<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ä»»åŠ¡è¯¦æƒ…ç¼–è¾‘å™¨</title>
    <style>
        :root {
            --primary-bg: #ffffff;
            --secondary-bg: #f8f9fa;
            --border-color: #e9ecef;
            --text-primary: #212529;
            --text-secondary: #6c757d;
            --primary-color: #457bd3;
            --hover-bg: #e9ecef;
            --danger-color: #dc3545;
            --success-color: #28a745;
            --warning-color: #ffc107;
            --shadow-sm: 0 2px 4px rgba(0,0,0,0.05);
            --shadow-md: 0 4px 6px rgba(0,0,0,0.1);
            --transition-speed: 0.2s;
            --border-radius: 8px;
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            background-color: var(--primary-bg);
            color: var(--text-primary);
            padding: 20px;
            margin: 0;
            overflow-x: hidden;
        }

        .container {
            max-width: 800px;
            margin: 0 auto;
        }

        /* ä»»åŠ¡å¤´éƒ¨ä¿¡æ¯ */
        .task-header {
            background-color: var(--secondary-bg);
            padding: 20px;
            border-radius: var(--border-radius);
            margin-bottom: 20px;
            box-shadow: var(--shadow-sm);
        }

        .task-title {
            font-size: 24px;
            font-weight: 600;
            margin-bottom: 10px;
            color: var(--text-primary);
        }

        .task-meta {
            display: flex;
            gap: 20px;
            font-size: 14px;
            color: var(--text-secondary);
        }

        .task-meta-item {
            display: flex;
            align-items: center;
            gap: 5px;
        }

        /* å­—æ®µç¼–è¾‘åŒºåŸŸ */
        .fields-section {
            background-color: var(--primary-bg);
            padding: 20px;
            border: 1px solid var(--border-color);
            border-radius: var(--border-radius);
            margin-bottom: 20px;
        }

        .section-title {
            font-size: 18px;
            font-weight: 600;
            margin-bottom: 15px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .add-field-btn {
            background-color: var(--primary-color);
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            transition: background-color var(--transition-speed);
        }

        .add-field-btn:hover {
            background-color: #3a6bc3;
        }

        /* å­—æ®µåˆ—è¡¨ */
        .fields-list {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .field-item {
            background-color: var(--secondary-bg);
            padding: 15px;
            border-radius: 6px;
            display: flex;
            align-items: center;
            gap: 10px;
            transition: all var(--transition-speed);
            cursor: move;
        }

        .field-item:hover {
            box-shadow: var(--shadow-sm);
            transform: translateY(-1px);
        }

        .field-item.dragging {
            opacity: 0.5;
        }

        .field-drag-handle {
            color: var(--text-secondary);
            cursor: move;
            font-size: 20px;
            user-select: none;
        }

        .field-info {
            flex: 1;
            display: flex;
            flex-direction: column;
            gap: 5px;
        }

        .field-name {
            font-weight: 600;
            color: var(--primary-color);
            font-size: 14px;
        }

        .field-content {
            color: var(--text-primary);
            font-size: 14px;
        }

        .field-content.empty {
            color: var(--text-secondary);
            font-style: italic;
        }

        .field-actions {
            display: flex;
            gap: 8px;
        }

        .field-btn {
            background: none;
            border: none;
            cursor: pointer;
            padding: 6px;
            border-radius: 4px;
            transition: background-color var(--transition-speed);
            font-size: 16px;
        }

        .field-btn:hover {
            background-color: var(--hover-bg);
        }

        .field-btn.edit {
            color: var(--primary-color);
        }

        .field-btn.delete {
            color: var(--danger-color);
        }

        /* æ—¥æœŸé€‰æ‹©åŒºåŸŸ */
        .date-section {
            background-color: var(--secondary-bg);
            padding: 20px;
            border-radius: var(--border-radius);
            margin-bottom: 20px;
        }

        .date-input-group {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-top: 10px;
        }

        .date-input {
            flex: 1;
            padding: 10px;
            border: 1px solid var(--border-color);
            border-radius: 6px;
            font-size: 14px;
        }

        .date-btn {
            background-color: var(--primary-color);
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            transition: background-color var(--transition-speed);
        }

        .date-btn:hover {
            background-color: #3a6bc3;
        }

        /* æ“ä½œæŒ‰é’®åŒºåŸŸ */
        .actions-section {
            display: flex;
            justify-content: flex-end;
            gap: 10px;
            margin-top: 20px;
        }

        .action-btn {
            padding: 10px 20px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            transition: all var(--transition-speed);
        }

        .action-btn.save {
            background-color: var(--success-color);
            color: white;
        }

        .action-btn.save:hover {
            background-color: #239a3b;
        }

        .action-btn.cancel {
            background-color: var(--secondary-bg);
            color: var(--text-primary);
            border: 1px solid var(--border-color);
        }

        .action-btn.cancel:hover {
            background-color: var(--hover-bg);
        }

        /* æ¨¡æ€æ¡† */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            z-index: 1000;
        }

        .modal.show {
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .modal-content {
            background-color: white;
            padding: 30px;
            border-radius: var(--border-radius);
            box-shadow: var(--shadow-md);
            width: 90%;
            max-width: 500px;
        }

        .modal-title {
            font-size: 20px;
            font-weight: 600;
            margin-bottom: 20px;
        }

        .modal-form {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .form-group {
            display: flex;
            flex-direction: column;
            gap: 5px;
        }

        .form-label {
            font-size: 14px;
            font-weight: 500;
            color: var(--text-secondary);
        }

        .form-input {
            padding: 10px;
            border: 1px solid var(--border-color);
            border-radius: 6px;
            font-size: 14px;
        }

        .form-input:focus {
            outline: none;
            border-color: var(--primary-color);
        }

        .modal-actions {
            display: flex;
            justify-content: flex-end;
            gap: 10px;
            margin-top: 20px;
        }

        /* åŠ è½½çŠ¶æ€ */
        .loading {
            text-align: center;
            padding: 40px;
            color: var(--text-secondary);
        }

        /* ç©ºçŠ¶æ€ */
        .empty-state {
            text-align: center;
            padding: 40px;
            color: var(--text-secondary);
        }

        .empty-state-icon {
            font-size: 48px;
            margin-bottom: 10px;
        }

        .empty-state-text {
            font-size: 16px;
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- ä»»åŠ¡å¤´éƒ¨ä¿¡æ¯ -->
        <div class="task-header">
            <h1 class="task-title" id="taskTitle">åŠ è½½ä¸­...</h1>
            <div class="task-meta">
                <div class="task-meta-item">
                    <span class="meta-icon">ğŸ“‹</span>
                    <span id="taskType">-</span>
                </div>
                <div class="task-meta-item">
                    <span class="meta-icon">ğŸ¯</span>
                    <span id="taskStatus">-</span>
                </div>
                <div class="task-meta-item">
                    <span class="meta-icon">ğŸ·ï¸</span>
                    <span id="taskId">-</span>
                </div>
            </div>
        </div>

        <!-- æ—¥æœŸè®¾ç½®åŒºåŸŸ -->
        <div class="date-section">
            <h2 class="section-title">ä»»åŠ¡æ—¥æœŸ</h2>
            <div class="date-input-group">
                <input type="date" id="taskDate" class="date-input">
                <button class="date-btn" onclick="updateTaskDate()">æ›´æ–°æ—¥æœŸ</button>
                <button class="date-btn" onclick="clearTaskDate()">æ¸…é™¤æ—¥æœŸ</button>
            </div>
        </div>

        <!-- å­—æ®µç¼–è¾‘åŒºåŸŸ -->
        <div class="fields-section">
            <div class="section-title">
                <span>ä»»åŠ¡å­—æ®µ</span>
                <button class="add-field-btn" onclick="showAddFieldModal()">+ æ·»åŠ å­—æ®µ</button>
            </div>
            <div id="fieldsList" class="fields-list">
                <!-- å­—æ®µåˆ—è¡¨å°†åŠ¨æ€åŠ è½½ -->
            </div>
        </div>

        <!-- æ“ä½œæŒ‰é’® -->
        <div class="actions-section">
            <button class="action-btn cancel" onclick="cancelEdit()">å–æ¶ˆ</button>
            <button class="action-btn save" onclick="saveChanges()">ä¿å­˜æ›´æ”¹</button>
        </div>
    </div>

    <!-- å­—æ®µç¼–è¾‘æ¨¡æ€æ¡† -->
    <div id="fieldModal" class="modal">
        <div class="modal-content">
            <h3 class="modal-title" id="modalTitle">æ·»åŠ å­—æ®µ</h3>
            <form class="modal-form" onsubmit="saveField(event)">
                <div class="form-group">
                    <label class="form-label">å­—æ®µåç§°</label>
                    <input type="text" id="fieldName" class="form-input" required>
                </div>
                <div class="form-group">
                    <label class="form-label">å­—æ®µå†…å®¹ï¼ˆå¯é€‰ï¼‰</label>
                    <input type="text" id="fieldContent" class="form-input">
                </div>
                <div class="modal-actions">
                    <button type="button" class="action-btn cancel" onclick="closeModal()">å–æ¶ˆ</button>
                    <button type="submit" class="action-btn save">ç¡®å®š</button>
                </div>
            </form>
        </div>
    </div>

    <script>
        // ä»»åŠ¡ç¼–è¾‘å™¨ç®¡ç†å¯¹è±¡
        const taskEditor = {
            currentTask: null,
            fields: [],
            editingFieldIndex: -1,
            hasChanges: false,

            // åˆå§‹åŒ–ç¼–è¾‘å™¨
            init() {
                console.log('ä»»åŠ¡ç¼–è¾‘å™¨åˆå§‹åŒ–');
                this.setupDragAndDrop();
                this.bindEvents();
                
                // ä¸å†è‡ªåŠ¨è¯·æ±‚åŠ è½½ä»»åŠ¡æ•°æ®ï¼Œç­‰å¾…åŸç”Ÿä»£ç è°ƒç”¨ loadTaskFromPlugin
                console.log('ä»»åŠ¡ç¼–è¾‘å™¨å·²å‡†å¤‡å°±ç»ªï¼Œç­‰å¾…åŠ è½½ä»»åŠ¡æ•°æ®');
            },

            // åŠ è½½ä»»åŠ¡æ•°æ®
            loadTask(encodedTask) {
                try {
                    const task = JSON.parse(decodeURIComponent(encodedTask));
                    console.log('åŠ è½½ä»»åŠ¡æ•°æ®:', task);
                    
                    this.currentTask = task;
                    this.updateTaskHeader(task);
                    this.loadFields(task.fields || []);
                    
                    // è®¾ç½®æ—¥æœŸ
                    if (task.scheduledDate) {
                        document.getElementById('taskDate').value = task.scheduledDate;
                    }
                } catch (error) {
                    console.error('åŠ è½½ä»»åŠ¡å¤±è´¥:', error);
                    alert('åŠ è½½ä»»åŠ¡æ•°æ®å¤±è´¥');
                }
            },

            // æ›´æ–°ä»»åŠ¡å¤´éƒ¨ä¿¡æ¯
            updateTaskHeader(task) {
                document.getElementById('taskTitle').textContent = task.title || 'æœªå‘½åä»»åŠ¡';
                document.getElementById('taskType').textContent = task.type || 'æœªçŸ¥';
                document.getElementById('taskStatus').textContent = task.status || 'æœªçŸ¥';
                document.getElementById('taskId').textContent = task.id ? task.id.substring(0, 8) + '...' : '-';
            },

            // åŠ è½½å­—æ®µåˆ—è¡¨
            loadFields(fields) {
                // ä¸ºæ¯ä¸ªå­—æ®µæ·»åŠ åŸå§‹ç´¢å¼•ä»¥è·Ÿè¸ªæ›´æ”¹
                this.fields = fields.map((field, index) => ({
                    ...field,
                    originalIndex: index,
                    isNew: false,
                    isDeleted: false
                }));
                this.renderFields();
            },

            // æ¸²æŸ“å­—æ®µåˆ—è¡¨
            renderFields() {
                const container = document.getElementById('fieldsList');
                
                // è¿‡æ»¤æ‰å·²åˆ é™¤çš„å­—æ®µ
                const activeFields = this.fields.filter(field => !field.isDeleted);
                
                if (activeFields.length === 0) {
                    container.innerHTML = `
                        <div class="empty-state">
                            <div class="empty-state-icon">ğŸ“</div>
                            <div class="empty-state-text">æš‚æ— å­—æ®µï¼Œç‚¹å‡»ä¸Šæ–¹æŒ‰é’®æ·»åŠ </div>
                        </div>
                    `;
                    return;
                }

                container.innerHTML = this.fields.map((field, index) => {
                    if (field.isDeleted) return '';
                    return `
                    <div class="field-item" draggable="true" data-index="${index}">
                        <span class="field-drag-handle">â‰¡</span>
                        <div class="field-info">
                            <div class="field-name">${field.name}</div>
                            <div class="field-content ${field.content ? '' : 'empty'}">
                                ${field.content || '(ç©º)'}
                            </div>
                        </div>
                        <div class="field-actions">
                            <button class="field-btn edit" onclick="taskEditor.editField(${index})" title="ç¼–è¾‘">
                                âœï¸
                            </button>
                            <button class="field-btn delete" onclick="taskEditor.deleteField(${index})" title="åˆ é™¤">
                                ğŸ—‘ï¸
                            </button>
                        </div>
                    </div>
                `;
                }).join('');

                // é‡æ–°ç»‘å®šæ‹–æ‹½äº‹ä»¶
                this.bindDragEvents();
            },

            // è®¾ç½®æ‹–æ‹½åŠŸèƒ½
            setupDragAndDrop() {
                let draggedElement = null;
                let draggedIndex = -1;

                document.addEventListener('dragstart', (e) => {
                    if (e.target.classList.contains('field-item')) {
                        draggedElement = e.target;
                        draggedIndex = parseInt(e.target.dataset.index);
                        e.target.classList.add('dragging');
                    }
                });

                document.addEventListener('dragend', (e) => {
                    if (e.target.classList.contains('field-item')) {
                        e.target.classList.remove('dragging');
                    }
                });

                document.addEventListener('dragover', (e) => {
                    e.preventDefault();
                    const container = document.getElementById('fieldsList');
                    const afterElement = this.getDragAfterElement(container, e.clientY);
                    
                    if (afterElement == null) {
                        container.appendChild(draggedElement);
                    } else {
                        container.insertBefore(draggedElement, afterElement);
                    }
                });

                document.addEventListener('drop', (e) => {
                    e.preventDefault();
                    if (draggedElement) {
                        const newIndex = [...document.querySelectorAll('.field-item')].indexOf(draggedElement);
                        if (draggedIndex !== newIndex) {
                            this.reorderField(draggedIndex, newIndex);
                        }
                    }
                });
            },

            // è·å–æ‹–æ‹½åçš„ä½ç½®
            getDragAfterElement(container, y) {
                const draggableElements = [...container.querySelectorAll('.field-item:not(.dragging)')];
                
                return draggableElements.reduce((closest, child) => {
                    const box = child.getBoundingClientRect();
                    const offset = y - box.top - box.height / 2;
                    
                    if (offset < 0 && offset > closest.offset) {
                        return { offset: offset, element: child };
                    } else {
                        return closest;
                    }
                }, { offset: Number.NEGATIVE_INFINITY }).element;
            },

            // é‡æ–°æ’åºå­—æ®µ
            reorderField(oldIndex, newIndex) {
                const [removed] = this.fields.splice(oldIndex, 1);
                this.fields.splice(newIndex, 0, removed);
                this.hasChanges = true;
                this.renderFields();
                
                // é€šçŸ¥åŸç”Ÿä»£ç 
                window.location.href = `mntask://reorderFields?oldIndex=${oldIndex}&newIndex=${newIndex}`;
            },

            // ç»‘å®šæ‹–æ‹½äº‹ä»¶
            bindDragEvents() {
                document.querySelectorAll('.field-item').forEach(item => {
                    item.addEventListener('dragstart', (e) => {
                        e.dataTransfer.effectAllowed = 'move';
                    });
                });
            },

            // ç»‘å®šé€šç”¨äº‹ä»¶
            bindEvents() {
                // ç›‘å¬é”®ç›˜äº‹ä»¶
                document.addEventListener('keydown', (e) => {
                    if (e.key === 'Escape') {
                        this.closeModal();
                    }
                });

                // ç›‘å¬æ¨¡æ€æ¡†èƒŒæ™¯ç‚¹å‡»
                document.getElementById('fieldModal').addEventListener('click', (e) => {
                    if (e.target.id === 'fieldModal') {
                        this.closeModal();
                    }
                });
            },

            // æ˜¾ç¤ºæ·»åŠ å­—æ®µæ¨¡æ€æ¡†
            showAddFieldModal() {
                this.editingFieldIndex = -1;
                document.getElementById('modalTitle').textContent = 'æ·»åŠ å­—æ®µ';
                document.getElementById('fieldName').value = '';
                document.getElementById('fieldContent').value = '';
                document.getElementById('fieldModal').classList.add('show');
                document.getElementById('fieldName').focus();
            },

            // ç¼–è¾‘å­—æ®µ
            editField(index) {
                const field = this.fields[index];
                this.editingFieldIndex = index;
                document.getElementById('modalTitle').textContent = 'ç¼–è¾‘å­—æ®µ';
                document.getElementById('fieldName').value = field.name;
                document.getElementById('fieldContent').value = field.content || '';
                document.getElementById('fieldModal').classList.add('show');
                document.getElementById('fieldName').focus();
            },

            // åˆ é™¤å­—æ®µ
            deleteField(index) {
                if (confirm(`ç¡®å®šè¦åˆ é™¤å­—æ®µ"${this.fields[index].name}"å—ï¼Ÿ`)) {
                    const field = this.fields[index];
                    // æ ‡è®°ä¸ºåˆ é™¤è€Œä¸æ˜¯ç›´æ¥åˆ é™¤ï¼Œä»¥ä¾¿è·Ÿè¸ªæ›´æ”¹
                    field.isDeleted = true;
                    this.hasChanges = true;
                    this.renderFields();
                    
                    // é€šçŸ¥åŸç”Ÿä»£ç 
                    window.location.href = `mntask://deleteField?index=${index}&name=${encodeURIComponent(field.name)}`;
                }
            },

            // ä¿å­˜å­—æ®µ
            saveField(event) {
                event.preventDefault();
                
                const name = document.getElementById('fieldName').value.trim();
                const content = document.getElementById('fieldContent').value.trim();
                
                if (!name) {
                    alert('å­—æ®µåç§°ä¸èƒ½ä¸ºç©º');
                    return;
                }

                // æ£€æµ‹å­—æ®µç±»å‹
                let fieldType = 'normal';
                let extraData = {};
                
                // æ£€æµ‹æ—¥æœŸå­—æ®µ
                if (name.includes('æ—¥æœŸ') || name.includes('Date')) {
                    fieldType = 'date';
                    // å¦‚æœå†…å®¹æ˜¯æ—¥æœŸæ ¼å¼ï¼Œæå–æ—¥æœŸ
                    const dateMatch = content.match(/\d{4}-\d{2}-\d{2}/);
                    if (dateMatch) {
                        extraData.date = dateMatch[0];
                    }
                }
                // æ£€æµ‹ä¼˜å…ˆçº§å­—æ®µ
                else if (name.includes('ä¼˜å…ˆçº§') || name.includes('Priority')) {
                    fieldType = 'priority';
                    if (content.includes('é«˜') || content.includes('High')) {
                        extraData.priority = 'é«˜';
                    } else if (content.includes('ä¸­') || content.includes('Medium')) {
                        extraData.priority = 'ä¸­';
                    } else if (content.includes('ä½') || content.includes('Low')) {
                        extraData.priority = 'ä½';
                    }
                }
                // æ£€æµ‹å¯åŠ¨é“¾æ¥
                else if (name.includes('å¯åŠ¨') || name.includes('Launch') || name.includes('é“¾æ¥')) {
                    fieldType = 'launch';
                    // æ£€æµ‹URL
                    const urlMatch = content.match(/(https?:\/\/[^\s]+|marginnote\d+app:\/\/[^\s]+)/);
                    if (urlMatch) {
                        extraData.url = urlMatch[0];
                        extraData.text = content.replace(urlMatch[0], '').trim() || name;
                    }
                }

                if (this.editingFieldIndex === -1) {
                    // æ·»åŠ æ–°å­—æ®µ
                    this.fields.push({ 
                        name, 
                        content,
                        isNew: true,
                        isDeleted: false,
                        originalIndex: undefined,
                        fieldType: fieldType,
                        ...extraData
                    });
                    // é€šçŸ¥åŸç”Ÿä»£ç 
                    window.location.href = `mntask://addField?name=${encodeURIComponent(name)}&content=${encodeURIComponent(content)}&fieldType=${fieldType}`;
                } else {
                    // æ›´æ–°ç°æœ‰å­—æ®µ
                    const oldField = this.fields[this.editingFieldIndex];
                    this.fields[this.editingFieldIndex] = { 
                        ...oldField,
                        name, 
                        content,
                        fieldType: fieldType,
                        ...extraData
                    };
                    // é€šçŸ¥åŸç”Ÿä»£ç 
                    window.location.href = `mntask://updateField?index=${this.editingFieldIndex}&name=${encodeURIComponent(name)}&content=${encodeURIComponent(content)}&oldName=${encodeURIComponent(oldField.name)}&fieldType=${fieldType}`;
                }

                this.hasChanges = true;
                this.renderFields();
                this.closeModal();
            },

            // å…³é—­æ¨¡æ€æ¡†
            closeModal() {
                document.getElementById('fieldModal').classList.remove('show');
                document.getElementById('fieldName').value = '';
                document.getElementById('fieldContent').value = '';
                this.editingFieldIndex = -1;
            },

            // æ›´æ–°ä»»åŠ¡æ—¥æœŸ
            updateTaskDate() {
                const date = document.getElementById('taskDate').value;
                if (date) {
                    this.hasChanges = true;
                    window.location.href = `mntask://updateTaskDate?date=${encodeURIComponent(date)}`;
                    alert(`å·²è®¾ç½®ä»»åŠ¡æ—¥æœŸä¸º: ${date}`);
                } else {
                    alert('è¯·é€‰æ‹©ä¸€ä¸ªæ—¥æœŸ');
                }
            },

            // æ¸…é™¤ä»»åŠ¡æ—¥æœŸ
            clearTaskDate() {
                if (confirm('ç¡®å®šè¦æ¸…é™¤ä»»åŠ¡æ—¥æœŸå—ï¼Ÿ')) {
                    document.getElementById('taskDate').value = '';
                    this.hasChanges = true;
                    window.location.href = 'mntask://clearTaskDate';
                    alert('å·²æ¸…é™¤ä»»åŠ¡æ—¥æœŸ');
                }
            },

            // å–æ¶ˆç¼–è¾‘
            cancelEdit() {
                if (this.hasChanges && !confirm('æœ‰æœªä¿å­˜çš„æ›´æ”¹ï¼Œç¡®å®šè¦é€€å‡ºå—ï¼Ÿ')) {
                    return;
                }
                window.location.href = 'mntask://closeTaskEditor';
            },

            // ä¿å­˜æ›´æ”¹
            saveChanges() {
                window.location.href = 'mntask://saveTaskChanges';
                alert('æ›´æ”¹å·²ä¿å­˜');
                this.hasChanges = false;
            },

            // è·å–æ›´æ”¹çš„å­—æ®µæ•°æ®
            getChangedFields() {
                const changes = {
                    deletedFields: [],
                    updatedFields: [],
                    addedFields: [],
                    reorderedFields: []
                };

                // è·Ÿè¸ªåŸå§‹å­—æ®µä»¥æ£€æµ‹æ›´æ”¹
                const originalFields = this.currentTask ? (this.currentTask.fields || []) : [];
                
                // æ£€æµ‹åˆ é™¤çš„å­—æ®µ
                originalFields.forEach((origField, index) => {
                    const exists = this.fields.some(field => 
                        field.originalIndex === index && !field.isDeleted
                    );
                    if (!exists) {
                        changes.deletedFields.push(index);
                    }
                });

                // æ£€æµ‹æ›´æ–°å’Œæ–°å¢çš„å­—æ®µ
                this.fields.forEach((field, currentIndex) => {
                    if (field.isDeleted) return;

                    if (field.isNew) {
                        // æ–°å¢çš„å­—æ®µ
                        changes.addedFields.push({
                            content: field.content || field.name,
                            isMainField: field.isMainField || false,
                            fieldType: field.fieldType || 'normal',
                            priority: field.priority,
                            date: field.date,
                            url: field.url,
                            text: field.text
                        });
                    } else if (field.originalIndex !== undefined) {
                        // æ£€æŸ¥æ˜¯å¦æ›´æ–°
                        const origField = originalFields[field.originalIndex];
                        if (origField && (
                            origField.name !== field.name || 
                            origField.content !== field.content
                        )) {
                            changes.updatedFields.push({
                                index: field.originalIndex,
                                content: field.content || field.name,
                                isMainField: field.isMainField || false
                            });
                        }

                        // æ£€æŸ¥æ˜¯å¦é‡æ–°æ’åº
                        if (field.originalIndex !== currentIndex) {
                            changes.reorderedFields.push({
                                from: field.originalIndex,
                                to: currentIndex
                            });
                        }
                    }
                });

                return changes;
            }
        };

        // å…¨å±€å‡½æ•°ä¾›åŸç”Ÿä»£ç è°ƒç”¨
        function showAddFieldModal() {
            taskEditor.showAddFieldModal();
        }

        function saveField(event) {
            taskEditor.saveField(event);
        }

        function closeModal() {
            taskEditor.closeModal();
        }

        function updateTaskDate() {
            taskEditor.updateTaskDate();
        }

        function clearTaskDate() {
            taskEditor.clearTaskDate();
        }

        function cancelEdit() {
            taskEditor.cancelEdit();
        }

        function saveChanges() {
            taskEditor.saveChanges();
        }

        // ä¾›åŸç”Ÿä»£ç è°ƒç”¨çš„åŠ è½½å‡½æ•°
        function loadTaskFromPlugin(encodedTask) {
            taskEditor.loadTask(encodedTask);
        }

        // åˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', () => {
            taskEditor.init();
        });
        
        // å°† taskEditor æš´éœ²ç»™å…¨å±€ï¼Œä»¥ä¾¿åŸç”Ÿä»£ç è®¿é—®
        window.taskEditor = taskEditor;
        
        // ç›‘å¬æ¥è‡ªçˆ¶çª—å£çš„æ¶ˆæ¯
        window.addEventListener('message', function(event) {
            if (event.data && event.data.type === 'getChangedFields') {
                // è·å–æ›´æ”¹çš„å­—æ®µæ•°æ®
                const changes = taskEditor.getChangedFields();
                
                // å‘é€å“åº”
                event.source.postMessage({
                    type: 'changedFields',
                    requestId: event.data.requestId,
                    changes: changes
                }, '*');
            }
        });
    </script>
</body>
</html>