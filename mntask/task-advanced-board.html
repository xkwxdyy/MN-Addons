<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>MNTask é«˜çº§ä»»åŠ¡ç®¡ç†çœ‹æ¿</title>
    
    <style>
        /* ========================================
           ğŸ¨ CSS å˜é‡å®šä¹‰ - ç°ä»£åŒ–è®¾è®¡ç³»ç»Ÿ
           ======================================== */
        :root {
            /* ä¸»é¢˜è‰² - æ·±è‰²ç³» */
            --bg-primary: #0f0f1e;
            --bg-secondary: #1a1a2e;
            --bg-tertiary: #16213e;
            --bg-card: rgba(255, 255, 255, 0.05);
            --bg-hover: rgba(255, 255, 255, 0.08);
            --bg-active: rgba(102, 126, 234, 0.2);
            
            /* ç»ç’ƒæ•ˆæœ */
            --glass-bg: rgba(255, 255, 255, 0.06);
            --glass-border: rgba(255, 255, 255, 0.1);
            --glass-blur: blur(10px);
            
            /* æ–‡å­—é¢œè‰² */
            --text-primary: #ffffff;
            --text-secondary: #b8bcc8;
            --text-muted: #6c7293;
            --text-disabled: #4a4a5e;
            
            /* ä»»åŠ¡ç±»å‹é¢œè‰² */
            --type-goal: #667eea;        /* ç›®æ ‡ - ç´«è“ */
            --type-kr: #f687b3;          /* å…³é”®ç»“æœ - ç²‰çº¢ */
            --type-project: #48bb78;     /* é¡¹ç›® - ç»¿è‰² */
            --type-action: #ed8936;      /* åŠ¨ä½œ - æ©™è‰² */
            
            /* çŠ¶æ€é¢œè‰² */
            --status-todo: #718096;      /* æœªå¼€å§‹ - ç°è‰² */
            --status-doing: #f6ad55;     /* è¿›è¡Œä¸­ - æ©™é»„ */
            --status-done: #48bb78;      /* å·²å®Œæˆ - ç»¿è‰² */
            
            /* ä¼˜å…ˆçº§é¢œè‰² */
            --priority-high: #fc8181;    /* é«˜ - çº¢è‰² */
            --priority-medium: #f6e05e;  /* ä¸­ - é»„è‰² */
            --priority-low: #68d391;     /* ä½ - ç»¿è‰² */
            
            /* å…¶ä»–æ ·å¼å˜é‡ */
            --radius: 12px;
            --radius-sm: 6px;
            --shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            --shadow-lg: 0 10px 20px rgba(0, 0, 0, 0.2);
            --transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            
            /* é—´è·ç³»ç»Ÿ */
            --spacing-xs: 4px;
            --spacing-sm: 8px;
            --spacing-md: 16px;
            --spacing-lg: 24px;
            --spacing-xl: 32px;
            
            /* è§¦æ‘¸ä¼˜åŒ–å°ºå¯¸ */
            --touch-target: 44px;
        }

        /* ========================================
           ğŸ“ åŸºç¡€æ ·å¼é‡ç½®
           ======================================== */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'PingFang SC', 'Hiragino Sans GB', 'Microsoft YaHei', sans-serif;
            background: var(--bg-primary);
            color: var(--text-primary);
            line-height: 1.6;
            overflow: hidden;
            -webkit-font-smoothing: antialiased;
        }

        /* è‡ªå®šä¹‰æ»šåŠ¨æ¡ */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }

        ::-webkit-scrollbar-track {
            background: var(--bg-secondary);
        }

        ::-webkit-scrollbar-thumb {
            background: var(--glass-border);
            border-radius: 4px;
        }

        /* ========================================
           ğŸ—ï¸ ä¸»å¸ƒå±€ç»“æ„
           ======================================== */
        .app-container {
            display: flex;
            flex-direction: column;
            height: 100vh;
            width: 100vw;
            overflow: hidden;
        }

        /* é¡¶éƒ¨å¯¼èˆªæ  */
        .navbar {
            background: var(--glass-bg);
            backdrop-filter: var(--glass-blur);
            border-bottom: 1px solid var(--glass-border);
            padding: var(--spacing-md) var(--spacing-lg);
            display: flex;
            align-items: center;
            justify-content: space-between;
            flex-shrink: 0;
            z-index: 100;
            flex-wrap: wrap;
            gap: var(--spacing-md);
        }

        .navbar-brand {
            display: flex;
            align-items: center;
            gap: var(--spacing-md);
        }

        .navbar-title {
            font-size: 1.125rem;
            font-weight: 600;
            background: linear-gradient(135deg, var(--type-goal) 0%, var(--type-kr) 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        /* è§†å›¾åˆ‡æ¢æŒ‰é’®ç»„ */
        .view-switcher {
            display: flex;
            gap: var(--spacing-xs);
            background: var(--bg-card);
            padding: var(--spacing-xs);
            border-radius: var(--radius-sm);
            overflow-x: auto;
            -webkit-overflow-scrolling: touch;
        }

        .view-btn {
            padding: var(--spacing-sm) var(--spacing-md);
            background: transparent;
            border: none;
            color: var(--text-secondary);
            cursor: pointer;
            border-radius: var(--radius-sm);
            transition: var(--transition);
            font-size: 0.875rem;
            font-weight: 500;
            white-space: nowrap;
            min-height: var(--touch-target);
            display: flex;
            align-items: center;
            touch-action: manipulation;
        }

        .view-btn.active {
            background: var(--bg-active);
            color: var(--type-goal);
        }

        /* ä¸»å†…å®¹åŒºåŸŸ */
        .main-content {
            flex: 1;
            display: flex;
            overflow: hidden;
        }

        /* ä¾§è¾¹æ  */
        .sidebar {
            width: 260px;
            background: var(--glass-bg);
            backdrop-filter: var(--glass-blur);
            border-right: 1px solid var(--glass-border);
            padding: var(--spacing-lg);
            overflow-y: auto;
            flex-shrink: 0;
        }

        .sidebar-section {
            margin-bottom: var(--spacing-xl);
        }

        .sidebar-title {
            font-size: 0.75rem;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            color: var(--text-muted);
            margin-bottom: var(--spacing-md);
            font-weight: 600;
        }

        /* ä¸»å·¥ä½œåŒº */
        .workspace {
            flex: 1;
            overflow: hidden;
            position: relative;
        }

        /* ========================================
           ğŸ“Š å­—æ®µç®¡ç†é¢æ¿æ ·å¼
           ======================================== */
        .field-manager {
            height: 100%;
            display: flex;
            flex-direction: column;
            padding: var(--spacing-lg);
        }

        .field-toolbar {
            display: flex;
            gap: var(--spacing-md);
            margin-bottom: var(--spacing-lg);
            flex-wrap: wrap;
        }

        .btn {
            padding: var(--spacing-sm) var(--spacing-md);
            background: var(--glass-bg);
            border: 1px solid var(--glass-border);
            border-radius: var(--radius-sm);
            color: var(--text-primary);
            cursor: pointer;
            transition: var(--transition);
            font-size: 0.875rem;
            font-weight: 500;
            display: flex;
            align-items: center;
            gap: var(--spacing-sm);
            min-height: var(--touch-target);
            touch-action: manipulation;
        }

        .btn:active {
            transform: scale(0.98);
            background: var(--bg-hover);
        }

        .btn-primary {
            background: var(--type-goal);
            border-color: var(--type-goal);
            color: white;
        }

        .btn-danger {
            background: var(--priority-high);
            border-color: var(--priority-high);
            color: white;
        }

        /* å­—æ®µè¡¨æ ¼ */
        .field-table-container {
            flex: 1;
            overflow: auto;
            background: var(--glass-bg);
            backdrop-filter: var(--glass-blur);
            border: 1px solid var(--glass-border);
            border-radius: var(--radius);
            -webkit-overflow-scrolling: touch;
        }

        .field-table {
            width: 100%;
            border-collapse: collapse;
            min-width: 800px;
        }

        .field-table th,
        .field-table td {
            padding: var(--spacing-md);
            text-align: left;
            border-bottom: 1px solid var(--glass-border);
            vertical-align: top;
        }

        .field-table th {
            background: var(--bg-secondary);
            font-weight: 600;
            font-size: 0.875rem;
            color: var(--text-secondary);
            position: sticky;
            top: 0;
            z-index: 10;
        }

        .field-table tr.selected {
            background: var(--bg-active);
        }

        /* ä»»åŠ¡è·¯å¾„æ˜¾ç¤º */
        .task-path {
            font-size: 0.75rem;
            color: var(--text-muted);
            margin-top: var(--spacing-xs);
        }

        /* ä»»åŠ¡æ ‡é¢˜æ ·å¼ */
        .task-title {
            font-size: 0.875rem;
            line-height: 1.5;
            word-break: break-word;
            min-width: 200px;
            display: block;
        }

        /* ä»»åŠ¡ç±»å‹æ ‡ç­¾ */
        .task-type-badge {
            display: inline-flex;
            align-items: center;
            gap: var(--spacing-xs);
            padding: 2px var(--spacing-sm);
            border-radius: var(--radius-sm);
            font-size: 0.75rem;
            font-weight: 600;
        }

        .task-type-badge.goal {
            background: rgba(102, 126, 234, 0.2);
            color: var(--type-goal);
        }

        .task-type-badge.kr {
            background: rgba(246, 135, 179, 0.2);
            color: var(--type-kr);
        }

        .task-type-badge.project {
            background: rgba(72, 187, 120, 0.2);
            color: var(--type-project);
        }

        .task-type-badge.action {
            background: rgba(237, 137, 54, 0.2);
            color: var(--type-action);
        }

        /* çŠ¶æ€æŒ‡ç¤ºå™¨ */
        .status-indicator {
            display: inline-flex;
            align-items: center;
            gap: var(--spacing-xs);
            font-size: 0.875rem;
        }

        .status-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
        }

        .status-dot.todo { background: var(--status-todo); }
        .status-dot.doing { background: var(--status-doing); }
        .status-dot.done { background: var(--status-done); }

        /* å­—æ®µå€¼ç¼–è¾‘ */
        .field-value {
            display: flex;
            align-items: center;
            gap: var(--spacing-sm);
            flex-wrap: wrap;
        }

        .field-input {
            background: var(--bg-card);
            border: 1px solid var(--glass-border);
            border-radius: var(--radius-sm);
            padding: var(--spacing-xs) var(--spacing-sm);
            color: var(--text-primary);
            font-size: 0.875rem;
            flex: 1;
            min-height: 32px;
        }

        .field-input:focus {
            outline: none;
            border-color: var(--type-goal);
            background: var(--bg-hover);
        }

        /* ä¼˜å…ˆçº§é€‰æ‹©å™¨ */
        .priority-selector {
            display: flex;
            gap: var(--spacing-sm);
        }

        .priority-option {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            cursor: pointer;
            opacity: 0.3;
            transition: var(--transition);
            position: relative;
        }

        .priority-option.selected {
            opacity: 1;
        }

        .priority-option.selected::after {
            content: 'âœ“';
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            color: white;
            font-size: 16px;
            font-weight: bold;
        }

        .priority-option.high { background: var(--priority-high); }
        .priority-option.medium { background: var(--priority-medium); }
        .priority-option.low { background: var(--priority-low); }

        /* ========================================
           ğŸ” é«˜çº§ç­›é€‰å™¨æ ·å¼
           ======================================== */
        .filter-builder {
            height: 100%;
            display: flex;
            padding: var(--spacing-lg);
            gap: var(--spacing-lg);
            flex-direction: column;
        }

        .filter-panel {
            background: var(--glass-bg);
            backdrop-filter: var(--glass-blur);
            border: 1px solid var(--glass-border);
            border-radius: var(--radius);
            padding: var(--spacing-lg);
            overflow-y: auto;
        }

        .filter-group {
            background: var(--bg-card);
            border: 1px solid var(--glass-border);
            border-radius: var(--radius);
            padding: var(--spacing-md);
            margin-bottom: var(--spacing-md);
        }

        .filter-group-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: var(--spacing-md);
            font-weight: 600;
        }

        .filter-options {
            display: flex;
            flex-wrap: wrap;
            gap: var(--spacing-md);
        }

        .filter-option {
            display: flex;
            align-items: center;
            gap: var(--spacing-sm);
            min-height: var(--touch-target);
        }

        .filter-select {
            background: var(--bg-secondary);
            border: 1px solid var(--glass-border);
            border-radius: var(--radius-sm);
            padding: var(--spacing-xs) var(--spacing-sm);
            color: var(--text-primary);
            font-size: 0.875rem;
        }

        /* ç­›é€‰é¢„è§ˆ */
        .filter-preview {
            background: var(--glass-bg);
            backdrop-filter: var(--glass-blur);
            border: 1px solid var(--glass-border);
            border-radius: var(--radius);
            padding: var(--spacing-lg);
            overflow-y: auto;
        }

        .preview-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: var(--spacing-md);
            margin-bottom: var(--spacing-lg);
        }

        .stat-card {
            background: var(--bg-card);
            border: 1px solid var(--glass-border);
            border-radius: var(--radius);
            padding: var(--spacing-md);
            text-align: center;
        }

        .stat-value {
            font-size: 2rem;
            font-weight: 700;
            color: var(--type-goal);
        }

        .stat-label {
            font-size: 0.875rem;
            color: var(--text-secondary);
        }

        /* ========================================
           âš¡ æ‰¹é‡æ“ä½œé¢æ¿æ ·å¼
           ======================================== */
        .batch-operations {
            height: 100%;
            display: flex;
            flex-direction: column;
            padding: var(--spacing-lg);
            overflow-y: auto;
        }

        .batch-selection {
            background: var(--glass-bg);
            backdrop-filter: var(--glass-blur);
            border: 1px solid var(--glass-border);
            border-radius: var(--radius);
            padding: var(--spacing-lg);
            margin-bottom: var(--spacing-lg);
        }

        .selection-methods {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: var(--spacing-md);
        }

        .selection-method {
            background: var(--bg-card);
            border: 1px solid var(--glass-border);
            border-radius: var(--radius);
            padding: var(--spacing-md);
            cursor: pointer;
            transition: var(--transition);
            min-height: 120px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            text-align: center;
        }

        .selection-method:active {
            background: var(--bg-active);
            transform: scale(0.98);
        }

        .batch-actions {
            background: var(--glass-bg);
            backdrop-filter: var(--glass-blur);
            border: 1px solid var(--glass-border);
            border-radius: var(--radius);
            padding: var(--spacing-lg);
        }

        .action-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: var(--spacing-md);
        }

        .action-card {
            background: var(--bg-card);
            border: 1px solid var(--glass-border);
            border-radius: var(--radius);
            padding: var(--spacing-lg);
            text-align: center;
            cursor: pointer;
            transition: var(--transition);
            min-height: 120px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }

        .action-card:active {
            background: var(--bg-active);
            transform: scale(0.98);
        }

        .action-icon {
            font-size: 2rem;
            margin-bottom: var(--spacing-sm);
        }

        /* ========================================
           ğŸŒ³ ä»»åŠ¡å…³ç³»è§†å›¾æ ·å¼
           ======================================== */
        .tree-view {
            height: 100%;
            padding: var(--spacing-lg);
            overflow: auto;
            -webkit-overflow-scrolling: touch;
        }

        .tree-node {
            margin-bottom: var(--spacing-xs);
        }

        .tree-node-content {
            display: flex;
            align-items: center;
            padding: var(--spacing-md);
            background: var(--glass-bg);
            backdrop-filter: var(--glass-blur);
            border: 1px solid var(--glass-border);
            border-radius: var(--radius-sm);
            cursor: pointer;
            transition: var(--transition);
            min-height: var(--touch-target);
        }

        .tree-node-content:active {
            background: var(--bg-active);
        }

        .tree-node-content.selected {
            background: var(--bg-active);
            border-color: var(--type-goal);
        }

        .tree-expand-icon {
            width: 32px;
            height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-right: var(--spacing-sm);
            transition: var(--transition);
            font-size: 20px;
        }

        .tree-expand-icon.expanded {
            transform: rotate(90deg);
        }

        .tree-node-info {
            flex: 1;
            display: flex;
            align-items: center;
            gap: var(--spacing-md);
            flex-wrap: wrap;
        }

        .tree-children {
            margin-left: var(--spacing-xl);
            margin-top: var(--spacing-xs);
        }

        /* ========================================
           ğŸ¯ æ¨¡æ€æ¡†æ ·å¼
           ======================================== */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            backdrop-filter: blur(5px);
            z-index: 1000;
            align-items: center;
            justify-content: center;
            padding: var(--spacing-lg);
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background: var(--bg-secondary);
            border: 1px solid var(--glass-border);
            border-radius: var(--radius);
            padding: var(--spacing-xl);
            max-width: 600px;
            width: 100%;
            max-height: 90vh;
            overflow-y: auto;
            animation: modalSlideIn 0.3s ease;
        }

        @keyframes modalSlideIn {
            from {
                transform: translateY(50px);
                opacity: 0;
            }
            to {
                transform: translateY(0);
                opacity: 1;
            }
        }

        .modal-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: var(--spacing-lg);
        }

        .modal-title {
            font-size: 1.25rem;
            font-weight: 600;
        }

        .modal-close {
            width: 44px;
            height: 44px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: var(--bg-card);
            border: 1px solid var(--glass-border);
            border-radius: 50%;
            cursor: pointer;
            transition: var(--transition);
            font-size: 24px;
        }

        /* è¡¨å•æ ·å¼ */
        .form-group {
            margin-bottom: var(--spacing-lg);
        }

        .form-label {
            display: block;
            font-size: 0.875rem;
            color: var(--text-secondary);
            margin-bottom: var(--spacing-sm);
            font-weight: 500;
        }

        .form-input,
        .form-select,
        .form-textarea {
            width: 100%;
            padding: var(--spacing-sm) var(--spacing-md);
            background: var(--bg-card);
            border: 1px solid var(--glass-border);
            border-radius: var(--radius-sm);
            color: var(--text-primary);
            font-size: 0.875rem;
            min-height: var(--touch-target);
        }

        .form-input:focus,
        .form-select:focus,
        .form-textarea:focus {
            outline: none;
            border-color: var(--type-goal);
            background: var(--bg-hover);
        }

        .form-textarea {
            min-height: 100px;
            resize: vertical;
        }

        /* æ“ä½œæç¤º */
        .toast {
            position: fixed;
            bottom: var(--spacing-lg);
            left: 50%;
            transform: translateX(-50%);
            background: var(--bg-secondary);
            border: 1px solid var(--glass-border);
            border-radius: var(--radius);
            padding: var(--spacing-md) var(--spacing-lg);
            display: flex;
            align-items: center;
            gap: var(--spacing-sm);
            z-index: 2000;
            animation: toastSlideUp 0.3s ease;
        }

        @keyframes toastSlideUp {
            from {
                transform: translate(-50%, 100%);
                opacity: 0;
            }
            to {
                transform: translate(-50%, 0);
                opacity: 1;
            }
        }

        .toast.success {
            border-color: var(--status-done);
            color: var(--status-done);
        }

        .toast.error {
            border-color: var(--priority-high);
            color: var(--priority-high);
        }

        /* ========================================
           ğŸ“± å“åº”å¼è®¾è®¡
           ======================================== */
        @media (max-width: 1024px) {
            .sidebar {
                position: fixed;
                left: -260px;
                height: 100%;
                z-index: 200;
                transition: left 0.3s ease;
            }
            
            .sidebar.open {
                left: 0;
            }
            
            .sidebar-toggle {
                display: block;
            }
            
            .filter-builder {
                flex-direction: column;
            }
        }

        @media (max-width: 768px) {
            .navbar {
                padding: var(--spacing-sm) var(--spacing-md);
            }
            
            .navbar-title {
                font-size: 1rem;
            }
            
            .view-switcher {
                width: 100%;
                order: 3;
            }
            
            .field-table {
                font-size: 0.75rem;
            }
            
            .field-table th,
            .field-table td {
                padding: var(--spacing-sm);
            }
            
            .selection-methods,
            .action-grid {
                grid-template-columns: 1fr;
            }
        }

        /* ========================================
           ğŸ› ï¸ å·¥å…·ç±»
           ======================================== */
        .hidden { display: none !important; }
        .text-center { text-align: center; }
        .text-muted { color: var(--text-muted); }
        .mb-0 { margin-bottom: 0; }
        .mb-1 { margin-bottom: var(--spacing-sm); }
        .mb-2 { margin-bottom: var(--spacing-md); }
        .mb-3 { margin-bottom: var(--spacing-lg); }

        /* å¤é€‰æ¡†æ ·å¼ */
        .checkbox {
            width: 24px;
            height: 24px;
            cursor: pointer;
            accent-color: var(--type-goal);
        }

        /* æ ‡ç­¾æ ·å¼ */
        .tag {
            display: inline-flex;
            align-items: center;
            padding: 2px var(--spacing-sm);
            background: var(--bg-active);
            border-radius: var(--radius-sm);
            font-size: 0.75rem;
            gap: var(--spacing-xs);
            margin: 2px;
        }

        .tag-remove {
            cursor: pointer;
            opacity: 0.6;
            transition: opacity 0.2s;
            padding: 2px;
            margin-left: 4px;
        }

        .tag-remove:active {
            opacity: 1;
        }

        /* åŠ è½½åŠ¨ç”» */
        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 2px solid var(--glass-border);
            border-top-color: var(--type-goal);
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* ç©ºçŠ¶æ€ */
        .empty-state {
            text-align: center;
            padding: var(--spacing-xl);
            color: var(--text-muted);
        }

        .empty-state-icon {
            font-size: 3rem;
            margin-bottom: var(--spacing-md);
            opacity: 0.3;
        }

        /* ä¾§è¾¹æ åˆ‡æ¢æŒ‰é’® */
        .sidebar-toggle {
            display: none;
            position: fixed;
            left: var(--spacing-md);
            bottom: var(--spacing-md);
            width: 56px;
            height: 56px;
            background: var(--type-goal);
            border-radius: 50%;
            align-items: center;
            justify-content: center;
            z-index: 300;
            box-shadow: var(--shadow-lg);
            cursor: pointer;
        }

        /* ç¡®è®¤å¯¹è¯æ¡† */
        .confirm-dialog {
            background: var(--bg-secondary);
            border: 1px solid var(--glass-border);
            border-radius: var(--radius);
            padding: var(--spacing-lg);
            max-width: 400px;
            text-align: center;
        }

        .confirm-message {
            margin-bottom: var(--spacing-lg);
            font-size: 1rem;
        }

        .confirm-buttons {
            display: flex;
            gap: var(--spacing-md);
            justify-content: center;
        }

        /* ä»»åŠ¡è¯¦æƒ…æ ·å¼ */
        .task-detail {
            padding: var(--spacing-lg);
        }

        .detail-section {
            margin-bottom: var(--spacing-lg);
        }

        .detail-label {
            font-size: 0.875rem;
            color: var(--text-secondary);
            margin-bottom: var(--spacing-xs);
        }

        .detail-value {
            font-size: 1rem;
            color: var(--text-primary);
        }

        /* æ‰¹é‡é€‰æ‹©æç¤º */
        .selection-hint {
            background: var(--bg-active);
            padding: var(--spacing-md);
            border-radius: var(--radius-sm);
            margin-bottom: var(--spacing-md);
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        /* è¿›åº¦æ¡æ ·å¼ä¼˜åŒ– */
        .progress-container {
            display: flex;
            align-items: center;
            gap: var(--spacing-sm);
            width: 100%;
        }

        .progress-bar {
            flex: 1;
            height: 6px;
            background: var(--glass-border);
            border-radius: 3px;
            overflow: hidden;
        }

        .progress-fill {
            height: 100%;
            background: var(--type-goal);
            transition: width 0.3s ease;
        }

        .progress-text {
            font-size: 0.75rem;
            color: var(--text-secondary);
            min-width: 40px;
            text-align: right;
        }
    </style>
</head>
<body>
    <!-- ========================================
         ğŸ¯ åº”ç”¨å®¹å™¨
         ======================================== -->
    <div class="app-container">
        <!-- é¡¶éƒ¨å¯¼èˆªæ  -->
        <nav class="navbar">
            <div class="navbar-brand">
                <h1 class="navbar-title">MNTask é«˜çº§ç®¡ç†çœ‹æ¿</h1>
            </div>
            
            <div class="navbar-actions">
                <button class="btn btn-primary" onclick="syncWithPlugin()">
                    ğŸ”„ åŒæ­¥æ•°æ®
                </button>
            </div>
            
            <div class="view-switcher">
                <button class="view-btn active" data-view="fields" onclick="switchView('fields')">
                    ğŸ“ å­—æ®µç®¡ç†
                </button>
                <button class="view-btn" data-view="filter" onclick="switchView('filter')">
                    ğŸ” é«˜çº§ç­›é€‰
                </button>
                <button class="view-btn" data-view="batch" onclick="switchView('batch')">
                    âš¡ æ‰¹é‡æ“ä½œ
                </button>
                <button class="view-btn" data-view="tree" onclick="switchView('tree')">
                    ğŸŒ³ å±‚çº§è§†å›¾
                </button>
            </div>
        </nav>

        <!-- ä¸»å†…å®¹åŒºåŸŸ -->
        <div class="main-content">
            <!-- ä¾§è¾¹æ  -->
            <aside class="sidebar" id="sidebar">
                <!-- å¿«é€Ÿç»Ÿè®¡ -->
                <div class="sidebar-section">
                    <h3 class="sidebar-title">ä»»åŠ¡ç»Ÿè®¡</h3>
                    <div class="stat-card mb-2">
                        <div class="stat-value" id="totalTasks">0</div>
                        <div class="stat-label">æ€»ä»»åŠ¡æ•°</div>
                    </div>
                    <div class="stat-card mb-2">
                        <div class="stat-value" id="todayTasks">0</div>
                        <div class="stat-label">ä»Šæ—¥ä»»åŠ¡</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="completionRate">0%</div>
                        <div class="stat-label">å®Œæˆç‡</div>
                    </div>
                </div>

                <!-- å¿«é€Ÿç­›é€‰ -->
                <div class="sidebar-section">
                    <h3 class="sidebar-title">å¿«é€Ÿç­›é€‰</h3>
                    <div class="filter-shortcuts">
                        <button class="btn mb-1" onclick="quickFilter('today')">
                            ğŸ“… ä»Šæ—¥ä»»åŠ¡
                        </button>
                        <button class="btn mb-1" onclick="quickFilter('high-priority')">
                            ğŸ”´ é«˜ä¼˜å…ˆçº§
                        </button>
                        <button class="btn mb-1" onclick="quickFilter('overdue')">
                            âš ï¸ é€¾æœŸä»»åŠ¡
                        </button>
                        <button class="btn" onclick="quickFilter('in-progress')">
                            ğŸš€ è¿›è¡Œä¸­
                        </button>
                    </div>
                </div>

                <!-- å­—æ®µæ¨¡æ¿ -->
                <div class="sidebar-section">
                    <h3 class="sidebar-title">å­—æ®µæ¨¡æ¿</h3>
                    <div class="template-list">
                        <button class="btn mb-1" onclick="applyFieldTemplate('basic')">
                            ğŸ“‹ åŸºç¡€æ¨¡æ¿
                        </button>
                        <button class="btn mb-1" onclick="applyFieldTemplate('project')">
                            ğŸ“ é¡¹ç›®æ¨¡æ¿
                        </button>
                        <button class="btn" onclick="applyFieldTemplate('okr')">
                            ğŸ¯ OKRæ¨¡æ¿
                        </button>
                    </div>
                </div>
            </aside>

            <!-- å·¥ä½œåŒº -->
            <div class="workspace">
                <!-- å­—æ®µç®¡ç†è§†å›¾ -->
                <div id="view-fields" class="view-content field-manager">
                    <div class="field-toolbar">
                        <button class="btn btn-primary" onclick="showAddFieldModal()">
                            â• æ·»åŠ å­—æ®µ
                        </button>
                        <button class="btn" onclick="batchEditFields()">
                            âœï¸ æ‰¹é‡ç¼–è¾‘
                        </button>
                        <button class="btn btn-danger" onclick="deleteSelectedFields()">
                            ğŸ—‘ï¸ åˆ é™¤é€‰ä¸­
                        </button>
                        <button class="btn" onclick="exportFieldData()">
                            ğŸ“¤ å¯¼å‡ºæ•°æ®
                        </button>
                        <div style="margin-left: auto; display: flex; align-items: center; gap: 16px;">
                            <div id="filterIndicator" style="display: none; background: var(--bg-active); padding: 6px 12px; border-radius: var(--radius-sm);">
                                <span>ğŸ” ç­›é€‰å·²åº”ç”¨</span>
                                <button class="btn" style="padding: 2px 8px; margin-left: 8px; font-size: 0.75rem;" onclick="clearFilter()">
                                    æ¸…é™¤ç­›é€‰
                                </button>
                            </div>
                            <span>å·²é€‰ä¸­: <span id="selectedCount" style="font-weight: bold;">0</span> é¡¹</span>
                            <input type="text" class="field-input" placeholder="æœç´¢ä»»åŠ¡..." onkeyup="searchTasks(this.value)">
                        </div>
                    </div>
                    
                    <div class="field-table-container">
                        <table class="field-table">
                            <thead>
                                <tr>
                                    <th width="50">
                                        <input type="checkbox" class="checkbox" onchange="toggleAllSelection(this)">
                                    </th>
                                    <th width="100">ç±»å‹</th>
                                    <th width="100">çŠ¶æ€</th>
                                    <th style="min-width: 300px;">ä»»åŠ¡æ ‡é¢˜</th>
                                    <th width="120">ä¼˜å…ˆçº§</th>
                                    <th width="120">æˆªæ­¢æ—¥æœŸ</th>
                                    <th width="200">æ ‡ç­¾</th>
                                    <th width="150">è¿›åº¦</th>
                                    <th width="100">æ“ä½œ</th>
                                </tr>
                            </thead>
                            <tbody id="fieldTableBody">
                                <!-- ä»»åŠ¡è¡Œå°†é€šè¿‡ JavaScript åŠ¨æ€ç”Ÿæˆ -->
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- é«˜çº§ç­›é€‰è§†å›¾ -->
                <div id="view-filter" class="view-content filter-builder hidden">
                    <div class="filter-panel">
                        <h3 class="mb-3">ç­›é€‰æ¡ä»¶æ„å»ºå™¨</h3>
                        
                        <div class="filter-group">
                            <div class="filter-group-header">
                                <h4>ä»»åŠ¡ç±»å‹</h4>
                            </div>
                            <div class="filter-options">
                                <label class="filter-option">
                                    <input type="checkbox" class="checkbox" id="filter-type-goal" value="ç›®æ ‡" checked>
                                    <span>ğŸ¯ ç›®æ ‡</span>
                                </label>
                                <label class="filter-option">
                                    <input type="checkbox" class="checkbox" id="filter-type-kr" value="å…³é”®ç»“æœ" checked>
                                    <span>ğŸ”‘ å…³é”®ç»“æœ</span>
                                </label>
                                <label class="filter-option">
                                    <input type="checkbox" class="checkbox" id="filter-type-project" value="é¡¹ç›®" checked>
                                    <span>ğŸ“ é¡¹ç›®</span>
                                </label>
                                <label class="filter-option">
                                    <input type="checkbox" class="checkbox" id="filter-type-action" value="åŠ¨ä½œ" checked>
                                    <span>âš¡ åŠ¨ä½œ</span>
                                </label>
                            </div>
                        </div>
                        
                        <div class="filter-group">
                            <div class="filter-group-header">
                                <h4>ä»»åŠ¡çŠ¶æ€</h4>
                            </div>
                            <div class="filter-options">
                                <label class="filter-option">
                                    <input type="checkbox" class="checkbox" id="filter-status-todo" value="æœªå¼€å§‹" checked>
                                    <span>â¸ æœªå¼€å§‹</span>
                                </label>
                                <label class="filter-option">
                                    <input type="checkbox" class="checkbox" id="filter-status-doing" value="è¿›è¡Œä¸­" checked>
                                    <span>ğŸš€ è¿›è¡Œä¸­</span>
                                </label>
                                <label class="filter-option">
                                    <input type="checkbox" class="checkbox" id="filter-status-done" value="å·²å®Œæˆ" checked>
                                    <span>âœ… å·²å®Œæˆ</span>
                                </label>
                            </div>
                        </div>
                        
                        <div class="filter-group">
                            <div class="filter-group-header">
                                <h4>ä¼˜å…ˆçº§</h4>
                            </div>
                            <div class="filter-options">
                                <label class="filter-option">
                                    <input type="checkbox" class="checkbox" id="filter-priority-high" value="é«˜" checked>
                                    <span>ğŸ”´ é«˜ä¼˜å…ˆçº§</span>
                                </label>
                                <label class="filter-option">
                                    <input type="checkbox" class="checkbox" id="filter-priority-medium" value="ä¸­" checked>
                                    <span>ğŸŸ¡ ä¸­ä¼˜å…ˆçº§</span>
                                </label>
                                <label class="filter-option">
                                    <input type="checkbox" class="checkbox" id="filter-priority-low" value="ä½" checked>
                                    <span>ğŸŸ¢ ä½ä¼˜å…ˆçº§</span>
                                </label>
                            </div>
                        </div>
                        
                        <button class="btn btn-primary" onclick="applyAdvancedFilter()">
                            åº”ç”¨ç­›é€‰
                        </button>
                        <button class="btn" onclick="resetFilter()">
                            é‡ç½®ç­›é€‰
                        </button>
                    </div>
                    
                    <div class="filter-preview">
                        <h3 class="mb-3">ç­›é€‰ç»“æœé¢„è§ˆ</h3>
                        <div class="preview-stats">
                            <div class="stat-card">
                                <div class="stat-value" id="filterResultCount">0</div>
                                <div class="stat-label">ç¬¦åˆæ¡ä»¶</div>
                            </div>
                            <div class="stat-card">
                                <div class="stat-value" id="filterExcludedCount">0</div>
                                <div class="stat-label">å·²æ’é™¤</div>
                            </div>
                        </div>
                        <div id="filterPreviewList">
                            <!-- ç­›é€‰ç»“æœé¢„è§ˆ -->
                        </div>
                        
                        <div id="filterActions" style="display: none; margin-top: 20px;">
                            <h4 class="mb-2">ç­›é€‰æ“ä½œ</h4>
                            <div style="display: flex; gap: 10px; flex-wrap: wrap;">
                                <button class="btn btn-primary" onclick="showFullFilterResults()">
                                    ğŸ“‹ æŸ¥çœ‹å…¨éƒ¨ç»“æœ
                                </button>
                                <button class="btn" onclick="applyFilterToTable()">
                                    ğŸ“Š åº”ç”¨åˆ°è¡¨æ ¼
                                </button>
                                <button class="btn" onclick="exportFilteredTasks()">
                                    ğŸ“¤ å¯¼å‡ºç­›é€‰ç»“æœ
                                </button>
                                <button class="btn" onclick="selectFilteredTasks()">
                                    âœ… é€‰æ‹©æ‰€æœ‰ç»“æœ
                                </button>
                            </div>
                        </div>
                        
                        <div id="fullFilterResults" style="display: none; margin-top: 20px;">
                            <h4 class="mb-2">å®Œæ•´ç­›é€‰ç»“æœ</h4>
                            <div id="fullFilterResultsList" style="max-height: 400px; overflow-y: auto;">
                                <!-- å®Œæ•´ç»“æœåˆ—è¡¨ -->
                            </div>
                        </div>
                    </div>
                </div>

                <!-- æ‰¹é‡æ“ä½œè§†å›¾ -->
                <div id="view-batch" class="view-content batch-operations hidden">
                    <div class="selection-hint" id="selectionHint" style="display: none;">
                        <span>å·²é€‰æ‹© <strong id="selectedCountHint">0</strong> ä¸ªä»»åŠ¡</span>
                        <button class="btn" onclick="clearSelection()">æ¸…é™¤é€‰æ‹©</button>
                    </div>
                    
                    <div class="batch-selection">
                        <h3 class="mb-3">é€‰æ‹©ä»»åŠ¡</h3>
                        <div class="selection-methods">
                            <div class="selection-method" onclick="selectTasksByType('ç›®æ ‡')">
                                <div class="action-icon">ğŸ¯</div>
                                <h4>æ‰€æœ‰ç›®æ ‡</h4>
                                <p class="text-muted">é€‰æ‹©æ‰€æœ‰ç›®æ ‡ç±»å‹çš„ä»»åŠ¡</p>
                            </div>
                            <div class="selection-method" onclick="selectTasksByStatus('è¿›è¡Œä¸­')">
                                <div class="action-icon">ğŸš€</div>
                                <h4>è¿›è¡Œä¸­ä»»åŠ¡</h4>
                                <p class="text-muted">é€‰æ‹©æ‰€æœ‰è¿›è¡Œä¸­çš„ä»»åŠ¡</p>
                            </div>
                            <div class="selection-method" onclick="selectTasksByPriority('é«˜')">
                                <div class="action-icon">ğŸ”´</div>
                                <h4>é«˜ä¼˜å…ˆçº§</h4>
                                <p class="text-muted">é€‰æ‹©æ‰€æœ‰é«˜ä¼˜å…ˆçº§ä»»åŠ¡</p>
                            </div>
                            <div class="selection-method" onclick="selectOverdueTasks()">
                                <div class="action-icon">âš ï¸</div>
                                <h4>é€¾æœŸä»»åŠ¡</h4>
                                <p class="text-muted">é€‰æ‹©æ‰€æœ‰å·²é€¾æœŸçš„ä»»åŠ¡</p>
                            </div>
                        </div>
                    </div>
                    
                    <div class="batch-actions">
                        <h3 class="mb-3">æ‰¹é‡æ“ä½œ</h3>
                        <div class="action-grid">
                            <div class="action-card" onclick="batchChangeStatus()">
                                <div class="action-icon">ğŸ”„</div>
                                <h4>ä¿®æ”¹çŠ¶æ€</h4>
                            </div>
                            <div class="action-card" onclick="batchChangePriority()">
                                <div class="action-icon">ğŸ”¥</div>
                                <h4>è®¾ç½®ä¼˜å…ˆçº§</h4>
                            </div>
                            <div class="action-card" onclick="batchAddTags()">
                                <div class="action-icon">ğŸ·ï¸</div>
                                <h4>æ·»åŠ æ ‡ç­¾</h4>
                            </div>
                            <div class="action-card" onclick="batchSetDueDate()">
                                <div class="action-icon">ğŸ“…</div>
                                <h4>è®¾ç½®æˆªæ­¢æ—¥æœŸ</h4>
                            </div>
                            <div class="action-card" onclick="batchMove()">
                                <div class="action-icon">ğŸ“</div>
                                <h4>ç§»åŠ¨åˆ°...</h4>
                            </div>
                            <div class="action-card" onclick="batchDelete()">
                                <div class="action-icon">ğŸ—‘ï¸</div>
                                <h4>æ‰¹é‡åˆ é™¤</h4>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- ä»»åŠ¡å…³ç³»è§†å›¾ -->
                <div id="view-tree" class="view-content tree-view hidden">
                    <div id="treeContainer">
                        <!-- æ ‘å½¢ç»“æ„å°†é€šè¿‡ JavaScript åŠ¨æ€ç”Ÿæˆ -->
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- ä¾§è¾¹æ åˆ‡æ¢æŒ‰é’®ï¼ˆç§»åŠ¨ç«¯ï¼‰ -->
    <button class="sidebar-toggle" id="sidebarToggle" onclick="toggleSidebar()">
        â˜°
    </button>

    <!-- ========================================
         ğŸ¯ æ¨¡æ€æ¡†
         ======================================== -->
    <!-- æ·»åŠ å­—æ®µæ¨¡æ€æ¡† -->
    <div class="modal" id="addFieldModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">æ·»åŠ å­—æ®µ</h2>
                <div class="modal-close" onclick="closeModal('addFieldModal')">âœ•</div>
            </div>
            
            <form id="addFieldForm" onsubmit="handleAddField(event)">
                <div class="form-group">
                    <label class="form-label">é€‰æ‹©ä»»åŠ¡</label>
                    <select class="form-select" id="fieldTaskSelect" multiple size="5">
                        <!-- ä»»åŠ¡é€‰é¡¹å°†åŠ¨æ€ç”Ÿæˆ -->
                    </select>
                    <p class="text-muted">æŒ‰ä½ Ctrl/Cmd é”®å¯å¤šé€‰</p>
                </div>
                
                <div class="form-group">
                    <label class="form-label">å­—æ®µç±»å‹</label>
                    <select class="form-select" id="fieldType" onchange="updateFieldValueInput()">
                        <option value="priority">ä¼˜å…ˆçº§</option>
                        <option value="dueDate">æˆªæ­¢æ—¥æœŸ</option>
                        <option value="tags">æ ‡ç­¾</option>
                        <option value="progress">è¿›åº¦</option>
                        <option value="plannedTime">è®¡åˆ’æ—¶é—´</option>
                        <option value="launchLink">å¯åŠ¨é“¾æ¥</option>
                        <option value="custom">è‡ªå®šä¹‰å­—æ®µ</option>
                    </select>
                </div>
                
                <div class="form-group" id="fieldValueGroup">
                    <label class="form-label">å­—æ®µå€¼</label>
                    <div id="fieldValueInput">
                        <select class="form-select" id="priorityValue">
                            <option value="é«˜">ğŸ”´ é«˜ä¼˜å…ˆçº§</option>
                            <option value="ä¸­">ğŸŸ¡ ä¸­ä¼˜å…ˆçº§</option>
                            <option value="ä½">ğŸŸ¢ ä½ä¼˜å…ˆçº§</option>
                        </select>
                    </div>
                </div>
                
                <div class="form-group">
                    <button type="submit" class="btn btn-primary">æ·»åŠ å­—æ®µ</button>
                    <button type="button" class="btn" onclick="closeModal('addFieldModal')">å–æ¶ˆ</button>
                </div>
            </form>
        </div>
    </div>

    <!-- ç¡®è®¤å¯¹è¯æ¡†æ¨¡æ€æ¡† -->
    <div class="modal" id="confirmModal">
        <div class="confirm-dialog">
            <div class="confirm-message" id="confirmMessage">ç¡®å®šè¦æ‰§è¡Œæ­¤æ“ä½œå—ï¼Ÿ</div>
            <div class="confirm-buttons">
                <button class="btn btn-primary" id="confirmYes">ç¡®å®š</button>
                <button class="btn" id="confirmNo">å–æ¶ˆ</button>
            </div>
        </div>
    </div>

    <!-- ä»»åŠ¡è¯¦æƒ…æ¨¡æ€æ¡† -->
    <div class="modal" id="taskDetailModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">ä»»åŠ¡è¯¦æƒ…</h2>
                <div class="modal-close" onclick="closeModal('taskDetailModal')">âœ•</div>
            </div>
            
            <div class="task-detail">
                <div class="detail-section">
                    <div class="detail-label">ä»»åŠ¡æ ‡é¢˜</div>
                    <div class="detail-value" id="detailTitle">-</div>
                </div>
                
                <div class="detail-section">
                    <div class="detail-label">ä»»åŠ¡è·¯å¾„</div>
                    <div class="detail-value" id="detailPath">-</div>
                </div>
                
                <div class="detail-section">
                    <div class="detail-label">ä»»åŠ¡ç±»å‹</div>
                    <div class="detail-value" id="detailType">-</div>
                </div>
                
                <div class="detail-section">
                    <div class="detail-label">ä»»åŠ¡çŠ¶æ€</div>
                    <div class="detail-value" id="detailStatus">-</div>
                </div>
                
                <div class="detail-section">
                    <div class="detail-label">ä¼˜å…ˆçº§</div>
                    <div class="detail-value" id="detailPriority">-</div>
                </div>
                
                <div class="detail-section">
                    <div class="detail-label">æˆªæ­¢æ—¥æœŸ</div>
                    <div class="detail-value" id="detailDueDate">-</div>
                </div>
                
                <div class="detail-section">
                    <div class="detail-label">æ ‡ç­¾</div>
                    <div class="detail-value" id="detailTags">-</div>
                </div>
                
                <div class="detail-section">
                    <div class="detail-label">è¿›åº¦</div>
                    <div class="detail-value" id="detailProgress">-</div>
                </div>
            </div>
        </div>
    </div>

    <script>
        /* ========================================
           ğŸ“Š æµ‹è¯•æ•°æ®ç”Ÿæˆ
           
           åˆ›å»ºä¸€ä¸ªå®Œæ•´çš„ OKR ä½“ç³»ä½œä¸ºæµ‹è¯•æ•°æ®
           åŒ…å«ç›®æ ‡ã€å…³é”®ç»“æœã€é¡¹ç›®ã€åŠ¨ä½œå››ä¸ªå±‚çº§
           ======================================== */
        
        // ä»»åŠ¡æ•°æ®å­˜å‚¨
        let tasks = [];
        let selectedTasks = new Set();
        let currentView = 'fields';
        let lastOperation = null; // è®°å½•æœ€åä¸€æ¬¡æ“ä½œï¼Œç”¨äºæ’¤é”€
        let currentFilteredTasks = null; // å½“å‰ç­›é€‰ç»“æœ
        let isFilterApplied = false; // æ˜¯å¦åº”ç”¨äº†ç­›é€‰

        // ç”Ÿæˆæµ‹è¯•æ•°æ®
        function generateTestData() {
            const now = new Date();
            let taskId = 1;
            
            // OKR 1: æå‡äº§å“ç”¨æˆ·ä½“éªŒ
            const okr1 = {
                id: `task_${taskId++}`,
                type: 'ç›®æ ‡',
                status: 'è¿›è¡Œä¸­',
                title: 'æå‡äº§å“ç”¨æˆ·ä½“éªŒï¼Œå®ç°ç”¨æˆ·æ»¡æ„åº¦è¾¾åˆ° 90%',
                path: '',
                fields: {
                    priority: 'é«˜',
                    today: true,
                    dueDate: new Date(now.getFullYear(), now.getMonth() + 3, 1).toISOString().split('T')[0],
                    tags: ['äº§å“', 'UX', 'Q1ç›®æ ‡'],
                    progress: 45
                }
            };
            tasks.push(okr1);
            
            // OKR 1 - KR 1
            const kr1_1 = {
                id: `task_${taskId++}`,
                type: 'å…³é”®ç»“æœ',
                status: 'è¿›è¡Œä¸­',
                title: 'å®Œæˆç”¨æˆ·ä½“éªŒè°ƒç ”ï¼Œæ”¶é›†è‡³å°‘ 500 ä»½æœ‰æ•ˆåé¦ˆ',
                path: okr1.title,
                fields: {
                    priority: 'é«˜',
                    today: false,
                    dueDate: new Date(now.getFullYear(), now.getMonth() + 1, 15).toISOString().split('T')[0],
                    tags: ['è°ƒç ”', 'UX'],
                    progress: 60
                }
            };
            tasks.push(kr1_1);
            
            // KR1-1 çš„é¡¹ç›®
            const project1_1_1 = {
                id: `task_${taskId++}`,
                type: 'é¡¹ç›®',
                status: 'è¿›è¡Œä¸­',
                title: 'ç”¨æˆ·è®¿è°ˆè®¡åˆ’',
                path: `${okr1.title} >> ${kr1_1.title}`,
                fields: {
                    priority: 'ä¸­',
                    dueDate: new Date(now.getFullYear(), now.getMonth(), 28).toISOString().split('T')[0],
                    tags: ['è®¿è°ˆ', 'è°ƒç ”'],
                    progress: 80
                }
            };
            tasks.push(project1_1_1);
            
            // é¡¹ç›®çš„åŠ¨ä½œ
            tasks.push({
                id: `task_${taskId++}`,
                type: 'åŠ¨ä½œ',
                status: 'å·²å®Œæˆ',
                title: 'åˆ¶å®šè®¿è°ˆå¤§çº²',
                path: `${okr1.title} >> ${kr1_1.title} >> ${project1_1_1.title}`,
                fields: {
                    priority: 'ä¸­',
                    tags: ['æ–‡æ¡£'],
                    progress: 100
                }
            });
            
            tasks.push({
                id: `task_${taskId++}`,
                type: 'åŠ¨ä½œ',
                status: 'è¿›è¡Œä¸­',
                title: 'æ‹›å‹Ÿè®¿è°ˆç”¨æˆ·ï¼ˆç›®æ ‡ 20 äººï¼‰',
                path: `${okr1.title} >> ${kr1_1.title} >> ${project1_1_1.title}`,
                fields: {
                    priority: 'é«˜',
                    today: true,
                    tags: ['æ‹›å‹Ÿ'],
                    progress: 70
                }
            });
            
            tasks.push({
                id: `task_${taskId++}`,
                type: 'åŠ¨ä½œ',
                status: 'æœªå¼€å§‹',
                title: 'æ‰§è¡Œç”¨æˆ·è®¿è°ˆ',
                path: `${okr1.title} >> ${kr1_1.title} >> ${project1_1_1.title}`,
                fields: {
                    priority: 'é«˜',
                    plannedTime: '14:00',
                    tags: ['è®¿è°ˆ'],
                    progress: 0
                }
            });
            
            // KR1-1 çš„ç¬¬äºŒä¸ªé¡¹ç›®
            const project1_1_2 = {
                id: `task_${taskId++}`,
                type: 'é¡¹ç›®',
                status: 'æœªå¼€å§‹',
                title: 'åœ¨çº¿é—®å·è°ƒæŸ¥',
                path: `${okr1.title} >> ${kr1_1.title}`,
                fields: {
                    priority: 'ä¸­',
                    dueDate: new Date(now.getFullYear(), now.getMonth() + 1, 5).toISOString().split('T')[0],
                    tags: ['é—®å·', 'è°ƒç ”'],
                    progress: 0
                }
            };
            tasks.push(project1_1_2);
            
            // OKR 1 - KR 2
            const kr1_2 = {
                id: `task_${taskId++}`,
                type: 'å…³é”®ç»“æœ',
                status: 'æœªå¼€å§‹',
                title: 'é‡æ–°è®¾è®¡æ ¸å¿ƒåŠŸèƒ½ç•Œé¢ï¼Œæå‡æ“ä½œæ•ˆç‡ 30%',
                path: okr1.title,
                fields: {
                    priority: 'é«˜',
                    dueDate: new Date(now.getFullYear(), now.getMonth() + 2, 1).toISOString().split('T')[0],
                    tags: ['è®¾è®¡', 'UI'],
                    progress: 0
                }
            };
            tasks.push(kr1_2);
            
            // OKR 2: æŠ€æœ¯æ¶æ„å‡çº§
            const okr2 = {
                id: `task_${taskId++}`,
                type: 'ç›®æ ‡',
                status: 'æœªå¼€å§‹',
                title: 'å®ŒæˆæŠ€æœ¯æ¶æ„å‡çº§ï¼Œæå‡ç³»ç»Ÿæ€§èƒ½ 50%',
                path: '',
                fields: {
                    priority: 'é«˜',
                    dueDate: new Date(now.getFullYear(), now.getMonth() + 6, 1).toISOString().split('T')[0],
                    tags: ['æŠ€æœ¯', 'æ¶æ„', 'Q2ç›®æ ‡'],
                    progress: 0
                }
            };
            tasks.push(okr2);
            
            // OKR 2 - KR 1
            const kr2_1 = {
                id: `task_${taskId++}`,
                type: 'å…³é”®ç»“æœ',
                status: 'æœªå¼€å§‹',
                title: 'å®Œæˆå¾®æœåŠ¡æ¶æ„è¿ç§»',
                path: okr2.title,
                fields: {
                    priority: 'é«˜',
                    dueDate: new Date(now.getFullYear(), now.getMonth() + 4, 1).toISOString().split('T')[0],
                    tags: ['æ¶æ„', 'å¾®æœåŠ¡'],
                    progress: 0
                }
            };
            tasks.push(kr2_1);
            
            // æ·»åŠ ä¸€äº›é€¾æœŸä»»åŠ¡ä½œä¸ºæµ‹è¯•
            tasks.push({
                id: `task_${taskId++}`,
                type: 'åŠ¨ä½œ',
                status: 'è¿›è¡Œä¸­',
                title: 'æ›´æ–°æŠ€æœ¯æ–‡æ¡£',
                path: `${okr2.title} >> ${kr2_1.title}`,
                fields: {
                    priority: 'ä½',
                    dueDate: new Date(now.getFullYear(), now.getMonth() - 1, 15).toISOString().split('T')[0],
                    tags: ['æ–‡æ¡£', 'é€¾æœŸ'],
                    progress: 30
                }
            });
            
            // ç”Ÿæˆæ›´å¤šæµ‹è¯•æ•°æ®
            for (let i = 0; i < 20; i++) {
                const types = ['ç›®æ ‡', 'å…³é”®ç»“æœ', 'é¡¹ç›®', 'åŠ¨ä½œ'];
                const statuses = ['æœªå¼€å§‹', 'è¿›è¡Œä¸­', 'å·²å®Œæˆ'];
                const priorities = ['é«˜', 'ä¸­', 'ä½'];
                const type = types[Math.floor(Math.random() * types.length)];
                
                tasks.push({
                    id: `task_${taskId++}`,
                    type: type,
                    status: statuses[Math.floor(Math.random() * statuses.length)],
                    title: `æµ‹è¯•ä»»åŠ¡ ${i + 1} - ${type}`,
                    path: type === 'ç›®æ ‡' ? '' : 'ç¤ºä¾‹è·¯å¾„',
                    fields: {
                        priority: priorities[Math.floor(Math.random() * priorities.length)],
                        today: Math.random() > 0.7,
                        dueDate: new Date(now.getTime() + (Math.random() - 0.5) * 60 * 24 * 60 * 60 * 1000).toISOString().split('T')[0],
                        tags: ['æµ‹è¯•', type],
                        progress: Math.floor(Math.random() * 101)
                    }
                });
            }
            
            console.log(`âœ… ç”Ÿæˆäº† ${tasks.length} ä¸ªæµ‹è¯•ä»»åŠ¡`);
        }

        /* ========================================
           ğŸ¯ æ ¸å¿ƒåŠŸèƒ½å®ç°
           ======================================== */
        
        // åˆå§‹åŒ–åº”ç”¨
        function initApp() {
            // ç”Ÿæˆæµ‹è¯•æ•°æ®
            generateTestData();
            
            // åˆå§‹åŒ–å„ä¸ªè§†å›¾
            renderFieldTable();
            updateStats();
            renderTreeView();
            
            // ç»‘å®šå…¨å±€äº‹ä»¶
            bindGlobalEvents();
            
            console.log('ğŸš€ åº”ç”¨åˆå§‹åŒ–å®Œæˆ');
        }

        // åˆ‡æ¢è§†å›¾
        function switchView(viewName) {
            // æ›´æ–°æŒ‰é’®çŠ¶æ€
            document.querySelectorAll('.view-btn').forEach(btn => {
                btn.classList.toggle('active', btn.dataset.view === viewName);
            });
            
            // åˆ‡æ¢è§†å›¾å†…å®¹
            document.querySelectorAll('.view-content').forEach(view => {
                view.classList.add('hidden');
            });
            document.getElementById(`view-${viewName}`).classList.remove('hidden');
            
            currentView = viewName;
            
            // æ›´æ–°é€‰æ‹©æç¤º
            updateSelectionHint();
        }

        // æ›´æ–°ç»Ÿè®¡æ•°æ®
        function updateStats() {
            const total = tasks.length;
            const today = tasks.filter(t => t.fields.today).length;
            const completed = tasks.filter(t => t.status === 'å·²å®Œæˆ').length;
            const completionRate = total > 0 ? Math.round((completed / total) * 100) : 0;
            
            document.getElementById('totalTasks').textContent = total;
            document.getElementById('todayTasks').textContent = today;
            document.getElementById('completionRate').textContent = `${completionRate}%`;
        }

        // æ˜¾ç¤ºæç¤ºæ¶ˆæ¯
        function showToast(message, type = 'success') {
            const toast = document.createElement('div');
            toast.className = `toast ${type}`;
            toast.innerHTML = `
                <span>${type === 'success' ? 'âœ…' : 'âŒ'}</span>
                <span>${message}</span>
            `;
            
            document.body.appendChild(toast);
            
            setTimeout(() => {
                toast.style.animation = 'toastSlideUp 0.3s ease reverse';
                setTimeout(() => {
                    document.body.removeChild(toast);
                }, 300);
            }, 3000);
        }

        // æ˜¾ç¤ºç¡®è®¤å¯¹è¯æ¡†
        function showConfirm(message) {
            return new Promise((resolve) => {
                const modal = document.getElementById('confirmModal');
                const messageEl = document.getElementById('confirmMessage');
                const yesBtn = document.getElementById('confirmYes');
                const noBtn = document.getElementById('confirmNo');
                
                messageEl.textContent = message;
                modal.classList.add('active');
                
                const handleYes = () => {
                    cleanup();
                    resolve(true);
                };
                
                const handleNo = () => {
                    cleanup();
                    resolve(false);
                };
                
                const cleanup = () => {
                    modal.classList.remove('active');
                    yesBtn.removeEventListener('click', handleYes);
                    noBtn.removeEventListener('click', handleNo);
                };
                
                yesBtn.addEventListener('click', handleYes);
                noBtn.addEventListener('click', handleNo);
            });
        }

        /* ========================================
           ğŸ“ å­—æ®µç®¡ç†åŠŸèƒ½
           ======================================== */
        
        // æ¸²æŸ“å­—æ®µè¡¨æ ¼
        function renderFieldTable() {
            try {
                const tbody = document.getElementById('fieldTableBody');
                if (!tbody) {
                    console.error('æœªæ‰¾åˆ°è¡¨æ ¼ä¸»ä½“å…ƒç´ ');
                    return;
                }
                
                tbody.innerHTML = '';
                
                // å†³å®šè¦æ˜¾ç¤ºçš„ä»»åŠ¡åˆ—è¡¨
                const tasksToDisplay = isFilterApplied && currentFilteredTasks ? currentFilteredTasks : tasks;
                
                if (!tasksToDisplay || tasksToDisplay.length === 0) {
                    const message = isFilterApplied ? 'æ²¡æœ‰ç¬¦åˆç­›é€‰æ¡ä»¶çš„ä»»åŠ¡' : 'æš‚æ— ä»»åŠ¡æ•°æ®';
                    tbody.innerHTML = `<tr><td colspan="9" class="text-center text-muted">${message}</td></tr>`;
                    return;
                }
                
                tasksToDisplay.forEach(task => {
                    if (!task || !task.id) {
                        console.warn('è·³è¿‡æ— æ•ˆä»»åŠ¡:', task);
                        return;
                    }
                    
                    // ç¡®ä¿ fields å¯¹è±¡å­˜åœ¨
                    if (!task.fields) {
                        task.fields = {};
                    }
                    
                    const tr = document.createElement('tr');
                    tr.dataset.taskId = task.id;
                    if (selectedTasks.has(task.id)) {
                        tr.classList.add('selected');
                    }
                    
                    // æ„å»ºä»»åŠ¡ç±»å‹å›¾æ ‡
                    const typeIcon = {
                        'ç›®æ ‡': 'ğŸ¯',
                        'å…³é”®ç»“æœ': 'ğŸ”‘',
                        'é¡¹ç›®': 'ğŸ“',
                        'åŠ¨ä½œ': 'âš¡'
                    }[task.type] || 'ğŸ“‹';
                
                // æ„å»ºä¼˜å…ˆçº§é€‰æ‹©å™¨
                const priorityHtml = `
                    <div class="priority-selector">
                        <div class="priority-option high ${task.fields.priority === 'é«˜' ? 'selected' : ''}" 
                             onclick="updatePriority('${task.id}', 'é«˜')" title="é«˜ä¼˜å…ˆçº§"></div>
                        <div class="priority-option medium ${task.fields.priority === 'ä¸­' ? 'selected' : ''}" 
                             onclick="updatePriority('${task.id}', 'ä¸­')" title="ä¸­ä¼˜å…ˆçº§"></div>
                        <div class="priority-option low ${task.fields.priority === 'ä½' ? 'selected' : ''}" 
                             onclick="updatePriority('${task.id}', 'ä½')" title="ä½ä¼˜å…ˆçº§"></div>
                    </div>
                `;
                
                // æ„å»ºæ ‡ç­¾HTML
                const tagsHtml = (task.fields.tags || []).map(tag => 
                    `<span class="tag">${tag} <span class="tag-remove" onclick="removeTag('${task.id}', '${tag}')">Ã—</span></span>`
                ).join(' ');
                
                // æ£€æŸ¥æ˜¯å¦é€¾æœŸ
                const isOverdue = task.fields.dueDate && new Date(task.fields.dueDate) < new Date() && task.status !== 'å·²å®Œæˆ';
                
                // æ„å»ºè¿›åº¦æ¡
                const progress = task.fields.progress || 0;
                const progressHtml = `
                    <div class="progress-container">
                        <div class="progress-bar">
                            <div class="progress-fill" style="width: ${progress}%"></div>
                        </div>
                        <span class="progress-text">${progress}%</span>
                    </div>
                `;
                
                tr.innerHTML = `
                    <td>
                        <input type="checkbox" class="checkbox" 
                               ${selectedTasks.has(task.id) ? 'checked' : ''}
                               onchange="toggleTaskSelection('${task.id}')">
                    </td>
                    <td>
                        <span class="task-type-badge ${task.type === 'ç›®æ ‡' ? 'goal' : 
                                                      task.type === 'å…³é”®ç»“æœ' ? 'kr' : 
                                                      task.type === 'é¡¹ç›®' ? 'project' : 'action'}">
                            ${typeIcon} ${task.type}
                        </span>
                    </td>
                    <td>
                        <div class="status-indicator">
                            <span class="status-dot ${task.status === 'æœªå¼€å§‹' ? 'todo' : 
                                                     task.status === 'è¿›è¡Œä¸­' ? 'doing' : 'done'}"></span>
                            ${task.status}
                        </div>
                    </td>
                    <td>
                        <div class="task-title">
                            ${task.title}
                            ${task.fields.today ? '<span class="tag">ğŸ“… ä»Šæ—¥</span>' : ''}
                            ${isOverdue ? '<span class="tag" style="background: rgba(252, 129, 129, 0.2); color: var(--priority-high);">âš ï¸ é€¾æœŸ</span>' : ''}
                        </div>
                        ${task.path ? `<div class="task-path">ğŸ“ ${task.path}</div>` : ''}
                    </td>
                    <td>${priorityHtml}</td>
                    <td>
                        <input type="date" class="field-input" 
                               value="${task.fields.dueDate || ''}"
                               onchange="updateDueDate('${task.id}', this.value)">
                    </td>
                    <td>
                        <div class="field-value">
                            ${tagsHtml}
                            <button class="btn" style="padding: 2px 8px; font-size: 0.75rem;" 
                                    onclick="addTag('${task.id}')">+</button>
                        </div>
                    </td>
                    <td>
                        <input type="range" min="0" max="100" 
                               value="${progress}"
                               onchange="updateProgress('${task.id}', this.value)"
                               style="width: 100%;">
                        <div class="progress-text text-center">${progress}%</div>
                    </td>
                    <td>
                        <button class="btn" style="padding: 4px 8px;" 
                                onclick="viewTaskDetail('${task.id}')">æŸ¥çœ‹</button>
                    </td>
                `;
                
                    tbody.appendChild(tr);
                });
            } catch (error) {
                console.error('æ¸²æŸ“å­—æ®µè¡¨æ ¼æ—¶å‡ºé”™:', error);
                showToast('æ¸²æŸ“è¡¨æ ¼å¤±è´¥ï¼Œè¯·åˆ·æ–°é¡µé¢', 'error');
            }
        }

        // æ›´æ–°ä¼˜å…ˆçº§
        function updatePriority(taskId, priority) {
            const task = tasks.find(t => t.id === taskId);
            if (task) {
                task.fields.priority = priority;
                renderFieldTable();
                showToast(`ä¼˜å…ˆçº§å·²æ›´æ–°ä¸º: ${priority}`);
            }
        }

        // æ›´æ–°æˆªæ­¢æ—¥æœŸ
        function updateDueDate(taskId, date) {
            const task = tasks.find(t => t.id === taskId);
            if (task) {
                task.fields.dueDate = date;
                showToast(`æˆªæ­¢æ—¥æœŸå·²æ›´æ–°`);
            }
        }

        // æ›´æ–°è¿›åº¦
        function updateProgress(taskId, progress) {
            try {
                const task = tasks.find(t => t.id === taskId);
                if (!task) {
                    console.error('æœªæ‰¾åˆ°ä»»åŠ¡:', taskId);
                    return;
                }
                
                task.fields.progress = parseInt(progress);
                
                // æ›´æ–°è¿›åº¦æ¡æ˜¾ç¤º
                const row = document.querySelector(`tr[data-task-id="${taskId}"]`);
                if (row) {
                    const progressFill = row.querySelector('.progress-fill');
                    const progressTexts = row.querySelectorAll('.progress-text');
                    
                    if (progressFill) {
                        progressFill.style.width = `${progress}%`;
                    }
                    
                    // æ›´æ–°æ‰€æœ‰è¿›åº¦æ–‡æœ¬ï¼ˆå¯èƒ½æœ‰å¤šä¸ªï¼‰
                    progressTexts.forEach(text => {
                        if (text) {
                            text.textContent = `${progress}%`;
                        }
                    });
                }
                
                showToast(`è¿›åº¦å·²æ›´æ–°ä¸º: ${progress}%`);
            } catch (error) {
                console.error('æ›´æ–°è¿›åº¦æ—¶å‡ºé”™:', error);
                showToast('æ›´æ–°è¿›åº¦å¤±è´¥', 'error');
            }
        }

        // æ·»åŠ æ ‡ç­¾
        function addTag(taskId) {
            const tag = prompt('è¾“å…¥æ ‡ç­¾åç§°:');
            if (tag && tag.trim()) {
                const task = tasks.find(t => t.id === taskId);
                if (task) {
                    if (!task.fields.tags) task.fields.tags = [];
                    if (!task.fields.tags.includes(tag)) {
                        task.fields.tags.push(tag);
                        renderFieldTable();
                        showToast(`æ ‡ç­¾ "${tag}" å·²æ·»åŠ `);
                    }
                }
            }
        }

        // ç§»é™¤æ ‡ç­¾
        function removeTag(taskId, tag) {
            const task = tasks.find(t => t.id === taskId);
            if (task && task.fields.tags) {
                task.fields.tags = task.fields.tags.filter(t => t !== tag);
                renderFieldTable();
                showToast(`æ ‡ç­¾ "${tag}" å·²ç§»é™¤`);
            }
        }

        // æŸ¥çœ‹ä»»åŠ¡è¯¦æƒ…
        function viewTaskDetail(taskId) {
            try {
                const task = tasks.find(t => t.id === taskId);
                if (!task) {
                    showToast('æœªæ‰¾åˆ°ä»»åŠ¡è¯¦æƒ…', 'error');
                    return;
                }
            
                // ç¡®ä¿ fields å¯¹è±¡å­˜åœ¨
                if (!task.fields) {
                    task.fields = {};
                }
                
                document.getElementById('detailTitle').textContent = task.title || 'æ— æ ‡é¢˜';
                document.getElementById('detailPath').textContent = task.path || 'æ— ';
                document.getElementById('detailType').textContent = task.type || 'æœªçŸ¥';
                document.getElementById('detailStatus').textContent = task.status || 'æœªçŸ¥';
                document.getElementById('detailPriority').textContent = task.fields.priority || 'æœªè®¾ç½®';
                document.getElementById('detailDueDate').textContent = task.fields.dueDate || 'æœªè®¾ç½®';
                document.getElementById('detailTags').textContent = (task.fields.tags || []).join(', ') || 'æ— ';
                document.getElementById('detailProgress').textContent = `${task.fields.progress || 0}%`;
                
                document.getElementById('taskDetailModal').classList.add('active');
            } catch (error) {
                console.error('æŸ¥çœ‹ä»»åŠ¡è¯¦æƒ…æ—¶å‡ºé”™:', error);
                showToast('æ— æ³•æ˜¾ç¤ºä»»åŠ¡è¯¦æƒ…', 'error');
            }
        }

        // ä»»åŠ¡é€‰æ‹©ç®¡ç†
        function toggleTaskSelection(taskId) {
            if (selectedTasks.has(taskId)) {
                selectedTasks.delete(taskId);
            } else {
                selectedTasks.add(taskId);
            }
            
            // æ›´æ–°è¡Œæ ·å¼
            const tr = document.querySelector(`tr[data-task-id="${taskId}"]`);
            if (tr) {
                tr.classList.toggle('selected', selectedTasks.has(taskId));
            }
            
            // æ›´æ–°é€‰ä¸­æ•°é‡
            updateSelectionHint();
        }

        // å…¨é€‰/å–æ¶ˆå…¨é€‰
        function toggleAllSelection(checkbox) {
            if (checkbox.checked) {
                tasks.forEach(task => selectedTasks.add(task.id));
            } else {
                selectedTasks.clear();
            }
            renderFieldTable();
            updateSelectionHint();
        }

        // æ›´æ–°é€‰æ‹©æç¤º
        function updateSelectionHint() {
            const count = selectedTasks.size;
            
            // å®‰å…¨æ›´æ–° selectedCount å…ƒç´ 
            const selectedCountEl = document.getElementById('selectedCount');
            if (selectedCountEl) {
                selectedCountEl.textContent = count;
            }
            
            // å®‰å…¨æ›´æ–° selectedCountHint å…ƒç´ 
            const selectedCountHintEl = document.getElementById('selectedCountHint');
            if (selectedCountHintEl) {
                selectedCountHintEl.textContent = count;
            }
            
            // å®‰å…¨æ›´æ–° selectionHint å…ƒç´ 
            const hint = document.getElementById('selectionHint');
            if (hint) {
                hint.style.display = count > 0 ? 'flex' : 'none';
            }
        }

        // æ¸…é™¤é€‰æ‹©
        function clearSelection() {
            selectedTasks.clear();
            if (currentView === 'fields') {
                renderFieldTable();
            }
            updateSelectionHint();
        }

        // æœç´¢ä»»åŠ¡
        function searchTasks(keyword) {
            const rows = document.querySelectorAll('#fieldTableBody tr');
            if (!rows || rows.length === 0) return;
            
            keyword = keyword.toLowerCase();
            
            rows.forEach(row => {
                try {
                    const titleElement = row.querySelector('.task-title');
                    if (!titleElement) {
                        row.style.display = '';
                        return;
                    }
                    
                    const title = titleElement.textContent.toLowerCase();
                    const pathElement = row.querySelector('.task-path');
                    const path = pathElement ? pathElement.textContent.toLowerCase() : '';
                    
                    const visible = !keyword || title.includes(keyword) || path.includes(keyword);
                    row.style.display = visible ? '' : 'none';
                } catch (error) {
                    console.error('æœç´¢ä»»åŠ¡æ—¶å‡ºé”™:', error);
                    row.style.display = '';
                }
            });
        }

        // æ‰¹é‡ç¼–è¾‘å­—æ®µ
        function batchEditFields() {
            if (selectedTasks.size === 0) {
                showToast('è¯·å…ˆé€‰æ‹©è¦ç¼–è¾‘çš„ä»»åŠ¡', 'error');
                return;
            }
            
            // æ˜¾ç¤ºæ·»åŠ å­—æ®µæ¨¡æ€æ¡†ï¼Œç”¨äºæ‰¹é‡ç¼–è¾‘
            showAddFieldModal();
        }

        // åˆ é™¤é€‰ä¸­å­—æ®µ
        async function deleteSelectedFields() {
            if (selectedTasks.size === 0) {
                showToast('è¯·å…ˆé€‰æ‹©è¦åˆ é™¤çš„ä»»åŠ¡', 'error');
                return;
            }
            
            const confirmed = await showConfirm(`ç¡®å®šè¦åˆ é™¤é€‰ä¸­çš„ ${selectedTasks.size} ä¸ªä»»åŠ¡å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ¢å¤ã€‚`);
            if (!confirmed) return;
            
            // ä¿å­˜æ“ä½œç”¨äºæ’¤é”€
            lastOperation = {
                type: 'delete',
                tasks: tasks.filter(t => selectedTasks.has(t.id))
            };
            
            // åˆ é™¤ä»»åŠ¡
            tasks = tasks.filter(t => !selectedTasks.has(t.id));
            selectedTasks.clear();
            
            renderFieldTable();
            updateStats();
            showToast('ä»»åŠ¡å·²åˆ é™¤');
        }

        // å¯¼å‡ºå­—æ®µæ•°æ®
        function exportFieldData() {
            const exportData = tasks.map(task => ({
                id: task.id,
                type: task.type,
                status: task.status,
                title: task.title,
                path: task.path,
                priority: task.fields.priority,
                dueDate: task.fields.dueDate,
                tags: (task.fields.tags || []).join(', '),
                progress: task.fields.progress
            }));
            
            const csv = convertToCSV(exportData);
            downloadFile(csv, 'tasks_export.csv', 'text/csv');
            
            showToast('æ•°æ®å·²å¯¼å‡º');
        }

        // è½¬æ¢ä¸ºCSVæ ¼å¼
        function convertToCSV(data) {
            if (data.length === 0) return '';
            
            const headers = Object.keys(data[0]);
            const csvHeaders = headers.join(',');
            
            const csvRows = data.map(row => {
                return headers.map(header => {
                    const value = row[header] || '';
                    // å¦‚æœåŒ…å«é€—å·æˆ–æ¢è¡Œï¼Œéœ€è¦ç”¨å¼•å·åŒ…è£¹
                    return value.toString().includes(',') || value.toString().includes('\n') 
                        ? `"${value.toString().replace(/"/g, '""')}"` 
                        : value;
                }).join(',');
            });
            
            return [csvHeaders, ...csvRows].join('\n');
        }

        // ä¸‹è½½æ–‡ä»¶
        function downloadFile(content, fileName, contentType) {
            const blob = new Blob([content], { type: contentType });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = fileName;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }

        /* ========================================
           ğŸ” é«˜çº§ç­›é€‰åŠŸèƒ½
           ======================================== */
        
        // åº”ç”¨é«˜çº§ç­›é€‰
        function applyAdvancedFilter() {
            const typeFilters = Array.from(document.querySelectorAll('#view-filter input[id^="filter-type-"]:checked'))
                .map(cb => cb.value);
            const statusFilters = Array.from(document.querySelectorAll('#view-filter input[id^="filter-status-"]:checked'))
                .map(cb => cb.value);
            const priorityFilters = Array.from(document.querySelectorAll('#view-filter input[id^="filter-priority-"]:checked'))
                .map(cb => cb.value);
            
            const filteredTasks = tasks.filter(task => {
                const typeMatch = typeFilters.length === 0 || typeFilters.includes(task.type);
                const statusMatch = statusFilters.length === 0 || statusFilters.includes(task.status);
                const priorityMatch = priorityFilters.length === 0 || priorityFilters.includes(task.fields.priority);
                
                return typeMatch && statusMatch && priorityMatch;
            });
            
            // ä¿å­˜ç­›é€‰ç»“æœ
            currentFilteredTasks = filteredTasks;
            isFilterApplied = true;
            
            document.getElementById('filterResultCount').textContent = filteredTasks.length;
            document.getElementById('filterExcludedCount').textContent = tasks.length - filteredTasks.length;
            
            // æ¸²æŸ“ç­›é€‰ç»“æœé¢„è§ˆ
            const previewList = document.getElementById('filterPreviewList');
            previewList.innerHTML = filteredTasks.slice(0, 10).map(task => {
                const typeIcon = {
                    'ç›®æ ‡': 'ğŸ¯',
                    'å…³é”®ç»“æœ': 'ğŸ”‘',
                    'é¡¹ç›®': 'ğŸ“',
                    'åŠ¨ä½œ': 'âš¡'
                }[task.type] || 'ğŸ“‹';
                
                return `
                    <div class="task-card" style="margin-bottom: 8px; padding: 12px; background: var(--bg-card); border-radius: 8px;">
                        <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 4px;">
                            <span class="task-type-badge ${task.type === 'ç›®æ ‡' ? 'goal' : 
                                                          task.type === 'å…³é”®ç»“æœ' ? 'kr' : 
                                                          task.type === 'é¡¹ç›®' ? 'project' : 'action'}">
                                ${typeIcon} ${task.type}
                            </span>
                            <span class="status-indicator">
                                <span class="status-dot ${task.status === 'æœªå¼€å§‹' ? 'todo' : 
                                                         task.status === 'è¿›è¡Œä¸­' ? 'doing' : 'done'}"></span>
                                ${task.status}
                            </span>
                        </div>
                        <strong>${task.title}</strong>
                        ${task.path ? `<div class="task-path">ğŸ“ ${task.path}</div>` : ''}
                    </div>
                `;
            }).join('');
            
            if (filteredTasks.length > 10) {
                previewList.innerHTML += `<p class="text-center text-muted">è¿˜æœ‰ ${filteredTasks.length - 10} ä¸ªä»»åŠ¡...</p>`;
            } else if (filteredTasks.length === 0) {
                previewList.innerHTML = '<p class="text-center text-muted">æ²¡æœ‰ç¬¦åˆæ¡ä»¶çš„ä»»åŠ¡</p>';
            }
            
            // æ˜¾ç¤ºæˆ–éšè—æ“ä½œæŒ‰é’®
            const filterActions = document.getElementById('filterActions');
            if (filterActions) {
                filterActions.style.display = filteredTasks.length > 0 ? 'block' : 'none';
            }
            
            // éšè—å®Œæ•´ç»“æœåŒºåŸŸï¼ˆç­‰å¾…ç”¨æˆ·ç‚¹å‡»æŸ¥çœ‹ï¼‰
            const fullResults = document.getElementById('fullFilterResults');
            if (fullResults) {
                fullResults.style.display = 'none';
            }
            
            showToast(`ç­›é€‰å®Œæˆï¼Œæ‰¾åˆ° ${filteredTasks.length} ä¸ªä»»åŠ¡`);
        }

        // é‡ç½®ç­›é€‰
        function resetFilter() {
            document.querySelectorAll('#view-filter input[type="checkbox"]').forEach(cb => {
                cb.checked = true;
            });
            currentFilteredTasks = null;
            isFilterApplied = false;
            applyAdvancedFilter();
        }
        
        // æ˜¾ç¤ºå®Œæ•´ç­›é€‰ç»“æœ
        function showFullFilterResults() {
            if (!currentFilteredTasks || currentFilteredTasks.length === 0) {
                showToast('æ²¡æœ‰ç­›é€‰ç»“æœå¯æ˜¾ç¤º', 'error');
                return;
            }
            
            const fullResults = document.getElementById('fullFilterResults');
            const resultsList = document.getElementById('fullFilterResultsList');
            
            if (!fullResults || !resultsList) {
                console.error('å®Œæ•´ç»“æœå®¹å™¨æœªæ‰¾åˆ°');
                return;
            }
            
            // æ¸²æŸ“æ‰€æœ‰ç­›é€‰ç»“æœ
            resultsList.innerHTML = currentFilteredTasks.map((task, index) => {
                const typeIcon = {
                    'ç›®æ ‡': 'ğŸ¯',
                    'å…³é”®ç»“æœ': 'ğŸ”‘',
                    'é¡¹ç›®': 'ğŸ“',
                    'åŠ¨ä½œ': 'âš¡'
                }[task.type] || 'ğŸ“‹';
                
                return `
                    <div class="task-card" style="margin-bottom: 12px; padding: 16px; background: var(--bg-card); border-radius: 8px; border: 1px solid var(--glass-border);">
                        <div style="display: flex; justify-content: space-between; align-items: start;">
                            <div style="flex: 1;">
                                <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 8px;">
                                    <span style="color: var(--text-muted); font-size: 0.875rem;">#${index + 1}</span>
                                    <span class="task-type-badge ${task.type === 'ç›®æ ‡' ? 'goal' : 
                                                                  task.type === 'å…³é”®ç»“æœ' ? 'kr' : 
                                                                  task.type === 'é¡¹ç›®' ? 'project' : 'action'}">
                                        ${typeIcon} ${task.type}
                                    </span>
                                    <span class="status-indicator">
                                        <span class="status-dot ${task.status === 'æœªå¼€å§‹' ? 'todo' : 
                                                                 task.status === 'è¿›è¡Œä¸­' ? 'doing' : 'done'}"></span>
                                        ${task.status}
                                    </span>
                                    ${task.fields.priority ? `<span class="tag">${task.fields.priority === 'é«˜' ? 'ğŸ”´' : task.fields.priority === 'ä¸­' ? 'ğŸŸ¡' : 'ğŸŸ¢'} ${task.fields.priority}</span>` : ''}
                                </div>
                                <h4 style="margin: 0 0 8px 0; font-size: 1rem;">${task.title}</h4>
                                ${task.path ? `<div class="task-path">ğŸ“ ${task.path}</div>` : ''}
                                <div style="display: flex; gap: 8px; margin-top: 8px; flex-wrap: wrap;">
                                    ${task.fields.today ? '<span class="tag">ğŸ“… ä»Šæ—¥</span>' : ''}
                                    ${task.fields.dueDate ? `<span class="tag">â° ${task.fields.dueDate}</span>` : ''}
                                    ${task.fields.tags ? task.fields.tags.map(tag => `<span class="tag">${tag}</span>`).join('') : ''}
                                    ${task.fields.progress !== undefined ? `<span class="tag">ğŸ“Š ${task.fields.progress}%</span>` : ''}
                                </div>
                            </div>
                            <button class="btn" style="margin-left: 16px;" onclick="viewTaskDetail('${task.id}')">
                                æŸ¥çœ‹è¯¦æƒ…
                            </button>
                        </div>
                    </div>
                `;
            }).join('');
            
            // æ˜¾ç¤ºå®Œæ•´ç»“æœåŒºåŸŸ
            fullResults.style.display = 'block';
            resultsList.scrollTop = 0;
            
            showToast(`æ˜¾ç¤ºå…¨éƒ¨ ${currentFilteredTasks.length} ä¸ªç­›é€‰ç»“æœ`);
        }
        
        // åº”ç”¨ç­›é€‰åˆ°è¡¨æ ¼
        function applyFilterToTable() {
            if (!currentFilteredTasks || currentFilteredTasks.length === 0) {
                showToast('æ²¡æœ‰ç­›é€‰ç»“æœå¯åº”ç”¨', 'error');
                return;
            }
            
            // åˆ‡æ¢åˆ°å­—æ®µç®¡ç†è§†å›¾
            switchView('fields');
            
            // æ ‡è®°ç­›é€‰å·²åº”ç”¨
            isFilterApplied = true;
            
            // æ˜¾ç¤ºç­›é€‰æŒ‡ç¤ºå™¨
            const indicator = document.getElementById('filterIndicator');
            if (indicator) {
                indicator.style.display = 'flex';
            }
            
            // æ›´æ–°æ˜¾ç¤ºé€»è¾‘ï¼ˆé€šè¿‡ä¿®æ”¹ renderFieldTable æ¥å®ç°ï¼‰
            renderFieldTable();
            
            showToast(`å·²åº”ç”¨ç­›é€‰ï¼Œæ˜¾ç¤º ${currentFilteredTasks.length} ä¸ªä»»åŠ¡`);
        }
        
        // å¯¼å‡ºç­›é€‰ç»“æœ
        function exportFilteredTasks() {
            if (!currentFilteredTasks || currentFilteredTasks.length === 0) {
                showToast('æ²¡æœ‰ç­›é€‰ç»“æœå¯å¯¼å‡º', 'error');
                return;
            }
            
            const exportData = currentFilteredTasks.map(task => ({
                id: task.id,
                type: task.type,
                status: task.status,
                title: task.title,
                path: task.path || '',
                priority: task.fields.priority || '',
                dueDate: task.fields.dueDate || '',
                tags: (task.fields.tags || []).join(', '),
                progress: task.fields.progress || 0,
                today: task.fields.today ? 'æ˜¯' : 'å¦'
            }));
            
            const csv = convertToCSV(exportData);
            const fileName = `ç­›é€‰ç»“æœ_${new Date().toISOString().split('T')[0]}.csv`;
            downloadFile(csv, fileName, 'text/csv;charset=utf-8');
            
            showToast(`å·²å¯¼å‡º ${currentFilteredTasks.length} ä¸ªç­›é€‰ç»“æœ`);
        }
        
        // é€‰æ‹©æ‰€æœ‰ç­›é€‰ç»“æœ
        function selectFilteredTasks() {
            if (!currentFilteredTasks || currentFilteredTasks.length === 0) {
                showToast('æ²¡æœ‰ç­›é€‰ç»“æœå¯é€‰æ‹©', 'error');
                return;
            }
            
            // æ¸…ç©ºå½“å‰é€‰æ‹©
            selectedTasks.clear();
            
            // é€‰æ‹©æ‰€æœ‰ç­›é€‰ç»“æœ
            currentFilteredTasks.forEach(task => {
                selectedTasks.add(task.id);
            });
            
            // åˆ‡æ¢åˆ°æ‰¹é‡æ“ä½œè§†å›¾
            switchView('batch');
            
            // æ›´æ–°é€‰æ‹©æç¤º
            updateSelectionHint();
            
            showToast(`å·²é€‰æ‹© ${selectedTasks.size} ä¸ªç­›é€‰ç»“æœ`);
        }

        // æ¸…é™¤ç­›é€‰
        function clearFilter() {
            isFilterApplied = false;
            currentFilteredTasks = null;
            
            // éšè—ç­›é€‰æŒ‡ç¤ºå™¨
            const indicator = document.getElementById('filterIndicator');
            if (indicator) {
                indicator.style.display = 'none';
            }
            
            // é‡æ–°æ¸²æŸ“è¡¨æ ¼
            renderFieldTable();
            
            showToast('ç­›é€‰å·²æ¸…é™¤');
        }

        // å¿«é€Ÿç­›é€‰
        function quickFilter(type) {
            let filteredTasks = [];
            let message = '';
            
            switch (type) {
                case 'today':
                    filteredTasks = tasks.filter(t => t.fields.today);
                    message = `ä»Šæ—¥ä»»åŠ¡: ${filteredTasks.length} ä¸ª`;
                    break;
                case 'high-priority':
                    filteredTasks = tasks.filter(t => t.fields.priority === 'é«˜');
                    message = `é«˜ä¼˜å…ˆçº§ä»»åŠ¡: ${filteredTasks.length} ä¸ª`;
                    break;
                case 'overdue':
                    filteredTasks = tasks.filter(t => {
                        return t.fields.dueDate && 
                               new Date(t.fields.dueDate) < new Date() && 
                               t.status !== 'å·²å®Œæˆ';
                    });
                    message = `é€¾æœŸä»»åŠ¡: ${filteredTasks.length} ä¸ª`;
                    break;
                case 'in-progress':
                    filteredTasks = tasks.filter(t => t.status === 'è¿›è¡Œä¸­');
                    message = `è¿›è¡Œä¸­ä»»åŠ¡: ${filteredTasks.length} ä¸ª`;
                    break;
            }
            
            // åˆ‡æ¢åˆ°ç­›é€‰è§†å›¾å¹¶æ˜¾ç¤ºç»“æœ
            switchView('filter');
            
            // æ›´æ–°ç­›é€‰ç»“æœ
            document.getElementById('filterResultCount').textContent = filteredTasks.length;
            document.getElementById('filterExcludedCount').textContent = tasks.length - filteredTasks.length;
            
            showToast(message);
        }

        /* ========================================
           âš¡ æ‰¹é‡æ“ä½œåŠŸèƒ½
           ======================================== */
        
        // æŒ‰ç±»å‹é€‰æ‹©ä»»åŠ¡
        function selectTasksByType(type) {
            selectedTasks.clear();
            tasks.forEach(task => {
                if (task.type === type) {
                    selectedTasks.add(task.id);
                }
            });
            
            if (currentView === 'fields') {
                renderFieldTable();
            }
            
            updateSelectionHint();
            showToast(`å·²é€‰æ‹© ${selectedTasks.size} ä¸ª${type}ç±»å‹çš„ä»»åŠ¡`);
        }

        // æŒ‰çŠ¶æ€é€‰æ‹©ä»»åŠ¡
        function selectTasksByStatus(status) {
            selectedTasks.clear();
            tasks.forEach(task => {
                if (task.status === status) {
                    selectedTasks.add(task.id);
                }
            });
            
            if (currentView === 'fields') {
                renderFieldTable();
            }
            
            updateSelectionHint();
            showToast(`å·²é€‰æ‹© ${selectedTasks.size} ä¸ª${status}çš„ä»»åŠ¡`);
        }

        // æŒ‰ä¼˜å…ˆçº§é€‰æ‹©ä»»åŠ¡
        function selectTasksByPriority(priority) {
            selectedTasks.clear();
            tasks.forEach(task => {
                if (task.fields.priority === priority) {
                    selectedTasks.add(task.id);
                }
            });
            
            if (currentView === 'fields') {
                renderFieldTable();
            }
            
            updateSelectionHint();
            showToast(`å·²é€‰æ‹© ${selectedTasks.size} ä¸ª${priority}ä¼˜å…ˆçº§çš„ä»»åŠ¡`);
        }

        // é€‰æ‹©é€¾æœŸä»»åŠ¡
        function selectOverdueTasks() {
            selectedTasks.clear();
            const now = new Date();
            
            tasks.forEach(task => {
                if (task.fields.dueDate && 
                    new Date(task.fields.dueDate) < now && 
                    task.status !== 'å·²å®Œæˆ') {
                    selectedTasks.add(task.id);
                }
            });
            
            if (currentView === 'fields') {
                renderFieldTable();
            }
            
            updateSelectionHint();
            showToast(`å·²é€‰æ‹© ${selectedTasks.size} ä¸ªé€¾æœŸä»»åŠ¡`);
        }

        // æ‰¹é‡ä¿®æ”¹çŠ¶æ€
        async function batchChangeStatus() {
            if (selectedTasks.size === 0) {
                showToast('è¯·å…ˆé€‰æ‹©è¦æ“ä½œçš„ä»»åŠ¡', 'error');
                return;
            }
            
            const newStatus = prompt('è¾“å…¥æ–°çŠ¶æ€ (æœªå¼€å§‹/è¿›è¡Œä¸­/å·²å®Œæˆ):');
            if (newStatus && ['æœªå¼€å§‹', 'è¿›è¡Œä¸­', 'å·²å®Œæˆ'].includes(newStatus)) {
                const confirmed = await showConfirm(`ç¡®å®šè¦å°† ${selectedTasks.size} ä¸ªä»»åŠ¡çš„çŠ¶æ€ä¿®æ”¹ä¸º"${newStatus}"å—ï¼Ÿ`);
                if (!confirmed) return;
                
                selectedTasks.forEach(taskId => {
                    const task = tasks.find(t => t.id === taskId);
                    if (task) {
                        task.status = newStatus;
                    }
                });
                
                renderFieldTable();
                updateStats();
                showToast(`å·²æ›´æ–° ${selectedTasks.size} ä¸ªä»»åŠ¡çš„çŠ¶æ€`);
            } else if (newStatus) {
                showToast('è¯·è¾“å…¥æœ‰æ•ˆçš„çŠ¶æ€ï¼šæœªå¼€å§‹ã€è¿›è¡Œä¸­æˆ–å·²å®Œæˆ', 'error');
            }
        }

        // æ‰¹é‡ä¿®æ”¹ä¼˜å…ˆçº§
        async function batchChangePriority() {
            if (selectedTasks.size === 0) {
                showToast('è¯·å…ˆé€‰æ‹©è¦æ“ä½œçš„ä»»åŠ¡', 'error');
                return;
            }
            
            const priority = prompt('è¾“å…¥æ–°ä¼˜å…ˆçº§ (é«˜/ä¸­/ä½):');
            if (priority && ['é«˜', 'ä¸­', 'ä½'].includes(priority)) {
                const confirmed = await showConfirm(`ç¡®å®šè¦å°† ${selectedTasks.size} ä¸ªä»»åŠ¡çš„ä¼˜å…ˆçº§ä¿®æ”¹ä¸º"${priority}"å—ï¼Ÿ`);
                if (!confirmed) return;
                
                selectedTasks.forEach(taskId => {
                    const task = tasks.find(t => t.id === taskId);
                    if (task) {
                        task.fields.priority = priority;
                    }
                });
                
                renderFieldTable();
                showToast(`å·²æ›´æ–° ${selectedTasks.size} ä¸ªä»»åŠ¡çš„ä¼˜å…ˆçº§`);
            } else if (priority) {
                showToast('è¯·è¾“å…¥æœ‰æ•ˆçš„ä¼˜å…ˆçº§ï¼šé«˜ã€ä¸­æˆ–ä½', 'error');
            }
        }

        // æ‰¹é‡æ·»åŠ æ ‡ç­¾
        async function batchAddTags() {
            if (selectedTasks.size === 0) {
                showToast('è¯·å…ˆé€‰æ‹©è¦æ“ä½œçš„ä»»åŠ¡', 'error');
                return;
            }
            
            const tags = prompt('è¾“å…¥è¦æ·»åŠ çš„æ ‡ç­¾ï¼ˆç”¨é€—å·åˆ†éš”ï¼‰:');
            if (tags) {
                const tagList = tags.split(',').map(t => t.trim()).filter(t => t);
                
                if (tagList.length === 0) {
                    showToast('è¯·è¾“å…¥æœ‰æ•ˆçš„æ ‡ç­¾', 'error');
                    return;
                }
                
                const confirmed = await showConfirm(`ç¡®å®šè¦ä¸º ${selectedTasks.size} ä¸ªä»»åŠ¡æ·»åŠ æ ‡ç­¾å—ï¼Ÿ`);
                if (!confirmed) return;
                
                selectedTasks.forEach(taskId => {
                    const task = tasks.find(t => t.id === taskId);
                    if (task) {
                        if (!task.fields.tags) task.fields.tags = [];
                        tagList.forEach(tag => {
                            if (!task.fields.tags.includes(tag)) {
                                task.fields.tags.push(tag);
                            }
                        });
                    }
                });
                
                renderFieldTable();
                showToast(`å·²ä¸º ${selectedTasks.size} ä¸ªä»»åŠ¡æ·»åŠ æ ‡ç­¾`);
            }
        }

        // æ‰¹é‡è®¾ç½®æˆªæ­¢æ—¥æœŸ
        async function batchSetDueDate() {
            if (selectedTasks.size === 0) {
                showToast('è¯·å…ˆé€‰æ‹©è¦æ“ä½œçš„ä»»åŠ¡', 'error');
                return;
            }
            
            const dueDate = prompt('è¾“å…¥æˆªæ­¢æ—¥æœŸ (YYYY-MM-DD):');
            if (dueDate) {
                // éªŒè¯æ—¥æœŸæ ¼å¼
                const dateRegex = /^\d{4}-\d{2}-\d{2}$/;
                if (!dateRegex.test(dueDate)) {
                    showToast('è¯·è¾“å…¥æ­£ç¡®çš„æ—¥æœŸæ ¼å¼ï¼šYYYY-MM-DD', 'error');
                    return;
                }
                
                const confirmed = await showConfirm(`ç¡®å®šè¦å°† ${selectedTasks.size} ä¸ªä»»åŠ¡çš„æˆªæ­¢æ—¥æœŸè®¾ç½®ä¸º ${dueDate} å—ï¼Ÿ`);
                if (!confirmed) return;
                
                selectedTasks.forEach(taskId => {
                    const task = tasks.find(t => t.id === taskId);
                    if (task) {
                        task.fields.dueDate = dueDate;
                    }
                });
                
                renderFieldTable();
                showToast(`å·²è®¾ç½® ${selectedTasks.size} ä¸ªä»»åŠ¡çš„æˆªæ­¢æ—¥æœŸ`);
            }
        }

        // æ‰¹é‡ç§»åŠ¨ä»»åŠ¡
        async function batchMove() {
            if (selectedTasks.size === 0) {
                showToast('è¯·å…ˆé€‰æ‹©è¦æ“ä½œçš„ä»»åŠ¡', 'error');
                return;
            }
            
            // è·å–å¯ä»¥ä½œä¸ºçˆ¶ä»»åŠ¡çš„ç›®æ ‡
            const possibleParents = tasks.filter(t => 
                (t.type === 'ç›®æ ‡' || t.type === 'å…³é”®ç»“æœ' || t.type === 'é¡¹ç›®') &&
                !selectedTasks.has(t.id)
            );
            
            if (possibleParents.length === 0) {
                showToast('æ²¡æœ‰å¯ç”¨çš„çˆ¶ä»»åŠ¡', 'error');
                return;
            }
            
            const parentOptions = possibleParents.map(t => `${t.type}: ${t.title}`).join('\n');
            const parentIndex = prompt(`é€‰æ‹©ç›®æ ‡çˆ¶ä»»åŠ¡ï¼ˆè¾“å…¥åºå·ï¼‰:\n${parentOptions.split('\n').map((opt, idx) => `${idx + 1}. ${opt}`).join('\n')}`);
            
            if (parentIndex && !isNaN(parentIndex)) {
                const idx = parseInt(parentIndex) - 1;
                if (idx >= 0 && idx < possibleParents.length) {
                    const confirmed = await showConfirm(`ç¡®å®šè¦å°† ${selectedTasks.size} ä¸ªä»»åŠ¡ç§»åŠ¨åˆ°"${possibleParents[idx].title}"ä¸‹å—ï¼Ÿ`);
                    if (!confirmed) return;
                    
                    const newParent = possibleParents[idx];
                    selectedTasks.forEach(taskId => {
                        const task = tasks.find(t => t.id === taskId);
                        if (task) {
                            // æ›´æ–°è·¯å¾„
                            if (newParent.path) {
                                task.path = `${newParent.path} >> ${newParent.title}`;
                            } else {
                                task.path = newParent.title;
                            }
                        }
                    });
                    
                    renderFieldTable();
                    renderTreeView();
                    showToast(`å·²ç§»åŠ¨ ${selectedTasks.size} ä¸ªä»»åŠ¡`);
                }
            }
        }

        // æ‰¹é‡åˆ é™¤
        async function batchDelete() {
            if (selectedTasks.size === 0) {
                showToast('è¯·å…ˆé€‰æ‹©è¦æ“ä½œçš„ä»»åŠ¡', 'error');
                return;
            }
            
            await deleteSelectedFields();
        }

        /* ========================================
           ğŸŒ³ æ ‘å½¢è§†å›¾åŠŸèƒ½
           ======================================== */
        
        // æ„å»ºä»»åŠ¡æ ‘
        function buildTaskTree() {
            const tree = [];
            const taskMap = new Map();
            
            // å…ˆåˆ›å»ºæ‰€æœ‰ä»»åŠ¡çš„æ˜ å°„
            tasks.forEach(task => {
                taskMap.set(task.title, {
                    ...task,
                    children: []
                });
            });
            
            // æ„å»ºæ ‘å½¢ç»“æ„
            tasks.forEach(task => {
                if (!task.path) {
                    // é¡¶å±‚ä»»åŠ¡
                    tree.push(taskMap.get(task.title));
                } else {
                    // æ‰¾åˆ°çˆ¶ä»»åŠ¡
                    const pathParts = task.path.split(' >> ');
                    const parentTitle = pathParts[pathParts.length - 1];
                    const parent = taskMap.get(parentTitle);
                    
                    if (parent) {
                        parent.children.push(taskMap.get(task.title));
                    } else {
                        // å¦‚æœæ‰¾ä¸åˆ°çˆ¶ä»»åŠ¡ï¼Œä½œä¸ºé¡¶å±‚ä»»åŠ¡
                        tree.push(taskMap.get(task.title));
                    }
                }
            });
            
            return tree;
        }

        // æ¸²æŸ“æ ‘å½¢è§†å›¾
        function renderTreeView() {
            const container = document.getElementById('treeContainer');
            const tree = buildTaskTree();
            
            if (tree.length === 0) {
                container.innerHTML = '<div class="empty-state"><div class="empty-state-icon">ğŸŒ²</div><p>æš‚æ— ä»»åŠ¡æ•°æ®</p></div>';
                return;
            }
            
            container.innerHTML = tree.map(node => renderTreeNode(node, 0)).join('');
        }

        // æ¸²æŸ“å•ä¸ªæ ‘èŠ‚ç‚¹
        function renderTreeNode(node, level) {
            // ç¡®ä¿ node.fields å­˜åœ¨
            if (!node.fields) {
                node.fields = {};
            }
            
            const hasChildren = node.children && node.children.length > 0;
            const typeIcon = {
                'ç›®æ ‡': 'ğŸ¯',
                'å…³é”®ç»“æœ': 'ğŸ”‘',
                'é¡¹ç›®': 'ğŸ“',
                'åŠ¨ä½œ': 'âš¡'
            }[node.type] || 'ğŸ“‹';
            
            const html = `
                <div class="tree-node" style="margin-left: ${level * 32}px;">
                    <div class="tree-node-content" onclick="toggleTreeNode(this, '${node.id}')">
                        <span class="tree-expand-icon ${hasChildren ? '' : 'invisible'}" style="${!hasChildren ? 'visibility: hidden;' : ''}">
                            ${hasChildren ? 'â–¶' : ''}
                        </span>
                        <div class="tree-node-info">
                            <span class="task-type-badge ${node.type === 'ç›®æ ‡' ? 'goal' : 
                                                          node.type === 'å…³é”®ç»“æœ' ? 'kr' : 
                                                          node.type === 'é¡¹ç›®' ? 'project' : 'action'}">
                                ${typeIcon} ${node.type}
                            </span>
                            <span>${node.title}</span>
                            <span class="status-indicator">
                                <span class="status-dot ${node.status === 'æœªå¼€å§‹' ? 'todo' : 
                                                         node.status === 'è¿›è¡Œä¸­' ? 'doing' : 'done'}"></span>
                                ${node.status}
                            </span>
                            ${node.fields.priority ? `<span class="tag">${node.fields.priority === 'é«˜' ? 'ğŸ”´' : node.fields.priority === 'ä¸­' ? 'ğŸŸ¡' : 'ğŸŸ¢'} ${node.fields.priority}</span>` : ''}
                            ${node.fields.today ? '<span class="tag">ğŸ“… ä»Šæ—¥</span>' : ''}
                        </div>
                    </div>
                    ${hasChildren ? `
                        <div class="tree-children hidden">
                            ${node.children.map(child => renderTreeNode(child, level + 1)).join('')}
                        </div>
                    ` : ''}
                </div>
            `;
            
            return html;
        }

        // åˆ‡æ¢æ ‘èŠ‚ç‚¹å±•å¼€/æŠ˜å 
        function toggleTreeNode(element, nodeId) {
            const node = element.parentElement;
            const children = node.querySelector('.tree-children');
            const icon = element.querySelector('.tree-expand-icon');
            
            if (children) {
                children.classList.toggle('hidden');
                if (icon) {
                    icon.classList.toggle('expanded');
                }
            }
            
            // ç‚¹å‡»æ—¶é€‰ä¸­/å–æ¶ˆé€‰ä¸­
            element.classList.toggle('selected');
        }

        /* ========================================
           ğŸ¯ æ¨¡æ€æ¡†ç®¡ç†
           ======================================== */
        
        // æ˜¾ç¤ºæ·»åŠ å­—æ®µæ¨¡æ€æ¡†
        function showAddFieldModal() {
            // å¡«å……ä»»åŠ¡é€‰æ‹©åˆ—è¡¨
            const select = document.getElementById('fieldTaskSelect');
            
            if (selectedTasks.size > 0) {
                // å¦‚æœæœ‰é€‰ä¸­çš„ä»»åŠ¡ï¼Œåªæ˜¾ç¤ºé€‰ä¸­çš„
                const selectedTasksList = Array.from(selectedTasks).map(id => tasks.find(t => t.id === id)).filter(t => t);
                select.innerHTML = selectedTasksList.map(task => 
                    `<option value="${task.id}" selected>${task.title}</option>`
                ).join('');
            } else {
                // å¦åˆ™æ˜¾ç¤ºæ‰€æœ‰ä»»åŠ¡
                select.innerHTML = tasks.map(task => 
                    `<option value="${task.id}">${task.title}</option>`
                ).join('');
            }
            
            updateFieldValueInput();
            document.getElementById('addFieldModal').classList.add('active');
        }

        // æ›´æ–°å­—æ®µå€¼è¾“å…¥æ¡†
        function updateFieldValueInput() {
            const fieldType = document.getElementById('fieldType').value;
            const container = document.getElementById('fieldValueInput');
            
            switch (fieldType) {
                case 'priority':
                    container.innerHTML = `
                        <select class="form-select" id="priorityValue">
                            <option value="é«˜">ğŸ”´ é«˜ä¼˜å…ˆçº§</option>
                            <option value="ä¸­">ğŸŸ¡ ä¸­ä¼˜å…ˆçº§</option>
                            <option value="ä½">ğŸŸ¢ ä½ä¼˜å…ˆçº§</option>
                        </select>
                    `;
                    break;
                case 'dueDate':
                    container.innerHTML = `<input type="date" class="form-input" id="dueDateValue">`;
                    break;
                case 'tags':
                    container.innerHTML = `<input type="text" class="form-input" id="tagsValue" placeholder="è¾“å…¥æ ‡ç­¾ï¼Œç”¨é€—å·åˆ†éš”">`;
                    break;
                case 'progress':
                    container.innerHTML = `
                        <input type="range" min="0" max="100" value="0" id="progressValue" style="width: 100%;">
                        <div class="text-center text-muted"><span id="progressDisplay">0</span>%</div>
                    `;
                    // æ·»åŠ è¿›åº¦æ˜¾ç¤ºæ›´æ–°
                    setTimeout(() => {
                        const slider = document.getElementById('progressValue');
                        const display = document.getElementById('progressDisplay');
                        if (slider && display) {
                            slider.addEventListener('input', (e) => {
                                display.textContent = e.target.value;
                            });
                        }
                    }, 0);
                    break;
                case 'plannedTime':
                    container.innerHTML = `<input type="time" class="form-input" id="plannedTimeValue">`;
                    break;
                case 'launchLink':
                    container.innerHTML = `<input type="url" class="form-input" id="launchLinkValue" placeholder="https://example.com">`;
                    break;
                case 'custom':
                    container.innerHTML = `
                        <input type="text" class="form-input mb-2" id="customFieldName" placeholder="å­—æ®µåç§°">
                        <input type="text" class="form-input" id="customFieldValue" placeholder="å­—æ®µå€¼">
                    `;
                    break;
            }
        }

        // å…³é—­æ¨¡æ€æ¡†
        function closeModal(modalId) {
            document.getElementById(modalId).classList.remove('active');
        }

        // å¤„ç†æ·»åŠ å­—æ®µ
        async function handleAddField(event) {
            event.preventDefault();
            
            const selectedTaskIds = Array.from(document.getElementById('fieldTaskSelect').selectedOptions)
                                         .map(option => option.value);
            const fieldType = document.getElementById('fieldType').value;
            
            if (selectedTaskIds.length === 0) {
                showToast('è¯·é€‰æ‹©è‡³å°‘ä¸€ä¸ªä»»åŠ¡', 'error');
                return;
            }
            
            let fieldValue;
            switch (fieldType) {
                case 'priority':
                    fieldValue = document.getElementById('priorityValue').value;
                    break;
                case 'dueDate':
                    fieldValue = document.getElementById('dueDateValue').value;
                    break;
                case 'tags':
                    fieldValue = document.getElementById('tagsValue').value.split(',').map(t => t.trim()).filter(t => t);
                    break;
                case 'progress':
                    fieldValue = parseInt(document.getElementById('progressValue').value);
                    break;
                case 'plannedTime':
                    fieldValue = document.getElementById('plannedTimeValue').value;
                    break;
                case 'launchLink':
                    fieldValue = document.getElementById('launchLinkValue').value;
                    break;
                case 'custom':
                    const fieldName = document.getElementById('customFieldName').value;
                    fieldValue = { name: fieldName, value: document.getElementById('customFieldValue').value };
                    break;
            }
            
            // åº”ç”¨å­—æ®µåˆ°é€‰ä¸­çš„ä»»åŠ¡
            selectedTaskIds.forEach(taskId => {
                const task = tasks.find(t => t.id === taskId);
                if (task) {
                    switch (fieldType) {
                        case 'priority':
                            task.fields.priority = fieldValue;
                            break;
                        case 'dueDate':
                            task.fields.dueDate = fieldValue;
                            break;
                        case 'tags':
                            if (!task.fields.tags) task.fields.tags = [];
                            fieldValue.forEach(tag => {
                                if (!task.fields.tags.includes(tag)) {
                                    task.fields.tags.push(tag);
                                }
                            });
                            break;
                        case 'progress':
                            task.fields.progress = fieldValue;
                            break;
                        case 'plannedTime':
                            task.fields.plannedTime = fieldValue;
                            break;
                        case 'launchLink':
                            task.fields.launchLink = fieldValue;
                            break;
                        case 'custom':
                            if (!task.fields.custom) task.fields.custom = {};
                            task.fields.custom[fieldValue.name] = fieldValue.value;
                            break;
                    }
                }
            });
            
            closeModal('addFieldModal');
            renderFieldTable();
            showToast(`å·²ä¸º ${selectedTaskIds.length} ä¸ªä»»åŠ¡æ·»åŠ å­—æ®µ`);
        }

        /* ========================================
           ğŸ“‹ å­—æ®µæ¨¡æ¿åŠŸèƒ½
           ======================================== */
        
        // åº”ç”¨å­—æ®µæ¨¡æ¿
        async function applyFieldTemplate(templateType) {
            const templates = {
                basic: {
                    priority: 'ä¸­',
                    tags: ['å¾…åŠ'],
                    progress: 0
                },
                project: {
                    priority: 'é«˜',
                    dueDate: new Date(Date.now() + 30 * 24 * 60 * 60 * 1000).toISOString().split('T')[0],
                    tags: ['é¡¹ç›®'],
                    progress: 0,
                    launchLink: ''
                },
                okr: {
                    priority: 'é«˜',
                    dueDate: new Date(Date.now() + 90 * 24 * 60 * 60 * 1000).toISOString().split('T')[0],
                    tags: ['OKR', 'Q1'],
                    progress: 0
                }
            };
            
            const template = templates[templateType];
            if (!template) return;
            
            if (selectedTasks.size === 0) {
                showToast('è¯·å…ˆé€‰æ‹©è¦åº”ç”¨æ¨¡æ¿çš„ä»»åŠ¡', 'error');
                return;
            }
            
            const confirmed = await showConfirm(`ç¡®å®šè¦ä¸º ${selectedTasks.size} ä¸ªä»»åŠ¡åº”ç”¨"${templateType === 'basic' ? 'åŸºç¡€' : templateType === 'project' ? 'é¡¹ç›®' : 'OKR'}"æ¨¡æ¿å—ï¼Ÿ`);
            if (!confirmed) return;
            
            selectedTasks.forEach(taskId => {
                const task = tasks.find(t => t.id === taskId);
                if (task) {
                    // åˆå¹¶æ¨¡æ¿å­—æ®µï¼Œä¿ç•™å·²æœ‰çš„éç©ºå­—æ®µ
                    Object.entries(template).forEach(([key, value]) => {
                        if (!task.fields[key] || (Array.isArray(task.fields[key]) && task.fields[key].length === 0)) {
                            task.fields[key] = value;
                        }
                    });
                }
            });
            
            renderFieldTable();
            showToast(`å·²ä¸º ${selectedTasks.size} ä¸ªä»»åŠ¡åº”ç”¨æ¨¡æ¿`);
        }

        /* ========================================
           ğŸ”„ ä¸æ’ä»¶é€šä¿¡ï¼ˆé¢„ç•™æ¥å£ï¼‰
           ======================================== */
        
        // åŒæ­¥æ•°æ®åˆ°æ’ä»¶
        function syncWithPlugin() {
            console.log('ğŸ”„ å‡†å¤‡åŒæ­¥æ•°æ®åˆ° MNTask æ’ä»¶...');
            
            // æ„å»ºåŒæ­¥æ•°æ®
            const syncData = {
                action: 'syncTasks',
                tasks: tasks,
                timestamp: new Date().toISOString()
            };
            
            // é€šè¿‡ mntask:// åè®®å‘é€æ•°æ®
            const url = `mntask://sync?data=${encodeURIComponent(JSON.stringify(syncData))}`;
            
            // åœ¨ iPad ä¸Šä½¿ç”¨ location.href
            try {
                window.location.href = url;
                showToast('æ­£åœ¨åŒæ­¥æ•°æ®...');
            } catch (error) {
                console.error('åŒæ­¥å¤±è´¥:', error);
                showToast('åŒæ­¥å¤±è´¥ï¼Œè¯·é‡è¯•', 'error');
            }
        }

        // ä»æ’ä»¶æ¥æ”¶æ•°æ®
        window.receiveFromPlugin = function(action, data) {
            console.log('ğŸ“¥ æ”¶åˆ°æ’ä»¶æ•°æ®:', action, data);
            
            switch (action) {
                case 'loadTasks':
                    // åŠ è½½æ’ä»¶æä¾›çš„ä»»åŠ¡æ•°æ®
                    if (data && data.tasks) {
                        tasks = data.tasks;
                        renderFieldTable();
                        updateStats();
                        renderTreeView();
                        showToast(`å·²åŠ è½½ ${tasks.length} ä¸ªä»»åŠ¡`);
                    }
                    break;
                    
                case 'updateTask':
                    // æ›´æ–°å•ä¸ªä»»åŠ¡
                    const task = tasks.find(t => t.id === data.taskId);
                    if (task && data.fields) {
                        Object.assign(task.fields, data.fields);
                        renderFieldTable();
                        showToast('ä»»åŠ¡å·²æ›´æ–°');
                    }
                    break;
                    
                case 'error':
                    showToast(data.message || 'æ“ä½œå¤±è´¥', 'error');
                    break;
                    
                default:
                    console.log('æœªçŸ¥æ“ä½œ:', action);
            }
        };

        /* ========================================
           ğŸ“± ç§»åŠ¨ç«¯é€‚é…
           ======================================== */
        
        // åˆ‡æ¢ä¾§è¾¹æ 
        function toggleSidebar() {
            const sidebar = document.getElementById('sidebar');
            if (sidebar) {
                sidebar.classList.toggle('open');
            } else {
                console.error('ä¾§è¾¹æ å…ƒç´ æœªæ‰¾åˆ°');
            }
        }

        // ç»‘å®šå…¨å±€äº‹ä»¶
        function bindGlobalEvents() {
            // ç‚¹å‡»æ¨¡æ€æ¡†èƒŒæ™¯å…³é—­
            document.querySelectorAll('.modal').forEach(modal => {
                modal.addEventListener('click', (e) => {
                    if (e.target === modal && !modal.id.includes('confirm')) {
                        modal.classList.remove('active');
                    }
                });
            });
            
            // å“åº”å¼ä¾§è¾¹æ 
            const checkWidth = () => {
                const toggle = document.getElementById('sidebarToggle');
                if (toggle) {
                    if (window.innerWidth <= 1024) {
                        toggle.style.display = 'flex';
                    } else {
                        toggle.style.display = 'none';
                        const sidebar = document.getElementById('sidebar');
                        if (sidebar) {
                            sidebar.classList.remove('open');
                        }
                    }
                }
            };
            
            window.addEventListener('resize', checkWidth);
            checkWidth();
            
            // é˜»æ­¢ç§»åŠ¨ç«¯çš„æ©¡çš®ç­‹æ•ˆæœ
            document.addEventListener('touchmove', (e) => {
                if (e.target.closest('.modal') || e.target.closest('.field-table-container') || e.target.closest('.tree-view')) {
                    return;
                }
                e.preventDefault();
            }, { passive: false });
        }

        /* ========================================
           ğŸš€ å¯åŠ¨åº”ç”¨
           ======================================== */
        
        // DOM åŠ è½½å®Œæˆååˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', initApp);

        // å…¨å±€é”™è¯¯å¤„ç†
        window.addEventListener('error', (event) => {
            console.error('âŒ å…¨å±€é”™è¯¯:', event.error);
            console.error('é”™è¯¯è¯¦æƒ…:', {
                message: event.message,
                filename: event.filename,
                lineno: event.lineno,
                colno: event.colno,
                error: event.error
            });
            
            // åœ¨å¼€å‘ç¯å¢ƒæ˜¾ç¤ºè¯¦ç»†é”™è¯¯ä¿¡æ¯
            const errorMsg = `é”™è¯¯: ${event.message} (${event.filename}:${event.lineno}:${event.colno})`;
            console.error(errorMsg);
            
            // å¦‚æœæ˜¯å·²çŸ¥çš„å®‰å…¨é”™è¯¯ï¼Œå¯ä»¥å¿½ç•¥æç¤º
            if (event.message && event.message.includes('getElementById')) {
                // DOM å…ƒç´ æœªæ‰¾åˆ°çš„é”™è¯¯å·²ç»åœ¨å„ä¸ªå‡½æ•°ä¸­å¤„ç†ï¼Œä¸éœ€è¦å…¨å±€æç¤º
                return;
            }
            
            // å…¶ä»–æœªå¤„ç†çš„é”™è¯¯æ‰æ˜¾ç¤ºæç¤º
            showToast('å‘ç”Ÿé”™è¯¯ï¼Œè¯·æŸ¥çœ‹æ§åˆ¶å°äº†è§£è¯¦æƒ…', 'error');
        });
    </script>
</body>
</html>