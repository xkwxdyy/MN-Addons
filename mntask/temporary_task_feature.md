# MNTask 临时任务制卡功能

## 功能概述

临时任务制卡功能允许用户对任何卡片（包括非任务看板中的卡片）进行快速制卡，无需先返回任务看板创建任务。这极大提升了临时任务创建的效率。

## 核心特性

### 1. 智能识别卡片类型
- **任务看板卡片**：使用原有制卡逻辑
- **非任务看板卡片**：触发临时任务创建流程
- **自动判断条件**：
  - 卡片本身不是任务卡片
  - 且（没有父卡片 或 父卡片不是任务卡片）

### 2. 智能父任务推荐
系统会智能推荐合适的父任务，优先级从高到低：
1. **当前启动的任务**（优先级 100）
   - 如果是动作：显示其父项目和兄弟任务
   - 如果是项目：显示项目本身和子任务
2. **进行中的底层任务**（优先级 70）
3. **未开始的底层任务**（优先级 60）

### 3. 任务创建流程
1. 检测到非任务看板卡片
2. 搜索并显示可选的父任务
3. 用户选择父任务
4. 输入新任务标题
5. 创建任务卡片并建立双向链接
6. 自动处理父任务类型转换（动作→项目）
7. 如果源卡片是知识点卡片，自动移动链接到相关链接字段

### 4. 状态绑定机制
非任务卡片可以绑定一个或多个任务卡片，状态切换会自动应用到绑定的任务：
- **单个绑定**：直接应用状态
- **多个绑定**：优先处理非完成/归档状态的任务
- **智能选择**：多个活跃任务时弹窗让用户选择

## 使用方法

### 创建临时任务

1. **选择任意卡片**
   - 可以是笔记卡片、知识点卡片等任意类型

2. **点击制卡按钮**
   - 系统自动识别并触发临时任务创建

3. **选择父任务**
   - 从推荐列表中选择合适的父任务
   - 优先显示当前启动的任务相关选项

4. **输入任务标题**
   - 默认使用源卡片标题
   - 可自定义修改

5. **完成创建**
   - 新任务自动设置为"进行中"状态
   - 与源卡片建立双向链接

### 状态切换

对于绑定了任务的非任务卡片：

1. **单击状态切换**
   - 自动识别绑定的任务
   - 应用相应的状态变更

2. **多任务处理**
   - 优先处理活跃任务
   - 多个活跃任务时提供选择

## 实现细节

### 新增方法

#### `MNTaskManager.getInProgressTasks(options)`
获取所有进行中的任务
- 参数：
  - `boardKeys`: 要搜索的看板（默认 ['project', 'action']）
  - `includeCompleted`: 是否包含已完成任务
- 返回：进行中的任务数组

#### `MNTaskManager.getBottomLevelTasks(options)`
获取底层任务（没有子项目的项目或动作）
- 参数：
  - `boardKeys`: 要搜索的看板
  - `statuses`: 要筛选的状态
- 返回：底层任务数组

#### `MNTaskManager.findSuitableParentTasks(currentNote)`
智能查找合适的父任务
- 参数：当前卡片
- 返回：候选父任务数组，包含推荐理由和优先级

#### `MNTaskManager.createTemporaryTask(sourceNote)`
创建临时任务
- 参数：源卡片（非任务卡片）
- 返回：创建结果对象

#### `MNTaskManager.getBindedTaskCards(note)`
获取卡片中绑定的任务卡片
- 参数：要检查的卡片
- 返回：绑定的任务信息数组

#### `MNTaskManager.applyStatusToBindedCard(note, newStatus)`
应用状态到绑定的任务卡片
- 参数：
  - `note`: 源卡片
  - `newStatus`: 新状态
- 返回：应用结果

### 修改的方法

#### `MNTaskManager.convertToTaskCard(note, taskType)`
- 新增临时任务创建检测逻辑
- 非任务看板卡片自动触发 `createTemporaryTask`

#### `MNTaskManager.updateTaskStatus(note, newStatus, skipParentUpdate)`
- 新增对非任务卡片的支持
- 自动检测并应用到绑定的任务

#### `MNTaskManager.toggleStatusForward(note)`
- 支持非任务卡片的状态切换
- 智能处理绑定任务的状态变更

## 测试

提供了完整的测试脚本 `test_temporary_task.js`，包含：
1. 获取进行中任务测试
2. 获取底层任务测试
3. 智能查找父任务测试
4. 创建临时任务测试
5. 获取绑定任务测试
6. 状态应用测试

## 注意事项

1. **任务类型转换**
   - 动作类型的父任务会自动转换为项目类型

2. **知识点卡片**
   - 会自动调用 MNMath 的方法处理链接移动

3. **状态优先级**
   - 优先处理非完成/归档状态的任务

4. **性能考虑**
   - 搜索任务时使用了缓存机制
   - 避免重复搜索

## 版本信息

- 添加日期：2024-01-12
- 版本：v0.16.0
- 作者：夏大鱼羊