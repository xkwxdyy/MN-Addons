# 插件看板数据交互与卡片同步实现  
> 下面说的“看板”默认指“task-focus-board.html” 文件
> 如果是软件里的“看板”，是指一些固定的卡片，作为看板的功能，来“存”卡片而已，本身并没有什么特别
> “软件卡片”||“软件里任务卡片”指的是 MarginNote 里的任务类型的卡片
> “看板里任务卡片”默认指的是“task-focus-board.html”文件中的任务卡片

请完成插件看板功能中「卡片数据与看板同步交互」的开发实现，具体需求如下：  


### **任务目标**  

开发插件看板的双向数据同步功能：实现软件里任务卡片数据 ↔ HTML任务卡片数据，并实现界面的实时交互（即软件卡片信息提取→转化为HTML元数据→HTML 中修改元数据后同步回原卡片），确保看板中任务卡片与软件中任务卡片内容的一致性。  


### **核心参考**  

请以 **MN Browser插件**（/Users/xiakangwei/Nutstore/Github/repository/MN-addon-develop/MN-Addon/mnbrowser） 的实现逻辑为主要学习对象，重点分析其如何完成：  
1. 卡片原始数据 → HTML界面的信息传递（数据提取与转换）  
2. HTML界面修改 → 卡片内容的反向同步（元数据解析与内容更新）  

其余参考：卡片操作 API 看：mnutils/xdyyutils.js 和 mnutils/mnutils.js 中的相关函数实现。
评论内容主要看 MNComment 类。

软件中任务类型的卡片的主要处理参考 MNTask项目 xdyy_utils_extensions.js 文件中对任务类卡片的处理。

### **具体开发需求**  

#### 1. 软件内提取任务卡片提取范围限制  

仅从 **已绑定的软件内看板卡片** 中提取任务卡片（非整个笔记本），要恢复之前的软件内 mntask 的 setting 的看板绑定视图。

#### 2. 核心实现步骤

##### （1）卡片信息提取与元数据转换  

- 如何从目标看板卡片中提取关键信息
- 需将提取的信息转化为 **可输入HTML界面的卡片元数据格式**（请说明元数据应包含的字段、数据类型及结构示例）。  

##### （2）HTML元数据修改与卡片同步  

- 当HTML界面接收到元数据并修改后（如用户编辑标题/状态），如何将修改后的元数据解析为卡片可识别的格式？  
- 如何通过插件API将解析后的内容 **精准同步回原看板卡片**（避免影响其他无关卡片）？  


具体的软件任务卡片数据转换示例（你从中可以看出，什么是我要的内容信息，而剩余的是格式内容）：动作卡片 A
```
【动作 >> 开发 MarginNote 插件 >> 开发 MNUtils 插件 >> 开发 MNMath 类｜进行中】要处理反例紧跟着非归类卡片的情况！
---
否则制卡会出问题！
---
<span id="mainField" style="font-weight:600;color:#1E40AF;background:linear-gradient(15deg,#EFF6FF 30%,#DBEAFE);border:2px solid #3B82F6;border-radius:12px;padding:10px 18px;display:inline-block;box-shadow:2px 2px 0px #BFDBFE,4px 4px 8px rgba(59,130,246,0.12);position:relative;margin:4px 8px;">信息</span>
---
<span id="subField" style="background:#FFF;color:#FF8C5A;border:2px solid currentColor;border-radius:3px;padding:6px 12px;font-size:0.9em;font-weight:600;box-shadow:0 1px 3px rgba(255,140,90,0.2);display:inline-block;"> 所属 </span> [开发 MNMath 类](marginnote4app://note/8E5D50A4-DF1E-4395-8370-B88DC371C3C5)
---
<span id="subField" style="background:#FFF;color:#FF8C5A;border:2px solid currentColor;border-radius:3px;padding:6px 12px;font-size:0.9em;font-weight:600;box-shadow:0 1px 3px rgba(255,140,90,0.2);display:inline-block;">[启动](marginnote4app://uistatus/H4sIAAAAAAAAE5VSy5LbIBD8F87SFuIp%2BWbJ5VxyyCG3VCqF0LBmg4VKoM06W%2F73AHbiveY2j56mp5l3NHr%2F8zxxtEOGgNbYMNNJGGmHJWAsmRg7wRQIojpDZQtEj5ibpm0apeRI5ahBcKEx4agqZGFxNqIdzlmM%2Fjx5jXZGuQAV0mqdRv9WujmG6Q7Vzv%2BGB8zPEeYYSivNO3WB1U5JI2MDYw0b6l4OtGb7o6h72rY1wU2Hh33Ph%2BMh6YC3ND%2Bd%2FQSFwlgHNzLjvIpntdwSr7cw%2BwiFuj%2F27ND2pO4IYTXjvajbLqf4yEk74D2lXaI2m3MfV0pkn71W0foZ7d6RNyZAzNGPl%2BDnV%2BU2%2BHpZkg40fPri7RwTRzbgibWSck6YbEUjGO1khS6lzgWThLNUo7jlmF8rFLRyeZUnIiiTVGDcsK5JGHEtCgI4F9Kr375XyC%2Bw3uXgD5kfX26FLTo7P7xe1DMkf1O5tBc1gysTRUv6f960mLKOcdJgUqEVAqhVnwp6hVcLv26hfT7dnL0T32D5Iko%2F2AlGtT7a%2BUzsbHz2SvstGbNr0jZRjeFkpwnmf9B4gnM28ABGbS4bGP1i9f8cRJb59zCvfwCp6rmF9QIAAA%3D%3D)</span>
---
<span id="mainField" style="font-weight:600;color:#1E40AF;background:linear-gradient(15deg,#EFF6FF 30%,#DBEAFE);border:2px solid #3B82F6;border-radius:12px;padding:10px 18px;display:inline-block;box-shadow:2px 2px 0px #BFDBFE,4px 4px 8px rgba(59,130,246,0.12);position:relative;margin:4px 8px;">进展</span>
---
<div style="position:relative; padding-left:28px; margin:14px 0; color:#1E40AF; font-weight:500; font-size:0.92em">
  <div style="position:absolute; left:0; top:50%; transform:translateY(-50%); 
              width:18px; height:18px; background:conic-gradient(#3B82F6 0%, #60A5FA 50%, #3B82F6 100%); 
              border-radius:50%; display:flex; align-items:center; justify-content:center">
    <div style="width:8px; height:8px; background:white; border-radius:50%"></div>
  </div>
  2025-07-20 11:10
</div>
开始「要处理反例紧跟着非归类卡片的情况！」
```

其中
```
【动作 >> 开发 MarginNote 插件 >> 开发 MNUtils 插件 >> 开发 MNMath 类｜进行中】要处理反例紧跟着非归类卡片的情况！
```
是卡片的标题，其余的用 --- 分隔的是一条条评论。卡片 A 的 URL 是 "marginnote4app://note/328FE6A7-D3DE-4ECE-943A-9DAEED56E515".

那么 A 对应的数据结构应该是：
```json
{
  "type": "action",
  "title-content": "要处理反例紧跟着非归类卡片的情况！",
  "title-path": "开发 MarginNote 插件 >> 开发 MNUtils 插件 >> 开发 MNMath 类",
  "status": "进行中",
  "url": "marginnote4app://note/328FE6A7-D3DE-4ECE-943A-9DAEED56E515",
  "id": "328FE6A7-D3DE-4ECE-943A-9DAEED56E515",
  // 任务描述/笔记/想法
  "description": "否则制卡会出问题！",
  "launchLink": "marginnote4app://uistatus/H4sIAAAAAAAAE5VSy5LbIBD8F87SFuIp%2BWbJ5VxyyCG3VCqF0LBmg4VKoM06W%2F73AHbiveY2j56mp5l3NHr%2F8zxxtEOGgNbYMNNJGGmHJWAsmRg7wRQIojpDZQtEj5ibpm0apeRI5ahBcKEx4agqZGFxNqIdzlmM%2Fjx5jXZGuQAV0mqdRv9WujmG6Q7Vzv%2BGB8zPEeYYSivNO3WB1U5JI2MDYw0b6l4OtGb7o6h72rY1wU2Hh33Ph%2BMh6YC3ND%2Bd%2FQSFwlgHNzLjvIpntdwSr7cw%2BwiFuj%2F27ND2pO4IYTXjvajbLqf4yEk74D2lXaI2m3MfV0pkn71W0foZ7d6RNyZAzNGPl%2BDnV%2BU2%2BHpZkg40fPri7RwTRzbgibWSck6YbEUjGO1khS6lzgWThLNUo7jlmF8rFLRyeZUnIiiTVGDcsK5JGHEtCgI4F9Kr375XyC%2Bw3uXgD5kfX26FLTo7P7xe1DMkf1O5tBc1gysTRUv6f960mLKOcdJgUqEVAqhVnwp6hVcLv26hfT7dnL0T32D5Iko%2F2AlGtT7a%2BUzsbHz2SvstGbNr0jZRjeFkpwnmf9B4gnM28ABGbS4bGP1i9f8cRJb59zCvfwCp6rmF9QIAAA%3D%3D",
  "parent-title":"开发 MNMath 类",
  "parent-URL": "marginnote4app://note/8E5D50A4-DF1E-4395-8370-B88DC371C3C5",
  "progresses": [
    {
      "time": "2025-07-20 11:10",
      "content": "开始「要处理反例紧跟着非归类卡片的情况！」"
    }
  ]
}
```

如果 B 是 A 上一级的项目卡片，则 B 的信息还多了
```json
{
  // ...
  "including": [
    {
      // A 的信息
    },
    {
      // 另一个动作卡片 的信息
    }
  ]
}
```

请基于以上需求，完成看板与卡片的双向数据同步功能开发。
注意要严格参考 MN Broswer 和 MNUtils。然后重点是先完成双向数据同步！ultrathink

---
开发暂停状态（不在“状态”的单击里切换，而是在长按菜单里增加暂停功能）
---
下面仍然处理“计划”视图
1. 现在的任务的那个信息预览UI很分散！
2. 今日任务回顾
   - 数据和下面的内容是割裂的！应该是类似于树状结构
```
已完成
  |- 看书
  ｜- 看电影
暂停
……
```
  - 未完成的同理要增加是否添加到待处理还是明天继续
ultrathink















---
1. 左侧的规划统计没有意义，改为对每个部分的定位，然后每个功能看板单独成行，现在是两个一行
2. 增加一个子看板在最底下，能看到所有任务，并且可以筛选，这个部分是要在上面基础上把其它任务纳入规划
3. 现在的任务的那个信息预览UI很分散！
4. 任务详情的进展
  - 报错
  ```
  task-focus-board.html:12077 🎨 [renderPlanningView] 开始渲染反思仪表板
task-focus-board.html:11869 🚀 MNTask 看板已启动
task-focus-board.html:12077 🎨 [renderPlanningView] 开始渲染反思仪表板
task-focus-board.html:12749 ✅ MNTask 任务看板初始化完成
task-focus-board.html:7504 Uncaught TypeError: Cannot read properties of null (reading 'stopPropagation')
    at viewProgressLog (task-focus-board.html:7504:19)
    at HTMLButtonElement.onclick (task-focus-board.html:5568:126)
task-focus-board.html:7504 Uncaught TypeError: Cannot read properties of null (reading 'stopPropagation')
    at viewProgressLog (task-focus-board.html:7504:19)
    at HTMLButtonElement.onclick (task-focus-board.html:5568:126)
```
  - 添加进展后没有立刻刷新
1. 焦点任务回顾
  - 已完成和处理中，或者暂定的应该分区显示
  - 未完成的任务要支持选择后续处理，比如添加到待处理任务，或者是移动到明天等
2. 待处理任务检查
  - 点击“添加新的待处理任务”右上角显示已添加，但是列表没有刷新！比如 cmd+R 手动刷新！请修复
  - 五个以上就“待处理任务较多，建议重新评估优先级”，但是这个不应该有限制，焦点任务有限制是正常的
3. 今日任务回顾
   - 数据和下面的内容是割裂的！应该是类似于树状结构
```
已完成
  |- 看书
  ｜- 看电影
暂停
……
```
  - 未完成的同理要增加是否添加到待处理还是明天继续
1. 今日进展记录
  - 不需要这个部分
2. 明日任务预览
  我觉得明日任务和待处理任务有交叉点，我的思路是明天（检测时间）打开这个 html 时，就自动把明日任务加到待处理任务中。
ultrathink
---
开发一个总结的汇总视图



---
1. “加入焦点”点击并没有刷新待处理任务列表
2. 控制台日志：
```task-focus-board.html:12073 🎨 [renderPlanningView] 开始渲染反思仪表板
task-focus-board.html:11865 🚀 MNTask 看板已启动
task-focus-board.html:12073 🎨 [renderPlanningView] 开始渲染反思仪表板
task-focus-board.html:12685 ✅ MNTask 任务看板初始化完成
task-focus-board.html:7646 快速进展面板不存在: quickProgress-task_3
toggleQuickProgress @ task-focus-board.html:7646
showQuickProgress @ task-focus-board.html:12651
onclick @ task-focus-board.html:12689
task-focus-board.html:7646 快速进展面板不存在: quickProgress-task_4
toggleQuickProgress @ task-focus-board.html:7646
showQuickProgress @ task-focus-board.html:12651
onclick @ task-focus-board.html:12689
``` ultrathink


---
1. 任务详情里应该要看到进展！但现在没有！
2. "计划"视图，目前的里面很多都是数字，或者只有任务名称。请注意我们的计划的这些筛选的目的是是对这些任务进行更好地处理，数字本身是没有意义的！一定要能回源到任务本身！
3. 当前控制台仍然有报错
```
task-focus-board.html:11802 🎨 [renderPlanningView] 开始渲染反思仪表板
task-focus-board.html:11594 🚀 MNTask 看板已启动
task-focus-board.html:11802 🎨 [renderPlanningView] 开始渲染反思仪表板
task-focus-board.html:12302 ✅ MNTask 任务看板初始化完成
task-focus-board.html:7521 Uncaught TypeError: Cannot read properties of null (reading 'classList')
    at toggleQuickProgress (task-focus-board.html:7521:36)
    at showQuickProgress (task-focus-board.html:12268:13)
    at HTMLButtonElement.onclick (task-focus-board.html:12306:34)
toggleQuickProgress @ task-focus-board.html:7521
showQuickProgress @ task-focus-board.html:12268
onclick @ task-focus-board.html:12306
task-focus-board.html:11802 🎨 [renderPlanningView] 开始渲染反思仪表板
task-focus-board.html:7355 Uncaught TypeError: Cannot read properties of null (reading 'stopPropagation')
    at addProgressNote (task-focus-board.html:7355:19)
    at HTMLDivElement.onclick (task-focus-board.html:1:40)
addProgressNote @ task-focus-board.html:7355
onclick @ task-focus-board.html:1

```
ultrathink


---
"计划"视图我们要重新设计:我目前的想法是结合对"焦点视图"的分析来处理，也就是要解决下面的问题，或者是帮助用户去反思：
1. 焦点任务都完成了吗？完成的怎么样？
2. 待处理任务里面还有内容吗？需要往里添加内容吗？
3. 今天的任务完成的怎么样（可以和时间轴联系起来），需要添加进展记录吗？
4. 明天的任务有哪些？
ultrathink

---
请你再完整阅读自查一遍 task-focus-board.html 里的代码逻辑和问题 ultrathink
---
“修复选择焦点任务后看板不更新的问题” 动作任务，我点击任务详情，发现里面提示“时间冲突”？？然后是“14:00-15:00” 下面有
```
⚡ 动作
回复紧急邮件
14:00-14:30
⚡ 动作
集成自动化测试框架
09:00-17:00
⚡ 动作
参加产品路线图评审
14:00-16:00
```
但我这个系统最核心的，就是我不考虑“安排时间”这个操作！！！！这个是无意义的操作！因为你不知道上一个任务什么时候做完，延迟了的话还要调整后面的任务！极其麻烦！


---
现在“计划”，“时间轴”和“看板”视图其实有一个很大的问题，就是目前整个窗口内能看到的文件比较少，主要原因是那个每个任务卡片的内容都是显示比较多，所以把窗口占满了。

所以我想的是，现在就是把默认效果改为收缩模式，比如只显示标题，然后路径的话以一个小一点的字号，以及淡一点的颜色显示在标题的下方。然后点击任务卡片后，才展开显示更多内容，然后展开后再点击就显示详情。

时间轴稍微不一样一点，可以改为，只显示
- 类型
- 标题
- 路径
- 状态
- 最新的一条进展记录

也是类似于上面的，点击第一次，展开，再点击就是进入详情页！ultrathink


---
“看板”视图现在还比较鸡肋。
1. 左侧栏占满了统计信息，这个可以显示在右侧视图的。左侧栏应该是一些提高效率的按钮。
2. 筛选功能不应该放在左侧，而是放在右侧看板里

一定要注意：这个看板是为了更好地看到目前任务的进展，从而进行下一步规划！你的设计一定要围绕这个目标！

总的还有一个问题：点击任务打开任务详情后，无法点击旁边空白处关闭，必须点击关闭按钮才行！交互不太友好
ultrathink

---
焦点任务左侧栏的“焦点统计”下方只保留“当前焦点”另外三个去掉。ultrathink


---
请重新自查顶部“看板”视图的代码，现在任务一个都筛不出来看板 列表 树形 甘特图，每个点击都是空白的内容。然后左侧栏没有“看板”视图适配的功能，而是其它视图的左侧栏！ultrathink

---
## 时间轴
1. 为什么我点击明天，会显示目标和关键结果？
2. 时间轴里只记录项目和动作卡片的开始和结束，目标和关键结果不需要记录。
```md
继续开发 task-focus-board.html。我来说一下顶部栏的功能的一些需要优化的点。

## 项目看板和目标看板

1. 左侧的“项目列表”好奇怪，怎么会直接把内容显示在左边呢？应该点击后在右边显示啊，因为后期项目的数量可能会比较大！
2. 项目看板目前无法通过拖拽改变项目的状态
3. 项目看板里的卡片点击“开始”或者“完成”卡片没有反应，但是左下角的那个项目统计有更新
4. 另外我要强调一下项目可能有子项目的，也就是说层级可能是
```
目标
  |- 关键结果 1
  |- 关键结果 2
    ｜- 项目 1
      ｜- 项目 1.1
      ｜- 项目 1.2
        ｜- 动作 1.2.1
        ｜- 动作 1.2.2
    ｜- 项目 2
      ｜- 动作 2.1
      ｜- 动作 2.2
```

当然也可能直接从项目开始往下。所以我希望项目看板和目标看板除了看板、列表外，还要增加一种类似于甘特图的那种，你可以参考一下 task-advanced-board.html 里面有一个功能是类似的。这个就是能从全局出发去看任务情况，尤其是项目和动作特别多的时候。

上面说的看板和列表样式也要包括动作任务。

所以我觉得项目看板和目标看板可以合并一下，就是“看板”，然后有一个按钮改成上面说的“计划”。

## 任务详情

1. 一些测试任务怎么还有“今日”字段？可能是之前删除时间的时候，这些测试数据没处理？需要更新一波新的测试数据了。
2. 现在“优先级”无法手动调整！
3. 链接一添加就修改不了了！
4. 任务卡片的显示界面（也就是没点开详情）要显示任务的路径，否则一些动作名可能会重复
5. 标题也是无法修改
6. 标签也是无法修改！

也就是说现在任务能改动的内容太少了！！！！

## 任务的快速添加
基于上面的新功能和当前整体架构，你再优化一下快速添加任务功能的设计。
```
ultrathink

---
刚刚出问题了，闪退了，我把之前的任务和你重新说，你自己检查一下是否完成了：
## 时间轴
1. 点完“下周”，点今天，会发现时间轴变成本周了，这是 bug
2. 左侧栏的“日期导航” 可以去掉，和右边的按钮重复了。
3. 左侧栏的“时间分布”去掉吧。
4. 右边的时间怎么这么乱？是不是日期没处理好？你看当前数据中的时间轴的日期

## 计划
“计划”按钮和“时间轴”按钮交换一下顺序。

计划的功能很多按钮点击没反应，请重点分析排查问题！
而且我觉得现在的逻辑可能还是有问题，请重新设计一个，可以去网上搜索资料，设计一个更好的计划功能。

然后把之前的任务完成。之前的任务为
```md
继续开发 task-focus-board.html。我来说一下顶部栏的功能的一些需要优化的点。

## 左侧栏
当窗口只有一半的时候，左侧栏无法自动收缩，会挡住下面的内容。


## 焦点任务
1. 焦点任务一旦完成，应该都不出现在焦点任务筛选中
2. 焦点下方的筛选有问题，标签和项目应该是交集关系，现在怎么变成了并的逻辑了？
3. 显示的这些任务卡片的内容其实还比较空，其实可以显示一些最近的几条的进展，不仅仅是只能通过手动点击“进展详情”来查看
4. 左侧有“选择焦点任务”右上角还有！重复了
5. 右上角的“安排明天任务”不需要高亮，我觉得计划功能需要单独在上方开一个按钮来切换视图，这是一个很大的，需要你好好设计的。目前焦点任务关注在当下，时间轴是看到一天的任务完成情况。“计划”功能里要能计划把什么任务加到“焦点任务”中的“待处理任务”中
6. 基于 6，其实“待处理任务”要改动逻辑，这里面的任务不能受焦点卡片和“待处理任务”中间的筛选的影响。可以在左侧加一个新功能就是添加任务到“待处理任务”，这个功能也可以在“计划”视图中使用。然后把筛选那个移动到这个新功能里。当前焦点下就是焦点任务和待成为焦点任务的待处理任务。左侧的“焦点统计”里感觉暂时只需要“当前焦点”，其它可以先暂时去掉。
7. “选择焦点任务”不需要默认高亮，然后“选择焦点任务”的功能是从待处理任务列表里选择。
8. “添加到焦点”可以改成一个图标类型，或者设计得再大一点，现在的按钮有点小

## 时间轴
1. 点击日周月右边的“今天”并没有跳转到当前实际的今天的日期，仍然是把 7 月 20 日，也就是昨天当做今天！我在今天 7 月 21 日 00:50 完成的任务，也放到了昨天的时间轴上！这是严重错误的！
2. 时间分布的“上午”，“下午”这几个点了没反应！
3. “日期导航”里的“明天”和“昨天”并不准确，比如我点击几次昨天，会一直递减，但是今天明天和昨天都是固定的。
4. “下周”我觉得要单独拿出来，也需要加一个本周。这个要不要开一个单独的视图？还是说把时间轴改成能支持多天显示的？


## 项目看板和目标看板

1. 左侧的“项目列表”好奇怪，怎么会直接把内容显示在左边呢？应该点击后在右边显示啊，因为后期项目的数量可能会比较大！
2. 项目看板目前无法通过拖拽改变项目的状态
3. 项目看板里的卡片点击“开始”或者“完成”卡片没有反应，但是左下角的那个项目统计有更新
4. 另外我要强调一下项目可能有子项目的，也就是说层级可能是
```
目标
  |- 关键结果 1
  |- 关键结果 2
    ｜- 项目 1
      ｜- 项目 1.1
      ｜- 项目 1.2
        ｜- 动作 1.2.1
        ｜- 动作 1.2.2
    ｜- 项目 2
      ｜- 动作 2.1
      ｜- 动作 2.2
```

当然也可能直接从项目开始往下。所以我希望项目看板和目标看板除了看板、列表外，还要增加一种类似于甘特图的那种，你可以参考一下 task-advanced-board.html 里面有一个功能是类似的。这个就是能从全局出发去看任务情况，尤其是项目和动作特别多的时候。

上面说的看板和列表样式也要包括动作任务。

所以我觉得项目看板和目标看板可以合并一下，就是“看板”，然后有一个按钮改成上面说的“计划”。

## 任务详情

1. 一些测试任务怎么还有“今日”字段？可能是之前删除时间的时候，这些测试数据没处理？需要更新一波新的测试数据了。
2. 现在“优先级”无法手动调整！
3. 链接一添加就修改不了了！
4. 任务卡片的显示界面（也就是没点开详情）要显示任务的路径，否则一些动作名可能会重复
5. 标题也是无法修改
6. 标签也是无法修改！

也就是说现在任务能改动的内容太少了！！！！

## 任务的快速添加
基于上面的新功能和当前整体架构，你再优化一下快速添加任务功能的设计。
```
ultrathink

---
时间轴上的任务也要支持能输入进展！ultrathink
---
补充：
1. 焦点任务视图的左侧“任务筛选”不需要暴露出来，这个应该是放在“添加到待处理”里面来筛选要加到待处理任务的那些任务！ 
2. “选择焦点任务”按钮不需要默认高亮！
3. 计划视图的左侧栏也要进行相应的适配，而不是用焦点任务视图的左侧栏！
ultrathink
---
为了防止你遗忘目前的最初的需求，我再说一下最初的需求：
```md
继续开发 task-focus-board.html。我来说一下顶部栏的功能的一些需要优化的点。

## 左侧栏
当窗口只有一半的时候，左侧栏无法自动收缩，会挡住下面的内容。


## 焦点任务
1. 焦点任务一旦完成，应该都不出现在焦点任务筛选中
2. 焦点下方的筛选有问题，标签和项目应该是交集关系，现在怎么变成了并的逻辑了？
3. 显示的这些任务卡片的内容其实还比较空，其实可以显示一些最近的几条的进展，不仅仅是只能通过手动点击“进展详情”来查看
4. 左侧有“选择焦点任务”右上角还有！重复了
5. 右上角的“安排明天任务”不需要高亮，我觉得计划功能需要单独在上方开一个按钮来切换视图，这是一个很大的，需要你好好设计的。目前焦点任务关注在当下，时间轴是看到一天的任务完成情况。“计划”功能里要能计划把什么任务加到“焦点任务”中的“待处理任务”中
6. 基于 6，其实“待处理任务”要改动逻辑，这里面的任务不能受焦点卡片和“待处理任务”中间的筛选的影响。可以在左侧加一个新功能就是添加任务到“待处理任务”，这个功能也可以在“计划”视图中使用。然后把筛选那个移动到这个新功能里。当前焦点下就是焦点任务和待成为焦点任务的待处理任务。左侧的“焦点统计”里感觉暂时只需要“当前焦点”，其它可以先暂时去掉。
7. “选择焦点任务”不需要默认高亮，然后“选择焦点任务”的功能是从待处理任务列表里选择。
8. “添加到焦点”可以改成一个图标类型，或者设计得再大一点，现在的按钮有点小

## 时间轴
1. 点击日周月右边的“今天”并没有跳转到当前实际的今天的日期，仍然是把 7 月 20 日，也就是昨天当做今天！我在今天 7 月 21 日 00:50 完成的任务，也放到了昨天的时间轴上！这是严重错误的！
2. 时间分布的“上午”，“下午”这几个点了没反应！
3. “日期导航”里的“明天”和“昨天”并不准确，比如我点击几次昨天，会一直递减，但是今天明天和昨天都是固定的。
4. “下周”我觉得要单独拿出来，也需要加一个本周。这个要不要开一个单独的视图？还是说把时间轴改成能支持多天显示的？


## 项目看板和目标看板

1. 左侧的“项目列表”好奇怪，怎么会直接把内容显示在左边呢？应该点击后在右边显示啊，因为后期项目的数量可能会比较大！
2. 项目看板目前无法通过拖拽改变项目的状态
3. 项目看板里的卡片点击“开始”或者“完成”卡片没有反应，但是左下角的那个项目统计有更新
4. 另外我要强调一下项目可能有子项目的，也就是说层级可能是
```
目标
  |- 关键结果 1
  |- 关键结果 2
    ｜- 项目 1
      ｜- 项目 1.1
      ｜- 项目 1.2
        ｜- 动作 1.2.1
        ｜- 动作 1.2.2
    ｜- 项目 2
      ｜- 动作 2.1
      ｜- 动作 2.2
```

当然也可能直接从项目开始往下。所以我希望项目看板和目标看板除了看板、列表外，还要增加一种类似于甘特图的那种，你可以参考一下 task-advanced-board.html 里面有一个功能是类似的。这个就是能从全局出发去看任务情况，尤其是项目和动作特别多的时候。

上面说的看板和列表样式也要包括动作任务。

所以我觉得项目看板和目标看板可以合并一下，就是“看板”，然后有一个按钮改成上面说的“计划”。

## 任务详情

1. 一些测试任务怎么还有“今日”字段？可能是之前删除时间的时候，这些测试数据没处理？需要更新一波新的测试数据了。
2. 现在“优先级”无法手动调整！
3. 链接一添加就修改不了了！
4. 任务卡片的显示界面（也就是没点开详情）要显示任务的路径，否则一些动作名可能会重复
5. 标题也是无法修改
6. 标签也是无法修改！

也就是说现在任务能改动的内容太少了！！！！

## 任务的快速添加
基于上面的新功能和当前整体架构，你再优化一下快速添加任务功能的设计。
```
ultrathink

---
左侧的“今日任务”现在和“今日时间轴”是一样的功能。我希望
1. “今日时间轴”改为“时间轴”，能查看往日的时间轴
2. “今日任务”还是是希望只查看今日的任务时间轴
3. 目前还没有一个安排明天任务的功能。 请研究当前的看板之后然后设计一个。ultrathink
---
1. 目标和关键结果不暴露在“焦点任务”中。这个任务只关心“动作”任务，因为动作是能执行的任务！
2. “项目”，“目标”单独设置看板，在上方按钮中切换，“关键结果”属于目标看板
3. 现在“当前焦点任务”下无法手动排序！！！ultrathink

---
1. 现在“当前焦点”下方的“待处理任务”怎么点击一下就马上加入上方焦点了？？我都没点“添加到焦点”
2. 筛选功能现在没有效果，比如切换项目，下方的内容没有进行相应切换！
3. 然后重点思考下面的痛点和需求：
  - 我个人认为时间安排是没有用的，因为你不知道你几点可以开始任务，而且几点可以结束任务，所以时间安排是没有意义的。
  - 在时间轴里的应该是只有正在进行的和已经完成的，未开始的不需要。
  - 然后当前的任务完成之后应该做什么呢？这个就是在焦点看板里进行排序就行。
ultrathink
---
测试数据单独成一个文件，我后面方便修复

## 选择焦点功能的问题

我取消掉一个项目的选择，确定后，项目还在，打开项目，发现项目的焦点没有取消掉。

## 快速添加任务
1. 输入 @ 来关联项目的时候，能否弹出已有项目来选择？类似于 OmniFocus 那种效果，否则 @后面项目名可能很长，自己会记不住！

## 时间轴

### 增加任务开始时间和结束时间处理
从未开始切换到进行中时，则开始时间为当前时间。

进行中切换到已完成时，则结束时间为当前时间。

### 显示
像“事线”app 的效果那样，任务的记录也显示在时间轴上，但是是作为对应任务的子项，比如：
```
9:00: 写代码
        ｜- 9:05 遇到点问题
        ｜- 9:10 解决问题
```

### 问题
不一定是一个动作结束了才开启另一个动作的，比如某一个任务进行时，同时进行另一个任务，那么这个时候时间轴怎么处理比较好呢？

###  任务状态
增加一个暂停状态，介于未开始和进行中之间。
场景：一个动作可能当天没有完成，就先暂停，否则时间轴上会一直显示任务
 ultrathink

---
mntask 的动作转项目卡片有问题。比如动作卡片默认制卡后是
```
【动作|未开始】啊啊
信息
所属
启动
进展
```
但是这个时候通过“修改卡片类型”动作转换的评论变成了：
```
信息
包含
未开始
进行中
已完成
已归档
所属
启动
进展
```
这是错误的！“包含”以及下面子字段应该在“进展”字段的上方，也就是正确的应该是
```
信息
所属
启动
包含
未开始
进行中
已完成
已归档
进展
```
请解决！请你仔细分析动作卡片应该的样式和项目卡片应该的样式！然后再开始考虑处理逻辑 ultrathink
---
继续开发 mntask 的启动按钮的单击功能，现在 launchTask 优化一下：
1. 每天有一个固定的复习任务，要在所有任务开始之前完成
2. 所以每天第一次点击启动，应该执行复习任务，而有一个 uistate 链接来保存这个复习界面：`marginnote4app://uistatus/H4sIAAAAAAAAE01Ty3LbMAz8F56tDN8P3yy57qWHHnrrdDqUBMVKKFEj0kncjP%2B9JO3WvhHYxQJYQZ%2FIzuEdVrQlG9R6%2Fzr1Am0RCCWlEmC06lvgg5EtZ53QPR3I0BmMjcJEE6WVor3qBq6BCyGxZq2wEiS6ioXFjRFtcY5i9FPvO7QdrAuwQZ1d%2B9Z%2FFDS%2Fob9RO%2Bf%2FwJ3mpwnmmBkPuTmmXCj0pOnsGdYx4aghtTKa0WrH9rLi5Auudk3NKrbHih002Smi0mzwker7yfdQJIbRwVVscN7GyS7XwHenMPsIRbo%2B1Hyva1oZSnnFRS0rbXKID4LqBu8YM0l6ODn3uGYS%2B%2BY7G0c%2Fo%2B0n8sMQIObX75fg5zfrTvDjvECe%2Fet3P84xaWRTnrihhCpJqVHSMC70Bp1LXmtMFKdUJMMF5eKyQaGzLq%2FyJJlMsDFMc4aVluRSJgjgXEhdf%2F7aIL%2FAehsHP0S%2BfbkmTtGN893%2FxT5D8jelC7zYGVypKO04k4ZLyTTmRKaLSIRELswVAti1O96CtxHey5Gt4%2FPxavGtw5WWz6VQw9hDa9c7nG9onAefTev8KTm0zWtF24bj2Pcw%2F6fGI0zZyT0M9uSyk9EvY1c%2BH%2BcN54Q3Va0aVvHdQVY107qimBjc7GrRHPa5YE3%2Fw2JXyG1usnn0f5d8%2BQsPOiesMQMAAA%3D%3D` 。
3. 我的想法是这样，设置一个全局变量和 iCloud 同步的（注意要和笔记本相关）来记录今天是否复习了。每天早上七点后打开软件时这个 bool 值为 false，表示今天还没有复习。如果是 false 的话，启动按钮默认启动复习的链接。
4. 启动按钮加一个长按功能，点击后表示已完成今日复习，设置全局变量为 true。
5. 我想的是我可以给一张卡片 ID 专门记录每天的复习时间，比如启动复习开始计时，然后复习完成后，记录下时间。这个卡片的 ID 也是我给出然后与学习集同步。具体的时间，用时间戳（参考时间戳的记录）就行，比如开始时间，结束时间，用了多久
---
我补充一下:这个制卡逻辑是很简单的,你不要弄复杂了,我选中的这段内容,其实已经包含了合并默认字段后每一步的逻辑.重新回去看当前的逻辑进行修复 ultrathink          

1. “项目”的“信息”字段下，缺少了“所属”，比如下面的例子，记为 A
```
【项目>哈哈阿拉丁按时>嘎嘎嘎嘎|未开始】哈哈哈哈
信息
包含
未开始
进行中
已完成
已归档
进展
```
1. “动作”的“信息”字段下，有启动，但也缺少了“所属”。比如下面的例子，记为 B
```
【动作>>哈哈阿拉丁按时>>嘎嘎嘎嘎>>哈哈哈哈|未开始】B
信息
启动
进展
```
制卡后，A 的最下面增加了 B 的链接，但位置错误
```
【项目>>哈哈阿拉丁按时>>嘎嘎嘎嘎|未开始】哈哈哈哈
信息
包含
未开始
进行中
已完成
已归档
进展
【动作>>哈哈阿拉丁按时>>嘎嘎嘎嘎>>哈哈哈哈|未开始】B （这条是B 的链接，只是显示为B 的标题）
```
链接应当是
```
【项目>>哈哈阿拉丁按时>>嘎嘎嘎嘎|未开始】哈哈哈哈
信息
包含
未开始
【动作>>哈哈阿拉丁按时>>嘎嘎嘎嘎>>哈哈哈哈|未开始】B （这条是B 的链接，只是显示为B 的标题）
进行中
已完成
已归档
进展
```

所以综上，应该 A 制卡后的效果理论效果为：
```
【项目>哈哈阿拉丁按时>>嘎嘎嘎嘎|未开始】哈哈哈哈
信息
所属 嘎嘎嘎嘎（此时为A 卡片的父卡片的标题的行内链接）
包含
未开始
进行中
已完成
已归档
进展
```

B 制卡后，B 应该是
```
【动作>>哈哈阿拉丁按时>>嘎嘎嘎嘎>>哈哈哈哈|未开始】B
信息
所属 哈哈哈哈（此时为B 卡片的父卡片 A的标题的行内链接）
启动
进展
```
同时 A 变成
```
【项目>>哈哈阿拉丁按时>>嘎嘎嘎嘎|未开始】哈哈哈哈
信息
包含
未开始
【动作>>哈哈阿拉丁按时>>嘎嘎嘎嘎>>哈哈哈哈|未开始】B （这条是B 的链接，只是显示为B 的标题）
进行中
已完成
已归档
进展
```

3. 已经是任务卡片的，制卡后缺少清除失效链接的处理，请重新分析逻辑并实现上面的效果，上面的效果以前是实现了的！如果你想要看以前的代码
```
mnaddon4 unpack <路径>
```
可以把 mntask 目录下的 *.mnaddon 进行解压。我印象里大概是 12.2 以前的制卡都没问题，只是以前的制卡的代码没有封装，全都暴露在 xdyy_menu_registry.js 里了。

ultrathink

---
继续开发 MNTask。
现在制卡功能有严重的问题！！！！！！！！！！
“所属”和“启动”怎么都变成了主字段，而且内容都没有了！！！
<span id="mainField" style="font-weight:600;color:#1E40AF;background:linear-gradient(15deg,#EFF6FF 30%,#DBEAFE);border:2px solid #3B82F6;border-radius:12px;padding:10px 18px;display:inline-block;box-shadow:2px 2px 0px #BFDBFE,4px 4px 8px rgba(59,130,246,0.12);position:relative;margin:4px 8px;">所属</span> 
请查看 git 最近的几次 commit 看看你是改动了什么导致的。
ultrathink

---
1. 任务制卡出问题！[01:56:39] [INFO] [Default] ❌ taskCardMake 执行失败: undefined is not an object (evaluating 'result.type')
点击制卡按钮后，选择“动作”之后又弹出一个选类型的弹窗？？？

1. 点击“启动”按钮的单击效果一直显示“未找到启动链接”，但启动字段里的链接我两种都试过了，仍然显示“未找到启动链接”，请分析并解决。

2. setting 里的“看板”视图先去掉吧，现在暂时不需要，先把控制显示的那个先注释掉，否则会[
  {
    "version": "marginnote4",
    "type": "macOS",
    "taskVersion": "0.12.5"
  },
  {
    "source": "handleRefreshBoard",
    "time": "Thu Jul 17 2025 01:54:52 GMT+0800 (中国标准时间)",
    "error": "this.loadTodayBoardData is not a function. (In 'this.loadTodayBoardData()', 'this.loadTodayBoardData' is undefined)"
  },
  {
    "source": "handleTodayBoardProtocol",
    "time": "Thu Jul 17 2025 01:54:53 GMT+0800 (中国标准时间)",
    "error": "this.loadTodayBoardData is not a function. (In 'this.loadTodayBoardData()', 'this.loadTodayBoardData' is undefined)"
  }
]

ultrathink

---

请完善 launchTask 函数（已经在 MNTaskManager 里定义了）。
1. isTaskLaunched 和 currentLaunchedTask 变量（就在launchTask 函数上的上面两行）分别表示
   - isTaskLaunched：是否有任务被启动了
   - currentLaunchedTask：当前运行的任务卡片（你可以改成存卡片的 ID）
  但我还没有把他们的数据永久化，也就是存到 iCloud 里面，请你处理
1. 我的逻辑是这样的：
   - 如果我选中了任务类型的卡片，然后触发 launchTask 函数，则此时获取到（通过 getLaunchLink）获取到启动的链接，记为 link
     - 看 link 是哪种类型（可以封装一个函数判断）一共有两种：uistate(`marginnote4app://uistatus/` 开头) 和 note 的 URL（有一个 getLaunchLinkType 可以看看是不是可以用）
       - 如果是 uistate ，暂时做空处理，后面完善
       - 如果是 note 的 URL，就在主视图定位这个 url 对应的卡片
     - 然后 isTaskLaunched 设置为 true，因为此时启动了任务
     - currentLaunchedTask 就变成当前选中的这张任务卡片
   - 如果没有选中卡片，或者选中的不是任务类型的卡片
     - 此时先看 isTaskLaunched 是不是 true，以及 currentLaunchedTask 有没有内容，如果有，此时的效果就是在主视图定位 currentLaunchedTask 卡片，并且  isTaskLaunched 改为 false，也就是我们重新回到了任务规划。
2.  launchTask 函数我已经加载在 mntask 的 menu_quick_launch 菜单下了。我需要你写一个长按菜单里的功能，其实是基于上面的功能，因为有的时候我需要找到当前的任务卡片，然后记录进展，这个时候不需要在主视图定位，而且 isTaskLaunched 也不需要改成 false。也就是只检测 currentLaunchedTask 是哪种卡片，然后在浮窗中定位。简而言之，这个功能就是在浮窗定位当前启动的任务卡片。
ultrathink

MNTaskManager 类里面有很多函数重复了！请自己检查并去重，注意要看内容，基本一致的就直接删掉，有比较大区别的最后汇总起来我来判断。



---
目前任务卡片有“进展”字段。目前是全部都是手动输入的，我希望下面的情况能够自动处理。对于目标，关键结果，以及项目三种类型的卡片，记为 A，如果子卡片 B 的状态更新了，就要把这个更新记录添加到进展里。记录用行内链接，也就是 [B 的标题（没有前缀部分）](卡片 URL)，我们把这个记为 content
1. 用 addTimestampRecord 函数里面的部分内容，可能你要先封装一下，才能内部调用。
2. 以下情形要记录
   1. 未开始 状态转为进行中：开始「content」
   2. 进行中 状态转为已完成：完成「content」
   3. 已完成 状态退为进行中：重新进行「content」
暂时就想到这么多，你可以补充和完善。ultrathink


---
动作转项目卡片有问题。比如动作卡片默认制卡后是
```
【动作|未开始】啊啊
信息
所属
启动
进展
```
但是这个时候通过“修改卡片类型”动作转换的评论变成了：
```
信息
包含
未开始
进行中
已完成
已归档
所属
启动
进展
```
这是错误的！“包含”以及下面子字段应该在“进展”字段的上方，也就是正确的应该是
```
信息
所属
启动
包含
未开始
进行中
已完成
已归档
进展
```
请解决！

---
❌ 需要封装的动作（大量）：中 1,2,3,5 封装优化，其余动作直接删除（注意菜单里也要对应删除）
---
下面开发 mntask 项目。
1. 一旦修改代码，就需要按照修改的内容程度来改 mnaddon.json 的版本号。
2. 任何更新，尤其是新功能，要在 mntask_guide.md 里详细更新。
3.  /Users/xiakangwei/Nutstore/Github/repository/MN-addon-develop/MN-Addon/log.md 是用于测试的 log 文件，一般说“log 文件已更新”就是这个。 MNUtil.log() 添加的内容我会复制到这里。太多了话请分段细读，这个很重要。如果区分 iPad 和 mac 的话，iPad 端的 log 信息在 iPad_MNUtils_LogViewer.md 里。
4.  你更新的 log 写在 mntask_guide.md 里! 而不是 log.md 里。 
---
1. 如果已经是任务卡片了，不要直接跳过，要检查是否有失效链接！



---
新增一个“记录”按钮，单击后能增加一个时间戳记录。具体细节如下：
1. 例子
```
<div style="position:relative; padding-left:28px; margin:14px 0; color:#1E40AF; font-weight:500; font-size:0.92em">
  <div style="position:absolute; left:0; top:50%; transform:translateY(-50%); 
              width:18px; height:18px; background:conic-gradient(#3B82F6 0%, #60A5FA 50%, #3B82F6 100%); 
              border-radius:50%; display:flex; align-items:center; justify-content:center">
    <div style="width:8px; height:8px; background:white; border-radius:50%"></div>
  </div>
  2025-07-15 23:52:42
</div>
内容
```
2. 样式：时间的样式就获取当前的时间，然后用上面的样式来显示。内容的地方通过弹窗来让用户输入内容。
3. 位置：添加在选中的卡片的最后一个评论即可，很简单，直接 appendMarkdownComment 就行。


---
任务卡片的制卡我们现在增加一个新的主字段叫做“进展”，放在最下方。
1. 要注意“包含”下方的任务链接的移动处理是否会出问题？是否要进行相应的修改？因为之前的话“包含”主字段是在最下方
2. 如果一些之前制作的任务卡片的话，优化一下 taskCardMake 函数，对于旧卡片， taskCardMake 触发时检测一下卡片是否有“进展”这个主字段，如果没有的话就添加一个。



---
 然后现在还不需要通过插件来访问实际的数据,我需要你自己测试一些数据，因为卡片类型有四种，而且要考虑筛选之类的，所以数据要比较多。

 数据结构是这样的（具体的请看一下 MNTaskManager 里的函数来理解）：我们操作的都是卡片，卡片有标题和评论。
 具体的卡片的 API 需要看一下 [MNUtils 的API文件](mnutils/MNUtils_API_Guide.md). 但其实你基本上操作的都是 markdown 类型的文本评论，具体还要学习 [utils 里的 MNComment 类和 MNNote 类来看评论是如何操作的](mnutils/mnutils.js)，比如修改，删除，添加。

 每个任务卡片都有一个卡片的 ID，这个将作为 html 与卡片交互的唯一标识符。这个提示你一下。

 注意这些的目的是为了帮助你更好地开发面板，我们先把 html 写好。然后你基于上面的分析来更好地把 html 开发一下。然后数据就是你自己给一些目标的，项目的例子来测试 html 的功能。

---
我得说一下为什么要开发这个看板，以及这个看板后续的功能。
这个看板并不是要把按钮的功能通过这个看板实现，而是开发按钮实现起来麻烦的功能，比如任务的字段添加，修改，移动，删除。

或者是任务的筛选功能这些需要更好的 UI 交互的功能。ultrathink

---
看板功能开发有巨大的问题。我咨询了插件开发专家，他说
1. 没处理跨域的问题，要避免跨域的东西
2. 完全不需要 iframe，这东西一个纯 html 就能写完的
3. 学习 /Users/xiakangwei/Nutstore/Github/repository/MN-addon-develop/mnbrowser/mnbrowser：“看 Browser 的主页代码吧，要么插件端跑个 js 拿到网页端的信息，要么网页端触发一个 URL Scheme 然后插件端拦截”
4. 插件和网页本身是比较独立的东西，可以先单独写网页部分，在电脑浏览器上确保这个网页所有功能都正常，再去封装函数，然后回到插件里考虑数据交换的部分

我网页开发一点也不懂，我觉得你先像他说的那样，先开发网页测试，然后再考虑数据交换，然后你写的代码要有充足的注释，也就是你的开发也是要作为我学习的示例。 ultrathink

---
iPad_MNUtils_LogViewer.md 已更新。

iPad 端测试：打开看板后，左侧栏的按钮点击后都显示“刷新完成”。
但是现在仍然是一直显示“加载中”，不加载，怎么点刷新按钮都没用
我把所有的按钮都点了一遍，log 信息在 iPad_MNUtils_LogViewer.md 里，已更新。
ultrathink


---
mac 端测试：
1. 字段可以通过 html  添加了！但是编辑失败！也就是编辑后没有同步进去。删除也不行！
2. 卡片的信息没有加载到任务编辑看板里，标题部分仍然是“加载中”。应该是包括字段信息都要加载出来。
3. 我点击“保存更改”，弹窗“获取更改失败”，但我脑图里是选中了卡片的
也就是任务编辑功能，目前只能加字段，其它功能全部失效。

iPad 端测试：
log 信息在 iPad_MNUtils_LogViewer.md 里，已更新。
2. 点击“刷新看板”后弹窗显示“刷新完成”，但界面仍然是“加载中”，没有任何变化
3. “刷新队列”
  - 点击“刷新队列”界面没任何反应，仍然是“加载中”
4. "任务列表"
  - 点击“任务列表”后，面板没有任何变化
5. 任务编辑功能和 mac 端一致，只能加字段。
总而言之，iPad 端全都是加载中，点刷新也没用。

请修复上述问题！
ultrathink

---
log.md 已更新。
mac 端测试：
这次问题太严重了。
打开看板后弹出：“任务看板已打开”“今日看板初始化失败”
然后整个看板是空白的，一直在“加载中”转圈。
左侧栏的其他按钮点击没有任何反应，一直是今日看板选中的状态！  太严重了这次的问题！ultrathink
---

log.md 已更新。
mac 端测试
1. log 信息没有频繁增加了
2. 任务编辑功能仍然有大问题
   - 没选中时弹窗提醒没有选中
   - 但选中后点击左侧栏的“任务编辑”按钮，但面板没有任何变化，没任何反应，但我注意到 log 信息里好像有新增一些内容

iPad 端测试：
log 信息在 iPad_MNUtils_LogViewer.md 里。
除了不会频繁增加了，其他问题全部都没有任何改进。
1. 打开看板后一直是“加载中”
2. 点击“刷新看板”后弹窗显示“刷新完成”，但界面仍然是“加载中”，没有任何变化
3. “刷新队列”
  - 点击“刷新队列”界面没任何反应，仍然是“加载中”
4. "任务列表"
  - 点击“任务列表”后，面板没有任何变化
5. “任务编辑”情况与 mac 端一致

这是个很严重的问题，这意味着我 iPad 上连用都用不了了！请再仔细学习 mnai, mnutils, mntoolbar 的项目对 html 的处理，看看自己是不是哪里没处理好！
ultrathink

---
mac 端测试
1. 日志没有频繁刷新了
2. 任务编辑功能仍然有大问题
   - 没选中时弹窗提醒没有选中
   - 选中后点击左侧栏的“任务编辑”按钮，但面板没有任何变化，没任何反应

iPad 端测试：
1. 打开看板后一直是“加载中”
2. 点击“刷新看板”后弹窗显示“刷新完成”，但界面仍然是“加载中”，没有任何变化
3. “刷新队列”
  - 也是 2s 就往日志里加内容
  - 点击“刷新队列”界面没任何反应，仍然是“加载中”
4. "任务列表"
  - 点击“任务列表”后，面板没有任何变化
5. “任务编辑”情况与 mac 端一致

log.md 已更新。请详细诊断和修复上面的问题 ultrathink

---
iPad 的看板一直在刷新，今日看板，项目都是！一直出不来。我看 MNUtils 的 log 信息发现 log 一直在刷新，好像是一直反复添加 log


--
还有一些问题：（我们说的看板都是“setting”点击后，或者是“看板”按钮点击后打开的那个看板，通过 html 来实现的）
1. 看板进入后，点击左侧除了“今日看板”以外的，再回到“今日看板”，会一直显示“加载中”，
   需要手动刷新才能显示内容。
2. 任务“安排”按钮点击一直弹窗“安排日期失败”
3. 任务“完成”按钮击一直弹窗“更新状态失败”
2 和 3 综合在一起就是看板里的任务卡片除了“详情”有效，其它都无效！请修复！！
ultrathink


---
1. 选中任务卡片后，点击“任务编辑”按钮，弹窗显示“正在打开任务编辑器...”，但面板没有任何变化
2. 看板里的任务卡片的“编辑”按钮点击也没有任何反应
严重问题！请修复 ultrathink

---
1. 看板按钮增加多选菜单里的功能：对脑图里选中的卡片，点击这个菜单动作后，就直接打开看板里的任务编辑进行这张卡片的编辑！
2. 如果是看板里筛选的卡片，不需要回到脑图再选，需要支持点击“编辑”就直接到任务编辑界面！ultrathink

---
任务编辑出现了，但
1. 我选中卡片，仍然提示我未选中任务卡片
2. 我点击取消后，左侧栏里的“任务编辑”就直接消失了！
ultrathink

---
我重新和你汇总一下现在问题，以防遗漏
1. 新加的卡片编辑功能我也没看到在哪！左侧应该多一个卡片编辑栏的，但没有！
2. 从按钮点击看板，打开看板后仍然显示“打开看板失败”！请解决！
“任务队列”界面
1. 任务的“今日”按钮点击无效
2. 点击完成后，脑图里的卡片状态并没有更新，然后弹出了一个报错
  ultrathink


---
单击看板按钮仍然显示失败，然后是错误报错弹窗：MN Task Error (registerTaskUpdateObserver): ReferenceError: Can't find variable: setinterval。但是看板是加出来了。ultrathink


---
1. 看板按钮的单击显示“Not supported yet”！“打开任务看板” 功能也是，这样就不方便了，希望的效果是和 “setting” 一样能打开看板的 html 界面。
2. 项目视图的那个筛选框，必须要把面板弄的很宽才会出来，应该加一个按钮能手动打开
3. 今日看板里，我点击“刷新”后弹出：已修复1个旧版标记，我点击一次就弹出一次，这个修复肯定是一次性的动作，不应该出现这么多次！
4. 我点击任务队列里任务的“今日”标签，弹出“添加到今日失败”，请修复！
5. 看板里的任务编辑要实现与卡片里的一一对应：卡片里编辑可以更新到看板里，看板里编辑的内容可以更新到卡片里。
编辑包括：增加，删除，修改，排序。
1. 字段
  - 主字段
  - 子字段
  这个比较特殊，因为这个是包裹在一个具体的 span 标签里的，所以要特殊处理
1. 具体，特殊的内容
  - “启动”链接的更新
2. 如果是粘贴的是 MarginNote 的链接（mnutils 有 API 来判定），那么返回到卡片里就是显示的是对应的卡片的标题
3. 其它细节你根据目前 MNTaskManager 里的函数来综合判断要如何实现，反正核心要点就是用 HTML 提升 UI 交互和用户体验。 ultrathink

---
1. 看板按钮的单击显示“Not supported yet”！请修复！
2. 主视图确实切换到“看板”了，但是我希望把顺序也移到 “Button”视图的前面
3. 开发一下新功能：目前有个按钮是添加新的字段的，如果是按钮的添加就很麻烦，一个字段涉及字段名和内容，希望能用 html 来优化这个交互。请你先分析字段菜单里的按钮的功能代码，然后尝试如何将这些功能兼容到 html 里，可能目前看板 html 里左侧还需要加一个就是任务编辑，比如我在脑图汇总点击某个按钮的功能，就可以打开这个任务编辑的 html 界面。可以方便地看到这个任务卡片的元信息！可以方便地添加移动和删除字段。比如前面说的给任务修改日期等功能，刚刚没有看到怎么添加，也可以在这个界面来添加。 ultrathink

<!-- 4. 最后，代码改动有点大，核查一下修改造成的影响，尤其是插件面板的 UI 交互方面，很容易出错，检查遗漏和错误，有的话进行修复。也就是要对这次比较大的更新再自查一下问题！ -->

---
1. setting 打开后
   - 发现关闭按钮消失了
   - 最上方的横条，点击本来可以拖动的，也点击没反应，移动不了了
   - 视图最开始也还是 Button，应该是改成了我们前面说的看板！
ultrathink

---
1. “系统日志”可以去掉了，然后视图切换也可以把“日志”去掉了，保留一个就行，叫“看板”。
2. 目前这个 html 里应该可以做很多事，比如有一个给任务安排时间还没处理，比如我写了很多动作，但是今天肯定安排不完，或者我知道某些只能某一天做，希望可以支持选择时间，对应的到时候的日期的时候就可以在今日看板里筛选出来。而且日期也能作为日期排序。
3. 卡片版本的“今日看板”可以去掉了，之后今日看板都是指现在这个 html 版本的
4. 目前这个 html 版本的启动不方便，首先是视图在比较后面，每次都要移动，把这个放在最前方。
5. 上面完成之后，就需要更新按钮里的功能
   1. 首先是今日标签不需要加今日，而是变成“日期”子字段，判断是否是今日就是看这个字段的内容是否是当天的日期，这样能和日期兼容在一起
   2. 今日，看板，筛选三个按钮里很多功能都可以做到 html 版本的看板里，然后去掉。“看板”按钮的单击为打开这个看板
6. 去网络上搜索一些优秀的任务管理工具，看看他们的功能和设计，参考一下，看看能否在这个 html 版本的看板里实现。

我很期待你的实现，请你认真对待！ultrathink


---
之前的逻辑是会根据动作卡片的状态来决定上级的状态，有个问题，如果A 为项目，B 为动作，A 只有 B 一个动作，B 已完成时，A 也是已完成，但 B 更新为已存档时，A 变成了进行中，但此时A 下面没有其它动作，或者是非“已完成”和“已存档”状态的动作，所以应该 A 的状态还是已完成！ultrathink

---
还有点问题：
1. 进行中的卡片，有今日标签，状态更改为已完成时，今日看板不会刷新！ultrathink


---
有进步！log.md 已更新。
已经不是完全白的了。html 加载出来了
你这次修改最主要的，能让 html 显现的关键，请你之前遇到的问题和最终解决思路进行总结，写到 MN-Addon/CLAUDE.md 文件中，并记忆。注意不要和 CLAUDE.md 里面已有内容重复。

然后开始修复问题：还是弹窗“今日看板初始化失败”。
导出数据功能正常，我看了一下内容，确实是今天的两个任务：
```
📊 今日任务报告
📅 日期：2025/7/11
⏰ 时间：20:23:42
━━━━━━━━━━━━━━━━━━━━

📈 统计摘要
• 任务总数：2
• 未开始：1
• 进行中：1
• 已完成：0
• 过期任务：0
• 完成率：0%

😴 未开始（1）
────────────────
▶️🟢 单击为增加“CHECK”


🔥 进行中（1）
────────────────
📁🟢 增加 “证明”按钮
```

剩下主要就是看为什么初始化失败，然后是任务信息如何加载出来显示在 html 里面。
ultrathink

---
今日看板刷新问题：
1. 统计信息重复添加了，直接把统计信息去掉吧，不需要了
2. 有今日标签的的状态更新，应该要在今日看板内刷新状态！
ultrathink



---
仍然会复制！D19B960F-6570-4EFC-B202-341F2033C5F7，复制了这个。log.md 已更新。ultrathink



我点击“聚焦今日看板”，弹窗里显示了今日任务
```
今日任务：5个
进行中：3个
```
也成功在浮窗定位了今日看板卡片，但卡片仍然只有标题。log.md 已更新。ultrathink

---
目前有一个大问题就是按钮里的菜单里的很多函数失效了。
请你逐个进行检查，看看哪些函数失效了，哪些没有实现，哪些有问题，然后进行修复。ultrathink

---
现在有一个问题，就是我的 mac 上和 iPad 是同一个 iCloud，但是这个看板的绑定，以及上传到 iCloud 数据就会有冲突，而这个任务看板对应的其实是不一样的。我觉得还有一个方案，就是这个上传到 iCloud 的内容，除了要和系统有关，也要和学习集有关，也就是笔记本，每个笔记本都有自己的唯一 id，可以把这个作为上传到 iCloud 的唯一标识符，这样就可以避免冲突了。
也就是不同笔记本里都可以设置一个局部的任务管理。

因为我刚刚在 mac 上发现我的卡片版本的今日看板不刷新了，显示的今日任务数一直不变，我怀疑是它读取的是我 iPad 上另一个学习集里的，所以有上面的需求！ultrathink

---
请你精读 mnutils 项目和 mntoolbar 项目，学习他们是如何调用 html 来扩展内容的，尤其是 mnutils 的 log 信息 有一个 log viewer 就是结合了 html 来实现的！
这样的话看看能否把今日看板之类的功能能否结合 HTML 来实现？这样可以设计更好的 UI 以及可以更好地展示内容了。
ultrathink
---
增加检查看板。下面详细解释。

---
1. “切换类型”的话，需要查看下面有没有“包含”和状态字段，动作卡片不需要！
2. 状态的话：“已阻塞”和“已取消”都去掉
3. “getOKRNotesOnToday”报错：获取OKR任务失败：MNTaskManager，getAllTaskCardsFromBoard is nota function. （In'MNTaskManager getAllTaskCardsFromBoard （rootNote）， MNTaskManager.getAllTaskCardsFromBoard is undefined
4. 今日看板刷新功能失效，看板里一直是空的！





--
请你分析几个按钮里单击、菜单里的功能，然后分析功能的合理性，在 guide 文件里加入你尽可能想到的基于这些功能合理的工作流。

然后再看看菜单里的功能，哪些没有实现？或者工作流过程中遇到了什么痛点？有的话去写新功能。
然后看看目前菜单的顺序，以及功能在这个菜单会不会有歧义，有没有问题之类的，进行综合分析！
ultrathink

---
开发一个新的按钮，能够快速启动任务。我的想法是：
1. 启动的任务怎么确定？
  - 目前就是默认按照今日看板进行中任务顺序，所以那个需要按照优先级之类的进行排序（不知道是不是已经是这样的了）
    - 我突然想到，今日看板需要支持我能手动修改排序，比如今天有好几个高优先级的，但是这几个仍然有个一个顺序，所以你看看我怎么样修改排序方便点？比如弹窗？这个需要你综合考察 mnai 和 mntoolbar 里开发的功能来看看能否从什么地方借鉴一下
    - 比如前面已经有高优先级的了，后面再加的话，默认放在高优先级组的后面，不然可能打乱手动排序的顺序
  - 然后单击后确定的卡片就是进行中的第一张
2. 启动的任务怎么处理？
  - 确定好卡片后，就是将这样卡片在浮窗中显示
3. 多选菜单
   1. 虽然单击支持自动选，但是还是加一个是通过弹窗来选择，你可以参考“今日”任务里筛选的效果，其实基于那个就可以，那个默认弹窗点击后是直接跳转，但我们这里是在浮窗跳转就行
   2. 之前加过快速更新“启动”链接的功能，这里也加一个

在上面的基础上，增加下面的处理：
1. “启动”链接的更新，需要支持剪切板里是卡片 ID 或者 URL 的，如果是的话，转化为 URL 格式替换旧链接。
2. 如果上面单击后确定的那张任务卡片的“启动”里的 URL 是卡片链接，而不是 uistate 的链接，那么直接定位这张卡，注意这里就不太一样了，如果是 uistate，那么就需要在浮窗中显示这张卡片的内容，如果是卡片链接，那么直接定位到这张卡片。

暂时我想到的就这么多，这个按钮的目的就是
1. 没进行任务的时候能够快速找到需要做的任务，然后我点击“启动”快速启动
2. 你看看还有没有别的探索可能性？至少我说的你要先实现  ultrathink

---
目前开发的按钮功能包括菜单里的，仍然有很多有问题！请你进行一遍详细的自查与修复 ultrathink

---
添加任务记录这些功能应该放在字段记录的那个按钮里，而不是任务状态切换的按钮 ultrathink


---
设置优先级功能出问题了，没有弹窗，而是直接加了 `<span id="subField" style="background:#FFF;color:#FF8C5A;border:2px solid currentColor;border-radius:3px;padding:6px 12px;font-size:0.9em;font-weight:600;box-shadow:0 1px 3px rgba(255,140,90,0.2);display:inline-block;">🔥 优先级: ⚪ undefined</span>` 请修复 ultrathink

---
过期任务功能现在很不完善！看板里虽然会增加有几个过期任务，但我看不到哪些过期了，“使用「处理过期任务」功能管理”，这个提示也没用啊，也没这个功能。

筛选的功能也有大问题，请你仔细重新检查。ultrathink

---
MNTask 里关于任务记录的几个功能，没几个能用的，要不就是点击没反应，请仔细检查！ ultrathink



---
我发现 MNTask 里用了 MNMath 的 toNoExcerptVersion 函数，并且很多次，但这个其实和 math 无关，我觉得要不就把 toNoExcerptVersion 函数的实现写到 mntask 里的辅助类里，避免对 MNMath 类有依赖，因为 MNMath 是扩展部分，不是官方原生的功能。ultrathink

---
重新完善一下按钮和菜单功能，支持单击和长按弹出菜单。感觉现在的太多太乱了。有很多内容只有个框架，先暂时去掉。把用到 MNTaskManager 和 TaskFieldUtils 的这些功能留着，其余没用到的先删除，不然现在菜单里东西太多，我不知道哪些已经开发了。ultrathink

---
请继续开发新功能：目前任务没有一个记录系统，类似于时间戳的那种，即使是动作任务可能也会有几步，所以需要一个记录系统来记录每个任务的完成情况，也就是类似于百分比的那种感觉，但是可以让用户记录每个步骤都做了什么，完成的怎么样，也类似于任务日志的东西


请学习一下 mnai 项目了解插件更多的处理可能性以及一些结合插件实现的操作， mnutils 项目学习基础 API。
然后我希望你思考

---
1. 自定义字段的添加优化一下，目前是默认加在`信息`字段的最下方。

默认制卡是加了`所属`，然后下方是`启动`，之后的新加就默认加在 `信息` 字段的下方，视觉上就是不断往上叠加，而不是从下面加入的。


2. 请学习 MNMath.manageCommentsByPopup 函数，解析字段内容，可以多选，然后进行移动和删除，mntask 里可以简单很多，因为没有 HtmlComment 类型的字段。只需要按照 id 那个来逐层解析，比如是先按 mainField 然后是 subField。
3. 至于如何获取新内容以及最后一个评论，这个暂时不要，目前就是
   - 选择字段
   - 多选
  然后类似地可以选择移动或删除。
4. 新功能加完了之后把这个写到按钮菜单里面。