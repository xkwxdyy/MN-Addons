<!DOCTYPE html>
<html>
<head>
    <title>我的计数器</title>
    <meta charset="UTF-8">
    <style>
        body {
            font-family: Arial;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            margin: 0;
            background-color: #f0f0f0;
        }
        
        .counter-container {
            background: white;
            padding: 40px;
            border-radius: 20px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
            text-align: center;
        }
        
        h1 {
            color: #333;
            margin-bottom: 30px;
        }
        
        .number-display {
            font-size: 72px;
            font-weight: bold;
            color: #007aff;
            margin: 30px 0;
            min-height: 100px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: transform 0.2s;
        }
        
        .button-group {
            display: flex;
            gap: 10px;
            justify-content: center;
        }
        
        button {
            padding: 15px 30px;
            font-size: 18px;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .btn-add {
            background-color: #4CAF50;
            color: white;
        }
        
        .btn-add:hover {
            background-color: #45a049;
            transform: translateY(-2px);
        }
        
        .btn-subtract {
            background-color: #f44336;
            color: white;
        }
        
        .btn-subtract:hover {
            background-color: #da190b;
            transform: translateY(-2px);
        }
        
        .btn-reset {
            background-color: #ff9800;
            color: white;
        }
        
        .btn-reset:hover {
            background-color: #e68900;
            transform: translateY(-2px);
        }
        
        .status {
            margin-top: 20px;
            padding: 10px;
            background-color: #e8f5e9;
            border-radius: 5px;
            color: #2e7d32;
            font-size: 14px;
            transition: background-color 0.5s;
        }
        
        /* 学习笔记样式 */
        .note {
            margin-top: 40px;
            padding: 20px;
            background-color: #fff9c4;
            border-radius: 10px;
            text-align: left;
            max-width: 500px;
            font-size: 14px;
            color: #666;
        }
        
        .note h3 {
            color: #f57c00;
            margin-top: 0;
        }
        
        .note code {
            background-color: #fff;
            padding: 2px 5px;
            border-radius: 3px;
            font-family: monospace;
        }
    </style>
</head>
<body>
    <div class="counter-container">
        <h1>🔢 超级计数器</h1>
        
        <div class="number-display" id="number">
            0
        </div>
        
        <div class="button-group">
            <button class="btn-subtract" onclick="subtract()">➖ 减一</button>
            <button class="btn-reset" onclick="reset()">🔄 重置</button>
            <button class="btn-add" onclick="add()">➕ 加一</button>
        </div>
        
        <div class="status" id="status">
            准备就绪
        </div>
        
        <div class="note">
            <h3>📚 学习笔记</h3>
            <p><strong>这个计数器展示了：</strong></p>
            <ul>
                <li>状态管理：数字保存在 <code>currentNumber</code> 变量中</li>
                <li>UI 更新：通过 <code>updateDisplay()</code> 更新界面</li>
                <li>插件通信：通过 <code>sendCommand()</code> 发送命令</li>
                <li>数据接收：<code>receiveData()</code> 处理插件返回的数据</li>
            </ul>
            <p>💡 <strong>提示：</strong>在控制台输入 <code>updateCounter(42)</code> 可以模拟插件更新数字！</p>
        </div>
    </div>
    
    <script>
        // =====================================
        // 🎯 计数器应用
        // 
        // 这是一个完整的计数器示例，展示了：
        // 1. 如何管理应用状态
        // 2. 如何与插件通信
        // 3. 如何更新用户界面
        // 4. 如何处理用户交互
        // =====================================
        
        // ==================== 状态管理 ====================
        let currentNumber = 0;  // 当前显示的数字
        
        // ==================== 显示更新 ====================
        
        // 更新数字显示
        function updateDisplay(number) {
            currentNumber = number;
            const display = document.getElementById('number');
            display.textContent = number;
            
            // 添加动画效果
            display.style.transform = 'scale(1.2)';
            setTimeout(() => {
                display.style.transform = 'scale(1)';
            }, 200);
            
            // 根据数字改变颜色
            if (number > 0) {
                display.style.color = '#4CAF50';  // 正数 - 绿色
            } else if (number < 0) {
                display.style.color = '#f44336';  // 负数 - 红色
            } else {
                display.style.color = '#007aff';  // 零 - 蓝色
            }
        }
        
        // 更新状态信息
        function updateStatus(message) {
            const status = document.getElementById('status');
            status.textContent = message;
            
            // 短暂高亮
            status.style.backgroundColor = '#ffeb3b';
            setTimeout(() => {
                status.style.backgroundColor = '#e8f5e9';
            }, 500);
        }
        
        // ==================== 与插件通信 ====================
        
        // 发送命令到插件
        function sendCommand(command, value = null) {
            // 构造 URL
            let url = `mntask://counter/${command}`;
            if (value !== null) {
                url += `?value=${value}`;
            }
            
            // 记录操作
            console.log('📤 发送命令:', url);
            updateStatus(`发送命令: ${command}`);
            
            // 发送
            window.location.href = url;
            
            // === 仅用于演示 ===
            // 在真实环境中，插件会处理命令并调用我们的函数
            // 这里我们模拟插件的响应
            setTimeout(() => {
                simulatePluginResponse(command);
            }, 300);
        }
        
        // 接收插件的数据
        function receiveData(data) {
            console.log('📥 收到数据:', data);
            
            if (data.number !== undefined) {
                updateDisplay(data.number);
                updateStatus('数据已更新');
            }
            
            if (data.message) {
                updateStatus(data.message);
            }
        }
        
        // ==================== 按钮操作 ====================
        
        // 加一
        function add() {
            console.log('🔼 执行加一操作');
            sendCommand('add');
        }
        
        // 减一
        function subtract() {
            console.log('🔽 执行减一操作');
            sendCommand('subtract');
        }
        
        // 重置
        function reset() {
            console.log('🔄 执行重置操作');
            if (currentNumber !== 0 && confirm('确定要重置为0吗？')) {
                sendCommand('reset');
            }
        }
        
        // ==================== 模拟插件响应 ====================
        // 注意：这部分代码仅用于演示
        // 在真实环境中，插件会执行这些操作
        
        function simulatePluginResponse(command) {
            let newNumber = currentNumber;
            let message = '';
            
            switch(command) {
                case 'add':
                    newNumber = currentNumber + 1;
                    message = '加一成功';
                    break;
                case 'subtract':
                    newNumber = currentNumber - 1;
                    message = '减一成功';
                    break;
                case 'reset':
                    newNumber = 0;
                    message = '已重置为零';
                    break;
                case 'getData':
                    message = '数据已加载';
                    break;
            }
            
            // 模拟插件调用我们的函数
            updateCounter(newNumber);
            
            // 或者使用完整数据格式
            // setCounterData(JSON.stringify({
            //     number: newNumber,
            //     message: message
            // }));
        }
        
        // ==================== 初始化 ====================
        
        // 页面加载完成后
        window.onload = function() {
            console.log('✅ 计数器页面加载完成');
            updateStatus('正在连接插件...');
            
            // 请求初始数据
            setTimeout(() => {
                sendCommand('getData');
            }, 100);
            
            // 显示欢迎信息
            console.log('=====================================');
            console.log('🎉 欢迎使用超级计数器！');
            console.log('💡 提示：');
            console.log('1. 点击按钮改变数字');
            console.log('2. 打开控制台查看通信日志');
            console.log('3. 输入 updateCounter(100) 测试更新');
            console.log('=====================================');
        };
        
        // ==================== 插件会调用的函数 ====================
        
        // 这个函数会被插件调用来更新数字
        window.updateCounter = function(number) {
            console.log('🔔 插件调用 updateCounter:', number);
            updateDisplay(number);
            updateStatus('计数器已更新');
        };
        
        // 这个函数会被插件调用来发送完整数据
        window.setCounterData = function(jsonString) {
            console.log('🔔 插件调用 setCounterData:', jsonString);
            try {
                const data = JSON.parse(jsonString);
                receiveData(data);
            } catch (error) {
                console.error('❌ 解析数据失败:', error);
                updateStatus('数据格式错误');
            }
        };
        
        // =====================================
        // 🎓 关键概念解释：
        // 
        // 1. 状态管理
        //    - currentNumber 保存当前数字
        //    - 所有操作都通过函数修改状态
        //    - 状态改变后更新界面
        // 
        // 2. 命令模式
        //    - 每个操作对应一个命令
        //    - 命令通过 URL Scheme 发送
        //    - 插件处理命令并返回结果
        // 
        // 3. 双向通信
        //    - 网页 → 插件：URL Scheme
        //    - 插件 → 网页：调用全局函数
        // 
        // 4. 错误处理
        //    - try-catch 处理 JSON 解析
        //    - 确认对话框防止误操作
        //    - 状态消息提供反馈
        // =====================================
    </script>
</body>
</html>