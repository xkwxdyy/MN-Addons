JSB.newAddon=function(t){try{JSB.require("mnutils"),MNUtil.init(t)}catch(t){subscriptionUtils.showHUD("Error when loading mnutils: "+t)}JSB.require("mnutils");try{JSB.require("CryptoJS")}catch(t){MNUtil.log("Error when loading CryptoJS: "+t)}try{JSB.require("marked")}catch(t){MNUtil.log("Error when loading marked: "+t)}try{JSB.require("highlight")}catch(t){MNUtil.log("Error when loading highlight: "+t)}try{JSB.require("mustache")}catch(t){MNUtil.log("Error when loading mustache: "+t)}return JSB.defineClass("MNSubscription : JSExtension",{sceneWillConnect:async function(){try{if(self.appInstance=Application.sharedInstance(),subscriptionConfig.init(),self.isNewWindow=!1,self.watchMode=!1,self.textSelected="",self.textProcessed=!1,self.dateGetText=Date.now(),self.dateNow=Date.now(),self.rect="{{0, 0}, {10, 10}}",self.arrow=1,self.isFirst=!0,MNUtil.addObserver(self,"onPopupMenuOnNote:","PopupMenuOnNote"),MNUtil.addObserver(self,"onPopupMenuOnSelection:","PopupMenuOnSelection"),MNUtil.addObserver(self,"onClosePopupMenuOnNote:","ClosePopupMenuOnNote"),MNUtil.addObserver(self,"onClosePopupMenuOnSelection:","ClosePopupMenuOnSelection"),MNUtil.addObserver(self,"onTextDidBeginEditing:","UITextViewTextDidBeginEditingNotification"),MNUtil.addObserver(self,"onTextDidEndEditing:","UITextViewTextDidEndEditingNotification"),await MNUtil.delay(.1),subscriptionUtils.checkSubscriptionController(),subscriptionUtils.ensureView(subscriptionUtils.subscriptionController.view),self.isFirst){var t=subscriptionConfig.getConfig("miniFrame"),i=subscriptionConfig.getConfig("customMode"),e=(subscriptionUtils.subscriptionController.view.frame=t,subscriptionConfig.getConfig("lastView")),o={};switch("log"===e?(o.width=500,o.height=500):(o.width=270,o.height=subscriptionConfig.frameHeight),o.x=t.x-.5*o.width,i){case"left":o.x=40,o.y=MNUtil.constrain(t.y,40,MNUtil.currentWindow.frame.height-o.height-40);break;case"top":o.y=40;break;case"right":o.x=MNUtil.currentWindow.frame.width-o.width-40,o.y=MNUtil.constrain(t.y,40,MNUtil.currentWindow.frame.height-o.height-40);break;case"bottom":o.x=MNUtil.constrain(t.x,40,MNUtil.currentWindow.frame.width-o.width-40),o.y=MNUtil.currentWindow.frame.height-o.height-40}subscriptionUtils.subscriptionController.lastFrame=o,subscriptionUtils.subscriptionController.currentFrame=subscriptionUtils.subscriptionController.view.frame,self.isFirst=!1}}catch(t){subscriptionUtils.addErrorLog(t,"sceneWillConnect")}},sceneDidDisconnect:function(){MNUtil.removeObserver(self,"PopupMenuOnNote"),MNUtil.removeObserver(self,"PopupMenuOnSelection"),MNUtil.removeObserver(self,"ClosePopupMenuOnNote"),MNUtil.removeObserver(self,"ClosePopupMenuOnSelection"),MNUtil.removeObserver(self,"UITextViewTextDidBeginEditingNotification"),MNUtil.removeObserver(self,"UITextViewTextDidEndEditingNotification")},onPopupMenuOnNote:function(t){var i;self.window===MNUtil.currentWindow&&(t=t.userInfo.note.noteId,i=Date.now(),MNUtil.popUpNoteInfo={time:i,noteId:t})},onClosePopupMenuOnNote:function(t){self.window===MNUtil.currentWindow&&MNUtil.popUpNoteInfo&&t.userInfo.noteid===MNUtil.popUpNoteInfo.noteId&&MNUtil.delay(1).then(()=>{MNUtil.popUpNoteInfo=void 0})},onPopupMenuOnSelection:function(t){var i;self.window===MNUtil.currentWindow&&(i=Date.now(),t=t.userInfo.documentController,MNUtil.popUpSelectionInfo={time:i,docController:t})},onClosePopupMenuOnSelection:async function(t){self.window===MNUtil.currentWindow&&(await MNUtil.delay(.01),MNUtil.popUpSelectionInfo)&&t.userInfo.documentController===MNUtil.popUpSelectionInfo.docController&&!t.userInfo.documentController.imageFromSelection()&&(MNUtil.popUpSelectionInfo=void 0)},onTextDidBeginEditing:function(t){self.window===MNUtil.currentWindow&&3!==MNUtil.studyMode&&(t=t.object,MNUtil.activeTextView=t)},onTextDidEndEditing:function(t){self.window===MNUtil.currentWindow&&3!==MNUtil.studyMode&&t.object===MNUtil.activeTextView&&(MNUtil.activeTextView=void 0)},sceneWillResignActive:function(){},sceneDidBecomeActive:function(){},notebookWillOpen:function(t){try{subscriptionUtils.refreshAddonCommands(),self.notebookid=t,subscriptionConfig.autoSubscribe()}catch(t){subscriptionUtils.addErrorLog(t,"notebookWillOpen")}},onCloudConfigChange:async function(t){MNUtil.postNotification("cloudConfigChange",t.userInfo)},notebookWillClose:function(t){},documentDidOpen:function(t){},documentWillClose:function(t){},controllerWillLayoutSubviews:function(t){if(t===MNUtil.studyController){t=subscriptionUtils.subscriptionController;if(!t.view.hidden){var i=MNUtil.currentWindow.bounds,e=t.currentFrame;if(e.x+.5*e.width>=i.width&&(e.x=i.width-.5*e.width),e.y>=i.height&&(e.y=i.height-20),t.miniMode){var o=subscriptionUtils.topOffset,s=subscriptionUtils.bottomOffset;switch(subscriptionConfig.getConfig("customMode")){case"left":0!==e.x&&(e.x=0),e.y=MNUtil.constrain(e.y,o,MNUtil.currentWindow.frame.height-40-s);break;case"top":e.y!==o&&(e.y=o),e.x=MNUtil.constrain(e.x,0,MNUtil.currentWindow.frame.width-40);break;case"right":e.x!==MNUtil.currentWindow.frame.width-40&&(e.x=MNUtil.currentWindow.frame.width-40),e.y=MNUtil.constrain(e.y,o,MNUtil.currentWindow.frame.height-40-s);break;case"bottom":e.y!==MNUtil.currentWindow.frame.height-40-s&&(e.y=MNUtil.currentWindow.frame.height-40-s),e.x=MNUtil.constrain(e.x,0,MNUtil.currentWindow.frame.width-40)}}t.view.frame=e,t.currentFrame=e}}},queryAddonCommandStatus:function(){return null},toggleAddon:async function(t){try{var i;subscriptionUtils.ensureView(subscriptionUtils.subscriptionController.view),self.addonBar||(self.addonBar=t.superview.superview,subscriptionUtils.addonBar=self.addonBar),self.isFirst&&(0===(i=self.addonBar.frame).x?subscriptionUtils.subscriptionController.view.frame={x:40,y:i.y,width:270,height:subscriptionConfig.frameHeight}:subscriptionUtils.subscriptionController.view.frame={x:i.x-270,y:i.y,width:270,height:subscriptionConfig.frameHeight},subscriptionUtils.subscriptionController.currentFrame=subscriptionUtils.subscriptionController.view.frame,self.isFirst=!1),subscriptionUtils.subscriptionController.view.hidden?subscriptionUtils.subscriptionController.show(self.addonBar.frame):subscriptionUtils.subscriptionController.hide(self.addonBar.frame)}catch(t){subscriptionUtils.showHUD(t)}}},{addonDidConnect:function(){subscriptionUtils.init(t),subscriptionUtils.subscriptionController&&(subscriptionUtils.subscriptionController.view.hidden=!1)},addonWillDisconnect:function(){subscriptionUtils.addonConnected=!1,subscriptionUtils.subscriptionController&&(subscriptionUtils.subscriptionController.view.hidden=!0)},applicationWillEnterForeground:async function(){subscriptionUtils.addonConnected&&MNUtil.currentNotebookId&&(await MNUtil.delay(.01),subscriptionConfig.autoSubscribe(!1))},applicationDidEnterBackground:function(){},applicationDidReceiveLocalNotification:function(t){}})};const getSubscriptionController=()=>self;var subscriptionController=JSB.defineClass("subscriptionController : UIViewController <NSURLConnectionDelegate,UIWebViewDelegate>",{viewDidLoad:function(){try{self.custom=!1,self.dynamic=!0,self.miniMode=!0,self.isLoading=!1,self.lastFrame=self.view.frame,self.currentFrame=self.view.frame,self.color=["#ffffb4","#ccfdc4","#b4d1fb","#f3aebe","#ffff54","#75fb4c","#55bbf9","#ea3323","#ef8733","#377e47","#173dac","#be3223","#ffffff","#dadada","#b4b4b4","#bd9fdc"],self.mode=0,self.moveDate=Date.now(),self.init(),subscriptionConfig.save()}catch(t){subscriptionUtils.showHUD("Error in viewDidLoad: "+t)}},viewWillAppear:t=>{},viewWillDisappear:t=>{},viewWillLayoutSubviews:()=>{self.layoutSubviews()},connectionDidReceiveResponse:async function(t,i){self.statusCode=i.statusCode(),400<=self.statusCode?(MNUtil.stopHUD(),MNUtil.showHUD(MNUtil.getStatusCodeDescription(""+self.statusCode))):(self.onDownloading=!0,self.currentData=NSMutableData.new(),self.expectedContentLength=i.expectedContentLength())},connectionDidReceiveData:async function(t,i){try{400<=self.statusCode?self.onDownloading=!1:(self.currentData.appendData(i),self.waitHUD("Downloading: "+(self.currentData.length()/self.expectedContentLength*100).toFixed(2)+"%"))}catch(t){subscriptionUtils.addErrorLog(t,"connectionDidReceiveData")}},connectionDidFinishLoading:async function(t){try{if(self.onDownloading=!1,!(400<=self.statusCode)){if(self.targetPath)switch(self.currentData.writeToFileAtomically(self.targetPath,!1),self.fileType){case"document":var i=MNUtil.getFileName(self.targetPath),e=MNUtil.importDocument(self.targetPath);MNUtil.currentNotebookId&&await MNUtil.confirm("Open document?","是否打开该文档？\n"+i)&&MNUtil.openDoc(e,MNUtil.currentNotebookId);break;case"notebook":(self.targetPath.endsWith(".marginpkg")||self.targetPath.endsWith(".marginnotes"))&&subscriptionUtils.importNotebook(self.targetPath,self.folder,self.notebookId);break;case"mnaddon":ZipArchive.unzipFileAtPathToDestination(self.targetPath,self.addonPath),MNUtil.waitHUD("Install success! Please restart MN manually")}MNUtil.delay(1).then(()=>{MNUtil.stopHUD()})}}catch(t){MNUtil.stopHUD(),subscriptionUtils.addErrorLog(t,"connectionDidFinishLoading")}},connectionDidFailWithError:function(t,i){self.onDownloading=!1,self.showHUD("connectionDidFailWithError")},webViewDidFinishLoad:async function(t){var i=getSubscriptionController();if(!t.sidebar){MNUtil.stopHUD();var e=t.request.URL().absoluteString();if(/^https\:\/\/afdian.com\/message\//.test(e)||/^https\:\/\/ifdian.net\/message\//.test(e))return await MNUtil.delay(1),(t=await i.getApikeyFromWebview(t))?void(await MNUtil.confirm("Subscribe via APIKey below?","是否使用以下APIKey订阅?\n"+t)&&(i.apikeyInput.text=t,i.apikeyInput.editable=!0,MNButton.setColor(i.showAPIKeyButton,"#e06c75"),subscriptionUtils.showHUD("Save APIKey"),subscriptionConfig.save(),i.activate())):void 0;e.startsWith("https://ifdian.net/order/create")}},webViewShouldStartLoadWithRequestNavigationType:function(t,i,e){let s=getSubscriptionController(),n=i.URL().absoluteString(),o=subscriptionUtils.getFileNameFromUrl(n);if(o&&(o.endsWith(".marginnotes")||o.endsWith(".marginpkg"))&&MNUtil.confirm("Should download this notebook?","是否下载该学习集？\n"+o).then(async t=>{var i;t&&(s.waitHUD("Downloading..."),t=subscriptionUtils.mainPath+"/"+o,i=MNConnection.requestWithURL(n),NSURLConnection.connectionWithRequestDelegate(i,s),s.targetPath=t,s.folder=subscriptionUtils.mainPath+"/download")}),/^nativecopy\:\/\//.test(n))return i=decodeURIComponent(n.split("content=")[1]),MNUtil.copy(i),!1;if(/^https?\:\/\/.*\.mnaddon$/.test(n)){let o=MNUtil.getFileName(n);return MNUtil.confirm("Install mnaddon: "+o+"?","安装插件: "+o+"？").then(async t=>{var i,e;t&&(s.waitHUD("Download: "+o),t=subscriptionUtils.mainPath+"/"+o,(await MNConnection.fetch(n)).writeToFileAtomically(t,!1),s.waitHUD("Get addonid..."),ZipArchive.unzipFileAtPathToDestination(t,subscriptionUtils.mainPath+"/temp"),i=MNUtil.readJSON(subscriptionUtils.mainPath+"/temp/mnaddon.json"))&&"addonid"in i&&(e=subscriptionUtils.extensionPath+"/"+i.addonid,ZipArchive.unzipFileAtPathToDestination(t,e),s.showHUD(`Install mnaddon [${i.title}] success! Please restart MN manually`))}),!1}if(t.sidebar&&/^https?\:\/\//.test(n))return s.docview.hidden&&((i=s.view.frame).width=800,i.height<500&&(i.height=500),i.x=MNUtil.constrain(s.view.frame.x,40,MNUtil.currentWindow.frame.width-i.width-40),s.view.frame=i,s.currentFrame=i,s.view.setNeedsLayout()),650<s.view.frame.width&&(s.waitHUD("Previewing Document...",s.docview),MNConnection.loadRequest(s.docview,n)),!1;if(/^mnaddon\:\/\//.test(n)){if(s.onDownloading)s.showHUD("Wait...");else{var r=decodeURIComponent(n).split("action=")[1].split("?");let e={action:r[0]};for(let t=1;t<r.length;t++){var a=r[t].split("=");e[a[0]]=a[1]}if("importDocument"===(e=subscriptionConfig.mnaddon.filter(t=>t.id===e.id)[0]).action)s.waitHUD("Importing document..."),subscriptionNetwork.downloadFromConfig(e,s),MNUtil.log({level:"info",message:"Import document: "+e.name});else if("importNotebook"===e.action)s.waitHUD("Importing notebook..."),subscriptionNetwork.downloadFromConfig(e,s),MNUtil.log({level:"info",message:"Import notebook: "+e.name});else if("install"===e.action||"update"===e.action)subscriptionNetwork.downloadFromConfig(e,s),MNUtil.log({level:"info",message:"Install addon: "+e.name+" "+e.version});else if("reinstall"===e.action)if("history"in e){let i=e.history.map(t=>t.version);MNUtil.userSelect("Choose a history version","选择历史版本",i).then(t=>{t&&(t=i[t-1],e.version=t,subscriptionNetwork.downloadFromConfig(e,s),MNUtil.log({level:"info",message:"Install addon: "+e.name+" "+e.version}))})}else MNUtil.confirm("Re-install this addon?","重新安装该插件？").then(async t=>{t&&(subscriptionNetwork.downloadFromConfig(e,s),MNUtil.log({level:"info",message:"Install addon: "+e.name+" "+e.version}))})}return!1}return!0},scrollViewDidScroll:function(){},chooseAPIKeyForQuota:async function(){var t,i=getSubscriptionController(),e=subscriptionConfig.getConfig("apikey").trim();let o="newAPIKey",s,n;if(e)switch(s=await MNUtil.userSelect("Select Action\n选择操作","",["New Key / 新的Key","Recharge / 充值"])){case 0:return;case 1:o="newAPIKey";break;case 2:o="rechargeAPIKey";break;default:return}if("newAPIKey"===o)s=await MNUtil.userSelect("Select APIKey for quota","选择要购买的额度",["5 Points (5¥)","10 Points (9.5¥)","20 Points (19¥)","50 Points (45¥)"]),n=["https://ifdian.net/order/create?product_type=1&plan_id=a6ed8b60fbcf11ee941152540025c377&sku=%5B%7B%22sku_id%22:%22b24e214cfd3f11eebc335254001e7c00%22,%22count%22:1%7D%5D","https://ifdian.net/order/create?product_type=1&plan_id=a6ed8b60fbcf11ee941152540025c377&sku=%5B%7B%22sku_id%22:%22a58e5502146f11efa4fa5254001e7c00%22,%22count%22:1%7D%5D","https://ifdian.net/order/create?product_type=1&plan_id=a6ed8b60fbcf11ee941152540025c377&sku=%5B%7B%22sku_id%22:%2279e3e74a147011efb46e52540025c377%22,%22count%22:1%7D%5D","https://ifdian.net/order/create?product_type=1&plan_id=a6ed8b60fbcf11ee941152540025c377&sku=%5B%7B%22sku_id%22%3A%22e87e8a7432f811efaa1552540025c377%22,%22count%22%3A1%7D%5D"];else if(s=await MNUtil.userSelect("Choose the recharge quota","选择要增加的额度\n(充值到账有数小时延迟)",["5 Points (5¥)","10 Points (9.5¥)","20 Points (19¥)","50 Points (45¥)"]),n=["https://ifdian.net/order/create?product_type=1&plan_id=f52724aa464611ef8acc52540025c377&sku=%5B%7B%22sku_id%22:%22f52fdfc8464611efbe3052540025c377%22,%22count%22:1%7D%5D","https://ifdian.net/order/create?product_type=1&plan_id=f52724aa464611ef8acc52540025c377&sku=%5B%7B%22sku_id%22:%22a077cf88557611efb1785254001e7c00%22,%22count%22:1%7D%5D","https://ifdian.net/order/create?product_type=1&plan_id=f52724aa464611ef8acc52540025c377&sku=%5B%7B%22sku_id%22:%22a0831816557611ef8fb05254001e7c00%22,%22count%22:1%7D%5D","https://ifdian.net/order/create?product_type=1&plan_id=f52724aa464611ef8acc52540025c377&sku=%5B%7B%22sku_id%22:%22ba4c466e557611ef80c852540025c377%22,%22count%22:1%7D%5D"],0===s)return;switch(i.docview.customUserAgent="Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_6) AppleWebKit/605.1.15 (KHTML, like Gecko) Version/16.0 Safari/605.1.15",s){case 0:return;case 1:MNConnection.loadRequest(i.docview,n[0]+"&remark="+e);break;case 2:MNConnection.loadRequest(i.docview,n[1]+"&remark="+e);break;case 3:MNConnection.loadRequest(i.docview,n[2]+"&remark="+e);break;case 4:MNConnection.loadRequest(i.docview,n[3]+"&remark="+e);break;default:return}i.docview.hidden&&((t=i.view.frame).width=650,t.height<500&&(t.height=500),i.view.frame=t,i.currentFrame=t,i.view.setNeedsLayout())},showHelper:async function(t){var i;MNConnection.loadRequest(self.docview,"https://mnaddon.craft.me/utilsQuestion"),MNUtil.showHUD("Loading..."),self.docview.hidden&&((i=self.view.frame).width=650,i.height<500&&(i.height=500),self.view.frame=i,self.currentFrame=i,self.view.setNeedsLayout())},chooseQuota:async function(){var t=getSubscriptionController(),i=subscriptionConfig.getConfig("apikey").trim();if(i){var e=await MNUtil.userSelect("Choose the recharge quota","选择要增加的额度\n(充值到账有数小时延迟)",["5 Points (5¥)","10 Points (9.5¥)","20 Points (19¥)","50 Points (45¥)"]),o=["https://ifdian.net/order/create?product_type=1&plan_id=f52724aa464611ef8acc52540025c377&sku=%5B%7B%22sku_id%22:%22f52fdfc8464611efbe3052540025c377%22,%22count%22:1%7D%5D","https://ifdian.net/order/create?product_type=1&plan_id=f52724aa464611ef8acc52540025c377&sku=%5B%7B%22sku_id%22:%22a077cf88557611efb1785254001e7c00%22,%22count%22:1%7D%5D","https://ifdian.net/order/create?product_type=1&plan_id=f52724aa464611ef8acc52540025c377&sku=%5B%7B%22sku_id%22:%22a0831816557611ef8fb05254001e7c00%22,%22count%22:1%7D%5D","https://ifdian.net/order/create?product_type=1&plan_id=f52724aa464611ef8acc52540025c377&sku=%5B%7B%22sku_id%22:%22ba4c466e557611ef80c852540025c377%22,%22count%22:1%7D%5D"];switch(t.docview.customUserAgent="Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_6) AppleWebKit/605.1.15 (KHTML, like Gecko) Version/16.0 Safari/605.1.15",e){case 0:return;case 1:MNConnection.loadRequest(t.docview,o[0]+"&remark="+i);break;case 2:MNConnection.loadRequest(t.docview,o[1]+"&remark="+i);break;case 3:MNConnection.loadRequest(t.docview,o[2]+"&remark="+i);break;case 4:MNConnection.loadRequest(t.docview,o[3]+"&remark="+i);break;default:return}t.docview.hidden&&((e=t.view.frame).width=650,e.height<500&&(e.height=500),t.view.frame=e,t.currentFrame=e,t.view.setNeedsLayout())}else t.showHUD("No APIKey")},openURL:function(t){var i;self.docview.hidden&&((i=self.view.frame).width=650,self.view.frame=i,self.currentFrame=i,self.view.setNeedsLayout()),self.docview.customUserAgent="Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_6) AppleWebKit/605.1.15 (KHTML, like Gecko) Version/16.0 Safari/605.1.15",self.showHUD("Open url..."),MNConnection.loadRequest(self.docview,t.url)},changeURL:function(t){self.popoverController&&self.popoverController.dismissPopoverAnimated(!0);var i=subscriptionConfig.getConfig("url"),e="changeURLTo:",e=[MNUtil.tableItem("URL1 (default)",self,e,"https://api.feliks.top","https://api.feliks.top"===i),MNUtil.tableItem("URL2",self,e,"https://api1.feliks.top","https://api1.feliks.top"===i),MNUtil.tableItem("URL3",self,e,"https://alpha.u1162561.nyat.app:20075","https://alpha.u1162561.nyat.app:20075"===i),MNUtil.tableItem("URL4",self,e,"https://api.u1162561.nyat.app:20074","https://api.u1162561.nyat.app:20074"===i)];self.popoverController=MNUtil.getPopoverAndPresent(t,e,200,2)},changeURLTo:function(t){self.popoverController&&self.popoverController.dismissPopoverAnimated(!0),subscriptionConfig.config.url=t,subscriptionConfig.save(),self.URLButton.setTitleForState(subscriptionUtils.getURLTitle(),0)},changeView:function(t){let e=getSubscriptionController();if(e.miniMode){let i="#457bd3";e.view.layer.backgroundColor=MNUtil.hexColorAlpha(i,.8),e.moveButton.setImageForState(void 0,0),void MNUtil.animate(()=>{e.setFrame(e.lastFrame);var t=e.view.bounds.width;e.moveButton.setFrame(35,0,t-70,25),MNButton.setColor(e.moveButton,i)},.25).then(()=>{e.miniMode=!1,e.showAllButton(),e.view.setNeedsLayout(),e.view.layer.backgroundColor=MNUtil.hexColorAlpha(i,0),e.refresh()})}else{Menu.dismissCurrentMenu(),e.popoverController&&e.popoverController.dismissPopoverAnimated(!0);var i=subscriptionConfig.getConfig("lastView"),t=new Menu(t,e);t.width=250,t.rowHeight=35,t.preferredPosition=1,t.addMenuItem("💲  Subscription Manager","setViewTo:","subscriptionView","subscriptionView"===i),t.addMenuItem("🎛️  Update Manager","setViewTo:","webview","webview"===i),t.addMenuItem("🎛️  Update Manager (α)","setViewTo:","webviewAlpha","webviewAlpha"===i),t.addMenuItem("📔  Shared Notebooks","setViewTo:","shareNotebooks","shareNotebooks"===i),t.addMenuItem("📄  Shared Documents","setViewTo:","shareDocuments","shareDocuments"===i),t.addMenuItem("🎛️  MNAddon Panel","showPanel:","setting","setting"===i),t.addMenuItem("🔨  Log Viewer","setViewTo:","log","log"===i),t.addMenuItem("🗺️  Update Roadmap","setViewTo:","roadmap","roadmap"===i),t.addMenuItem("🗺️  Feedback","setViewTo:","feedback","feedback"===i),t.addMenuItem("❌  Force to Crash","force2Crash:","sidebar","sidebar"===i),t.show()}},setViewTo:async function(t){var i=getSubscriptionController();try{switch(Menu.dismissCurrentMenu(),t){case"subscriptionView":i.subscriptionView.hidden=!1,i.webview.hidden=!0,MNButton.setTitle(i.moveButton,"Subscription Manager",void 0,!0),subscriptionConfig.config.lastView="subscriptionView";break;case"shareNotebooks":i.subscriptionView.hidden=!0,i.webview.hidden=!1,MNButton.setTitle(i.moveButton,"Shared Notebooks",void 0,!0),i.webview.loadFileURLAllowingReadAccessToURL(NSURL.fileURLWithPath(subscriptionUtils.mainPath+"/sidebar.html"),NSURL.fileURLWithPath(subscriptionUtils.mainPath+"/")),i.refreshSidebar(!0,"shareNotebooks"),subscriptionConfig.config.lastView="shareNotebooks";break;case"shareDocuments":i.subscriptionView.hidden=!0,i.webview.hidden=!1,MNButton.setTitle(i.moveButton,"Shared Documents",void 0,!0),i.webview.loadFileURLAllowingReadAccessToURL(NSURL.fileURLWithPath(subscriptionUtils.mainPath+"/sidebar.html"),NSURL.fileURLWithPath(subscriptionUtils.mainPath+"/")),i.refreshSidebar(!0,"shareDocuments"),subscriptionConfig.config.lastView="shareDocuments";break;case"webview":i.subscriptionView.hidden=!0,i.webview.hidden=!1,MNButton.setTitle(i.moveButton,"Update Manager",void 0,!0),i.webview.loadFileURLAllowingReadAccessToURL(NSURL.fileURLWithPath(subscriptionUtils.mainPath+"/sidebar.html"),NSURL.fileURLWithPath(subscriptionUtils.mainPath+"/")),i.refreshSidebar(!0,"webview"),subscriptionConfig.config.lastView="webview";break;case"webviewAlpha":i.subscriptionView.hidden=!0,i.webview.hidden=!1,MNButton.setTitle(i.moveButton,"Update Manager (α)",void 0,!0),i.webview.loadFileURLAllowingReadAccessToURL(NSURL.fileURLWithPath(subscriptionUtils.mainPath+"/sidebar.html"),NSURL.fileURLWithPath(subscriptionUtils.mainPath+"/")),i.refreshSidebar(!0,"webviewAlpha"),subscriptionConfig.config.lastView="webviewAlpha";break;case"QQGruop":MNConnection.loadRequest(i.docview,"https://qm.qq.com/q/nuwBBTCwpi",!1);break;case"roadmap":MNUtil.postNotification("openInBrowser",{url:"https://mnaddon.craft.me/roadmap"});break;case"feedback":MNUtil.postNotification("openInBrowser",{url:"https://s.craft.me/D9f5zVkfItscTP"});break;case"log":i.subscriptionView.hidden=!0,i.webview.hidden=!1,MNButton.setTitle(i.moveButton,"Log Viewer",void 0,!0),i.webview.loadFileURLAllowingReadAccessToURL(NSURL.fileURLWithPath(subscriptionUtils.mainPath+"/log.html"),NSURL.fileURLWithPath(subscriptionUtils.mainPath+"/")),subscriptionConfig.config.lastView="log";var e=i.view.frame;e.width<500&&(e.width=500),e.height<500&&(e.height=500),i.view.frame=e,i.currentFrame=e,i.view.setNeedsLayout(),await MNUtil.delay(.5),i.showLog(MNUtil.logs)}subscriptionConfig.save(),i.view.setNeedsLayout()}catch(t){MNUtil.showHUD(t)}},force2Crash:function(t){MNUtil.studyView.frame={x:void 0}},showPanel:function(t){Menu.dismissCurrentMenu(),"sidebar"===t?MNExtensionPanel.toggle():(self.blur(),MNUtil.excuteCommand("OpenExtensions"))},pasteApiKey:async function(t){var i=MNUtil.clipboardText.trim();i.startsWith("sk-")?(MNButton.setColor(self.showAPIKeyButton,"#e06c75"),self.apikeyInput.text=i,self.apikeyInput.editable=!0,subscriptionUtils.showHUD("Save APIKey"),subscriptionConfig.save(),await MNUtil.confirm("Activate now?","现在激活?")&&self.activate()):MNUtil.confirm("Invalid APIKey","无效的APIKey\n应为sk-xxxxxx")},toggleApikey:function(t){var i;self.apikeyInput.text&&self.apikeyInput.text.trim()?(self.apikeyInput.text="",self.apikeyInput.editable=!1,MNButton.setColor(self.showAPIKeyButton,"#a2a2a2")):(self.apikeyInput.editable=!0,subscriptionConfig.config.apikey.trim()?(i=subscriptionConfig.getConfig("apikey").trim(),self.apikeyInput.text=i,self.showAPIKeyButton.color="#e06c75",MNUtil.copy(i),MNUtil.showHUD("APIKey 已复制")):(self.showAPIKeyButton.color="#a2a2a2",MNUtil.showHUD("No APIKey")))},refreshUsage:async function(t){var i=getSubscriptionController(),e=(subscriptionUtils.showHUD("Fetching usage"),await subscriptionNetwork.getUsage());"error"in e?i.usageButton.setTitleForState(e.error,0):i.usageButton.setTitleForState(`Usage: ${(e.usage/100).toFixed(2)} / `+e.total.toFixed(2),0)},showDetail:async function(t){self.docview.hidden&&((i=self.view.frame).width=650,self.view.frame=i,self.currentFrame=i,self.view.setNeedsLayout());var i=subscriptionConfig.getConfig("apikey").trim();i?(self.showHUD("Loading..."),self.docview.loadFileURLAllowingReadAccessToURL(NSURL.fileURLWithPath(subscriptionUtils.mainPath+"/usage.html"),NSURL.fileURLWithPath(subscriptionUtils.mainPath+"/")),await MNUtil.delay(.5),self.runJavaScript(`window.fetchData("${subscriptionConfig.getConfig("apikey")}","${subscriptionConfig.getConfig("url")}")`,"docview")):self.showHUD("No APIKey")},chooseActivateDays:function(t){var i;self.popoverController&&self.popoverController.dismissPopoverAnimated(!0),!subscriptionConfig.config.activated&&subscriptionConfig.config.subscriptionDaysRemain||!subscriptionConfig.isSubscribed()&&subscriptionConfig.config.subscriptionDaysRemain?(subscriptionConfig.config.activated=!0,subscriptionConfig.config.subscribedDay=subscriptionUtils.getToday(),subscriptionConfig.config.subscriptionDaysRemain=subscriptionConfig.config.subscriptionDaysRemain-1,subscriptionConfig.save(),subscriptionUtils.refreshAddonCommands(),self.activationStatus.setTitleForState(subscriptionConfig.getStatus(),0),subscriptionUtils.showHUD("Subscription days remian: "+subscriptionConfig.config.subscriptionDaysRemain)):(i="activate:",i=[MNUtil.tableItem("1 day",self,i,1),MNUtil.tableItem("5 days",self,i,5),MNUtil.tableItem("10 days",self,i,10),MNUtil.tableItem("15 days",self,i,15),MNUtil.tableItem("20 days",self,i,20),MNUtil.tableItem("25 days",self,i,25),MNUtil.tableItem("30 days",self,i,30)],self.popoverController=MNUtil.getPopoverAndPresent(t,i,100,1))},activate:async function(t=1){self.popoverController&&self.popoverController.dismissPopoverAnimated(!0);var i=self.apikeyInput.text.trim();if((i&&(subscriptionConfig.config.apikey=i),10<=t)&&!await MNUtil.confirm(`You'll be charged $${.1*t} for a ${t}-day subscription. Please confirm`,`订阅${t}天会扣除${.1*t}$额度. 请确认`))return;(await subscriptionNetwork.subscribe(t)).success?"error"in(i=await subscriptionNetwork.getUsage())?self.usageButton.setTitleForState(i.error,0):self.usageButton.setTitleForState(`Usage: ${(i.usage/100).toFixed(2)} / `+i.total.toFixed(2),0):(self.autoSubscription.setTitleForState(subscriptionConfig.config.autoSubscription?"Auto subscription: ✅":"Auto subscription: ❌",0),subscriptionConfig.save())},toggleAutoSubscription:async function(t){try{var i=subscriptionConfig.getConfig("autoSubscription");subscriptionConfig.config.autoSubscription=!i,subscriptionConfig.save(),self.autoSubscription.setTitleForState(subscriptionConfig.config.autoSubscription?"Auto subscription: ✅":"Auto subscription: ❌",0)}catch(t){subscriptionUtils.showHUD(t)}},changeOpacity:function(t){self.popoverController&&self.popoverController.dismissPopoverAnimated(!0);var i=[{title:"100%",object:self,selector:"changeOpacityTo:",param:1},{title:"90%",object:self,selector:"changeOpacityTo:",param:.9},{title:"80%",object:self,selector:"changeOpacityTo:",param:.8},{title:"70%",object:self,selector:"changeOpacityTo:",param:.7},{title:"60%",object:self,selector:"changeOpacityTo:",param:.6},{title:"50%",object:self,selector:"changeOpacityTo:",param:.5}];self.popoverController=subscriptionUtils.getPopoverAndPresent(t,i,100)},changeOpacityTo:function(t){self.view.layer.opacity=t},closeButtonTapped:async function(){self.toMinimode(!0),self.blur()},refreshButtonTapped:async function(t){let i=getSubscriptionController();var e,o=subscriptionConfig.getConfig("lastView");"subscriptionView"==o?"error"in(e=await subscriptionNetwork.getUsage())?i.usageButton.setTitleForState(e.error,0):i.usageButton.setTitleForState(`Usage: ${(e.usage/100).toFixed(2)} / `+e.total.toFixed(2),0):"log"==o?i.clearLogs():t.clickDate&&Date.now()-t.clickDate<500?(i.webview.loadFileURLAllowingReadAccessToURL(NSURL.fileURLWithPath(subscriptionUtils.mainPath+"/sidebar.html"),NSURL.fileURLWithPath(subscriptionUtils.mainPath+"/")),MNUtil.delay(.5).then(()=>{i.refreshSidebar(!1,subscriptionConfig.getConfig("lastView"))})):(i.refreshSidebar(!0,subscriptionConfig.getConfig("lastView")),t.clickDate=Date.now())},onMoveGesture:function(i){try{let t=self.view.frame;var e,o,s,n,r,a;if(1===i.state)e=i.translationInView(i.view),o=i.locationInView(MNUtil.currentWindow),self.base=MNUtil.genFrame(t.x-o.x+e.x,t.y-o.y+e.y,t.width,t.height);else if(2===i.state&&(s=MNUtil.currentWindow.bounds,n=i.locationInView(MNUtil.currentWindow),r=MNUtil.constrain(self.base.y+n.y,0,s.height-15),a=self.base.x+n.x,self.view.frame=MNUtil.genFrame(a,r,self.base.width,self.base.height),self.currentFrame=self.view.frame,self.custom=!1),3===i.state&&self.miniMode){var c=subscriptionUtils.topOffset,l=subscriptionUtils.bottomOffset;let e={left:t.x,right:MNUtil.currentWindow.frame.width-t.x-t.width,top:t.y-c,bottom:MNUtil.currentWindow.frame.height-t.y-t.height-l};switch(Object.keys(e).reduce((t,i)=>e[t]<e[i]?t:i)){case"left":t.x=0,subscriptionConfig.config.customMode="left";break;case"right":t.x=MNUtil.currentWindow.frame.width-t.width,subscriptionConfig.config.customMode="right";break;case"top":t.y=c,subscriptionConfig.config.customMode="top";break;case"bottom":t.y=MNUtil.currentWindow.frame.height-t.height-l,subscriptionConfig.config.customMode="bottom"}self.onAnimate=!0,MNUtil.animate(()=>{self.view.frame=t,self.currentFrame=self.view.frame,self.custom=!1}).then(()=>{self.onAnimate=!1,subscriptionConfig.config.miniFrame=t,subscriptionConfig.save()})}}catch(t){subscriptionUtils.addErrorLog(t,"onMoveGesture")}},onResizeGesture0:function(t){self.custom=!1;var i=t.view.frame,e=t.locationInView(self.view),o=self.view.frame;let s=e.x+.5*i.width;e=self.view.frame.height;s<=270&&(s=270),self.view.frame={x:o.x,y:o.y,width:s,height:e},self.currentFrame=self.view.frame,3===t.state&&MNUtil.currentWindow.bringSubviewToFront(self.view)},onResizeGesture:function(t){self.custom=!1,self.dynamic=!1;var i=t.view.frame,e=t.locationInView(t.view),o=self.view.frame;let s=e.x+i.x+.3*i.width,n=e.y+i.y+.3*i.height;s<=270&&(s=270),n<=subscriptionConfig.frameHeight&&(n=subscriptionConfig.frameHeight),self.view.frame={x:o.x,y:o.y,width:s,height:n},self.currentFrame=self.view.frame,3===t.state&&MNUtil.currentWindow.bringSubviewToFront(self.view)},onLongPress:async function(t){if(1===t.state){var o=getSubscriptionController(),t=t.view;if(t.url)MNUtil.openURL(t.url);else if("chooseAPIKeyForQuota"===t.id){let t="newAPIKey",i,e;if(subscriptionConfig.getConfig("apikey").trim())switch(i=await MNUtil.userSelect("Select Action (Open In Browser)\n选择操作 (在外部浏览器打开)","",["New Key / 新的Key","Recharge / 充值"])){case 0:return;case 1:t="newAPIKey";break;case 2:t="rechargeAPIKey";break;default:return}switch("newAPIKey"===t?(i=await MNUtil.userSelect("Select APIKey for quota","选择要购买的额度",["5 Points (5¥)","10 Points (9.5¥)","20 Points (19¥)","50 Points (45¥)"]),e=["https://ifdian.net/order/create?product_type=1&plan_id=a6ed8b60fbcf11ee941152540025c377&sku=%5B%7B%22sku_id%22:%22b24e214cfd3f11eebc335254001e7c00%22,%22count%22:1%7D%5D","https://ifdian.net/order/create?product_type=1&plan_id=a6ed8b60fbcf11ee941152540025c377&sku=%5B%7B%22sku_id%22:%22a58e5502146f11efa4fa5254001e7c00%22,%22count%22:1%7D%5D","https://ifdian.net/order/create?product_type=1&plan_id=a6ed8b60fbcf11ee941152540025c377&sku=%5B%7B%22sku_id%22:%2279e3e74a147011efb46e52540025c377%22,%22count%22:1%7D%5D","https://ifdian.net/order/create?product_type=1&plan_id=a6ed8b60fbcf11ee941152540025c377&sku=%5B%7B%22sku_id%22%3A%22e87e8a7432f811efaa1552540025c377%22,%22count%22%3A1%7D%5D"]):(i=await MNUtil.userSelect("Choose the recharge quota","选择要增加的额度\n(充值到账有数小时延迟)",["5 Points (5¥)","10 Points (9.5¥)","20 Points (19¥)","50 Points (45¥)"]),e=["https://ifdian.net/order/create?product_type=1&plan_id=f52724aa464611ef8acc52540025c377&sku=%5B%7B%22sku_id%22:%22f52fdfc8464611efbe3052540025c377%22,%22count%22:1%7D%5D","https://ifdian.net/order/create?product_type=1&plan_id=f52724aa464611ef8acc52540025c377&sku=%5B%7B%22sku_id%22:%22a077cf88557611efb1785254001e7c00%22,%22count%22:1%7D%5D","https://ifdian.net/order/create?product_type=1&plan_id=f52724aa464611ef8acc52540025c377&sku=%5B%7B%22sku_id%22:%22a0831816557611ef8fb05254001e7c00%22,%22count%22:1%7D%5D","https://ifdian.net/order/create?product_type=1&plan_id=f52724aa464611ef8acc52540025c377&sku=%5B%7B%22sku_id%22:%22ba4c466e557611ef80c852540025c377%22,%22count%22:1%7D%5D"],MNUtil.copy(subscriptionConfig.getConfig("apikey")),MNUtil.showHUD("APIKey 已复制,请在充值时填写")),o.docview.customUserAgent="Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_6) AppleWebKit/605.1.15 (KHTML, like Gecko) Version/16.0 Safari/605.1.15",i){case 0:return;case 1:MNUtil.openURL(e[0]);break;case 2:MNUtil.openURL(e[1]);break;case 3:MNUtil.openURL(e[2]);break;case 4:MNUtil.openURL(e[3]);break;default:return}}}}});function tryCatch(i){return function(...t){try{return i(...t)}catch(t){return MNUtil.showHUD(t),null}}}subscriptionController.prototype.refresh=async function(){switch(subscriptionConfig.getConfig("lastView")){case"subscriptionView":this.subscriptionView.hidden=!1,this.webview.hidden=!0,this.moveButton.setTitle("Subscription Manager"),subscriptionConfig.config.lastView="subscriptionView";break;case"webview":this.subscriptionView.hidden=!0,this.webview.hidden=!1,this.moveButton.setTitle("Update Manager"),MNUtil.delay(.5).then(()=>{this.refreshSidebar(!0,"webview")}),subscriptionConfig.config.lastView="webview";break;case"webviewAlpha":this.subscriptionView.hidden=!0,this.webview.hidden=!1,this.moveButton.setTitle("Update Manager (α)"),MNUtil.delay(.5).then(()=>{this.refreshSidebar(!0,"webviewAlpha")}),subscriptionConfig.config.lastView="webviewAlpha";break;case"shareNotebooks":this.subscriptionView.hidden=!0,this.webview.hidden=!1,this.moveButton.setTitle("Shared Notebooks"),MNUtil.delay(.5).then(()=>{this.refreshSidebar(!0,"shareNotebooks")}),subscriptionConfig.config.lastView="shareNotebooks";break;case"shareDocuments":this.subscriptionView.hidden=!0,this.webview.hidden=!1,this.moveButton.setTitle("Shared Documents"),MNUtil.delay(.5).then(()=>{this.refreshSidebar(!0,"shareDocuments")}),subscriptionConfig.config.lastView="shareDocuments";break;case"log":this.subscriptionView.hidden=!0,this.webview.hidden=!1,MNButton.setTitle(this.moveButton,"Log Viewer",void 0,!0),this.webview.loadFileURLAllowingReadAccessToURL(NSURL.fileURLWithPath(subscriptionUtils.mainPath+"/log.html"),NSURL.fileURLWithPath(subscriptionUtils.mainPath+"/")),subscriptionConfig.config.lastView="log";var t=this.view.frame;t.width<500&&(t.width=500),t.height<500&&(t.height=500),this.view.frame=t,this.currentFrame=t,this.view.setNeedsLayout(),await MNUtil.delay(.5),this.showLog(MNUtil.logs)}},subscriptionController.prototype.init=function(){try{this.logoImage=MNUtil.getImage(subscriptionUtils.mainPath+"/dollar.png",2),this.logImage=MNUtil.getImage(subscriptionUtils.mainPath+"/log.png",2),this.appImage=MNUtil.getImage(subscriptionUtils.mainPath+"/app.png",2),this.bothModeImage=MNUtil.getImage(subscriptionUtils.mainPath+"/bothMode.png",2),this.goforwardImage=MNUtil.getImage(subscriptionUtils.mainPath+"/goforward.png",2),this.screenImage=MNUtil.getImage(subscriptionUtils.mainPath+"/screen.png",2),this.snipasteImage=MNUtil.getImage(subscriptionUtils.mainPath+"/snipaste.png",2),this.closeImage=MNUtil.getImage(subscriptionUtils.mainPath+"/stop.png",2),this.view.layer.shadowOffset={width:0,height:0},this.view.layer.shadowRadius=15,this.view.layer.shadowOpacity=.5,this.view.layer.shadowColor=UIColor.colorWithWhiteAlpha(.5,1),this.view.layer.opacity=1,this.view.layer.cornerRadius=15,this.view.backgroundColor=UIColor.whiteColor().colorWithAlphaComponent(0),this.highlightColor=UIColor.blendedColor(UIColor.colorWithHexString("#2c4d81").colorWithAlphaComponent(.8),Application.sharedInstance().defaultTextColor,.8),this.moveButton=MNButton.new({title:"Subscription Manager",bold:!0,font:16,radius:8,color:"#457bd3",highlight:this.highlightColor,opacity:.8},this.view),this.moveButton.addClickAction(this,"changeView:"),this.closeButton=MNButton.new({image:subscriptionUtils.mainPath+"/stop.png",radius:8,color:"#e06c75",opacity:.8},this.view),this.closeButton.addClickAction(this,"closeButtonTapped:"),this.refreshButton=MNButton.new({image:subscriptionUtils.mainPath+"/reload.png",radius:8,color:"#457bd3",opacity:.8},this.view),this.refreshButton.addClickAction(this,"refreshButtonTapped:"),this.subscriptionView=UIView.new(),this.subscriptionView.backgroundColor=UIColor.whiteColor().colorWithAlphaComponent(.8),this.subscriptionView.layer.cornerRadius=13,this.subscriptionView.hidden=!1,this.view.addSubview(this.subscriptionView),this.webview=new UIWebView(this.view.bounds),this.webview.backgroundColor=UIColor.whiteColor(),this.webview.scalesPageToFit=!0,this.webview.autoresizingMask=18,((this.webview.delegate=this).webview.scrollView.delegate=this).webview.scrollView.bounces=!1,this.webview.layer.cornerRadius=15,this.webview.layer.masksToBounds=!0,this.webview.layer.borderColor=MNUtil.hexColorAlpha("#9bb2d6",.8),this.webview.layer.borderWidth=0,this.webview.sidebar=!0,this.docview=new UIWebView(this.view.bounds),this.docview.backgroundColor=UIColor.whiteColor(),this.docview.scalesPageToFit=!0,this.docview.autoresizingMask=18,((this.docview.delegate=this).docview.scrollView.delegate=this).docview.scrollView.bounces=!1,this.docview.layer.cornerRadius=15,this.docview.layer.masksToBounds=!0,this.docview.layer.borderColor=MNUtil.hexColorAlpha("#9bb2d6",.8),this.docview.layer.borderWidth=0,this.docview.sidebar=!1,this.docview.customUserAgent="Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_6) AppleWebKit/605.1.15 (KHTML, like Gecko) Version/16.0 Safari/605.1.15",this.highlightColor=UIColor.blendedColor(MNUtil.hexColorAlpha("#2c4d81",.8),MNUtil.app.defaultTextColor,.8),this.webview.hidden=!0,this.docview.hidden=!0,this.webview.lastOffset=0,this.view.addSubview(this.webview),this.view.addSubview(this.docview),this.webview.loadFileURLAllowingReadAccessToURL(NSURL.fileURLWithPath(subscriptionUtils.mainPath+"/sidebar.html"),NSURL.fileURLWithPath(subscriptionUtils.mainPath+"/")),this.activationStatus=MNButton.new({title:subscriptionConfig.getStatus(),bold:!0,font:14,radius:10,color:"#457bd3",highlight:this.highlightColor,opacity:.8},this.subscriptionView),this.activationStatus.addClickAction(this,"chooseActivateDays:");var t=subscriptionConfig.getConfig("autoSubscription");this.autoSubscription=MNButton.new({title:t?"Auto subscription: ✅":"Auto subscription: ❌",bold:!0,font:14,radius:10,color:"#457bd3",highlight:this.highlightColor,opacity:.8},this.subscriptionView),this.autoSubscription.addClickAction(this,"toggleAutoSubscription:"),this.freeUsage=MNButton.new({title:subscriptionConfig.getFreeUsage(),bold:!0,font:14,radius:10,color:"#457bd3",highlight:this.highlightColor,opacity:.8},this.subscriptionView),this.usageButton=MNButton.new({title:"Refresh Usage",bold:!0,font:14,radius:10,color:"#457bd3",highlight:this.highlightColor,opacity:.8},this.subscriptionView),this.usageButton.addClickAction(this,"refreshUsage:"),this.usageDetailButton=MNButton.new({title:"Usage Detail",bold:!0,font:14,radius:10,color:"#457bd3",highlight:this.highlightColor,opacity:.8},this.subscriptionView),this.usageDetailButton.addClickAction(this,"showDetail:"),this.URLButton=MNButton.new({title:subscriptionUtils.getURLTitle(),bold:!0,font:14,radius:10,color:"#457bd3",highlight:this.highlightColor,opacity:.8},this.subscriptionView),this.URLButton.addClickAction(this,"changeURL:"),this.apikeyInput=this.creatTextView("subscriptionView",void 0,.75),this.apikeyInput.editable=!1,this.apikeyInput.text="",this.pasteKeyButton=MNButton.new({title:"Paste",bold:!0,font:14,radius:8,color:"#e06c75",highlight:this.highlightColor,opacity:.8},this.subscriptionView),this.pasteKeyButton.addClickAction(this,"pasteApiKey:"),this.showAPIKeyButton=MNButton.new({image:subscriptionUtils.mainPath+"/vision.png",radius:8,color:"#a2a2a2",opacity:.8},this.subscriptionView),this.showAPIKeyButton.addClickAction(this,"toggleApikey:"),this.DMButton=MNButton.new({title:"Show APIKey",bold:!0,font:14,highlight:this.highlightColor,radius:10,color:"#e06c75",opacity:.8,url:"https://ifdian.net/message/929697869e9311eea6745254001e7c00"},this.subscriptionView),this.DMButton.addClickAction(this,"openURL:"),this.DMButton.addLongPressGesture(this,"onLongPress:"),this.buyAPIKeyButton=MNButton.new({title:"Buy APIKey",bold:!0,font:14,highlight:this.highlightColor,radius:10,color:"#9bb2d6",id:"chooseAPIKeyForQuota"},this.subscriptionView),this.buyAPIKeyButton.addClickAction(this,"chooseAPIKeyForQuota:"),this.buyAPIKeyButton.addLongPressGesture(this,"onLongPress:"),this.helperButton=MNButton.new({title:"Have questions?",bold:!0,font:14,highlight:this.highlightColor,radius:10,color:"#9bb2d6",id:"showHelper"},this.subscriptionView),this.helperButton.addClickAction(this,"showHelper:"),this.resizeButton=MNButton.new({image:subscriptionUtils.mainPath+"/curve.png",radius:10,color:"#e06c75",opacity:.8,alpha:0},this.view),this.moveButton.addPanGesture(this,"onMoveGesture:"),this.closeButton.addPanGesture(this,"onResizeGesture0:"),this.resizeButton.addPanGesture(this,"onResizeGesture:"),this.toMinimode(!1)}catch(t){subscriptionUtils.addErrorLog(t,"init")}},subscriptionController.prototype.show=function(t){let i=this.view.frame,e=this.view.layer.opacity;if("marginnote3"===subscriptionUtils.version.version)this.view.hidden=!1;else{let t=subscriptionConfig.getConfig("lastView");this.view.layer.opacity=.2,"log"===t&&(i.width<500&&(i.width=500),i.x+500>MNUtil.studyWidth&&(i.x=MNUtil.studyWidth-500),i.height<500&&(i.height=500),i.y+500>MNUtil.studyHeight)&&(i.y=MNUtil.studyHeight-500),this.view.hidden=!1,this.moveButton.hidden=!0,this.closeButton.hidden=!0,this.activationStatus.hidden=!0,this.freeUsage.hidden=!0,this.autoSubscription.hidden=!0,this.usageButton.hidden=!0,this.apikeyInput.hidden=!0,this.pasteKeyButton.hidden=!0,this.refreshButton.hidden=!0,MNUtil.currentWindow.bringSubviewToFront(this.view),this.activationStatus.setTitle(subscriptionConfig.getStatus()),this.freeUsage.setTitle(subscriptionConfig.getFreeUsage()),MNUtil.animate(()=>{this.view.layer.opacity=e,this.view.frame=i,this.currentFrame=i}).then(()=>{this.view.layer.borderWidth=0,this.moveButton.hidden=!1,this.closeButton.hidden=!1,this.activationStatus.hidden=!1,this.freeUsage.hidden=!1,this.autoSubscription.hidden=!1,this.pasteKeyButton.hidden=!1,this.apikeyInput.hidden=!1,this.usageButton.hidden=!1,this.refreshButton.hidden=!1,this.refreshLayout(),"webview"===t?this.refreshSidebar(!0,!1):"webviewAlpha"===t?this.refreshSidebar(!0,!0):"log"===t&&this.showLog(MNUtil.logs)})}},subscriptionController.prototype.hide=function(t){let i=this.view.layer.opacity;"marginnote3"===subscriptionUtils.version.version?this.view.hidden=!0:(this.moveButton.hidden=!0,this.closeButton.hidden=!0,this.activationStatus.hidden=!0,this.freeUsage.hidden=!0,this.autoSubscription.hidden=!0,this.pasteKeyButton.hidden=!0,this.usageButton.hidden=!0,this.apikeyInput.hidden=!0,this.refreshButton.hidden=!0,MNUtil.animate(()=>{this.view.layer.opacity=.2}).then(()=>{this.view.hidden=!0,this.view.layer.opacity=i}))},subscriptionController.prototype.creatTextView=function(t="view",i="#c0bfbf",e=.9){var o=UITextView.new();return o.font=UIFont.systemFontOfSize(15),o.layer.cornerRadius=8,o.backgroundColor=subscriptionUtils.hexColorAlpha(i,e),o.textColor=UIColor.blackColor(),o.bounces=!0,this[t].addSubview(o),o},subscriptionController.prototype.refreshLayout=function(){this.freeUsage.setTitleForState(subscriptionConfig.getFreeUsage(),0)},subscriptionController.prototype.runJavaScript=async function(e,o="webview"){return new Promise((i,t)=>{try{this[o].evaluateJavaScript(e,t=>{i(t)})}catch(t){subscriptionUtils.addErrorLog(t,"runJavaScript"),i(0)}})},subscriptionController.prototype.getApikeyFromWebview=async function(e){return new Promise((i,t)=>{e.evaluateJavaScript('JSON.stringify(Array.from(document.getElementsByClassName("msg")).map(msg => msg.innerText).filter(msg=>msg.startsWith("sk")))',async t=>{var t=JSON.parse(t);t.length&&((t=t.at(-1))===subscriptionConfig.getConfig("apikey")&&i(void 0),i(t)),i(void 0)})})},subscriptionController.prototype.refreshSidebar=async function(i=!0,r="webview"){try{let t;if(i){if(!this.view.hidden)switch(r){case"webview":this.waitHUD("Retrieving updates...",this.webview);break;case"shareNotebooks":this.waitHUD("Retrieving notebooks...",this.webview);break;case"shareDocuments":this.waitHUD("Retrieving documents...",this.webview);break;case"webviewAlpha":this.waitHUD("Retrieving updates (α)...",this.webview)}switch(r){case"webview":t=await subscriptionNetwork.readFileFromWebdav("mnaddon.json"),subscriptionConfig.config.alpha=!1;break;case"shareNotebooks":t=await subscriptionNetwork.readFileFromWebdav("shareNotebooks.json");break;case"shareDocuments":t=await subscriptionNetwork.readFileFromWebdav("shareDocuments.json");break;case"webviewAlpha":t=await subscriptionNetwork.readFileFromWebdav("mnaddonAlpha.json"),subscriptionConfig.config.alpha=!0}MNUtil.stopHUD(),subscriptionConfig.mnaddon=t}else t=subscriptionConfig.mnaddon;let e=subscriptionUtils.getLocalMNAddonVersions(),o=[],s=[],n=[];var a,c;Array.isArray(t)?(c=(t=t.map(t=>{var i=t.id;if(i in e)switch(subscriptionUtils.compareVersions(t.version,e[i])){case 0:t.action="reinstall",s.push(t);break;case 1:t.action="update",o.push(t);break;case-1:t.action="reinstall",s.push(t)}else n.push(t);return t}),0<o.length&&(a=o.map(t=>t.name),MNUtil.showHUD("Updates available: "+a.join(", "))),o.concat(s).concat(n)),this.runJavaScript(`updateFromNative(\`${encodeURIComponent(JSON.stringify(c))}\`)`),subscriptionConfig.save()):t.timeout&&t.message?MNUtil.showHUD(t.message):subscriptionUtils.addErrorLog("获取插件商店内容失败","refreshSidebar",t)}catch(t){subscriptionUtils.addErrorLog(t,"refreshSidebar")}},subscriptionController.prototype.activate=async function(t=1){MNUtil.showHUD("activate");var i=this.apikeyInput.text.trim();i?subscriptionConfig.config.apikey=i:subscriptionConfig.getConfig("apikey"),subscriptionConfig.config.activated?!subscriptionConfig.isSubscribed()&&subscriptionConfig.config.subscriptionDaysRemain?(subscriptionConfig.config.activated=!0,subscriptionConfig.config.subscribedDay=subscriptionUtils.getToday(),subscriptionConfig.config.subscriptionDaysRemain=subscriptionConfig.config.subscriptionDaysRemain-1,subscriptionConfig.save(),subscriptionUtils.refreshAddonCommands(),this.activationStatus.setTitle(subscriptionConfig.getStatus()),subscriptionUtils.showHUD("Subscription days remian: "+subscriptionConfig.config.subscriptionDaysRemain)):(await subscriptionNetwork.subscribe(t)).success||(this.autoSubscription.setTitle(subscriptionConfig.config.autoSubscription?"Auto subscription: ✅":"Auto subscription: ❌"),subscriptionConfig.save()):subscriptionConfig.config.subscriptionDaysRemain?(subscriptionConfig.config.activated=!0,subscriptionConfig.config.subscribedDay=subscriptionUtils.getToday(),subscriptionConfig.config.subscriptionDaysRemain=subscriptionConfig.config.subscriptionDaysRemain-1,subscriptionConfig.save(),subscriptionUtils.refreshAddonCommands(),this.activationStatus.setTitle(subscriptionConfig.getStatus()),subscriptionUtils.showHUD("Subscription days remian: "+subscriptionConfig.config.subscriptionDaysRemain)):subscriptionNetwork.subscribe(t)},subscriptionController.prototype.blur=async function(){await this.runJavaScript(`        function removeFocus() {
            // 获取当前具有焦点的元素
            const focusedElement = document.activeElement;

            // 如果当前焦点元素存在，移除焦点
            if (focusedElement) {
                focusedElement.blur();
            }
        }
        removeFocus()`,"docview"),this.docview.endEditing(!0)},subscriptionController.prototype.layoutSubviews=function(){var t,i,e,o;this.miniMode||(t=(i=this.view.bounds).width,i=i.y+i.height,e=260,o=subscriptionConfig.getConfig("lastView"),500<t&&"log"!==o?(this.subscriptionView.frame=MNUtil.genFrame(0,30,270,i-30),this.webview.frame=MNUtil.genFrame(0,30,270,i-30),this.docview.frame=MNUtil.genFrame(275,30,t-275,i-30),this.docview.hidden=!1):(e=t-10,this.subscriptionView.frame=MNUtil.genFrame(0,30,t,i-30),this.webview.frame=MNUtil.genFrame(0,30,t,i-30),this.docview.hidden=!0),this.closeButton.setFrame(t-30,0,25,25),this.moveButton.setFrame(35,0,t-70,25),this.refreshButton.setFrame(5,0,25,25),this.activationStatus.setFrame(5,80,e,30),this.showAPIKeyButton.setFrame(e-85,45,30,25),this.pasteKeyButton.setFrame(e-50,45,50,25),this.autoSubscription.setFrame(5,115,e,30),this.freeUsage.setFrame(e-25,150,30,30),this.usageButton.setFrame(5,150,e-35,30),this.usageDetailButton.setFrame(e-110,185,115,30),this.URLButton.setFrame(5,185,e-120,30),this.apikeyInput.frame={x:5,y:5,width:e,height:70},this.resizeButton.setFrame(t-30,i-30,30,30),this.DMButton.hidden=i<295,this.DMButton.setFrame(5,220,e,30),this.buyAPIKeyButton.hidden=i<320,this.buyAPIKeyButton.setFrame(5,255,e,30),this.helperButton.hidden=i<340,this.helperButton.setFrame(5,290,e,30))},subscriptionController.prototype.showHUD=function(t,i=1.5,e=this.view){MNUtil.showHUD(t,i,e)},subscriptionController.prototype.waitHUD=function(t,i=this.view){MNUtil.waitHUD(t,i)},subscriptionController.prototype.showLog=function(t){"log"==subscriptionConfig.getConfig("lastView")&&this.runJavaScript(`showLogsFromAddon(\`${encodeURIComponent(JSON.stringify(t))}\`)`)},subscriptionController.prototype.appendLog=function(t){"log"==subscriptionConfig.getConfig("lastView")&&this.runJavaScript(`appendLogFromAddon(\`${encodeURIComponent(JSON.stringify(t))}\`)`)},subscriptionController.prototype.clearLogs=function(){"log"==subscriptionConfig.getConfig("lastView")?(MNUtil.logs=[],this.runJavaScript("clearLogsFromAddon()")):MNUtil.logs=[]},subscriptionController.prototype.hideAllButton=function(){this.closeButton.hidden=!0,this.refreshButton.hidden=!0,this.subscriptionView.hidden=!0,this.resizeButton.hidden=!0,this.webview.hidden=!0,this.docview.hidden=!0},subscriptionController.prototype.showAllButton=function(){this.closeButton.hidden=!1,this.refreshButton.hidden=!1,this.subscriptionView.hidden=!1,this.webview.hidden=!1,this.resizeButton.hidden=!1},subscriptionController.prototype.setFrame=function(t,i,e,o){this.view.frame="object"==typeof t?t:MNUtil.genFrame(t,i,e,o),this.currentFrame=this.view.frame},subscriptionController.prototype.toMinimode=function(e=!0){try{this.miniMode=!0,this.lastFrame=this.view.frame,this.currentFrame=this.view.frame,this.hideAllButton(),this.view.layer.borderWidth=0;let t="#457bd3",i=(this.view.layer.backgroundColor=MNUtil.hexColorAlpha(t,.8),this.moveButton.setTitleForState("",0),subscriptionConfig.getConfig("miniFrame"));if(e)MNUtil.animate(()=>{this.setFrame(i),this.moveButton.frame=MNUtil.genFrame(0,0,40,40),subscriptionConfig.isSubscribed()?MNButton.setColor(this.moveButton,"#457bd3"):MNButton.setColor(this.moveButton,"#677180")}).then(()=>{switch(this.moveButton.hidden=!1,this.view.layer.backgroundColor=MNUtil.hexColorAlpha(t,0),subscriptionConfig.getConfig("lastView")){case"subscriptionView":this.moveButton.setImageForState(this.logoImage,0);break;case"webview":case"webviewAlpha":this.moveButton.setImageForState(this.appImage,0);break;case"log":this.moveButton.setImageForState(this.logImage,0);break;default:this.moveButton.setImageForState(this.appImage,0)}});else{switch(this.setFrame(i),this.moveButton.frame=MNUtil.genFrame(0,0,40,40),this.moveButton.hidden=!1,this.view.layer.backgroundColor=MNUtil.hexColorAlpha(t,0),subscriptionConfig.getConfig("lastView")){case"subscriptionView":this.moveButton.setImageForState(this.logoImage,0);break;case"webview":case"webviewAlpha":this.moveButton.setImageForState(this.appImage,0);break;case"log":this.moveButton.setImageForState(this.logImage,0);break;default:this.moveButton.setImageForState(this.appImage,0)}subscriptionConfig.isSubscribed()?MNButton.setColor(this.moveButton,"#457bd3"):MNButton.setColor(this.moveButton,"#677180")}}catch(t){subscriptionUtils.addErrorLog(t,"toMinimode")}};class subscriptionUtils{constructor(t){this.name=t}static subscriptionController;static mainPath;static init(t){try{this.addonConnected=!0,this.app=Application.sharedInstance(),this.data=Database.sharedInstance(),this.focusWindow=this.app.focusWindow,this.version=this.appVersion(),this.mainPath=t,this.errorLog=[],this.extensionPath=t.replace(/\/marginnote\.extension\.\w+/,""),this.topOffset=MNUtil.isMacOS()?30:22,this.bottomOffset=MNUtil.isMacOS()?0:15,MNUtil.createFolder(t+"/download"),this.downloadPath=t+"/download"}catch(t){MNUtil.log({message:"subscriptionUtils.init",level:"ERROR",source:"MN Utils",timestamp:Date.now(),detail:t.toString()})}}static showHUD(t,i=0){this.app.showHUD(t,this.focusWindow,2)}static addErrorLog(t,i,e){MNUtil.showHUD("MN Utils Error ("+i+"): "+t);t={error:t.toString(),source:i,time:new Date(Date.now()).toString(),mnaddon:"MN Utils"};e&&(t.info=e),this.errorLog.push(t),MNUtil.copyJSON(this.errorLog)}static appVersion(){var t={},i=parseFloat(this.app.appVersion);switch(t.version=4<=i?"marginnote4":"marginnote3",this.app.osType){case 0:t.type="iPadOS";break;case 1:t.type="iPhoneOS";break;case 2:t.type="macOS"}return t}static getByDefault(t,i){var e=NSUserDefaults.standardUserDefaults().objectForKey(t);return void 0===e?(NSUserDefaults.standardUserDefaults().setObjectForKey(i,t),i):e}static getNoteColors(){return["#ffffb4","#ccfdc4","#b4d1fb","#f3aebe","#ffff54","#75fb4c","#55bbf9","#ea3323","#ef8733","#377e47","#173dac","#be3223","#ffffff","#dadada","#b4b4b4","#bd9fdc"]}static getNoteById(t){return this.data.getNoteById(t)}static getNoteBookById(t){return this.data.getNotebookById(t)}static getUrlByNoteId(t){return this.appVersion().version+"app://note/"+t}static getNoteIdByURL(t){let i=t.trim();return i=/^marginnote\dapp:\/\/note\//.test(i)?i.slice(22):i}static clipboardText(){return UIPasteboard.generalPasteboard().string}static copy(t){UIPasteboard.generalPasteboard().string=t}static copyJSON(t){UIPasteboard.generalPasteboard().string=JSON.stringify(t,null,2)}static copyImage(t){UIPasteboard.generalPasteboard().setDataForPasteboardType(t,"public.png")}static studyController(){return this.app.studyController(this.focusWindow)}static studyView(){return this.app.studyController(this.focusWindow).view}static currentDocController(){return this.studyController().readerController.currentDocumentController}static currentNotebook(){var t=this.studyController().notebookController.notebookId;return this.getNoteBookById(t)}static undoGrouping(t,i){UndoManager.sharedInstance().undoGrouping(String(Date.now()),t,i),this.app.refreshAfterDBChanged(t)}static checkSubscriptionController(){this.subscriptionController||(this.subscriptionController=subscriptionController.new()),MNUtil.isDescendantOfCurrentWindow(this.subscriptionController.view)||MNUtil.currentWindow.addSubview(this.subscriptionController.view)}static getNewLocDev(t,i=MNUtil.currentWindow){1===t.state&&(t.initLocation=t.locationInView(i),self.initFrame=self.view.frame)}static getNewLoc(t,i=MNUtil.currentWindow){var e,o=t.locationInView(i),s=(t.moveDate||(t.moveDate=0),100<Date.now()-t.moveDate&&(e=t.translationInView(i),s=t.locationInView(t.view.superview),1===t.state)&&(t.locationToBrowser={x:s.x-e.x,y:s.y-e.y}),o.x<=0&&(o.x=0),o.x>i.frame.width&&(o.x=i.frame.width),t.moveDate=Date.now(),{x:o.x-t.locationToBrowser.x,y:o.y-t.locationToBrowser.y});return s.y<=0&&(s.y=0),s.y>=i.frame.height-15&&(s.y=i.frame.height-15),s}static getImage(t,i=2){return UIImage.imageWithDataScale(NSData.dataWithContentsOfFile(t),i)}static refreshAddonCommands(){var t=subscriptionUtils.subscriptionController;t&&t.miniMode&&(subscriptionConfig.isSubscribed()?MNButton.setColor(t.moveButton,"#457bd3"):MNButton.setColor(t.moveButton,"#677180"))}static addObserver(t,i,e){NSNotificationCenter.defaultCenter().addObserverSelectorName(t,i,e)}static removeObserver(t,i){NSNotificationCenter.defaultCenter().removeObserverName(t,i)}static checkSender(t,i){return this.app.checkNotifySenderInWindow(t,i)}static getPopoverAndPresent(t,i,e=100,o=2){var s=MenuController.new(),i=(s.commandTable=i,s.rowHeight=35,s.preferredContentSize={width:e,height:s.rowHeight*s.commandTable.length},new UIPopoverController(s)),e=t.convertRectToView(t.bounds,this.studyView());return i.presentPopoverFromRect(e,this.studyView(),o,!0),i}static hexColorAlpha(t,i){t=UIColor.colorWithHexString(t);return void 0!==i?t.colorWithAlphaComponent(i):t}static getToday(){return(new Date).getDate()}static ensureView(t){MNUtil.isDescendantOfCurrentWindow(t)||(t.hidden=!0,MNUtil.currentWindow.addSubview(t))}static async delay(e){return new Promise((t,i)=>{NSTimer.scheduledTimerWithTimeInterval(e,!1,function(){t()})})}static getLocalMNAddonVersions(){try{var i=this.extensionPath+"/";let t=NSFileManager.defaultManager().contentsOfDirectoryAtPath(i),e=(t=t.filter(t=>!/\.DS_Store$/.test(t)),{});return t.map(t=>{var i;MNUtil.isfileExists(this.extensionPath+"/"+t+"/mnaddon.json")&&(i=MNUtil.readJSON(this.extensionPath+"/"+t+"/mnaddon.json").version,t=t.split("marginnote.extension.")[1],e[t]=i)}),e}catch(t){MNUtil.showHUD(t)}}static compareVersions(t,i){var e=t=>{return t.match(/(\d+)([a-zA-Z]*)(\d*)/g).map(t=>{var i=t.match(/\d+/),t=t.match(/[a-zA-Z]+/);return{num:i?parseInt(i[0],10):0,alpha:t?t[0]:"",alphaNum:t?t[0].charCodeAt(0):0}})},o=e(t),s=e(i);for(let t=0;t<Math.max(o.length,s.length);t++){var n=o[t]||{num:0,alpha:"",alphaNum:0},r=s[t]||{num:0,alpha:"",alphaNum:0};if(n.num!==r.num)return n.num>r.num?1:-1;if(n.alphaNum!==r.alphaNum)return n.alphaNum>r.alphaNum?1:-1;if(n.alpha===r.alpha&&n.num===r.num){n=n.num,r=r.num;if(n!==r)return r<n?1:-1}}return 0}static getRandomAuthorization(t){t="https://dav.jianguoyun.com/dav/mnaddonStore/"+t,t=[{user:"2063617827@qq.com",password:"a3dkxi2c72hgm8hh",url:t},{user:"1514501767@qq.com",password:"a76xnbehrsr36via",url:t}];return 1===t.length?t[0]:t.length?t[Math.floor(Math.random()*t.length)]:""}static getURLTitle(){var t=subscriptionConfig.getConfig("url");return"https://api.feliks.top"===t?"URL1":"https://api1.feliks.top"===t?"URL2":"https://alpha.u1162561.nyat.app:20075"===t?"URL3":"https://api.u1162561.nyat.app:20074"===t?"URL4":"https://d2p9226849.vicp.fun"===t?"URL5":"Unknown URL"}static async importNotebook(o,s,t){try{var n=subscriptionUtils.subscriptionController,e=(n.waitHUD("Importing notebook..."),MNUtil.allNotebookIds());let i=2;if(e.includes(t)&&(i=await MNUtil.userSelect("请选择操作","",["合并已有学习集","覆盖已有学习集"])),o.endsWith(".marginnotes"))switch(i){case 0:return void MNUtil.stopHUD();case 1:n.waitHUD("Importing notebook..."),await MNUtil.delay(.1);var r,a=MNUtil.importNotebook(o,!0);n.waitHUD("✅ Import success!"),a&&(r=await MNUtil.confirm("是否打开学习集？",a.title),MNUtil.refreshAfterDBChanged(),r)&&MNUtil.openURL("marginnote4app://notebook/"+a.topicId),MNUtil.stopHUD(.5);break;case 2:case 3:n.waitHUD("Importing notebook..."),await MNUtil.delay(.1);var c,l=MNUtil.importNotebook(o,!1);n.waitHUD("✅ Import success!"),l&&(c=await MNUtil.confirm("是否打开学习集？",l.title),MNUtil.refreshAfterDBChanged(),c)&&MNUtil.openURL("marginnote4app://notebook/"+l.topicId),MNUtil.stopHUD(.5);break;default:return}else{MNUtil.createFolderDev(s),ZipArchive.unzipFileAtPathToDestination(o,s);var u=MNUtil.subpathsOfDirectory(s+"/").filter(t=>t.endsWith(".pdf"));let e=u.map(t=>s+"/"+t);var d=u.map(t=>MNUtil.documentFolder+"/"+t);let t=MNUtil.contentsOfDirectory(s+"/");switch(t=t.filter(t=>t.endsWith(".marginnotes")),i){case 0:return void MNUtil.stopHUD();case 1:n.waitHUD("Importing notebook..."),await MNUtil.delay(.1);var h=MNUtil.importNotebook(s+"/"+t[0],!0);await MNUtil.delay(.1),d.length&&(n.waitHUD("Importing documents..."),d.forEach((t,i)=>{MNUtil.copyFile(e[i],t),MNUtil.importDocument(t)})),await MNUtil.delay(.1),n.waitHUD("✅ Import success!"),await MNUtil.openNotebook(h,!0),MNUtil.stopHUD(.5);break;case 2:case 3:n.waitHUD("Importing notebook..."),await MNUtil.delay(.1);var p=MNUtil.importNotebook(s+"/"+t[0],!1);await MNUtil.delay(.1),d.length&&(n.waitHUD("Importing documents..."),d.forEach((t,i)=>{MNUtil.copyFile(e[i],t),MNUtil.importDocument(t)})),await MNUtil.delay(.1),n.waitHUD("✅ Import success!"),await MNUtil.openNotebook(p,!0),MNUtil.stopHUD(.5);break;default:return}}}catch(t){subscriptionUtils.addErrorLog(t,"importNotebook")}}static getFileNameFromUrl(t){var i=t.indexOf("?");if(-1===i)return MNUtil.getFileName(t);for(const s of t.slice(i+1).split("&")){var[e,o]=s.split("=");if("filename"===e)return decodeURIComponent(o)}return null}}class subscriptionNetwork{constructor(t){this.name=t}static onSubscrbing=!1;static genNSURL(t){return NSURL.URLWithString(t)}static initRequest(t,i){var e=NSMutableURLRequest.requestWithURL(this.genNSURL(t));e.setHTTPMethod(i.method??"GET"),e.setTimeoutInterval(i.timeout??10);return e.setAllHTTPHeaderFields({"User-Agent":"Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_4) AppleWebKit/605.1.15 (KHTML, like Gecko) Version/13.1.1 Safari/605.1.15","Content-Type":"application/json",Accept:"application/json",...i.headers??{}}),i.search?e.setURL(this.genNSURL(t.trim()+"?"+Object.entries(i.search).reduce((t,i)=>{var[i,e]=i;return(t?t+"&":"")+i+"="+encodeURIComponent(e)},""))):i.body?e.setHTTPBody(NSData.dataWithStringEncoding(i.body,4)):i.form?e.setHTTPBody(NSData.dataWithStringEncoding(Object.entries(i.form).reduce((t,i)=>{var[i,e]=i;return(t?t+"&":"")+i+"="+encodeURIComponent(e)},""),4)):i.json&&e.setHTTPBody(NSJSONSerialization.dataWithJSONObjectOptions(i.json,1)),e}static async sendRequest(i){const e=NSOperationQueue.mainQueue();return new Promise((o,t)=>{NSURLConnection.sendAsynchronousRequestQueueCompletionHandler(i,e,(t,i,e)=>{i=NSJSONSerialization.JSONObjectWithDataOptions(i,1);NSJSONSerialization.isValidJSONObject(i)&&(e.localizedDescription&&(i.success=!1,subscriptionUtils.showHUD(e.localizedDescription)),o(i)),o(i)})})}static async fetch(t,i={}){t=this.initRequest(t,i);return await this.sendRequest(t)}static async subscribe(t=1,i=!0){this.onSubscrbing=!0;var e={"Content-Type":"application/json",Authorization:"Bearer "+subscriptionConfig.config.apikey};let o="mnaddon";var s={model:o=1<t?"mnaddon"+t:o,messages:[{role:"user",content:"mnaddon"}]},n=subscriptionConfig.getConfig("url")+"/v1/chat/completions",n=await this.fetch(n,{method:"POST",headers:e,timeout:60,json:s});if(n.success)subscriptionConfig.isSubscribed()?(subscriptionConfig.config.subscriptionDaysRemain=subscriptionConfig.getConfig("subscriptionDaysRemain")+t,MNUtil.showHUD("✅ Subscribe success! "+subscriptionConfig.config.subscriptionDaysRemain+" days remain")):(subscriptionConfig.config.activated=!0,subscriptionConfig.config.subscribedDay=subscriptionUtils.getToday(),subscriptionConfig.config.subscriptionDaysRemain=subscriptionConfig.getConfig("subscriptionDaysRemain")+t-1,MNUtil.showHUD("✅ subscribe success! "+subscriptionConfig.config.subscriptionDaysRemain+" days remain")),MNUtil.log({source:"subscription",message:"✅ Subscribe success!",detail:subscriptionConfig.config.subscriptionDaysRemain+" days remain"});else{let t=!1;subscriptionConfig.config.autoSubscription=!1,n.error&&(MNUtil.log({level:"error",source:"subscription",message:"Error: "+n.error.message,detail:JSON.stringify(n.error,void 0,2)}),n.error.message?(MNUtil.showHUD("Error: "+n.error.message),n.error.message.includes("该令牌额度已用尽")&&(t=!0)):(MNUtil.showHUD("Error: "+JSON.stringify(n.error)),MNUtil.copyJSON(n.error))),subscriptionConfig.config.activated&&t||i&&(subscriptionConfig.config.activated=!1)}return this.onSubscrbing=!1,MNUtil.delay(.1).then(()=>{subscriptionConfig.save(),subscriptionUtils.subscriptionController.activationStatus.setTitleForState(subscriptionConfig.getStatus(),0),subscriptionUtils.refreshAddonCommands()}),n}static async getKey(t="mnaddon"){var i,e=subscriptionConfig.getConfig("apikey");if(""!==e.trim())return e={"Content-Type":"application/json",Authorization:"Bearer "+e},t={model:t,messages:[{role:"user",content:"mnaddon"}]},i=subscriptionConfig.getConfig("url")+"/v1/chat/completions",await this.fetch(i,{method:"POST",headers:e,timeout:60,json:t});subscriptionUtils.showHUD("no api key")}static async countDownload(t="mnaddon"){var i={"Content-Type":"application/json",Authorization:"Bearer sk-S2rXjj2qB98OiweU46F3BcF2D36e4e5eBfB2C9C269627e44"},t={model:t,messages:[{role:"user",content:"mnaddon"}]},e=subscriptionConfig.getConfig("url")+"/v1/chat/completions";return await this.fetch(e,{method:"POST",headers:i,timeout:60,json:t})}static async getUsage(){var t,i=subscriptionConfig.getConfig("url"),e=i+"/v1/dashboard/billing/subscription",i=i+"/v1/dashboard/billing/usage",o=subscriptionConfig.getConfig("apikey");if(""!==o.trim())return t={},"error"in(o=await this.fetch(i,{method:"GET",timeout:60,headers:i={Authorization:"Bearer "+o,"Content-Type":"application/json"}}))&&o.error.message.includes("该令牌额度已用尽")?t.error="该令牌额度已用尽":(t.usage=o.total_usage,o=await this.fetch(e,{method:"GET",timeout:60,headers:i}),t.total=o.hard_limit_usd),t;subscriptionUtils.showHUD("no api key")}static btoa(t){t=CryptoJS.enc.Utf8.parse(t);return CryptoJS.enc.Base64.stringify(t)}static async readWebDAVFile(t,i,e){i={Authorization:"Basic "+this.btoa(i+":"+e),"Cache-Control":"no-cache"},e=await MNConnection.fetch(t,{method:"GET",headers:i});try{return e.base64Encoding?MNUtil.data2string(e):e}catch(t){return e}}static readWebDAVFileWithDelegate(t,i,e){try{var o={Authorization:"Basic "+this.btoa(i+":"+e),"Cache-Control":"no-cache"};return this.initRequest(t,{method:"GET",headers:o})}catch(t){}}static async readFileFromWebdav(t){t=subscriptionUtils.getRandomAuthorization(t);return await this.readWebDAVFile(t.url,t.user,t.password)}static readFileFromWebdavWithDelegate(t,i){t=subscriptionUtils.getRandomAuthorization(t);return this.readWebDAVFileWithDelegate(t.url,t.user,t.password,i)}static async downloadFromConfig(t,i=void 0){var e=subscriptionUtils.subscriptionController;if("importDocument"===t.action)MNUtil.allDocumentIds().includes(t.id)?(MNUtil.currentNotebookId?await MNUtil.confirm("Document already exists","文档已存在，是否打开该文档？\n"+t.fileName)&&MNUtil.openDoc(t.id,MNUtil.currentNotebookId):MNUtil.confirm("Document already exists","文档已存在\n"+t.fileName),MNUtil.stopHUD()):(e.waitHUD("Download: "+t.name),MNUtil.createFolderDev(MNUtil.documentFolder+"/Download"),r=(s=MNUtil.documentFolder+"/Download")+"/"+t.fileName,n=MNConnection.requestWithURL(t.url),i&&(NSURLConnection.connectionWithRequestDelegate(n,i),i.targetPath=r,i.folder=s,i.documentId=t.id,i.fileType="document"));else{if("importNotebook"===t.action)return n=t.url.endsWith(".marginpkg")?t.id+".marginpkg":t.id+".marginnotes",r=subscriptionUtils.downloadPath+"/"+n,MNUtil.isfileExists(r)?(s=subscriptionUtils.downloadPath+"/"+t.id,void subscriptionUtils.importNotebook(r,s,t.id)):(e.waitHUD("Download: "+t.name),n=MNConnection.requestWithURL(t.url),i&&(NSURLConnection.connectionWithRequestDelegate(n,i),i.targetPath=r,i.folder=subscriptionUtils.downloadPath+"/"+t.id,i.notebookId=t.id,i.fileType="notebook"),void MNUtil.stopHUD());var o,s=subscriptionUtils.extensionPath+"/marginnote.extension."+t.id,n=t.id+"_v"+t.version.replace(/\./g,"_")+".mnaddon",r=subscriptionUtils.downloadPath+"/"+n;t.customUrl?(e.waitHUD("Download: "+t.name),o=MNConnection.requestWithURL(t.url),i&&(NSURLConnection.connectionWithRequestDelegate(o,i),i.targetPath=r,i.addonPath=s,i.fileType="mnaddon")):(e.waitHUD("Download: "+n),i&&(o=subscriptionNetwork.readFileFromWebdavWithDelegate(n,i),NSURLConnection.connectionWithRequestDelegate(o,i),i.targetPath=r,i.addonPath=s,i.fileType="mnaddon")),subscriptionNetwork.countDownload(t.id)}}}class subscriptionConfig{constructor(t){this.name=t}static defaultConfig={activated:!1,autoSubscription:!1,subscribedDay:0,apikey:"",freeUsage:0,freeDay:0,subscriptionDaysRemain:0,url:"https://api.feliks.top",lastView:"webview",customMode:"left",alpha:!1,miniFrame:{x:0,y:80,width:40,height:40}};static frameHeight=355;static mnaddon=[];static init(){this.config=this.getByDefault("FeliksPro",this.defaultConfig)}static getByDefault(t,i){var e=NSUserDefaults.standardUserDefaults().objectForKey(t);return void 0===e?(NSUserDefaults.standardUserDefaults().setObjectForKey(i,t),i):e}static getConfig(t){return(void 0!==this.config[t]?this.config:this.defaultConfig)[t]}static isSubscribed(){var t;return!!this.getConfig("activated")&&(t=subscriptionUtils.getToday(),this.getConfig("subscribedDay")===t)}static getFreeUsage(){var t=subscriptionUtils.getToday();return this.getConfig("freeDay")===t?["🔟","9️⃣","8️⃣","7️⃣","6️⃣","5️⃣","4️⃣","3️⃣","2️⃣","1️⃣","0️⃣"][this.getConfig("freeUsage")]||"0️⃣":(this.config.freeDay=t,this.config.freeUsage=0,"🔟")}static isFree(t=!0){var i,e=subscriptionUtils.getToday();return this.getConfig("freeDay")===e?(i=this.getConfig("freeUsage"),t?(this.config.freeUsage=i+1,10<=this.config.freeUsage?subscriptionUtils.showHUD("Free Usage remian: 0"):subscriptionUtils.showHUD("Free Usage remian: "+(9-i)),i<=10):i<=9):(this.config.freeDay=e,t?(this.config.freeUsage=1,subscriptionUtils.showHUD("Free Usage remian: "+(10-this.config.freeUsage))):this.config.freeUsage=0,!0)}static checkSubscribed(t=!0,i=!1,e=!0){if(!this.getConfig("activated"))return!i&&this.isFree(t)?(MNUtil.delay(.1).then(()=>{subscriptionUtils.subscriptionController&&subscriptionUtils.subscriptionController.freeUsage.setTitleForState(this.getFreeUsage(),0),this.save()}),!0):(e&&MNUtil.confirm("MN Utils: Subscription not activated!","MN Utils: 插件订阅未激活!"),!1);if(this.isSubscribed())return!0;if(this.getConfig("autoSubscription")){if(this.config.subscriptionDaysRemain)return this.config.activated=!0,this.config.subscribedDay=subscriptionUtils.getToday(),this.config.subscriptionDaysRemain=this.config.subscriptionDaysRemain-1,MNUtil.delay(.1).then(()=>{subscriptionUtils.subscriptionController&&subscriptionUtils.subscriptionController.activationStatus&&subscriptionUtils.subscriptionController.activationStatus.setTitleForState(this.getStatus(),0),subscriptionUtils.showHUD("Subscription days remian: "+this.config.subscriptionDaysRemain),subscriptionUtils.refreshAddonCommands(),this.save()}),!0;subscriptionNetwork.onSubscrbing||subscriptionNetwork.subscribe().then(t=>{subscriptionUtils.refreshAddonCommands()})}return!i&&this.isFree(t)?(MNUtil.delay(.1).then(()=>{subscriptionUtils.subscriptionController&&subscriptionUtils.subscriptionController.freeUsage.setTitleForState(this.getFreeUsage(),0),this.save()}),!0):(e&&MNUtil.confirm("MN Utils: Subscribe today?","MN Utils: 今日是否订阅?").then(t=>{switch(t){case 0:return;case 1:this.config.subscriptionDaysRemain?(this.config.activated=!0,this.config.subscribedDay=subscriptionUtils.getToday(),this.config.subscriptionDaysRemain=this.config.subscriptionDaysRemain-1,MNUtil.delay(.1).then(()=>{subscriptionUtils.subscriptionController&&subscriptionUtils.subscriptionController.activationStatus&&subscriptionUtils.subscriptionController.activationStatus.setTitleForState(this.getStatus(),0),subscriptionUtils.showHUD("Subscription days remian: "+this.config.subscriptionDaysRemain),subscriptionUtils.refreshAddonCommands(),this.save()})):subscriptionNetwork.onSubscrbing||subscriptionNetwork.subscribe().then(t=>{subscriptionUtils.refreshAddonCommands()})}}),!1)}static getStatus(){return"Activated: "+(this.getConfig("activated")?"✅":"❌")+" | "+("Subscribed: "+(this.isSubscribed()?"✅":"❌"))+" | "+this.getConfig("subscriptionDaysRemain")}static save(){NSUserDefaults.standardUserDefaults().setObjectForKey(this.config,"FeliksPro")}static remove(){NSUserDefaults.standardUserDefaults().removeObjectForKey("FeliksPro")}static getConfig(t){return(void 0!==this.config[t]?this.config:this.defaultConfig)[t]}static autoSubscribe(t=!0){this.getConfig("autoSubscription")?this.getConfig("activated")?this.isSubscribed()?subscriptionUtils.refreshAddonCommands():this.config.subscriptionDaysRemain?(this.config.activated=!0,this.config.subscribedDay=subscriptionUtils.getToday(),this.config.subscriptionDaysRemain=this.config.subscriptionDaysRemain-1,subscriptionUtils.subscriptionController.activationStatus&&subscriptionUtils.subscriptionController.activationStatus.setTitleForState(this.getStatus(),0),subscriptionUtils.showHUD("Subscription days remian: "+this.config.subscriptionDaysRemain),subscriptionUtils.refreshAddonCommands(),this.save()):subscriptionNetwork.onSubscrbing?subscriptionUtils.refreshAddonCommands():subscriptionNetwork.subscribe().then(t=>{subscriptionUtils.refreshAddonCommands()}):(t&&subscriptionUtils.showHUD("Not activated!"),subscriptionConfig.config.autoSubscription=!1,subscriptionUtils.refreshAddonCommands()):subscriptionUtils.refreshAddonCommands()}}