<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>‰ªªÂä°ËØ¶ÊÉÖÁºñËæëÂô®</title>
    <style>
        :root {
            --primary-bg: #ffffff;
            --secondary-bg: #f8f9fa;
            --border-color: #e9ecef;
            --text-primary: #212529;
            --text-secondary: #6c757d;
            --primary-color: #457bd3;
            --hover-bg: #e9ecef;
            --danger-color: #dc3545;
            --success-color: #28a745;
            --warning-color: #ffc107;
            --shadow-sm: 0 2px 4px rgba(0,0,0,0.05);
            --shadow-md: 0 4px 6px rgba(0,0,0,0.1);
            --transition-speed: 0.2s;
            --border-radius: 8px;
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            background-color: var(--primary-bg);
            color: var(--text-primary);
            padding: 20px;
            margin: 0;
            overflow-x: hidden;
        }

        .container {
            max-width: 800px;
            margin: 0 auto;
        }

        /* ‰ªªÂä°Â§¥ÈÉ®‰ø°ÊÅØ */
        .task-header {
            background-color: var(--secondary-bg);
            padding: 20px;
            border-radius: var(--border-radius);
            margin-bottom: 20px;
            box-shadow: var(--shadow-sm);
        }

        .task-title {
            font-size: 24px;
            font-weight: 600;
            margin-bottom: 10px;
            color: var(--text-primary);
        }

        .task-meta {
            display: flex;
            gap: 20px;
            font-size: 14px;
            color: var(--text-secondary);
        }

        .task-meta-item {
            display: flex;
            align-items: center;
            gap: 5px;
        }

        /* Â≠óÊÆµÁºñËæëÂå∫Âüü */
        .fields-section {
            background-color: var(--primary-bg);
            padding: 20px;
            border: 1px solid var(--border-color);
            border-radius: var(--border-radius);
            margin-bottom: 20px;
        }

        .section-title {
            font-size: 18px;
            font-weight: 600;
            margin-bottom: 15px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .add-field-btn {
            background-color: var(--primary-color);
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            transition: background-color var(--transition-speed);
        }

        .add-field-btn:hover {
            background-color: #3a6bc3;
        }

        /* Â≠óÊÆµÂàóË°® */
        .fields-list {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .field-item {
            background-color: var(--secondary-bg);
            padding: 15px;
            border-radius: 6px;
            display: flex;
            align-items: center;
            gap: 10px;
            transition: all var(--transition-speed);
            cursor: move;
        }

        .field-item:hover {
            box-shadow: var(--shadow-sm);
            transform: translateY(-1px);
        }

        .field-item.dragging {
            opacity: 0.5;
        }

        .field-drag-handle {
            color: var(--text-secondary);
            cursor: move;
            font-size: 20px;
            user-select: none;
        }

        .field-info {
            flex: 1;
            display: flex;
            flex-direction: column;
            gap: 5px;
        }

        .field-name {
            font-weight: 600;
            color: var(--primary-color);
            font-size: 14px;
        }

        .field-content {
            color: var(--text-primary);
            font-size: 14px;
        }

        .field-content.empty {
            color: var(--text-secondary);
            font-style: italic;
        }

        .field-actions {
            display: flex;
            gap: 8px;
        }

        .field-btn {
            background: none;
            border: none;
            cursor: pointer;
            padding: 6px;
            border-radius: 4px;
            transition: background-color var(--transition-speed);
            font-size: 16px;
        }

        .field-btn:hover {
            background-color: var(--hover-bg);
        }

        .field-btn.edit {
            color: var(--primary-color);
        }

        .field-btn.delete {
            color: var(--danger-color);
        }

        /* Êó•ÊúüÈÄâÊã©Âå∫Âüü */
        .date-section {
            background-color: var(--secondary-bg);
            padding: 20px;
            border-radius: var(--border-radius);
            margin-bottom: 20px;
        }

        .date-input-group {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-top: 10px;
        }

        .date-input {
            flex: 1;
            padding: 10px;
            border: 1px solid var(--border-color);
            border-radius: 6px;
            font-size: 14px;
        }

        .date-btn {
            background-color: var(--primary-color);
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            transition: background-color var(--transition-speed);
        }

        .date-btn:hover {
            background-color: #3a6bc3;
        }

        /* Êìç‰ΩúÊåâÈíÆÂå∫Âüü */
        .actions-section {
            display: flex;
            justify-content: flex-end;
            gap: 10px;
            margin-top: 20px;
        }

        .action-btn {
            padding: 10px 20px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            transition: all var(--transition-speed);
        }

        .action-btn.save {
            background-color: var(--success-color);
            color: white;
        }

        .action-btn.save:hover {
            background-color: #239a3b;
        }

        .action-btn.cancel {
            background-color: var(--secondary-bg);
            color: var(--text-primary);
            border: 1px solid var(--border-color);
        }

        .action-btn.cancel:hover {
            background-color: var(--hover-bg);
        }

        /* Ê®°ÊÄÅÊ°Ü */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            z-index: 1000;
        }

        .modal.show {
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .modal-content {
            background-color: white;
            padding: 30px;
            border-radius: var(--border-radius);
            box-shadow: var(--shadow-md);
            width: 90%;
            max-width: 500px;
        }

        .modal-title {
            font-size: 20px;
            font-weight: 600;
            margin-bottom: 20px;
        }

        .modal-form {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .form-group {
            display: flex;
            flex-direction: column;
            gap: 5px;
        }

        .form-label {
            font-size: 14px;
            font-weight: 500;
            color: var(--text-secondary);
        }

        .form-input {
            padding: 10px;
            border: 1px solid var(--border-color);
            border-radius: 6px;
            font-size: 14px;
        }

        .form-input:focus {
            outline: none;
            border-color: var(--primary-color);
        }

        .modal-actions {
            display: flex;
            justify-content: flex-end;
            gap: 10px;
            margin-top: 20px;
        }

        /* Âä†ËΩΩÁä∂ÊÄÅ */
        .loading {
            text-align: center;
            padding: 40px;
            color: var(--text-secondary);
        }

        /* Á©∫Áä∂ÊÄÅ */
        .empty-state {
            text-align: center;
            padding: 40px;
            color: var(--text-secondary);
        }

        .empty-state-icon {
            font-size: 48px;
            margin-bottom: 10px;
        }

        .empty-state-text {
            font-size: 16px;
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- ‰ªªÂä°Â§¥ÈÉ®‰ø°ÊÅØ -->
        <div class="task-header">
            <h1 class="task-title" id="taskTitle">Âä†ËΩΩ‰∏≠...</h1>
            <div class="task-meta">
                <div class="task-meta-item">
                    <span class="meta-icon">üìã</span>
                    <span id="taskType">-</span>
                </div>
                <div class="task-meta-item">
                    <span class="meta-icon">üéØ</span>
                    <span id="taskStatus">-</span>
                </div>
                <div class="task-meta-item">
                    <span class="meta-icon">üè∑Ô∏è</span>
                    <span id="taskId">-</span>
                </div>
            </div>
        </div>

        <!-- Êó•ÊúüËÆæÁΩÆÂå∫Âüü -->
        <div class="date-section">
            <h2 class="section-title">‰ªªÂä°Êó•Êúü</h2>
            <div class="date-input-group">
                <input type="date" id="taskDate" class="date-input">
                <button class="date-btn" onclick="updateTaskDate()">Êõ¥Êñ∞Êó•Êúü</button>
                <button class="date-btn" onclick="clearTaskDate()">Ê∏ÖÈô§Êó•Êúü</button>
            </div>
        </div>

        <!-- Â≠óÊÆµÁºñËæëÂå∫Âüü -->
        <div class="fields-section">
            <div class="section-title">
                <span>‰ªªÂä°Â≠óÊÆµ</span>
                <button class="add-field-btn" onclick="showAddFieldModal()">+ Ê∑ªÂä†Â≠óÊÆµ</button>
            </div>
            <div id="fieldsList" class="fields-list">
                <!-- Â≠óÊÆµÂàóË°®Â∞ÜÂä®ÊÄÅÂä†ËΩΩ -->
            </div>
        </div>

        <!-- Êìç‰ΩúÊåâÈíÆ -->
        <div class="actions-section">
            <button class="action-btn cancel" onclick="cancelEdit()">ÂèñÊ∂à</button>
            <button class="action-btn save" onclick="saveChanges()">‰øùÂ≠òÊõ¥Êîπ</button>
        </div>
    </div>

    <!-- Â≠óÊÆµÁºñËæëÊ®°ÊÄÅÊ°Ü -->
    <div id="fieldModal" class="modal">
        <div class="modal-content">
            <h3 class="modal-title" id="modalTitle">Ê∑ªÂä†Â≠óÊÆµ</h3>
            <form class="modal-form" onsubmit="saveField(event)">
                <div class="form-group">
                    <label class="form-label">Â≠óÊÆµÂêçÁß∞</label>
                    <input type="text" id="fieldName" class="form-input" required>
                </div>
                <div class="form-group">
                    <label class="form-label">Â≠óÊÆµÂÜÖÂÆπÔºàÂèØÈÄâÔºâ</label>
                    <input type="text" id="fieldContent" class="form-input">
                </div>
                <div class="modal-actions">
                    <button type="button" class="action-btn cancel" onclick="closeModal()">ÂèñÊ∂à</button>
                    <button type="submit" class="action-btn save">Á°ÆÂÆö</button>
                </div>
            </form>
        </div>
    </div>

    <script>
        // ‰ªªÂä°ÁºñËæëÂô®ÁÆ°ÁêÜÂØπË±°
        const taskEditor = {
            currentTask: null,
            fields: [],
            editingFieldIndex: -1,
            hasChanges: false,

            // ÂàùÂßãÂåñÁºñËæëÂô®
            init() {
                console.log('‰ªªÂä°ÁºñËæëÂô®ÂàùÂßãÂåñ');
                this.setupDragAndDrop();
                this.bindEvents();
                
                // ‰∏çÂÜçËá™Âä®ËØ∑Ê±ÇÂä†ËΩΩ‰ªªÂä°Êï∞ÊçÆÔºåÁ≠âÂæÖÂéüÁîü‰ª£Á†ÅË∞ÉÁî® loadTaskFromPlugin
                console.log('‰ªªÂä°ÁºñËæëÂô®Â∑≤ÂáÜÂ§áÂ∞±Áª™ÔºåÁ≠âÂæÖÂä†ËΩΩ‰ªªÂä°Êï∞ÊçÆ');
            },

            // Âä†ËΩΩ‰ªªÂä°Êï∞ÊçÆ
            loadTask(encodedTask) {
                try {
                    const task = JSON.parse(decodeURIComponent(encodedTask));
                    console.log('Âä†ËΩΩ‰ªªÂä°Êï∞ÊçÆ:', task);
                    
                    this.currentTask = task;
                    this.updateTaskHeader(task);
                    this.loadFields(task.fields || []);
                    
                    // ËÆæÁΩÆÊó•Êúü
                    if (task.scheduledDate) {
                        document.getElementById('taskDate').value = task.scheduledDate;
                    }
                } catch (error) {
                    console.error('Âä†ËΩΩ‰ªªÂä°Â§±Ë¥•:', error);
                    alert('Âä†ËΩΩ‰ªªÂä°Êï∞ÊçÆÂ§±Ë¥•');
                }
            },

            // Êõ¥Êñ∞‰ªªÂä°Â§¥ÈÉ®‰ø°ÊÅØ
            updateTaskHeader(task) {
                document.getElementById('taskTitle').textContent = task.title || 'Êú™ÂëΩÂêç‰ªªÂä°';
                document.getElementById('taskType').textContent = task.type || 'Êú™Áü•';
                document.getElementById('taskStatus').textContent = task.status || 'Êú™Áü•';
                document.getElementById('taskId').textContent = task.id ? task.id.substring(0, 8) + '...' : '-';
            },

            // Âä†ËΩΩÂ≠óÊÆµÂàóË°®
            loadFields(fields) {
                // ‰∏∫ÊØè‰∏™Â≠óÊÆµÊ∑ªÂä†ÂéüÂßãÁ¥¢Âºï‰ª•Ë∑üË∏™Êõ¥Êîπ
                this.fields = fields.map((field, index) => ({
                    ...field,
                    originalIndex: index,
                    isNew: false,
                    isDeleted: false
                }));
                this.renderFields();
            },

            // Ê∏≤ÊüìÂ≠óÊÆµÂàóË°®
            renderFields() {
                const container = document.getElementById('fieldsList');
                
                // ËøáÊª§ÊéâÂ∑≤Âà†Èô§ÁöÑÂ≠óÊÆµ
                const activeFields = this.fields.filter(field => !field.isDeleted);
                
                if (activeFields.length === 0) {
                    container.innerHTML = `
                        <div class="empty-state">
                            <div class="empty-state-icon">üìù</div>
                            <div class="empty-state-text">ÊöÇÊó†Â≠óÊÆµÔºåÁÇπÂáª‰∏äÊñπÊåâÈíÆÊ∑ªÂä†</div>
                        </div>
                    `;
                    return;
                }

                container.innerHTML = this.fields.map((field, index) => {
                    if (field.isDeleted) return '';
                    return `
                    <div class="field-item" draggable="true" data-index="${index}">
                        <span class="field-drag-handle">‚â°</span>
                        <div class="field-info">
                            <div class="field-name">${field.name}</div>
                            <div class="field-content ${field.content ? '' : 'empty'}">
                                ${field.content || '(Á©∫)'}
                            </div>
                        </div>
                        <div class="field-actions">
                            <button class="field-btn edit" onclick="taskEditor.editField(${index})" title="ÁºñËæë">
                                ‚úèÔ∏è
                            </button>
                            <button class="field-btn delete" onclick="taskEditor.deleteField(${index})" title="Âà†Èô§">
                                üóëÔ∏è
                            </button>
                        </div>
                    </div>
                `;
                }).join('');

                // ÈáçÊñ∞ÁªëÂÆöÊãñÊãΩ‰∫ã‰ª∂
                this.bindDragEvents();
            },

            // ËÆæÁΩÆÊãñÊãΩÂäüËÉΩ
            setupDragAndDrop() {
                let draggedElement = null;
                let draggedIndex = -1;

                document.addEventListener('dragstart', (e) => {
                    if (e.target.classList.contains('field-item')) {
                        draggedElement = e.target;
                        draggedIndex = parseInt(e.target.dataset.index);
                        e.target.classList.add('dragging');
                    }
                });

                document.addEventListener('dragend', (e) => {
                    if (e.target.classList.contains('field-item')) {
                        e.target.classList.remove('dragging');
                    }
                });

                document.addEventListener('dragover', (e) => {
                    e.preventDefault();
                    const container = document.getElementById('fieldsList');
                    const afterElement = this.getDragAfterElement(container, e.clientY);
                    
                    if (afterElement == null) {
                        container.appendChild(draggedElement);
                    } else {
                        container.insertBefore(draggedElement, afterElement);
                    }
                });

                document.addEventListener('drop', (e) => {
                    e.preventDefault();
                    if (draggedElement) {
                        const newIndex = [...document.querySelectorAll('.field-item')].indexOf(draggedElement);
                        if (draggedIndex !== newIndex) {
                            this.reorderField(draggedIndex, newIndex);
                        }
                    }
                });
            },

            // Ëé∑ÂèñÊãñÊãΩÂêéÁöÑ‰ΩçÁΩÆ
            getDragAfterElement(container, y) {
                const draggableElements = [...container.querySelectorAll('.field-item:not(.dragging)')];
                
                return draggableElements.reduce((closest, child) => {
                    const box = child.getBoundingClientRect();
                    const offset = y - box.top - box.height / 2;
                    
                    if (offset < 0 && offset > closest.offset) {
                        return { offset: offset, element: child };
                    } else {
                        return closest;
                    }
                }, { offset: Number.NEGATIVE_INFINITY }).element;
            },

            // ÈáçÊñ∞ÊéíÂ∫èÂ≠óÊÆµ
            reorderField(oldIndex, newIndex) {
                const [removed] = this.fields.splice(oldIndex, 1);
                this.fields.splice(newIndex, 0, removed);
                this.hasChanges = true;
                this.renderFields();
                
                // ÈÄöÁü•ÂéüÁîü‰ª£Á†Å
                window.location.href = `mntask://reorderFields?oldIndex=${oldIndex}&newIndex=${newIndex}`;
            },

            // ÁªëÂÆöÊãñÊãΩ‰∫ã‰ª∂
            bindDragEvents() {
                document.querySelectorAll('.field-item').forEach(item => {
                    item.addEventListener('dragstart', (e) => {
                        e.dataTransfer.effectAllowed = 'move';
                    });
                });
            },

            // ÁªëÂÆöÈÄöÁî®‰∫ã‰ª∂
            bindEvents() {
                // ÁõëÂê¨ÈîÆÁõò‰∫ã‰ª∂
                document.addEventListener('keydown', (e) => {
                    if (e.key === 'Escape') {
                        this.closeModal();
                    }
                });

                // ÁõëÂê¨Ê®°ÊÄÅÊ°ÜËÉåÊôØÁÇπÂáª
                document.getElementById('fieldModal').addEventListener('click', (e) => {
                    if (e.target.id === 'fieldModal') {
                        this.closeModal();
                    }
                });
            },

            // ÊòæÁ§∫Ê∑ªÂä†Â≠óÊÆµÊ®°ÊÄÅÊ°Ü
            showAddFieldModal() {
                this.editingFieldIndex = -1;
                document.getElementById('modalTitle').textContent = 'Ê∑ªÂä†Â≠óÊÆµ';
                document.getElementById('fieldName').value = '';
                document.getElementById('fieldContent').value = '';
                document.getElementById('fieldModal').classList.add('show');
                document.getElementById('fieldName').focus();
            },

            // ÁºñËæëÂ≠óÊÆµ
            editField(index) {
                const field = this.fields[index];
                this.editingFieldIndex = index;
                document.getElementById('modalTitle').textContent = 'ÁºñËæëÂ≠óÊÆµ';
                document.getElementById('fieldName').value = field.name;
                document.getElementById('fieldContent').value = field.content || '';
                document.getElementById('fieldModal').classList.add('show');
                document.getElementById('fieldName').focus();
            },

            // Âà†Èô§Â≠óÊÆµ
            deleteField(index) {
                if (confirm(`Á°ÆÂÆöË¶ÅÂà†Èô§Â≠óÊÆµ"${this.fields[index].name}"ÂêóÔºü`)) {
                    const field = this.fields[index];
                    // Ê†áËÆ∞‰∏∫Âà†Èô§ËÄå‰∏çÊòØÁõ¥Êé•Âà†Èô§Ôºå‰ª•‰æøË∑üË∏™Êõ¥Êîπ
                    field.isDeleted = true;
                    this.hasChanges = true;
                    this.renderFields();
                    
                    // ÈÄöÁü•ÂéüÁîü‰ª£Á†Å
                    window.location.href = `mntask://deleteField?index=${index}&name=${encodeURIComponent(field.name)}`;
                }
            },

            // ‰øùÂ≠òÂ≠óÊÆµ
            saveField(event) {
                event.preventDefault();
                
                const name = document.getElementById('fieldName').value.trim();
                const content = document.getElementById('fieldContent').value.trim();
                
                if (!name) {
                    alert('Â≠óÊÆµÂêçÁß∞‰∏çËÉΩ‰∏∫Á©∫');
                    return;
                }

                // Ê£ÄÊµãÂ≠óÊÆµÁ±ªÂûã
                let fieldType = 'normal';
                let extraData = {};
                
                // Ê£ÄÊµãÊó•ÊúüÂ≠óÊÆµ
                if (name.includes('Êó•Êúü') || name.includes('Date')) {
                    fieldType = 'date';
                    // Â¶ÇÊûúÂÜÖÂÆπÊòØÊó•ÊúüÊ†ºÂºèÔºåÊèêÂèñÊó•Êúü
                    const dateMatch = content.match(/\d{4}-\d{2}-\d{2}/);
                    if (dateMatch) {
                        extraData.date = dateMatch[0];
                    }
                }
                // Ê£ÄÊµã‰ºòÂÖàÁ∫ßÂ≠óÊÆµ
                else if (name.includes('‰ºòÂÖàÁ∫ß') || name.includes('Priority')) {
                    fieldType = 'priority';
                    if (content.includes('È´ò') || content.includes('High')) {
                        extraData.priority = 'È´ò';
                    } else if (content.includes('‰∏≠') || content.includes('Medium')) {
                        extraData.priority = '‰∏≠';
                    } else if (content.includes('‰Ωé') || content.includes('Low')) {
                        extraData.priority = '‰Ωé';
                    }
                }
                // Ê£ÄÊµãÂêØÂä®ÈìæÊé•
                else if (name.includes('ÂêØÂä®') || name.includes('Launch') || name.includes('ÈìæÊé•')) {
                    fieldType = 'launch';
                    // Ê£ÄÊµãURL
                    const urlMatch = content.match(/(https?:\/\/[^\s]+|marginnote\d+app:\/\/[^\s]+)/);
                    if (urlMatch) {
                        extraData.url = urlMatch[0];
                        extraData.text = content.replace(urlMatch[0], '').trim() || name;
                    }
                }

                if (this.editingFieldIndex === -1) {
                    // Ê∑ªÂä†Êñ∞Â≠óÊÆµ
                    this.fields.push({ 
                        name, 
                        content,
                        isNew: true,
                        isDeleted: false,
                        originalIndex: undefined,
                        fieldType: fieldType,
                        ...extraData
                    });
                    // ÈÄöÁü•ÂéüÁîü‰ª£Á†Å
                    window.location.href = `mntask://addField?name=${encodeURIComponent(name)}&content=${encodeURIComponent(content)}&fieldType=${fieldType}`;
                } else {
                    // Êõ¥Êñ∞Áé∞ÊúâÂ≠óÊÆµ
                    const oldField = this.fields[this.editingFieldIndex];
                    this.fields[this.editingFieldIndex] = { 
                        ...oldField,
                        name, 
                        content,
                        fieldType: fieldType,
                        ...extraData
                    };
                    // ÈÄöÁü•ÂéüÁîü‰ª£Á†Å
                    window.location.href = `mntask://updateField?index=${this.editingFieldIndex}&name=${encodeURIComponent(name)}&content=${encodeURIComponent(content)}&oldName=${encodeURIComponent(oldField.name)}&fieldType=${fieldType}`;
                }

                this.hasChanges = true;
                this.renderFields();
                this.closeModal();
            },

            // ÂÖ≥Èó≠Ê®°ÊÄÅÊ°Ü
            closeModal() {
                document.getElementById('fieldModal').classList.remove('show');
                document.getElementById('fieldName').value = '';
                document.getElementById('fieldContent').value = '';
                this.editingFieldIndex = -1;
            },

            // Êõ¥Êñ∞‰ªªÂä°Êó•Êúü
            updateTaskDate() {
                const date = document.getElementById('taskDate').value;
                if (date) {
                    this.hasChanges = true;
                    window.location.href = `mntask://updateTaskDate?date=${encodeURIComponent(date)}`;
                    alert(`Â∑≤ËÆæÁΩÆ‰ªªÂä°Êó•Êúü‰∏∫: ${date}`);
                } else {
                    alert('ËØ∑ÈÄâÊã©‰∏Ä‰∏™Êó•Êúü');
                }
            },

            // Ê∏ÖÈô§‰ªªÂä°Êó•Êúü
            clearTaskDate() {
                if (confirm('Á°ÆÂÆöË¶ÅÊ∏ÖÈô§‰ªªÂä°Êó•ÊúüÂêóÔºü')) {
                    document.getElementById('taskDate').value = '';
                    this.hasChanges = true;
                    window.location.href = 'mntask://clearTaskDate';
                    alert('Â∑≤Ê∏ÖÈô§‰ªªÂä°Êó•Êúü');
                }
            },

            // ÂèñÊ∂àÁºñËæë
            cancelEdit() {
                if (this.hasChanges && !confirm('ÊúâÊú™‰øùÂ≠òÁöÑÊõ¥ÊîπÔºåÁ°ÆÂÆöË¶ÅÈÄÄÂá∫ÂêóÔºü')) {
                    return;
                }
                window.location.href = 'mntask://closeTaskEditor';
            },

            // ‰øùÂ≠òÊõ¥Êîπ
            saveChanges() {
                window.location.href = 'mntask://saveTaskChanges';
                alert('Êõ¥ÊîπÂ∑≤‰øùÂ≠ò');
                this.hasChanges = false;
            },

            // Ëé∑ÂèñÊõ¥ÊîπÁöÑÂ≠óÊÆµÊï∞ÊçÆ
            getChangedFields() {
                const changes = {
                    deletedFields: [],
                    updatedFields: [],
                    addedFields: [],
                    reorderedFields: []
                };

                // Ë∑üË∏™ÂéüÂßãÂ≠óÊÆµ‰ª•Ê£ÄÊµãÊõ¥Êîπ
                const originalFields = this.currentTask ? (this.currentTask.fields || []) : [];
                
                // Ê£ÄÊµãÂà†Èô§ÁöÑÂ≠óÊÆµ
                originalFields.forEach((origField, index) => {
                    const exists = this.fields.some(field => 
                        field.originalIndex === index && !field.isDeleted
                    );
                    if (!exists) {
                        changes.deletedFields.push(index);
                    }
                });

                // Ê£ÄÊµãÊõ¥Êñ∞ÂíåÊñ∞Â¢ûÁöÑÂ≠óÊÆµ
                this.fields.forEach((field, currentIndex) => {
                    if (field.isDeleted) return;

                    if (field.isNew) {
                        // Êñ∞Â¢ûÁöÑÂ≠óÊÆµ
                        changes.addedFields.push({
                            content: field.content || field.name,
                            isMainField: field.isMainField || false,
                            fieldType: field.fieldType || 'normal',
                            priority: field.priority,
                            date: field.date,
                            url: field.url,
                            text: field.text
                        });
                    } else if (field.originalIndex !== undefined) {
                        // Ê£ÄÊü•ÊòØÂê¶Êõ¥Êñ∞
                        const origField = originalFields[field.originalIndex];
                        if (origField && (
                            origField.name !== field.name || 
                            origField.content !== field.content
                        )) {
                            changes.updatedFields.push({
                                index: field.originalIndex,
                                content: field.content || field.name,
                                isMainField: field.isMainField || false
                            });
                        }

                        // Ê£ÄÊü•ÊòØÂê¶ÈáçÊñ∞ÊéíÂ∫è
                        if (field.originalIndex !== currentIndex) {
                            changes.reorderedFields.push({
                                from: field.originalIndex,
                                to: currentIndex
                            });
                        }
                    }
                });

                return changes;
            }
        };

        // ÂÖ®Â±ÄÂáΩÊï∞‰æõÂéüÁîü‰ª£Á†ÅË∞ÉÁî®
        function showAddFieldModal() {
            taskEditor.showAddFieldModal();
        }

        function saveField(event) {
            taskEditor.saveField(event);
        }

        function closeModal() {
            taskEditor.closeModal();
        }

        function updateTaskDate() {
            taskEditor.updateTaskDate();
        }

        function clearTaskDate() {
            taskEditor.clearTaskDate();
        }

        function cancelEdit() {
            taskEditor.cancelEdit();
        }

        function saveChanges() {
            taskEditor.saveChanges();
        }

        // ‰æõÂéüÁîü‰ª£Á†ÅË∞ÉÁî®ÁöÑÂä†ËΩΩÂáΩÊï∞
        function loadTaskFromPlugin(encodedTask) {
            taskEditor.loadTask(encodedTask);
        }

        // ÂàùÂßãÂåñ
        document.addEventListener('DOMContentLoaded', () => {
            taskEditor.init();
        });
        
        // Â∞Ü taskEditor Êö¥Èú≤ÁªôÂÖ®Â±ÄÔºå‰ª•‰æøÂéüÁîü‰ª£Á†ÅËÆøÈóÆ
        window.taskEditor = taskEditor;
        
        // ÁõëÂê¨Êù•Ëá™Áà∂Á™óÂè£ÁöÑÊ∂àÊÅØ
        window.addEventListener('message', function(event) {
            if (event.data && event.data.type === 'getChangedFields') {
                // Ëé∑ÂèñÊõ¥ÊîπÁöÑÂ≠óÊÆµÊï∞ÊçÆ
                const changes = taskEditor.getChangedFields();
                
                // ÂèëÈÄÅÂìçÂ∫î
                event.source.postMessage({
                    type: 'changedFields',
                    requestId: event.data.requestId,
                    changes: changes
                }, '*');
            }
        });
    </script>
</body>
</html>