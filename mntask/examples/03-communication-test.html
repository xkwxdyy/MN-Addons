<!DOCTYPE html>
<html>
<head>
    <title>通信测试</title>
    <meta charset="UTF-8">
    <style>
        body {
            font-family: Arial;
            padding: 20px;
            text-align: center;
            background-color: #f5f5f5;
        }
        
        .container {
            max-width: 500px;
            margin: 0 auto;
            background: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        
        button {
            background-color: #007aff;
            color: white;
            padding: 12px 24px;
            border: none;
            border-radius: 6px;
            font-size: 16px;
            cursor: pointer;
            margin: 10px;
            transition: background-color 0.3s;
        }
        
        button:hover {
            background-color: #0051d5;
        }
        
        .message-box {
            margin-top: 20px;
            padding: 15px;
            background-color: #f0f0f0;
            border-radius: 8px;
            min-height: 50px;
        }
        
        .log {
            text-align: left;
            margin-top: 20px;
            padding: 10px;
            background-color: #f9f9f9;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-family: monospace;
            font-size: 12px;
            max-height: 200px;
            overflow-y: auto;
        }
        
        .log-entry {
            margin: 5px 0;
            padding: 5px;
            background-color: white;
            border-radius: 3px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>📡 通信测试页面</h1>
        <p>这个页面演示网页如何与插件通信</p>
        
        <h3>1. 发送消息到插件</h3>
        <button onclick="sendToPlugin('打招呼')">👋 打招呼</button>
        <button onclick="sendToPlugin('请求数据')">📊 请求数据</button>
        <button onclick="sendToPlugin('保存设置')">💾 保存设置</button>
        
        <h3>2. 接收插件的消息</h3>
        <div class="message-box" id="messageBox">
            等待插件的消息...
        </div>
        
        <h3>3. 通信日志</h3>
        <div class="log" id="log"></div>
    </div>
    
    <script>
        // =====================================
        // 📚 通信测试页面 - 学习笔记
        // 
        // 这个页面展示了网页与插件通信的基本原理
        // 在真实的插件环境中运行时：
        // 1. 点击按钮会发送 URL Scheme 到插件
        // 2. 插件会调用我们的函数返回数据
        // 
        // 在浏览器中测试时：
        // - 我们模拟了插件的响应
        // - 可以看到通信的完整流程
        // =====================================
        
        // 添加日志的函数
        function addLog(message, type = 'info') {
            const log = document.getElementById('log');
            const time = new Date().toLocaleTimeString();
            const entry = document.createElement('div');
            entry.className = 'log-entry';
            
            // 根据类型选择图标
            const icon = type === 'send' ? '📤' : '📥';
            
            entry.innerHTML = `${icon} [${time}] ${message}`;
            log.appendChild(entry);
            
            // 自动滚动到底部
            log.scrollTop = log.scrollHeight;
        }
        
        // 发送消息到插件
        function sendToPlugin(action) {
            // 记录日志
            addLog(`发送消息: ${action}`, 'send');
            
            // 构造特殊的 URL
            // mntask:// 是我们的自定义协议
            // 插件会拦截这种 URL
            const url = `mntask://${action}?time=${Date.now()}`;
            
            // 显示 URL（帮助理解）
            console.log('构造的 URL:', url);
            
            // 发送（在真实插件中，这会被插件拦截）
            window.location.href = url;
            
            // 模拟效果（仅用于演示）
            // 在真实环境中，插件会调用 receiveFromPlugin
            setTimeout(() => {
                simulatePluginResponse(action);
            }, 1000);
        }
        
        // 接收插件的消息
        // 这个函数会被插件调用
        function receiveFromPlugin(message) {
            // 记录日志
            addLog(`收到消息: ${message}`, 'receive');
            
            // 更新显示
            const messageBox = document.getElementById('messageBox');
            messageBox.innerHTML = `✅ 收到插件消息：<br><strong>${message}</strong>`;
            
            // 添加动画效果
            messageBox.style.transform = 'scale(1.05)';
            setTimeout(() => {
                messageBox.style.transform = 'scale(1)';
            }, 200);
        }
        
        // 模拟插件响应（仅用于演示）
        function simulatePluginResponse(action) {
            let response = '';
            
            switch(action) {
                case '打招呼':
                    response = '你好！我是插件，很高兴认识你！';
                    break;
                case '请求数据':
                    response = '这是任务数据：[任务1, 任务2, 任务3]';
                    break;
                case '保存设置':
                    response = '设置已保存成功！';
                    break;
                default:
                    response = '未知的命令：' + action;
            }
            
            // 调用接收函数，模拟插件调用
            receiveFromPlugin(response);
        }
        
        // 页面加载完成
        window.onload = function() {
            addLog('页面加载完成，准备通信', 'info');
            
            // 显示提示
            console.log('💡 提示：打开控制台查看更多信息');
            console.log('📌 在真实插件环境中，URL Scheme 会被插件拦截');
            console.log('🎯 试试在控制台输入: receiveFromPlugin("来自控制台的消息")');
        };
        
        // =====================================
        // 🎓 学习要点：
        // 
        // 1. URL Scheme 通信（网页→插件）
        //    - 使用 window.location.href = 'mntask://...'
        //    - 插件会拦截这种特殊的 URL
        //    - 可以传递参数，如 ?action=save&data=123
        // 
        // 2. JavaScript 注入（插件→网页）
        //    - 插件调用 webView.evaluateJavaScript()
        //    - 执行网页中的函数，如 receiveFromPlugin()
        //    - 可以传递数据作为函数参数
        // 
        // 3. 通信流程
        //    - 用户操作 → 网页发送 URL → 插件处理
        //    - 插件处理 → 调用 JS → 网页更新
        // =====================================
    </script>
</body>
</html>