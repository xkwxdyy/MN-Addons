# ğŸŒ‰ MarginNote æ’ä»¶å¼€å‘ï¼šHTML ä¸å¡ç‰‡æ•°æ®ä¼ è¾“å®Œå…¨æŒ‡å—

> æœ¬æ•™ç¨‹ä¸“ä¸º MarginNote æ’ä»¶å¼€å‘æ–°æ‰‹è®¾è®¡ï¼Œæ‰‹æŠŠæ‰‹æ•™ä½ å¦‚ä½•åœ¨ HTML é¡µé¢å’Œ MarginNote å¡ç‰‡ä¹‹é—´å»ºç«‹æ•°æ®é€šé“ï¼Œå®ç°åŒå‘æ•°æ®ä¼ è¾“ã€‚

## ğŸ“š æ•™ç¨‹ç»“æ„

æœ¬æ•™ç¨‹åˆ†ä¸ºä»¥ä¸‹å‡ ä¸ªéƒ¨åˆ†ï¼Œå¾ªåºæ¸è¿›ï¼š

1. **ç†è§£æ•°æ®ä¼ è¾“çš„æ„ä¹‰** - ä¸ºä»€ä¹ˆéœ€è¦ HTML ä¸å¡ç‰‡è¿æ¥
2. **åŸºç¡€æ¦‚å¿µé€Ÿæˆ** - å¿«é€Ÿäº†è§£å¿…è¦çš„æŠ€æœ¯æ¦‚å¿µ
3. **å•å‘ä¼ è¾“ï¼šHTML â†’ å¡ç‰‡** - ä»ç½‘é¡µæå–æ•°æ®åˆ°å¡ç‰‡
4. **å•å‘ä¼ è¾“ï¼šå¡ç‰‡ â†’ HTML** - ä»å¡ç‰‡å‘é€æ•°æ®åˆ°ç½‘é¡µ
5. **åŒå‘é€šä¿¡å®æˆ˜** - å®ç°å®Œæ•´çš„åŒå‘æ•°æ®äº¤äº’
6. **è¿›é˜¶æŠ€å·§** - å›¾ç‰‡ã€è§†é¢‘ç­‰å¤æ‚æ•°æ®å¤„ç†
7. **å®Œæ•´é¡¹ç›®å®æˆ˜** - åšä¸€ä¸ªå®ç”¨çš„åŠŸèƒ½
8. **å¸¸è§é—®é¢˜ä¸è°ƒè¯•** - è§£å†³å¼€å‘ä¸­çš„é—®é¢˜

---

## ç¬¬ä¸€éƒ¨åˆ†ï¼šç†è§£æ•°æ®ä¼ è¾“çš„æ„ä¹‰

### ğŸ¤” ä¸ºä»€ä¹ˆéœ€è¦ HTML ä¸å¡ç‰‡çš„è¿æ¥ï¼Ÿ

æƒ³è±¡ä¸€ä¸‹è¿™äº›åœºæ™¯ï¼š

1. **åœ¨çº¿è§†é¢‘å­¦ä¹ **
   - ä½ åœ¨ B ç«™çœ‹æ•™å­¦è§†é¢‘
   - æƒ³æŠŠæŸä¸ªé‡è¦æ—¶åˆ»çš„ç”»é¢å’Œç¬”è®°ä¿å­˜åˆ° MarginNote
   - ä¼ ç»Ÿæ–¹æ³•ï¼šæˆªå›¾ â†’ ä¿å­˜ â†’ å¯¼å…¥ â†’ æ·»åŠ ç¬”è®°ï¼ˆå¤ªéº»çƒ¦ï¼ï¼‰
   - æœ‰äº†æ•°æ®ä¼ è¾“ï¼šä¸€é”®å®Œæˆï¼

2. **ç½‘é¡µå†…å®¹æ”¶é›†**
   - æµè§ˆç»´åŸºç™¾ç§‘æˆ–æŠ€æœ¯æ–‡æ¡£
   - æƒ³æŠŠé‡è¦æ®µè½æ”¶é›†åˆ°ç¬”è®°ä¸­
   - ä¼ ç»Ÿæ–¹æ³•ï¼šå¤åˆ¶ â†’ ç²˜è´´ â†’ æ ¼å¼è°ƒæ•´ï¼ˆæ ¼å¼ç»å¸¸ä¹±æ‰ï¼‰
   - æœ‰äº†æ•°æ®ä¼ è¾“ï¼šä¿ç•™åŸå§‹æ ¼å¼ï¼Œè‡ªåŠ¨æ•´ç†ï¼

3. **AI è¾…åŠ©å­¦ä¹ **
   - æƒ³ç”¨ AI è§£é‡ŠæŸä¸ªæ¦‚å¿µ
   - ä¼ ç»Ÿæ–¹æ³•ï¼šå¤åˆ¶åˆ° AI â†’ å¾—åˆ°ç­”æ¡ˆ â†’ å†å¤åˆ¶å›æ¥
   - æœ‰äº†æ•°æ®ä¼ è¾“ï¼šåœ¨æ’ä»¶å†…ç›´æ¥å®Œæˆï¼

### ğŸ¯ æ•°æ®ä¼ è¾“èƒ½å®ç°ä»€ä¹ˆï¼Ÿ

é€šè¿‡å»ºç«‹ HTML ä¸å¡ç‰‡çš„æ•°æ®é€šé“ï¼Œä½ å¯ä»¥ï¼š

#### 1. æ•°æ®é‡‡é›†åŠŸèƒ½
```
ç½‘é¡µ â†’ æ’ä»¶ â†’ å¡ç‰‡
```
- ğŸ“ æå–ç½‘é¡µæ–‡å­—å¹¶åˆ›å»ºç¬”è®°
- ğŸ–¼ï¸ ä¿å­˜ç½‘é¡µå›¾ç‰‡åˆ°å¡ç‰‡
- ğŸ¥ æˆªå–è§†é¢‘ç”»é¢ä½œä¸ºç¬”è®°
- ğŸ”— ä¿å­˜åŸå§‹é“¾æ¥å’Œæ—¶é—´æˆ³

#### 2. æ•°æ®å±•ç¤ºåŠŸèƒ½
```
å¡ç‰‡ â†’ æ’ä»¶ â†’ ç½‘é¡µ
```
- ğŸ“Š åœ¨ç½‘é¡µä¸­å±•ç¤ºç¬”è®°ç»Ÿè®¡
- ğŸ” å®ç°ç¬”è®°å†…å®¹æœç´¢
- ğŸ“ˆ å¯è§†åŒ–å­¦ä¹ è¿›åº¦
- ğŸ¨ è‡ªå®šä¹‰ç¬”è®°å±•ç¤ºæ ·å¼

#### 3. åŒå‘äº¤äº’åŠŸèƒ½
```
å¡ç‰‡ âŸ· æ’ä»¶ âŸ· ç½‘é¡µ
```
- âœï¸ åœ¨ç½‘é¡µä¸­ç¼–è¾‘ï¼ŒåŒæ­¥åˆ°å¡ç‰‡
- ğŸ”„ å¡ç‰‡ä¿®æ”¹åï¼Œç½‘é¡µå®æ—¶æ›´æ–°
- ğŸ¤– AI å¤„ç†åçš„å†…å®¹ç›´æ¥ä¿å­˜
- ğŸ“± å®ç°ç±»ä¼¼"åº”ç”¨"çš„äº¤äº’ä½“éªŒ

### ğŸ’¡ çœŸå®æ¡ˆä¾‹å±•ç¤º

è®©æˆ‘ä»¬çœ‹çœ‹ MNBrowser æ’ä»¶æ˜¯å¦‚ä½•å®ç°è¿™äº›åŠŸèƒ½çš„ï¼š

#### æ¡ˆä¾‹ 1ï¼šB ç«™è§†é¢‘ç¬”è®°
å½“ä½ åœ¨çœ‹è§†é¢‘æ—¶ï¼Œæ’ä»¶å¯ä»¥ï¼š
1. è·å–å½“å‰è§†é¢‘çš„æ—¶é—´æˆ³
2. æˆªå–å½“å‰ç”»é¢
3. æå–è§†é¢‘æ ‡é¢˜å’Œé“¾æ¥
4. ä¸€é”®åˆ›å»ºåŒ…å«æ‰€æœ‰ä¿¡æ¯çš„å¡ç‰‡

#### æ¡ˆä¾‹ 2ï¼šç½‘é¡µæ–‡æœ¬æ”¶é›†
é€‰ä¸­ç½‘é¡µæ–‡å­—åï¼Œæ’ä»¶å¯ä»¥ï¼š
1. è·å–é€‰ä¸­çš„æ–‡æœ¬
2. ä¿ç•™æ–‡æœ¬çš„æ ¼å¼ï¼ˆç²—ä½“ã€æ–œä½“ç­‰ï¼‰
3. è‡ªåŠ¨æ·»åŠ æ¥æºä¿¡æ¯
4. åˆ›å»ºæ ¼å¼ä¼˜ç¾çš„å¡ç‰‡

### ğŸš€ å¼€å§‹å‰çš„å‡†å¤‡

åœ¨æ·±å…¥æŠ€æœ¯ç»†èŠ‚ä¹‹å‰ï¼Œè®©æˆ‘ä»¬ç¡®ä¿ä½ ç†è§£æ•´ä¸ªæ•°æ®æµï¼š

```
ç”¨æˆ·æ“ä½œ
    â†“
HTML é¡µé¢ï¼ˆå‰ç«¯ï¼‰
    â†“
JavaScript æ¡¥æ¥å±‚
    â†“
æ’ä»¶æ§åˆ¶å™¨ï¼ˆåç«¯ï¼‰
    â†“
MarginNote API
    â†“
ç¬”è®°å¡ç‰‡
```

æ¯ä¸€å±‚éƒ½æœ‰å…¶ä½œç”¨ï¼š
- **HTML é¡µé¢**ï¼šç”¨æˆ·çœ‹åˆ°å’Œæ“ä½œçš„ç•Œé¢
- **JavaScript**ï¼šå¤„ç†ç”¨æˆ·æ“ä½œï¼Œå‡†å¤‡æ•°æ®
- **æ’ä»¶æ§åˆ¶å™¨**ï¼šæ¥æ”¶æ•°æ®ï¼Œè°ƒç”¨ MN API
- **MarginNote API**ï¼šå®é™…åˆ›å»ºå’Œä¿®æ”¹å¡ç‰‡

### ğŸ“‹ æœ¬ç« å°ç»“

é€šè¿‡ HTML ä¸å¡ç‰‡çš„æ•°æ®ä¼ è¾“ï¼Œæˆ‘ä»¬å¯ä»¥ï¼š
1. âœ… å¤§å¹…æå‡ç¬”è®°æ•ˆç‡
2. âœ… å®ç°è‡ªåŠ¨åŒ–æ“ä½œ
3. âœ… åˆ›å»ºæ›´ä¸°å¯Œçš„äº¤äº’ä½“éªŒ
4. âœ… æ•´åˆå¤–éƒ¨æœåŠ¡ï¼ˆå¦‚ AIï¼‰

ä¸‹ä¸€ç« ï¼Œæˆ‘ä»¬å°†å­¦ä¹ å®ç°è¿™äº›åŠŸèƒ½æ‰€éœ€çš„åŸºç¡€æ¦‚å¿µã€‚å¦‚æœä½ å·²ç»è¿«ä¸åŠå¾…æƒ³è¦å¼€å§‹ç¼–ç ï¼Œå¯ä»¥ç›´æ¥è·³åˆ°ç¬¬ä¸‰éƒ¨åˆ†çš„å®æˆ˜å†…å®¹ï¼

---

> ğŸ’¡ **å­¦ä¹ å»ºè®®**ï¼šä¸è¦è¯•å›¾ä¸€æ¬¡ç†è§£æ‰€æœ‰å†…å®¹ã€‚å…ˆæœ‰ä¸ªæ•´ä½“æ¦‚å¿µï¼Œç„¶åé€šè¿‡å®è·µé€æ­¥æ·±å…¥ã€‚è®°ä½ï¼Œæœ€å¥½çš„å­¦ä¹ æ–¹æ³•æ˜¯åŠ¨æ‰‹åšï¼

---

## ç¬¬äºŒéƒ¨åˆ†ï¼šåŸºç¡€æ¦‚å¿µé€Ÿæˆ

### ğŸŒ ä»€ä¹ˆæ˜¯ WebViewï¼Ÿ

æƒ³è±¡ä¸€ä¸‹ï¼ŒWebView å°±åƒæ˜¯åœ¨ä½ çš„æ’ä»¶é‡ŒåµŒå…¥äº†ä¸€ä¸ªè¿·ä½ æµè§ˆå™¨ï¼š

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   MarginNote æ’ä»¶    â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚   WebView     â”‚  â”‚ â† è¿™é‡Œå¯ä»¥æ˜¾ç¤ºç½‘é¡µï¼
â”‚  â”‚ æ˜¾ç¤º HTML å†…å®¹ â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚  [æ’ä»¶çš„å…¶ä»–éƒ¨åˆ†]    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

#### WebView çš„ç‰¹ç‚¹ï¼š
- ğŸŒ å¯ä»¥åŠ è½½ä»»ä½•ç½‘é¡µï¼ˆæœ¬åœ°æˆ–åœ¨çº¿ï¼‰
- ğŸ¨ æ”¯æŒå®Œæ•´çš„ HTML/CSS/JavaScript
- ğŸ”— å¯ä»¥ä¸æ’ä»¶åŸç”Ÿä»£ç é€šä¿¡
- ğŸ“± åœ¨ iOS ä¸­ä½¿ç”¨ UIWebView æˆ– WKWebView

### ğŸŒ‰ JavaScript æ¡¥æ¥ - ä¸¤ä¸ªä¸–ç•Œçš„å¯¹è¯

æ’ä»¶ä»£ç ï¼ˆObjective-C/JavaScriptï¼‰å’Œç½‘é¡µä»£ç ï¼ˆJavaScriptï¼‰æ˜¯ä¸¤ä¸ªä¸åŒçš„ä¸–ç•Œï¼Œå®ƒä»¬éœ€è¦ä¸€ä¸ª"æ¡¥æ¢"æ¥é€šä¿¡ï¼š

```javascript
// æ’ä»¶ä¸–ç•Œï¼ˆåŸç”Ÿ JavaScriptï¼‰
let selectedText = await webview.evaluateJavaScript(`
    // ç½‘é¡µä¸–ç•Œï¼ˆç½‘é¡µ JavaScriptï¼‰
    window.getSelection().toString()
`)
```

è¿™å°±åƒæ˜¯ï¼š
- æ’ä»¶ä¸–ç•Œè¯´ï¼š"å˜¿ï¼Œç½‘é¡µï¼Œå‘Šè¯‰æˆ‘ç”¨æˆ·é€‰ä¸­äº†ä»€ä¹ˆæ–‡å­—"
- ç½‘é¡µä¸–ç•Œå›ç­”ï¼š"ç”¨æˆ·é€‰ä¸­äº†'Hello World'"
- æ’ä»¶ä¸–ç•Œæ”¶åˆ°ç­”æ¡ˆå¹¶å¤„ç†

### ğŸ”‘ æ ¸å¿ƒæ–¹æ³•ï¼ševaluateJavaScript

è¿™æ˜¯æœ€é‡è¦çš„æ–¹æ³•ï¼Œå®ƒè®©æ’ä»¶èƒ½å¤Ÿåœ¨ç½‘é¡µä¸­æ‰§è¡Œ JavaScript ä»£ç ï¼š

```javascript
// åŸºæœ¬ç”¨æ³•
let result = await this.webview.evaluateJavaScript(`1 + 1`)
console.log(result) // è¾“å‡º: 2

// è·å–ç½‘é¡µæ ‡é¢˜
let title = await this.webview.evaluateJavaScript(`document.title`)

// è·å–æ‰€æœ‰å›¾ç‰‡
let images = await this.webview.evaluateJavaScript(`
    Array.from(document.images).map(img => img.src)
`)
```

#### é‡è¦æç¤ºï¼š
1. âš ï¸ ä»£ç åœ¨ç½‘é¡µç¯å¢ƒä¸­æ‰§è¡Œï¼Œä¸èƒ½è®¿é—®æ’ä»¶å˜é‡
2. âš ï¸ è¿”å›å€¼å¿…é¡»æ˜¯å¯åºåˆ—åŒ–çš„ï¼ˆå­—ç¬¦ä¸²ã€æ•°å­—ã€æ•°ç»„ã€å¯¹è±¡ï¼‰
3. âš ï¸ ä½¿ç”¨åå¼•å· ` ` å¯ä»¥å†™å¤šè¡Œä»£ç 

### ğŸ“¡ URL Scheme - ç½‘é¡µä¸»åŠ¨è”ç³»æ’ä»¶

é™¤äº†æ’ä»¶ä¸»åŠ¨è¯¢é—®ç½‘é¡µï¼Œç½‘é¡µä¹Ÿå¯ä»¥ä¸»åŠ¨è”ç³»æ’ä»¶ï¼Œé€šè¿‡ URL Schemeï¼š

```javascript
// åœ¨ç½‘é¡µä¸­
window.location.href = "browser://action?data=hello"

// åœ¨æ’ä»¶ä¸­æ¥æ”¶
webViewDidFinishLoad: function(webView) {
    let url = webView.request.URL.absoluteString
    if (url.startsWith("browser://")) {
        // å¤„ç†æ¥è‡ªç½‘é¡µçš„è¯·æ±‚
        let action = this.parseURL(url)
        this.handleAction(action)
    }
}
```

å¸¸è§çš„ URL Scheme æ¨¡å¼ï¼š
- `browser://copy?text=xxx` - å¤åˆ¶æ–‡æœ¬
- `browser://screenshot` - æˆªå›¾
- `browser://close` - å…³é—­çª—å£

### ğŸ¯ ç®€å•ç¤ºä¾‹ï¼šè·å–ç½‘é¡µæ ‡é¢˜å¹¶åˆ›å»ºå¡ç‰‡

è®©æˆ‘ä»¬é€šè¿‡ä¸€ä¸ªå®Œæ•´ä½†ç®€å•çš„ä¾‹å­æ¥ç†è§£æ•´ä¸ªæµç¨‹ï¼š

```javascript
// æ­¥éª¤ 1ï¼šåœ¨æ’ä»¶ä¸­è·å–ç½‘é¡µæ ‡é¢˜
async function getTitleAndCreateCard() {
    // æ‰§è¡Œç½‘é¡µ JavaScriptï¼Œè·å–æ ‡é¢˜
    let title = await this.webview.evaluateJavaScript(`
        document.title
    `)
    
    // æ­¥éª¤ 2ï¼šä½¿ç”¨ MNUtil åˆ›å»ºå¡ç‰‡
    if (title) {
        // è·å–å½“å‰ç¬”è®°æœ¬
        let currentNotebook = MNUtil.currentDocController.notebook
        
        // åˆ›å»ºæ–°å¡ç‰‡
        let newNote = MNUtil.createNote(currentNotebook)
        
        // è®¾ç½®å¡ç‰‡æ ‡é¢˜
        newNote.noteTitle = title
        
        // æ·»åŠ åˆ°ç¬”è®°æœ¬
        MNUtil.addNoteToDocument(newNote, currentNotebook)
        
        console.log("âœ… æˆåŠŸåˆ›å»ºå¡ç‰‡ï¼š" + title)
    }
}
```

### ğŸ”„ æ•°æ®ç±»å‹è½¬æ¢

åœ¨ä¼ è¾“æ•°æ®æ—¶ï¼Œéœ€è¦æ³¨æ„æ•°æ®ç±»å‹çš„è½¬æ¢ï¼š

```javascript
// 1. ç®€å•ç±»å‹ - ç›´æ¥ä¼ è¾“
let text = await webview.evaluateJavaScript(`"Hello"`) // å­—ç¬¦ä¸²
let number = await webview.evaluateJavaScript(`42`)     // æ•°å­—
let bool = await webview.evaluateJavaScript(`true`)     // å¸ƒå°”å€¼

// 2. å¤æ‚ç±»å‹ - éœ€è¦åºåˆ—åŒ–
let data = await webview.evaluateJavaScript(`
    JSON.stringify({
        title: document.title,
        url: window.location.href,
        time: new Date().toISOString()
    })
`)
let parsed = JSON.parse(data) // è§£ææˆå¯¹è±¡

// 3. ç‰¹æ®Šç±»å‹ - Base64 ç¼–ç 
let imageData = await webview.evaluateJavaScript(`
    // å°†å›¾ç‰‡è½¬ä¸º Base64
    let img = document.querySelector('img')
    let canvas = document.createElement('canvas')
    canvas.width = img.width
    canvas.height = img.height
    let ctx = canvas.getContext('2d')
    ctx.drawImage(img, 0, 0)
    canvas.toDataURL('image/png')
`)
```

### ğŸ“‹ æœ¬ç« å°ç»“

ç°åœ¨ä½ å·²ç»äº†è§£äº†ï¼š
1. âœ… WebView æ˜¯åµŒå…¥çš„ç½‘é¡µæµè§ˆå™¨
2. âœ… evaluateJavaScript è®©æ’ä»¶æ‰§è¡Œç½‘é¡µä»£ç 
3. âœ… URL Scheme è®©ç½‘é¡µä¸»åŠ¨è”ç³»æ’ä»¶
4. âœ… æ•°æ®éœ€è¦æ­£ç¡®çš„ç±»å‹è½¬æ¢

æœ‰äº†è¿™äº›åŸºç¡€çŸ¥è¯†ï¼Œæˆ‘ä»¬å°±å¯ä»¥å¼€å§‹å®æˆ˜äº†ï¼

---

## ç¬¬ä¸‰éƒ¨åˆ†ï¼šå•å‘ä¼ è¾“ HTML â†’ å¡ç‰‡

### ğŸ¯ æœ¬ç« ç›®æ ‡

å­¦å®Œæœ¬ç« ï¼Œä½ å°†èƒ½å¤Ÿï¼š
- ä»ç½‘é¡µæå–å„ç§æ•°æ®ï¼ˆæ–‡æœ¬ã€å›¾ç‰‡ã€è§†é¢‘ï¼‰
- å°†æ•°æ®è½¬æ¢ä¸ºåˆé€‚çš„æ ¼å¼
- åˆ›å»ºåŒ…å«è¿™äº›æ•°æ®çš„å¡ç‰‡
- å¤„ç†å„ç§è¾¹ç•Œæƒ…å†µ

### ğŸ“ æå–ç½‘é¡µæ–‡æœ¬

#### 1. è·å–ç”¨æˆ·é€‰ä¸­çš„æ–‡æœ¬

è¿™æ˜¯æœ€å¸¸è§çš„éœ€æ±‚ï¼Œç”¨æˆ·é€‰ä¸­ä¸€æ®µæ–‡å­—åæå–ï¼š

```javascript
// åœ¨ webviewController.js ä¸­
async getSelectedText() {
    let selectedText = await this.webview.evaluateJavaScript(`
        // è·å–é€‰ä¸­çš„æ–‡æœ¬
        let selection = window.getSelection()
        let text = selection.toString()
        
        // å¦‚æœæ²¡æœ‰é€‰ä¸­æ–‡æœ¬ï¼Œè¿”å›ç©º
        if (!text) {
            ''
        } else {
            // è¿”å›é€‰ä¸­çš„æ–‡æœ¬å’Œä¸€äº›é¢å¤–ä¿¡æ¯
            JSON.stringify({
                text: text,
                html: selection.rangeCount > 0 ? 
                      selection.getRangeAt(0).cloneContents().textContent : '',
                url: window.location.href,
                title: document.title
            })
        }
    `)
    
    // è§£æè¿”å›çš„æ•°æ®
    if (selectedText) {
        return JSON.parse(selectedText)
    }
    return null
}

// ä½¿ç”¨ç¤ºä¾‹
async function createNoteFromSelection() {
    let data = await this.getSelectedText()
    if (data && data.text) {
        // åˆ›å»ºå¡ç‰‡
        let note = MNUtil.createNote(MNUtil.currentNotebook)
        note.noteTitle = data.text.substring(0, 50) // å‰50ä¸ªå­—ç¬¦ä½œä¸ºæ ‡é¢˜
        note.noteText = data.text
        
        // æ·»åŠ æ¥æºä¿¡æ¯ä½œä¸ºè¯„è®º
        note.appendMarkdownComment(`æ¥æºï¼š[${data.title}](${data.url})`)
        
        MNUtil.showHUD("âœ… å·²åˆ›å»ºå¡ç‰‡")
    }
}
```

#### 2. è·å–ç‰¹å®šå…ƒç´ çš„å†…å®¹

æœ‰æ—¶æˆ‘ä»¬éœ€è¦è·å–ç‰¹å®šçš„å†…å®¹ï¼Œæ¯”å¦‚æ–‡ç« æ ‡é¢˜ã€ä½œè€…ç­‰ï¼š

```javascript
async getArticleInfo() {
    let info = await this.webview.evaluateJavaScript(`
        // å°è¯•å¤šç§æ–¹å¼è·å–æ ‡é¢˜
        let title = document.querySelector('h1')?.innerText || 
                   document.querySelector('.article-title')?.innerText ||
                   document.title
        
        // è·å–ä½œè€…ï¼ˆæ ¹æ®ç½‘ç«™ç»“æ„è°ƒæ•´é€‰æ‹©å™¨ï¼‰
        let author = document.querySelector('.author')?.innerText ||
                    document.querySelector('[class*="author"]')?.innerText ||
                    'æœªçŸ¥ä½œè€…'
        
        // è·å–å‘å¸ƒæ—¶é—´
        let time = document.querySelector('.publish-time')?.innerText ||
                   document.querySelector('time')?.innerText ||
                   new Date().toLocaleDateString()
        
        // è·å–æ­£æ–‡
        let content = document.querySelector('article')?.innerText ||
                     document.querySelector('.content')?.innerText ||
                     document.body.innerText
        
        JSON.stringify({
            title: title,
            author: author,
            time: time,
            content: content.substring(0, 1000), // é™åˆ¶é•¿åº¦
            url: window.location.href
        })
    `)
    
    return JSON.parse(info)
}
```

### ğŸ–¼ï¸ æå–ç½‘é¡µå›¾ç‰‡

#### 1. è·å–å•å¼ å›¾ç‰‡

```javascript
async getImageAsBase64(imageUrl) {
    let base64 = await this.webview.evaluateJavaScript(`
        new Promise((resolve) => {
            let img = new Image()
            img.crossOrigin = 'anonymous' // å¤„ç†è·¨åŸŸ
            img.onload = function() {
                // åˆ›å»º canvas
                let canvas = document.createElement('canvas')
                canvas.width = this.width
                canvas.height = this.height
                
                // ç»˜åˆ¶å›¾ç‰‡
                let ctx = canvas.getContext('2d')
                ctx.drawImage(this, 0, 0)
                
                // è½¬ä¸º Base64
                let dataURL = canvas.toDataURL('image/png')
                resolve(dataURL)
            }
            img.onerror = function() {
                resolve(null)
            }
            img.src = '${imageUrl}'
        })
    `)
    
    return base64
}

// åˆ›å»ºåŒ…å«å›¾ç‰‡çš„å¡ç‰‡
async function createImageNote(imageUrl) {
    let base64 = await this.getImageAsBase64(imageUrl)
    if (base64) {
        let note = MNUtil.createNote(MNUtil.currentNotebook)
        note.noteTitle = "ç½‘é¡µå›¾ç‰‡"
        
        // ä½¿ç”¨ Markdown æ ¼å¼æ’å…¥å›¾ç‰‡
        note.appendMarkdownComment(`![image](${base64})`)
        
        // æ·»åŠ åŸå§‹é“¾æ¥
        note.appendTextComment(`åŸå§‹é“¾æ¥ï¼š${imageUrl}`)
    }
}
```

#### 2. æ‰¹é‡è·å–é¡µé¢æ‰€æœ‰å›¾ç‰‡

```javascript
async getAllImages() {
    let images = await this.webview.evaluateJavaScript(`
        // è·å–æ‰€æœ‰å›¾ç‰‡å…ƒç´ 
        let imgs = Array.from(document.querySelectorAll('img'))
        
        // è¿‡æ»¤å¹¶è·å–ä¿¡æ¯
        imgs.filter(img => img.src && img.width > 100) // è¿‡æ»¤å°å›¾ç‰‡
            .map(img => ({
                src: img.src,
                alt: img.alt || 'æ— æè¿°',
                width: img.width,
                height: img.height
            }))
    `)
    
    return images
}
```

### ğŸ¥ å¤„ç†è§†é¢‘æˆªå›¾

è¿™æ˜¯ MNBrowser çš„ç‰¹è‰²åŠŸèƒ½ï¼Œè®©æˆ‘ä»¬çœ‹çœ‹å¦‚ä½•å®ç°ï¼š

```javascript
async captureVideoFrame() {
    let videoInfo = await this.webview.evaluateJavaScript(`
        // æŸ¥æ‰¾è§†é¢‘å…ƒç´ 
        let video = document.querySelector('video')
        if (!video) {
            null
        } else {
            // åˆ›å»º canvas æˆªå›¾
            let canvas = document.createElement('canvas')
            canvas.width = video.videoWidth
            canvas.height = video.videoHeight
            
            let ctx = canvas.getContext('2d')
            ctx.drawImage(video, 0, 0, canvas.width, canvas.height)
            
            // è·å–è§†é¢‘ä¿¡æ¯
            JSON.stringify({
                screenshot: canvas.toDataURL('image/png'),
                currentTime: video.currentTime,
                duration: video.duration,
                title: document.title,
                url: window.location.href
            })
        }
    `)
    
    if (videoInfo) {
        let data = JSON.parse(videoInfo)
        
        // åˆ›å»ºè§†é¢‘ç¬”è®°å¡ç‰‡
        let note = MNUtil.createNote(MNUtil.currentNotebook)
        note.noteTitle = `${data.title} - ${this.formatTime(data.currentTime)}`
        
        // æ·»åŠ æˆªå›¾
        note.appendMarkdownComment(`![screenshot](${data.screenshot})`)
        
        // æ·»åŠ æ—¶é—´æˆ³é“¾æ¥ï¼ˆå¦‚æœæ˜¯ B ç«™ï¼‰
        if (data.url.includes('bilibili.com')) {
            let timeUrl = `${data.url}?t=${Math.floor(data.currentTime)}`
            note.appendMarkdownComment(`[è·³è½¬åˆ° ${this.formatTime(data.currentTime)}](${timeUrl})`)
        }
    }
}

// æ ¼å¼åŒ–æ—¶é—´
formatTime(seconds) {
    let h = Math.floor(seconds / 3600)
    let m = Math.floor((seconds % 3600) / 60)
    let s = Math.floor(seconds % 60)
    
    if (h > 0) {
        return `${h}:${m.toString().padStart(2, '0')}:${s.toString().padStart(2, '0')}`
    } else {
        return `${m}:${s.toString().padStart(2, '0')}`
    }
}
```

### ğŸ”§ å®Œæ•´çš„æ•°æ®æå–æµç¨‹

è®©æˆ‘ä»¬æ•´åˆä¸Šé¢çš„çŸ¥è¯†ï¼Œåˆ›å»ºä¸€ä¸ªå®Œæ•´çš„æ•°æ®æå–å’Œå¡ç‰‡åˆ›å»ºæµç¨‹ï¼š

```javascript
// ä¸»æ§åˆ¶å™¨ç±»
class DataExtractor {
    constructor(webview) {
        this.webview = webview
    }
    
    // æ™ºèƒ½æå–ç½‘é¡µå†…å®¹
    async smartExtract() {
        let result = await this.webview.evaluateJavaScript(`
            // æ£€æµ‹é¡µé¢ç±»å‹
            let pageType = 'unknown'
            let data = {}
            
            // æ£€æµ‹è§†é¢‘ç½‘ç«™
            if (window.location.host.includes('bilibili.com') || 
                window.location.host.includes('youtube.com')) {
                pageType = 'video'
                let video = document.querySelector('video')
                if (video) {
                    // æˆªå–å½“å‰ç”»é¢
                    let canvas = document.createElement('canvas')
                    canvas.width = video.videoWidth
                    canvas.height = video.videoHeight
                    canvas.getContext('2d').drawImage(video, 0, 0)
                    
                    data = {
                        type: 'video',
                        screenshot: canvas.toDataURL('image/png'),
                        currentTime: video.currentTime,
                        title: document.title,
                        url: window.location.href
                    }
                }
            }
            
            // æ£€æµ‹æ–‡ç« é¡µé¢
            else if (document.querySelector('article') || 
                     document.querySelector('.post-content')) {
                pageType = 'article'
                data = {
                    type: 'article',
                    title: document.querySelector('h1')?.innerText || document.title,
                    content: document.querySelector('article')?.innerText || '',
                    author: document.querySelector('.author')?.innerText || '',
                    url: window.location.href
                }
            }
            
            // é»˜è®¤ï¼šè·å–é€‰ä¸­æ–‡æœ¬
            else {
                let selection = window.getSelection().toString()
                if (selection) {
                    data = {
                        type: 'selection',
                        text: selection,
                        title: document.title,
                        url: window.location.href
                    }
                }
            }
            
            JSON.stringify(data)
        `)
        
        return JSON.parse(result)
    }
    
    // æ ¹æ®æå–çš„æ•°æ®åˆ›å»ºå¡ç‰‡
    async createNoteFromData(data) {
        if (!data || !data.type) return
        
        let note = MNUtil.createNote(MNUtil.currentNotebook)
        
        switch (data.type) {
            case 'video':
                note.noteTitle = `ğŸ“¹ ${data.title}`
                note.appendMarkdownComment(`![è§†é¢‘æˆªå›¾](${data.screenshot})`)
                note.appendMarkdownComment(`â± æ—¶é—´ï¼š${this.formatTime(data.currentTime)}`)
                note.appendMarkdownComment(`ğŸ”— [æŸ¥çœ‹åŸè§†é¢‘](${data.url})`)
                break
                
            case 'article':
                note.noteTitle = `ğŸ“° ${data.title}`
                note.noteText = data.content.substring(0, 500) + '...'
                note.appendMarkdownComment(`ğŸ‘¤ ä½œè€…ï¼š${data.author}`)
                note.appendMarkdownComment(`ğŸ”— [é˜…è¯»åŸæ–‡](${data.url})`)
                break
                
            case 'selection':
                note.noteTitle = data.text.substring(0, 50)
                note.noteText = data.text
                note.appendMarkdownComment(`ğŸ“„ æ¥æºï¼š[${data.title}](${data.url})`)
                break
        }
        
        MNUtil.showHUD(`âœ… å·²åˆ›å»º${this.getTypeEmoji(data.type)}ç¬”è®°`)
    }
    
    getTypeEmoji(type) {
        const emojis = {
            'video': 'è§†é¢‘',
            'article': 'æ–‡ç« ',
            'selection': 'æ–‡æœ¬'
        }
        return emojis[type] || 'æ™®é€š'
    }
}
```

### ğŸ’¡ å®æˆ˜æŠ€å·§æ€»ç»“

1. **é”™è¯¯å¤„ç†å¾ˆé‡è¦**
   ```javascript
   try {
       let data = await this.webview.evaluateJavaScript(`...`)
       // å¤„ç†æ•°æ®
   } catch (error) {
       console.error("æå–æ•°æ®å¤±è´¥ï¼š", error)
       MNUtil.showHUD("âŒ æå–å¤±è´¥ï¼Œè¯·é‡è¯•")
   }
   ```

2. **å¤„ç†å¼‚æ­¥æ“ä½œ**
   ```javascript
   // åœ¨ evaluateJavaScript ä¸­ä½¿ç”¨ Promise
   let result = await this.webview.evaluateJavaScript(`
       new Promise((resolve) => {
           // å¼‚æ­¥æ“ä½œ
           setTimeout(() => resolve('done'), 1000)
       })
   `)
   ```

3. **æ•°æ®å¤§å°é™åˆ¶**
   - Base64 å›¾ç‰‡ä¼šæ¯”åŸå›¾å¤§ 30% å·¦å³
   - é¿å…ä¸€æ¬¡ä¼ è¾“è¿‡å¤§çš„æ•°æ®
   - å¯ä»¥åˆ†æ‰¹ä¼ è¾“æˆ–å‹ç¼©

4. **è·¨åŸŸé—®é¢˜å¤„ç†**
   - ä½¿ç”¨ `crossOrigin = 'anonymous'`
   - æˆ–è€…é€šè¿‡ä»£ç†æœåŠ¡å™¨
   - æˆ–è€…è®©ç”¨æˆ·æ‰‹åŠ¨ä¿å­˜

### ğŸ“‹ æœ¬ç« å°ç»“

ç°åœ¨ä½ å·²ç»æŒæ¡äº†ä» HTML æå–æ•°æ®åˆ°å¡ç‰‡çš„å®Œæ•´æµç¨‹ï¼š
1. âœ… ä½¿ç”¨ evaluateJavaScript æ‰§è¡Œç½‘é¡µä»£ç 
2. âœ… æå–æ–‡æœ¬ã€å›¾ç‰‡ã€è§†é¢‘ç­‰å„ç§æ•°æ®
3. âœ… å°†æ•°æ®è½¬æ¢ä¸ºåˆé€‚çš„æ ¼å¼ï¼ˆJSONã€Base64ï¼‰
4. âœ… ä½¿ç”¨ MNUtil API åˆ›å»ºå’Œç¼–è¾‘å¡ç‰‡
5. âœ… å¤„ç†å„ç§è¾¹ç•Œæƒ…å†µå’Œé”™è¯¯

ä¸‹ä¸€ç« ï¼Œæˆ‘ä»¬å°†å­¦ä¹ åå‘çš„æ•°æ®æµï¼šå¦‚ä½•ä»å¡ç‰‡ä¼ è¾“æ•°æ®åˆ° HTML é¡µé¢ã€‚

---

## ç¬¬å››éƒ¨åˆ†ï¼šå•å‘ä¼ è¾“ å¡ç‰‡ â†’ HTML

### ğŸ¯ æœ¬ç« ç›®æ ‡

å­¦å®Œæœ¬ç« ï¼Œä½ å°†èƒ½å¤Ÿï¼š
- è¯»å– MarginNote å¡ç‰‡çš„å„ç§æ•°æ®
- å°†å¡ç‰‡æ•°æ®ä¼ é€’åˆ°ç½‘é¡µä¸­
- åœ¨ç½‘é¡µä¸­åŠ¨æ€å±•ç¤ºå¡ç‰‡å†…å®¹
- å®ç°å¡ç‰‡æ•°æ®çš„å¯è§†åŒ–

### ğŸ“– è¯»å–å¡ç‰‡æ•°æ®

#### 1. è·å–å½“å‰é€‰ä¸­çš„å¡ç‰‡

```javascript
// è·å–å½“å‰ç„¦ç‚¹å¡ç‰‡
function getCurrentNote() {
    // æ–¹æ³• 1ï¼šè·å–å½“å‰é€‰ä¸­çš„å¡ç‰‡
    let focusNote = MNNote.getFocusNote()
    if (!focusNote) {
        MNUtil.showHUD("âŒ è¯·å…ˆé€‰æ‹©ä¸€ä¸ªå¡ç‰‡")
        return null
    }
    
    // æå–å¡ç‰‡çš„åŸºæœ¬ä¿¡æ¯
    let noteData = {
        id: focusNote.noteId,
        title: focusNote.noteTitle || "æ— æ ‡é¢˜",
        text: focusNote.noteText || "",
        createTime: focusNote.createDate.getTime(),
        modifyTime: focusNote.modifyDate.getTime(),
        colorIndex: focusNote.colorIndex,
        // è·å–æ‰€æœ‰è¯„è®º
        comments: focusNote.comments.map(comment => ({
            type: comment.type, // æ–‡æœ¬ã€é“¾æ¥ã€å›¾ç‰‡ç­‰
            text: comment.text || ""
        }))
    }
    
    return noteData
}
```

#### 2. æ‰¹é‡è·å–å¡ç‰‡æ•°æ®

```javascript
// è·å–å½“å‰ç¬”è®°æœ¬çš„æ‰€æœ‰å¡ç‰‡
function getAllNotes() {
    let notebook = MNUtil.currentNotebook
    if (!notebook) return []
    
    // è·å–æ‰€æœ‰å¡ç‰‡
    let allNotes = notebook.notes
    
    // è½¬æ¢ä¸ºå¯ä¼ è¾“çš„æ ¼å¼
    return allNotes.map(note => ({
        id: note.noteId,
        title: note.noteTitle || "",
        text: note.noteText || "",
        parentId: note.parentNote?.noteId || null,
        childCount: note.childNotes.length,
        hasImage: note.comments.some(c => c.type === "image"),
        colorIndex: note.colorIndex,
        tags: note.linkedNotes.filter(n => n.noteTitle?.startsWith("#"))
                              .map(n => n.noteTitle)
    }))
}

// è·å–ç‰¹å®šæ¡ä»¶çš„å¡ç‰‡
function getFilteredNotes(filter) {
    let notebook = MNUtil.currentNotebook
    if (!notebook) return []
    
    return notebook.notes.filter(note => {
        // æ ¹æ®é¢œè‰²ç­›é€‰
        if (filter.color !== undefined && note.colorIndex !== filter.color) {
            return false
        }
        
        // æ ¹æ®æ ‡ç­¾ç­›é€‰
        if (filter.tag && !note.noteTitle?.includes(filter.tag)) {
            return false
        }
        
        // æ ¹æ®åˆ›å»ºæ—¶é—´ç­›é€‰
        if (filter.afterDate && note.createDate.getTime() < filter.afterDate) {
            return false
        }
        
        return true
    }).map(note => ({
        id: note.noteId,
        title: note.noteTitle || "",
        text: note.noteText || ""
    }))
}
```

### ğŸš€ å°†æ•°æ®ä¼ é€’åˆ°ç½‘é¡µ

#### 1. ç›´æ¥æ³¨å…¥æ•°æ®

æœ€ç®€å•çš„æ–¹æ³•æ˜¯ç›´æ¥å°†æ•°æ®æ³¨å…¥åˆ°ç½‘é¡µçš„å…¨å±€å˜é‡ä¸­ï¼š

```javascript
async function sendDataToWebView(data) {
    // å°†æ•°æ®è½¬ä¸º JSON å­—ç¬¦ä¸²
    let jsonData = JSON.stringify(data)
    
    // æ³¨å…¥åˆ°ç½‘é¡µ
    await this.webview.evaluateJavaScript(`
        // åœ¨ç½‘é¡µä¸­åˆ›å»ºå…¨å±€å˜é‡
        window.MNData = ${jsonData};
        
        // è§¦å‘è‡ªå®šä¹‰äº‹ä»¶ï¼Œé€šçŸ¥ç½‘é¡µæ•°æ®å·²æ›´æ–°
        window.dispatchEvent(new CustomEvent('MNDataUpdated', {
            detail: window.MNData
        }));
        
        // è¿”å›ç¡®è®¤
        'Data injected successfully'
    `)
}

// ä½¿ç”¨ç¤ºä¾‹
async function updateWebViewWithCurrentNote() {
    let noteData = getCurrentNote()
    if (noteData) {
        await sendDataToWebView(noteData)
        MNUtil.showHUD("âœ… æ•°æ®å·²å‘é€åˆ°ç½‘é¡µ")
    }
}
```

#### 2. é€šè¿‡å‡½æ•°è°ƒç”¨ä¼ é€’

æ›´çµæ´»çš„æ–¹æ³•æ˜¯åœ¨ç½‘é¡µä¸­å®šä¹‰æ¥æ”¶å‡½æ•°ï¼Œç„¶åä»æ’ä»¶è°ƒç”¨ï¼š

```javascript
// é¦–å…ˆï¼Œåœ¨ç½‘é¡µä¸­å®šä¹‰æ¥æ”¶å‡½æ•°
let webPageCode = `
<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>å¡ç‰‡æ•°æ®å±•ç¤º</title>
    <style>
        .note-card {
            border: 1px solid #ddd;
            padding: 15px;
            margin: 10px;
            border-radius: 8px;
            background: white;
        }
        .note-title {
            font-size: 18px;
            font-weight: bold;
            margin-bottom: 10px;
        }
        .note-text {
            color: #666;
            white-space: pre-wrap;
        }
    </style>
</head>
<body>
    <div id="container"></div>
    
    <script>
        // å®šä¹‰æ¥æ”¶æ•°æ®çš„å‡½æ•°
        window.receiveNoteData = function(noteData) {
            const container = document.getElementById('container');
            container.innerHTML = ''; // æ¸…ç©ºå®¹å™¨
            
            // æ˜¾ç¤ºå•ä¸ªå¡ç‰‡
            if (!Array.isArray(noteData)) {
                noteData = [noteData];
            }
            
            // æ¸²æŸ“æ¯ä¸ªå¡ç‰‡
            noteData.forEach(note => {
                const card = document.createElement('div');
                card.className = 'note-card';
                card.innerHTML = \`
                    <div class="note-title">\${note.title || 'æ— æ ‡é¢˜'}</div>
                    <div class="note-text">\${note.text || 'æ— å†…å®¹'}</div>
                    <div class="note-meta">
                        åˆ›å»ºæ—¶é—´ï¼š\${new Date(note.createTime).toLocaleString()}
                    </div>
                \`;
                container.appendChild(card);
            });
            
            return 'Rendered ' + noteData.length + ' notes';
        };
        
        // å®šä¹‰æ›´æ–°ç»Ÿè®¡ä¿¡æ¯çš„å‡½æ•°
        window.updateStats = function(stats) {
            document.getElementById('stats').innerHTML = \`
                æ€»å¡ç‰‡æ•°ï¼š\${stats.total}<br>
                ä»Šæ—¥åˆ›å»ºï¼š\${stats.todayCount}<br>
                å¸¦å›¾ç‰‡çš„ï¼š\${stats.withImages}
            \`;
        };
    </script>
</body>
</html>
`;

// åœ¨æ’ä»¶ä¸­è°ƒç”¨ç½‘é¡µå‡½æ•°
async function sendNoteToWebView(note) {
    let noteData = {
        id: note.noteId,
        title: note.noteTitle,
        text: note.noteText,
        createTime: note.createDate.getTime()
    };
    
    // è°ƒç”¨ç½‘é¡µä¸­çš„å‡½æ•°
    let result = await this.webview.evaluateJavaScript(`
        window.receiveNoteData(${JSON.stringify(noteData)})
    `);
    
    console.log("ç½‘é¡µè¿”å›ï¼š", result);
}
```

### ğŸ“Š åœ¨ç½‘é¡µä¸­å±•ç¤ºå¡ç‰‡æ•°æ®

#### 1. åˆ›å»ºäº¤äº’å¼å¡ç‰‡åˆ—è¡¨

```javascript
// å®Œæ•´çš„ HTML é¡µé¢ç¤ºä¾‹
let interactiveHTML = `
<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>æˆ‘çš„ç¬”è®°ç®¡ç†å™¨</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            margin: 0;
            padding: 20px;
            background: #f5f5f5;
        }
        
        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }
        
        .search-box {
            padding: 8px 15px;
            border: 1px solid #ddd;
            border-radius: 20px;
            width: 300px;
        }
        
        .note-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 15px;
        }
        
        .note-card {
            background: white;
            border-radius: 8px;
            padding: 15px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
        }
        
        .note-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.15);
        }
        
        .note-card.selected {
            border: 2px solid #007aff;
        }
        
        .color-indicator {
            width: 100%;
            height: 4px;
            margin: -15px -15px 10px -15px;
            border-radius: 8px 8px 0 0;
        }
        
        .color-0 { background: #ff6b6b; }
        .color-1 { background: #4ecdc4; }
        .color-2 { background: #45b7d1; }
        .color-3 { background: #96ceb4; }
        .color-4 { background: #feca57; }
        
        .stats-panel {
            background: white;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
        }
        
        .action-buttons {
            position: fixed;
            bottom: 20px;
            right: 20px;
            display: flex;
            gap: 10px;
        }
        
        .btn {
            padding: 10px 20px;
            background: #007aff;
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
        }
        
        .btn:hover {
            background: #0051a8;
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>æˆ‘çš„ç¬”è®°</h1>
        <input type="text" class="search-box" placeholder="æœç´¢ç¬”è®°..." id="searchBox">
    </div>
    
    <div class="stats-panel" id="statsPanel">
        åŠ è½½ä¸­...
    </div>
    
    <div class="note-grid" id="noteGrid"></div>
    
    <div class="action-buttons">
        <button class="btn" onclick="refreshNotes()">åˆ·æ–°</button>
        <button class="btn" onclick="exportSelected()">å¯¼å‡ºé€‰ä¸­</button>
    </div>
    
    <script>
        let allNotes = [];
        let selectedNotes = new Set();
        
        // æ¥æ”¶ç¬”è®°æ•°æ®
        window.receiveNotes = function(notes) {
            allNotes = notes;
            renderNotes(notes);
            updateStats();
        };
        
        // æ¸²æŸ“ç¬”è®°
        function renderNotes(notes) {
            const grid = document.getElementById('noteGrid');
            grid.innerHTML = '';
            
            notes.forEach(note => {
                const card = createNoteCard(note);
                grid.appendChild(card);
            });
        }
        
        // åˆ›å»ºå¡ç‰‡å…ƒç´ 
        function createNoteCard(note) {
            const card = document.createElement('div');
            card.className = 'note-card';
            if (selectedNotes.has(note.id)) {
                card.className += ' selected';
            }
            
            card.innerHTML = \`
                <div class="color-indicator color-\${note.colorIndex || 0}"></div>
                <h3>\${note.title || 'æ— æ ‡é¢˜'}</h3>
                <p>\${note.text ? note.text.substring(0, 100) + '...' : 'æ— å†…å®¹'}</p>
                <div style="margin-top: 10px; font-size: 12px; color: #999;">
                    \${note.childCount || 0} ä¸ªå­ç¬”è®°
                    \${note.hasImage ? 'ğŸ“' : ''}
                </div>
            \`;
            
            card.onclick = () => toggleSelect(note.id, card);
            
            return card;
        }
        
        // åˆ‡æ¢é€‰ä¸­çŠ¶æ€
        function toggleSelect(noteId, card) {
            if (selectedNotes.has(noteId)) {
                selectedNotes.delete(noteId);
                card.classList.remove('selected');
            } else {
                selectedNotes.add(noteId);
                card.classList.add('selected');
            }
        }
        
        // æœç´¢åŠŸèƒ½
        document.getElementById('searchBox').oninput = function(e) {
            const keyword = e.target.value.toLowerCase();
            const filtered = allNotes.filter(note => 
                (note.title && note.title.toLowerCase().includes(keyword)) ||
                (note.text && note.text.toLowerCase().includes(keyword))
            );
            renderNotes(filtered);
        };
        
        // æ›´æ–°ç»Ÿè®¡ä¿¡æ¯
        function updateStats() {
            const today = new Date().setHours(0, 0, 0, 0);
            const todayNotes = allNotes.filter(n => n.createTime >= today);
            
            document.getElementById('statsPanel').innerHTML = \`
                <div style="display: flex; justify-content: space-around;">
                    <div>
                        <div style="font-size: 24px; font-weight: bold;">\${allNotes.length}</div>
                        <div style="color: #666;">æ€»ç¬”è®°æ•°</div>
                    </div>
                    <div>
                        <div style="font-size: 24px; font-weight: bold;">\${todayNotes.length}</div>
                        <div style="color: #666;">ä»Šæ—¥æ–°å¢</div>
                    </div>
                    <div>
                        <div style="font-size: 24px; font-weight: bold;">\${selectedNotes.size}</div>
                        <div style="color: #666;">å·²é€‰ä¸­</div>
                    </div>
                </div>
            \`;
        }
        
        // åˆ·æ–°æ•°æ®
        function refreshNotes() {
            // é€šçŸ¥æ’ä»¶è¯·æ±‚æ–°æ•°æ®
            window.location.href = 'browser://refresh-notes';
        }
        
        // å¯¼å‡ºé€‰ä¸­çš„ç¬”è®°
        function exportSelected() {
            if (selectedNotes.size === 0) {
                alert('è¯·å…ˆé€‰æ‹©è¦å¯¼å‡ºçš„ç¬”è®°');
                return;
            }
            
            const selectedData = allNotes.filter(n => selectedNotes.has(n.id));
            window.location.href = 'browser://export?data=' + 
                encodeURIComponent(JSON.stringify(selectedData));
        }
    </script>
</body>
</html>
`;
```

#### 2. å®æ—¶æ›´æ–°æœºåˆ¶

```javascript
// åœ¨æ’ä»¶ä¸­è®¾ç½®å®šæ—¶æ›´æ–°
class NoteDataSync {
    constructor(webview) {
        this.webview = webview;
        this.syncInterval = null;
    }
    
    // å¼€å§‹åŒæ­¥
    startSync(intervalMs = 5000) {
        this.syncInterval = setInterval(() => {
            this.syncNotes();
        }, intervalMs);
        
        // ç«‹å³æ‰§è¡Œä¸€æ¬¡
        this.syncNotes();
    }
    
    // åœæ­¢åŒæ­¥
    stopSync() {
        if (this.syncInterval) {
            clearInterval(this.syncInterval);
            this.syncInterval = null;
        }
    }
    
    // åŒæ­¥ç¬”è®°æ•°æ®
    async syncNotes() {
        try {
            // è·å–æ‰€æœ‰ç¬”è®°
            let notes = getAllNotes();
            
            // å‘é€åˆ°ç½‘é¡µ
            await this.webview.evaluateJavaScript(`
                if (window.receiveNotes) {
                    window.receiveNotes(${JSON.stringify(notes)});
                }
            `);
        } catch (error) {
            console.error("åŒæ­¥å¤±è´¥ï¼š", error);
        }
    }
    
    // ç›‘å¬ç¬”è®°å˜åŒ–
    watchNoteChanges() {
        // ç›‘å¬ç¬”è®°åˆ›å»º
        NSNotificationCenter.defaultCenter().addObserverSelectorName(
            this,
            'onNoteCreated:',
            'MNNoteCreatedNotification'
        );
        
        // ç›‘å¬ç¬”è®°ä¿®æ”¹
        NSNotificationCenter.defaultCenter().addObserverSelectorName(
            this,
            'onNoteModified:',
            'MNNoteModifiedNotification'
        );
    }
    
    // ç¬”è®°åˆ›å»ºæ—¶ç«‹å³åŒæ­¥
    onNoteCreated(notification) {
        this.syncNotes();
    }
    
    // ç¬”è®°ä¿®æ”¹æ—¶ç«‹å³åŒæ­¥
    onNoteModified(notification) {
        // å»¶è¿Ÿä¸€ä¸‹é¿å…é¢‘ç¹æ›´æ–°
        if (this.updateTimer) {
            clearTimeout(this.updateTimer);
        }
        this.updateTimer = setTimeout(() => {
            this.syncNotes();
        }, 500);
    }
}
```

### ğŸ’¡ å®æˆ˜æ¡ˆä¾‹ï¼šç¬”è®°ç»Ÿè®¡ä»ªè¡¨æ¿

è®©æˆ‘ä»¬åˆ›å»ºä¸€ä¸ªå®Œæ•´çš„ç¬”è®°ç»Ÿè®¡ä»ªè¡¨æ¿ï¼š

```javascript
// è·å–è¯¦ç»†çš„ç»Ÿè®¡æ•°æ®
function getNoteStatistics() {
    let notebook = MNUtil.currentNotebook;
    if (!notebook) return null;
    
    let notes = notebook.notes;
    let now = new Date();
    let today = new Date(now.getFullYear(), now.getMonth(), now.getDate()).getTime();
    let thisWeek = today - (7 * 24 * 60 * 60 * 1000);
    let thisMonth = today - (30 * 24 * 60 * 60 * 1000);
    
    // ç»Ÿè®¡æ•°æ®
    let stats = {
        total: notes.length,
        today: 0,
        thisWeek: 0,
        thisMonth: 0,
        byColor: {},
        byTag: {},
        withImages: 0,
        withLinks: 0,
        averageLength: 0,
        topTags: []
    };
    
    let totalLength = 0;
    let tagCount = {};
    
    notes.forEach(note => {
        let createTime = note.createDate.getTime();
        
        // æ—¶é—´ç»Ÿè®¡
        if (createTime >= today) stats.today++;
        if (createTime >= thisWeek) stats.thisWeek++;
        if (createTime >= thisMonth) stats.thisMonth++;
        
        // é¢œè‰²ç»Ÿè®¡
        let color = note.colorIndex || 0;
        stats.byColor[color] = (stats.byColor[color] || 0) + 1;
        
        // å†…å®¹ç»Ÿè®¡
        totalLength += (note.noteText || '').length;
        
        // è¯„è®ºç±»å‹ç»Ÿè®¡
        note.comments.forEach(comment => {
            if (comment.type === 'image') stats.withImages++;
            if (comment.type === 'link') stats.withLinks++;
        });
        
        // æ ‡ç­¾ç»Ÿè®¡
        let tags = (note.noteTitle || '').match(/#\w+/g) || [];
        tags.forEach(tag => {
            tagCount[tag] = (tagCount[tag] || 0) + 1;
        });
    });
    
    // è®¡ç®—å¹³å‡é•¿åº¦
    stats.averageLength = Math.round(totalLength / notes.length) || 0;
    
    // è·å–çƒ­é—¨æ ‡ç­¾
    stats.topTags = Object.entries(tagCount)
        .sort((a, b) => b[1] - a[1])
        .slice(0, 10)
        .map(([tag, count]) => ({ tag, count }));
    
    return stats;
}

// åˆ›å»ºå¯è§†åŒ–ä»ªè¡¨æ¿
let dashboardHTML = `
<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>ç¬”è®°ç»Ÿè®¡ä»ªè¡¨æ¿</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            margin: 0;
            padding: 20px;
            background: #f0f2f5;
        }
        
        .dashboard {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
        }
        
        .card {
            background: white;
            border-radius: 10px;
            padding: 20px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        
        .metric {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }
        
        .metric-value {
            font-size: 32px;
            font-weight: bold;
            color: #1890ff;
        }
        
        .metric-label {
            color: #666;
        }
        
        .chart-container {
            position: relative;
            height: 300px;
        }
        
        .tag-cloud {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
        }
        
        .tag {
            background: #e6f7ff;
            color: #1890ff;
            padding: 5px 15px;
            border-radius: 20px;
            font-size: 14px;
        }
    </style>
</head>
<body>
    <h1>ç¬”è®°ç»Ÿè®¡ä»ªè¡¨æ¿</h1>
    
    <div class="dashboard">
        <!-- åŸºç¡€ç»Ÿè®¡ -->
        <div class="card">
            <h3>åŸºç¡€ç»Ÿè®¡</h3>
            <div class="metric">
                <span class="metric-label">æ€»ç¬”è®°æ•°</span>
                <span class="metric-value" id="totalNotes">0</span>
            </div>
            <div class="metric">
                <span class="metric-label">ä»Šæ—¥æ–°å¢</span>
                <span class="metric-value" id="todayNotes">0</span>
            </div>
            <div class="metric">
                <span class="metric-label">æœ¬å‘¨æ–°å¢</span>
                <span class="metric-value" id="weekNotes">0</span>
            </div>
        </div>
        
        <!-- é¢œè‰²åˆ†å¸ƒå›¾ -->
        <div class="card">
            <h3>é¢œè‰²åˆ†å¸ƒ</h3>
            <div class="chart-container">
                <canvas id="colorChart"></canvas>
            </div>
        </div>
        
        <!-- çƒ­é—¨æ ‡ç­¾ -->
        <div class="card">
            <h3>çƒ­é—¨æ ‡ç­¾</h3>
            <div class="tag-cloud" id="tagCloud"></div>
        </div>
        
        <!-- å†…å®¹ç»Ÿè®¡ -->
        <div class="card">
            <h3>å†…å®¹ç»Ÿè®¡</h3>
            <div class="metric">
                <span class="metric-label">å¹³å‡é•¿åº¦</span>
                <span class="metric-value" id="avgLength">0</span>
            </div>
            <div class="metric">
                <span class="metric-label">å«å›¾ç‰‡</span>
                <span class="metric-value" id="withImages">0</span>
            </div>
            <div class="metric">
                <span class="metric-label">å«é“¾æ¥</span>
                <span class="metric-value" id="withLinks">0</span>
            </div>
        </div>
    </div>
    
    <script>
        let colorChart = null;
        
        // æ¥æ”¶ç»Ÿè®¡æ•°æ®
        window.updateStats = function(stats) {
            // æ›´æ–°åŸºç¡€ç»Ÿè®¡
            document.getElementById('totalNotes').textContent = stats.total;
            document.getElementById('todayNotes').textContent = stats.today;
            document.getElementById('weekNotes').textContent = stats.thisWeek;
            
            // æ›´æ–°å†…å®¹ç»Ÿè®¡
            document.getElementById('avgLength').textContent = stats.averageLength;
            document.getElementById('withImages').textContent = stats.withImages;
            document.getElementById('withLinks').textContent = stats.withLinks;
            
            // æ›´æ–°é¢œè‰²åˆ†å¸ƒå›¾
            updateColorChart(stats.byColor);
            
            // æ›´æ–°æ ‡ç­¾äº‘
            updateTagCloud(stats.topTags);
        };
        
        // æ›´æ–°é¢œè‰²åˆ†å¸ƒå›¾
        function updateColorChart(colorData) {
            const ctx = document.getElementById('colorChart').getContext('2d');
            
            if (colorChart) {
                colorChart.destroy();
            }
            
            const colors = [
                '#ff6b6b', '#4ecdc4', '#45b7d1', 
                '#96ceb4', '#feca57', '#ff9ff3'
            ];
            
            colorChart = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: Object.keys(colorData).map(i => 'é¢œè‰² ' + i),
                    datasets: [{
                        data: Object.values(colorData),
                        backgroundColor: colors
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false
                }
            });
        }
        
        // æ›´æ–°æ ‡ç­¾äº‘
        function updateTagCloud(tags) {
            const cloud = document.getElementById('tagCloud');
            cloud.innerHTML = '';
            
            tags.forEach(item => {
                const tag = document.createElement('div');
                tag.className = 'tag';
                tag.textContent = item.tag + ' (' + item.count + ')';
                cloud.appendChild(tag);
            });
        }
    </script>
</body>
</html>
`;
```

### ğŸ“‹ æœ¬ç« å°ç»“

ç°åœ¨ä½ å·²ç»æŒæ¡äº†ä»å¡ç‰‡ä¼ è¾“æ•°æ®åˆ° HTML çš„å®Œæ•´æµç¨‹ï¼š
1. âœ… è¯»å–å„ç§å¡ç‰‡æ•°æ®ï¼ˆå•ä¸ªã€æ‰¹é‡ã€ç­›é€‰ï¼‰
2. âœ… é€šè¿‡ evaluateJavaScript ä¼ é€’æ•°æ®åˆ°ç½‘é¡µ
3. âœ… åœ¨ç½‘é¡µä¸­åˆ›å»ºäº¤äº’å¼ç•Œé¢å±•ç¤ºæ•°æ®
4. âœ… å®ç°å®æ—¶åŒæ­¥å’Œè‡ªåŠ¨æ›´æ–°
5. âœ… åˆ›å»ºæ•°æ®å¯è§†åŒ–ä»ªè¡¨æ¿

---

## ç¬¬äº”éƒ¨åˆ†ï¼šåŒå‘é€šä¿¡å®æˆ˜

### ğŸ¯ æœ¬ç« ç›®æ ‡

å­¦å®Œæœ¬ç« ï¼Œä½ å°†èƒ½å¤Ÿï¼š
- å»ºç«‹å®Œæ•´çš„åŒå‘é€šä¿¡æœºåˆ¶
- å®ç°ç½‘é¡µå’Œå¡ç‰‡çš„å®æ—¶åŒæ­¥
- å¤„ç†å¤æ‚çš„äº¤äº’åœºæ™¯
- æ„å»ºä¸€ä¸ªå®Œæ•´çš„ä»»åŠ¡ç®¡ç†ç³»ç»Ÿ

### ğŸ”„ åŒå‘é€šä¿¡æ¶æ„

#### 1. é€šä¿¡æµç¨‹è®¾è®¡

```javascript
// å®šä¹‰é€šä¿¡åè®®
const Protocol = {
    // ä»æ’ä»¶åˆ°ç½‘é¡µçš„æ¶ˆæ¯ç±»å‹
    TO_WEB: {
        INIT: 'init',           // åˆå§‹åŒ–
        UPDATE_NOTE: 'updateNote', // æ›´æ–°å¡ç‰‡
        DELETE_NOTE: 'deleteNote', // åˆ é™¤å¡ç‰‡
        SYNC_ALL: 'syncAll'     // åŒæ­¥æ‰€æœ‰æ•°æ®
    },
    
    // ä»ç½‘é¡µåˆ°æ’ä»¶çš„æ¶ˆæ¯ç±»å‹
    TO_PLUGIN: {
        CREATE_NOTE: 'browser://create-note',
        UPDATE_NOTE: 'browser://update-note',
        DELETE_NOTE: 'browser://delete-note',
        GET_NOTES: 'browser://get-notes'
    }
};

// æ¶ˆæ¯å¤„ç†å™¨åŸºç±»
class MessageHandler {
    constructor(webview) {
        this.webview = webview;
        this.handlers = new Map();
    }
    
    // æ³¨å†Œæ¶ˆæ¯å¤„ç†å™¨
    on(messageType, handler) {
        this.handlers.set(messageType, handler);
    }
    
    // å‘é€æ¶ˆæ¯åˆ°ç½‘é¡µ
    async send(type, data) {
        try {
            await this.webview.evaluateJavaScript(`
                if (window.handleMessage) {
                    window.handleMessage('${type}', ${JSON.stringify(data)});
                }
            `);
        } catch (error) {
            console.error("å‘é€æ¶ˆæ¯å¤±è´¥ï¼š", error);
        }
    }
    
    // å¤„ç†æ¥è‡ªç½‘é¡µçš„æ¶ˆæ¯
    handleWebMessage(url) {
        try {
            let urlObj = new URL(url);
            let action = urlObj.pathname.replace('//', '');
            let params = Object.fromEntries(urlObj.searchParams);
            
            let handler = this.handlers.get(action);
            if (handler) {
                handler(params);
            }
        } catch (error) {
            console.error("å¤„ç†æ¶ˆæ¯å¤±è´¥ï¼š", error);
        }
    }
}
```

#### 2. ç½‘é¡µç«¯é€šä¿¡æ¡†æ¶

```javascript
// ç½‘é¡µç«¯çš„é€šä¿¡ç®¡ç†å™¨
let webCommunicator = `
<script>
class WebCommunicator {
    constructor() {
        this.handlers = new Map();
        this.pendingRequests = new Map();
        this.requestId = 0;
        
        // è®¾ç½®å…¨å±€æ¶ˆæ¯å¤„ç†å™¨
        window.handleMessage = this.handleMessage.bind(this);
    }
    
    // æ³¨å†Œæ¶ˆæ¯å¤„ç†å™¨
    on(messageType, handler) {
        this.handlers.set(messageType, handler);
    }
    
    // å‘é€æ¶ˆæ¯åˆ°æ’ä»¶
    send(action, data) {
        const url = action + '?' + new URLSearchParams(data).toString();
        window.location.href = url;
    }
    
    // å‘é€è¯·æ±‚å¹¶ç­‰å¾…å“åº”
    async request(action, data) {
        return new Promise((resolve, reject) => {
            const id = ++this.requestId;
            this.pendingRequests.set(id, { resolve, reject });
            
            // æ·»åŠ è¯·æ±‚ID
            data.requestId = id;
            this.send(action, data);
            
            // è¶…æ—¶å¤„ç†
            setTimeout(() => {
                if (this.pendingRequests.has(id)) {
                    this.pendingRequests.delete(id);
                    reject(new Error('Request timeout'));
                }
            }, 5000);
        });
    }
    
    // å¤„ç†æ¥è‡ªæ’ä»¶çš„æ¶ˆæ¯
    handleMessage(type, data) {
        // æ£€æŸ¥æ˜¯å¦æ˜¯å“åº”æ¶ˆæ¯
        if (data.requestId && this.pendingRequests.has(data.requestId)) {
            const { resolve } = this.pendingRequests.get(data.requestId);
            this.pendingRequests.delete(data.requestId);
            resolve(data);
            return;
        }
        
        // å¤„ç†æ™®é€šæ¶ˆæ¯
        const handler = this.handlers.get(type);
        if (handler) {
            handler(data);
        }
    }
}

// åˆ›å»ºå…¨å±€é€šä¿¡å®ä¾‹
const comm = new WebCommunicator();
</script>
`;
```

### ğŸ—ï¸ å®Œæ•´ç¤ºä¾‹ï¼šä»»åŠ¡ç®¡ç†ç³»ç»Ÿ

è®©æˆ‘ä»¬åˆ›å»ºä¸€ä¸ªå®Œæ•´çš„ä»»åŠ¡ç®¡ç†ç³»ç»Ÿï¼Œå±•ç¤ºåŒå‘é€šä¿¡çš„å¼ºå¤§åŠŸèƒ½ï¼š

#### 1. æ’ä»¶ç«¯å®ç°

```javascript
// TaskManager.js - ä»»åŠ¡ç®¡ç†å™¨æ’ä»¶
class TaskManager {
    constructor() {
        this.webview = null;
        this.messageHandler = null;
        this.initWebView();
    }
    
    // åˆå§‹åŒ– WebView
    initWebView() {
        // åˆ›å»º WebView
        this.webview = UIWebView.new();
        this.webview.frame = { x: 0, y: 0, width: 400, height: 600 };
        
        // åŠ è½½ HTML
        this.webview.loadHTMLStringBaseURL(this.getHTML(), null);
        
        // åˆå§‹åŒ–æ¶ˆæ¯å¤„ç†å™¨
        this.messageHandler = new MessageHandler(this.webview);
        this.setupMessageHandlers();
    }
    
    // è®¾ç½®æ¶ˆæ¯å¤„ç†å™¨
    setupMessageHandlers() {
        // åˆ›å»ºä»»åŠ¡
        this.messageHandler.on('create-task', async (params) => {
            let task = await this.createTask(params);
            // å‘é€åˆ›å»ºæˆåŠŸçš„æ¶ˆæ¯
            this.messageHandler.send('taskCreated', task);
        });
        
        // æ›´æ–°ä»»åŠ¡
        this.messageHandler.on('update-task', async (params) => {
            let success = await this.updateTask(params.id, params);
            this.messageHandler.send('taskUpdated', { 
                id: params.id, 
                success 
            });
        });
        
        // è·å–æ‰€æœ‰ä»»åŠ¡
        this.messageHandler.on('get-tasks', async () => {
            let tasks = await this.getAllTasks();
            this.messageHandler.send('tasksLoaded', tasks);
        });
        
        // åˆ é™¤ä»»åŠ¡
        this.messageHandler.on('delete-task', async (params) => {
            let success = await this.deleteTask(params.id);
            if (success) {
                this.messageHandler.send('taskDeleted', { id: params.id });
            }
        });
    }
    
    // åˆ›å»ºä»»åŠ¡ï¼ˆåœ¨ MarginNote ä¸­åˆ›å»ºå¡ç‰‡ï¼‰
    async createTask(taskData) {
        let note = MNUtil.createNote(MNUtil.currentNotebook);
        
        // è®¾ç½®ä»»åŠ¡æ ‡é¢˜
        note.noteTitle = `ğŸ“‹ ${taskData.title}`;
        
        // æ·»åŠ ä»»åŠ¡è¯¦æƒ…
        note.appendTextComment(`çŠ¶æ€ï¼š${taskData.status || 'å¾…åŠ'}`);
        note.appendTextComment(`ä¼˜å…ˆçº§ï¼š${taskData.priority || 'ä¸­'}`);
        note.appendTextComment(`æˆªæ­¢æ—¥æœŸï¼š${taskData.dueDate || 'æ— '}`);
        
        if (taskData.description) {
            note.appendTextComment(`æè¿°ï¼š${taskData.description}`);
        }
        
        // è®¾ç½®é¢œè‰²
        const priorityColors = { 'é«˜': 0, 'ä¸­': 2, 'ä½': 4 };
        note.colorIndex = priorityColors[taskData.priority] || 2;
        
        return {
            id: note.noteId,
            title: taskData.title,
            status: taskData.status,
            priority: taskData.priority,
            dueDate: taskData.dueDate,
            description: taskData.description
        };
    }
    
    // æ›´æ–°ä»»åŠ¡
    async updateTask(noteId, updates) {
        let note = MNDatabase.sharedInstance().getNoteById(noteId);
        if (!note) return false;
        
        // æ›´æ–°æ ‡é¢˜
        if (updates.title) {
            note.noteTitle = `ğŸ“‹ ${updates.title}`;
        }
        
        // æ›´æ–°è¯„è®ºä¸­çš„å­—æ®µ
        let comments = note.comments;
        for (let i = 0; i < comments.length; i++) {
            let comment = comments[i];
            if (comment.text.startsWith('çŠ¶æ€ï¼š') && updates.status) {
                comment.text = `çŠ¶æ€ï¼š${updates.status}`;
            }
            if (comment.text.startsWith('ä¼˜å…ˆçº§ï¼š') && updates.priority) {
                comment.text = `ä¼˜å…ˆçº§ï¼š${updates.priority}`;
                // æ›´æ–°é¢œè‰²
                const priorityColors = { 'é«˜': 0, 'ä¸­': 2, 'ä½': 4 };
                note.colorIndex = priorityColors[updates.priority] || 2;
            }
        }
        
        return true;
    }
    
    // è·å–æ‰€æœ‰ä»»åŠ¡
    async getAllTasks() {
        let notebook = MNUtil.currentNotebook;
        if (!notebook) return [];
        
        // ç­›é€‰ä»»åŠ¡å¡ç‰‡ï¼ˆæ ‡é¢˜ä»¥ğŸ“‹å¼€å¤´ï¼‰
        let taskNotes = notebook.notes.filter(note => 
            note.noteTitle && note.noteTitle.startsWith('ğŸ“‹')
        );
        
        return taskNotes.map(note => {
            let task = {
                id: note.noteId,
                title: note.noteTitle.replace('ğŸ“‹ ', ''),
                status: 'å¾…åŠ',
                priority: 'ä¸­',
                dueDate: null,
                description: ''
            };
            
            // ä»è¯„è®ºä¸­æå–ä¿¡æ¯
            note.comments.forEach(comment => {
                if (comment.text.startsWith('çŠ¶æ€ï¼š')) {
                    task.status = comment.text.replace('çŠ¶æ€ï¼š', '');
                }
                if (comment.text.startsWith('ä¼˜å…ˆçº§ï¼š')) {
                    task.priority = comment.text.replace('ä¼˜å…ˆçº§ï¼š', '');
                }
                if (comment.text.startsWith('æˆªæ­¢æ—¥æœŸï¼š')) {
                    task.dueDate = comment.text.replace('æˆªæ­¢æ—¥æœŸï¼š', '');
                }
                if (comment.text.startsWith('æè¿°ï¼š')) {
                    task.description = comment.text.replace('æè¿°ï¼š', '');
                }
            });
            
            return task;
        });
    }
    
    // åˆ é™¤ä»»åŠ¡
    async deleteTask(noteId) {
        let note = MNDatabase.sharedInstance().getNoteById(noteId);
        if (!note) return false;
        
        MNUtil.removeNoteFromDocument(note);
        return true;
    }
    
    // è·å– HTML å†…å®¹
    getHTML() {
        return `
<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>ä»»åŠ¡ç®¡ç†å™¨</title>
    <style>
        * {
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            margin: 0;
            padding: 20px;
            background: #f5f7fa;
        }
        
        .container {
            max-width: 800px;
            margin: 0 auto;
        }
        
        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
        }
        
        .add-task-form {
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }
        
        .form-group {
            margin-bottom: 15px;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: 500;
        }
        
        .form-group input,
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 8px 12px;
            border: 1px solid #ddd;
            border-radius: 6px;
            font-size: 14px;
        }
        
        .task-list {
            background: white;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            overflow: hidden;
        }
        
        .task-item {
            padding: 15px 20px;
            border-bottom: 1px solid #eee;
            display: flex;
            align-items: center;
            transition: background 0.2s;
        }
        
        .task-item:hover {
            background: #f8f9fa;
        }
        
        .task-checkbox {
            margin-right: 15px;
        }
        
        .task-content {
            flex: 1;
        }
        
        .task-title {
            font-weight: 500;
            margin-bottom: 5px;
        }
        
        .task-meta {
            font-size: 12px;
            color: #666;
        }
        
        .task-actions {
            display: flex;
            gap: 10px;
        }
        
        .btn {
            padding: 6px 12px;
            border: none;
            border-radius: 4px;
            font-size: 14px;
            cursor: pointer;
            transition: opacity 0.2s;
        }
        
        .btn:hover {
            opacity: 0.8;
        }
        
        .btn-primary {
            background: #007aff;
            color: white;
        }
        
        .btn-danger {
            background: #ff3b30;
            color: white;
        }
        
        .priority-high {
            border-left: 4px solid #ff3b30;
        }
        
        .priority-medium {
            border-left: 4px solid #ff9500;
        }
        
        .priority-low {
            border-left: 4px solid #34c759;
        }
        
        .status-completed {
            opacity: 0.6;
            text-decoration: line-through;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ä»»åŠ¡ç®¡ç†å™¨</h1>
            <button class="btn btn-primary" onclick="toggleAddForm()">
                + æ–°å»ºä»»åŠ¡
            </button>
        </div>
        
        <div class="add-task-form" id="addTaskForm" style="display: none;">
            <h3>æ–°å»ºä»»åŠ¡</h3>
            <div class="form-group">
                <label>ä»»åŠ¡æ ‡é¢˜ *</label>
                <input type="text" id="taskTitle" placeholder="è¾“å…¥ä»»åŠ¡æ ‡é¢˜">
            </div>
            <div class="form-group">
                <label>ä¼˜å…ˆçº§</label>
                <select id="taskPriority">
                    <option value="é«˜">é«˜</option>
                    <option value="ä¸­" selected>ä¸­</option>
                    <option value="ä½">ä½</option>
                </select>
            </div>
            <div class="form-group">
                <label>æˆªæ­¢æ—¥æœŸ</label>
                <input type="date" id="taskDueDate">
            </div>
            <div class="form-group">
                <label>æè¿°</label>
                <textarea id="taskDescription" rows="3" placeholder="ä»»åŠ¡æè¿°ï¼ˆå¯é€‰ï¼‰"></textarea>
            </div>
            <div style="display: flex; gap: 10px;">
                <button class="btn btn-primary" onclick="createTask()">åˆ›å»º</button>
                <button class="btn" onclick="toggleAddForm()">å–æ¶ˆ</button>
            </div>
        </div>
        
        <div class="task-list" id="taskList">
            <div style="padding: 50px; text-align: center; color: #999;">
                åŠ è½½ä¸­...
            </div>
        </div>
    </div>
    
    ${webCommunicator}
    
    <script>
        let tasks = [];
        
        // æ³¨å†Œæ¶ˆæ¯å¤„ç†å™¨
        comm.on('tasksLoaded', (data) => {
            tasks = data;
            renderTasks();
        });
        
        comm.on('taskCreated', (task) => {
            tasks.push(task);
            renderTasks();
            toggleAddForm();
            clearForm();
        });
        
        comm.on('taskUpdated', (data) => {
            if (data.success) {
                loadTasks();
            }
        });
        
        comm.on('taskDeleted', (data) => {
            tasks = tasks.filter(t => t.id !== data.id);
            renderTasks();
        });
        
        // åŠ è½½ä»»åŠ¡
        function loadTasks() {
            comm.send('browser://get-tasks', {});
        }
        
        // æ¸²æŸ“ä»»åŠ¡åˆ—è¡¨
        function renderTasks() {
            const listEl = document.getElementById('taskList');
            
            if (tasks.length === 0) {
                listEl.innerHTML = '<div style="padding: 50px; text-align: center; color: #999;">æš‚æ— ä»»åŠ¡</div>';
                return;
            }
            
            listEl.innerHTML = tasks.map(task => \`
                <div class="task-item priority-\${task.priority.toLowerCase()} \${task.status === 'å·²å®Œæˆ' ? 'status-completed' : ''}">
                    <input type="checkbox" 
                           class="task-checkbox" 
                           \${task.status === 'å·²å®Œæˆ' ? 'checked' : ''}
                           onchange="toggleTaskStatus('\${task.id}', this.checked)">
                    <div class="task-content">
                        <div class="task-title">\${task.title}</div>
                        <div class="task-meta">
                            ä¼˜å…ˆçº§ï¼š\${task.priority} | 
                            \${task.dueDate ? 'æˆªæ­¢ï¼š' + task.dueDate : 'æ— æˆªæ­¢æ—¥æœŸ'}
                        </div>
                    </div>
                    <div class="task-actions">
                        <button class="btn btn-danger" onclick="deleteTask('\${task.id}')">
                            åˆ é™¤
                        </button>
                    </div>
                </div>
            \`).join('');
        }
        
        // åˆ‡æ¢æ·»åŠ è¡¨å•
        function toggleAddForm() {
            const form = document.getElementById('addTaskForm');
            form.style.display = form.style.display === 'none' ? 'block' : 'none';
        }
        
        // åˆ›å»ºä»»åŠ¡
        function createTask() {
            const title = document.getElementById('taskTitle').value.trim();
            if (!title) {
                alert('è¯·è¾“å…¥ä»»åŠ¡æ ‡é¢˜');
                return;
            }
            
            const taskData = {
                title: title,
                priority: document.getElementById('taskPriority').value,
                dueDate: document.getElementById('taskDueDate').value,
                description: document.getElementById('taskDescription').value,
                status: 'å¾…åŠ'
            };
            
            comm.send('browser://create-task', taskData);
        }
        
        // åˆ‡æ¢ä»»åŠ¡çŠ¶æ€
        function toggleTaskStatus(taskId, completed) {
            comm.send('browser://update-task', {
                id: taskId,
                status: completed ? 'å·²å®Œæˆ' : 'å¾…åŠ'
            });
        }
        
        // åˆ é™¤ä»»åŠ¡
        function deleteTask(taskId) {
            if (confirm('ç¡®å®šè¦åˆ é™¤è¿™ä¸ªä»»åŠ¡å—ï¼Ÿ')) {
                comm.send('browser://delete-task', { id: taskId });
            }
        }
        
        // æ¸…ç©ºè¡¨å•
        function clearForm() {
            document.getElementById('taskTitle').value = '';
            document.getElementById('taskPriority').value = 'ä¸­';
            document.getElementById('taskDueDate').value = '';
            document.getElementById('taskDescription').value = '';
        }
        
        // åˆå§‹åŒ–
        window.onload = () => {
            loadTasks();
        };
    </script>
</body>
</html>
        `;
    }
}
```

### ğŸ’¡ é«˜çº§æŠ€å·§

#### 1. æ•°æ®ç¼“å­˜ä¸åŒæ­¥

```javascript
// å®ç°æ•°æ®ç¼“å­˜ä»¥æé«˜æ€§èƒ½
class DataCache {
    constructor() {
        this.cache = new Map();
        this.dirty = new Set(); // æ ‡è®°éœ€è¦åŒæ­¥çš„æ•°æ®
    }
    
    // è·å–æ•°æ®
    get(key) {
        return this.cache.get(key);
    }
    
    // è®¾ç½®æ•°æ®
    set(key, value) {
        this.cache.set(key, value);
        this.dirty.add(key);
    }
    
    // æ‰¹é‡åŒæ­¥
    async sync(syncFunction) {
        if (this.dirty.size === 0) return;
        
        let toSync = Array.from(this.dirty);
        this.dirty.clear();
        
        for (let key of toSync) {
            await syncFunction(key, this.cache.get(key));
        }
    }
}
```

#### 2. é”™è¯¯å¤„ç†ä¸é‡è¯•

```javascript
// å¸¦é‡è¯•æœºåˆ¶çš„é€šä¿¡
class ReliableCommunicator {
    constructor(webview, maxRetries = 3) {
        this.webview = webview;
        this.maxRetries = maxRetries;
    }
    
    async sendWithRetry(code, retries = 0) {
        try {
            return await this.webview.evaluateJavaScript(code);
        } catch (error) {
            if (retries < this.maxRetries) {
                console.log(`é‡è¯• ${retries + 1}/${this.maxRetries}`);
                await this.delay(1000 * (retries + 1)); // é€’å¢å»¶è¿Ÿ
                return this.sendWithRetry(code, retries + 1);
            }
            throw error;
        }
    }
    
    delay(ms) {
        return new Promise(resolve => setTimeout(resolve, ms));
    }
}
```

### ğŸ“‹ æœ¬ç« å°ç»“

æ­å–œä½ ï¼ç°åœ¨ä½ å·²ç»æŒæ¡äº†åŒå‘é€šä¿¡çš„æ ¸å¿ƒæŠ€æœ¯ï¼š
1. âœ… è®¾è®¡äº†å®Œæ•´çš„é€šä¿¡åè®®
2. âœ… å®ç°äº†æ¶ˆæ¯å¤„ç†æ¡†æ¶
3. âœ… åˆ›å»ºäº†ä»»åŠ¡ç®¡ç†ç³»ç»Ÿå®ä¾‹
4. âœ… å­¦ä¼šäº†æ•°æ®ç¼“å­˜å’Œé”™è¯¯å¤„ç†
5. âœ… ç†è§£äº†å®æ—¶åŒæ­¥çš„å®ç°æ–¹å¼

é€šè¿‡è¿™ä¸ªä»»åŠ¡ç®¡ç†ç³»ç»Ÿçš„ä¾‹å­ï¼Œä½ å¯ä»¥çœ‹åˆ°ï¼š
- ç½‘é¡µæä¾›äº†ä¸°å¯Œçš„ç”¨æˆ·ç•Œé¢
- æ’ä»¶è´Ÿè´£æ•°æ®çš„æŒä¹…åŒ–å­˜å‚¨
- åŒå‘é€šä¿¡è®©ä¸¤è€…å®Œç¾é…åˆ

ä½ å¯ä»¥åŸºäºè¿™ä¸ªæ¡†æ¶å¼€å‘æ›´å¤šåŠŸèƒ½ï¼Œæ¯”å¦‚ï¼š
- ğŸ“Š æ•°æ®åˆ†æä»ªè¡¨æ¿
- ğŸ¤– AI è¾…åŠ©å·¥å…·
- ğŸ“š çŸ¥è¯†ç®¡ç†ç³»ç»Ÿ
- ğŸ¯ å­¦ä¹ è¿›åº¦è¿½è¸ªå™¨

ä¸‹ä¸€ç« ï¼Œæˆ‘ä»¬å°†å­¦ä¹ ä¸€äº›è¿›é˜¶æŠ€å·§ï¼Œè®©ä½ çš„æ’ä»¶æ›´åŠ ä¸“ä¸šå’Œå¼ºå¤§ï¼

---

## ç¬¬å…­éƒ¨åˆ†ï¼šè¿›é˜¶æŠ€å·§

### ğŸ¯ æœ¬ç« ç›®æ ‡

å­¦å®Œæœ¬ç« ï¼Œä½ å°†æŒæ¡ï¼š
- é«˜æ•ˆå¤„ç†å›¾ç‰‡å’Œè§†é¢‘æ•°æ®
- ä¼˜åŒ–æ€§èƒ½å’Œå†…å­˜ä½¿ç”¨
- å¤„ç†å¤§é‡æ•°æ®çš„æŠ€å·§
- è°ƒè¯•å’Œé”™è¯¯å¤„ç†çš„æœ€ä½³å®è·µ

### ğŸ–¼ï¸ Base64 å›¾ç‰‡å¤„ç†è¿›é˜¶

#### 1. å›¾ç‰‡å‹ç¼©å’Œä¼˜åŒ–

åœ¨å¤„ç†å›¾ç‰‡æ—¶ï¼ŒBase64 ç¼–ç ä¼šå¢åŠ çº¦ 33% çš„æ•°æ®å¤§å°ã€‚è¿™é‡Œæ˜¯ä¸€äº›ä¼˜åŒ–æŠ€å·§ï¼š

```javascript
// å‹ç¼©å›¾ç‰‡è´¨é‡
async function compressImage(imageUrl, quality = 0.8) {
    return await this.webview.evaluateJavaScript(`
        new Promise((resolve) => {
            const img = new Image();
            img.crossOrigin = 'anonymous';
            
            img.onload = function() {
                const canvas = document.createElement('canvas');
                
                // è®¡ç®—åˆé€‚çš„å°ºå¯¸ï¼ˆæœ€å¤§ 1000pxï¼‰
                let width = this.width;
                let height = this.height;
                const maxSize = 1000;
                
                if (width > maxSize || height > maxSize) {
                    if (width > height) {
                        height = (height * maxSize) / width;
                        width = maxSize;
                    } else {
                        width = (width * maxSize) / height;
                        height = maxSize;
                    }
                }
                
                canvas.width = width;
                canvas.height = height;
                
                const ctx = canvas.getContext('2d');
                ctx.drawImage(this, 0, 0, width, height);
                
                // ä½¿ç”¨ JPEG æ ¼å¼å’ŒæŒ‡å®šè´¨é‡
                const dataUrl = canvas.toDataURL('image/jpeg', ${quality});
                
                // è¿”å›å‹ç¼©åçš„å›¾ç‰‡å’Œä¿¡æ¯
                resolve({
                    dataUrl: dataUrl,
                    originalSize: this.width + 'x' + this.height,
                    compressedSize: width + 'x' + height,
                    sizeReduction: Math.round((1 - dataUrl.length / (this.width * this.height * 4)) * 100)
                });
            };
            
            img.onerror = () => resolve(null);
            img.src = '${imageUrl}';
        })
    `);
}

// æ‰¹é‡å¤„ç†å›¾ç‰‡
async function batchProcessImages(imageUrls, maxConcurrent = 3) {
    const results = [];
    const chunks = [];
    
    // åˆ†ç»„å¤„ç†ï¼Œé¿å…ä¸€æ¬¡æ€§å¤„ç†å¤ªå¤š
    for (let i = 0; i < imageUrls.length; i += maxConcurrent) {
        chunks.push(imageUrls.slice(i, i + maxConcurrent));
    }
    
    for (const chunk of chunks) {
        const promises = chunk.map(url => compressImage(url));
        const chunkResults = await Promise.all(promises);
        results.push(...chunkResults);
        
        // ç»™æµè§ˆå™¨ä¸€äº›å–˜æ¯æ—¶é—´
        await new Promise(resolve => setTimeout(resolve, 100));
    }
    
    return results;
}
```

#### 2. å›¾ç‰‡æ‡’åŠ è½½å’Œæ¸è¿›å¼æ˜¾ç¤º

```javascript
// åˆ›å»ºå ä½å›¾ç‰‡
function createPlaceholder(width, height) {
    // åˆ›å»ºä¸€ä¸ªå°çš„å ä½å›¾
    const svg = `
        <svg width="${width}" height="${height}" xmlns="http://www.w3.org/2000/svg">
            <rect width="100%" height="100%" fill="#f0f0f0"/>
            <text x="50%" y="50%" text-anchor="middle" dy=".3em" fill="#999">
                åŠ è½½ä¸­...
            </text>
        </svg>
    `;
    return 'data:image/svg+xml;base64,' + btoa(svg);
}

// æ¸è¿›å¼å›¾ç‰‡åŠ è½½
let progressiveImageLoader = `
<script>
class ProgressiveImageLoader {
    constructor() {
        this.observer = null;
        this.init();
    }
    
    init() {
        // ä½¿ç”¨ Intersection Observer å®ç°æ‡’åŠ è½½
        this.observer = new IntersectionObserver((entries) => {
            entries.forEach(entry => {
                if (entry.isIntersecting) {
                    this.loadImage(entry.target);
                    this.observer.unobserve(entry.target);
                }
            });
        }, {
            rootMargin: '50px' // æå‰ 50px å¼€å§‹åŠ è½½
        });
        
        // è§‚å¯Ÿæ‰€æœ‰æ‡’åŠ è½½å›¾ç‰‡
        document.querySelectorAll('img[data-src]').forEach(img => {
            this.observer.observe(img);
        });
    }
    
    async loadImage(img) {
        const src = img.dataset.src;
        
        // å…ˆåŠ è½½ä½è´¨é‡ç‰ˆæœ¬
        if (img.dataset.lowSrc) {
            await this.loadSrc(img, img.dataset.lowSrc);
            img.style.filter = 'blur(5px)';
        }
        
        // åŠ è½½é«˜è´¨é‡ç‰ˆæœ¬
        await this.loadSrc(img, src);
        img.style.filter = 'none';
        img.style.transition = 'filter 0.3s';
    }
    
    loadSrc(img, src) {
        return new Promise((resolve) => {
            const tempImg = new Image();
            tempImg.onload = () => {
                img.src = src;
                resolve();
            };
            tempImg.onerror = resolve;
            tempImg.src = src;
        });
    }
}

// é¡µé¢åŠ è½½å®Œæˆååˆå§‹åŒ–
window.addEventListener('DOMContentLoaded', () => {
    new ProgressiveImageLoader();
});
</script>
`;
```

### ğŸ¥ è§†é¢‘å¤„ç†é«˜çº§æŠ€å·§

#### 1. ç²¾ç¡®çš„è§†é¢‘æ—¶é—´æˆ³å’Œé¢„è§ˆ

```javascript
// é«˜çº§è§†é¢‘æˆªå›¾ç±»
class VideoProcessor {
    constructor(webview) {
        this.webview = webview;
    }
    
    // è·å–å¤šä¸ªæ—¶é—´ç‚¹çš„æˆªå›¾
    async getMultipleFrames(timestamps) {
        return await this.webview.evaluateJavaScript(`
            new Promise(async (resolve) => {
                const video = document.querySelector('video');
                if (!video) {
                    resolve([]);
                    return;
                }
                
                const frames = [];
                const canvas = document.createElement('canvas');
                canvas.width = video.videoWidth / 2; // ç¼©å°å°ºå¯¸
                canvas.height = video.videoHeight / 2;
                const ctx = canvas.getContext('2d');
                
                for (const timestamp of ${JSON.stringify(timestamps)}) {
                    // è·³è½¬åˆ°æŒ‡å®šæ—¶é—´
                    video.currentTime = timestamp;
                    
                    // ç­‰å¾…è·³è½¬å®Œæˆ
                    await new Promise(resolve => {
                        video.onseeked = resolve;
                    });
                    
                    // æˆªå›¾
                    ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
                    
                    frames.push({
                        timestamp: timestamp,
                        dataUrl: canvas.toDataURL('image/jpeg', 0.7),
                        timeString: formatTime(timestamp)
                    });
                }
                
                resolve(frames);
                
                function formatTime(seconds) {
                    const h = Math.floor(seconds / 3600);
                    const m = Math.floor((seconds % 3600) / 60);
                    const s = Math.floor(seconds % 60);
                    
                    if (h > 0) {
                        return h + ':' + String(m).padStart(2, '0') + ':' + String(s).padStart(2, '0');
                    }
                    return m + ':' + String(s).padStart(2, '0');
                }
            })
        `);
    }
    
    // åˆ›å»ºè§†é¢‘é¢„è§ˆæ¡
    async createVideoPreviewStrip(duration, frameCount = 10) {
        // è®¡ç®—è¦æˆªå–çš„æ—¶é—´ç‚¹
        const timestamps = [];
        const interval = duration / frameCount;
        
        for (let i = 0; i < frameCount; i++) {
            timestamps.push(i * interval);
        }
        
        const frames = await this.getMultipleFrames(timestamps);
        
        // åˆ›å»ºé¢„è§ˆæ¡çš„ HTML
        const previewHtml = frames.map(frame => `
            <div class="preview-frame" data-time="${frame.timestamp}">
                <img src="${frame.dataUrl}" alt="${frame.timeString}">
                <span class="time-label">${frame.timeString}</span>
            </div>
        `).join('');
        
        return `
            <div class="video-preview-strip">
                ${previewHtml}
            </div>
            <style>
                .video-preview-strip {
                    display: flex;
                    overflow-x: auto;
                    gap: 5px;
                    padding: 10px;
                    background: #f0f0f0;
                    border-radius: 8px;
                }
                .preview-frame {
                    flex-shrink: 0;
                    position: relative;
                    cursor: pointer;
                }
                .preview-frame img {
                    width: 120px;
                    height: 68px;
                    object-fit: cover;
                    border-radius: 4px;
                }
                .time-label {
                    position: absolute;
                    bottom: 2px;
                    right: 2px;
                    background: rgba(0, 0, 0, 0.7);
                    color: white;
                    padding: 2px 4px;
                    font-size: 10px;
                    border-radius: 2px;
                }
            </style>
        `;
    }
    
    // æ™ºèƒ½è§†é¢‘åˆ†æ
    async analyzeVideo() {
        return await this.webview.evaluateJavaScript(`
            const video = document.querySelector('video');
            if (!video) return null;
            
            // æ”¶é›†è§†é¢‘ä¿¡æ¯
            const info = {
                duration: video.duration,
                currentTime: video.currentTime,
                playbackRate: video.playbackRate,
                volume: video.volume,
                muted: video.muted,
                paused: video.paused,
                buffered: [],
                // è§†é¢‘è´¨é‡ä¿¡æ¯
                videoWidth: video.videoWidth,
                videoHeight: video.videoHeight,
                // è·å–è§†é¢‘æ ‡é¢˜
                title: document.title,
                // è·å–è§†é¢‘æº
                source: video.currentSrc || video.src
            };
            
            // è·å–ç¼“å†²åŒºä¿¡æ¯
            for (let i = 0; i < video.buffered.length; i++) {
                info.buffered.push({
                    start: video.buffered.start(i),
                    end: video.buffered.end(i)
                });
            }
            
            // è®¡ç®—è§‚çœ‹è¿›åº¦
            info.watchProgress = (info.currentTime / info.duration * 100).toFixed(1) + '%';
            
            // æ£€æµ‹è§†é¢‘å¹³å°
            const host = window.location.hostname;
            if (host.includes('bilibili.com')) {
                info.platform = 'Bilibili';
                // å°è¯•è·å– BV å·
                const bvMatch = window.location.pathname.match(/BV[0-9A-Za-z]+/);
                if (bvMatch) info.videoId = bvMatch[0];
            } else if (host.includes('youtube.com')) {
                info.platform = 'YouTube';
                const vMatch = window.location.search.match(/v=([^&]+)/);
                if (vMatch) info.videoId = vMatch[1];
            }
            
            return info;
        `);
    }
}
```

### ğŸ“ Markdown è½¬æ¢é«˜çº§æŠ€å·§

#### 1. å¯Œæ–‡æœ¬åˆ° Markdown çš„æ™ºèƒ½è½¬æ¢

```javascript
// HTML åˆ° Markdown è½¬æ¢å™¨
class HtmlToMarkdownConverter {
    // è½¬æ¢è§„åˆ™æ˜ å°„
    static rules = {
        'h1': (node) => `# ${node.textContent}\n\n`,
        'h2': (node) => `## ${node.textContent}\n\n`,
        'h3': (node) => `### ${node.textContent}\n\n`,
        'h4': (node) => `#### ${node.textContent}\n\n`,
        'h5': (node) => `##### ${node.textContent}\n\n`,
        'h6': (node) => `###### ${node.textContent}\n\n`,
        'p': (node) => `${this.processInlineElements(node)}\n\n`,
        'br': () => '\n',
        'hr': () => '\n---\n\n',
        'blockquote': (node) => `> ${this.processInlineElements(node)}\n\n`,
        'ul': (node) => this.processList(node, false),
        'ol': (node) => this.processList(node, true),
        'code': (node) => `\`${node.textContent}\``,
        'pre': (node) => `\`\`\`\n${node.textContent}\n\`\`\`\n\n`,
        'a': (node) => `[${node.textContent}](${node.href})`,
        'img': (node) => `![${node.alt || ''}](${node.src})`,
        'strong': (node) => `**${node.textContent}**`,
        'b': (node) => `**${node.textContent}**`,
        'em': (node) => `*${node.textContent}*`,
        'i': (node) => `*${node.textContent}*`,
        'del': (node) => `~~${node.textContent}~~`,
        'table': (node) => this.processTable(node)
    };
    
    static convert(html) {
        // åˆ›å»ºä¸´æ—¶ DOM
        const div = document.createElement('div');
        div.innerHTML = html;
        
        return this.processNode(div);
    }
    
    static processNode(node) {
        let markdown = '';
        
        for (const child of node.childNodes) {
            if (child.nodeType === Node.TEXT_NODE) {
                markdown += child.textContent;
            } else if (child.nodeType === Node.ELEMENT_NODE) {
                const tagName = child.tagName.toLowerCase();
                const rule = this.rules[tagName];
                
                if (rule) {
                    markdown += rule(child);
                } else {
                    // é€’å½’å¤„ç†æœªçŸ¥å…ƒç´ 
                    markdown += this.processNode(child);
                }
            }
        }
        
        return markdown;
    }
    
    static processInlineElements(node) {
        let text = '';
        
        for (const child of node.childNodes) {
            if (child.nodeType === Node.TEXT_NODE) {
                text += child.textContent;
            } else if (child.nodeType === Node.ELEMENT_NODE) {
                const tagName = child.tagName.toLowerCase();
                const rule = this.rules[tagName];
                
                if (rule) {
                    text += rule(child);
                } else {
                    text += child.textContent;
                }
            }
        }
        
        return text;
    }
    
    static processList(listNode, ordered) {
        let markdown = '';
        const items = listNode.querySelectorAll('li');
        
        items.forEach((item, index) => {
            const prefix = ordered ? `${index + 1}. ` : '- ';
            markdown += prefix + this.processInlineElements(item) + '\n';
        });
        
        return markdown + '\n';
    }
    
    static processTable(tableNode) {
        let markdown = '';
        const rows = tableNode.querySelectorAll('tr');
        
        if (rows.length === 0) return '';
        
        // å¤„ç†è¡¨å¤´
        const headerCells = rows[0].querySelectorAll('th, td');
        if (headerCells.length > 0) {
            markdown += '| ' + Array.from(headerCells)
                .map(cell => cell.textContent.trim())
                .join(' | ') + ' |\n';
            
            markdown += '| ' + Array(headerCells.length)
                .fill('---')
                .join(' | ') + ' |\n';
        }
        
        // å¤„ç†æ•°æ®è¡Œ
        for (let i = 1; i < rows.length; i++) {
            const cells = rows[i].querySelectorAll('td');
            markdown += '| ' + Array.from(cells)
                .map(cell => cell.textContent.trim())
                .join(' | ') + ' |\n';
        }
        
        return markdown + '\n';
    }
}

// ä½¿ç”¨ç¤ºä¾‹
async function convertWebPageToMarkdown() {
    const markdown = await this.webview.evaluateJavaScript(`
        // è·å–ä¸»è¦å†…å®¹åŒºåŸŸ
        const content = document.querySelector('article') || 
                       document.querySelector('.content') || 
                       document.querySelector('main') || 
                       document.body;
        
        // æ¸…ç†ä¸éœ€è¦çš„å…ƒç´ 
        const clone = content.cloneNode(true);
        clone.querySelectorAll('script, style, nav, aside').forEach(el => el.remove());
        
        // è½¬æ¢ä¸º Markdown
        ${HtmlToMarkdownConverter.toString()}
        HtmlToMarkdownConverter.convert(clone.innerHTML);
    `);
    
    return markdown;
}
```

### âš¡ æ€§èƒ½ä¼˜åŒ–æŠ€å·§

#### 1. æ‰¹é‡æ“ä½œä¼˜åŒ–

```javascript
// æ‰¹é‡åˆ›å»ºå¡ç‰‡çš„ä¼˜åŒ–æ–¹æ¡ˆ
class BatchNoteCreator {
    constructor() {
        this.queue = [];
        this.processing = false;
        this.batchSize = 10;
        this.delayBetweenBatches = 500;
    }
    
    // æ·»åŠ åˆ°é˜Ÿåˆ—
    async add(noteData) {
        this.queue.push(noteData);
        
        if (!this.processing) {
            this.processQueue();
        }
    }
    
    // å¤„ç†é˜Ÿåˆ—
    async processQueue() {
        if (this.queue.length === 0) {
            this.processing = false;
            return;
        }
        
        this.processing = true;
        
        // ä½¿ç”¨ undoGrouping å°†æ‰¹é‡æ“ä½œä½œä¸ºä¸€ä¸ªæ’¤é”€å•å…ƒ
        MNUtil.undoGrouping(() => {
            const batch = this.queue.splice(0, this.batchSize);
            
            batch.forEach(data => {
                const note = MNUtil.createNote(MNUtil.currentNotebook);
                note.noteTitle = data.title;
                note.noteText = data.text;
                
                // æ‰¹é‡æ·»åŠ è¯„è®º
                if (data.comments) {
                    data.comments.forEach(comment => {
                        note.appendTextComment(comment);
                    });
                }
            });
        });
        
        // æ˜¾ç¤ºè¿›åº¦
        const remaining = this.queue.length;
        if (remaining > 0) {
            MNUtil.showHUD(`æ­£åœ¨å¤„ç†... å‰©ä½™ ${remaining} ä¸ª`);
            
            // ç»§ç»­å¤„ç†ä¸‹ä¸€æ‰¹
            setTimeout(() => this.processQueue(), this.delayBetweenBatches);
        } else {
            MNUtil.showHUD("âœ… æ‰¹é‡åˆ›å»ºå®Œæˆ");
            this.processing = false;
        }
    }
}

// å†…å­˜ä¼˜åŒ–ï¼šåŠæ—¶é‡Šæ”¾å¤§å¯¹è±¡
class MemoryManager {
    static cleanup(object) {
        if (typeof object !== 'object' || object === null) return;
        
        // æ¸…ç†æ•°ç»„
        if (Array.isArray(object)) {
            object.length = 0;
            return;
        }
        
        // æ¸…ç†å¯¹è±¡å±æ€§
        for (let key in object) {
            if (object.hasOwnProperty(key)) {
                delete object[key];
            }
        }
    }
    
    // ç›‘æ§å†…å­˜ä½¿ç”¨
    static async checkMemory() {
        if (performance && performance.memory) {
            const used = performance.memory.usedJSHeapSize;
            const total = performance.memory.totalJSHeapSize;
            const percent = (used / total * 100).toFixed(1);
            
            console.log(`å†…å­˜ä½¿ç”¨: ${percent}%`);
            
            // å¦‚æœå†…å­˜ä½¿ç”¨è¶…è¿‡ 80%ï¼Œå»ºè®®æ¸…ç†
            if (percent > 80) {
                console.warn("å†…å­˜ä½¿ç”¨ç‡è¿‡é«˜ï¼Œå»ºè®®æ¸…ç†ç¼“å­˜");
                return true;
            }
        }
        return false;
    }
}
```

#### 2. é˜²æŠ–å’ŒèŠ‚æµ

```javascript
// å·¥å…·å‡½æ•°
const Utils = {
    // é˜²æŠ–ï¼šåœ¨åœæ­¢è§¦å‘åæ‰§è¡Œ
    debounce(func, wait) {
        let timeout;
        return function executedFunction(...args) {
            const later = () => {
                clearTimeout(timeout);
                func(...args);
            };
            clearTimeout(timeout);
            timeout = setTimeout(later, wait);
        };
    },
    
    // èŠ‚æµï¼šå›ºå®šæ—¶é—´é—´éš”æ‰§è¡Œ
    throttle(func, limit) {
        let inThrottle;
        return function(...args) {
            if (!inThrottle) {
                func.apply(this, args);
                inThrottle = true;
                setTimeout(() => inThrottle = false, limit);
            }
        };
    },
    
    // è¯·æ±‚åˆå¹¶
    batchRequests(requestFn, delay = 100) {
        let pending = [];
        let timer = null;
        
        return function(data) {
            pending.push(data);
            
            if (timer) clearTimeout(timer);
            
            timer = setTimeout(() => {
                const batch = pending.slice();
                pending = [];
                requestFn(batch);
            }, delay);
        };
    }
};

// ä½¿ç”¨ç¤ºä¾‹ï¼šä¼˜åŒ–æœç´¢
const optimizedSearch = Utils.debounce(async (keyword) => {
    const results = await searchNotes(keyword);
    updateSearchResults(results);
}, 300);

// ä½¿ç”¨ç¤ºä¾‹ï¼šä¼˜åŒ–æ»šåŠ¨
const optimizedScroll = Utils.throttle(() => {
    updateVisibleCards();
}, 100);
```

### ğŸ› è°ƒè¯•æŠ€å·§

#### 1. å¢å¼ºçš„æ—¥å¿—ç³»ç»Ÿ

```javascript
// å¼€å‘è€…å·¥å…·ç±»
class DevTools {
    static logLevels = {
        DEBUG: 0,
        INFO: 1,
        WARN: 2,
        ERROR: 3
    };
    
    static currentLevel = this.logLevels.DEBUG;
    static logs = [];
    static maxLogs = 1000;
    
    static log(level, category, message, data) {
        if (level < this.currentLevel) return;
        
        const entry = {
            timestamp: new Date().toISOString(),
            level: Object.keys(this.logLevels).find(k => this.logLevels[k] === level),
            category,
            message,
            data
        };
        
        this.logs.push(entry);
        
        // é™åˆ¶æ—¥å¿—æ•°é‡
        if (this.logs.length > this.maxLogs) {
            this.logs.shift();
        }
        
        // æ§åˆ¶å°è¾“å‡º
        const color = ['blue', 'green', 'orange', 'red'][level];
        console.log(
            `%c[${entry.level}] ${category}: ${message}`,
            `color: ${color}; font-weight: bold`,
            data || ''
        );
    }
    
    static debug(category, message, data) {
        this.log(this.logLevels.DEBUG, category, message, data);
    }
    
    static info(category, message, data) {
        this.log(this.logLevels.INFO, category, message, data);
    }
    
    static warn(category, message, data) {
        this.log(this.logLevels.WARN, category, message, data);
    }
    
    static error(category, message, data) {
        this.log(this.logLevels.ERROR, category, message, data);
    }
    
    // å¯¼å‡ºæ—¥å¿—
    static exportLogs() {
        const logText = this.logs.map(log => 
            `${log.timestamp} [${log.level}] ${log.category}: ${log.message} ${
                log.data ? JSON.stringify(log.data) : ''
            }`
        ).join('\n');
        
        // åˆ›å»ºæ—¥å¿—å¡ç‰‡
        const note = MNUtil.createNote(MNUtil.currentNotebook);
        note.noteTitle = `è°ƒè¯•æ—¥å¿— - ${new Date().toLocaleString()}`;
        note.noteText = logText;
        
        MNUtil.showHUD("æ—¥å¿—å·²å¯¼å‡ºåˆ°å¡ç‰‡");
    }
    
    // æ€§èƒ½æµ‹é‡
    static measure(name, fn) {
        const start = performance.now();
        const result = fn();
        const duration = performance.now() - start;
        
        this.info('Performance', `${name} took ${duration.toFixed(2)}ms`);
        
        return result;
    }
}

// ä½¿ç”¨ç¤ºä¾‹
DevTools.debug('DataExtractor', 'å¼€å§‹æå–æ•°æ®', { url: window.location.href });
DevTools.measure('å›¾ç‰‡å‹ç¼©', () => compressImage(imageUrl));
```

### ğŸ“‹ æœ¬ç« å°ç»“

é€šè¿‡æœ¬ç« çš„å­¦ä¹ ï¼Œä½ å·²ç»æŒæ¡äº†ï¼š
1. âœ… é«˜æ•ˆçš„å›¾ç‰‡å¤„ç†å’Œå‹ç¼©æŠ€å·§
2. âœ… è§†é¢‘æ•°æ®çš„é«˜çº§å¤„ç†æ–¹æ³•
3. âœ… HTML åˆ° Markdown çš„æ™ºèƒ½è½¬æ¢
4. âœ… æ€§èƒ½ä¼˜åŒ–çš„å„ç§ç­–ç•¥
5. âœ… ä¸“ä¸šçš„è°ƒè¯•å’Œæ—¥å¿—ç³»ç»Ÿ

è¿™äº›è¿›é˜¶æŠ€å·§å°†å¸®åŠ©ä½ å¼€å‘å‡ºæ›´åŠ ä¸“ä¸šã€é«˜æ•ˆçš„æ’ä»¶ã€‚è®°ä½ï¼š
- å§‹ç»ˆè€ƒè™‘æ€§èƒ½å’Œç”¨æˆ·ä½“éªŒ
- åˆç†ä½¿ç”¨ç¼“å­˜å’Œæ‰¹å¤„ç†
- åšå¥½é”™è¯¯å¤„ç†å’Œæ—¥å¿—è®°å½•
- å®šæœŸæµ‹è¯•å’Œä¼˜åŒ–ä»£ç 

---

## ç¬¬ä¸ƒéƒ¨åˆ†ï¼šå®Œæ•´é¡¹ç›®å®æˆ˜ - æ™ºèƒ½å­¦ä¹ åŠ©æ‰‹

### ğŸ¯ é¡¹ç›®ç›®æ ‡

æˆ‘ä»¬å°†åˆ›å»ºä¸€ä¸ªåŠŸèƒ½å®Œæ•´çš„"æ™ºèƒ½å­¦ä¹ åŠ©æ‰‹"æ’ä»¶ï¼Œå®ƒèƒ½å¤Ÿï¼š
1. ğŸ“– è‡ªåŠ¨æå–ç½‘é¡µé‡ç‚¹å†…å®¹
2. ğŸ¤– ä½¿ç”¨ AI ç”Ÿæˆå­¦ä¹ ç¬”è®°
3. ğŸ“Š è¿½è¸ªå­¦ä¹ è¿›åº¦
4. ğŸ”„ åŒå‘åŒæ­¥ç¬”è®°å†…å®¹
5. ğŸ“ˆ ç”Ÿæˆå­¦ä¹ æŠ¥å‘Š

### ğŸ“ é¡¹ç›®æ¶æ„è®¾è®¡

```
æ™ºèƒ½å­¦ä¹ åŠ©æ‰‹
â”œâ”€â”€ æ’ä»¶ç«¯ (main.js)
â”‚   â”œâ”€â”€ æ•°æ®ç®¡ç†æ¨¡å—
â”‚   â”œâ”€â”€ AI æ¥å£æ¨¡å—
â”‚   â”œâ”€â”€ åŒæ­¥ç®¡ç†æ¨¡å—
â”‚   â””â”€â”€ ç»Ÿè®¡åˆ†ææ¨¡å—
â”œâ”€â”€ ç½‘é¡µç«¯ (webview.html)
â”‚   â”œâ”€â”€ å†…å®¹æå–ç•Œé¢
â”‚   â”œâ”€â”€ AI å¯¹è¯ç•Œé¢
â”‚   â”œâ”€â”€ è¿›åº¦è¿½è¸ªç•Œé¢
â”‚   â””â”€â”€ æŠ¥å‘Šå±•ç¤ºç•Œé¢
â””â”€â”€ é€šä¿¡å±‚
    â”œâ”€â”€ æ¶ˆæ¯åè®®å®šä¹‰
    â””â”€â”€ æ•°æ®ä¼ è¾“ä¼˜åŒ–
```

### ğŸ’» æ ¸å¿ƒä»£ç å®ç°

#### 1. ä¸»æ’ä»¶æ–‡ä»¶

```javascript
// SmartLearningAssistant.js
class SmartLearningAssistant {
    constructor() {
        this.name = "æ™ºèƒ½å­¦ä¹ åŠ©æ‰‹";
        this.version = "1.0.0";
        this.webview = null;
        this.messageHandler = null;
        this.aiService = new AIService();
        this.dataManager = new DataManager();
        this.syncManager = new SyncManager();
        
        this.init();
    }
    
    init() {
        // åˆ›å»º WebView
        this.createWebView();
        
        // è®¾ç½®æ¶ˆæ¯å¤„ç†
        this.setupMessageHandlers();
        
        // åˆå§‹åŒ–æ•°æ®
        this.loadUserData();
        
        // æ³¨å†Œæ’ä»¶å‘½ä»¤
        this.registerCommands();
    }
    
    createWebView() {
        this.webview = UIWebView.new();
        this.webview.frame = { x: 0, y: 0, width: 450, height: 700 };
        this.webview.layer.cornerRadius = 10;
        this.webview.layer.shadowOpacity = 0.3;
        
        // åŠ è½½ç•Œé¢
        this.webview.loadHTMLStringBaseURL(this.getHTML(), null);
    }
    
    setupMessageHandlers() {
        this.messageHandler = new MessageHandler(this.webview);
        
        // å†…å®¹æå–ç›¸å…³
        this.messageHandler.on('extract-content', this.handleExtractContent.bind(this));
        this.messageHandler.on('save-notes', this.handleSaveNotes.bind(this));
        
        // AI ç›¸å…³
        this.messageHandler.on('ai-explain', this.handleAIExplain.bind(this));
        this.messageHandler.on('ai-summarize', this.handleAISummarize.bind(this));
        this.messageHandler.on('ai-quiz', this.handleAIQuiz.bind(this));
        
        // è¿›åº¦è¿½è¸ª
        this.messageHandler.on('update-progress', this.handleUpdateProgress.bind(this));
        this.messageHandler.on('get-statistics', this.handleGetStatistics.bind(this));
        
        // åŒæ­¥ç›¸å…³
        this.messageHandler.on('sync-notes', this.handleSyncNotes.bind(this));
    }
    
    // æ™ºèƒ½å†…å®¹æå–
    async handleExtractContent(params) {
        try {
            DevTools.info('ContentExtraction', 'å¼€å§‹æå–å†…å®¹', params);
            
            const content = await this.webview.evaluateJavaScript(`
                // æ™ºèƒ½è¯†åˆ«é¡µé¢ç±»å‹
                const pageAnalyzer = new PageAnalyzer();
                const pageType = pageAnalyzer.analyze();
                
                // æ ¹æ®é¡µé¢ç±»å‹ä½¿ç”¨ä¸åŒçš„æå–ç­–ç•¥
                let extractor;
                switch(pageType) {
                    case 'article':
                        extractor = new ArticleExtractor();
                        break;
                    case 'video':
                        extractor = new VideoExtractor();
                        break;
                    case 'pdf':
                        extractor = new PDFExtractor();
                        break;
                    default:
                        extractor = new GeneralExtractor();
                }
                
                extractor.extract();
            `);
            
            // å¤„ç†æå–çš„å†…å®¹
            const processed = await this.processExtractedContent(content);
            
            // å‘é€å›ç½‘é¡µ
            this.messageHandler.send('content-extracted', processed);
            
        } catch (error) {
            DevTools.error('ContentExtraction', 'æå–å¤±è´¥', error);
            this.messageHandler.send('extraction-error', { 
                message: 'å†…å®¹æå–å¤±è´¥ï¼Œè¯·é‡è¯•' 
            });
        }
    }
    
    // AI è§£é‡ŠåŠŸèƒ½
    async handleAIExplain(params) {
        const { text, context } = params;
        
        try {
            // è°ƒç”¨ AI æœåŠ¡
            const explanation = await this.aiService.explain(text, context);
            
            // åˆ›å»ºè§£é‡Šå¡ç‰‡
            const note = MNUtil.createNote(MNUtil.currentNotebook);
            note.noteTitle = `ğŸ’¡ AI è§£é‡Š: ${text.substring(0, 30)}...`;
            
            // æ ¼å¼åŒ– AI å›å¤
            const formatted = this.formatAIResponse(explanation);
            note.noteText = formatted;
            
            // æ·»åŠ å…ƒæ•°æ®
            note.appendTextComment(`åŸæ–‡: ${text}`);
            note.appendTextComment(`æ—¶é—´: ${new Date().toLocaleString()}`);
            note.colorIndex = 3; // è“è‰²æ ‡è®°
            
            // æ›´æ–°å­¦ä¹ è®°å½•
            this.dataManager.addLearningRecord({
                type: 'ai_explain',
                content: text,
                result: explanation,
                timestamp: Date.now()
            });
            
            this.messageHandler.send('ai-explained', {
                noteId: note.noteId,
                explanation: formatted
            });
            
        } catch (error) {
            DevTools.error('AI', 'AIè§£é‡Šå¤±è´¥', error);
            this.messageHandler.send('ai-error', {
                message: 'AI æœåŠ¡æš‚æ—¶ä¸å¯ç”¨'
            });
        }
    }
    
    // AI æ€»ç»“åŠŸèƒ½
    async handleAISummarize(params) {
        const { content, type } = params;
        
        // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
        this.messageHandler.send('ai-processing', {
            message: 'æ­£åœ¨ç”Ÿæˆæ€»ç»“...'
        });
        
        try {
            // æ ¹æ®å†…å®¹ç±»å‹é€‰æ‹©æ€»ç»“ç­–ç•¥
            let summary;
            if (type === 'article') {
                summary = await this.aiService.summarizeArticle(content);
            } else if (type === 'video') {
                summary = await this.aiService.summarizeVideo(content);
            } else {
                summary = await this.aiService.summarize(content);
            }
            
            // åˆ›å»ºæ€»ç»“å¡ç‰‡
            const note = this.createSummaryNote(summary, content);
            
            // å‘é€ç»“æœ
            this.messageHandler.send('ai-summarized', {
                noteId: note.noteId,
                summary: summary
            });
            
        } catch (error) {
            this.handleAIError(error);
        }
    }
    
    // å­¦ä¹ è¿›åº¦è¿½è¸ª
    async handleUpdateProgress(params) {
        const { topicId, progress, timeSpent } = params;
        
        // æ›´æ–°è¿›åº¦æ•°æ®
        this.dataManager.updateProgress(topicId, {
            progress,
            timeSpent,
            lastUpdate: Date.now()
        });
        
        // æ£€æŸ¥æ˜¯å¦è¾¾åˆ°é‡Œç¨‹ç¢‘
        const milestones = this.checkMilestones(topicId, progress);
        if (milestones.length > 0) {
            this.celebrateMilestones(milestones);
        }
        
        // ç”Ÿæˆè¿›åº¦æŠ¥å‘Š
        const report = this.generateProgressReport(topicId);
        
        this.messageHandler.send('progress-updated', {
            report,
            milestones
        });
    }
    
    // è·å–ç»Ÿè®¡æ•°æ®
    async handleGetStatistics() {
        const stats = {
            // åŸºç¡€ç»Ÿè®¡
            totalNotes: this.dataManager.getTotalNotes(),
            todayNotes: this.dataManager.getTodayNotes(),
            weeklyNotes: this.dataManager.getWeeklyNotes(),
            
            // å­¦ä¹ æ—¶é—´ç»Ÿè®¡
            totalTime: this.dataManager.getTotalLearningTime(),
            todayTime: this.dataManager.getTodayLearningTime(),
            averageTime: this.dataManager.getAverageDailyTime(),
            
            // AI ä½¿ç”¨ç»Ÿè®¡
            aiUsage: {
                explains: this.dataManager.getAIUsageCount('explain'),
                summaries: this.dataManager.getAIUsageCount('summarize'),
                quizzes: this.dataManager.getAIUsageCount('quiz')
            },
            
            // å­¦ä¹ æ•ˆç‡åˆ†æ
            efficiency: this.analyzeLearmingEfficiency(),
            
            // çƒ­é—¨ä¸»é¢˜
            topTopics: this.dataManager.getTopTopics(5),
            
            // å­¦ä¹ æ›²çº¿æ•°æ®
            learningCurve: this.dataManager.getLearningCurve(30)
        };
        
        this.messageHandler.send('statistics-loaded', stats);
    }
    
    // ç”Ÿæˆå­¦ä¹ æŠ¥å‘Š
    generateWeeklyReport() {
        const report = {
            period: this.getWeekPeriod(),
            summary: this.dataManager.getWeeklySummary(),
            achievements: this.dataManager.getWeeklyAchievements(),
            recommendations: this.generateRecommendations(),
            visualData: this.prepareVisualizationData()
        };
        
        // åˆ›å»ºæŠ¥å‘Šå¡ç‰‡
        const note = MNUtil.createNote(MNUtil.currentNotebook);
        note.noteTitle = `ğŸ“Š å‘¨å­¦ä¹ æŠ¥å‘Š - ${report.period}`;
        
        // ç”Ÿæˆ Markdown æ ¼å¼çš„æŠ¥å‘Š
        const markdown = this.formatWeeklyReport(report);
        note.noteText = markdown;
        
        // æ·»åŠ å¯è§†åŒ–å›¾è¡¨
        note.appendHtmlComment(this.generateCharts(report.visualData));
        
        return note;
    }
    
    // è·å–å®Œæ•´çš„ HTML
    getHTML() {
        return `
<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>æ™ºèƒ½å­¦ä¹ åŠ©æ‰‹</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #f5f7fa;
            color: #333;
        }
        
        .container {
            height: 100vh;
            display: flex;
            flex-direction: column;
        }
        
        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        
        .header h1 {
            font-size: 24px;
            margin-bottom: 10px;
        }
        
        .tabs {
            display: flex;
            background: white;
            border-bottom: 1px solid #e0e0e0;
            overflow-x: auto;
        }
        
        .tab {
            padding: 15px 20px;
            cursor: pointer;
            white-space: nowrap;
            border-bottom: 3px solid transparent;
            transition: all 0.3s;
        }
        
        .tab:hover {
            background: #f5f5f5;
        }
        
        .tab.active {
            border-bottom-color: #667eea;
            color: #667eea;
            font-weight: 500;
        }
        
        .content {
            flex: 1;
            overflow-y: auto;
            padding: 20px;
        }
        
        .panel {
            display: none;
            animation: fadeIn 0.3s;
        }
        
        .panel.active {
            display: block;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        /* æå–é¢æ¿æ ·å¼ */
        .extract-panel {
            background: white;
            border-radius: 10px;
            padding: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
        }
        
        .extract-options {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 10px;
            margin-bottom: 20px;
        }
        
        .option-card {
            padding: 15px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            cursor: pointer;
            text-align: center;
            transition: all 0.3s;
        }
        
        .option-card:hover {
            border-color: #667eea;
            transform: translateY(-2px);
        }
        
        .option-card.selected {
            background: #667eea;
            color: white;
            border-color: #667eea;
        }
        
        .extract-button {
            width: 100%;
            padding: 12px;
            background: #667eea;
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            cursor: pointer;
            transition: background 0.3s;
        }
        
        .extract-button:hover {
            background: #5a67d8;
        }
        
        .extract-button:disabled {
            background: #ccc;
            cursor: not-allowed;
        }
        
        /* AI é¢æ¿æ ·å¼ */
        .ai-panel {
            display: grid;
            gap: 20px;
        }
        
        .ai-input {
            background: white;
            border-radius: 10px;
            padding: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
        }
        
        .ai-input textarea {
            width: 100%;
            min-height: 100px;
            padding: 10px;
            border: 1px solid #e0e0e0;
            border-radius: 5px;
            resize: vertical;
            font-family: inherit;
        }
        
        .ai-actions {
            display: flex;
            gap: 10px;
            margin-top: 10px;
        }
        
        .ai-button {
            flex: 1;
            padding: 10px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .ai-button.explain {
            background: #48bb78;
            color: white;
        }
        
        .ai-button.summarize {
            background: #4299e1;
            color: white;
        }
        
        .ai-button.quiz {
            background: #ed8936;
            color: white;
        }
        
        .ai-response {
            background: white;
            border-radius: 10px;
            padding: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
            white-space: pre-wrap;
            line-height: 1.6;
        }
        
        /* è¿›åº¦é¢æ¿æ ·å¼ */
        .progress-panel {
            display: grid;
            gap: 20px;
        }
        
        .progress-card {
            background: white;
            border-radius: 10px;
            padding: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
        }
        
        .progress-bar {
            height: 20px;
            background: #e0e0e0;
            border-radius: 10px;
            overflow: hidden;
            margin: 10px 0;
        }
        
        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #667eea, #764ba2);
            transition: width 0.5s;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 12px;
        }
        
        /* ç»Ÿè®¡é¢æ¿æ ·å¼ */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
        }
        
        .stat-card {
            background: white;
            border-radius: 10px;
            padding: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
            text-align: center;
        }
        
        .stat-value {
            font-size: 36px;
            font-weight: bold;
            color: #667eea;
            margin: 10px 0;
        }
        
        .stat-label {
            color: #666;
            font-size: 14px;
        }
        
        .chart-container {
            background: white;
            border-radius: 10px;
            padding: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
            height: 400px;
            position: relative;
        }
        
        /* åŠ è½½åŠ¨ç”» */
        .loader {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid #f3f3f3;
            border-top: 3px solid #667eea;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        /* æç¤ºä¿¡æ¯ */
        .toast {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: #333;
            color: white;
            padding: 12px 24px;
            border-radius: 50px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            opacity: 0;
            transition: opacity 0.3s;
            z-index: 1000;
        }
        
        .toast.show {
            opacity: 1;
        }
        
        .toast.success {
            background: #48bb78;
        }
        
        .toast.error {
            background: #e53e3e;
        }
        
        .toast.info {
            background: #4299e1;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ğŸ§  æ™ºèƒ½å­¦ä¹ åŠ©æ‰‹</h1>
            <p>è®©å­¦ä¹ æ›´é«˜æ•ˆã€æ›´æ™ºèƒ½</p>
        </div>
        
        <div class="tabs">
            <div class="tab active" data-tab="extract">ğŸ“– å†…å®¹æå–</div>
            <div class="tab" data-tab="ai">ğŸ¤– AI åŠ©æ‰‹</div>
            <div class="tab" data-tab="progress">ğŸ“ˆ å­¦ä¹ è¿›åº¦</div>
            <div class="tab" data-tab="stats">ğŸ“Š ç»Ÿè®¡åˆ†æ</div>
        </div>
        
        <div class="content">
            <!-- å†…å®¹æå–é¢æ¿ -->
            <div class="panel extract-panel active" data-panel="extract">
                <h2>æ™ºèƒ½å†…å®¹æå–</h2>
                <p style="margin: 10px 0; color: #666;">é€‰æ‹©è¦æå–çš„å†…å®¹ç±»å‹</p>
                
                <div class="extract-options">
                    <div class="option-card" data-type="auto">
                        <div style="font-size: 32px;">ğŸ”</div>
                        <div>è‡ªåŠ¨è¯†åˆ«</div>
                    </div>
                    <div class="option-card" data-type="article">
                        <div style="font-size: 32px;">ğŸ“°</div>
                        <div>æ–‡ç« </div>
                    </div>
                    <div class="option-card" data-type="video">
                        <div style="font-size: 32px;">ğŸ“¹</div>
                        <div>è§†é¢‘</div>
                    </div>
                    <div class="option-card" data-type="code">
                        <div style="font-size: 32px;">ğŸ’»</div>
                        <div>ä»£ç </div>
                    </div>
                </div>
                
                <button class="extract-button" onclick="extractContent()">
                    å¼€å§‹æå–
                </button>
                
                <div id="extractResult" style="margin-top: 20px;"></div>
            </div>
            
            <!-- AI åŠ©æ‰‹é¢æ¿ -->
            <div class="panel ai-panel" data-panel="ai">
                <div class="ai-input">
                    <h3>è¾“å…¥è¦ç†è§£çš„å†…å®¹</h3>
                    <textarea id="aiInput" placeholder="ç²˜è´´æˆ–è¾“å…¥æ–‡æœ¬..."></textarea>
                    <div class="ai-actions">
                        <button class="ai-button explain" onclick="aiExplain()">
                            ğŸ’¡ è§£é‡Š
                        </button>
                        <button class="ai-button summarize" onclick="aiSummarize()">
                            ğŸ“ æ€»ç»“
                        </button>
                        <button class="ai-button quiz" onclick="aiQuiz()">
                            â“ å‡ºé¢˜
                        </button>
                    </div>
                </div>
                
                <div id="aiResponse" class="ai-response" style="display: none;"></div>
            </div>
            
            <!-- å­¦ä¹ è¿›åº¦é¢æ¿ -->
            <div class="panel progress-panel" data-panel="progress">
                <h2>ä»Šæ—¥å­¦ä¹ è¿›åº¦</h2>
                
                <div class="progress-card">
                    <h3>æ€»ä½“è¿›åº¦</h3>
                    <div class="progress-bar">
                        <div class="progress-fill" style="width: 0%">0%</div>
                    </div>
                    <p style="color: #666; margin-top: 10px;">
                        å·²å­¦ä¹  <span id="learnedCount">0</span> ä¸ªçŸ¥è¯†ç‚¹
                    </p>
                </div>
                
                <div id="topicProgress"></div>
            </div>
            
            <!-- ç»Ÿè®¡åˆ†æé¢æ¿ -->
            <div class="panel" data-panel="stats">
                <h2>å­¦ä¹ ç»Ÿè®¡</h2>
                
                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-label">æ€»ç¬”è®°æ•°</div>
                        <div class="stat-value" id="totalNotes">0</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-label">ä»Šæ—¥æ–°å¢</div>
                        <div class="stat-value" id="todayNotes">0</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-label">å­¦ä¹ æ—¶é•¿</div>
                        <div class="stat-value" id="totalTime">0h</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-label">AI ä½¿ç”¨</div>
                        <div class="stat-value" id="aiUsage">0</div>
                    </div>
                </div>
                
                <div class="chart-container" style="margin-top: 20px;">
                    <canvas id="learningChart"></canvas>
                </div>
            </div>
        </div>
    </div>
    
    <!-- æ¶ˆæ¯æç¤º -->
    <div id="toast" class="toast"></div>
    
    ${webCommunicator}
    
    <script>
        // é¡µé¢æ§åˆ¶é€»è¾‘
        let selectedExtractType = 'auto';
        let learningChart = null;
        
        // æ ‡ç­¾åˆ‡æ¢
        document.querySelectorAll('.tab').forEach(tab => {
            tab.addEventListener('click', () => {
                // åˆ‡æ¢æ ‡ç­¾çŠ¶æ€
                document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
                tab.classList.add('active');
                
                // åˆ‡æ¢é¢æ¿
                const tabName = tab.dataset.tab;
                document.querySelectorAll('.panel').forEach(p => p.classList.remove('active'));
                document.querySelector(\`[data-panel="\${tabName}"]\`).classList.add('active');
                
                // ç‰¹æ®Šå¤„ç†
                if (tabName === 'stats') {
                    loadStatistics();
                }
            });
        });
        
        // å†…å®¹æå–é€‰é¡¹
        document.querySelectorAll('.option-card').forEach(card => {
            card.addEventListener('click', () => {
                document.querySelectorAll('.option-card').forEach(c => c.classList.remove('selected'));
                card.classList.add('selected');
                selectedExtractType = card.dataset.type;
            });
        });
        
        // é»˜è®¤é€‰ä¸­è‡ªåŠ¨è¯†åˆ«
        document.querySelector('[data-type="auto"]').classList.add('selected');
        
        // å†…å®¹æå–
        function extractContent() {
            const button = document.querySelector('.extract-button');
            button.disabled = true;
            button.innerHTML = '<span class="loader"></span> æå–ä¸­...';
            
            comm.send('browser://extract-content', {
                type: selectedExtractType,
                url: window.location.href
            });
        }
        
        // AI åŠŸèƒ½
        function aiExplain() {
            const text = document.getElementById('aiInput').value.trim();
            if (!text) {
                showToast('è¯·è¾“å…¥è¦è§£é‡Šçš„å†…å®¹', 'error');
                return;
            }
            
            showAILoading();
            comm.send('browser://ai-explain', {
                text: text,
                context: document.title
            });
        }
        
        function aiSummarize() {
            const text = document.getElementById('aiInput').value.trim();
            if (!text) {
                showToast('è¯·è¾“å…¥è¦æ€»ç»“çš„å†…å®¹', 'error');
                return;
            }
            
            showAILoading();
            comm.send('browser://ai-summarize', {
                content: text,
                type: 'text'
            });
        }
        
        function aiQuiz() {
            const text = document.getElementById('aiInput').value.trim();
            if (!text) {
                showToast('è¯·è¾“å…¥å­¦ä¹ å†…å®¹', 'error');
                return;
            }
            
            showAILoading();
            comm.send('browser://ai-quiz', {
                content: text,
                difficulty: 'medium'
            });
        }
        
        function showAILoading() {
            const response = document.getElementById('aiResponse');
            response.style.display = 'block';
            response.innerHTML = '<span class="loader"></span> AI æ­£åœ¨æ€è€ƒ...';
        }
        
        // åŠ è½½ç»Ÿè®¡æ•°æ®
        function loadStatistics() {
            comm.send('browser://get-statistics', {});
        }
        
        // æ¶ˆæ¯å¤„ç†
        comm.on('content-extracted', (data) => {
            const button = document.querySelector('.extract-button');
            button.disabled = false;
            button.textContent = 'å¼€å§‹æå–';
            
            const resultDiv = document.getElementById('extractResult');
            resultDiv.innerHTML = \`
                <div style="background: #f0fdf4; border: 1px solid #86efac; padding: 15px; border-radius: 8px;">
                    <h3 style="color: #16a34a; margin-bottom: 10px;">âœ… æå–æˆåŠŸ</h3>
                    <p>å·²åˆ›å»º \${data.notesCount} ä¸ªç¬”è®°</p>
                    <p style="margin-top: 5px; color: #666;">æå–ç±»å‹ï¼š\${data.type}</p>
                </div>
            \`;
            
            showToast('å†…å®¹æå–æˆåŠŸï¼', 'success');
        });
        
        comm.on('ai-explained', (data) => {
            const response = document.getElementById('aiResponse');
            response.innerHTML = \`
                <h3>ğŸ’¡ AI è§£é‡Š</h3>
                <div style="margin-top: 10px;">\${data.explanation}</div>
            \`;
        });
        
        comm.on('ai-summarized', (data) => {
            const response = document.getElementById('aiResponse');
            response.innerHTML = \`
                <h3>ğŸ“ AI æ€»ç»“</h3>
                <div style="margin-top: 10px;">\${data.summary}</div>
            \`;
        });
        
        comm.on('statistics-loaded', (stats) => {
            // æ›´æ–°ç»Ÿè®¡å¡ç‰‡
            document.getElementById('totalNotes').textContent = stats.totalNotes;
            document.getElementById('todayNotes').textContent = stats.todayNotes;
            document.getElementById('totalTime').textContent = Math.round(stats.totalTime / 60) + 'h';
            document.getElementById('aiUsage').textContent = 
                stats.aiUsage.explains + stats.aiUsage.summaries + stats.aiUsage.quizzes;
            
            // æ›´æ–°å›¾è¡¨
            updateLearningChart(stats.learningCurve);
        });
        
        // æ›´æ–°å­¦ä¹ æ›²çº¿å›¾è¡¨
        function updateLearningChart(data) {
            const ctx = document.getElementById('learningChart').getContext('2d');
            
            if (learningChart) {
                learningChart.destroy();
            }
            
            learningChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: data.map(d => d.date),
                    datasets: [{
                        label: 'å­¦ä¹ æ—¶é•¿ï¼ˆåˆ†é’Ÿï¼‰',
                        data: data.map(d => d.minutes),
                        borderColor: '#667eea',
                        backgroundColor: 'rgba(102, 126, 234, 0.1)',
                        tension: 0.4
                    }, {
                        label: 'ç¬”è®°æ•°é‡',
                        data: data.map(d => d.notes),
                        borderColor: '#48bb78',
                        backgroundColor: 'rgba(72, 187, 120, 0.1)',
                        tension: 0.4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom'
                        }
                    }
                }
            });
        }
        
        // æç¤ºåŠŸèƒ½
        function showToast(message, type = 'info') {
            const toast = document.getElementById('toast');
            toast.textContent = message;
            toast.className = \`toast \${type} show\`;
            
            setTimeout(() => {
                toast.classList.remove('show');
            }, 3000);
        }
        
        // é¡µé¢åŠ è½½å®Œæˆååˆå§‹åŒ–
        window.onload = () => {
            // æ£€æŸ¥æ˜¯å¦åœ¨æ”¯æŒçš„é¡µé¢
            const supportedSites = ['article', 'video', 'pdf'];
            const pageType = detectPageType();
            
            if (supportedSites.includes(pageType)) {
                showToast(\`æ£€æµ‹åˆ°\${pageType}ç±»å‹é¡µé¢ï¼Œå¯ä»¥å¼€å§‹æå–\`, 'info');
            }
        };
        
        // é¡µé¢ç±»å‹æ£€æµ‹
        function detectPageType() {
            // ç®€å•çš„é¡µé¢ç±»å‹æ£€æµ‹é€»è¾‘
            if (document.querySelector('video')) return 'video';
            if (document.querySelector('article')) return 'article';
            if (window.location.pathname.endsWith('.pdf')) return 'pdf';
            return 'general';
        }
    </script>
</body>
</html>
        `;
    }
}

// AI æœåŠ¡æ¨¡å—
class AIService {
    constructor() {
        this.apiKey = this.loadAPIKey();
        this.baseURL = 'https://api.openai.com/v1';
        this.model = 'gpt-3.5-turbo';
    }
    
    async explain(text, context) {
        const prompt = `
ä½œä¸ºä¸€ä½ä¸“ä¸šçš„æ•™å¸ˆï¼Œè¯·ç”¨ç®€å•æ˜“æ‡‚çš„è¯­è¨€è§£é‡Šä»¥ä¸‹å†…å®¹ï¼š

å†…å®¹ï¼š${text}
ä¸Šä¸‹æ–‡ï¼š${context}

è¦æ±‚ï¼š
1. ç”¨é€šä¿—çš„è¯­è¨€è§£é‡Šæ ¸å¿ƒæ¦‚å¿µ
2. å¦‚æœå¯èƒ½ï¼Œä¸¾ä¸€ä¸ªç”Ÿæ´»ä¸­çš„ä¾‹å­
3. æŒ‡å‡ºè¿™ä¸ªçŸ¥è¯†ç‚¹çš„å®é™…åº”ç”¨
4. ä¿æŒè§£é‡Šåœ¨ 200 å­—ä»¥å†…
        `;
        
        return await this.complete(prompt);
    }
    
    async summarize(content) {
        const prompt = `
è¯·å¯¹ä»¥ä¸‹å†…å®¹è¿›è¡Œæ€»ç»“ï¼š

${content}

è¦æ±‚ï¼š
1. æå– 3-5 ä¸ªå…³é”®è¦ç‚¹
2. æ¯ä¸ªè¦ç‚¹ç”¨ä¸€å¥è¯æ¦‚æ‹¬
3. æœ€åç”¨ä¸€æ®µè¯æ€»ç»“ä¸»è¦è§‚ç‚¹
4. æ€»ç»“ä¿æŒåœ¨ 300 å­—ä»¥å†…
        `;
        
        return await this.complete(prompt);
    }
    
    async generateQuiz(content, difficulty = 'medium') {
        const prompt = `
åŸºäºä»¥ä¸‹å†…å®¹ï¼Œç”Ÿæˆ ${difficulty} éš¾åº¦çš„æµ‹è¯•é¢˜ï¼š

${content}

è¦æ±‚ï¼š
1. ç”Ÿæˆ 3 é“é€‰æ‹©é¢˜
2. æ¯é¢˜ 4 ä¸ªé€‰é¡¹ï¼Œåªæœ‰ä¸€ä¸ªæ­£ç¡®ç­”æ¡ˆ
3. é¢˜ç›®è¦æµ‹è¯•å¯¹å†…å®¹çš„ç†è§£ï¼Œä¸æ˜¯ç®€å•è®°å¿†
4. æä¾›ç­”æ¡ˆå’Œç®€çŸ­è§£é‡Š
        `;
        
        return await this.complete(prompt);
    }
    
    async complete(prompt) {
        // å®é™…é¡¹ç›®ä¸­ï¼Œè¿™é‡Œä¼šè°ƒç”¨çœŸå®çš„ AI API
        // è¿™é‡Œç”¨æ¨¡æ‹Ÿå“åº”ä»£æ›¿
        return this.simulateAIResponse(prompt);
    }
    
    simulateAIResponse(prompt) {
        // æ¨¡æ‹Ÿ AI å“åº”
        if (prompt.includes('è§£é‡Š')) {
            return `è¿™ä¸ªæ¦‚å¿µçš„æ ¸å¿ƒæ˜¯å»ºç«‹æ•°æ®ä¹‹é—´çš„åŒå‘è¿æ¥ã€‚

æƒ³è±¡ä¸€ä¸‹ï¼Œå°±åƒä¸¤ä¸ªæœ‹å‹é€šè¿‡ç”µè¯äº¤æµï¼š
- HTML é¡µé¢å°±åƒä¸€ä¸ªæœ‹å‹
- MarginNote å¡ç‰‡å°±åƒå¦ä¸€ä¸ªæœ‹å‹
- evaluateJavaScript å’Œ URL Scheme å°±åƒç”µè¯çº¿

é€šè¿‡è¿™ç§è¿æ¥ï¼Œç½‘é¡µå¯ä»¥æŠŠçœ‹åˆ°çš„å†…å®¹å‘Šè¯‰å¡ç‰‡ï¼Œå¡ç‰‡ä¹Ÿå¯ä»¥æŠŠè‡ªå·±çš„ä¿¡æ¯å±•ç¤ºåœ¨ç½‘é¡µä¸Šã€‚è¿™åœ¨å®é™…åº”ç”¨ä¸­éå¸¸æœ‰ç”¨ï¼Œæ¯”å¦‚è‡ªåŠ¨æ”¶é›†ç½‘é¡µç¬”è®°ã€å®æ—¶åŒæ­¥å­¦ä¹ è¿›åº¦ç­‰ã€‚`;
        } else if (prompt.includes('æ€»ç»“')) {
            return `**å…³é”®è¦ç‚¹ï¼š**
1. ğŸ”— åŒå‘é€šä¿¡æ˜¯æ’ä»¶å¼€å‘çš„æ ¸å¿ƒæŠ€æœ¯
2. ğŸ“¤ evaluateJavaScript ç”¨äºæ’ä»¶å‘ç½‘é¡µå‘é€æŒ‡ä»¤
3. ğŸ“¥ URL Scheme ç”¨äºç½‘é¡µå‘æ’ä»¶å‘é€æ¶ˆæ¯
4. ğŸ”„ æ•°æ®éœ€è¦æ­£ç¡®çš„æ ¼å¼è½¬æ¢ï¼ˆJSONã€Base64ï¼‰
5. âš¡ æ€§èƒ½ä¼˜åŒ–å¾ˆé‡è¦ï¼ˆæ‰¹å¤„ç†ã€ç¼“å­˜ï¼‰

**æ€»ç»“ï¼š**
æŒæ¡ HTML ä¸å¡ç‰‡çš„æ•°æ®ä¼ è¾“æŠ€æœ¯ï¼Œèƒ½è®©ä½ å¼€å‘å‡ºåŠŸèƒ½å¼ºå¤§çš„ MarginNote æ’ä»¶ã€‚è¿™ä¸ä»…æå‡äº†ç¬”è®°æ•ˆç‡ï¼Œè¿˜èƒ½åˆ›é€ å‡ºå…¨æ–°çš„å­¦ä¹ ä½“éªŒã€‚`;
        } else {
            return 'æ¨¡æ‹Ÿçš„ AI å“åº”å†…å®¹';
        }
    }
}

// æ•°æ®ç®¡ç†æ¨¡å—
class DataManager {
    constructor() {
        this.storage = NSUserDefaults.standardUserDefaults();
        this.prefix = 'SmartLearningAssistant_';
    }
    
    // ä¿å­˜æ•°æ®
    save(key, value) {
        const fullKey = this.prefix + key;
        this.storage.setObjectForKey(JSON.stringify(value), fullKey);
    }
    
    // è¯»å–æ•°æ®
    load(key, defaultValue = null) {
        const fullKey = this.prefix + key;
        const data = this.storage.objectForKey(fullKey);
        
        if (data) {
            try {
                return JSON.parse(data);
            } catch (e) {
                return defaultValue;
            }
        }
        
        return defaultValue;
    }
    
    // å­¦ä¹ è®°å½•ç®¡ç†
    addLearningRecord(record) {
        const records = this.load('learningRecords', []);
        records.push({
            ...record,
            id: Date.now().toString(),
            timestamp: Date.now()
        });
        
        // åªä¿ç•™æœ€è¿‘ 1000 æ¡è®°å½•
        if (records.length > 1000) {
            records.splice(0, records.length - 1000);
        }
        
        this.save('learningRecords', records);
    }
    
    // ç»Ÿè®¡åŠŸèƒ½
    getTotalNotes() {
        const notebook = MNUtil.currentNotebook;
        return notebook ? notebook.notes.length : 0;
    }
    
    getTodayNotes() {
        const notebook = MNUtil.currentNotebook;
        if (!notebook) return 0;
        
        const today = new Date().setHours(0, 0, 0, 0);
        return notebook.notes.filter(note => 
            note.createDate.getTime() >= today
        ).length;
    }
    
    getWeeklyNotes() {
        const notebook = MNUtil.currentNotebook;
        if (!notebook) return 0;
        
        const weekAgo = Date.now() - (7 * 24 * 60 * 60 * 1000);
        return notebook.notes.filter(note => 
            note.createDate.getTime() >= weekAgo
        ).length;
    }
    
    getTotalLearningTime() {
        const records = this.load('learningRecords', []);
        return records.reduce((total, record) => {
            return total + (record.duration || 0);
        }, 0);
    }
    
    getLearningCurve(days = 30) {
        const records = this.load('learningRecords', []);
        const curve = [];
        
        for (let i = days - 1; i >= 0; i--) {
            const date = new Date();
            date.setDate(date.getDate() - i);
            date.setHours(0, 0, 0, 0);
            
            const dayRecords = records.filter(r => {
                const recordDate = new Date(r.timestamp);
                return recordDate.toDateString() === date.toDateString();
            });
            
            curve.push({
                date: date.toLocaleDateString(),
                minutes: dayRecords.reduce((sum, r) => sum + (r.duration || 0), 0) / 60,
                notes: dayRecords.filter(r => r.type === 'note_created').length
            });
        }
        
        return curve;
    }
}

// åŒæ­¥ç®¡ç†æ¨¡å—
class SyncManager {
    constructor() {
        this.syncInterval = null;
        this.lastSync = null;
    }
    
    startAutoSync(interval = 60000) {
        this.syncInterval = setInterval(() => {
            this.sync();
        }, interval);
    }
    
    stopAutoSync() {
        if (this.syncInterval) {
            clearInterval(this.syncInterval);
            this.syncInterval = null;
        }
    }
    
    async sync() {
        try {
            DevTools.info('Sync', 'å¼€å§‹åŒæ­¥æ•°æ®');
            
            // åŒæ­¥ç¬”è®°
            await this.syncNotes();
            
            // åŒæ­¥å­¦ä¹ è¿›åº¦
            await this.syncProgress();
            
            // åŒæ­¥è®¾ç½®
            await this.syncSettings();
            
            this.lastSync = Date.now();
            
            DevTools.info('Sync', 'åŒæ­¥å®Œæˆ');
            
        } catch (error) {
            DevTools.error('Sync', 'åŒæ­¥å¤±è´¥', error);
        }
    }
    
    async syncNotes() {
        // å®ç°ç¬”è®°åŒæ­¥é€»è¾‘
        // å¯ä»¥åŒæ­¥åˆ°äº‘ç«¯æˆ–å…¶ä»–è®¾å¤‡
    }
    
    async syncProgress() {
        // å®ç°è¿›åº¦åŒæ­¥é€»è¾‘
    }
    
    async syncSettings() {
        // å®ç°è®¾ç½®åŒæ­¥é€»è¾‘
    }
}

// é¡µé¢åˆ†æå™¨
const PageAnalyzer = \`
class PageAnalyzer {
    analyze() {
        // æ£€æµ‹è§†é¢‘
        if (document.querySelector('video')) {
            return 'video';
        }
        
        // æ£€æµ‹æ–‡ç« 
        if (document.querySelector('article') || 
            document.querySelector('[class*="article"]') ||
            document.querySelector('[class*="post"]')) {
            return 'article';
        }
        
        // æ£€æµ‹ PDF
        if (window.location.pathname.endsWith('.pdf') ||
            document.querySelector('embed[type="application/pdf"]')) {
            return 'pdf';
        }
        
        // æ£€æµ‹ä»£ç 
        if (document.querySelector('pre code') ||
            document.querySelector('.highlight') ||
            window.location.hostname.includes('github.com')) {
            return 'code';
        }
        
        return 'general';
    }
}
\`;

// å†…å®¹æå–å™¨åŸºç±»
const ContentExtractor = \`
class ContentExtractor {
    extract() {
        throw new Error('Subclass must implement extract method');
    }
    
    cleanText(text) {
        return text.trim()
                  .replace(/\\s+/g, ' ')
                  .replace(/\\n{3,}/g, '\\n\\n');
    }
}

class ArticleExtractor extends ContentExtractor {
    extract() {
        const article = document.querySelector('article') || document.body;
        
        // æå–æ ‡é¢˜
        const title = document.querySelector('h1')?.textContent || 
                     document.title;
        
        // æå–ä½œè€…
        const author = this.extractAuthor();
        
        // æå–å‘å¸ƒæ—¶é—´
        const publishTime = this.extractPublishTime();
        
        // æå–æ­£æ–‡
        const content = this.extractContent(article);
        
        // æå–å›¾ç‰‡
        const images = this.extractImages(article);
        
        return {
            type: 'article',
            title,
            author,
            publishTime,
            content,
            images,
            url: window.location.href
        };
    }
    
    extractAuthor() {
        const selectors = [
            '.author', '[class*="author"]', 
            '.by', '[class*="by"]',
            'meta[name="author"]'
        ];
        
        for (const selector of selectors) {
            const element = document.querySelector(selector);
            if (element) {
                return element.textContent || element.content || 'æœªçŸ¥ä½œè€…';
            }
        }
        
        return 'æœªçŸ¥ä½œè€…';
    }
    
    extractPublishTime() {
        const selectors = [
            'time', '.date', '[class*="publish"]',
            'meta[property="article:published_time"]'
        ];
        
        for (const selector of selectors) {
            const element = document.querySelector(selector);
            if (element) {
                return element.textContent || 
                       element.dateTime || 
                       element.content || 
                       new Date().toLocaleDateString();
            }
        }
        
        return new Date().toLocaleDateString();
    }
    
    extractContent(container) {
        // å…‹éš†å®¹å™¨ä»¥é¿å…ä¿®æ”¹åŸå§‹ DOM
        const clone = container.cloneNode(true);
        
        // ç§»é™¤ä¸éœ€è¦çš„å…ƒç´ 
        const removeSelectors = [
            'script', 'style', 'nav', 'aside',
            '.ad', '[class*="advertisement"]',
            '.share', '[class*="share"]'
        ];
        
        removeSelectors.forEach(selector => {
            clone.querySelectorAll(selector).forEach(el => el.remove());
        });
        
        // æå–æ–‡æœ¬
        return this.cleanText(clone.textContent);
    }
    
    extractImages(container) {
        const images = [];
        
        container.querySelectorAll('img').forEach(img => {
            if (img.width > 100 && img.height > 100) {
                images.push({
                    src: img.src,
                    alt: img.alt || '',
                    caption: this.findImageCaption(img)
                });
            }
        });
        
        return images;
    }
    
    findImageCaption(img) {
        // æŸ¥æ‰¾å›¾ç‰‡è¯´æ˜
        const parent = img.parentElement;
        const figcaption = parent.querySelector('figcaption');
        
        if (figcaption) {
            return figcaption.textContent;
        }
        
        // æŸ¥æ‰¾ä¸´è¿‘çš„æ–‡æœ¬
        const nextElement = img.nextElementSibling;
        if (nextElement && nextElement.tagName === 'P') {
            const text = nextElement.textContent;
            if (text.length < 100) {
                return text;
            }
        }
        
        return '';
    }
}

class VideoExtractor extends ContentExtractor {
    extract() {
        const video = document.querySelector('video');
        if (!video) return null;
        
        return {
            type: 'video',
            title: document.title,
            duration: video.duration,
            currentTime: video.currentTime,
            thumbnail: this.getVideoThumbnail(video),
            source: video.currentSrc || video.src,
            platform: this.detectPlatform(),
            url: window.location.href
        };
    }
    
    getVideoThumbnail(video) {
        const canvas = document.createElement('canvas');
        canvas.width = video.videoWidth || 640;
        canvas.height = video.videoHeight || 360;
        
        const ctx = canvas.getContext('2d');
        ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
        
        return canvas.toDataURL('image/jpeg', 0.8);
    }
    
    detectPlatform() {
        const hostname = window.location.hostname;
        
        if (hostname.includes('youtube.com')) return 'YouTube';
        if (hostname.includes('bilibili.com')) return 'Bilibili';
        if (hostname.includes('vimeo.com')) return 'Vimeo';
        
        return 'Unknown';
    }
}

class GeneralExtractor extends ContentExtractor {
    extract() {
        // é€šç”¨æå–é€»è¾‘
        const selection = window.getSelection();
        
        if (selection.toString()) {
            // å¦‚æœæœ‰é€‰ä¸­æ–‡æœ¬ï¼Œæå–é€‰ä¸­å†…å®¹
            return {
                type: 'selection',
                content: selection.toString(),
                context: this.getSelectionContext(selection),
                url: window.location.href
            };
        }
        
        // å¦åˆ™æå–é¡µé¢ä¸»è¦å†…å®¹
        return {
            type: 'general',
            title: document.title,
            content: this.extractMainContent(),
            url: window.location.href
        };
    }
    
    getSelectionContext(selection) {
        if (selection.rangeCount === 0) return '';
        
        const range = selection.getRangeAt(0);
        const container = range.commonAncestorContainer.parentElement;
        
        // è·å–é€‰ä¸­æ–‡æœ¬çš„ä¸Šä¸‹æ–‡
        const context = {
            before: '',
            after: ''
        };
        
        // ç®€å•å®ç°ï¼šè·å–çˆ¶å…ƒç´ çš„æ–‡æœ¬
        const fullText = container.textContent;
        const selectedText = selection.toString();
        const index = fullText.indexOf(selectedText);
        
        if (index !== -1) {
            context.before = fullText.substring(Math.max(0, index - 50), index);
            context.after = fullText.substring(
                index + selectedText.length, 
                Math.min(fullText.length, index + selectedText.length + 50)
            );
        }
        
        return context;
    }
    
    extractMainContent() {
        // å°è¯•æ‰¾åˆ°ä¸»è¦å†…å®¹åŒºåŸŸ
        const contentSelectors = [
            'main', 'article', '[role="main"]',
            '.content', '#content', '.main'
        ];
        
        for (const selector of contentSelectors) {
            const element = document.querySelector(selector);
            if (element) {
                return this.cleanText(element.textContent);
            }
        }
        
        // å¦‚æœæ‰¾ä¸åˆ°ï¼Œè¿”å› body çš„æ–‡æœ¬
        return this.cleanText(document.body.textContent);
    }
}
\`;

// åˆ›å»ºæ’ä»¶å®ä¾‹
const smartLearningAssistant = new SmartLearningAssistant();
```

### ğŸ“‹ é¡¹ç›®æ€»ç»“

é€šè¿‡è¿™ä¸ªå®Œæ•´çš„é¡¹ç›®ï¼Œæˆ‘ä»¬å®ç°äº†ï¼š

1. **æ™ºèƒ½å†…å®¹æå–**
   - è‡ªåŠ¨è¯†åˆ«é¡µé¢ç±»å‹
   - é’ˆå¯¹æ€§çš„å†…å®¹æå–ç­–ç•¥
   - ä¿ç•™é‡è¦çš„å…ƒæ•°æ®

2. **AI è¾…åŠ©å­¦ä¹ **
   - å†…å®¹è§£é‡Šå’Œæ€»ç»“
   - è‡ªåŠ¨ç”Ÿæˆæµ‹è¯•é¢˜
   - ä¸ªæ€§åŒ–å­¦ä¹ å»ºè®®

3. **å­¦ä¹ è¿›åº¦è¿½è¸ª**
   - å®æ—¶è¿›åº¦ç›‘æ§
   - é‡Œç¨‹ç¢‘æ¿€åŠ±æœºåˆ¶
   - è¯¦ç»†çš„å­¦ä¹ æŠ¥å‘Š

4. **æ•°æ®å¯è§†åŒ–**
   - å­¦ä¹ æ›²çº¿å±•ç¤º
   - ç»Ÿè®¡æ•°æ®å›¾è¡¨
   - äº¤äº’å¼æ•°æ®æ¢ç´¢

5. **åŒå‘æ•°æ®åŒæ­¥**
   - å®æ—¶æ•°æ®æ›´æ–°
   - ç¦»çº¿æ•°æ®ç¼“å­˜
   - è·¨è®¾å¤‡åŒæ­¥æ”¯æŒ

è¿™ä¸ªé¡¹ç›®å±•ç¤ºäº†å¦‚ä½•å°†å‰é¢ç« èŠ‚å­¦åˆ°çš„æ‰€æœ‰æŠ€æœ¯æ•´åˆåˆ°ä¸€ä¸ªå®ç”¨çš„æ’ä»¶ä¸­ã€‚ä½ å¯ä»¥åŸºäºè¿™ä¸ªæ¡†æ¶ï¼Œæ ¹æ®è‡ªå·±çš„éœ€æ±‚è¿›è¡Œä¿®æ”¹å’Œæ‰©å±•ã€‚

---

## ç¬¬å…«éƒ¨åˆ†ï¼šå¸¸è§é—®é¢˜ä¸è°ƒè¯•

### ğŸ¯ æœ¬ç« ç›®æ ‡

å¸®åŠ©ä½ è§£å†³å¼€å‘ä¸­çš„å¸¸è§é—®é¢˜ï¼ŒæŒæ¡è°ƒè¯•æŠ€å·§ï¼Œäº†è§£æœ€ä½³å®è·µã€‚

### â“ å¸¸è§é—®é¢˜åŠè§£å†³æ–¹æ¡ˆ

#### 1. WebView åŠ è½½é—®é¢˜

**é—®é¢˜ï¼šWebView æ˜¾ç¤ºç©ºç™½**
```javascript
// âŒ é”™è¯¯ï¼šè·¯å¾„ä¸æ­£ç¡®
webview.loadRequest(NSURLRequest.requestWithURL(
    NSURL.URLWithString("file://index.html")
));

// âœ… æ­£ç¡®ï¼šä½¿ç”¨æ­£ç¡®çš„æ–‡ä»¶è·¯å¾„
const htmlPath = MNUtil.getPluginPath() + "/index.html";
webview.loadRequest(NSURLRequest.requestWithURL(
    NSURL.fileURLWithPath(htmlPath)
));
```

**é—®é¢˜ï¼šCSS/JS èµ„æºåŠ è½½å¤±è´¥**
```javascript
// âœ… ä½¿ç”¨ Base URL åŠ è½½æœ¬åœ°èµ„æº
const html = \`
<html>
<head>
    <link rel="stylesheet" href="style.css">
    <script src="script.js"></script>
</head>
<body>å†…å®¹</body>
</html>
\`;

const baseURL = NSURL.fileURLWithPath(MNUtil.getPluginPath());
webview.loadHTMLStringBaseURL(html, baseURL);
```

#### 2. æ•°æ®ä¼ è¾“é—®é¢˜

**é—®é¢˜ï¼ševaluateJavaScript è¿”å› undefined**
```javascript
// âŒ é”™è¯¯ï¼šæ²¡æœ‰è¿”å›å€¼
await webview.evaluateJavaScript(\`
    document.title  // æ²¡æœ‰æ˜¾å¼è¿”å›
\`);

// âœ… æ­£ç¡®ï¼šç¡®ä¿æœ‰è¿”å›å€¼
await webview.evaluateJavaScript(\`
    document.title  // è¡¨è¾¾å¼ä¼šè‡ªåŠ¨è¿”å›
\`);

// æˆ–è€…ä½¿ç”¨æ˜¾å¼è¿”å›
await webview.evaluateJavaScript(\`
    (() => {
        const title = document.title;
        return title;  // æ˜¾å¼è¿”å›
    })()
\`);
```

**é—®é¢˜ï¼šå¤§æ•°æ®ä¼ è¾“å¤±è´¥**
```javascript
// âŒ é”™è¯¯ï¼šæ•°æ®å¤ªå¤§
const hugeData = await webview.evaluateJavaScript(\`
    document.body.innerHTML  // å¯èƒ½éå¸¸å¤§
\`);

// âœ… æ­£ç¡®ï¼šåˆ†å—ä¼ è¾“
async function transferLargeData() {
    // å…ˆè·å–æ•°æ®å¤§å°
    const size = await webview.evaluateJavaScript(\`
        document.body.innerHTML.length
    \`);
    
    if (size > 1000000) {  // 1MB
        // åˆ†å—ä¼ è¾“
        const chunks = [];
        const chunkSize = 100000;  // 100KB
        
        for (let i = 0; i < size; i += chunkSize) {
            const chunk = await webview.evaluateJavaScript(\`
                document.body.innerHTML.substring(${i}, ${i + chunkSize})
            \`);
            chunks.push(chunk);
        }
        
        return chunks.join('');
    } else {
        // ç›´æ¥ä¼ è¾“
        return await webview.evaluateJavaScript(\`
            document.body.innerHTML
        \`);
    }
}
```

#### 3. å†…å­˜æ³„æ¼é—®é¢˜

**é—®é¢˜ï¼šWebView å†…å­˜ä¸æ–­å¢é•¿**
```javascript
// âŒ é”™è¯¯ï¼šæ²¡æœ‰æ¸…ç†äº‹ä»¶ç›‘å¬å™¨
window.addEventListener('scroll', handleScroll);
// é¡µé¢åˆ‡æ¢æ—¶æ²¡æœ‰ç§»é™¤

// âœ… æ­£ç¡®ï¼šæ­£ç¡®ç®¡ç†ç”Ÿå‘½å‘¨æœŸ
class WebViewManager {
    constructor() {
        this.listeners = [];
    }
    
    addEventListener(element, event, handler) {
        element.addEventListener(event, handler);
        this.listeners.push({ element, event, handler });
    }
    
    cleanup() {
        // ç§»é™¤æ‰€æœ‰ç›‘å¬å™¨
        this.listeners.forEach(({ element, event, handler }) => {
            element.removeEventListener(event, handler);
        });
        this.listeners = [];
        
        // æ¸…ç†å…¶ä»–èµ„æº
        if (this.timers) {
            this.timers.forEach(timer => clearInterval(timer));
        }
        
        // æ¸…ç†å¤§å¯¹è±¡
        this.cache = null;
        this.data = null;
    }
}
```

#### 4. å¼‚æ­¥æ“ä½œé—®é¢˜

**é—®é¢˜ï¼šPromise æ²¡æœ‰æ­£ç¡®å¤„ç†**
```javascript
// âŒ é”™è¯¯ï¼šæ²¡æœ‰ç­‰å¾… Promise
webview.evaluateJavaScript(\`
    fetch('/api/data').then(r => r.json())
\`);  // è¿”å› Promise å¯¹è±¡ï¼Œä¸æ˜¯æ•°æ®

// âœ… æ­£ç¡®ï¼šç­‰å¾… Promise å®Œæˆ
const data = await webview.evaluateJavaScript(\`
    fetch('/api/data').then(r => r.json())
\`);

// æˆ–è€…åœ¨ç½‘é¡µä¸­å¤„ç†
const data = await webview.evaluateJavaScript(\`
    (async () => {
        const response = await fetch('/api/data');
        return await response.json();
    })()
\`);
```

### ğŸ è°ƒè¯•æŠ€å·§

#### 1. ä½¿ç”¨ Safari å¼€å‘è€…å·¥å…·

```javascript
// å¯ç”¨ WebView è°ƒè¯•
webview.configuration.preferences.setValue(true, 'developerExtrasEnabled');

// åœ¨ Safari ä¸­ï¼š
// 1. æ‰“å¼€ Safari
// 2. èœå•æ  -> å¼€å‘ -> [ä½ çš„è®¾å¤‡å]
// 3. é€‰æ‹©ä½ çš„ WebView
// 4. ç°åœ¨å¯ä»¥ä½¿ç”¨å®Œæ•´çš„å¼€å‘è€…å·¥å…·äº†ï¼
```

#### 2. æ—¥å¿—è°ƒè¯•ç³»ç»Ÿ

```javascript
// åˆ›å»ºå¼ºå¤§çš„æ—¥å¿—ç³»ç»Ÿ
class Logger {
    constructor(enabled = true) {
        this.enabled = enabled;
        this.logs = [];
    }
    
    log(level, category, message, data) {
        if (!this.enabled) return;
        
        const entry = {
            timestamp: new Date().toISOString(),
            level,
            category,
            message,
            data,
            stack: new Error().stack
        };
        
        this.logs.push(entry);
        
        // åœ¨æ§åˆ¶å°è¾“å‡º
        const color = {
            debug: 'gray',
            info: 'blue',
            warn: 'orange',
            error: 'red'
        }[level];
        
        console.log(
            \`%c[\${level.toUpperCase()}] \${category}: \${message}\`,
            \`color: \${color}; font-weight: bold\`,
            data || ''
        );
        
        // å‘é€åˆ°æ’ä»¶ç«¯
        if (window.location.href.startsWith('browser://')) {
            window.location.href = \`browser://log?level=\${level}&category=\${category}&message=\${encodeURIComponent(message)}\`;
        }
    }
    
    debug(category, message, data) {
        this.log('debug', category, message, data);
    }
    
    info(category, message, data) {
        this.log('info', category, message, data);
    }
    
    warn(category, message, data) {
        this.log('warn', category, message, data);
    }
    
    error(category, message, data) {
        this.log('error', category, message, data);
    }
    
    // å¯¼å‡ºæ—¥å¿—
    export() {
        return this.logs;
    }
    
    // æ¸…ç©ºæ—¥å¿—
    clear() {
        this.logs = [];
    }
}

// å…¨å±€æ—¥å¿—å®ä¾‹
window.logger = new Logger();

// ä½¿ç”¨ç¤ºä¾‹
logger.info('DataExtraction', 'å¼€å§‹æå–æ•°æ®', { url: window.location.href });
logger.error('Network', 'è¯·æ±‚å¤±è´¥', { status: 404, url: '/api/data' });
```

#### 3. æ€§èƒ½åˆ†æ

```javascript
// æ€§èƒ½ç›‘æ§å·¥å…·
class PerformanceMonitor {
    constructor() {
        this.measurements = {};
    }
    
    start(name) {
        this.measurements[name] = {
            start: performance.now(),
            memory: performance.memory ? performance.memory.usedJSHeapSize : 0
        };
    }
    
    end(name) {
        if (!this.measurements[name]) {
            console.warn(\`No measurement started for \${name}\`);
            return;
        }
        
        const measurement = this.measurements[name];
        const duration = performance.now() - measurement.start;
        const memoryDelta = performance.memory ? 
            performance.memory.usedJSHeapSize - measurement.memory : 0;
        
        console.log(\`
Performance: \${name}
Duration: \${duration.toFixed(2)}ms
Memory Delta: \${(memoryDelta / 1024 / 1024).toFixed(2)}MB
        \`);
        
        delete this.measurements[name];
        
        return { duration, memoryDelta };
    }
    
    async measure(name, fn) {
        this.start(name);
        try {
            const result = await fn();
            return result;
        } finally {
            this.end(name);
        }
    }
}

// ä½¿ç”¨ç¤ºä¾‹
const monitor = new PerformanceMonitor();

await monitor.measure('å›¾ç‰‡å¤„ç†', async () => {
    await processImages(imageList);
});
```

### ğŸ’¡ æœ€ä½³å®è·µæ€»ç»“

#### 1. ä»£ç ç»„ç»‡

```javascript
// æ¨èçš„é¡¹ç›®ç»“æ„
/my-plugin
â”œâ”€â”€ main.js           // æ’ä»¶ä¸»å…¥å£
â”œâ”€â”€ webview/
â”‚   â”œâ”€â”€ index.html    // WebView ç•Œé¢
â”‚   â”œâ”€â”€ app.js        // å‰ç«¯é€»è¾‘
â”‚   â””â”€â”€ style.css     // æ ·å¼
â”œâ”€â”€ modules/
â”‚   â”œâ”€â”€ data.js       // æ•°æ®ç®¡ç†
â”‚   â”œâ”€â”€ sync.js       // åŒæ­¥é€»è¾‘
â”‚   â””â”€â”€ ai.js         // AI æœåŠ¡
â”œâ”€â”€ utils/
â”‚   â”œâ”€â”€ logger.js     // æ—¥å¿—å·¥å…·
â”‚   â””â”€â”€ helpers.js    // è¾…åŠ©å‡½æ•°
â””â”€â”€ config.json       // é…ç½®æ–‡ä»¶
```

#### 2. é”™è¯¯å¤„ç†

```javascript
// å…¨å±€é”™è¯¯å¤„ç†
class ErrorHandler {
    static handle(error, context) {
        // è®°å½•é”™è¯¯
        DevTools.error(context, error.message, {
            stack: error.stack,
            timestamp: Date.now()
        });
        
        // ç”¨æˆ·å‹å¥½çš„é”™è¯¯æç¤º
        const userMessage = this.getUserMessage(error);
        MNUtil.showHUD(userMessage);
        
        // é”™è¯¯æ¢å¤
        this.recover(error, context);
    }
    
    static getUserMessage(error) {
        const messages = {
            'NetworkError': 'ç½‘ç»œè¿æ¥å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œ',
            'DataError': 'æ•°æ®å¤„ç†å¤±è´¥ï¼Œè¯·é‡è¯•',
            'AIError': 'AI æœåŠ¡æš‚æ—¶ä¸å¯ç”¨'
        };
        
        return messages[error.constructor.name] || 'æ“ä½œå¤±è´¥ï¼Œè¯·é‡è¯•';
    }
    
    static recover(error, context) {
        // æ ¹æ®é”™è¯¯ç±»å‹è¿›è¡Œæ¢å¤
        if (error instanceof NetworkError) {
            // åˆ‡æ¢åˆ°ç¦»çº¿æ¨¡å¼
            AppState.setOfflineMode(true);
        }
    }
}

// ä½¿ç”¨ try-catch åŒ…è£…æ‰€æœ‰å¼‚æ­¥æ“ä½œ
async function safeExecute(fn, context) {
    try {
        return await fn();
    } catch (error) {
        ErrorHandler.handle(error, context);
        return null;
    }
}
```

#### 3. æ€§èƒ½ä¼˜åŒ–æ£€æŸ¥æ¸…å•

- [ ] ä½¿ç”¨é˜²æŠ–å’ŒèŠ‚æµä¼˜åŒ–é¢‘ç¹æ“ä½œ
- [ ] å®ç°å›¾ç‰‡æ‡’åŠ è½½
- [ ] æ‰¹é‡å¤„ç†æ•°æ®æ“ä½œ
- [ ] åŠæ—¶æ¸…ç†ä¸ç”¨çš„å¯¹è±¡å’Œç›‘å¬å™¨
- [ ] ä½¿ç”¨ Web Worker å¤„ç†è€—æ—¶æ“ä½œ
- [ ] ç¼“å­˜å¸¸ç”¨æ•°æ®
- [ ] é¿å…æ·±å±‚åµŒå¥—çš„ Promise
- [ ] ä½¿ç”¨è™šæ‹Ÿæ»šåŠ¨å¤„ç†é•¿åˆ—è¡¨

### ğŸ“š è¿›ä¸€æ­¥å­¦ä¹ èµ„æº

1. **å®˜æ–¹æ–‡æ¡£**
   - MarginNote API æ–‡æ¡£
   - JSBox æ–‡æ¡£ï¼ˆå‚è€ƒ JSB æ¡†æ¶ï¼‰
   - MDN Web Docsï¼ˆWeb æŠ€æœ¯ï¼‰

2. **ç¤¾åŒºèµ„æº**
   - MarginNote ä¸­æ–‡è®ºå›
   - GitHub ä¸Šçš„å¼€æºæ’ä»¶
   - Discord/Telegram å¼€å‘è€…ç¾¤ç»„

3. **ç›¸å…³æŠ€æœ¯**
   - JavaScript é«˜çº§ç¼–ç¨‹
   - iOS WebView å¼€å‘
   - å‰ç«¯æ€§èƒ½ä¼˜åŒ–
   - ç”¨æˆ·ä½“éªŒè®¾è®¡

4. **æ¨èé¡¹ç›®**
   - MNUtils - åŸºç¡€ API æ¡†æ¶
   - OhMyMN - ç°ä»£åŒ–æ’ä»¶æ¡†æ¶
   - å„ç§ä¼˜ç§€çš„å¼€æºæ’ä»¶

### ğŸ‰ ç»“è¯­

æ­å–œä½ å®Œæˆäº†æ•´ä¸ªæ•™ç¨‹ï¼ç°åœ¨ä½ å·²ç»æŒæ¡äº†ï¼š

1. âœ… HTML ä¸å¡ç‰‡æ•°æ®ä¼ è¾“çš„æ ¸å¿ƒæŠ€æœ¯
2. âœ… å•å‘å’ŒåŒå‘é€šä¿¡çš„å®ç°æ–¹æ³•
3. âœ… å„ç§è¿›é˜¶æŠ€å·§å’Œæ€§èƒ½ä¼˜åŒ–
4. âœ… å®Œæ•´é¡¹ç›®çš„å¼€å‘æµç¨‹
5. âœ… è°ƒè¯•å’Œé—®é¢˜è§£å†³èƒ½åŠ›

è®°ä½ï¼Œä¼˜ç§€çš„æ’ä»¶ä¸æ˜¯ä¸€è¹´è€Œå°±çš„ã€‚æŒç»­å­¦ä¹ ã€ä¸æ–­å®è·µã€ç§¯æåˆ†äº«ï¼Œä½ ä¼šæˆä¸ºå‡ºè‰²çš„ MarginNote æ’ä»¶å¼€å‘è€…ï¼

**æœ€åçš„å»ºè®®ï¼š**
- ğŸš€ ä»ç®€å•çš„åŠŸèƒ½å¼€å§‹ï¼Œé€æ­¥å¢åŠ å¤æ‚åº¦
- ğŸ’¡ å¤šçœ‹ä¼˜ç§€æ’ä»¶çš„æºç ï¼Œå­¦ä¹ æœ€ä½³å®è·µ
- ğŸ¤ å‚ä¸ç¤¾åŒºï¼Œåˆ†äº«ä½ çš„ä½œå“å’Œç»éªŒ
- ğŸ“ˆ æŒç»­ä¼˜åŒ–ï¼Œè®©æ’ä»¶è¶Šæ¥è¶Šå¥½ç”¨

ç¥ä½ å¼€å‘æ„‰å¿«ï¼Œåˆ›é€ å‡ºä»¤äººæƒŠå¹çš„æ’ä»¶ï¼ğŸŠ
