# MarginNote4 æ’ä»¶å¼€å‘æ€»çº²

> æœ¬æ–‡æ¡£æ˜¯ MN-Addon é¡¹ç›®çš„æ ¸å¿ƒå¼€å‘æŒ‡å—ï¼Œæ¶µç›– MarginNote4 çš„æ ¸å¿ƒæ¦‚å¿µã€æŠ€æœ¯æ¶æ„ã€å¼€å‘è§„èŒƒå’Œæœ€ä½³å®è·µï¼Œä¸ºæ‰€æœ‰ MarginNote æ’ä»¶å¼€å‘è€…æä¾›å…¨é¢çš„æŠ€æœ¯å‚è€ƒã€‚

## ğŸ¯ å¼€å‘æ¡†æ¶é€‰æ‹©æŒ‡å—

åœ¨å¼€å§‹ MarginNote æ’ä»¶å¼€å‘ä¹‹å‰ï¼Œæ‚¨éœ€è¦æ ¹æ®é¡¹ç›®éœ€æ±‚é€‰æ‹©åˆé€‚çš„å¼€å‘æ¡†æ¶ã€‚ç›®å‰æœ‰ä¸‰ç§ä¸»è¦çš„å¼€å‘æ–¹å¼ï¼š

### 1. MNUtils API æ¡†æ¶ï¼ˆæ¨èï¼‰

**é€‚ç”¨åœºæ™¯**ï¼š
- å¿«é€Ÿå¼€å‘å„ç§è§„æ¨¡çš„æ’ä»¶
- å¸Œæœ›ç›´æ¥ä½¿ç”¨ JavaScript
- éœ€è¦ä¸°å¯Œçš„ API å°è£…
- ä¸å…¶ä»– MNUtils æ’ä»¶ç”Ÿæ€åä½œ

**ä¼˜åŠ¿**ï¼š
- âœ… æˆç†Ÿç¨³å®šï¼Œç»è¿‡å¤§é‡é¡¹ç›®éªŒè¯
- âœ… API è®¾è®¡ç›´è§‚ï¼Œæ˜“äºä¸Šæ‰‹
- âœ… æ— éœ€å¤æ‚é…ç½®ï¼Œå¼€ç®±å³ç”¨
- âœ… æµ·é‡ç°æˆçš„ç¤ºä¾‹ä»£ç å’Œæ’ä»¶å‚è€ƒ
- âœ… å®Œå–„çš„æ–‡æ¡£å’Œç¤¾åŒºæ”¯æŒ
- âœ… è½»é‡çº§ï¼Œæ€§èƒ½ä¼˜ç§€

**åŠ£åŠ¿**ï¼š
- âŒ éœ€è¦ç”¨æˆ·å®‰è£… MNUtils æ’ä»¶
- âŒ çº¯ JavaScriptï¼Œç¼ºå°‘ç±»å‹æ£€æŸ¥
- âŒ è°ƒè¯•ä¾èµ–æ—¥å¿—è¾“å‡º

### 2. åŸç”Ÿ API å¼€å‘

**é€‚ç”¨åœºæ™¯**ï¼š
- å¼€å‘æç®€æ’ä»¶
- ä¸æƒ³ä¾èµ– MNUtils
- éœ€è¦æœ€å¤§ç¨‹åº¦çš„æ§åˆ¶
- å­¦ä¹  MarginNote åº•å±‚æœºåˆ¶

**ä¼˜åŠ¿**ï¼š
- âœ… æ— ä»»ä½•ä¾èµ–
- âœ… æœ€å°çš„æ’ä»¶ä½“ç§¯
- âœ… ç›´æ¥è®¿é—®æ‰€æœ‰åº•å±‚ API
- âœ… å®Œå…¨æ§åˆ¶

**åŠ£åŠ¿**ï¼š
- âŒ å¼€å‘éš¾åº¦å¤§
- âŒ éœ€è¦æ·±å…¥ç†è§£ Objective-C æ¦‚å¿µ
- âŒ å¤§é‡é‡å¤ä»£ç 
- âŒ å®¹æ˜“å‡ºé”™ï¼Œè°ƒè¯•å›°éš¾

### 3. OhMyMN æ¡†æ¶ï¼ˆæœªæ¥é€‰æ‹©ï¼‰

**é€‚ç”¨åœºæ™¯**ï¼š
- éœ€è¦ TypeScript ç±»å‹æ”¯æŒ
- è®¡åˆ’å¼€å‘å¤§å‹å¤æ‚æ’ä»¶
- å¸Œæœ›ä½¿ç”¨ç°ä»£åŒ–å·¥å…·é“¾
- è¿½æ±‚æœ€æ–°æŠ€æœ¯æ ˆ

**ä¼˜åŠ¿**ï¼š
- âœ… å®Œæ•´çš„ TypeScript æ”¯æŒ
- âœ… ç°ä»£åŒ–çš„ API è®¾è®¡
- âœ… æ”¯æŒçƒ­é‡è½½å¼€å‘
- âœ… æ¨¡å—åŒ–æ¶æ„

**åŠ£åŠ¿**ï¼š
- âŒ å­¦ä¹ æ›²çº¿è¾ƒé«˜
- âŒ éœ€è¦ Node.js ç¯å¢ƒ
- âŒ ç¤¾åŒºç›¸å¯¹è¾ƒæ–°
- âŒ æ‰“åŒ…ä½“ç§¯è¾ƒå¤§

### æ¡†æ¶å¯¹æ¯”è¡¨

| ç‰¹æ€§ | MNUtils | åŸç”Ÿ API | OhMyMN |
|------|----------|----------|---------|
| å¼€å‘éš¾åº¦ | ç®€å• | å›°éš¾ | ä¸­ç­‰ |
| TypeScript | âŒ | âŒ | âœ… |
| çƒ­é‡è½½ | âŒ | âŒ | âœ… |
| ç±»å‹å®‰å…¨ | âŒ | âŒ | âœ… |
| ç¤¾åŒºæ”¯æŒ | ä¼˜ç§€ | æœ‰é™ | è‰¯å¥½ |
| æ’ä»¶ä½“ç§¯ | ä¸­ç­‰ | æœ€å° | è¾ƒå¤§ |
| ä¾èµ–è¦æ±‚ | MNUtilsæ’ä»¶ | æ—  | Node.js |
| API ä¸°å¯Œåº¦ | ä¸°å¯Œ | åŸºç¡€ | æœ€ä¸°å¯Œ |
| å­¦ä¹ èµ„æº | æœ€ä¸°å¯Œ | è¾ƒå°‘ | å¢é•¿ä¸­ |
| æˆç†Ÿåº¦ | éå¸¸æˆç†Ÿ | æœ€æˆç†Ÿ | è¾ƒæ–° |

### é€‰æ‹©å»ºè®®

- **å¤§éƒ¨åˆ†å¼€å‘è€…**ï¼šæ¨èä½¿ç”¨ MNUtilsï¼Œæˆç†Ÿç¨³å®šï¼Œèµ„æºä¸°å¯Œ
- **æ–°æ‰‹å¼€å‘è€…**ï¼šå¼ºçƒˆå»ºè®®ä» MNUtils å¼€å§‹ï¼Œå­¦ä¹ æ›²çº¿å¹³ç¼“
- **æç®€æ’ä»¶**ï¼šå¯ä»¥è€ƒè™‘åŸç”Ÿ APIï¼Œæ— éœ€ä¾èµ–
- **æœªæ¥é¡¹ç›®**ï¼šå¦‚éœ€ TypeScript æ”¯æŒï¼Œå¯ä»¥è€ƒè™‘ OhMyMN

## ğŸŒŸ MNUtils - æ ¸å¿ƒ API æ¡†æ¶ï¼ˆä¸»æµé€‰æ‹©ï¼‰

### é‡è¦è¯´æ˜

**MNUtils æ˜¯ MarginNote æ’ä»¶å¼€å‘ç”Ÿæ€ä¸­æœ€åŸºç¡€ã€æœ€é‡è¦çš„ API é¡¹ç›®**ã€‚å®ƒä¸ºæ‰€æœ‰ MarginNote æ’ä»¶æä¾›äº†ç»Ÿä¸€ã€ä¾¿æ·çš„ API æ¥å£ï¼Œæå¤§åœ°ç®€åŒ–äº†æ’ä»¶å¼€å‘çš„å¤æ‚åº¦ã€‚

### MNUtils çš„æ ¸å¿ƒä»·å€¼

1. **API å°è£…**ï¼šå°†å¤æ‚çš„ Objective-C API å°è£…æˆç®€å•æ˜“ç”¨çš„ JavaScript æ¥å£
2. **è·¨å¹³å°å…¼å®¹**ï¼šå¤„ç† iOS å’Œ macOS çš„å¹³å°å·®å¼‚
3. **åŠŸèƒ½å¢å¼º**ï¼šæä¾›åŸç”Ÿ API æ²¡æœ‰çš„é«˜çº§åŠŸèƒ½
4. **å¼€å‘æ•ˆç‡**ï¼šè®©å¼€å‘è€…ä¸“æ³¨äºä¸šåŠ¡é€»è¾‘è€Œéåº•å±‚å®ç°

### å¦‚ä½•ä½¿ç”¨ MNUtils

#### 1. æ£€æŸ¥ MNUtils æ˜¯å¦å¯ç”¨
```javascript
// åœ¨æ’ä»¶åˆå§‹åŒ–æ—¶æ£€æŸ¥
if (typeof MNUtil === "undefined") {
  console.error("MNUtils not installed");
  // æç¤ºç”¨æˆ·å®‰è£… MNUtils
  return;
}

// åˆå§‹åŒ– MNUtils
MNUtil.init(self.path);
```

#### 2. å¸¸ç”¨ API ç¤ºä¾‹
```javascript
// UI äº¤äº’
MNUtil.showHUD("æ“ä½œæˆåŠŸ");

// ç¬”è®°æ“ä½œ
const focusNote = MNNote.getFocusNote();
MNUtil.undoGrouping(() => {
  focusNote.noteTitle = "æ–°æ ‡é¢˜";
});

// äº‹ä»¶ç®¡ç†
MNUtil.addObserver(self, "onPopupMenuOnNote:", "PopupMenuOnNote");

// æ•°æ®å­˜å‚¨
NSUserDefaults.standardUserDefaults().setObjectForKey(data, key);
```

### MNUtils æ ¸å¿ƒç»„ä»¶

| ç±»å | åŠŸèƒ½ | ä¸»è¦ç”¨é€” |
|------|------|----------|
| **MNUtil** | æ ¸å¿ƒå·¥å…·ç±» | ç³»ç»ŸåŠŸèƒ½ã€UIäº¤äº’ã€æ–‡ä»¶æ“ä½œ |
| **MNNote** | ç¬”è®°æ“ä½œç±» | ç¬”è®°çš„åˆ›å»ºã€ä¿®æ”¹ã€æŸ¥è¯¢ |
| **MNNotebook** | ç¬”è®°æœ¬ç®¡ç† | å­¦ä¹ é›†å’Œç¬”è®°æœ¬æ“ä½œ |
| **MNDocument** | æ–‡æ¡£æ“ä½œ | PDF/ePubæ–‡æ¡£ç®¡ç† |
| **MNComment** | è¯„è®ºç®¡ç† | å„ç±»è¯„è®ºçš„æ·»åŠ å’Œç®¡ç† |
| **Menu** | èœå•ç»„ä»¶ | åˆ›å»ºè‡ªå®šä¹‰å¼¹å‡ºèœå• |
| **MNButton** | æŒ‰é’®ç»„ä»¶ | åˆ›å»ºè‡ªå®šä¹‰UIæŒ‰é’® |
| **MNConnection** | ç½‘ç»œè¯·æ±‚ | HTTPè¯·æ±‚ã€WebDAV |
| **MNExtensionPanel** | æ’ä»¶é¢æ¿ | æ§åˆ¶æ’ä»¶UIé¢æ¿ |

### å®Œæ•´ API æ–‡æ¡£

**è¯¦ç»†çš„ API ä½¿ç”¨è¯´æ˜è¯·å‚è€ƒï¼š[MNutils_API_Guide.md](./MNutils_API_Guide.md)**

è¯¥æ–‡æ¡£åŒ…å«ï¼š
- æ‰€æœ‰ç±»å’Œæ–¹æ³•çš„è¯¦ç»†è¯´æ˜
- å‚æ•°ç±»å‹å’Œè¿”å›å€¼
- ä½¿ç”¨ç¤ºä¾‹å’Œæœ€ä½³å®è·µ
- å¸¸è§é—®é¢˜è§£ç­”

### ä¸ºä»€ä¹ˆå¿…é¡»ä½¿ç”¨ MNUtils

1. **é™ä½å¼€å‘éš¾åº¦**
   - æ— éœ€ç†è§£å¤æ‚çš„ Objective-C API
   - æä¾›ç›´è§‚çš„ JavaScript æ¥å£
   - è‡ªåŠ¨å¤„ç†ç±»å‹è½¬æ¢

2. **æé«˜å¼€å‘æ•ˆç‡**
   - å¸¸ç”¨åŠŸèƒ½å°è£…æˆä¸€è¡Œä»£ç 
   - æ‰¹é‡æ“ä½œæ”¯æŒ
   - é”™è¯¯å¤„ç†æœºåˆ¶

3. **ä¿è¯å…¼å®¹æ€§**
   - å¤„ç†ä¸åŒç‰ˆæœ¬çš„ API å·®å¼‚
   - å…¼å®¹ iOS å’Œ macOS å¹³å°
   - å‘åå…¼å®¹ä¿è¯

4. **ç¤¾åŒºæ ‡å‡†**
   - å‡ ä¹æ‰€æœ‰ä¼˜ç§€æ’ä»¶éƒ½åŸºäº MNUtils
   - ä¸°å¯Œçš„ç¤ºä¾‹ä»£ç 
   - æ´»è·ƒçš„ç¤¾åŒºæ”¯æŒ

### å®‰è£… MNUtils

ç”¨æˆ·éœ€è¦å…ˆå®‰è£… MNUtils æ’ä»¶ï¼Œä½ çš„æ’ä»¶æ‰èƒ½ä½¿ç”¨å…¶ APIï¼š
1. ä» MarginNote æ’ä»¶å•†åº—ä¸‹è½½ MNUtils
2. å®‰è£…å¹¶å¯ç”¨ MNUtils æ’ä»¶
3. é‡å¯ MarginNote

### å¼€å‘å»ºè®®

- **å§‹ç»ˆæ£€æŸ¥ MNUtils å¯ç”¨æ€§**ï¼šåœ¨ä½¿ç”¨ä»»ä½• API å‰è¿›è¡Œæ£€æŸ¥
- **å‚è€ƒ API æ–‡æ¡£**ï¼šå……åˆ†åˆ©ç”¨ MNutils_API_Guide.md
- **å­¦ä¹ ç¤ºä¾‹ä»£ç **ï¼šå‚è€ƒå…¶ä»–åŸºäº MNUtils çš„æ’ä»¶
- **ä¼˜é›…é™çº§**ï¼šä¸ºæ²¡æœ‰å®‰è£… MNUtils çš„ç”¨æˆ·æä¾›æç¤º

---

## ğŸ“– ç›®å½•

1. [ğŸ¯ å¼€å‘æ¡†æ¶é€‰æ‹©æŒ‡å—](#ğŸ¯-å¼€å‘æ¡†æ¶é€‰æ‹©æŒ‡å—)
2. [ğŸŒŸ MNUtils - æ ¸å¿ƒ API æ¡†æ¶](#ğŸŒŸ-mnutils---æ ¸å¿ƒ-api-æ¡†æ¶ä¸»æµé€‰æ‹©)
3. [ğŸ“š MarginNote4 åŸºç¡€æ¶æ„](#ğŸ“š-marginnote4-åŸºç¡€æ¶æ„)
4. [ğŸ› ï¸ æŠ€æœ¯æ¶æ„ä¸é™åˆ¶](#ğŸ› ï¸-æŠ€æœ¯æ¶æ„ä¸é™åˆ¶)
5. [âš ï¸ å¼€å‘é™·é˜±ä¸è§£å†³æ–¹æ¡ˆ](#âš ï¸-å¼€å‘é™·é˜±ä¸è§£å†³æ–¹æ¡ˆ)
6. [ğŸ”§ æ’ä»¶å¼€å‘è¦ç‚¹](#ğŸ”§-æ’ä»¶å¼€å‘è¦ç‚¹)
7. [ğŸ”„ æ’ä»¶ç”Ÿå‘½å‘¨æœŸè¯¦è§£](#ğŸ”„-æ’ä»¶ç”Ÿå‘½å‘¨æœŸè¯¦è§£)
8. [ğŸ“¡ äº‹ä»¶ç³»ç»Ÿå®Œæ•´æŒ‡å—](#ğŸ“¡-äº‹ä»¶ç³»ç»Ÿå®Œæ•´æŒ‡å—)
9. [ğŸ“ æœ€ä½³å®è·µ](#ğŸ“-æœ€ä½³å®è·µ)
10. [ğŸš€ å¸¸è§æ’ä»¶ç±»å‹](#ğŸš€-å¸¸è§æ’ä»¶ç±»å‹)
11. [ğŸ’¡ å¼€å‘è§„èŒƒä¸æ ‡å‡†](#ğŸ’¡-å¼€å‘è§„èŒƒä¸æ ‡å‡†)
12. [ğŸš€ å¼€å‘æµç¨‹æŒ‡å—](#ğŸš€-å¼€å‘æµç¨‹æŒ‡å—)
13. [ğŸ“˜ å®æˆ˜å¼€å‘æŒ‡å—](#ğŸ“˜-å®æˆ˜å¼€å‘æŒ‡å—)
14. [ğŸ’» å®Œæ•´ç¤ºä¾‹ä»£ç ](#ğŸ’»-å®Œæ•´ç¤ºä¾‹ä»£ç )
15. [ğŸ¨ OhMyMN æ¡†æ¶å‚è€ƒ](#ğŸ¨-ohmymn-æ¡†æ¶å‚è€ƒ)
16. [ğŸ”’ å®‰å…¨ä¸éšç§](#ğŸ”’-å®‰å…¨ä¸éšç§)
17. [ğŸ“Š æµ‹è¯•ç­–ç•¥](#ğŸ“Š-æµ‹è¯•ç­–ç•¥)
18. [ğŸ¯ å‘å¸ƒä¸ç»´æŠ¤](#ğŸ¯-å‘å¸ƒä¸ç»´æŠ¤)
19. [ğŸ“š å‚è€ƒèµ„æº](#ğŸ“š-å‚è€ƒèµ„æº)
20. [â“ FAQ - å¸¸è§é—®é¢˜è§£ç­”](#â“-faq---å¸¸è§é—®é¢˜è§£ç­”)
21. [ğŸ“¤ æ’ä»¶å•†åº—å‘å¸ƒæµç¨‹](#ğŸ“¤-æ’ä»¶å•†åº—å‘å¸ƒæµç¨‹)

---

## ğŸ“š MarginNote4 åŸºç¡€æ¶æ„

### 1. æ–‡æ¡£ç³»ç»Ÿ

#### æ”¯æŒçš„æ–‡æ¡£ç±»å‹
- **PDF**: ä¸»è¦æ–‡æ¡£æ ¼å¼ï¼Œæ”¯æŒæ‰¹æ³¨ã€é«˜äº®ã€æ‰‹å†™
- **ePub**: ç”µå­ä¹¦æ ¼å¼ï¼Œæ”¯æŒé‡æ’ç‰ˆ
- **ç½‘é¡µ**: é€šè¿‡å†…ç½®æµè§ˆå™¨å¯¼å…¥

#### æ–‡æ¡£æ ‡è¯†
```javascript
// æ¯ä¸ªæ–‡æ¡£éƒ½æœ‰å”¯ä¸€çš„ MD5 æ ‡è¯†
doc.docMd5        // æ–‡æ¡£å”¯ä¸€æ ‡è¯†
doc.docTitle      // æ–‡æ¡£æ ‡é¢˜
doc.pageCount     // é¡µæ•°
```

### 2. ç¬”è®°ç³»ç»Ÿå±‚çº§ç»“æ„

```
å­¦ä¹ é›† (Study Set)
  â””â”€â”€ ç¬”è®°æœ¬ (Notebook)
      â””â”€â”€ ç¬”è®° (Note)
          â”œâ”€â”€ æ‘˜å½• (Excerpt)
          â”œâ”€â”€ è¯„è®º (Comments)
          â”‚   â”œâ”€â”€ æ–‡æœ¬è¯„è®º
          â”‚   â”œâ”€â”€ å›¾ç‰‡è¯„è®º
          â”‚   â”œâ”€â”€ æ‰‹å†™è¯„è®º
          â”‚   â””â”€â”€ é“¾æ¥è¯„è®º
          â”œâ”€â”€ æ ‡ç­¾ (Tags)
          â””â”€â”€ å­ç¬”è®° (Child Notes)
```

### 3. ç¬”è®°ç±»å‹

#### 3.1 æ‘˜å½•ç¬”è®°
- ä»æ–‡æ¡£ä¸­é€‰æ‹©æ–‡æœ¬æˆ–å›¾ç‰‡åˆ›å»º
- ä¿ç•™åŸæ–‡ä½ç½®ä¿¡æ¯
- æ”¯æŒå¤šæ®µæ‘˜å½•åˆå¹¶

#### 3.2 è„‘å›¾ç¬”è®°
- ç‹¬ç«‹åˆ›å»ºçš„ç¬”è®°
- ä¸ä¾èµ–æ–‡æ¡£å†…å®¹
- å¸¸ç”¨äºçŸ¥è¯†æ•´ç†

#### 3.3 å¡ç‰‡ç¬”è®°
- ç”¨äºè®°å¿†å’Œå¤ä¹ 
- æ”¯æŒæ­£åé¢è®¾è®¡
- å¯åŠ å…¥å¤ä¹ è®¡åˆ’

### 4. å­¦ä¹ æ¨¡å¼

MarginNote4 æä¾›ä¸‰ç§ä¸»è¦æ¨¡å¼ï¼š

1. **æ–‡æ¡£æ¨¡å¼** (Document Mode)
   - é˜…è¯»å’Œæ ‡æ³¨æ–‡æ¡£
   - åˆ›å»ºæ‘˜å½•ç¬”è®°
   - å¿«é€Ÿæµè§ˆ

2. **å­¦ä¹ æ¨¡å¼** (Study Mode)
   - æ–‡æ¡£ + è„‘å›¾åŒå±æ˜¾ç¤º
   - æ•´ç†çŸ¥è¯†ç»“æ„
   - å»ºç«‹ç¬”è®°å…³è”

3. **å¤ä¹ æ¨¡å¼** (Review Mode)
   - é—´éš”é‡å¤ç®—æ³•
   - å¡ç‰‡å¼å¤ä¹ 
   - è®°å¿†å¼ºåŒ–

### 5. è„‘å›¾åŠŸèƒ½

#### è„‘å›¾è§†å›¾ç±»å‹
- **å¤§çº²è§†å›¾**: å±‚çº§åˆ—è¡¨æ˜¾ç¤º
- **è„‘å›¾è§†å›¾**: æ€ç»´å¯¼å›¾æ˜¾ç¤º
- **æ¡†æ¶è§†å›¾**: è¡¨æ ¼åŒ–æ˜¾ç¤º

#### è„‘å›¾æ“ä½œ
```javascript
// èšç„¦åˆ°è„‘å›¾ä¸­çš„ç¬”è®°
MNUtil.focusNoteInMindMapById(noteId, delay)

// è·å–è„‘å›¾è§†å›¾
MNUtil.mindmapView

// è„‘å›¾åˆ†æ”¯é¢œè‰²
note.mindmapBranchColor
```

### 6. æ ‡ç­¾ç³»ç»Ÿ

#### æ ‡ç­¾ç±»å‹
1. **æ™®é€šæ ‡ç­¾**: ç”¨äºåˆ†ç±»å’Œç­›é€‰
2. **é“¾æ¥æ ‡ç­¾**: å»ºç«‹ç¬”è®°é—´å…³è”
3. **ç³»ç»Ÿæ ‡ç­¾**: å¦‚ #é‡è¦ #å¾…åŠ

#### æ ‡ç­¾æ“ä½œ
```javascript
note.tags                    // è·å–æ ‡ç­¾æ•°ç»„
note.appendTags(["æ ‡ç­¾1"])   // æ·»åŠ æ ‡ç­¾
note.removeTags(["æ ‡ç­¾2"])   // åˆ é™¤æ ‡ç­¾
```

### 7. é“¾æ¥ç³»ç»Ÿ

#### é“¾æ¥ç±»å‹
1. **ç¬”è®°é“¾æ¥**: è¿æ¥ç›¸å…³ç¬”è®°
2. **æ–‡æ¡£é“¾æ¥**: è·³è½¬åˆ°æ–‡æ¡£ä½ç½®
3. **å¤–éƒ¨é“¾æ¥**: ç½‘é¡µæˆ–å…¶ä»–åº”ç”¨

#### URL æ ¼å¼
```
marginnote4app://note/[noteId]      // ç¬”è®°é“¾æ¥
marginnote4app://notebook/[id]      // ç¬”è®°æœ¬é“¾æ¥
```

### 8. è¯„è®ºç³»ç»Ÿ

#### è¯„è®ºç±»å‹
```javascript
// æ–‡æœ¬è¯„è®º
note.appendTextComment("è¯„è®ºå†…å®¹")

// Markdown è¯„è®º
note.appendMarkdownComment("**åŠ ç²—**æ–‡æœ¬")

// HTML è¯„è®ºï¼ˆå¯Œæ–‡æœ¬ï¼‰
note.appendHtmlComment(html, text, size, tag)

// å›¾ç‰‡è¯„è®º
note.appendImageComment(imageData)

// é“¾æ¥è¯„è®º
note.appendNoteLink(targetNote, "é“¾æ¥è¯´æ˜")
```

### 9. é¢œè‰²ç³»ç»Ÿ

MarginNote4 ä½¿ç”¨ 16 è‰²ç³»ç»Ÿï¼š

```javascript
// é¢œè‰²ç´¢å¼• 0-15
0: "æ·¡é»„è‰²"    8: "æ©™è‰²"
1: "æ·¡ç»¿è‰²"    9: "æ·±ç»¿è‰²"
2: "æ·¡è“è‰²"    10: "æ·±è“è‰²"
3: "æ·¡çº¢è‰²"    11: "æ·±çº¢è‰²"
4: "é»„è‰²"      12: "ç™½è‰²"
5: "ç»¿è‰²"      13: "æ·¡ç°è‰²"
6: "è“è‰²"      14: "æ·±ç°è‰²"
7: "çº¢è‰²"      15: "ç´«è‰²"
```

### 10. æ•°æ®ç®¡ç†

#### å­˜å‚¨ä½ç½®
- **æœ¬åœ°å­˜å‚¨**: SQLite æ•°æ®åº“
- **iCloud åŒæ­¥**: è·¨è®¾å¤‡åŒæ­¥
- **å¤‡ä»½**: æ”¯æŒå¯¼å‡ºä¸º .mnbackup

#### æ•°æ®åº“ç»“æ„
```javascript
MNUtil.db                    // æ•°æ®åº“å®ä¾‹
MNUtil.dbFolder             // æ•°æ®åº“æ–‡ä»¶å¤¹
```

### 11. æ‰©å±•ç³»ç»Ÿ

#### æ’ä»¶ä½ç½®
- iOS: `~/Library/MarginNote 4/Extensions/`
- macOS: `~/Library/Containers/MarginNote 4/Data/Library/MarginNote 4/Extensions/`

#### æ’ä»¶ç”Ÿå‘½å‘¨æœŸ
```javascript
// åœºæ™¯è¿æ¥
sceneWillConnect()

// ç¬”è®°æœ¬æ‰“å¼€
notebookWillOpen(notebookId)

// æ–‡æ¡£æ‰“å¼€
documentDidOpen(docMd5)

// åœºæ™¯æ–­å¼€
sceneDidDisconnect()
```

### 12. æ‰‹åŠ¿å’Œå¿«æ·é”®

#### å¸¸ç”¨æ‰‹åŠ¿
- **é•¿æŒ‰**: å¼¹å‡ºèœå•
- **åŒå‡»**: å¿«é€Ÿç¼–è¾‘
- **æ‹–æ”¾**: ç§»åŠ¨ç¬”è®°

#### å¼¹å‡ºèœå•
```javascript
// ç¬”è®°å¼¹å‡ºèœå•
onPopupMenuOnNote(info)

// é€‰æ‹©åŒºåŸŸå¼¹å‡ºèœå•
onPopupMenuOnSelection(info)
```

### 13. å¯¼å…¥å¯¼å‡º

#### æ”¯æŒçš„æ ¼å¼
- **å¯¼å…¥**: PDF, ePub, ç½‘é¡µ, .mnbackup
- **å¯¼å‡º**: 
  - è„‘å›¾: PNG, PDF, OPML, Markdown
  - ç¬”è®°: Anki, PDF, Word
  - æ•°æ®: .mnbackup

### 14. ä¸»é¢˜ç³»ç»Ÿ

```javascript
MNUtil.themeColor = {
  Gray: "#414141",     // ç°è‰²ä¸»é¢˜
  Default: "#FFFFFF",  // é»˜è®¤ä¸»é¢˜
  Dark: "#000000",     // æš—è‰²ä¸»é¢˜
  Green: "#E9FBC7",    // ç»¿è‰²ä¸»é¢˜
  Sepia: "#F5EFDC"     // æ£•è¤è‰²ä¸»é¢˜
}
```

## ğŸ› ï¸ æŠ€æœ¯æ¶æ„ä¸é™åˆ¶

### 1. æŠ€æœ¯æœ¬è´¨
- **åŸºç¡€æ¶æ„**ï¼šMarginNote æ’ä»¶æœ¬è´¨ä¸Šæ˜¯åŸºäº Objective-C API çš„ JavaScript æ‰©å±•
- **è¿è¡Œç¯å¢ƒ**ï¼šåœ¨ Safari/WebKit ç¯å¢ƒä¸­è¿è¡Œï¼Œå—é™äº iOS/macOS ç³»ç»Ÿ API
- **é€šä¿¡æœºåˆ¶**ï¼šé€šè¿‡ JSBridge å®ç° JavaScript ä¸åŸç”Ÿ API çš„äº¤äº’

### 2. æ’ä»¶åŒ…ç»“æ„
```
plugin.mnaddon (ZIP æ ¼å¼)
â”œâ”€â”€ mnaddon.json    # æ’ä»¶æ¸…å•ï¼ˆå¿…éœ€ï¼‰
â”œâ”€â”€ main.js         # ä¸»ç¨‹åºï¼ˆå¿…éœ€ï¼‰
â”œâ”€â”€ logo.png        # 44x44 å›¾æ ‡ï¼ˆå¿…éœ€ï¼‰
â””â”€â”€ resources/      # èµ„æºæ–‡ä»¶ï¼ˆå¯é€‰ï¼‰
    â”œâ”€â”€ *.js        # å…¶ä»–è„šæœ¬æ–‡ä»¶
    â”œâ”€â”€ *.html      # HTML ç•Œé¢æ–‡ä»¶
    â””â”€â”€ *.css       # æ ·å¼æ–‡ä»¶
```

### 3. æ¸…å•æ–‡ä»¶è§„èŒƒ (mnaddon.json)
```json
{
  "addonid": "marginnote.extension.yourplugin",
  "author": "ä½œè€…å",
  "title": "æ’ä»¶åç§°",
  "version": "1.0.0",
  "marginnote_version_min": "3.7.11",
  "cert_key": ""  // å®˜æ–¹è®¤è¯å¯†é’¥ï¼ˆå¯é€‰ï¼‰
}
```

### 4. æŠ€æœ¯é™åˆ¶

#### API é™åˆ¶
- **æ—  Node.js API**ï¼šä¸èƒ½ä½¿ç”¨ fsã€pathã€process ç­‰
- **æ— å®Œæ•´ç½‘ç»œè¯·æ±‚**ï¼šXMLHttpRequest å—é™ï¼Œæ—  fetch API
- **æ— æ–‡ä»¶ç³»ç»Ÿè®¿é—®**ï¼šä¸èƒ½ç›´æ¥è¯»å†™æ–‡ä»¶ç³»ç»Ÿ
- **æ— è¿›ç¨‹æ§åˆ¶**ï¼šä¸èƒ½æ‰§è¡Œå¤–éƒ¨ç¨‹åºæˆ–è„šæœ¬
- **å†…å­˜é™åˆ¶**ï¼šå¤§æ•°æ®å¤„ç†å¯èƒ½å¯¼è‡´å´©æºƒ

#### å¹³å°å·®å¼‚
| åŠŸèƒ½ | iOS | macOS |
|------|-----|-------|
| è§¦æ‘¸æ‰‹åŠ¿ | âœ… | âŒ |
| é¼ æ ‡æ‚¬åœ | âŒ | âœ… |
| é”®ç›˜å¿«æ·é”® | å—é™ | âœ… |
| çª—å£ç®¡ç† | å—é™ | âœ… |
| æ–‡ä»¶æ‹–æ”¾ | âŒ | âœ… |

### 5. å¼€å‘é—¨æ§›
- **å­¦ä¹ æ›²çº¿é™¡å³­**ï¼šéœ€è¦ç†è§£ Objective-C æ¦‚å¿µå’Œ JSBridge æœºåˆ¶
- **è°ƒè¯•å›°éš¾**ï¼šé”™è¯¯ä¿¡æ¯æœ‰é™ï¼Œéœ€è¦å¤§é‡æ—¥å¿—
- **æ–‡æ¡£ç¨€ç¼º**ï¼šå®˜æ–¹æ–‡æ¡£ä¸å®Œæ•´ï¼Œéœ€è¦å‚è€ƒå…¶ä»–æ’ä»¶
- **å…¼å®¹æ€§æŒ‘æˆ˜**ï¼šiOS å’Œ macOS è¡Œä¸ºå·®å¼‚å¤§

### 6. æ ¸å¿ƒæ¡†æ¶ä½¿ç”¨

#### QuartzCore æ¡†æ¶
QuartzCore æ˜¯ iOS çš„æ ¸å¿ƒåŠ¨ç”»æ¡†æ¶ï¼Œåœ¨æ’ä»¶å¼€å‘ä¸­ä¸»è¦ç”¨äºï¼š
- **è§†è§‰åé¦ˆ**ï¼šåˆ›å»ºåŠ¨ç”»æ•ˆæœï¼Œæå‡ç”¨æˆ·ä½“éªŒ
- **ç•Œé¢åŠ¨ç”»**ï¼šå¹³æ»‘çš„è¿‡æ¸¡å’Œè½¬åœºæ•ˆæœ
- **å›¾å±‚æ“ä½œ**ï¼šè‡ªå®šä¹‰ç»˜åˆ¶å’Œå›¾å½¢å˜æ¢

```javascript
// ä½¿ç”¨ QuartzCore åˆ›å»ºåŠ¨ç”»æ•ˆæœç¤ºä¾‹
function animateView(view) {
  // åˆ›å»ºåŸºç¡€åŠ¨ç”»
  const animation = CABasicAnimation.animationWithKeyPath("opacity");
  animation.fromValue = 0.0;
  animation.toValue = 1.0;
  animation.duration = 0.3;
  
  // åº”ç”¨åˆ°è§†å›¾çš„ layer
  view.layer.addAnimation(animation, "fadeIn");
}
```

#### UIKit æ¡†æ¶
UIKit æ˜¯ iOS åº”ç”¨çš„åŸºç¡€æ¡†æ¶ï¼Œæä¾›äº†ä¸°å¯Œçš„ UI ç»„ä»¶å’ŒåŠŸèƒ½ï¼š
- **ç•Œé¢æ„å»º**ï¼šåˆ›å»ºè‡ªå®šä¹‰è§†å›¾ã€æŒ‰é’®ã€èœå•ç­‰
- **äº‹ä»¶å¤„ç†**ï¼šå“åº”ç”¨æˆ·äº¤äº’
- **æ–‡æ¡£ç®¡ç†**ï¼šå¤„ç†æ–‡æ¡£å’Œèµ„æº
- **é¢œè‰²å’Œä¸»é¢˜**ï¼šé€‚é… MarginNote çš„ä¸»é¢˜ç³»ç»Ÿ

```javascript
// UIKit ä½¿ç”¨ç¤ºä¾‹
// åˆ›å»ºè‡ªå®šä¹‰æŒ‰é’®
const button = UIButton.buttonWithType(0); // UIButtonTypeCustom
button.frame = { x: 0, y: 0, width: 100, height: 44 };
button.setTitle("è‡ªå®šä¹‰æŒ‰é’®", 0); // UIControlStateNormal
button.setTitleColor(UIColor.systemBlueColor, 0);

// æ·»åŠ ç‚¹å‡»äº‹ä»¶
button.addTarget(self, "buttonClicked:", 1 << 6); // UIControlEventTouchUpInside

// è·å–å½“å‰ä¸»é¢˜é¢œè‰²
const app = Application.sharedInstance();
const tintColor = app.defaultTintColor;
const textColor = app.defaultTextColor;
```

#### æ¡†æ¶ä½¿ç”¨æ³¨æ„äº‹é¡¹
1. **æ€§èƒ½è€ƒè™‘**ï¼šåŠ¨ç”»å’Œè§†è§‰æ•ˆæœè¦é€‚åº¦ï¼Œé¿å…å½±å“æ€§èƒ½
2. **å¹³å°å·®å¼‚**ï¼šæŸäº› UIKit åŠŸèƒ½åœ¨ macOS ä¸Šå¯èƒ½ä¸å¯ç”¨
3. **å†…å­˜ç®¡ç†**ï¼šåŠæ—¶é‡Šæ”¾ä¸å†ä½¿ç”¨çš„è§†å›¾å’Œèµ„æº
4. **ä¸»é¢˜é€‚é…**ï¼šä½¿ç”¨ç³»ç»Ÿæä¾›çš„é¢œè‰²ï¼Œç¡®ä¿åœ¨ä¸åŒä¸»é¢˜ä¸‹æ˜¾ç¤ºæ­£å¸¸

## âš ï¸ å¼€å‘é™·é˜±ä¸è§£å†³æ–¹æ¡ˆ

### 1. å¸¸è§é—ªé€€é—®é¢˜

#### é—®é¢˜ï¼šæ¨¡å—åŠ è½½æ—¶æœºé”™è¯¯
```javascript
// âŒ é”™è¯¯ï¼šåœ¨ JSB.newAddon å†…éƒ¨åŠ è½½æ¨¡å—
JSB.newAddon = function(mainPath) {
  JSB.require('module');  // ğŸ’¥ å¯¼è‡´é—ªé€€ï¼
  return JSB.defineClass(...);
};

// âœ… æ­£ç¡®ï¼šåœ¨æ–‡ä»¶æœ«å°¾åŠ è½½æ¨¡å—
JSB.newAddon = function(mainPath) {
  return JSB.defineClass(...);
};
// æ–‡ä»¶æœ«å°¾
JSB.require('module');
```

#### é—®é¢˜ï¼šES6 è¯­æ³•å…¼å®¹æ€§
```javascript
// âŒ å¯èƒ½å¯¼è‡´é—®é¢˜ï¼ˆç‰¹åˆ«æ˜¯åœ¨åˆå§‹åŒ–é˜¶æ®µï¼‰
class TaskModel {
  constructor() {}
}

// âœ… æ›´å®‰å…¨çš„ä¼ ç»Ÿå†™æ³•
function TaskModel() {}
TaskModel.prototype.method = function() {}
```

#### é—®é¢˜ï¼šé”™è¯¯çš„å¯¹è±¡åˆ›å»ºæ–¹å¼
```javascript
// âŒ é”™è¯¯ï¼šä½¿ç”¨ new æ“ä½œç¬¦
const controller = new TaskController();

// âœ… æ­£ç¡®ï¼šä½¿ç”¨ JSB çš„ .new() æ–¹æ³•
const controller = TaskController.new();
```

### 2. æ’ä»¶ä¸æ˜¾ç¤ºé—®é¢˜

#### å¿…éœ€å®ç°çš„æ–¹æ³•
```javascript
// æ’ä»¶åœ¨æ’ä»¶æ æ˜¾ç¤ºçš„å¿…è¦æ¡ä»¶
queryAddonCommandStatus: function() {
  return {
    image: "logo.png",      // 44x44 å›¾æ ‡
    object: self,           // å›è°ƒå¯¹è±¡
    selector: "toggleAddon:", // ç‚¹å‡»æ–¹æ³•
    checked: false          // é€‰ä¸­çŠ¶æ€
  };
}
```

#### é™æ€æ–¹æ³•è¦æ±‚
```javascript
// JSB.defineClass éœ€è¦ä¸¤ä¸ªå‚æ•°
JSB.defineClass("PluginName : JSExtension", 
  { /* å®ä¾‹æ–¹æ³• */ },
  { /* é™æ€æ–¹æ³• - ä¸èƒ½çœç•¥ */ 
    addonDidConnect: function() {},
    addonWillDisconnect: function() {}
  }
);
```

### 3. ä½œç”¨åŸŸé—®é¢˜

#### self å¼•ç”¨ä¸¢å¤±
```javascript
// å…¨å±€ä¿å­˜ self å¼•ç”¨
var self = null;

// åœ¨ sceneWillConnect ä¸­èµ‹å€¼
sceneWillConnect: function() {
  self = this;  // å…³é”®ï¼
  self.path = mainPath;
}
```

### 4. äº‹ä»¶æ¸…ç†é—®é¢˜
```javascript
// âŒ é”™è¯¯ï¼šå¿˜è®°æ¸…ç†äº‹ä»¶
sceneDidDisconnect: function() {
  // ä»€ä¹ˆéƒ½ä¸åš
}

// âœ… æ­£ç¡®ï¼šæ¸…ç†æ‰€æœ‰æ³¨å†Œçš„äº‹ä»¶
sceneDidDisconnect: function() {
  if (typeof MNUtil === "undefined") return;
  MNUtil.removeObserver(self, "PopupMenuOnNote");
  MNUtil.removeObserver(self, "PopupMenuOnSelection");
  // ... æ¸…ç†æ‰€æœ‰äº‹ä»¶
}
```

## ğŸ”§ æ’ä»¶å¼€å‘è¦ç‚¹

### 1. ç†è§£æ•°æ®æµ
- ç”¨æˆ·æ“ä½œ â†’ æ’ä»¶å“åº” â†’ ä¿®æ”¹æ•°æ® â†’ UI æ›´æ–°

### 2. æ€§èƒ½è€ƒè™‘
- é¿å…é¢‘ç¹çš„æ•°æ®åº“æ“ä½œ
- ä½¿ç”¨æ‰¹é‡æ›´æ–°
- åˆç†ä½¿ç”¨ç¼“å­˜

### 3. ç”¨æˆ·ä½“éªŒ
- éµå¾ª MarginNote çš„äº¤äº’ä¹ æƒ¯
- æä¾›æ’¤é”€åŠŸèƒ½
- é”™è¯¯å¤„ç†è¦å‹å¥½

### 4. ç‰ˆæœ¬å…¼å®¹
- æ£€æµ‹ MN3/MN4 ç‰ˆæœ¬
- ä½¿ç”¨æ¡ä»¶åˆ¤æ–­å¤„ç†å·®å¼‚
- æµ‹è¯•å¤šç‰ˆæœ¬å…¼å®¹æ€§

### 5. è°ƒè¯•æŠ€å·§
- ä½¿ç”¨ Safari Web Inspector
- æ·»åŠ è¯¦ç»†çš„æ—¥å¿—
- å¤„ç†è¾¹ç•Œæƒ…å†µ

#### å®˜æ–¹æ¨èè°ƒè¯•æ–¹æ³•

ç”±äº Apple çš„å®‰å…¨é™åˆ¶ï¼Œä¼ ç»Ÿçš„æ–­ç‚¹è°ƒè¯•åœ¨ MarginNote æ’ä»¶å¼€å‘ä¸­å—åˆ°é™åˆ¶ã€‚å®˜æ–¹æ¨èä½¿ç”¨ä»¥ä¸‹æ–¹æ³•è¿›è¡Œè°ƒè¯•ï¼š

##### 1. ä½¿ç”¨ alert() æ–¹æ³•
```javascript
// ç®€å•çš„è°ƒè¯•ä¿¡æ¯è¾“å‡º
Application.sharedInstance().alert("è°ƒè¯•ä¿¡æ¯: " + JSON.stringify(data));

// æ£€æŸ¥å˜é‡å€¼
const note = MNNote.getFocusNote();
if (note) {
  Application.sharedInstance().alert("ç¬”è®°æ ‡é¢˜: " + note.noteTitle);
}
```

##### 2. ä½¿ç”¨ showHUD() æ–¹æ³•ï¼ˆæ¨èï¼‰
```javascript
// æ˜¾ç¤ºä¸´æ—¶æç¤ºä¿¡æ¯
const app = Application.sharedInstance();
app.showHUD("æ“ä½œå¼€å§‹", self.window, 1); // æ˜¾ç¤º 1 ç§’

// æ˜¾ç¤ºå¤„ç†è¿›åº¦
app.showHUD("å¤„ç†ä¸­... (1/10)", self.window, 0.5);

// æ˜¾ç¤ºé”™è¯¯ä¿¡æ¯
app.showHUD("âŒ é”™è¯¯: " + error.message, self.window, 3);
```

##### 3. æ—¥å¿—è¾“å‡ºæŠ€å·§
```javascript
// åˆ›å»ºè°ƒè¯•æ—¥å¿—å‡½æ•°
function debugLog(message, data) {
  if (typeof MNUtil !== "undefined" && MNUtil.log) {
    MNUtil.log(`[DEBUG] ${message}: ${JSON.stringify(data)}`);
  } else {
    // é™çº§ä½¿ç”¨ alert
    Application.sharedInstance().alert(`[DEBUG] ${message}: ${JSON.stringify(data)}`);
  }
}

// ä½¿ç”¨ç¤ºä¾‹
debugLog("å½“å‰ç¬”è®°", { id: note.noteId, title: note.noteTitle });
```

##### 4. é”™è¯¯æ•è·å’Œè°ƒè¯•
```javascript
// åŒ…è£…å‡½æ•°è¿›è¡Œé”™è¯¯æ•è·
function safeExecute(func, funcName) {
  try {
    return func();
  } catch (error) {
    const errorInfo = {
      function: funcName,
      message: error.message,
      stack: error.stack,
      time: new Date().toISOString()
    };
    
    // æ˜¾ç¤ºé”™è¯¯ä¿¡æ¯
    Application.sharedInstance().showHUD(
      `é”™è¯¯: ${funcName} - ${error.message}`, 
      self.window, 
      5
    );
    
    // è®°å½•è¯¦ç»†é”™è¯¯
    if (typeof MNUtil !== "undefined" && MNUtil.addErrorLog) {
      MNUtil.addErrorLog(error, funcName, errorInfo);
    }
    
    return null;
  }
}

// ä½¿ç”¨ç¤ºä¾‹
const result = safeExecute(() => {
  // å¯èƒ½å‡ºé”™çš„ä»£ç 
  return processNote(note);
}, "processNote");
```

##### 5. æ€§èƒ½è°ƒè¯•
```javascript
// æµ‹é‡å‡½æ•°æ‰§è¡Œæ—¶é—´
function measureTime(func, funcName) {
  const start = Date.now();
  const result = func();
  const duration = Date.now() - start;
  
  Application.sharedInstance().showHUD(
    `${funcName} è€—æ—¶: ${duration}ms`, 
    self.window, 
    2
  );
  
  return result;
}

// ä½¿ç”¨ç¤ºä¾‹
const notes = measureTime(() => {
  return notebook.notes;
}, "è·å–æ‰€æœ‰ç¬”è®°");
```

##### 6. è°ƒè¯•æœ€ä½³å®è·µ
1. **åˆ†é˜¶æ®µè°ƒè¯•**ï¼šå°†å¤æ‚æ“ä½œåˆ†è§£ä¸ºå¤šä¸ªæ­¥éª¤ï¼Œæ¯æ­¥éƒ½è¾“å‡ºè°ƒè¯•ä¿¡æ¯
2. **ä½¿ç”¨æ¡ä»¶è°ƒè¯•**ï¼šè®¾ç½®è°ƒè¯•å¼€å…³ï¼Œç”Ÿäº§ç¯å¢ƒå…³é—­è°ƒè¯•è¾“å‡º
3. **ä¿å­˜è°ƒè¯•æ—¥å¿—**ï¼šå°†é‡è¦çš„è°ƒè¯•ä¿¡æ¯ä¿å­˜åˆ°æ–‡ä»¶æˆ–å‰ªè´´æ¿
4. **å¯è§†åŒ–è°ƒè¯•**ï¼šä½¿ç”¨ HUD æ˜¾ç¤ºå…³é”®çŠ¶æ€å˜åŒ–

```javascript
// è°ƒè¯•å¼€å…³
const DEBUG_MODE = true;

function debug(message) {
  if (DEBUG_MODE) {
    Application.sharedInstance().showHUD(`ğŸ” ${message}`, self.window, 1);
  }
}
```

### 6. ç»¼åˆ API å‚è€ƒï¼ˆæŒ‰åŠŸèƒ½åˆ†ç±»ï¼‰

æœ¬èŠ‚æŒ‰ç…§å®é™…å¼€å‘ä¸­çš„åŠŸèƒ½éœ€æ±‚ç»„ç»‡ APIï¼Œæ¯ä¸ªåŠŸèƒ½éƒ½æä¾›äº†ä¸‰ç§å®ç°æ–¹å¼çš„å¯¹æ¯”ã€‚

#### 6.1 åº”ç”¨ç¨‹åºä¸ç³»ç»Ÿä¿¡æ¯

<table>
<tr>
<th>åŠŸèƒ½</th>
<th>MNUtilsï¼ˆæ¨èï¼‰</th>
<th>åŸç”Ÿ API</th>
<th>OhMyMN</th>
</tr>
<tr>
<td>è·å–ç‰ˆæœ¬ä¿¡æ¯</td>
<td>

```javascript
const version = MNUtil.getMarginNoteVersion()
```

</td>
<td>

```javascript
const app = Application.sharedInstance()
const version = app.appVersion
const build = app.build
```

</td>
<td>

```typescript
import { MN } from "marginnote"
const version = MN.appVersion
const build = MN.build
```

</td>
</tr>
<tr>
<td>è·å–ä¸»é¢˜</td>
<td>

```javascript
const theme = MNUtil.currentTheme
const colors = MNUtil.themeColor
```

</td>
<td>

```javascript
const app = Application.sharedInstance()
const theme = app.currentTheme
const tintColor = app.defaultTintColor
```

</td>
<td>

```typescript
const theme = MN.currentTheme
const colors = {
  tint: MN.app.defaultTintColor,
  text: MN.app.defaultTextColor
}
```

</td>
</tr>
<tr>
<td>ç³»ç»Ÿè·¯å¾„</td>
<td>

```javascript
const paths = {
  db: MNUtil.db,
  dbFolder: MNUtil.dbFolder,
  doc: MNUtil.docPath,
  cache: MNUtil.cachePath
}
```

</td>
<td>

```javascript
const app = Application.sharedInstance()
const dbPath = app.dbPath
const docPath = app.documentPath
const cachePath = app.cachePath
```

</td>
<td>

```typescript
const paths = {
  db: MN.app.dbPath,
  doc: MN.app.documentPath,
  cache: MN.app.cachePath,
  temp: MN.app.tempPath,
  addon: Addon.path
}
```

</td>
</tr>
</table>

#### 6.2 ç¬”è®°æ“ä½œ

<table>
<tr>
<th>åŠŸèƒ½</th>
<th>MNUtilsï¼ˆæ¨èï¼‰</th>
<th>åŸç”Ÿ API</th>
<th>OhMyMN</th>
</tr>
<tr>
<td>è·å–å½“å‰ç¬”è®°</td>
<td>

```javascript
const note = MNNote.getFocusNote()
```

</td>
<td>

```javascript
const mindmapView = self.studyController
  .notebookController.mindmapView
const focusNote = mindmapView.focusNote
```

</td>
<td>

```typescript
import { MN, NodeNote } from "marginnote"
const focusNote = MN.focusNote
const node = new NodeNote(focusNote)
```

</td>
</tr>
<tr>
<td>ä¿®æ”¹ç¬”è®°ï¼ˆæ”¯æŒæ’¤é”€ï¼‰</td>
<td>

```javascript
MNUtil.undoGrouping(() => {
  note.noteTitle = "æ–°æ ‡é¢˜"
  note.colorIndex = 3
  note.appendTags(["æ ‡ç­¾"])
})
```

</td>
<td>

```javascript
UndoManager.sharedInstance().undoGrouping(
  "ä¿®æ”¹ç¬”è®°",
  notebookId,
  function() {
    note.noteTitle = "æ–°æ ‡é¢˜"
    note.colorIndex = 3
  }
)
```

</td>
<td>

```typescript
import { undoGroupingWithRefresh } from "marginnote"
undoGroupingWithRefresh(() => {
  node.noteTitle = "æ–°æ ‡é¢˜"
  node.colorIndex = 3
  node.appendTags(["æ ‡ç­¾"])
})
```

</td>
</tr>
<tr>
<td>æ·»åŠ è¯„è®º</td>
<td>

```javascript
note.appendTextComment("æ–‡æœ¬è¯„è®º")
note.appendMarkdownComment("**Markdown**")
note.appendHtmlComment(html, text, size, tag)
```

</td>
<td>

```javascript
note.appendTextComment("æ–‡æœ¬è¯„è®º")
note.appendHtmlComment(
  "<b>HTML</b>",
  "çº¯æ–‡æœ¬",
  16,
  "tag"
)
```

</td>
<td>

```typescript
node.appendTextComments("æ–‡æœ¬è¯„è®º")
// NodeNote ä¼šè‡ªåŠ¨å¤„ç†å¤šç§æ ¼å¼
```

</td>
</tr>
</table>

#### 6.3 ç”¨æˆ·ç•Œé¢ä¸äº¤äº’

<table>
<tr>
<th>åŠŸèƒ½</th>
<th>MNUtilsï¼ˆæ¨èï¼‰</th>
<th>åŸç”Ÿ API</th>
<th>OhMyMN</th>
</tr>
<tr>
<td>æ˜¾ç¤ºæç¤º</td>
<td>

```javascript
MNUtil.showHUD("æ“ä½œæˆåŠŸ")
```

</td>
<td>

```javascript
Application.sharedInstance().showHUD(
  "æ“ä½œæˆåŠŸ",
  self.window,
  2
)
```

</td>
<td>

```typescript
import { showHUD } from "marginnote"
showHUD("æ“ä½œæˆåŠŸ", 2)
```

</td>
</tr>
<tr>
<td>å¼¹å‡ºèœå•</td>
<td>

```javascript
const menu = new Menu(button, self, 200)
menu.addMenuItem("é€‰é¡¹1", "action1:", param1)
menu.addMenuItem("é€‰é¡¹2", "action2:", param2)
menu.show()
```

</td>
<td>

```javascript
// éœ€è¦æ‰‹åŠ¨åˆ›å»º UIMenu
const menu = UIMenu.menuWithTitle(
  "",
  children: [/* menu items */]
)
```

</td>
<td>

```typescript
import { select } from "marginnote"
const result = await select(
  ["é€‰é¡¹1", "é€‰é¡¹2"],
  ["val1", "val2"]
)
```

</td>
</tr>
<tr>
<td>è¾“å…¥å¯¹è¯æ¡†</td>
<td>

```javascript
const input = MNUtil.getInputValue(
  "æ ‡é¢˜",
  "æ¶ˆæ¯",
  "é»˜è®¤å€¼"
)
```

</td>
<td>

```javascript
// éœ€è¦ä½¿ç”¨ UIAlertController
// ä»£ç è¾ƒå¤æ‚
```

</td>
<td>

```typescript
import { popup } from "marginnote"
const result = await popup({
  title: "è¾“å…¥",
  type: PopupType.Input,
  defaultValue: "é»˜è®¤"
})
```

</td>
</tr>
</table>

#### 6.4 æ–‡ä»¶æ“ä½œ

<table>
<tr>
<th>åŠŸèƒ½</th>
<th>OhMyMN</th>
<th>MNUtils</th>
<th>åŸç”Ÿ API</th>
</tr>
<tr>
<td>è¯»å†™ JSON</td>
<td>

```typescript
import { readJSON, writeJSON } from "marginnote"
const data = readJSON(path) || {}
data.version = "1.0"
writeJSON(path, data)
```

</td>
<td>

```javascript
// MNUtils ä½¿ç”¨ NSUserDefaults
const data = NSUserDefaults
  .standardUserDefaults()
  .objectForKey(key)
```

</td>
<td>

```javascript
// éœ€è¦ä½¿ç”¨ NSFileManager
// å’Œ NSJSONSerialization
```

</td>
</tr>
<tr>
<td>æœ¬åœ°å­˜å‚¨</td>
<td>

```typescript
import { getLocalDataByKey, setLocalDataByKey } from "marginnote"
setLocalDataByKey(data, "key")
const saved = getLocalDataByKey("key")
```

</td>
<td>

```javascript
NSUserDefaults.standardUserDefaults()
  .setObjectForKey(data, key)
const saved = NSUserDefaults
  .standardUserDefaults()
  .objectForKey(key)
```

</td>
<td>

```javascript
// åŒ MNUtils
```

</td>
</tr>
</table>

#### 6.5 ç½‘ç»œè¯·æ±‚

<table>
<tr>
<th>åŠŸèƒ½</th>
<th>OhMyMN</th>
<th>MNUtils</th>
<th>åŸç”Ÿ API</th>
</tr>
<tr>
<td>HTTP è¯·æ±‚</td>
<td>

```typescript
import { fetch } from "marginnote"
const data = await fetch(url)
  .then(res => res.json())

// POST è¯·æ±‚
await fetch(url, {
  method: "POST",
  json: { key: "value" }
})
```

</td>
<td>

```javascript
const conn = new MNConnection(url)
conn.sendAsynchronousRequest((res) => {
  const data = JSON.parse(res)
})
```

</td>
<td>

```javascript
// ä½¿ç”¨ NSURLConnection
// æˆ– NSURLSession
// ä»£ç è¾ƒå¤æ‚
```

</td>
</tr>
</table>

#### 6.6 äº‹ä»¶å¤„ç†

<table>
<tr>
<th>åŠŸèƒ½</th>
<th>OhMyMN</th>
<th>MNUtils</th>
<th>åŸç”Ÿ API</th>
</tr>
<tr>
<td>æ³¨å†Œäº‹ä»¶</td>
<td>

```typescript
import { eventObserverController } from "marginnote"
const observer = eventObserverController([
  "PopupMenuOnNote",
  "ProcessNewExcerpt"
])
observer.add()
```

</td>
<td>

```javascript
MNUtil.addObserver(
  self,
  "onPopupMenuOnNote:",
  "PopupMenuOnNote"
)
```

</td>
<td>

```javascript
NSNotificationCenter.defaultCenter()
  .addObserverSelectorName(
    self,
    "onPopupMenuOnNote:",
    "PopupMenuOnNote"
  )
```

</td>
</tr>
</table>

#### 6.7 å¼€å‘è¾…åŠ©

<table>
<tr>
<th>åŠŸèƒ½</th>
<th>OhMyMN</th>
<th>MNUtils</th>
<th>åŸç”Ÿ API</th>
</tr>
<tr>
<td>æ—¥å¿—è¾“å‡º</td>
<td>

```typescript
import { MN } from "marginnote"
MN.log("ä¿¡æ¯", data)
MN.error("é”™è¯¯", error)
```

</td>
<td>

```javascript
MNUtil.log("ä¿¡æ¯: " + JSON.stringify(data))
MNUtil.addErrorLog(error, "function", context)
```

</td>
<td>

```javascript
console.log("ä¿¡æ¯")
// æˆ–ä½¿ç”¨ Application.alert()
```

</td>
</tr>
<tr>
<td>å»¶æ—¶æ‰§è¡Œ</td>
<td>

```typescript
import { delay } from "marginnote"
await delay(1) // ç­‰å¾…1ç§’
```

</td>
<td>

```javascript
MNUtil.delay(1).then(() => {
  // 1ç§’åæ‰§è¡Œ
})
```

</td>
<td>

```javascript
self.performSelector(
  "method:",
  null,
  1.0
)
```

</td>
</tr>
</table>

### API é€‰æ‹©å»ºè®®

1. **ä¼˜å…ˆä½¿ç”¨ MNUtils**ï¼šæˆç†Ÿç¨³å®šï¼Œæ‹¥æœ‰ä¸°å¯Œçš„ API å°è£…å’Œå¤§é‡ç¤ºä¾‹ä»£ç 
2. **åŸç”Ÿ API é€‚ç”¨ç‰¹æ®Šåœºæ™¯**ï¼šå½“éœ€è¦æœ€å°ä¾èµ–æˆ– MNUtils æœªæä¾›çš„åŠŸèƒ½æ—¶ä½¿ç”¨
3. **OhMyMN ä½œä¸ºæœªæ¥é€‰æ‹©**ï¼šå¦‚æœé¡¹ç›®éœ€è¦ TypeScript æ”¯æŒå’Œç°ä»£åŒ–å¼€å‘ä½“éªŒ

## ğŸ”„ æ’ä»¶ç”Ÿå‘½å‘¨æœŸè¯¦è§£

### 1. ç”Ÿå‘½å‘¨æœŸæ–¹æ³•å®Œæ•´åˆ—è¡¨

#### å®ä¾‹æ–¹æ³•ï¼ˆæ¯ä¸ªçª—å£ç‹¬ç«‹ï¼‰
```javascript
{
  // çª—å£ç”Ÿå‘½å‘¨æœŸ
  sceneWillConnect: function() {
    // æ–°å»º MN çª—å£æ—¶è°ƒç”¨
    // åˆå§‹åŒ–æ’ä»¶ç»„ä»¶
  },
  
  sceneDidDisconnect: function() {
    // å…³é—­ MN çª—å£æ—¶è°ƒç”¨
    // æ¸…ç†èµ„æºï¼Œä¿å­˜çŠ¶æ€
  },
  
  sceneWillResignActive: function() {
    // çª—å£å¤±å»ç„¦ç‚¹æ—¶è°ƒç”¨
    // æš‚åœæ´»åŠ¨ï¼Œä¿å­˜ä¸´æ—¶çŠ¶æ€
  },
  
  sceneDidBecomeActive: function() {
    // çª—å£è·å¾—ç„¦ç‚¹æ—¶è°ƒç”¨
    // æ¢å¤æ´»åŠ¨ï¼Œåˆ·æ–°UI
  },
  
  // ç¬”è®°æœ¬ç”Ÿå‘½å‘¨æœŸ
  notebookWillOpen: function(notebookId) {
    // æ‰“å¼€ç¬”è®°æœ¬æ—¶è°ƒç”¨
    // åŠ è½½ç¬”è®°æœ¬ç›¸å…³é…ç½®
  },
  
  notebookWillClose: function(notebookId) {
    // å…³é—­ç¬”è®°æœ¬æ—¶è°ƒç”¨
    // ä¿å­˜ç¬”è®°æœ¬æ•°æ®
  },
  
  // æ–‡æ¡£ç”Ÿå‘½å‘¨æœŸ
  documentDidOpen: function(docMd5) {
    // æ‰“å¼€æ–‡æ¡£æ—¶è°ƒç”¨
    // åˆå§‹åŒ–æ–‡æ¡£ç›¸å…³åŠŸèƒ½
  },
  
  documentWillClose: function(docMd5) {
    // å…³é—­æ–‡æ¡£æ—¶è°ƒç”¨
    // æ¸…ç†æ–‡æ¡£èµ„æº
  }
}
```

#### é™æ€æ–¹æ³•ï¼ˆå…¨å±€å”¯ä¸€ï¼‰
```javascript
{
  addonDidConnect: function() {
    // æ’ä»¶å®‰è£…/å¯ç”¨æ—¶è°ƒç”¨ï¼ˆåŒ…æ‹¬ MN å¯åŠ¨ï¼‰
    // å…¨å±€åˆå§‹åŒ–
  },
  
  addonWillDisconnect: function() {
    // æ’ä»¶å¸è½½/ç¦ç”¨æ—¶è°ƒç”¨
    // å…¨å±€æ¸…ç†
  }
}
```

### 2. ç”Ÿå‘½å‘¨æœŸç®¡ç†æœ€ä½³å®è·µ

#### åˆå§‹åŒ–ç­–ç•¥
```javascript
sceneWillConnect: function() {
  // 1. ä¿å­˜å®ä¾‹å¼•ç”¨
  self = this;
  self.path = mainPath;
  
  // 2. æ£€æŸ¥ä¾èµ–
  if (typeof MNUtil === "undefined") {
    console.error("MNUtils not installed");
    return;
  }
  
  // 3. åˆå§‹åŒ–ç»„ä»¶
  MNUtil.init(mainPath);
  self.initComponents();
  
  // 4. æ³¨å†Œäº‹ä»¶
  self.registerObservers();
  
  // 5. æ¢å¤ä¸Šæ¬¡çŠ¶æ€
  self.restoreState();
}
```

#### èµ„æºæ¸…ç†ç­–ç•¥
```javascript
sceneDidDisconnect: function() {
  // 1. ä¿å­˜å½“å‰çŠ¶æ€
  self.saveState();
  
  // 2. æ¸…ç†äº‹ä»¶ç›‘å¬
  self.removeAllObservers();
  
  // 3. é‡Šæ”¾å¤§å¯¹è±¡
  self.cleanup();
  
  // 4. å–æ¶ˆå®šæ—¶å™¨
  if (self.timers) {
    self.timers.forEach(timer => clearTimeout(timer));
  }
}
```

## ğŸ“¡ äº‹ä»¶ç³»ç»Ÿå®Œæ•´æŒ‡å—

### 1. äº‹ä»¶æ³¨å†Œä¸ç®¡ç†

#### ä½¿ç”¨ MNUtilï¼ˆæ¨èï¼‰
```javascript
// æ³¨å†Œäº‹ä»¶
MNUtil.addObserver(self, 'onPopupMenuOnNote:', 'PopupMenuOnNote');

// ç§»é™¤äº‹ä»¶
MNUtil.removeObserver(self, 'PopupMenuOnNote');
```


### 2. å®Œæ•´äº‹ä»¶åˆ—è¡¨

| äº‹ä»¶å | è§¦å‘æ—¶æœº | å‚æ•° | ç”¨é€” |
|--------|----------|------|------|
| AddonBroadcast | æ‰“å¼€ç‰¹å®š URL | URL ä¿¡æ¯ | æ’ä»¶é—´é€šä¿¡ |
| ProcessNewExcerpt | åˆ›å»ºæ‘˜å½• | æ‘˜å½•ä¿¡æ¯ | å¤„ç†æ–°æ‘˜å½• |
| ChangeExcerptRange | ä¿®æ”¹æ‘˜å½•èŒƒå›´ | ä¿®æ”¹ä¿¡æ¯ | åŒæ­¥æ›´æ–° |
| PopupMenuOnNote | ç‚¹å‡»ç¬”è®° | ç¬”è®°å¯¹è±¡ | æ·»åŠ èœå•é¡¹ |
| ClosePopupMenuOnNote | ç¬”è®°èœå•å…³é—­ | - | æ¸…ç†çŠ¶æ€ |
| PopupMenuOnSelection | é€‰æ‹©æ–‡æœ¬ | é€‰åŒºä¿¡æ¯ | å¤„ç†é€‰åŒº |
| ClosePopupMenuOnSelection | é€‰åŒºèœå•å…³é—­ | - | æ¸…ç†çŠ¶æ€ |
| OCRImageBegin | OCR å¼€å§‹ | å›¾ç‰‡ä¿¡æ¯ | å‡†å¤‡ OCR |
| OCRImageEnd | OCR ç»“æŸ | è¯†åˆ«ç»“æœ | å¤„ç†ç»“æœ |

### 3. äº‹ä»¶å¤„ç†ç¤ºä¾‹

#### å¤„ç†ç¬”è®°èœå•
```javascript
onPopupMenuOnNote: function(sender) {
  const note = sender.userInfo.note;
  
  // æ·»åŠ èœå•é¡¹
  MNUtil.addMenuItem({
    title: "è‡ªå®šä¹‰æ“ä½œ",
    object: self,
    selector: "customAction:",
    param: note
  });
}
```

#### å¤„ç†æ–°æ‘˜å½•
```javascript
onProcessNewExcerpt: function(sender) {
  const excerptInfo = sender.userInfo;
  
  MNUtil.undoGrouping(() => {
    // è‡ªåŠ¨å¤„ç†æ–°æ‘˜å½•
    const note = excerptInfo.note;
    if (note) {
      // æ·»åŠ æ ‡ç­¾ã€ä¿®æ”¹æ ¼å¼ç­‰
      note.appendTags(["å·²å¤„ç†"]);
    }
  });
}
```

## ğŸ¨ OhMyMN æ¡†æ¶è¯¦è§£

### æ¡†æ¶æ¦‚è¿°

OhMyMN æ˜¯ä¸€ä¸ªä¸“ä¸º MarginNote æ’ä»¶å¼€å‘è®¾è®¡çš„ç°ä»£åŒ–æ¡†æ¶ï¼Œå®ƒæå¤§åœ°é™ä½äº†æ’ä»¶å¼€å‘çš„é—¨æ§›ï¼Œæä¾›äº†ï¼š
- å®Œæ•´çš„ TypeScript ç±»å‹å®šä¹‰
- ä¼˜é›…çš„ API è®¾è®¡
- å¼ºå¤§çš„å·¥å…·å‡½æ•°åº“
- æ¨¡å—åŒ–çš„å¼€å‘æ–¹å¼
- çƒ­é‡è½½å¼€å‘ä½“éªŒ

### æ ¸å¿ƒæ¦‚å¿µ

#### 1. NodeNote vs MbBookNote

OhMyMN æä¾›äº†ä¸¤ä¸ªæ ¸å¿ƒçš„ç¬”è®°ç±»ï¼š

**MbBookNote**ï¼š
- MarginNote ä¸­æ‰€æœ‰ç¬”è®°çš„åŸºç¡€ç±»å‹
- ä¸æ˜¯æ‰€æœ‰ MbBookNote éƒ½æ˜¯å¡ç‰‡
- æä¾›åŸºç¡€çš„ç¬”è®°æ“ä½œåŠŸèƒ½

**NodeNote**ï¼š
- MbBookNote çš„å¢å¼ºç‰ˆæœ¬
- NodeNote ä¸€å®šæ˜¯ä¸€å¼ å¡ç‰‡
- æä¾›æ›´ä¸°å¯Œçš„æ“ä½œæ–¹æ³•å’Œå±æ€§è®¿é—®

```typescript
import { NodeNote, MN } from "marginnote"

// è·å–å½“å‰ç¬”è®°å¹¶è½¬æ¢ä¸º NodeNote
const focusNote = MN.focusNote
if (focusNote) {
  const node = new NodeNote(focusNote)
  
  // NodeNote æä¾›çš„å¢å¼ºåŠŸèƒ½
  const allText = node.allText  // è·å–æ‰€æœ‰æ–‡æœ¬
  const excerpts = node.excerptsText  // è·å–æ‘˜å½•æ–‡æœ¬
  const comments = node.commentsText  // è·å–è¯„è®ºæ–‡æœ¬
  
  // å±‚çº§æ“ä½œ
  const children = node.childNodes  // å­èŠ‚ç‚¹
  const parent = node.parentNode  // çˆ¶èŠ‚ç‚¹
  const descendants = node.descendantNodes  // æ‰€æœ‰åä»£èŠ‚ç‚¹
}
```

### æ ¸å¿ƒ API æ¨¡å—

#### 1. åº”ç”¨ç¨‹åºæ¥å£ (Application)

```typescript
import { MN } from "marginnote"

// åº”ç”¨ä¿¡æ¯
const version = MN.appVersion  // "4.0.2"
const build = MN.build  // "4.0.2(97)"
const isMac = MN.isMac  // æ˜¯å¦ Mac ç‰ˆæœ¬

// ä¸»é¢˜å’Œé¢œè‰²
const currentTheme = MN.currentTheme  // "Gray" | "Default" | "Dark" | "Green" | "Sepia"
const tintColor = MN.app.defaultTintColor
const textColor = MN.app.defaultTextColor

// è·¯å¾„
const dbPath = MN.app.dbPath
const docPath = MN.app.documentPath
const cachePath = MN.app.cachePath

// çª—å£å’Œæ§åˆ¶å™¨
const focusWindow = MN.app.focusWindow
const studyController = MN.studyController
```

#### 2. ç¬”è®°æ“ä½œ (Note)

```typescript
import { NodeNote, undoGroupingWithRefresh, isNoteExist } from "marginnote"

// åˆ›å»º/ä¿®æ”¹ç¬”è®°ï¼ˆæ”¯æŒæ’¤é”€ï¼‰
undoGroupingWithRefresh(() => {
  const note = new NodeNote(someNote)
  
  // åŸºç¡€å±æ€§ä¿®æ”¹
  note.noteTitle = "æ–°æ ‡é¢˜"
  note.colorIndex = 3  // é¢œè‰²ç´¢å¼• 0-15
  
  // å†…å®¹æ“ä½œ
  note.appendTitles("é¢å¤–æ ‡é¢˜")
  note.appendTags(["æ ‡ç­¾1", "æ ‡ç­¾2"])
  note.appendTextComments("æ–‡æœ¬è¯„è®º")
  
  // ç§»é™¤è¯„è®ºä½†ä¿ç•™é“¾æ¥æ ‡ç­¾
  note.removeCommentButLinkTag()
  
  // æ•´ç†æ ‡ç­¾
  note.tidyupTags()
})

// æ£€æŸ¥ç¬”è®°æ˜¯å¦å­˜åœ¨
if (isNoteExist(noteId)) {
  // ç¬”è®°å­˜åœ¨
}
```

#### 3. å¼¹çª—å’Œç”¨æˆ·äº¤äº’ (Popup)

```typescript
import { popup, showHUD, alert, confirm, select } from "marginnote"

// æ˜¾ç¤ºä¸´æ—¶æç¤º
showHUD("æ“ä½œæˆåŠŸ", 2)  // æ˜¾ç¤º2ç§’

// ç®€å•æç¤º
alert("è¿™æ˜¯ä¸€ä¸ªæç¤º")

// ç¡®è®¤å¯¹è¯æ¡†
const confirmed = await confirm("ç¡®å®šè¦æ‰§è¡Œæ­¤æ“ä½œå—ï¼Ÿ")

// é€‰æ‹©åˆ—è¡¨
const selected = await select(
  ["é€‰é¡¹1", "é€‰é¡¹2", "é€‰é¡¹3"],
  ["value1", "value2", "value3"],
  0  // é»˜è®¤é€‰ä¸­ç´¢å¼•
)

// é«˜çº§å¼¹çª—
const result = await popup({
  title: "è¾“å…¥ä¿¡æ¯",
  message: "è¯·è¾“å…¥æ‚¨çš„åå­—ï¼š",
  type: PopupType.Input,
  buttons: ["ç¡®å®š", "å–æ¶ˆ"],
  defaultValue: "é»˜è®¤å€¼"
})
```

#### 4. ç½‘ç»œè¯·æ±‚ (Fetch)

```typescript
import { fetch } from "marginnote"

// GET è¯·æ±‚
const data = await fetch("https://api.example.com/data")
  .then(res => res.json())

// POST è¯·æ±‚ (JSON)
const response = await fetch("https://api.example.com/submit", {
  method: "POST",
  headers: {
    "Authorization": "Bearer token"
  },
  json: {
    name: "test",
    value: 123
  }
})

// POST è¯·æ±‚ (Form)
const formResponse = await fetch("https://api.example.com/form", {
  method: "POST",
  form: {
    field1: "value1",
    field2: "value2"
  }
})
```

#### 5. æ–‡ä»¶æ“ä½œ (File)

```typescript
import { 
  isfileExists, 
  copyFile, 
  writeTextFile, 
  readJSON, 
  writeJSON,
  MN
} from "marginnote"

// æ–‡ä»¶è·¯å¾„
const cachePath = MN.app.cachePath
const tempPath = MN.app.tempPath
const addonPath = Addon.path

// æ£€æŸ¥æ–‡ä»¶
if (isfileExists(filePath)) {
  // æ–‡ä»¶å­˜åœ¨
}

// è¯»å†™ JSON
const config = readJSON(configPath) || {}
config.version = "1.0.0"
writeJSON(configPath, config)

// å†™å…¥æ–‡æœ¬æ–‡ä»¶
writeTextFile(logPath, "æ—¥å¿—å†…å®¹")

// å¤åˆ¶æ–‡ä»¶
const success = copyFile(sourcePath, destPath)
```

#### 6. å»¶æ—¶å’Œå®šæ—¶å™¨ (Delay)

```typescript
import { delay, loopBreak, setTimeInterval } from "marginnote"

// ç­‰å¾… 1 ç§’
await delay(1)

// æ¡ä»¶è½®è¯¢ï¼ˆæœ€å¤šå°è¯• 10 æ¬¡ï¼Œæ¯æ¬¡é—´éš” 0.5 ç§’ï¼‰
const success = await loopBreak(10, 0.5, () => {
  return someCondition === true
})

// å®šæ—¶æ‰§è¡Œ
const timer = setTimeInterval(2, () => {
  console.log("æ¯2ç§’æ‰§è¡Œä¸€æ¬¡")
})

// åœæ­¢å®šæ—¶å™¨
timer.invalidate()
```

#### 7. å…¶ä»–å®ç”¨å·¥å…·

```typescript
import { 
  getLocalDataByKey, 
  setLocalDataByKey,
  copy,
  openURL,
  postNotification
} from "marginnote"

// æœ¬åœ°æ•°æ®å­˜å‚¨
setLocalDataByKey({ name: "test" }, "config")
const config = getLocalDataByKey("config")

// å¤åˆ¶åˆ°å‰ªè´´æ¿
copy("è¦å¤åˆ¶çš„æ–‡æœ¬", true)  // ç¬¬äºŒä¸ªå‚æ•°ä¸ºæ˜¯å¦æ˜¾ç¤º HUD

// æ‰“å¼€ URL
openURL("https://marginnote.com")

// å‘é€é€šçŸ¥ï¼ˆç”¨äºæ’ä»¶é—´é€šä¿¡ï¼‰
postNotification("CustomEvent", { data: "some data" })
```

### å¼€å‘å·¥å…·å‡½æ•°

#### 1. ç”Ÿå‘½å‘¨æœŸè¾…åŠ©

```typescript
import { defineLifecycleHandlers } from "marginnote"

// è·å–ç±»å‹å®‰å…¨çš„ç”Ÿå‘½å‘¨æœŸæ–¹æ³•
const handlers = defineLifecycleHandlers({
  instanceMethods: {
    sceneWillConnect() {
      // åˆå§‹åŒ–
    },
    notebookWillOpen(notebookId: string) {
      // ç¬”è®°æœ¬æ‰“å¼€
    }
  },
  classMethods: {
    addonDidConnect() {
      // æ’ä»¶å®‰è£…
    }
  }
})
```

#### 2. äº‹ä»¶å¤„ç†è¾…åŠ©

```typescript
import { defineEventHandlers, eventObserverController } from "marginnote"

// å®šä¹‰äº‹ä»¶å¤„ç†å™¨
const eventHandlers = defineEventHandlers({
  onProcessNewExcerpt(excerptInfo) {
    // å¤„ç†æ–°æ‘˜å½•
  },
  onPopupMenuOnNote({ note }) {
    // ç¬”è®°èœå•
  }
})

// äº‹ä»¶è§‚å¯Ÿè€…æ§åˆ¶å™¨
const observer = eventObserverController([
  "ProcessNewExcerpt",
  "PopupMenuOnNote"
])

// æ·»åŠ æ‰€æœ‰äº‹ä»¶
observer.add()

// ç§»é™¤æ‰€æœ‰äº‹ä»¶
observer.remove()
```

#### 3. å›½é™…åŒ–æ”¯æŒ

```typescript
import { i18n } from "marginnote"

// å®šä¹‰å¤šè¯­è¨€æ–‡æœ¬
const lang = i18n({
  zh: {
    title: "æ ‡é¢˜",
    confirm: "ç¡®å®š",
    cancel: "å–æ¶ˆ"
  },
  en: {
    title: "Title", 
    confirm: "OK",
    cancel: "Cancel"
  }
})

// è‡ªåŠ¨æ ¹æ®ç³»ç»Ÿè¯­è¨€é€‰æ‹©
console.log(lang.title)  // ä¸­æ–‡ç³»ç»Ÿæ˜¾ç¤º"æ ‡é¢˜"ï¼Œè‹±æ–‡ç³»ç»Ÿæ˜¾ç¤º"Title"
```

### OhMyMN æ¨¡å—å¼€å‘

OhMyMN æ”¯æŒæ¨¡å—åŒ–å¼€å‘ï¼Œè®©ä½ å¯ä»¥åˆ›å»ºå¯å¤ç”¨çš„åŠŸèƒ½æ¨¡å—ï¼š

```typescript
// å®šä¹‰æ¨¡å—
export default {
  name: "MyModule",
  title: "æˆ‘çš„æ¨¡å—",
  settings: [
    {
      key: "enable",
      type: SettingType.Switch,
      label: "å¯ç”¨æ¨¡å—"
    }
  ],
  actions: [
    {
      title: "æ‰§è¡Œæ“ä½œ",
      handler: async () => {
        // æ“ä½œé€»è¾‘
      }
    }
  ],
  lifecycle: {
    onLoad() {
      // æ¨¡å—åŠ è½½
    },
    onUnload() {
      // æ¨¡å—å¸è½½
    }
  }
}
```

### Lite æ’ä»¶å¼€å‘

å¯¹äºç®€å•åŠŸèƒ½ï¼Œå¯ä»¥ä½¿ç”¨ OhMyMN Lite æ¨¡å¼å¼€å‘ï¼š

```typescript
// 200 è¡Œå·¦å³çš„ç®€å•æ’ä»¶
import { JSB, MN, showHUD } from "marginnote"

JSB.newAddon = () => {
  return JSB.defineClass("SimplPlugin : JSExtension", {
    sceneWillConnect() {
      // åˆå§‹åŒ–
      showHUD("æ’ä»¶å·²åŠ è½½")
    },
    
    queryAddonCommandStatus() {
      return {
        image: "logo.png",
        object: this,
        selector: "toggle:",
        checked: false
      }
    },
    
    toggle() {
      showHUD("Hello from Lite Plugin!")
    }
  })
}
```

### æœ€ä½³å®è·µ

1. **ç±»å‹å®‰å…¨**ï¼šå……åˆ†åˆ©ç”¨ TypeScript çš„ç±»å‹ç³»ç»Ÿ
2. **é”™è¯¯å¤„ç†**ï¼šä½¿ç”¨ try-catch åŒ…è£…å¯èƒ½å‡ºé”™çš„æ“ä½œ
3. **æ€§èƒ½ä¼˜åŒ–**ï¼šé¿å…åœ¨å¾ªç¯ä¸­è¿›è¡Œé¢‘ç¹çš„ API è°ƒç”¨
4. **æ¨¡å—åŒ–**ï¼šå°†åŠŸèƒ½æ‹†åˆ†ä¸ºç‹¬ç«‹çš„æ¨¡å—
5. **å›½é™…åŒ–**ï¼šä½¿ç”¨ i18n æ”¯æŒå¤šè¯­è¨€

## ğŸ“ æœ€ä½³å®è·µ

1. **éµå¾ª MN è®¾è®¡ç†å¿µ**
   - ä»¥å­¦ä¹ ä¸ºä¸­å¿ƒ
   - å¼ºè°ƒçŸ¥è¯†ç®¡ç†
   - æ³¨é‡æ•ˆç‡

2. **æ’ä»¶åŠŸèƒ½å®šä½**
   - å¢å¼ºè€Œéæ›¿ä»£
   - ä¸“æ³¨ç‰¹å®šåœºæ™¯
   - ä¿æŒç®€æ´

3. **æ•°æ®å®‰å…¨**
   - æ“ä½œå‰å¤‡ä»½
   - éªŒè¯ç”¨æˆ·è¾“å…¥
   - å¤„ç†å¼‚å¸¸æƒ…å†µ

4. **æ€§èƒ½ä¼˜åŒ–**
   - æ‡’åŠ è½½èµ„æº
   - å¼‚æ­¥å¤„ç†ä»»åŠ¡
   - åŠæ—¶é‡Šæ”¾å†…å­˜

5. **ç”¨æˆ·åé¦ˆ**
   - æ¸…æ™°çš„æ“ä½œæç¤º
   - è¿›åº¦æ˜¾ç¤º
   - é”™è¯¯è¯´æ˜

## ğŸ“– å®˜æ–¹ API å‚è€ƒ

### æ ¸å¿ƒç±»å±‚æ¬¡ç»“æ„

```
JSExtension (æ’ä»¶åŸºç±»)
â”œâ”€â”€ Application (åº”ç”¨ç®¡ç†)
â”‚   â”œâ”€â”€ JSBApplication
â”‚   â””â”€â”€ JSBDocumentController
â”œâ”€â”€ Notebook (ç¬”è®°æœ¬ç®¡ç†)
â”‚   â”œâ”€â”€ JSBNotebookController
â”‚   â”œâ”€â”€ JSBMindMapView
â”‚   â””â”€â”€ JSBOutlineView
â”œâ”€â”€ Database (æ•°æ®ç®¡ç†)
â”‚   â”œâ”€â”€ JSBMbTopic (ç¬”è®°æœ¬)
â”‚   â”œâ”€â”€ JSBMbBookNote (ç¬”è®°)
â”‚   â”œâ”€â”€ JSBMbBook (æ–‡æ¡£)
â”‚   â””â”€â”€ JSBMbModelTool (å·¥å…·)
â””â”€â”€ UI Components (ç•Œé¢ç»„ä»¶)
    â”œâ”€â”€ UIView
    â”œâ”€â”€ UIButton
    â”œâ”€â”€ UIColor
    â””â”€â”€ UIImage
```

### JSBApplication API

| å±æ€§/æ–¹æ³• | ç±»å‹ | è¯´æ˜ |
|-----------|------|------|
| **å±æ€§** |
| currentTheme | String | å½“å‰ä¸»é¢˜ ("Gray", "Default", "Dark", "Green", "Sepia") |
| defaultTintColor | UIColor | é»˜è®¤ä¸»é¢˜è‰² |
| defaultTextColor | UIColor | é»˜è®¤æ–‡æœ¬é¢œè‰² |
| defaultBookPageColor | UIColor | é»˜è®¤ä¹¦é¡µé¢œè‰² |
| defaultNotebookColor | UIColor | é»˜è®¤ç¬”è®°æœ¬é¢œè‰² |
| dbPath | String | æ•°æ®åº“è·¯å¾„ |
| documentPath | String | æ–‡æ¡£è·¯å¾„ |
| cachePath | String | ç¼“å­˜è·¯å¾„ |
| osType | Integer | ç³»ç»Ÿç±»å‹ (0: iPadOS, 1: iPhoneOS, 2: macOS) |
| **æ–¹æ³•** |
| sharedInstance() | JSBApplication | è·å–åº”ç”¨å®ä¾‹ |
| showHUD(message, view, duration) | void | æ˜¾ç¤ºæç¤ºä¿¡æ¯ |
| alert(message) | void | æ˜¾ç¤ºè­¦å‘Šæ¡† |
| openURL(url) | void | æ‰“å¼€ URL |
| refreshAfterDBChanged(topicId) | void | åˆ·æ–°æ•°æ®åº“ |

### JSBMbBookNote API

| å±æ€§/æ–¹æ³• | ç±»å‹ | è¯»å†™ | è¯´æ˜ |
|-----------|------|------|------|
| **åŸºæœ¬å±æ€§** |
| noteId | String | åªè¯» | ç¬”è®°å”¯ä¸€æ ‡è¯† |
| noteTitle | String | è¯»å†™ | ç¬”è®°æ ‡é¢˜ |
| excerptText | String | è¯»å†™ | æ‘˜å½•æ–‡æœ¬ |
| colorIndex | Integer | è¯»å†™ | é¢œè‰²ç´¢å¼• (0-15) |
| fillIndex | Integer | è¯»å†™ | å¡«å……æ ·å¼ç´¢å¼• |
| mindmapPosition | CGPoint | è¯»å†™ | è„‘å›¾ä½ç½® |
| **å…³è”å±æ€§** |
| notebookId | String | åªè¯» | æ‰€å±ç¬”è®°æœ¬ ID |
| docMd5 | String | åªè¯» | æ‰€å±æ–‡æ¡£ MD5 |
| startPage | Integer | åªè¯» | èµ·å§‹é¡µç  |
| endPage | Integer | åªè¯» | ç»“æŸé¡µç  |
| **æ—¶é—´å±æ€§** |
| createDate | Date | åªè¯» | åˆ›å»ºæ—¶é—´ |
| modifiedDate | Date | åªè¯» | ä¿®æ”¹æ—¶é—´ |
| **å…³ç³»å±æ€§** |
| parentNote | MbBookNote | åªè¯» | çˆ¶ç¬”è®° |
| childNotes | Array | åªè¯» | å­ç¬”è®°æ•°ç»„ |
| linkedNotes | Array | åªè¯» | é“¾æ¥çš„ç¬”è®° |
| comments | Array | åªè¯» | è¯„è®ºæ•°ç»„ |
| **æ–¹æ³•** |
| createWithTitle(title) | MbBookNote | åˆ›å»ºæ–°ç¬”è®° |
| appendTextComment(text) | void | æ·»åŠ æ–‡æœ¬è¯„è®º |
| appendHtmlComment(html, text, size, tag) | void | æ·»åŠ  HTML è¯„è®º |
| appendNoteLink(note, text) | void | æ·»åŠ ç¬”è®°é“¾æ¥ |
| removeCommentByIndex(index) | void | åˆ é™¤è¯„è®º |
| paste() | void | ç²˜è´´å†…å®¹ |
| clearFormat() | void | æ¸…é™¤æ ¼å¼ |
| merge(note) | void | åˆå¹¶ç¬”è®° |

### JSBDocumentController API

| å±æ€§/æ–¹æ³• | ç±»å‹ | è¯´æ˜ |
|-----------|------|------|
| **å±æ€§** |
| document | JSBMbBook | å½“å‰æ–‡æ¡£å¯¹è±¡ |
| currentPage | Integer | å½“å‰é¡µç  |
| selectionsByIndex | Array | é€‰ä¸­å†…å®¹æ•°ç»„ |
| **æ–¹æ³•** |
| gotoPage(pageIndex) | void | è·³è½¬åˆ°æŒ‡å®šé¡µ |
| search(keyword) | Array | æœç´¢å…³é”®è¯ |
| highlightSelection(selection) | void | é«˜äº®é€‰ä¸­å†…å®¹ |

### JSBNotebookController API

| å±æ€§/æ–¹æ³• | ç±»å‹ | è¯´æ˜ |
|-----------|------|------|
| **å±æ€§** |
| notebook | JSBMbTopic | å½“å‰ç¬”è®°æœ¬ |
| mindmapView | JSBMindMapView | è„‘å›¾è§†å›¾ |
| outlineView | JSBOutlineView | å¤§çº²è§†å›¾ |
| **æ–¹æ³•** |
| focusNote(noteId) | void | èšç„¦åˆ°æŒ‡å®šç¬”è®° |
| refreshView() | void | åˆ·æ–°è§†å›¾ |

### äº‹ä»¶å›è°ƒ API

```javascript
// ç¬”è®°èœå•äº‹ä»¶
onPopupMenuOnNote: function(sender) {
  // sender.userInfo.note - å½“å‰ç¬”è®°å¯¹è±¡
  // sender.userInfo.documentController - æ–‡æ¡£æ§åˆ¶å™¨
}

// é€‰æ‹©åŒºåŸŸèœå•äº‹ä»¶
onPopupMenuOnSelection: function(sender) {
  // sender.userInfo.documentController - æ–‡æ¡£æ§åˆ¶å™¨
  // sender.userInfo.selection - é€‰ä¸­å†…å®¹
}

// æ–°æ‘˜å½•äº‹ä»¶
onProcessNewExcerpt: function(sender) {
  // sender.userInfo.note - æ–°åˆ›å»ºçš„ç¬”è®°
  // sender.userInfo.excerptText - æ‘˜å½•æ–‡æœ¬
}

// OCR äº‹ä»¶
onOCRImageBegin: function(sender) {
  // sender.userInfo.imageData - å›¾ç‰‡æ•°æ®
}

onOCRImageEnd: function(sender) {
  // sender.userInfo.text - è¯†åˆ«ç»“æœ
}
```

### é¢œè‰²ç´¢å¼•å‚è€ƒ

| ç´¢å¼• | é¢œè‰² | ç´¢å¼• | é¢œè‰² |
|------|------|------|------|
| 0 | æ·¡é»„è‰² | 8 | æ©™è‰² |
| 1 | æ·¡ç»¿è‰² | 9 | æ·±ç»¿è‰² |
| 2 | æ·¡è“è‰² | 10 | æ·±è“è‰² |
| 3 | æ·¡çº¢è‰² | 11 | æ·±çº¢è‰² |
| 4 | é»„è‰² | 12 | ç™½è‰² |
| 5 | ç»¿è‰² | 13 | æ·¡ç°è‰² |
| 6 | è“è‰² | 14 | æ·±ç°è‰² |
| 7 | çº¢è‰² | 15 | ç´«è‰² |

## ğŸš€ å¸¸è§æ’ä»¶ç±»å‹

1. **ç¬”è®°å¤„ç†ç±»**
   - æ‰¹é‡æ•´ç†
   - æ ¼å¼è½¬æ¢
   - å†…å®¹å¢å¼º

2. **å­¦ä¹ è¾…åŠ©ç±»**
   - å¤ä¹ è®¡åˆ’
   - çŸ¥è¯†æµ‹è¯•
   - å­¦ä¹ ç»Ÿè®¡

3. **å¯¼å…¥å¯¼å‡ºç±»**
   - ç¬¬ä¸‰æ–¹æ ¼å¼æ”¯æŒ
   - æ•°æ®è¿ç§»
   - å¤‡ä»½ç®¡ç†

4. **ç•Œé¢å¢å¼ºç±»**
   - å¿«æ·æ“ä½œ
   - è§†å›¾å®šåˆ¶
   - ä¸»é¢˜ç¾åŒ–

5. **é›†æˆç±»**
   - å¤–éƒ¨æœåŠ¡è¿æ¥
   - API é›†æˆ
   - äº‘åŒæ­¥

## ğŸ’¡ å¼€å‘è§„èŒƒä¸æ ‡å‡†

### 1. ä»£ç ç»„ç»‡è§„èŒƒ

#### æ–‡ä»¶ç»“æ„
```
plugin/
â”œâ”€â”€ main.js              # ä¸»å…¥å£æ–‡ä»¶
â”œâ”€â”€ mnaddon.json         # æ’ä»¶é…ç½®
â”œâ”€â”€ logo.png            # 44x44 å›¾æ ‡
â”œâ”€â”€ controllers/        # æ§åˆ¶å™¨
â”‚   â”œâ”€â”€ mainController.js
â”‚   â””â”€â”€ settingController.js
â”œâ”€â”€ models/            # æ•°æ®æ¨¡å‹
â”‚   â””â”€â”€ dataModel.js
â”œâ”€â”€ utils/             # å·¥å…·å‡½æ•°
â”‚   â””â”€â”€ helpers.js
â””â”€â”€ resources/         # èµ„æºæ–‡ä»¶
    â”œâ”€â”€ html/
    â”œâ”€â”€ css/
    â””â”€â”€ images/
```

#### å‘½åè§„èŒƒ
```javascript
// ç±»åï¼šPascalCase
class TaskManager {}
JSB.defineClass("TaskManager : NSObject", {})

// æ–¹æ³•åï¼šcamelCase
function createTask() {}
createTask: function() {}

// å¸¸é‡ï¼šUPPER_SNAKE_CASE
const MAX_RETRY_COUNT = 3;

// ç§æœ‰å±æ€§ï¼šä¸‹åˆ’çº¿å‰ç¼€
this._privateData = [];
```

### 2. é”™è¯¯å¤„ç†è§„èŒƒ

#### åŸºç¡€é”™è¯¯å¤„ç†
```javascript
function safeExecute(fn, context) {
  try {
    return fn.call(context);
  } catch (error) {
    // è®°å½•é”™è¯¯
    if (typeof MNUtil !== "undefined" && MNUtil.addErrorLog) {
      MNUtil.addErrorLog(error, fn.name, context);
    }
    
    // ç”¨æˆ·æç¤º
    if (typeof MNUtil !== "undefined" && MNUtil.showHUD) {
      MNUtil.showHUD("æ“ä½œå¤±è´¥: " + error.message);
    }
    
    // è¿”å›é»˜è®¤å€¼
    return null;
  }
}
```

#### å¼‚æ­¥é”™è¯¯å¤„ç†
```javascript
async function asyncOperation() {
  try {
    // æ˜¾ç¤ºè¿›åº¦
    MNUtil.showHUD("å¤„ç†ä¸­...");
    
    // æ‰§è¡Œæ“ä½œ
    const result = await someAsyncTask();
    
    // æˆåŠŸæç¤º
    MNUtil.showHUD("âœ… å®Œæˆ");
    return result;
  } catch (error) {
    // é”™è¯¯æ¢å¤
    await this.recoverFromError(error);
    
    // é”™è¯¯æç¤º
    MNUtil.showHUD("âŒ " + error.message);
    throw error;
  }
}
```

### 3. æ€§èƒ½ä¼˜åŒ–è§„èŒƒ

#### é˜²æŠ–ä¸èŠ‚æµ
```javascript
// é˜²æŠ–å®ç°
function debounce(func, wait) {
  let timeout;
  return function executedFunction(...args) {
    const later = () => {
      clearTimeout(timeout);
      func(...args);
    };
    clearTimeout(timeout);
    timeout = setTimeout(later, wait);
  };
}

// ä½¿ç”¨ç¤ºä¾‹
this.search = debounce(this.performSearch, 300);
```

#### æ‰¹é‡æ“ä½œ
```javascript
// ä½¿ç”¨ undoGrouping æ‰¹é‡æ“ä½œ
MNUtil.undoGrouping(() => {
  notes.forEach(note => {
    note.noteTitle = processTitle(note.noteTitle);
    note.colorIndex = 2;
  });
});
```

#### å†…å­˜ç®¡ç†
```javascript
// åŠæ—¶é‡Šæ”¾å¤§å¯¹è±¡
cleanupLargeData: function() {
  this.largeArray = null;
  this.cacheData = {};
  
  // å¼ºåˆ¶åƒåœ¾å›æ”¶ï¼ˆå¦‚æœå¯ç”¨ï¼‰
  if (global.gc) {
    global.gc();
  }
}
```

## ğŸš€ å¼€å‘æµç¨‹æŒ‡å—

### 1. å¼€å‘ç¯å¢ƒæ­å»º

#### é€šç”¨å¿…éœ€å·¥å…·
- **Mac ç”µè„‘**ï¼šå¼€å‘å’Œè°ƒè¯•å¿…éœ€
- **MarginNote 4**ï¼šMac ç‰ˆæœ¬ç”¨äºæµ‹è¯•
- **ä»£ç ç¼–è¾‘å™¨**ï¼šæ¨è VSCode
- **Node.js**ï¼šv18+ (ç”¨äºå·¥å…·é“¾)

#### OhMyMN å¼€å‘ç¯å¢ƒ
```bash
# å®‰è£… Node.js å’Œ pnpm
brew install node
npm install -g pnpm

# åˆ›å»º OhMyMN é¡¹ç›®
pnpm create ohmymn

# é€‰æ‹©é¡¹ç›®ç±»å‹
# ? Select a project type:
# > OhMyMN Plugin (å®Œæ•´æ’ä»¶)
# > OhMyMN Module (æ¨¡å—å¼€å‘)
# > Lite Plugin (è½»é‡æ’ä»¶)

# å®‰è£…ä¾èµ–
cd my-ohmymn-plugin
pnpm install

# å¯åŠ¨å¼€å‘æœåŠ¡å™¨ï¼ˆæ”¯æŒçƒ­é‡è½½ï¼‰
pnpm dev

# æ„å»ºæ’ä»¶
pnpm build
```

#### MNUtils/ä¼ ç»Ÿå¼€å‘ç¯å¢ƒ
```bash
# å®‰è£… mnaddon CLI å·¥å…·
npm install -g mnaddon

# åˆ›å»ºæ’ä»¶é¡¹ç›®
mnaddon create my-plugin
cd my-plugin

# æˆ–æ‰‹åŠ¨åˆ›å»º
mkdir my-plugin
cd my-plugin
npm init -y

# åŸºç¡€æ–‡ä»¶ç»“æ„
touch main.js
touch mnaddon.json
# æ·»åŠ  44x44 çš„ logo.png
```

### 2. VSCode é…ç½®ä¼˜åŒ–

#### æ¨èæ‰©å±•
```json
{
  "recommendations": [
    "dbaeumer.vscode-eslint",
    "esbenp.prettier-vscode",
    "ms-vscode.vscode-typescript-next",
    "marginnote.marginnote-api"
  ]
}
```

#### TypeScript é…ç½® (OhMyMN)
```json
// tsconfig.json
{
  "compilerOptions": {
    "target": "ES2020",
    "module": "ESNext",
    "lib": ["ES2020"],
    "moduleResolution": "node",
    "strict": true,
    "esModuleInterop": true,
    "skipLibCheck": true,
    "forceConsistentCasingInFileNames": true,
    "types": ["@marginnote/api"]
  },
  "include": ["src/**/*"],
  "exclude": ["node_modules"]
}
```

#### ä»£ç ç‰‡æ®µ (Code Snippets)
```json
// .vscode/marginnote.code-snippets
{
  "OhMyMN Plugin Template": {
    "prefix": "ohmymn",
    "body": [
      "import { JSB, MN, showHUD } from 'marginnote'",
      "",
      "JSB.newAddon = () => {",
      "  return JSB.defineClass('${1:PluginName} : JSExtension', {",
      "    sceneWillConnect() {",
      "      showHUD('${1:PluginName} loaded', 2)",
      "      $0",
      "    },",
      "    ",
      "    queryAddonCommandStatus() {",
      "      return {",
      "        image: 'logo.png',",
      "        object: this,",
      "        selector: 'toggle:',",
      "        checked: false",
      "      }",
      "    },",
      "    ",
      "    toggle() {",
      "      // Your code here",
      "    }",
      "  })",
      "}"
    ]
  }
}
```

### 3. å¼€å‘å·¥ä½œæµ

#### OhMyMN çƒ­é‡è½½å¼€å‘æµç¨‹

```bash
# 1. å¯åŠ¨å¼€å‘æœåŠ¡å™¨
pnpm dev

# 2. è‡ªåŠ¨ç›‘å¬æ–‡ä»¶å˜åŒ–å¹¶é‡æ–°ç¼–è¯‘
# 3. åœ¨ MarginNote ä¸­åˆ·æ–°æ’ä»¶å³å¯çœ‹åˆ°æ›´æ–°
# 4. ä½¿ç”¨æµè§ˆå™¨æ§åˆ¶å°æŸ¥çœ‹æ—¥å¿—
```

**çƒ­é‡è½½ç‰¹æ€§**ï¼š
- è‡ªåŠ¨ç¼–è¯‘ TypeScript
- å®æ—¶æ›´æ–°æ’ä»¶ä»£ç 
- ä¿ç•™æ’ä»¶çŠ¶æ€
- å¿«é€Ÿè¿­ä»£å¼€å‘

#### ä¼ ç»Ÿå¼€å‘æµç¨‹

```bash
# 1. ç¼–å†™ä»£ç 
# 2. æ‰“åŒ…æ’ä»¶
mnaddon pack .

# 3. å®‰è£…åˆ° MarginNote
# macOS è·¯å¾„
cp my-plugin.mnaddon ~/Library/Containers/QReader.MarginNoteMac/Data/Library/MarginNote\ 4/Extensions/

# 4. é‡å¯ MarginNote æµ‹è¯•
```

### 4. è°ƒè¯•æŠ€å·§è¿›é˜¶

#### OhMyMN è°ƒè¯•æ–¹æ³•

```typescript
import { MN, showHUD, HUDController } from "marginnote"

// 1. æ§åˆ¶å°æ—¥å¿—ï¼ˆæ¨èï¼‰
MN.log("Debug info", { data: someData })
MN.error("Error occurred", error)

// 2. HUD è°ƒè¯•ä¿¡æ¯
const hud = HUDController()
hud.show("Processing...")
// æ‰§è¡Œæ“ä½œ
hud.hidden("Complete!")

// 3. æ¡ä»¶æ–­ç‚¹
if (MN.dev) {  // å¼€å‘æ¨¡å¼
  debugger  // æµè§ˆå™¨ä¼šåœ¨æ­¤æš‚åœ
}

// 4. æ€§èƒ½åˆ†æ
console.time("operation")
// æ‰§è¡Œæ“ä½œ
console.timeEnd("operation")
```

#### Safari Web Inspector è°ƒè¯•

1. **å¯ç”¨å¼€å‘è€…æ¨¡å¼**
   - Safari â†’ åå¥½è®¾ç½® â†’ é«˜çº§ â†’ å‹¾é€‰"åœ¨èœå•æ ä¸­æ˜¾ç¤ºå¼€å‘èœå•"

2. **è¿æ¥ MarginNote**
   - æ‰“å¼€ MarginNote 4
   - Safari â†’ å¼€å‘ â†’ [ä½ çš„è®¾å¤‡] â†’ MarginNote
   - é€‰æ‹©å¯¹åº”çš„ WebView

3. **è°ƒè¯•åŠŸèƒ½**
   - è®¾ç½®æ–­ç‚¹
   - æŸ¥çœ‹å˜é‡
   - æ‰§è¡Œè¡¨è¾¾å¼
   - æ€§èƒ½åˆ†æ

#### é«˜çº§è°ƒè¯•æŠ€å·§

```typescript
// 1. è‡ªå®šä¹‰è°ƒè¯•ç±»
class Debugger {
  private enabled = MN.dev
  
  log(category: string, ...args: any[]) {
    if (!this.enabled) return
    
    const timestamp = new Date().toISOString()
    const prefix = `[${category}] ${timestamp}:`
    
    console.group(prefix)
    console.log(...args)
    console.trace()
    console.groupEnd()
  }
  
  time(label: string, fn: () => any) {
    if (!this.enabled) return fn()
    
    console.time(label)
    const result = fn()
    console.timeEnd(label)
    return result
  }
  
  async timeAsync(label: string, fn: () => Promise<any>) {
    if (!this.enabled) return fn()
    
    console.time(label)
    const result = await fn()
    console.timeEnd(label)
    return result
  }
}

const debug = new Debugger()

// ä½¿ç”¨
debug.log("NoteProcess", "Processing note", note)
const result = debug.time("Database Query", () => {
  return queryDatabase()
})
```

```typescript
// 2. é”™è¯¯è¾¹ç•Œ
function withErrorBoundary<T extends (...args: any[]) => any>(
  fn: T,
  errorHandler?: (error: Error) => void
): T {
  return ((...args: Parameters<T>) => {
    try {
      const result = fn(...args)
      if (result instanceof Promise) {
        return result.catch(error => {
          MN.error("Async error", error)
          errorHandler?.(error)
          showHUD(`é”™è¯¯: ${error.message}`, 3)
        })
      }
      return result
    } catch (error) {
      MN.error("Sync error", error)
      errorHandler?.(error)
      showHUD(`é”™è¯¯: ${error.message}`, 3)
    }
  }) as T
}

// ä½¿ç”¨
const safeProcess = withErrorBoundary(processNote)
```

```typescript
// 3. çŠ¶æ€ç›‘æ§
class StateMonitor {
  private states = new Map<string, any>()
  
  track(key: string, value: any) {
    const oldValue = this.states.get(key)
    this.states.set(key, value)
    
    if (MN.dev && oldValue !== value) {
      console.log(`State Change: ${key}`, {
        old: oldValue,
        new: value,
        stack: new Error().stack
      })
    }
  }
  
  snapshot() {
    return Object.fromEntries(this.states)
  }
}
```

### 5. æœ€ä½³å®è·µå·¥ä½œæµ

#### é¡¹ç›®ç»“æ„ï¼ˆOhMyMNï¼‰
```
my-ohmymn-plugin/
â”œâ”€â”€ src/
â”‚   â”œâ”€â”€ main.ts          # å…¥å£æ–‡ä»¶
â”‚   â”œâ”€â”€ modules/         # åŠŸèƒ½æ¨¡å—
â”‚   â”œâ”€â”€ utils/           # å·¥å…·å‡½æ•°
â”‚   â””â”€â”€ types/           # ç±»å‹å®šä¹‰
â”œâ”€â”€ assets/
â”‚   â””â”€â”€ logo.png         # æ’ä»¶å›¾æ ‡
â”œâ”€â”€ package.json
â”œâ”€â”€ tsconfig.json
â”œâ”€â”€ .gitignore
â””â”€â”€ README.md
```

#### Git å·¥ä½œæµ
```bash
# 1. åˆå§‹åŒ–ä»“åº“
git init
git add .
git commit -m "Initial commit"

# 2. åŠŸèƒ½åˆ†æ”¯å¼€å‘
git checkout -b feature/note-processing
# å¼€å‘åŠŸèƒ½
git add .
git commit -m "Add note processing feature"

# 3. ç‰ˆæœ¬æ ‡ç­¾
git tag v1.0.0
git push origin v1.0.0
```

#### æŒç»­é›†æˆé…ç½®
```yaml
# .github/workflows/build.yml
name: Build and Release

on:
  push:
    tags:
      - 'v*'

jobs:
  build:
    runs-on: macos-latest
    steps:
      - uses: actions/checkout@v3
      
      - uses: pnpm/action-setup@v2
        with:
          version: 8
          
      - uses: actions/setup-node@v3
        with:
          node-version: 18
          cache: 'pnpm'
          
      - run: pnpm install
      - run: pnpm build
      
      - uses: softprops/action-gh-release@v1
        with:
          files: dist/*.mnaddon
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
```

### 3. è°ƒè¯•æŠ€å·§

#### Safari è¿œç¨‹è°ƒè¯•
1. åœ¨ Mac Safari ä¸­å¯ç”¨å¼€å‘èœå•
2. åœ¨ iOS è®¾å¤‡è®¾ç½®ä¸­å¯ç”¨ Web æ£€æŸ¥å™¨
3. è¿æ¥è®¾å¤‡ï¼Œåœ¨ Safari å¼€å‘èœå•ä¸­é€‰æ‹©è®¾å¤‡
4. æ‰“å¼€ MarginNoteï¼Œé€‰æ‹©å¯¹åº”çš„ WebView

#### æ—¥å¿—ç³»ç»Ÿ
```javascript
// å¼€å‘ç¯å¢ƒæ—¥å¿—ç±»
class Logger {
  constructor(prefix) {
    this.prefix = prefix;
    this.enabled = true;
  }
  
  log(...args) {
    if (!this.enabled) return;
    
    const timestamp = new Date().toISOString();
    const message = `[${this.prefix}] ${timestamp}:`;
    
    // æ§åˆ¶å°è¾“å‡º
    console.log(message, ...args);
    
    // MNUtil æ—¥å¿—
    if (typeof MNUtil !== "undefined" && MNUtil.log) {
      MNUtil.log(`${message} ${args.join(' ')}`);
    }
  }
  
  error(error, context) {
    this.log('ERROR:', error.message, error.stack);
    
    if (typeof MNUtil !== "undefined" && MNUtil.addErrorLog) {
      MNUtil.addErrorLog(error, context.method, context.data);
    }
  }
}

// ä½¿ç”¨ç¤ºä¾‹
const logger = new Logger('MyPlugin');
logger.log('Plugin initialized');
```

## ğŸ“˜ å®æˆ˜å¼€å‘æŒ‡å—

æœ¬èŠ‚é€šè¿‡å®é™…æ¡ˆä¾‹å±•ç¤ºå¦‚ä½•å¼€å‘å¸¸è§çš„ MarginNote æ’ä»¶åŠŸèƒ½ã€‚

### æ¡ˆä¾‹1ï¼šæ™ºèƒ½ç¬”è®°å¤„ç†å™¨

**éœ€æ±‚**ï¼šè‡ªåŠ¨å¤„ç†æ–°åˆ›å»ºçš„ç¬”è®°ï¼Œæ·»åŠ æ ‡ç­¾ã€ç”Ÿæˆæ ‡é¢˜ã€åˆ†ç±»æ•´ç†ã€‚

#### OhMyMN å®ç°

```typescript
import { 
  JSB, MN, NodeNote, 
  undoGroupingWithRefresh, 
  eventObserverController,
  getLocalDataByKey, 
  setLocalDataByKey 
} from "marginnote"

// é…ç½®ç®¡ç†
interface Config {
  autoTitle: boolean
  autoTag: boolean
  tagPrefix: string
  colorByType: boolean
}

class SmartNoteProcessor {
  private config: Config
  private observer = eventObserverController(["ProcessNewExcerpt"])
  
  constructor() {
    this.loadConfig()
  }
  
  loadConfig() {
    this.config = getLocalDataByKey("smart-processor-config") || {
      autoTitle: true,
      autoTag: true,
      tagPrefix: "auto:",
      colorByType: true
    }
  }
  
  saveConfig() {
    setLocalDataByKey(this.config, "smart-processor-config")
  }
  
  // æ™ºèƒ½ç”Ÿæˆæ ‡é¢˜
  generateTitle(text: string): string {
    // 1. å°è¯•æå–ç¬¬ä¸€å¥è¯
    const firstSentence = text.match(/^[^ã€‚ï¼ï¼Ÿ.!?]+[ã€‚ï¼ï¼Ÿ.!?]/)?.[0]
    if (firstSentence && firstSentence.length <= 50) {
      return firstSentence
    }
    
    // 2. å°è¯•æå–å…³é”®è¯
    const keywords = this.extractKeywords(text)
    if (keywords.length > 0) {
      return keywords.slice(0, 3).join(" - ")
    }
    
    // 3. æˆªå–å‰30ä¸ªå­—ç¬¦
    return text.substring(0, 30) + "..."
  }
  
  // æå–å…³é”®è¯ï¼ˆç®€åŒ–ç‰ˆï¼‰
  extractKeywords(text: string): string[] {
    // è¿™é‡Œå¯ä»¥æ¥å…¥æ›´å¤æ‚çš„NLPç®—æ³•
    const words = text.split(/[ï¼Œã€‚ï¼ï¼Ÿ\s]+/)
    const stopWords = ["çš„", "äº†", "å’Œ", "æ˜¯", "åœ¨", "æœ‰", "ä¸ª", "åˆ°", "è¿™", "ä¸"]
    
    return words
      .filter(word => word.length > 1 && !stopWords.includes(word))
      .slice(0, 5)
  }
  
  // æ ¹æ®å†…å®¹ç±»å‹åˆ†é…é¢œè‰²
  getColorByType(text: string): number {
    if (text.includes("å®šä¹‰") || text.includes("æ¦‚å¿µ")) return 4  // é»„è‰²
    if (text.includes("ä¾‹å­") || text.includes("ç¤ºä¾‹")) return 5  // ç»¿è‰²
    if (text.includes("é‡è¦") || text.includes("å…³é”®")) return 7  // çº¢è‰²
    if (text.includes("é—®é¢˜") || text.includes("ç–‘é—®")) return 6  // è“è‰²
    return 0  // é»˜è®¤é¢œè‰²
  }
  
  // å¤„ç†æ–°ç¬”è®°
  processNewNote(note: any) {
    const nodeNote = new NodeNote(note)
    
    undoGroupingWithRefresh(() => {
      // 1. è‡ªåŠ¨ç”Ÿæˆæ ‡é¢˜
      if (this.config.autoTitle && !nodeNote.noteTitle) {
        const title = this.generateTitle(nodeNote.excerptsText)
        nodeNote.noteTitle = title
      }
      
      // 2. è‡ªåŠ¨æ·»åŠ æ ‡ç­¾
      if (this.config.autoTag) {
        const tags = []
        
        // æ·»åŠ æ—¶é—´æ ‡ç­¾
        const date = new Date().toISOString().split('T')[0]
        tags.push(`${this.config.tagPrefix}${date}`)
        
        // æ·»åŠ å…³é”®è¯æ ‡ç­¾
        const keywords = this.extractKeywords(nodeNote.excerptsText)
        keywords.slice(0, 3).forEach(keyword => {
          tags.push(`${this.config.tagPrefix}${keyword}`)
        })
        
        nodeNote.appendTags(tags)
      }
      
      // 3. æ ¹æ®ç±»å‹è®¾ç½®é¢œè‰²
      if (this.config.colorByType) {
        const color = this.getColorByType(nodeNote.excerptsText)
        nodeNote.colorIndex = color
      }
      
      // 4. æ·»åŠ å¤„ç†è®°å½•
      const timestamp = new Date().toLocaleString()
      nodeNote.appendTextComments(`[æ™ºèƒ½å¤„ç†] ${timestamp}`)
    })
  }
  
  // æ‰¹é‡å¤„ç†ç°æœ‰ç¬”è®°
  async batchProcess() {
    const notebook = MN.currentNotebook
    if (!notebook) return
    
    const notes = notebook.notes
    let processed = 0
    
    for (const note of notes) {
      if (!note.noteTitle) {  // åªå¤„ç†æ²¡æœ‰æ ‡é¢˜çš„ç¬”è®°
        this.processNewNote(note)
        processed++
        
        // æ¯å¤„ç†10ä¸ªç¬”è®°æš‚åœä¸€ä¸‹ï¼Œé¿å…å¡é¡¿
        if (processed % 10 === 0) {
          await new Promise(resolve => setTimeout(resolve, 100))
        }
      }
    }
    
    MN.showHUD(`æ‰¹é‡å¤„ç†å®Œæˆï¼š${processed} ä¸ªç¬”è®°`, 3)
  }
}

// æ’ä»¶ä¸»ä½“
JSB.newAddon = () => {
  const processor = new SmartNoteProcessor()
  
  return JSB.defineClass("SmartNoteProcessor : JSExtension", {
    sceneWillConnect() {
      processor.observer.add()
    },
    
    sceneDidDisconnect() {
      processor.observer.remove()
    },
    
    // å¤„ç†æ–°æ‘˜å½•
    onProcessNewExcerpt({ userInfo }) {
      const note = userInfo.note
      if (note) {
        processor.processNewNote(note)
      }
    },
    
    // æ’ä»¶æŒ‰é’®
    queryAddonCommandStatus() {
      return {
        image: "logo.png",
        object: this,
        selector: "showMenu:",
        checked: false
      }
    },
    
    // æ˜¾ç¤ºèœå•
    async showMenu() {
      const options = [
        "æ‰¹é‡å¤„ç†ç°æœ‰ç¬”è®°",
        "é…ç½®è®¾ç½®",
        "å…³äºæ’ä»¶"
      ]
      
      const result = await MN.select(options, null)
      
      switch (result?.index) {
        case 0:
          await processor.batchProcess()
          break
        case 1:
          await this.showConfig()
          break
        case 2:
          MN.alert("æ™ºèƒ½ç¬”è®°å¤„ç†å™¨ v1.0.0\nè‡ªåŠ¨å¤„ç†å’Œæ•´ç†æ‚¨çš„ç¬”è®°")
          break
      }
    },
    
    // é…ç½®ç•Œé¢
    async showConfig() {
      // è¿™é‡Œå¯ä»¥å®ç°æ›´å¤æ‚çš„é…ç½®ç•Œé¢
      const config = processor.config
      
      const autoTitle = await MN.confirm(
        "æ˜¯å¦å¯ç”¨è‡ªåŠ¨ç”Ÿæˆæ ‡é¢˜ï¼Ÿ\nå½“å‰ï¼š" + (config.autoTitle ? "å·²å¯ç”¨" : "å·²ç¦ç”¨")
      )
      
      if (autoTitle !== config.autoTitle) {
        config.autoTitle = autoTitle
        processor.saveConfig()
        MN.showHUD("é…ç½®å·²ä¿å­˜", 2)
      }
    }
  })
}
```

### æ¡ˆä¾‹2ï¼šç¬”è®°å¯¼å‡ºå·¥å…·

**éœ€æ±‚**ï¼šå°†ç¬”è®°å¯¼å‡ºä¸º Markdownã€Anki å¡ç‰‡ç­‰æ ¼å¼ã€‚

#### æ··åˆå®ç°ï¼ˆä½¿ç”¨ MNUtilsï¼‰

```javascript
// ä½¿ç”¨ MNUtils æä¾›çš„åŸºç¡€åŠŸèƒ½
if (typeof MNUtil === "undefined") {
  Application.sharedInstance().alert("è¯·å…ˆå®‰è£… MNUtils æ’ä»¶")
  return
}

var self;

// Markdown å¯¼å‡ºå™¨
function MarkdownExporter() {
  this.exportNote = function(note) {
    var md = ""
    
    // æ ‡é¢˜
    if (note.noteTitle) {
      md += "# " + note.noteTitle + "\n\n"
    }
    
    // æ‘˜å½•
    if (note.excerptText) {
      md += "> " + note.excerptText.replace(/\n/g, "\n> ") + "\n\n"
    }
    
    // è¯„è®º
    var comments = note.comments
    if (comments && comments.length > 0) {
      md += "## ç¬”è®°\n\n"
      comments.forEach(function(comment) {
        if (comment.text) {
          md += "- " + comment.text + "\n"
        }
      })
      md += "\n"
    }
    
    // æ ‡ç­¾
    var tags = note.tags
    if (tags && tags.length > 0) {
      md += "**æ ‡ç­¾**: " + tags.map(function(tag) {
        return "`" + tag + "`"
      }).join(" ") + "\n\n"
    }
    
    // å­ç¬”è®°
    var childNotes = note.childNotes
    if (childNotes && childNotes.length > 0) {
      md += "### å­ç¬”è®°\n\n"
      childNotes.forEach(function(child) {
        md += this.exportNote(child).replace(/^#/gm, "##")
      }, this)
    }
    
    return md
  }
  
  this.exportNotebook = function() {
    var notebook = MNUtil.currentNotebook
    if (!notebook) {
      MNUtil.showHUD("è¯·å…ˆæ‰“å¼€ä¸€ä¸ªç¬”è®°æœ¬")
      return
    }
    
    var notes = notebook.notes
    var markdown = "# " + notebook.title + "\n\n"
    
    // åªå¯¼å‡ºé¡¶å±‚ç¬”è®°ï¼ˆå­ç¬”è®°ä¼šé€’å½’å¯¼å‡ºï¼‰
    var topLevelNotes = notes.filter(function(note) {
      return !note.parentNote
    })
    
    topLevelNotes.forEach(function(note) {
      markdown += this.exportNote(note)
      markdown += "---\n\n"
    }, this)
    
    // å¤åˆ¶åˆ°å‰ªè´´æ¿
    UIPasteboard.generalPasteboard().string = markdown
    MNUtil.showHUD("å·²å¯¼å‡º " + topLevelNotes.length + " ä¸ªç¬”è®°åˆ°å‰ªè´´æ¿")
  }
}

// Anki å¯¼å‡ºå™¨
function AnkiExporter() {
  this.noteToAnkiCard = function(note) {
    var front = note.noteTitle || note.excerptText.substring(0, 50) + "..."
    var back = ""
    
    // æ‘˜å½•ä½œä¸ºç­”æ¡ˆ
    if (note.excerptText) {
      back += note.excerptText + "\n\n"
    }
    
    // æ·»åŠ è¯„è®º
    var comments = note.comments
    if (comments && comments.length > 0) {
      back += comments.map(function(c) {
        return c.text
      }).filter(Boolean).join("\n")
    }
    
    // Anki æ ¼å¼ï¼šç”¨åˆ¶è¡¨ç¬¦åˆ†éš”
    return front + "\t" + back
  }
  
  this.exportSelected = function() {
    var focusNotes = MNNote.getFocusNotes()
    if (!focusNotes || focusNotes.length === 0) {
      MNUtil.showHUD("è¯·å…ˆé€‰æ‹©è¦å¯¼å‡ºçš„ç¬”è®°")
      return
    }
    
    var ankiData = focusNotes.map(this.noteToAnkiCard).join("\n")
    
    // ä¿å­˜åˆ°æ–‡ä»¶
    var fileName = "anki_export_" + new Date().getTime() + ".txt"
    var filePath = MNUtil.cachePath + "/" + fileName
    
    // å†™å…¥æ–‡ä»¶
    NSString.stringWithString(ankiData).writeToFileAtomically(filePath, true)
    
    MNUtil.showHUD("å·²å¯¼å‡º " + focusNotes.length + " å¼ å¡ç‰‡")
    
    // å¯ä»¥æ·»åŠ åˆ†äº«åŠŸèƒ½
    if (MNUtil.isMacOS()) {
      // macOS ä¸Šæ‰“å¼€æ–‡ä»¶ä½ç½®
      NSWorkspace.sharedWorkspace().selectFileInFileViewerRootedAtPath(filePath)
    }
  }
}

// ä¸»æ’ä»¶
JSB.newAddon = function(mainPath) {
  self = this
  
  var markdownExporter = new MarkdownExporter()
  var ankiExporter = new AnkiExporter()
  
  return JSB.defineClass("NoteExporter : JSExtension", {
    // åˆå§‹åŒ–
    sceneWillConnect: function() {
      self.markdownExporter = markdownExporter
      self.ankiExporter = ankiExporter
    },
    
    // æ’ä»¶æŒ‰é’®
    queryAddonCommandStatus: function() {
      return {
        image: "export.png",
        object: self,
        selector: "showExportMenu:",
        checked: false
      }
    },
    
    // å¯¼å‡ºèœå•
    showExportMenu: function(sender) {
      var menu = new Menu(sender, self, 250)
      
      menu.addMenuItem("ğŸ“ å¯¼å‡ºç¬”è®°æœ¬ä¸º Markdown", "exportMarkdown:")
      menu.addMenuItem("ğŸ´ å¯¼å‡ºé€‰ä¸­ç¬”è®°ä¸º Anki", "exportAnki:")
      menu.addMenuItem("ğŸ“Š å¯¼å‡ºç»Ÿè®¡ä¿¡æ¯", "exportStats:")
      
      menu.show()
    },
    
    // å¯¼å‡ºåŠŸèƒ½
    exportMarkdown: function() {
      self.markdownExporter.exportNotebook()
    },
    
    exportAnki: function() {
      self.ankiExporter.exportSelected()
    },
    
    exportStats: function() {
      var notebook = MNUtil.currentNotebook
      if (!notebook) return
      
      var notes = notebook.notes
      var stats = {
        total: notes.length,
        withTitle: notes.filter(function(n) { return n.noteTitle }).length,
        withTags: notes.filter(function(n) { return n.tags && n.tags.length > 0 }).length,
        withComments: notes.filter(function(n) { return n.comments && n.comments.length > 0 }).length,
        byColor: {}
      }
      
      // æŒ‰é¢œè‰²ç»Ÿè®¡
      notes.forEach(function(note) {
        var color = note.colorIndex || 0
        stats.byColor[color] = (stats.byColor[color] || 0) + 1
      })
      
      var report = "ğŸ“Š ç¬”è®°æœ¬ç»Ÿè®¡\n\n"
      report += "æ€»ç¬”è®°æ•°: " + stats.total + "\n"
      report += "æœ‰æ ‡é¢˜: " + stats.withTitle + "\n"
      report += "æœ‰æ ‡ç­¾: " + stats.withTags + "\n"
      report += "æœ‰è¯„è®º: " + stats.withComments + "\n\n"
      report += "é¢œè‰²åˆ†å¸ƒ:\n"
      
      Object.keys(stats.byColor).forEach(function(color) {
        report += "é¢œè‰² " + color + ": " + stats.byColor[color] + " ä¸ª\n"
      })
      
      Application.sharedInstance().alert(report)
    }
  }, {})
}
```

### å¼€å‘æœ€ä½³å®è·µæ€»ç»“

1. **æ¨¡å—åŒ–è®¾è®¡**
   - å°†åŠŸèƒ½æ‹†åˆ†ä¸ºç‹¬ç«‹çš„ç±»æˆ–æ¨¡å—
   - ä½¿ç”¨ä¾èµ–æ³¨å…¥æé«˜å¯æµ‹è¯•æ€§
   - é¿å…å…¨å±€å˜é‡æ±¡æŸ“

2. **é”™è¯¯å¤„ç†**
   - æ€»æ˜¯æ£€æŸ¥å¯¹è±¡æ˜¯å¦å­˜åœ¨
   - ä½¿ç”¨ try-catch åŒ…è£…å¯èƒ½å‡ºé”™çš„æ“ä½œ
   - æä¾›å‹å¥½çš„é”™è¯¯æç¤º

3. **æ€§èƒ½ä¼˜åŒ–**
   - æ‰¹é‡æ“ä½œæ—¶æ·»åŠ è¿›åº¦åé¦ˆ
   - å¤§é‡æ•°æ®å¤„ç†æ—¶ä½¿ç”¨å¼‚æ­¥
   - åŠæ—¶é‡Šæ”¾ä¸å†ä½¿ç”¨çš„èµ„æº

4. **ç”¨æˆ·ä½“éªŒ**
   - æ“ä½œå‰ç¡®è®¤ï¼Œæ“ä½œååé¦ˆ
   - æ”¯æŒæ’¤é”€é‡åš
   - ä¿å­˜ç”¨æˆ·é…ç½®

5. **ä»£ç è´¨é‡**
   - ä½¿ç”¨ TypeScript è·å¾—ç±»å‹å®‰å…¨
   - ç¼–å†™å•å…ƒæµ‹è¯•
   - ä¿æŒä»£ç ç®€æ´å¯è¯»

## ğŸ’» å®Œæ•´ç¤ºä¾‹ä»£ç 

æœ¬èŠ‚æä¾›äº†ä½¿ç”¨ä¸åŒæ¡†æ¶å¼€å‘ MarginNote æ’ä»¶çš„å®Œæ•´ç¤ºä¾‹ã€‚

### OhMyMN TypeScript ç¤ºä¾‹

è¿™æ˜¯ä¸€ä¸ªä½¿ç”¨ OhMyMN æ¡†æ¶å’Œ TypeScript å¼€å‘çš„ç°ä»£åŒ–æ’ä»¶ç¤ºä¾‹ã€‚

#### package.json
```json
{
  "name": "my-ohmymn-plugin",
  "version": "1.0.0",
  "type": "module",
  "scripts": {
    "dev": "marginnote-dev",
    "build": "marginnote-build"
  },
  "devDependencies": {
    "@marginnote/api": "latest",
    "@marginnote/addon": "latest",
    "typescript": "^5.0.0"
  }
}
```

#### src/main.ts
```typescript
import { 
  JSB, 
  MN, 
  NodeNote,
  showHUD, 
  alert,
  popup,
  select,
  undoGroupingWithRefresh,
  eventObserverController,
  i18n
} from "marginnote"

// å›½é™…åŒ–æ”¯æŒ
const lang = i18n({
  zh: {
    title: "æˆ‘çš„æ’ä»¶",
    process_note: "å¤„ç†ç¬”è®°",
    add_tag: "æ·»åŠ æ ‡ç­¾",
    change_color: "ä¿®æ”¹é¢œè‰²",
    success: "æ“ä½œæˆåŠŸ",
    select_action: "é€‰æ‹©æ“ä½œ"
  },
  en: {
    title: "My Plugin",
    process_note: "Process Note",
    add_tag: "Add Tag", 
    change_color: "Change Color",
    success: "Success",
    select_action: "Select Action"
  }
})

// äº‹ä»¶è§‚å¯Ÿå™¨
const observer = eventObserverController([
  "PopupMenuOnNote",
  "ProcessNewExcerpt"
])

JSB.newAddon = () => {
  return JSB.defineClass("MyOhMyMNPlugin : JSExtension", {
    // çª—å£è¿æ¥æ—¶åˆå§‹åŒ–
    sceneWillConnect() {
      MN.log("Plugin connected", MN.studyController.window)
      showHUD(lang.title + " å·²åŠ è½½", 2)
      
      // æ·»åŠ äº‹ä»¶ç›‘å¬
      observer.add()
    },
    
    // çª—å£æ–­å¼€æ—¶æ¸…ç†
    sceneDidDisconnect() {
      // ç§»é™¤äº‹ä»¶ç›‘å¬
      observer.remove()
    },
    
    // æ’ä»¶æŒ‰é’®çŠ¶æ€
    queryAddonCommandStatus() {
      return {
        image: "logo.png",
        object: this,
        selector: "togglePlugin:",
        checked: false
      }
    },
    
    // æ’ä»¶æŒ‰é’®ç‚¹å‡»
    async togglePlugin() {
      const focusNote = MN.focusNote
      if (!focusNote) {
        showHUD("è¯·å…ˆé€‰æ‹©ä¸€ä¸ªç¬”è®°", 2)
        return
      }
      
      // ä½¿ç”¨ select è®©ç”¨æˆ·é€‰æ‹©æ“ä½œ
      const action = await select(
        [lang.process_note, lang.add_tag, lang.change_color],
        ["process", "tag", "color"]
      )
      
      if (action) {
        await this.performAction(focusNote, action.value)
      }
    },
    
    // æ‰§è¡Œæ“ä½œ
    async performAction(note: any, action: string) {
      const nodeNote = new NodeNote(note)
      
      undoGroupingWithRefresh(() => {
        switch (action) {
          case "process":
            this.processNote(nodeNote)
            break
          case "tag":
            this.addTagToNote(nodeNote)
            break
          case "color":
            this.changeNoteColor(nodeNote)
            break
        }
      })
      
      showHUD(lang.success, 2)
    },
    
    // å¤„ç†ç¬”è®°
    processNote(note: NodeNote) {
      // è·å–æ‰€æœ‰æ–‡æœ¬
      const allText = note.allText
      
      // è‡ªåŠ¨ç”Ÿæˆæ ‡é¢˜ï¼ˆå–å‰20ä¸ªå­—ï¼‰
      if (!note.noteTitle && allText) {
        note.noteTitle = allText.substring(0, 20) + "..."
      }
      
      // æ·»åŠ å¤„ç†æ ‡è®°
      note.appendTags(["å·²å¤„ç†"])
      
      // æ·»åŠ æ—¶é—´æˆ³è¯„è®º
      const timestamp = new Date().toLocaleString()
      note.appendTextComments(`å¤„ç†æ—¶é—´ï¼š${timestamp}`)
    },
    
    // æ·»åŠ æ ‡ç­¾
    async addTagToNote(note: NodeNote) {
      const result = await popup({
        title: lang.add_tag,
        type: PopupType.Input,
        message: "è¯·è¾“å…¥æ ‡ç­¾ï¼ˆç”¨ç©ºæ ¼åˆ†éš”å¤šä¸ªæ ‡ç­¾ï¼‰",
        defaultValue: ""
      })
      
      if (result && result.inputText) {
        const tags = result.inputText.split(" ").filter(t => t.length > 0)
        note.appendTags(tags)
      }
    },
    
    // ä¿®æ”¹é¢œè‰²
    async changeNoteColor(note: NodeNote) {
      const colors = [
        "é»„è‰²", "ç»¿è‰²", "è“è‰²", "çº¢è‰²",
        "æ©™è‰²", "æ·±ç»¿", "æ·±è“", "æ·±çº¢"
      ]
      
      const color = await select(colors, [4, 5, 6, 7, 8, 9, 10, 11])
      if (color) {
        note.colorIndex = color.value
      }
    },
    
    // å¤„ç†æ–°æ‘˜å½•äº‹ä»¶
    onProcessNewExcerpt({ userInfo }: any) {
      const note = userInfo.note
      if (note) {
        const nodeNote = new NodeNote(note)
        
        // è‡ªåŠ¨å¤„ç†æ–°æ‘˜å½•
        undoGroupingWithRefresh(() => {
          // è‡ªåŠ¨æ·»åŠ æ—¶é—´æ ‡ç­¾
          const dateTag = new Date().toISOString().split('T')[0]
          nodeNote.appendTags([dateTag])
          
          // å¦‚æœæ˜¯é•¿æ–‡æœ¬ï¼Œè‡ªåŠ¨ç”Ÿæˆæ ‡é¢˜
          if (nodeNote.excerptsText.length > 100) {
            nodeNote.noteTitle = nodeNote.excerptsText.substring(0, 30) + "..."
          }
        })
      }
    },
    
    // ç¬”è®°å³é”®èœå•
    onPopupMenuOnNote({ userInfo }: any) {
      if (!MN.isModeMindMap) return
      
      const note = userInfo.note
      userInfo.menuController.addMenuItem({
        title: "ğŸ¨ " + lang.change_color,
        object: this,
        selector: "menuChangeColor:",
        param: note
      })
    },
    
    // èœå•é¡¹åŠ¨ä½œ
    async menuChangeColor(note: any) {
      const nodeNote = new NodeNote(note)
      await this.changeNoteColor(nodeNote)
    }
  }, {
    // é™æ€æ–¹æ³•
    addonDidConnect() {
      MN.log("OhMyMN Plugin installed")
    },
    
    addonWillDisconnect() {
      MN.log("OhMyMN Plugin uninstalled")
    }
  })
}
```

### OhMyMN Lite æ’ä»¶ç¤ºä¾‹

é€‚åˆç®€å•åŠŸèƒ½çš„è½»é‡çº§æ’ä»¶å¼€å‘ã€‚

```javascript
import { JSB, MN, showHUD, popup, NodeNote } from "marginnote"

JSB.newAddon = () => {
  return JSB.defineClass("QuickNoteLite : JSExtension", {
    sceneWillConnect() {
      showHUD("QuickNote Lite å·²å¯åŠ¨", 2)
    },
    
    queryAddonCommandStatus() {
      return {
        image: "logo.png",
        object: this,
        selector: "quickAction:",
        checked: false
      }
    },
    
    async quickAction() {
      const note = MN.focusNote
      if (!note) {
        showHUD("è¯·é€‰æ‹©ä¸€ä¸ªç¬”è®°", 2)
        return
      }
      
      const result = await popup({
        title: "å¿«é€Ÿç¬”è®°",
        message: "ä¸ºè¿™ä¸ªç¬”è®°æ·»åŠ å¤‡æ³¨",
        type: PopupType.Input,
        buttons: ["ç¡®å®š", "å–æ¶ˆ"]
      })
      
      if (result && result.buttonIndex === 0 && result.inputText) {
        const nodeNote = new NodeNote(note)
        nodeNote.appendTextComments(result.inputText)
        showHUD("å¤‡æ³¨å·²æ·»åŠ ", 2)
      }
    }
  })
}
```

### HelloWorld æ’ä»¶ç¤ºä¾‹ï¼ˆä¼ ç»Ÿæ–¹å¼ï¼‰

è¿™æ˜¯ä¸€ä¸ªæœ€åŸºç¡€çš„ MarginNote æ’ä»¶ç¤ºä¾‹ï¼Œå±•ç¤ºäº†æ’ä»¶çš„åŸºæœ¬ç»“æ„å’Œç”Ÿå‘½å‘¨æœŸã€‚

#### mnaddon.json
```json
{
  "addonid": "marginnote.extension.helloworld",
  "author": "Your Name",
  "title": "Hello World",
  "version": "1.0.0",
  "marginnote_version_min": "3.7.11",
  "cert_key": ""
}
```

#### main.js
```javascript
var self = null;

JSB.newAddon = function(mainPath) {
  self = this;
  
  return JSB.defineClass('HelloWorld : JSExtension', {
    // çª—å£ç”Ÿå‘½å‘¨æœŸ
    sceneWillConnect: function() {
      self.window = Application.sharedInstance().focusWindow;
      
      // æ˜¾ç¤ºæ¬¢è¿ä¿¡æ¯
      Application.sharedInstance().showHUD(
        "Hello World æ’ä»¶å·²åŠ è½½ï¼", 
        self.window, 
        3
      );
    },
    
    sceneDidDisconnect: function() {
      // æ¸…ç†èµ„æº
      self = null;
    },
    
    // ç¬”è®°æœ¬ç”Ÿå‘½å‘¨æœŸ
    notebookWillOpen: function(notebookId) {
      Application.sharedInstance().showHUD(
        "æ‰“å¼€ç¬”è®°æœ¬: " + notebookId, 
        self.window, 
        2
      );
    },
    
    // æ’ä»¶æŒ‰é’®çŠ¶æ€
    queryAddonCommandStatus: function() {
      return {
        image: 'logo.png',
        object: self,
        selector: 'togglePlugin:',
        checked: false
      };
    },
    
    // æ’ä»¶æŒ‰é’®ç‚¹å‡»
    togglePlugin: function(sender) {
      Application.sharedInstance().alert("Hello from MarginNote!");
    },
    
    // ç¬”è®°èœå•
    onPopupMenuOnNote: function(sender) {
      if (!Application.sharedInstance().isModeMindMap) {
        return;
      }
      
      const note = sender.userInfo.note;
      
      // æ·»åŠ èœå•é¡¹
      sender.userInfo.menuController.addMenuItem({
        title: "ğŸ‘‹ Say Hello",
        object: self,
        selector: 'sayHello:',
        param: note
      });
    },
    
    // èœå•åŠ¨ä½œ
    sayHello: function(note) {
      Application.sharedInstance().showHUD(
        "Hello! å½“å‰ç¬”è®°: " + note.noteTitle, 
        self.window, 
        3
      );
    }
  }, {
    // é™æ€æ–¹æ³•
    addonDidConnect: function() {
      console.log("HelloWorld addon connected");
    },
    
    addonWillDisconnect: function() {
      console.log("HelloWorld addon disconnected");
    }
  });
};
```

### AutoTitle æ’ä»¶ç¤ºä¾‹

è¿™æ˜¯ä¸€ä¸ªå®ç”¨çš„æ’ä»¶ç¤ºä¾‹ï¼Œå±•ç¤ºäº†å¦‚ä½•è‡ªåŠ¨ä¸ºç¬”è®°ç”Ÿæˆæ ‡é¢˜ã€‚

#### main.js (æ ¸å¿ƒåŠŸèƒ½)
```javascript
var self = null;

JSB.newAddon = function(mainPath) {
  self = this;
  
  return JSB.defineClass('AutoTitle : JSExtension', {
    // åˆå§‹åŒ–
    sceneWillConnect: function() {
      self.window = Application.sharedInstance().focusWindow;
      self.studyController = Application.sharedInstance().studyController(self.window);
      
      // æ³¨å†Œäº‹ä»¶
      NSNotificationCenter.defaultCenter().addObserver(
        self,
        'onProcessNewExcerpt:',
        'ProcessNewExcerpt',
        null
      );
      
      Application.sharedInstance().showHUD(
        "AutoTitle å·²å¯åŠ¨", 
        self.window, 
        2
      );
    },
    
    // æ¸…ç†
    sceneDidDisconnect: function() {
      NSNotificationCenter.defaultCenter().removeObserver(self);
    },
    
    // å¤„ç†æ–°æ‘˜å½•
    onProcessNewExcerpt: function(sender) {
      const excerptInfo = sender.userInfo;
      const note = excerptInfo.note;
      
      if (!note || note.noteTitle) {
        return; // å·²æœ‰æ ‡é¢˜ï¼Œè·³è¿‡
      }
      
      // è‡ªåŠ¨ç”Ÿæˆæ ‡é¢˜
      const title = this.generateTitle(note.excerptText);
      
      // ä½¿ç”¨æ’¤é”€ç»„
      UndoManager.sharedInstance().undoGrouping(
        "è‡ªåŠ¨ç”Ÿæˆæ ‡é¢˜",
        self.studyController.notebookController.notebookId,
        function() {
          note.noteTitle = title;
        }
      );
      
      Application.sharedInstance().showHUD(
        "âœ… å·²ç”Ÿæˆæ ‡é¢˜: " + title, 
        self.window, 
        2
      );
    },
    
    // ç”Ÿæˆæ ‡é¢˜é€»è¾‘
    generateTitle: function(text) {
      if (!text) return "æ— æ ‡é¢˜";
      
      // æ¸…ç†æ–‡æœ¬
      text = text.trim();
      
      // æå–ç¬¬ä¸€å¥è¯
      const sentences = text.match(/[^ã€‚ï¼ï¼Ÿ.!?]+[ã€‚ï¼ï¼Ÿ.!?]/g);
      if (sentences && sentences.length > 0) {
        let firstSentence = sentences[0].trim();
        
        // é™åˆ¶é•¿åº¦
        if (firstSentence.length > 30) {
          firstSentence = firstSentence.substring(0, 27) + "...";
        }
        
        return firstSentence;
      }
      
      // å¦‚æœæ²¡æœ‰å¥å­ï¼Œå–å‰30ä¸ªå­—ç¬¦
      if (text.length > 30) {
        return text.substring(0, 27) + "...";
      }
      
      return text;
    },
    
    // æ’ä»¶æŒ‰é’®
    queryAddonCommandStatus: function() {
      return {
        image: 'logo.png',
        object: self,
        selector: 'toggleAutoTitle:',
        checked: self.autoTitleEnabled || false
      };
    },
    
    // åˆ‡æ¢è‡ªåŠ¨æ ‡é¢˜åŠŸèƒ½
    toggleAutoTitle: function(sender) {
      self.autoTitleEnabled = !self.autoTitleEnabled;
      
      const status = self.autoTitleEnabled ? "å¯ç”¨" : "ç¦ç”¨";
      Application.sharedInstance().showHUD(
        "è‡ªåŠ¨æ ‡é¢˜å·²" + status, 
        self.window, 
        2
      );
      
      // åˆ·æ–°æ’ä»¶æŒ‰é’®çŠ¶æ€
      Application.sharedInstance().refreshAddonCommands();
    },
    
    // æ‰‹åŠ¨å¤„ç†é€‰ä¸­çš„ç¬”è®°
    onPopupMenuOnNote: function(sender) {
      const note = sender.userInfo.note;
      
      sender.userInfo.menuController.addMenuItem({
        title: "ğŸ¤– ç”Ÿæˆæ ‡é¢˜",
        object: self,
        selector: 'generateTitleForNote:',
        param: note
      });
    },
    
    generateTitleForNote: function(note) {
      if (!note) return;
      
      const oldTitle = note.noteTitle;
      const newTitle = this.generateTitle(note.excerptText);
      
      UndoManager.sharedInstance().undoGrouping(
        "ç”Ÿæˆæ ‡é¢˜",
        self.studyController.notebookController.notebookId,
        function() {
          note.noteTitle = newTitle;
        }
      );
      
      Application.sharedInstance().showHUD(
        "âœ… æ ‡é¢˜å·²æ›´æ–°", 
        self.window, 
        2
      );
    }
  }, {
    // é™æ€æ–¹æ³•
    addonDidConnect: function() {},
    addonWillDisconnect: function() {}
  });
};
```

### å¼€å‘æŠ€å·§æ€»ç»“

1. **ç”Ÿå‘½å‘¨æœŸç®¡ç†**
   - åœ¨ `sceneWillConnect` ä¸­åˆå§‹åŒ–
   - åœ¨ `sceneDidDisconnect` ä¸­æ¸…ç†èµ„æº
   - æ³¨æ„ä¿å­˜ self å¼•ç”¨

2. **äº‹ä»¶å¤„ç†**
   - ä½¿ç”¨ NSNotificationCenter ç›‘å¬ç³»ç»Ÿäº‹ä»¶
   - è®°å¾—åœ¨æ–­å¼€æ—¶ç§»é™¤ç›‘å¬å™¨
   - ä½¿ç”¨ UndoManager æ”¯æŒæ’¤é”€

3. **ç”¨æˆ·äº¤äº’**
   - ä½¿ç”¨ showHUD æ˜¾ç¤ºä¸´æ—¶æç¤º
   - ä½¿ç”¨ alert æ˜¾ç¤ºé‡è¦ä¿¡æ¯
   - æ·»åŠ èœå•é¡¹å¢å¼ºåŠŸèƒ½

4. **é”™è¯¯å¤„ç†**
   - æ£€æŸ¥å¯¹è±¡æ˜¯å¦å­˜åœ¨
   - ä½¿ç”¨ try-catch æ•è·å¼‚å¸¸
   - æä¾›å‹å¥½çš„é”™è¯¯æç¤º

## ğŸ”’ å®‰å…¨ä¸éšç§

### 1. æ•°æ®å®‰å…¨
- **ä¸æ”¶é›†ç”¨æˆ·éšç§æ•°æ®**
- **æ‰€æœ‰æ•°æ®æœ¬åœ°å­˜å‚¨**
- **æ•æ„Ÿæ“ä½œéœ€ç”¨æˆ·ç¡®è®¤**
- **æä¾›æ•°æ®å¯¼å‡ºåŠŸèƒ½**

### 2. æƒé™æ§åˆ¶
```javascript
// æ“ä½œå‰æ£€æŸ¥æƒé™
function checkPermission(action) {
  // æ£€æŸ¥ç¬”è®°æœ¬æ˜¯å¦åªè¯»
  if (MNUtil.currentNotebook.readOnly) {
    MNUtil.showHUD("ç¬”è®°æœ¬ä¸ºåªè¯»çŠ¶æ€");
    return false;
  }
  
  // æ£€æŸ¥æ˜¯å¦æœ‰ä¿®æ”¹æƒé™
  if (!self.hasModifyPermission) {
    MNUtil.showHUD("æ²¡æœ‰ä¿®æ”¹æƒé™");
    return false;
  }
  
  return true;
}
```

### 3. é”™è¯¯éš”ç¦»
```javascript
// æ¨¡å—é”™è¯¯éš”ç¦»
function isolatedExecute(moduleFunc) {
  try {
    return moduleFunc();
  } catch (error) {
    // æ¨¡å—é”™è¯¯ä¸å½±å“ä¸»ç¨‹åº
    console.error('Module error:', error);
    return null;
  }
}
```

## ğŸ“Š æµ‹è¯•ç­–ç•¥

### 1. å•å…ƒæµ‹è¯•
```javascript
// ç®€å•çš„æµ‹è¯•æ¡†æ¶
class TestRunner {
  constructor() {
    this.tests = [];
    this.results = [];
  }
  
  test(name, fn) {
    this.tests.push({ name, fn });
  }
  
  async run() {
    for (const test of this.tests) {
      try {
        await test.fn();
        this.results.push({ name: test.name, passed: true });
      } catch (error) {
        this.results.push({ 
          name: test.name, 
          passed: false, 
          error: error.message 
        });
      }
    }
    
    this.report();
  }
  
  report() {
    const passed = this.results.filter(r => r.passed).length;
    const failed = this.results.filter(r => !r.passed).length;
    
    console.log(`Tests: ${passed} passed, ${failed} failed`);
    
    this.results.filter(r => !r.passed).forEach(r => {
      console.error(`âŒ ${r.name}: ${r.error}`);
    });
  }
}
```

### 2. é›†æˆæµ‹è¯•
- æµ‹è¯•æ’ä»¶ç”Ÿå‘½å‘¨æœŸ
- æµ‹è¯•äº‹ä»¶å“åº”
- æµ‹è¯•æ•°æ®æŒä¹…åŒ–
- æµ‹è¯•è·¨å¹³å°å…¼å®¹æ€§

### 3. æ€§èƒ½æµ‹è¯•
```javascript
// æ€§èƒ½ç›‘æ§
class PerformanceMonitor {
  static measure(name, fn) {
    const start = Date.now();
    const result = fn();
    const duration = Date.now() - start;
    
    if (duration > 100) {
      console.warn(`Slow operation '${name}': ${duration}ms`);
    }
    
    return result;
  }
  
  static async measureAsync(name, fn) {
    const start = Date.now();
    const result = await fn();
    const duration = Date.now() - start;
    
    if (duration > 1000) {
      console.warn(`Slow async operation '${name}': ${duration}ms`);
    }
    
    return result;
  }
}
```

## ğŸ¯ å‘å¸ƒä¸ç»´æŠ¤

### 1. ç‰ˆæœ¬ç®¡ç†
- ä½¿ç”¨è¯­ä¹‰åŒ–ç‰ˆæœ¬å· (SemVer)
- ç»´æŠ¤è¯¦ç»†çš„æ›´æ–°æ—¥å¿—
- æ ‡è®°ç ´åæ€§æ›´æ”¹

### 2. ç”¨æˆ·æ”¯æŒ
- æä¾›è¯¦ç»†çš„ä½¿ç”¨æ–‡æ¡£
- åˆ›å»º FAQ é¡µé¢
- å»ºç«‹åé¦ˆæ¸ é“

### 3. æŒç»­æ”¹è¿›
- æ”¶é›†ç”¨æˆ·åé¦ˆ
- ç›‘æ§é”™è¯¯æŠ¥å‘Š
- å®šæœŸæ›´æ–°ä¼˜åŒ–

## ğŸ“š å‚è€ƒèµ„æº

### å®˜æ–¹èµ„æº
- [MarginNote å®˜æ–¹ç½‘ç«™](https://www.marginnote.com/)
- [MarginNote æ’ä»¶å¼€å‘æ–‡æ¡£](https://docs-addon.marginnote.cn/)
- [MarginNote å¼€å‘æŒ‡å—](https://docs-addon.marginnote.cn/guide)
- [MarginNote é«˜çº§å¼€å‘](https://docs-addon.marginnote.cn/advanced/)
- [MarginNote API ä»“åº“](https://github.com/MarginNote/Addon)
- [MarginNote è®ºå›](https://bbs.marginnote.cn/)
- [MarginNote æ’ä»¶ç¤¾åŒº](https://bbs.marginnote.cn/c/script/Mod/55)

### ç¤¾åŒºèµ„æº
- [OhMyMN é¡¹ç›®](https://github.com/ourongxing/ohmymn) - åŠŸèƒ½æœ€å…¨é¢çš„æ’ä»¶æ¡†æ¶
- [Awesome MarginNote](https://github.com/topics/marginnote) - ä¼˜ç§€æ’ä»¶é›†åˆ
- [MarginNote API æ›´æ–°ä»“åº“](https://github.com/marginnoteapp/marginnote-api) - æœ€æ–° API å‚è€ƒ
- æ’ä»¶å¼€å‘äº¤æµç¾¤
- [MN-Addon é¡¹ç›®](https://github.com/xkdaq/MN-Addon) - æœ¬é¡¹ç›®ä»“åº“

### å­¦ä¹ èµ„æº
- [JavaScript åŸºç¡€æ•™ç¨‹](https://developer.mozilla.org/zh-CN/docs/Web/JavaScript)
- [Objective-C å…¥é—¨æŒ‡å—](https://developer.apple.com/library/archive/documentation/Cocoa/Conceptual/ProgrammingWithObjectiveC/Introduction/Introduction.html)
- [JSBridge åŸç†è§£æ](https://github.com/marcuswestin/WebViewJavascriptBridge)
- [Safari WebView å¼€å‘](https://developer.apple.com/documentation/webkit)
- [JSBox æ–‡æ¡£](https://docs.xteko.com/) - äº†è§£ JSB æ¡†æ¶åŸºç¡€

### å¼€æºæ’ä»¶ç¤ºä¾‹
- **[OhMyMN](https://github.com/ourongxing/ohmymn)**: åŠŸèƒ½æœ€å…¨é¢çš„æ’ä»¶æ¡†æ¶ï¼Œæä¾›ä¸°å¯Œçš„åŠŸèƒ½æ¨¡å—
- **[MNUtils](https://github.com/xkdaq/MN-Addon/tree/main/mnutils)**: æ ¸å¿ƒ API å°è£…åº“ï¼Œå¿…å¤‡åŸºç¡€è®¾æ–½
- **[MNToolbar](https://github.com/xkdaq/MN-Addon/tree/main/mntoolbar)**: å·¥å…·æ å¢å¼ºæ’ä»¶ï¼Œå¯å®šåˆ¶æŒ‰é’®å’Œèœå•
- **[Export to Anki](https://github.com/XHXIAIEIN/Export-to-Anki)**: å¯¼å‡ºåˆ° Anki çš„æ’ä»¶ç¤ºä¾‹
- **[Enhance MarginNote](https://github.com/JeffChen-png/EnhanceMarginNote)**: åŠŸèƒ½å¢å¼ºæ’ä»¶
- æ›´å¤šæ’ä»¶è¯·åœ¨ GitHub æœç´¢ "marginnote addon" æˆ– "marginnote plugin"

### å¼€å‘å·¥å…·
- **[mnaddon CLI](https://www.npmjs.com/package/mnaddon)**: å®˜æ–¹æ‰“åŒ…å·¥å…·
- **VSCode æ’ä»¶**: æœç´¢ "JSBox" è·å¾—è¯­æ³•æ”¯æŒ
- **Safari Developer Tools**: ç”¨äºè°ƒè¯• WebView

## â“ FAQ - å¸¸è§é—®é¢˜è§£ç­”

### åŸºç¡€é—®é¢˜

**Q: MarginNote 3 å’Œ MarginNote 4 çš„æ’ä»¶å…¼å®¹å—ï¼Ÿ**
A: å¤§éƒ¨åˆ†å…¼å®¹ï¼Œä½†æœ‰ä¸€äº› API å·®å¼‚ã€‚å»ºè®®åœ¨ mnaddon.json ä¸­æŒ‡å®šæœ€ä½ç‰ˆæœ¬è¦æ±‚ï¼Œå¹¶åœ¨ä»£ç ä¸­è¿›è¡Œç‰ˆæœ¬æ£€æµ‹ã€‚

**Q: ä¸ºä»€ä¹ˆæˆ‘çš„æ’ä»¶åœ¨æ’ä»¶æ ä¸æ˜¾ç¤ºï¼Ÿ**
A: æ£€æŸ¥ä»¥ä¸‹å‡ ç‚¹ï¼š
1. ç¡®ä¿å®ç°äº† `queryAddonCommandStatus` æ–¹æ³•
2. æ£€æŸ¥ logo.png æ˜¯å¦å­˜åœ¨ä¸”ä¸º 44x44 åƒç´ 
3. ç¡®è®¤ JSB.defineClass åŒ…å«äº†é™æ€æ–¹æ³•å‚æ•°
4. æŸ¥çœ‹æ§åˆ¶å°æ˜¯å¦æœ‰é”™è¯¯ä¿¡æ¯

**Q: æ’ä»¶å¼€å‘å¿…é¡»è¦ Mac å—ï¼Ÿ**
A: æ˜¯çš„ï¼Œè°ƒè¯•å’Œæµ‹è¯•éœ€è¦ Mac ç‰ˆæœ¬çš„ MarginNoteã€‚iOS ç‰ˆæœ¬æ— æ³•ä½¿ç”¨ Safari è¿›è¡Œè°ƒè¯•ã€‚

### å¼€å‘é—®é¢˜

**Q: ä¸ºä»€ä¹ˆæ’ä»¶åŠ è½½åç«‹å³é—ªé€€ï¼Ÿ**
A: å¸¸è§åŸå› ï¼š
1. åœ¨ JSB.newAddon å†…éƒ¨è°ƒç”¨äº† JSB.require
2. ä½¿ç”¨äº†ä¸å…¼å®¹çš„ ES6 è¯­æ³•
3. åˆå§‹åŒ–æ—¶è®¿é—®äº†æœªå®šä¹‰çš„å¯¹è±¡
4. æ²¡æœ‰æ­£ç¡®ä¿å­˜ self å¼•ç”¨

**Q: å¦‚ä½•è°ƒè¯•æ’ä»¶ä»£ç ï¼Ÿ**
A: ç”±äºå®‰å…¨é™åˆ¶ï¼Œä¸èƒ½ä½¿ç”¨æ–­ç‚¹è°ƒè¯•ã€‚æ¨èæ–¹æ³•ï¼š
```javascript
// ä½¿ç”¨ showHUD æ˜¾ç¤ºè°ƒè¯•ä¿¡æ¯
Application.sharedInstance().showHUD("Debug: " + value, self.window, 2);

// ä½¿ç”¨ alert æš‚åœæ‰§è¡Œ
Application.sharedInstance().alert("æ–­ç‚¹ï¼š" + JSON.stringify(data));

// ä½¿ç”¨ MNUtil.logï¼ˆå¦‚æœå®‰è£…äº† MNUtilsï¼‰
MNUtil.log("è°ƒè¯•ä¿¡æ¯", data);
```

**Q: ä¸ºä»€ä¹ˆä¿®æ”¹ç¬”è®°åä¸èƒ½æ’¤é”€ï¼Ÿ**
A: éœ€è¦ä½¿ç”¨ UndoManager åŒ…è£…ä¿®æ”¹æ“ä½œï¼š
```javascript
UndoManager.sharedInstance().undoGrouping(
  "æ“ä½œåç§°",
  notebookId,
  function() {
    // ä½ çš„ä¿®æ”¹ä»£ç 
    note.noteTitle = "æ–°æ ‡é¢˜";
  }
);
```

### API é—®é¢˜

**Q: å¦‚ä½•è·å–å½“å‰é€‰ä¸­çš„ç¬”è®°ï¼Ÿ**
A: æœ‰å¤šç§æ–¹å¼ï¼š
```javascript
// ä½¿ç”¨ MNUtilsï¼ˆæ¨èï¼‰
const note = MNNote.getFocusNote();

// åŸç”Ÿ API
const mindmapView = self.studyController.notebookController.mindmapView;
const focusNote = mindmapView.focusNote;
```

**Q: å¦‚ä½•æ‰¹é‡å¤„ç†ç¬”è®°ï¼Ÿ**
A: ä½¿ç”¨ undoGrouping åŒ…è£…æ‰¹é‡æ“ä½œï¼š
```javascript
MNUtil.undoGrouping(() => {
  notebook.notes.forEach(note => {
    // å¤„ç†æ¯ä¸ªç¬”è®°
    note.colorIndex = 2;
  });
});
```

**Q: å¦‚ä½•ç›‘å¬ç³»ç»Ÿäº‹ä»¶ï¼Ÿ**
A: ä½¿ç”¨ NSNotificationCenterï¼š
```javascript
// æ³¨å†Œç›‘å¬
NSNotificationCenter.defaultCenter().addObserver(
  self,
  'onEventHandler:',
  'EventName',
  null
);

// å¤„ç†äº‹ä»¶
onEventHandler: function(sender) {
  const info = sender.userInfo;
  // å¤„ç†äº‹ä»¶
}

// è®°å¾—åœ¨ sceneDidDisconnect ä¸­ç§»é™¤
NSNotificationCenter.defaultCenter().removeObserver(self);
```

### æ€§èƒ½é—®é¢˜

**Q: æ’ä»¶è¿è¡Œå¾ˆæ…¢æ€ä¹ˆåŠï¼Ÿ**
A: ä¼˜åŒ–å»ºè®®ï¼š
1. é¿å…åœ¨å¾ªç¯ä¸­è¿›è¡Œæ•°æ®åº“æ“ä½œ
2. ä½¿ç”¨æ‰¹é‡æ›´æ–°è€Œä¸æ˜¯é€ä¸ªæ›´æ–°
3. ç¼“å­˜å¸¸ç”¨æ•°æ®
4. ä½¿ç”¨é˜²æŠ–/èŠ‚æµå¤„ç†é¢‘ç¹è§¦å‘çš„äº‹ä»¶
5. åŠæ—¶é‡Šæ”¾å¤§å¯¹è±¡å’Œæ¸…ç†å®šæ—¶å™¨

**Q: å¤„ç†å¤§é‡ç¬”è®°æ—¶å¡é¡¿ï¼Ÿ**
A: ä½¿ç”¨å¼‚æ­¥å¤„ç†å’Œè¿›åº¦æç¤ºï¼š
```javascript
async function processLargeNotes(notes) {
  const batchSize = 50;
  for (let i = 0; i < notes.length; i += batchSize) {
    const batch = notes.slice(i, i + batchSize);
    
    // æ˜¾ç¤ºè¿›åº¦
    Application.sharedInstance().showHUD(
      `å¤„ç†ä¸­... ${i}/${notes.length}`, 
      self.window, 
      0.5
    );
    
    // å¤„ç†æ‰¹æ¬¡
    await processBatch(batch);
    
    // è®©å‡ºæ‰§è¡Œæƒ
    await new Promise(resolve => setTimeout(resolve, 10));
  }
}
```

### å‘å¸ƒé—®é¢˜

**Q: å¦‚ä½•è·å¾—å®˜æ–¹è®¤è¯ï¼Ÿ**
A: è”ç³» MarginNote å®˜æ–¹å›¢é˜Ÿï¼Œæä¾›ï¼š
1. æ’ä»¶åŠŸèƒ½è¯´æ˜
2. æºä»£ç å®¡æ ¸
3. æµ‹è¯•æŠ¥å‘Š
4. ç”¨æˆ·æ–‡æ¡£

**Q: æ’ä»¶æ›´æ–°å¦‚ä½•é€šçŸ¥ç”¨æˆ·ï¼Ÿ**
A: å®˜æ–¹è®¤è¯æ’ä»¶å¯ä»¥è‡ªåŠ¨æ¨é€æ›´æ–°ã€‚éè®¤è¯æ’ä»¶éœ€è¦ï¼š
1. åœ¨æ’ä»¶å†…å®ç°ç‰ˆæœ¬æ£€æŸ¥
2. æä¾›æ›´æ–°æç¤ºå’Œä¸‹è½½é“¾æ¥
3. å¼•å¯¼ç”¨æˆ·æ‰‹åŠ¨æ›´æ–°

## ğŸ“¤ æ’ä»¶å•†åº—å‘å¸ƒæµç¨‹

### 1. å‡†å¤‡é˜¶æ®µ

#### å¿…éœ€ææ–™
- âœ… å®Œæ•´çš„æ’ä»¶ä»£ç 
- âœ… 44x44 çš„ logo.png
- âœ… è¯¦ç»†çš„åŠŸèƒ½è¯´æ˜æ–‡æ¡£
- âœ… ä½¿ç”¨æ¼”ç¤ºè§†é¢‘æˆ–æˆªå›¾
- âœ… ç‰ˆæœ¬æ›´æ–°æ—¥å¿—

#### ä»£ç è¦æ±‚
1. **ç¨³å®šæ€§**ï¼šå……åˆ†æµ‹è¯•ï¼Œæ— æ˜æ˜¾ bug
2. **å…¼å®¹æ€§**ï¼šæ”¯æŒ MN3 å’Œ MN4
3. **æ€§èƒ½**ï¼šä¸å½±å“åº”ç”¨æ€§èƒ½
4. **å®‰å…¨æ€§**ï¼šä¸æ”¶é›†ç”¨æˆ·æ•°æ®

### 2. æ‰“åŒ…æ’ä»¶

```bash
# 1. ç¡®ä¿æ–‡ä»¶ç»“æ„æ­£ç¡®
your-plugin/
â”œâ”€â”€ mnaddon.json
â”œâ”€â”€ main.js
â”œâ”€â”€ logo.png
â””â”€â”€ [å…¶ä»–èµ„æºæ–‡ä»¶]

# 2. ä½¿ç”¨ mnaddon å·¥å…·æ‰“åŒ…
mnaddon pack .

# 3. ç”Ÿæˆ your-plugin.mnaddon æ–‡ä»¶
```

### 3. æäº¤æµç¨‹

#### æ–¹å¼ä¸€ï¼šè®ºå›å‘å¸ƒï¼ˆæ¨èæ–°æ‰‹ï¼‰
1. è®¿é—® [MarginNote è®ºå›](https://bbs.marginnote.cn/c/script/Mod/55)
2. åˆ›å»ºæ–°ä¸»é¢˜ï¼ŒåŒ…å«ï¼š
   - æ’ä»¶åç§°å’Œç‰ˆæœ¬
   - åŠŸèƒ½ä»‹ç»
   - ä½¿ç”¨è¯´æ˜
   - ä¸‹è½½é“¾æ¥
   - æºç é“¾æ¥ï¼ˆå¦‚æœå¼€æºï¼‰

#### æ–¹å¼äºŒï¼šå®˜æ–¹å•†åº—
1. è”ç³»å®˜æ–¹ï¼šdeveloper@marginnote.com
2. æä¾›ææ–™ï¼š
   - æ’ä»¶æ–‡ä»¶
   - åŠŸèƒ½æ–‡æ¡£
   - æµ‹è¯•æŠ¥å‘Š
   - å¼€å‘è€…ä¿¡æ¯
3. ç­‰å¾…å®¡æ ¸ï¼ˆé€šå¸¸ 3-7 å¤©ï¼‰
4. å®¡æ ¸é€šè¿‡åä¸Šæ¶

### 4. æ›´æ–°ç»´æŠ¤

#### ç‰ˆæœ¬æ›´æ–°
```json
// mnaddon.json
{
  "version": "1.1.0",  // é€’å¢ç‰ˆæœ¬å·
  "marginnote_version_min": "3.7.11",
  "update_url": "https://yoursite.com/check-update"
}
```

#### æ›´æ–°é€šçŸ¥
```javascript
// å®ç°ç‰ˆæœ¬æ£€æŸ¥
async function checkUpdate() {
  try {
    const response = await fetch(updateUrl);
    const latestVersion = await response.json();
    
    if (compareVersion(latestVersion.version, currentVersion) > 0) {
      Application.sharedInstance().alert(
        `æ–°ç‰ˆæœ¬ ${latestVersion.version} å¯ç”¨ï¼\n` +
        `æ›´æ–°å†…å®¹ï¼š${latestVersion.changelog}`
      );
    }
  } catch (error) {
    // é™é»˜å¤±è´¥
  }
}
```

### 5. ç”¨æˆ·æ”¯æŒ

#### å»ºç«‹åé¦ˆæ¸ é“
1. **GitHub Issues**ï¼šå¼€æºé¡¹ç›®é¦–é€‰
2. **è®ºå›å¸–å­**ï¼šé›†ä¸­å›å¤ç”¨æˆ·é—®é¢˜
3. **é‚®ä»¶æ”¯æŒ**ï¼šæä¾›å¼€å‘è€…é‚®ç®±
4. **ä½¿ç”¨æ–‡æ¡£**ï¼šè¯¦ç»†çš„ README

#### å¤„ç†ç”¨æˆ·åé¦ˆ
- åŠæ—¶å“åº”ç”¨æˆ·é—®é¢˜
- æ”¶é›†åŠŸèƒ½å»ºè®®
- ä¿®å¤æŠ¥å‘Šçš„ bug
- å®šæœŸå‘å¸ƒæ›´æ–°

### 6. æ¨å¹¿å»ºè®®

1. **åˆ¶ä½œæ¼”ç¤ºè§†é¢‘**
   - å±•ç¤ºæ ¸å¿ƒåŠŸèƒ½
   - å®é™…ä½¿ç”¨åœºæ™¯
   - å®‰è£…ä½¿ç”¨æ•™ç¨‹

2. **æ’°å†™ä½¿ç”¨æ•™ç¨‹**
   - å›¾æ–‡å¹¶èŒ‚
   - å¸¸è§é—®é¢˜è§£ç­”
   - ä½¿ç”¨æŠ€å·§åˆ†äº«

3. **ç¤¾åŒºäº’åŠ¨**
   - å‚ä¸è®ºå›è®¨è®º
   - åˆ†äº«å¼€å‘ç»éªŒ
   - å¸®åŠ©å…¶ä»–å¼€å‘è€…

---

> ğŸ’¡ **æç¤º**ï¼šæœ¬æ–‡æ¡£æŒç»­æ›´æ–°ä¸­ã€‚å¦‚æœ‰ç–‘é—®æˆ–å»ºè®®ï¼Œæ¬¢è¿æäº¤ Issue æˆ– PRã€‚ç¥ä½ å¼€å‘å‡ºä¼˜ç§€çš„ MarginNote æ’ä»¶ï¼