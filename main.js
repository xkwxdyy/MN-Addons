JSB.newAddon=function(t){try{JSB.require("mnutils"),MNUtil.init(t)}catch(t){subscriptionUtils.showHUD("Error when loading mnutils: "+t)}JSB.require("mnutils");try{JSB.require("CryptoJS")}catch(t){MNUtil.showHUD("Error when loading CryptoJS: "+t)}try{JSB.require("marked")}catch(t){MNUtil.showHUD("Error when loading marked: "+t)}try{JSB.require("highlight")}catch(t){MNUtil.showHUD("Error when loading highlight: "+t)}try{JSB.require("mustache")}catch(t){MNUtil.showHUD("Error when loading mustache: "+t)}return JSB.defineClass("MNSubscription : JSExtension",{sceneWillConnect:function(){try{self.appInstance=Application.sharedInstance(),subscriptionUtils.init(t),subscriptionConfig.init(),self.isNewWindow=!1,self.watchMode=!1,self.textSelected="",self.textProcessed=!1,self.dateGetText=Date.now(),self.dateNow=Date.now(),self.rect="{{0, 0}, {10, 10}}",self.arrow=1,self.isFirst=!0,MNUtil.addObserver(self,"onPopupMenuOnNote:","PopupMenuOnNote"),MNUtil.addObserver(self,"onPopupMenuOnSelection:","PopupMenuOnSelection"),MNUtil.addObserver(self,"onClosePopupMenuOnNote:","ClosePopupMenuOnNote"),MNUtil.addObserver(self,"onClosePopupMenuOnSelection:","ClosePopupMenuOnSelection")}catch(t){subscriptionUtils.showHUD("Error in sceneWillConnect: "+t)}},sceneDidDisconnect:function(){MNUtil.removeObserver(self,"PopupMenuOnNote"),MNUtil.removeObserver(self,"PopupMenuOnSelection"),MNUtil.removeObserver(self,"ClosePopupMenuOnNote"),MNUtil.removeObserver(self,"ClosePopupMenuOnSelection")},onPopupMenuOnNote:function(t){var i;self.window===MNUtil.currentWindow&&(t=t.userInfo.note.noteId,i=Date.now(),MNUtil.popUpNoteInfo={time:i,noteId:t})},onClosePopupMenuOnNote:function(t){self.window===MNUtil.currentWindow&&MNUtil.popUpNoteInfo&&t.userInfo.noteid===MNUtil.popUpNoteInfo.noteId&&MNUtil.delay(1).then(()=>{MNUtil.popUpNoteInfo=void 0})},onPopupMenuOnSelection:function(t){var i;self.window===MNUtil.currentWindow&&(i=Date.now(),t=t.userInfo.documentController,MNUtil.popUpSelectionInfo={time:i,docController:t})},onClosePopupMenuOnSelection:async function(t){self.window===MNUtil.currentWindow&&(await MNUtil.delay(.01),MNUtil.popUpSelectionInfo)&&t.userInfo.documentController===MNUtil.popUpSelectionInfo.docController&&!t.userInfo.documentController.imageFromSelection()&&(MNUtil.popUpSelectionInfo=void 0)},sceneWillResignActive:function(){},sceneDidBecomeActive:function(){},notebookWillOpen:function(t){try{subscriptionUtils.checkSubscriptionController(),MNUtil.studyMode<3?(subscriptionUtils.refreshAddonCommands(),subscriptionUtils.subscriptionController.view.hidden=!0,subscriptionUtils.subscriptionController.notebookid=t,self.notebookid=t,subscriptionUtils.subscriptionController.view.frame={x:50,y:100,width:270,height:subscriptionConfig.frameHeight},subscriptionUtils.subscriptionController.currentFrame={x:50,y:100,width:270,height:subscriptionConfig.frameHeight},NSTimer.scheduledTimerWithTimeInterval(.2,!1,function(){MNUtil.studyView.becomeFirstResponder()})):subscriptionUtils.subscriptionController&&(subscriptionUtils.subscriptionController.view.hidden=!0),subscriptionConfig.autoSubscribe()}catch(t){subscriptionUtils.addErrorLog(t,"notebookWillOpen")}},onCloudConfigChange:async function(t){MNUtil.postNotification("cloudConfigChange",t.userInfo)},notebookWillClose:function(t){},documentDidOpen:function(t){},documentWillClose:function(t){},controllerWillLayoutSubviews:function(t){var i;t!==subscriptionUtils.studyController()||(3===subscriptionUtils.studyController().studyMode&&subscriptionUtils.subscriptionController&&(subscriptionUtils.subscriptionController.view.hidden=!0),subscriptionUtils.subscriptionController.view.hidden)||(t=subscriptionUtils.studyView().bounds,(i=subscriptionUtils.subscriptionController.currentFrame).x+.5*i.width>=t.width&&(i.x=t.width-.5*i.width),i.y>=t.height&&(i.y=t.height-20),subscriptionUtils.subscriptionController.view.frame=i,subscriptionUtils.subscriptionController.currentFrame=i)},queryAddonCommandStatus:function(){return{image:"logo.png",object:self,selector:"toggleAddon:",checked:subscriptionConfig.isSubscribed()}},toggleAddon:async function(t){try{var i;subscriptionUtils.ensureView(subscriptionUtils.subscriptionController.view),self.addonBar||(self.addonBar=t.superview.superview,subscriptionUtils.addonBar=self.addonBar),self.isFirst&&(0===(i=self.addonBar.frame).x?subscriptionUtils.subscriptionController.view.frame={x:40,y:i.y,width:270,height:subscriptionConfig.frameHeight}:subscriptionUtils.subscriptionController.view.frame={x:i.x-270,y:i.y,width:270,height:subscriptionConfig.frameHeight},subscriptionUtils.subscriptionController.currentFrame=subscriptionUtils.subscriptionController.view.frame,self.isFirst=!1),subscriptionUtils.subscriptionController.view.hidden?subscriptionUtils.subscriptionController.show(self.addonBar.frame):subscriptionUtils.subscriptionController.hide(self.addonBar.frame)}catch(t){subscriptionUtils.showHUD(t)}}},{addonDidConnect:function(){},addonWillDisconnect:function(){},applicationWillEnterForeground:async function(){await MNUtil.delay(.01),subscriptionConfig.autoSubscribe(!1)},applicationDidEnterBackground:function(){},applicationDidReceiveLocalNotification:function(t){}})};const getSubscriptionController=()=>self;var subscriptionController=JSB.defineClass("subscriptionController : UIViewController <NSURLConnectionDelegate,UIWebViewDelegate>",{viewDidLoad:function(){try{self.custom=!1,self.customMode="None",self.dynamic=!0,self.miniMode=!1,self.isLoading=!1,self.lastFrame=self.view.frame,self.currentFrame=self.view.frame,self.color=["#ffffb4","#ccfdc4","#b4d1fb","#f3aebe","#ffff54","#75fb4c","#55bbf9","#ea3323","#ef8733","#377e47","#173dac","#be3223","#ffffff","#dadada","#b4b4b4","#bd9fdc"],self.mode=0,self.moveDate=Date.now(),self.init(),subscriptionConfig.save()}catch(t){subscriptionUtils.showHUD("Error in viewDidLoad: "+t)}},viewWillAppear:t=>{},viewWillDisappear:t=>{},viewWillLayoutSubviews:()=>{self.layoutSubviews()},connectionDidReceiveResponse:async function(t,i){self.statusCode=i.statusCode(),400<=self.statusCode?(MNUtil.stopHUD(),MNUtil.showHUD(MNUtil.getStatusCodeDescription(""+self.statusCode))):(self.onDownloading=!0,self.currentData=NSMutableData.new(),self.expectedContentLength=i.expectedContentLength())},connectionDidReceiveData:async function(t,i){try{400<=self.statusCode?self.onDownloading=!1:(self.currentData.appendData(i),MNUtil.waitHUD("Downloading: "+(self.currentData.length()/self.expectedContentLength*100).toFixed(2)+"%"))}catch(t){subscriptionUtils.addErrorLog(t,"connectionDidReceiveData")}},connectionDidFinishLoading:function(t){try{self.onDownloading=!1,400<=self.statusCode||(self.targetPath&&(self.currentData.writeToFileAtomically(self.targetPath,!1),self.addonPath)&&(ZipArchive.unzipFileAtPathToDestination(self.targetPath,self.addonPath),MNUtil.waitHUD("Install success! Please restart MN manually")),MNUtil.delay(1).then(()=>{MNUtil.stopHUD()}))}catch(t){MNUtil.stopHUD(),subscriptionUtils.addErrorLog(t,"connectionDidFinishLoading")}},connectionDidFailWithError:function(t,i){self.onDownloading=!1,MNUtil.showHUD("connectionDidFailWithError")},webViewDidFinishLoad:async function(t){var i=getSubscriptionController(),e=t.request.URL().absoluteString();/^https\:\/\/afdian.com\/message\//.test(e)&&(await MNUtil.delay(1),e=await i.getApikeyFromWebview(t))&&await MNUtil.confirm("Subscribe via key ["+e+"]?","用 key ["+e+"] 订阅？")&&(i.apikeyInput.text=e,i.apikeyInput.editable=!0,MNButton.setColor(i.showAPIKeyButton,"#e06c75"),subscriptionUtils.showHUD("Save APIKey"),subscriptionConfig.save(),i.activate())},webViewShouldStartLoadWithRequestNavigationType:function(t,i,e){let s=getSubscriptionController(),o=i.URL().absoluteString();if(/^https?\:\/\/.*\.mnaddon$/.test(o)){let s=MNUtil.getFileName(o);return MNUtil.confirm("Install mnaddon: "+s+"?","安装插件: "+s+"？").then(async t=>{var i,e;t&&(MNUtil.showHUD("Download: "+s),t=subscriptionUtils.mainPath+"/"+s,(await MNConnection.fetch(o)).writeToFileAtomically(t,!1),MNUtil.showHUD("Get addonid..."),ZipArchive.unzipFileAtPathToDestination(t,subscriptionUtils.mainPath+"/temp"),i=MNUtil.readJSON(subscriptionUtils.mainPath+"/temp/mnaddon.json"))&&"addonid"in i&&(e=subscriptionUtils.extensionPath+"/"+i.addonid,ZipArchive.unzipFileAtPathToDestination(t,e),MNUtil.showHUD(`Install mnaddon [${i.title}] success! Please restart MN manually`))}),!1}if(t.sidebar&&/^https?\:\/\//.test(o))return s.docview.hidden&&s.view.frame.x+650<MNUtil.studyView.frame.width&&((i=s.view.frame).width=650,i.height<500&&(i.height=500),s.view.frame=i,s.currentFrame=i,s.view.setNeedsLayout()),600<s.view.frame.width&&(MNUtil.showHUD("Loading Document..."),MNConnection.loadRequest(s.docview,o)),!1;if(/^mnaddon\:\/\//.test(o)){if(s.onDownloading)MNUtil.showHUD("Wait...");else{var n=decodeURIComponent(o).split("action=")[1].split("?");let e={action:n[0]};for(let t=1;t<n.length;t++){var r=n[t].split("=");e[r[0]]=r[1]}if("install"===(e=subscriptionConfig.mnaddon.filter(t=>t.id===e.id)[0]).action||"update"===e.action)subscriptionNetwork.downloadFromConfig(e,s);else if("reinstall"===e.action)if("history"in e){let i=e.history.map(t=>t.version);MNUtil.userSelect("Choose a history version","选择历史版本",i).then(t=>{t&&(t=i[t-1],e.version=t,subscriptionNetwork.downloadFromConfig(e,s))})}else MNUtil.confirm("Re-install this addon?","重新安装该插件？").then(async t=>{t&&subscriptionNetwork.downloadFromConfig(e,s)})}return!1}return!0},scrollViewDidScroll:function(){},chooseAPIKeyForQuota:async function(){var t,i=getSubscriptionController(),e=["https://ifdian.net/order/create?product_type=1&plan_id=a6ed8b60fbcf11ee941152540025c377&sku=%5B%7B%22sku_id%22:%22b24e214cfd3f11eebc335254001e7c00%22,%22count%22:1%7D%5D","https://ifdian.net/order/create?product_type=1&plan_id=a6ed8b60fbcf11ee941152540025c377&sku=%5B%7B%22sku_id%22:%22a58e5502146f11efa4fa5254001e7c00%22,%22count%22:1%7D%5D","https://ifdian.net/order/create?product_type=1&plan_id=a6ed8b60fbcf11ee941152540025c377&sku=%5B%7B%22sku_id%22:%2279e3e74a147011efb46e52540025c377%22,%22count%22:1%7D%5D","https://ifdian.net/order/create?product_type=1&plan_id=a6ed8b60fbcf11ee941152540025c377&sku=%5B%7B%22sku_id%22%3A%22e87e8a7432f811efaa1552540025c377%22,%22count%22%3A1%7D%5D"];switch(await MNUtil.userSelect("Select APIKey for quota","选择要购买的额度",["5 Points (5¥)","10 Points (9.5¥)","20 Points (19¥)","50 Points (45¥)"])){case 0:return;case 1:MNConnection.loadRequest(i.docview,e[0]);break;case 2:MNConnection.loadRequest(i.docview,e[1]);break;case 3:MNConnection.loadRequest(i.docview,e[2]);break;case 4:MNConnection.loadRequest(i.docview,e[3]);break;default:return}i.docview.hidden&&((t=i.view.frame).width=650,i.view.frame=t,i.currentFrame=t,i.view.setNeedsLayout())},openURL:function(t){var i;self.docview.hidden&&((i=self.view.frame).width=650,self.view.frame=i,self.currentFrame=i,self.view.setNeedsLayout()),MNUtil.showHUD("Open url..."),MNConnection.loadRequest(self.docview,t.url)},changeURL:function(t){self.popoverController&&self.popoverController.dismissPopoverAnimated(!0);var i=subscriptionConfig.getConfig("url"),e="changeURLTo:",e=[MNUtil.tableItem("URL1 (default)",self,e,"https://api.feliks.top","https://api.feliks.top"===i),MNUtil.tableItem("URL2",self,e,"https://api1.feliks.top","https://api1.feliks.top"===i),MNUtil.tableItem("URL3",self,e,"https://alpha.u1162561.nyat.app:20075","https://alpha.u1162561.nyat.app:20075"===i),MNUtil.tableItem("URL4",self,e,"https://api.u1162561.nyat.app:20074","https://api.u1162561.nyat.app:20074"===i),MNUtil.tableItem("URL5",self,e,"https://d2p9226849.vicp.fun","https://d2p9226849.vicp.fun"===i)];self.popoverController=MNUtil.getPopoverAndPresent(t,e,200,2)},changeURLTo:function(t){self.popoverController&&self.popoverController.dismissPopoverAnimated(!0),subscriptionConfig.config.url=t,subscriptionConfig.save(),self.URLButton.setTitleForState(subscriptionUtils.getURLTitle(),0)},changeView:function(t){Menu.dismissCurrentMenu(),self.popoverController&&self.popoverController.dismissPopoverAnimated(!0);var i=subscriptionConfig.getConfig("lastView"),t=new Menu(t,self);t.width=250,t.rowHeight=35,t.preferredPosition=1,t.addMenuItem("💲  Subscription Manager","setViewTo:","subscriptionView","subscriptionView"===i),t.addMenuItem("🎛️  Update Manager","setViewTo:","webview","webview"===i),t.addMenuItem("🎛️  Update Manager (α)","setViewTo:","webviewAlpha","webviewAlpha"===i),t.addMenuItem("🎛️  MNAddon Panel","showPanel:","setting","setting"===i),t.addMenuItem("🗺️  Update Roadmap","setViewTo:","roadmap","roadmap"===i),t.addMenuItem("❌  Force to Crash","force2Crash:","sidebar","sidebar"===i),t.show()},setViewTo:async function(t){var i=getSubscriptionController();try{switch(Menu.dismissCurrentMenu(),t){case"subscriptionView":i.subscriptionView.hidden=!1,i.webview.hidden=!0,MNButton.setTitle(i.moveButton,"Subscription Manager",void 0,!0),subscriptionConfig.config.lastView="subscriptionView";break;case"webview":i.subscriptionView.hidden=!0,i.webview.hidden=!1,MNButton.setTitle(i.moveButton,"Update Manager",void 0,!0),i.refreshSidebar(),subscriptionConfig.config.lastView="webview";break;case"roadmap":MNUtil.postNotification("openInBrowser",{url:"https://mnaddon.craft.me/roadmap"});break;case"webviewAlpha":i.subscriptionView.hidden=!0,i.webview.hidden=!1,MNButton.setTitle(i.moveButton,"Update Manager (α)",void 0,!0),i.refreshSidebar(!0,!0),subscriptionConfig.config.lastView="webviewAlpha"}subscriptionConfig.save(),i.view.setNeedsLayout()}catch(t){MNUtil.showHUD(t)}},force2Crash:function(t){MNUtil.studyView.frame={x:void 0}},showPanel:function(t){self.popoverController&&self.popoverController.dismissPopoverAnimated(!0),"sidebar"===t?MNExtensionPanel.toggle():MNUtil.excuteCommand("OpenExtensions")},pasteApiKey:async function(t){var i=MNUtil.clipboardText.trim();i.startsWith("sk-")?(MNButton.setColor(self.showAPIKeyButton,"#e06c75"),self.apikeyInput.text=i,self.apikeyInput.editable=!0,subscriptionUtils.showHUD("Save APIKey"),subscriptionConfig.save(),await MNUtil.confirm("Activate now?","现在激活?")&&self.activate()):MNUtil.confirm("Invalid APIKey","无效的APIKey\n应为sk-xxxxxx")},toggleApikey:function(t){var i;self.apikeyInput.text&&self.apikeyInput.text.trim()?(self.apikeyInput.text="",self.apikeyInput.editable=!1,MNButton.setColor(self.showAPIKeyButton,"#a2a2a2")):(self.apikeyInput.editable=!0,subscriptionConfig.config.apikey.trim()?(i=subscriptionConfig.getConfig("apikey").trim(),self.apikeyInput.text=i,self.showAPIKeyButton.color="#e06c75",MNUtil.copy(i),MNUtil.showHUD("APIKey 已复制")):(self.showAPIKeyButton.color="#a2a2a2",MNUtil.showHUD("No APIKey")))},refreshUsage:async function(t){var i=getSubscriptionController(),e=(subscriptionUtils.showHUD("Fetching usage"),await subscriptionNetwork.getUsage());"error"in e?i.usageButton.setTitleForState(e.error,0):i.usageButton.setTitleForState(`Usage: ${(e.usage/100).toFixed(2)} / `+e.total.toFixed(2),0)},showDetail:function(t){var i;self.docview.hidden&&((i=self.view.frame).width=650,self.view.frame=i,self.currentFrame=i,self.view.setNeedsLayout()),MNUtil.copy(subscriptionConfig.getConfig("apikey")),MNUtil.showHUD("APIKey 已复制, 粘贴到右侧输入框后查询"),self.docview.loadFileURLAllowingReadAccessToURL(NSURL.fileURLWithPath(subscriptionUtils.mainPath+"/usage.html"),NSURL.fileURLWithPath(subscriptionUtils.mainPath+"/"))},chooseActivateDays:function(t){var i;self.popoverController&&self.popoverController.dismissPopoverAnimated(!0),!subscriptionConfig.config.activated&&subscriptionConfig.config.subscriptionDaysRemain||!subscriptionConfig.isSubscribed()&&subscriptionConfig.config.subscriptionDaysRemain?(subscriptionConfig.config.activated=!0,subscriptionConfig.config.subscribedDay=subscriptionUtils.getToday(),subscriptionConfig.config.subscriptionDaysRemain=subscriptionConfig.config.subscriptionDaysRemain-1,subscriptionConfig.save(),subscriptionUtils.refreshAddonCommands(),self.activationStatus.setTitleForState(subscriptionConfig.getStatus(),0),subscriptionUtils.showHUD("Subscription days remian: "+subscriptionConfig.config.subscriptionDaysRemain)):(i="activate:",i=[MNUtil.tableItem("1 day",self,i,1),MNUtil.tableItem("5 days",self,i,5),MNUtil.tableItem("10 days",self,i,10),MNUtil.tableItem("15 days",self,i,15),MNUtil.tableItem("20 days",self,i,20),MNUtil.tableItem("25 days",self,i,25),MNUtil.tableItem("30 days",self,i,30)],self.popoverController=MNUtil.getPopoverAndPresent(t,i,100,1))},activate:async function(t=1){self.popoverController&&self.popoverController.dismissPopoverAnimated(!0);var i=self.apikeyInput.text.trim(),i=(i&&(subscriptionConfig.config.apikey=i),await subscriptionNetwork.subscribe(t));i.success?"error"in(t=await subscriptionNetwork.getUsage())?self.usageButton.setTitleForState(t.error,0):self.usageButton.setTitleForState(`Usage: ${(t.usage/100).toFixed(2)} / `+t.total.toFixed(2),0):(self.autoSubscription.setTitleForState(subscriptionConfig.config.autoSubscription?"Auto subscription: ✅":"Auto subscription: ❌",0),subscriptionConfig.save())},toggleAutoSubscription:async function(t){try{var i=subscriptionConfig.getConfig("autoSubscription");subscriptionConfig.config.autoSubscription=!i,subscriptionConfig.save(),self.autoSubscription.setTitleForState(subscriptionConfig.config.autoSubscription?"Auto subscription: ✅":"Auto subscription: ❌",0)}catch(t){subscriptionUtils.showHUD(t)}},changeOpacity:function(t){self.popoverController&&self.popoverController.dismissPopoverAnimated(!0);var i=[{title:"100%",object:self,selector:"changeOpacityTo:",param:1},{title:"90%",object:self,selector:"changeOpacityTo:",param:.9},{title:"80%",object:self,selector:"changeOpacityTo:",param:.8},{title:"70%",object:self,selector:"changeOpacityTo:",param:.7},{title:"60%",object:self,selector:"changeOpacityTo:",param:.6},{title:"50%",object:self,selector:"changeOpacityTo:",param:.5}];self.popoverController=subscriptionUtils.getPopoverAndPresent(t,i,100)},changeOpacityTo:function(t){self.view.layer.opacity=t},closeButtonTapped:function(){self.hide(subscriptionUtils.addonBar.frame)},refreshButtonTapped:async function(t){var i;"subscriptionView"==subscriptionConfig.config.lastView?"error"in(i=await subscriptionNetwork.getUsage())?self.usageButton.setTitleForState(i.error,0):self.usageButton.setTitleForState(`Usage: ${(i.usage/100).toFixed(2)} / `+i.total.toFixed(2),0):t.clickDate&&Date.now()-t.clickDate<500?(self.webview.loadFileURLAllowingReadAccessToURL(NSURL.fileURLWithPath(subscriptionUtils.mainPath+"/sidebar.html"),NSURL.fileURLWithPath(subscriptionUtils.mainPath+"/")),MNUtil.delay(.5).then(()=>{self.refreshSidebar(!1)})):(self.refreshSidebar(!0,subscriptionConfig.getConfig("alpha")),t.clickDate=Date.now())},onMoveGesture:function(i){try{var e,s,o=i.locationInView(MNUtil.studyView),n=(100<Date.now()-self.moveDate&&(e=i.translationInView(MNUtil.sudyView),s=i.locationInView(self.view),1===i.state)&&(i.locationToBrowser={x:s.x-e.x,y:s.y-e.y}),self.moveDate=Date.now(),{x:o.x-i.locationToBrowser.x,y:o.y-i.locationToBrowser.y}),r=self.view.frame,a=MNUtil.studyView.bounds;let t=n.y;(t=t<=0?0:t)>=a.height-15&&(t=a.height-15);var c=n.x;self.custom?(self.customMode="None",self.view.frame={x:c,y:t,width:self.lastFrame.width,height:self.lastFrame.height}):self.view.frame={x:c,y:t,width:r.width,height:r.height},self.currentFrame=self.view.frame,self.custom=!1}catch(t){subscriptionUtils.addErrorLog(t,"onMoveGesture")}},onResizeGesture0:function(t){self.custom=!1,self.customMode="none";var i=t.view.frame,e=t.locationInView(self.view),s=self.view.frame;let o=e.x+.5*i.width;e=self.view.frame.height;o<=270&&(o=270),self.view.frame={x:s.x,y:s.y,width:o,height:e},self.currentFrame=self.view.frame,350<o?(self.webview.frame=MNUtil.genFrame(0,30,300,e-30),self.docview.frame=MNUtil.genFrame(305,30,o-305,e-30),self.docview.hidden=!1):(self.webview.frame=MNUtil.genFrame(0,30,o,e-30),self.docview.hidden=!0),3===t.state&&MNUtil.studyView.bringSubviewToFront(self.view)},onResizeGesture:function(t){self.custom=!1,self.dynamic=!1;var i=t.view.frame,t=t.locationInView(t.view),e=self.view.frame;let s=t.x+i.x+.3*i.width,o=t.y+i.y+.3*i.height;s<=270&&(s=270),o<=subscriptionConfig.frameHeight&&(o=subscriptionConfig.frameHeight),self.view.frame={x:e.x,y:e.y,width:s,height:o},350<s?(self.webview.frame=MNUtil.genFrame(0,30,270,o-30),self.docview.frame=MNUtil.genFrame(275,30,s-275,o-30),self.docview.hidden=!1):(self.webview.frame=MNUtil.genFrame(0,30,s,o-30),self.docview.hidden=!0),self.currentFrame=self.view.frame},onLongPress:async function(t){if(1===t.state){getSubscriptionController();t=t.view;if(t.url)MNUtil.openURL(t.url);else if("chooseAPIKeyForQuota"===t.id){var i=["https://ifdian.net/order/create?product_type=1&plan_id=a6ed8b60fbcf11ee941152540025c377&sku=%5B%7B%22sku_id%22:%22b24e214cfd3f11eebc335254001e7c00%22,%22count%22:1%7D%5D","https://ifdian.net/order/create?product_type=1&plan_id=a6ed8b60fbcf11ee941152540025c377&sku=%5B%7B%22sku_id%22:%22a58e5502146f11efa4fa5254001e7c00%22,%22count%22:1%7D%5D","https://ifdian.net/order/create?product_type=1&plan_id=a6ed8b60fbcf11ee941152540025c377&sku=%5B%7B%22sku_id%22:%2279e3e74a147011efb46e52540025c377%22,%22count%22:1%7D%5D","https://ifdian.net/order/create?product_type=1&plan_id=a6ed8b60fbcf11ee941152540025c377&sku=%5B%7B%22sku_id%22%3A%22e87e8a7432f811efaa1552540025c377%22,%22count%22%3A1%7D%5D"];switch(await MNUtil.userSelect("Select APIKey for quota","选择要购买的额度",["5 Points (5¥)","10 Points (9.5¥)","20 Points (19¥)","50 Points (45¥)"])){case 0:return;case 1:MNUtil.openURL(i[0]);break;case 2:MNUtil.openURL(i[1]);break;case 3:MNUtil.openURL(i[2]);break;case 4:MNUtil.openURL(i[3]);break;default:return}}}}});function tryCatch(i){return function(...t){try{return i(...t)}catch(t){return MNUtil.showHUD(t),null}}}subscriptionController.prototype.init=function(){try{this.homeImage=MNUtil.getImage(subscriptionUtils.mainPath+"/home.png",2),this.homeImage=MNUtil.getImage(subscriptionUtils.mainPath+"/home.png",2),this.bothModeImage=MNUtil.getImage(subscriptionUtils.mainPath+"/bothMode.png",2),this.goforwardImage=MNUtil.getImage(subscriptionUtils.mainPath+"/goforward.png",2),this.screenImage=MNUtil.getImage(subscriptionUtils.mainPath+"/screen.png",2),this.snipasteImage=MNUtil.getImage(subscriptionUtils.mainPath+"/snipaste.png",2),this.closeImage=MNUtil.getImage(subscriptionUtils.mainPath+"/stop.png",2),this.view.layer.shadowOffset={width:0,height:0},this.view.layer.shadowRadius=15,this.view.layer.shadowOpacity=.5,this.view.layer.shadowColor=UIColor.colorWithWhiteAlpha(.5,1),this.view.layer.opacity=1,this.view.layer.cornerRadius=15,this.view.backgroundColor=UIColor.whiteColor().colorWithAlphaComponent(0),this.highlightColor=UIColor.blendedColor(UIColor.colorWithHexString("#2c4d81").colorWithAlphaComponent(.8),Application.sharedInstance().defaultTextColor,.8),this.moveButton=MNButton.new({title:"Subscription Manager",bold:!0,font:16,radius:8,color:"#457bd3",highlight:this.highlightColor,opacity:.8},this.view),this.moveButton.addClickAction(this,"changeView:"),this.closeButton=MNButton.new({image:subscriptionUtils.mainPath+"/stop.png",radius:8,color:"#e06c75",opacity:.8},this.view),this.closeButton.addClickAction(this,"closeButtonTapped:"),this.refreshButton=MNButton.new({image:subscriptionUtils.mainPath+"/reload.png",radius:8,color:"#457bd3",opacity:.8},this.view),this.refreshButton.addClickAction(this,"refreshButtonTapped:"),this.subscriptionView=UIView.new(),this.subscriptionView.backgroundColor=UIColor.whiteColor().colorWithAlphaComponent(.8),this.subscriptionView.layer.cornerRadius=13,this.subscriptionView.hidden=!1,this.view.addSubview(this.subscriptionView),this.webview=new UIWebView(this.view.bounds),this.webview.backgroundColor=UIColor.whiteColor(),this.webview.scalesPageToFit=!0,this.webview.autoresizingMask=18,((this.webview.delegate=this).webview.scrollView.delegate=this).webview.scrollView.bounces=!1,this.webview.layer.cornerRadius=15,this.webview.layer.masksToBounds=!0,this.webview.layer.borderColor=MNUtil.hexColorAlpha("#9bb2d6",.8),this.webview.layer.borderWidth=0,this.webview.sidebar=!0,this.docview=new UIWebView(this.view.bounds),this.docview.backgroundColor=UIColor.whiteColor(),this.docview.scalesPageToFit=!0,this.docview.autoresizingMask=18,((this.docview.delegate=this).docview.scrollView.delegate=this).docview.scrollView.bounces=!1,this.docview.layer.cornerRadius=15,this.docview.layer.masksToBounds=!0,this.docview.layer.borderColor=MNUtil.hexColorAlpha("#9bb2d6",.8),this.docview.layer.borderWidth=0,this.docview.sidebar=!1,this.docview.customUserAgent="Mozilla/5.0 (iPhone; CPU iPhone OS 15_0 like Mac OS X) AppleWebKit/605.1.15 (KHTML, like Gecko) Mobile/15E148",this.highlightColor=UIColor.blendedColor(MNUtil.hexColorAlpha("#2c4d81",.8),MNUtil.app.defaultTextColor,.8),this.webview.hidden=!0,this.docview.hidden=!0,this.webview.lastOffset=0,this.view.addSubview(this.webview),this.view.addSubview(this.docview),this.webview.loadFileURLAllowingReadAccessToURL(NSURL.fileURLWithPath(subscriptionUtils.mainPath+"/sidebar.html"),NSURL.fileURLWithPath(subscriptionUtils.mainPath+"/")),this.activationStatus=MNButton.new({title:subscriptionConfig.getStatus(),bold:!0,font:14,radius:10,color:"#457bd3",highlight:this.highlightColor,opacity:.8},this.subscriptionView),this.activationStatus.addClickAction(this,"chooseActivateDays:");var t=subscriptionConfig.getConfig("autoSubscription");switch(this.autoSubscription=MNButton.new({title:t?"Auto subscription: ✅":"Auto subscription: ❌",bold:!0,font:14,radius:10,color:"#457bd3",highlight:this.highlightColor,opacity:.8},this.subscriptionView),this.autoSubscription.addClickAction(this,"toggleAutoSubscription:"),this.freeUsage=MNButton.new({title:subscriptionConfig.getFreeUsage(),bold:!0,font:14,radius:10,color:"#457bd3",highlight:this.highlightColor,opacity:.8},this.subscriptionView),this.usageButton=MNButton.new({title:"Refresh Usage",bold:!0,font:14,radius:10,color:"#457bd3",highlight:this.highlightColor,opacity:.8},this.subscriptionView),this.usageButton.addClickAction(this,"refreshUsage:"),this.usageDetailButton=MNButton.new({title:"Usage Detail",bold:!0,font:14,radius:10,color:"#457bd3",highlight:this.highlightColor,opacity:.8},this.subscriptionView),this.usageDetailButton.addClickAction(this,"showDetail:"),this.URLButton=MNButton.new({title:subscriptionUtils.getURLTitle(),bold:!0,font:14,radius:10,color:"#457bd3",highlight:this.highlightColor,opacity:.8},this.subscriptionView),this.URLButton.addClickAction(this,"changeURL:"),this.apikeyInput=this.creatTextView("subscriptionView",void 0,.75),this.apikeyInput.editable=!1,this.apikeyInput.text="",this.pasteKeyButton=MNButton.new({title:"Paste",bold:!0,font:14,radius:8,color:"#e06c75",highlight:this.highlightColor,opacity:.8},this.subscriptionView),this.pasteKeyButton.addClickAction(this,"pasteApiKey:"),this.showAPIKeyButton=MNButton.new({image:subscriptionUtils.mainPath+"/vision.png",radius:8,color:"#a2a2a2",opacity:.8},this.subscriptionView),this.showAPIKeyButton.addClickAction(this,"toggleApikey:"),this.DMButton=MNButton.new({title:"Show APIKey in DM",bold:!0,font:14,highlight:this.highlightColor,radius:10,color:"#e06c75",opacity:.8,url:"https://afdian.com/message/929697869e9311eea6745254001e7c00"},this.subscriptionView),this.DMButton.addClickAction(this,"openURL:"),this.DMButton.addLongPressGesture(this,"onLongPress:"),this.buyAPIKeyButton=MNButton.new({title:"Buy APIKey",bold:!0,font:14,highlight:this.highlightColor,radius:10,color:"#9bb2d6",id:"chooseAPIKeyForQuota"},this.subscriptionView),this.buyAPIKeyButton.addClickAction(this,"chooseAPIKeyForQuota:"),this.buyAPIKeyButton.addLongPressGesture(this,"onLongPress:"),this.resizeButton=MNButton.new({image:subscriptionUtils.mainPath+"/curve.png",radius:10,color:"#e06c75",opacity:.8,alpha:0},this.view),this.moveButton.addPanGesture(this,"onMoveGesture:"),this.closeButton.addPanGesture(this,"onResizeGesture0:"),this.resizeButton.addPanGesture(this,"onResizeGesture:"),subscriptionConfig.getConfig("lastView")){case"subscriptionView":this.subscriptionView.hidden=!1,this.webview.hidden=!0,this.moveButton.setTitle("Subscription Manager"),subscriptionConfig.config.lastView="subscriptionView";break;case"webview":this.subscriptionView.hidden=!0,this.webview.hidden=!1,this.moveButton.setTitle("Update Manager"),MNUtil.delay(.5).then(()=>{this.refreshSidebar()}),subscriptionConfig.config.lastView="webview";break;case"webviewAlpha":this.subscriptionView.hidden=!0,this.webview.hidden=!1,this.moveButton.setTitle("Update Manager (α)"),MNUtil.delay(.5).then(()=>{this.refreshSidebar(!0,!0)}),subscriptionConfig.config.lastView="webviewAlpha"}}catch(t){subscriptionUtils.addErrorLog(t,"init")}},subscriptionController.prototype.show=function(t){this.view.frame;let i=this.view.layer.opacity;"marginnote3"===subscriptionUtils.version.version?this.view.hidden=!1:(this.view.layer.opacity=.2,this.view.hidden=!1,this.moveButton.hidden=!0,this.closeButton.hidden=!0,this.activationStatus.hidden=!0,this.freeUsage.hidden=!0,this.autoSubscription.hidden=!0,this.usageButton.hidden=!0,this.apikeyInput.hidden=!0,this.pasteKeyButton.hidden=!0,this.refreshButton.hidden=!0,MNUtil.studyView.bringSubviewToFront(this.view),this.activationStatus.setTitle(subscriptionConfig.getStatus()),this.freeUsage.setTitle(subscriptionConfig.getFreeUsage()),MNUtil.animate(()=>{this.view.layer.opacity=i}).then(()=>{this.view.layer.borderWidth=0,this.moveButton.hidden=!1,this.closeButton.hidden=!1,this.activationStatus.hidden=!1,this.freeUsage.hidden=!1,this.autoSubscription.hidden=!1,this.pasteKeyButton.hidden=!1,this.apikeyInput.hidden=!1,this.usageButton.hidden=!1,this.refreshButton.hidden=!1,this.refreshLayout()}))},subscriptionController.prototype.hide=function(t){let i=this.view.layer.opacity;"marginnote3"===subscriptionUtils.version.version?this.view.hidden=!0:(this.moveButton.hidden=!0,this.closeButton.hidden=!0,this.activationStatus.hidden=!0,this.freeUsage.hidden=!0,this.autoSubscription.hidden=!0,this.pasteKeyButton.hidden=!0,this.usageButton.hidden=!0,this.apikeyInput.hidden=!0,this.refreshButton.hidden=!0,MNUtil.animate(()=>{this.view.layer.opacity=.2}).then(()=>{this.view.hidden=!0,this.view.layer.opacity=i}))},subscriptionController.prototype.creatTextView=function(t="view",i="#c0bfbf",e=.9){var s=UITextView.new();return s.font=UIFont.systemFontOfSize(15),s.layer.cornerRadius=8,s.backgroundColor=subscriptionUtils.hexColorAlpha(i,e),s.textColor=UIColor.blackColor(),s.bounces=!0,this[t].addSubview(s),s},subscriptionController.prototype.refreshLayout=function(){this.freeUsage.setTitleForState(subscriptionConfig.getFreeUsage(),0)},subscriptionController.prototype.runJavaScript=async function(e){return new Promise((i,t)=>{try{this.webview.evaluateJavaScript(e,t=>{i(t)})}catch(t){MNUtil.showHUD(t),i(0)}})},subscriptionController.prototype.getApikeyFromWebview=async function(e){return new Promise((i,t)=>{e.evaluateJavaScript('JSON.stringify(Array.from(document.getElementsByClassName("msg")).map(msg => msg.innerText).filter(msg=>msg.startsWith("sk")))',async t=>{var t=JSON.parse(t);t.length&&((t=t.at(-1))===subscriptionConfig.getConfig("apikey")&&i(void 0),i(t)),i(void 0)})})},subscriptionController.prototype.refreshSidebar=async function(i=!0,r=!1){try{let t,e=(i?(self.view.hidden||MNUtil.showHUD("Retrieving info..."),t=r?(subscriptionConfig.config.alpha=!0,await subscriptionNetwork.readFileFromWebdav("mnaddonAlpha.json")):(subscriptionConfig.config.alpha=!1,await subscriptionNetwork.readFileFromWebdav("mnaddon.json")),subscriptionConfig.mnaddon=t):t=subscriptionConfig.mnaddon,subscriptionUtils.getLocalMNAddonVersions()),s=[],o=[],n=[];var a,c;Array.isArray(t)?(c=(t=t.map(t=>{var i=t.id;if(i in e)switch(subscriptionUtils.compareVersions(t.version,e[i])){case 0:t.action="reinstall",o.push(t);break;case 1:t.action="update",s.push(t);break;case-1:t.action="reinstall",o.push(t)}else n.push(t);return t}),0<s.length&&(a=s.map(t=>t.name),MNUtil.showHUD("Updates available: "+a.join(", "))),s.concat(o).concat(n)),this.runJavaScript(`updateFromNative(\`${encodeURIComponent(JSON.stringify(c))}\`)`),subscriptionConfig.save()):t.timeout&&t.message?MNUtil.showHUD(t.message):subscriptionUtils.addErrorLog("获取插件商店内容失败","refreshSidebar",t)}catch(t){subscriptionUtils.addErrorLog(t,"refreshSidebar")}},subscriptionController.prototype.activate=async function(t=1){MNUtil.showHUD("activate");var i=this.apikeyInput.text.trim();i?subscriptionConfig.config.apikey=i:subscriptionConfig.getConfig("apikey"),subscriptionConfig.config.activated?!subscriptionConfig.isSubscribed()&&subscriptionConfig.config.subscriptionDaysRemain?(subscriptionConfig.config.activated=!0,subscriptionConfig.config.subscribedDay=subscriptionUtils.getToday(),subscriptionConfig.config.subscriptionDaysRemain=subscriptionConfig.config.subscriptionDaysRemain-1,subscriptionConfig.save(),subscriptionUtils.refreshAddonCommands(),this.activationStatus.setTitle(subscriptionConfig.getStatus()),subscriptionUtils.showHUD("Subscription days remian: "+subscriptionConfig.config.subscriptionDaysRemain)):(await subscriptionNetwork.subscribe(t)).success||(this.autoSubscription.setTitle(subscriptionConfig.config.autoSubscription?"Auto subscription: ✅":"Auto subscription: ❌"),subscriptionConfig.save()):subscriptionConfig.config.subscriptionDaysRemain?(subscriptionConfig.config.activated=!0,subscriptionConfig.config.subscribedDay=subscriptionUtils.getToday(),subscriptionConfig.config.subscriptionDaysRemain=subscriptionConfig.config.subscriptionDaysRemain-1,subscriptionConfig.save(),subscriptionUtils.refreshAddonCommands(),this.activationStatus.setTitle(subscriptionConfig.getStatus()),subscriptionUtils.showHUD("Subscription days remian: "+subscriptionConfig.config.subscriptionDaysRemain)):subscriptionNetwork.subscribe(t)},subscriptionController.prototype.layoutSubviews=function(){var t=this.view.bounds,i=t.width,t=t.y+t.height,e=260;350<i?(this.subscriptionView.frame=MNUtil.genFrame(0,30,270,t-30),this.webview.frame=MNUtil.genFrame(0,30,270,t-30),this.docview.frame=MNUtil.genFrame(275,30,i-275,t-30),this.docview.hidden=!1):(e=i-10,this.subscriptionView.frame=MNUtil.genFrame(0,30,i,t-30),this.webview.frame=MNUtil.genFrame(0,30,i,t-30),this.docview.hidden=!0),this.closeButton.setFrame(i-30,0,25,25),this.moveButton.setFrame(35,0,i-70,25),this.refreshButton.setFrame(5,0,25,25),this.activationStatus.setFrame(5,80,e,30),this.showAPIKeyButton.setFrame(e-85,45,30,25),this.pasteKeyButton.setFrame(e-50,45,50,25),this.autoSubscription.setFrame(5,115,e,30),this.freeUsage.setFrame(e-25,150,30,30),this.usageButton.setFrame(5,150,e-35,30),this.usageDetailButton.setFrame(e-110,185,115,30),this.URLButton.setFrame(5,185,e-120,30),this.apikeyInput.frame={x:5,y:5,width:e,height:70},this.resizeButton.setFrame(i-30,t-30,30,30),this.DMButton.hidden=t<295,this.buyAPIKeyButton.hidden=t<320,this.DMButton.setFrame(5,220,e,30),this.buyAPIKeyButton.setFrame(5,255,e,30)};class subscriptionUtils{constructor(t){this.name=t}static subscriptionController;static mainPath;static init(t){this.app=Application.sharedInstance(),this.data=Database.sharedInstance(),this.focusWindow=this.app.focusWindow,this.version=this.appVersion(),this.mainPath=t,this.errorLog=[],this.extensionPath=t.replace(/\/marginnote\.extension\.\w+/,"")}static showHUD(t,i=0){this.app.showHUD(t,this.focusWindow,2)}static addErrorLog(t,i,e){MNUtil.showHUD("MN Utils Error ("+i+"): "+t);t={error:t.toString(),source:i,time:new Date(Date.now()).toString(),mnaddon:"MN Utils"};e&&(t.info=e),this.errorLog.push(t),MNUtil.copyJSON(this.errorLog)}static appVersion(){var t={},i=parseFloat(this.app.appVersion);switch(t.version=4<=i?"marginnote4":"marginnote3",this.app.osType){case 0:t.type="iPadOS";break;case 1:t.type="iPhoneOS";break;case 2:t.type="macOS"}return t}static getByDefault(t,i){var e=NSUserDefaults.standardUserDefaults().objectForKey(t);return void 0===e?(NSUserDefaults.standardUserDefaults().setObjectForKey(i,t),i):e}static getNoteColors(){return["#ffffb4","#ccfdc4","#b4d1fb","#f3aebe","#ffff54","#75fb4c","#55bbf9","#ea3323","#ef8733","#377e47","#173dac","#be3223","#ffffff","#dadada","#b4b4b4","#bd9fdc"]}static getNoteById(t){return this.data.getNoteById(t)}static getNoteBookById(t){return this.data.getNotebookById(t)}static getUrlByNoteId(t){return this.appVersion().version+"app://note/"+t}static getNoteIdByURL(t){let i=t.trim();return i=/^marginnote\dapp:\/\/note\//.test(i)?i.slice(22):i}static clipboardText(){return UIPasteboard.generalPasteboard().string}static copy(t){UIPasteboard.generalPasteboard().string=t}static copyJSON(t){UIPasteboard.generalPasteboard().string=JSON.stringify(t,null,2)}static copyImage(t){UIPasteboard.generalPasteboard().setDataForPasteboardType(t,"public.png")}static studyController(){return this.app.studyController(this.focusWindow)}static studyView(){return this.app.studyController(this.focusWindow).view}static currentDocController(){return this.studyController().readerController.currentDocumentController}static currentNotebook(){var t=this.studyController().notebookController.notebookId;return this.getNoteBookById(t)}static undoGrouping(t,i){UndoManager.sharedInstance().undoGrouping(String(Date.now()),t,i),this.app.refreshAfterDBChanged(t)}static checkSubscriptionController(){this.subscriptionController||(this.subscriptionController=subscriptionController.new()),this.subscriptionController.view.isDescendantOfView(MNUtil.studyView)||MNUtil.studyView.addSubview(this.subscriptionController.view)}static getImage(t,i=2){return UIImage.imageWithDataScale(NSData.dataWithContentsOfFile(t),i)}static refreshAddonCommands(){this.studyController().refreshAddonCommands()}static addObserver(t,i,e){NSNotificationCenter.defaultCenter().addObserverSelectorName(t,i,e)}static removeObserver(t,i){NSNotificationCenter.defaultCenter().removeObserverName(t,i)}static checkSender(t,i){return this.app.checkNotifySenderInWindow(t,i)}static getPopoverAndPresent(t,i,e=100,s=2){var o=MenuController.new(),i=(o.commandTable=i,o.rowHeight=35,o.preferredContentSize={width:e,height:o.rowHeight*o.commandTable.length},new UIPopoverController(o)),e=t.convertRectToView(t.bounds,this.studyView());return i.presentPopoverFromRect(e,this.studyView(),s,!0),i}static hexColorAlpha(t,i){t=UIColor.colorWithHexString(t);return void 0!==i?t.colorWithAlphaComponent(i):t}static getToday(){return(new Date).getDate()}static ensureView(t){MNUtil.isDescendantOfStudyView(t)||(t.hidden=!0,MNUtil.studyView.addSubview(t))}static async delay(e){return new Promise((t,i)=>{NSTimer.scheduledTimerWithTimeInterval(e,!1,function(){t()})})}static getLocalMNAddonVersions(){try{var i=this.extensionPath+"/";let t=NSFileManager.defaultManager().contentsOfDirectoryAtPath(i),e=(t=t.filter(t=>!/\.DS_Store$/.test(t)),{});return t.map(t=>{var i;MNUtil.isfileExists(this.extensionPath+"/"+t+"/mnaddon.json")&&(i=MNUtil.readJSON(this.extensionPath+"/"+t+"/mnaddon.json").version,t=t.split("marginnote.extension.")[1],e[t]=i)}),e}catch(t){MNUtil.showHUD(t)}}static compareVersions(t,i){var e=t=>{return t.match(/(\d+)([a-zA-Z]*)(\d*)/g).map(t=>{var i=t.match(/\d+/),t=t.match(/[a-zA-Z]+/);return{num:i?parseInt(i[0],10):0,alpha:t?t[0]:"",alphaNum:t?t[0].charCodeAt(0):0}})},s=e(t),o=e(i);for(let t=0;t<Math.max(s.length,o.length);t++){var n=s[t]||{num:0,alpha:"",alphaNum:0},r=o[t]||{num:0,alpha:"",alphaNum:0};if(n.num!==r.num)return n.num>r.num?1:-1;if(n.alphaNum!==r.alphaNum)return n.alphaNum>r.alphaNum?1:-1;if(n.alpha===r.alpha&&n.num===r.num){n=n.num,r=r.num;if(n!==r)return r<n?1:-1}}return 0}static getRandomAuthorization(t){t="https://dav.jianguoyun.com/dav/mnaddonStore/"+t,t=[{user:"2063617827@qq.com",password:"a3dkxi2c72hgm8hh",url:t},{user:"1514501767@qq.com",password:"a76xnbehrsr36via",url:t}];return 1===t.length?t[0]:t.length?t[Math.floor(Math.random()*t.length)]:""}static getURLTitle(){var t=subscriptionConfig.getConfig("url");return"https://api.feliks.top"===t?"URL1":"https://api1.feliks.top"===t?"URL2":"https://alpha.u1162561.nyat.app:20075"===t?"URL3":"https://api.u1162561.nyat.app:20074"===t?"URL4":"https://d2p9226849.vicp.fun"===t?"URL5":"Unknown URL"}}class subscriptionNetwork{constructor(t){this.name=t}static onSubscrbing=!1;static genNSURL(t){return NSURL.URLWithString(t)}static initRequest(t,i){var e=NSMutableURLRequest.requestWithURL(this.genNSURL(t));e.setHTTPMethod(i.method??"GET"),e.setTimeoutInterval(i.timeout??10);return e.setAllHTTPHeaderFields({"User-Agent":"Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_4) AppleWebKit/605.1.15 (KHTML, like Gecko) Version/13.1.1 Safari/605.1.15","Content-Type":"application/json",Accept:"application/json",...i.headers??{}}),i.search?e.setURL(this.genNSURL(t.trim()+"?"+Object.entries(i.search).reduce((t,i)=>{var[i,e]=i;return(t?t+"&":"")+i+"="+encodeURIComponent(e)},""))):i.body?e.setHTTPBody(NSData.dataWithStringEncoding(i.body,4)):i.form?e.setHTTPBody(NSData.dataWithStringEncoding(Object.entries(i.form).reduce((t,i)=>{var[i,e]=i;return(t?t+"&":"")+i+"="+encodeURIComponent(e)},""),4)):i.json&&e.setHTTPBody(NSJSONSerialization.dataWithJSONObjectOptions(i.json,1)),e}static async sendRequest(i){const e=NSOperationQueue.mainQueue();return new Promise((s,t)=>{NSURLConnection.sendAsynchronousRequestQueueCompletionHandler(i,e,(t,i,e)=>{i=NSJSONSerialization.JSONObjectWithDataOptions(i,1);NSJSONSerialization.isValidJSONObject(i)&&(e.localizedDescription&&(i.success=!1,subscriptionUtils.showHUD(e.localizedDescription)),s(i)),s(i)})})}static async fetch(t,i={}){t=this.initRequest(t,i);return await this.sendRequest(t)}static async subscribe(t=1,i=!0){this.onSubscrbing=!0;var e={"Content-Type":"application/json",Authorization:"Bearer "+subscriptionConfig.config.apikey};let s="mnaddon";var o={model:s=1<t?"mnaddon"+t:s,messages:[{role:"user",content:"mnaddon"}]},n=subscriptionConfig.getConfig("url")+"/v1/chat/completions",n=await this.fetch(n,{method:"POST",headers:e,timeout:60,json:o});if(n.success)subscriptionConfig.isSubscribed()?(subscriptionConfig.config.subscriptionDaysRemain=subscriptionConfig.getConfig("subscriptionDaysRemain")+t,MNUtil.showHUD("Subscription days remian: "+subscriptionConfig.config.subscriptionDaysRemain)):(subscriptionConfig.config.activated=!0,subscriptionConfig.config.subscribedDay=subscriptionUtils.getToday(),subscriptionConfig.config.subscriptionDaysRemain=subscriptionConfig.getConfig("subscriptionDaysRemain")+t-1,MNUtil.showHUD("subscribe success: "+s));else{let t=!1;subscriptionConfig.config.autoSubscription=!1,n.error&&(n.error.message?(MNUtil.showHUD("Error: "+n.error.message),n.error.message.includes("该令牌额度已用尽")&&(t=!0)):(MNUtil.showHUD("Error: "+JSON.stringify(n.error)),MNUtil.copyJSON(n.error))),subscriptionConfig.config.activated&&t||i&&(subscriptionConfig.config.activated=!1)}return this.onSubscrbing=!1,MNUtil.delay(.1).then(()=>{subscriptionConfig.save(),subscriptionUtils.subscriptionController.activationStatus.setTitleForState(subscriptionConfig.getStatus(),0),subscriptionUtils.refreshAddonCommands()}),n}static async getKey(t="mnaddon"){var i,e=subscriptionConfig.getConfig("apikey");if(""!==e.trim())return e={"Content-Type":"application/json",Authorization:"Bearer "+e},t={model:t,messages:[{role:"user",content:"mnaddon"}]},i=subscriptionConfig.getConfig("url")+"/v1/chat/completions",await this.fetch(i,{method:"POST",headers:e,timeout:60,json:t});subscriptionUtils.showHUD("no api key")}static async getUsage(){var t,i=subscriptionConfig.getConfig("url"),e=i+"/v1/dashboard/billing/subscription",i=i+"/v1/dashboard/billing/usage",s=subscriptionConfig.getConfig("apikey");if(""!==s.trim())return t={},"error"in(s=await this.fetch(i,{method:"GET",timeout:60,headers:i={Authorization:"Bearer "+s,"Content-Type":"application/json"}}))&&s.error.message.includes("该令牌额度已用尽")?t.error="该令牌额度已用尽":(t.usage=s.total_usage,s=await this.fetch(e,{method:"GET",timeout:60,headers:i}),t.total=s.hard_limit_usd),t;subscriptionUtils.showHUD("no api key")}static btoa(t){t=CryptoJS.enc.Utf8.parse(t);return CryptoJS.enc.Base64.stringify(t)}static async readWebDAVFile(t,i,e){i={Authorization:"Basic "+this.btoa(i+":"+e),"Cache-Control":"no-cache"},e=await MNConnection.fetch(t,{method:"GET",headers:i});try{return e.base64Encoding?MNUtil.data2string(e):e}catch(t){return e}}static readWebDAVFileWithDelegate(t,i,e){try{var s={Authorization:"Basic "+this.btoa(i+":"+e),"Cache-Control":"no-cache"};return this.initRequest(t,{method:"GET",headers:s})}catch(t){}}static async readFileFromWebdav(t){t=subscriptionUtils.getRandomAuthorization(t);return await this.readWebDAVFile(t.url,t.user,t.password)}static readFileFromWebdavWithDelegate(t,i){t=subscriptionUtils.getRandomAuthorization(t);return this.readWebDAVFileWithDelegate(t.url,t.user,t.password,i)}static async downloadFromConfig(t,i=void 0){var e=subscriptionUtils.extensionPath+"/marginnote.extension."+t.id,s=t.id+"_v"+t.version.replace(/\./g,"_")+".mnaddon",o=subscriptionUtils.mainPath+"/"+s;t.customUrl?(MNUtil.waitHUD("Download: "+t.name),t=MNConnection.requestWithURL(t.url),i&&(NSURLConnection.connectionWithRequestDelegate(t,i),i.targetPath=o,i.addonPath=e)):(MNUtil.waitHUD("Download: "+s),i&&(t=subscriptionNetwork.readFileFromWebdavWithDelegate(s,i),NSURLConnection.connectionWithRequestDelegate(t,i),i.targetPath=o,i.addonPath=e))}}class subscriptionConfig{constructor(t){this.name=t}static defaultConfig={activated:!1,autoSubscription:!1,subscribedDay:0,apikey:"",freeUsage:0,freeDay:0,subscriptionDaysRemain:0,url:"https://api.feliks.top",lastView:"webview",alpha:!1};static frameHeight=355;static mnaddon=[];static init(){this.config=this.getByDefault("FeliksPro",this.defaultConfig)}static getByDefault(t,i){var e=NSUserDefaults.standardUserDefaults().objectForKey(t);return void 0===e?(NSUserDefaults.standardUserDefaults().setObjectForKey(i,t),i):e}static getConfig(t){return(void 0!==this.config[t]?this.config:this.defaultConfig)[t]}static isSubscribed(){var t;return!!this.getConfig("activated")&&(t=subscriptionUtils.getToday(),this.getConfig("subscribedDay")===t)}static getFreeUsage(){var t=subscriptionUtils.getToday();return this.getConfig("freeDay")===t?["🔟","9️⃣","8️⃣","7️⃣","6️⃣","5️⃣","4️⃣","3️⃣","2️⃣","1️⃣","0️⃣"][this.getConfig("freeUsage")]||"0️⃣":(this.config.freeDay=t,this.config.freeUsage=0,"🔟")}static isFree(t=!0){var i,e=subscriptionUtils.getToday();return this.getConfig("freeDay")===e?(i=this.getConfig("freeUsage"),t?(this.config.freeUsage=i+1,10<=this.config.freeUsage?subscriptionUtils.showHUD("Free Usage remian: 0"):subscriptionUtils.showHUD("Free Usage remian: "+(9-i)),i<=10):i<=9):(this.config.freeDay=e,t?(this.config.freeUsage=1,subscriptionUtils.showHUD("Free Usage remian: "+(10-this.config.freeUsage))):this.config.freeUsage=0,!0)}static checkSubscribed(t=!0,i=!1,e=!0){if(!this.getConfig("activated"))return!i&&this.isFree(t)?(MNUtil.delay(.1).then(()=>{subscriptionUtils.subscriptionController&&subscriptionUtils.subscriptionController.freeUsage.setTitleForState(this.getFreeUsage(),0),this.save()}),!0):(e&&MNUtil.showHUD("Subscription Not activated!"),!1);if(this.isSubscribed())return!0;if(this.getConfig("autoSubscription")){if(this.config.subscriptionDaysRemain)return this.config.activated=!0,this.config.subscribedDay=subscriptionUtils.getToday(),this.config.subscriptionDaysRemain=this.config.subscriptionDaysRemain-1,MNUtil.delay(.1).then(()=>{subscriptionUtils.subscriptionController&&subscriptionUtils.subscriptionController.activationStatus&&subscriptionUtils.subscriptionController.activationStatus.setTitleForState(this.getStatus(),0),subscriptionUtils.showHUD("Subscription days remian: "+this.config.subscriptionDaysRemain),subscriptionUtils.refreshAddonCommands(),this.save()}),!0;subscriptionNetwork.onSubscrbing||subscriptionNetwork.subscribe().then(t=>{subscriptionUtils.refreshAddonCommands()})}return!i&&this.isFree(t)?(MNUtil.delay(.1).then(()=>{subscriptionUtils.subscriptionController&&subscriptionUtils.subscriptionController.freeUsage.setTitleForState(this.getFreeUsage(),0),this.save()}),!0):(e&&subscriptionUtils.showHUD("Not subscribed today!"),!1)}static getStatus(){return"Activated: "+(this.getConfig("activated")?"✅":"❌")+" | "+("Subscribed: "+(this.isSubscribed()?"✅":"❌"))+" | "+this.getConfig("subscriptionDaysRemain")}static save(){NSUserDefaults.standardUserDefaults().setObjectForKey(this.config,"FeliksPro")}static remove(){NSUserDefaults.standardUserDefaults().removeObjectForKey("FeliksPro")}static getConfig(t){return(void 0!==this.config[t]?this.config:this.defaultConfig)[t]}static autoSubscribe(t=!0){this.getConfig("autoSubscription")?this.getConfig("activated")?this.isSubscribed()?subscriptionUtils.refreshAddonCommands():this.config.subscriptionDaysRemain?(this.config.activated=!0,this.config.subscribedDay=subscriptionUtils.getToday(),this.config.subscriptionDaysRemain=this.config.subscriptionDaysRemain-1,subscriptionUtils.subscriptionController.activationStatus&&subscriptionUtils.subscriptionController.activationStatus.setTitleForState(this.getStatus(),0),subscriptionUtils.showHUD("Subscription days remian: "+this.config.subscriptionDaysRemain),subscriptionUtils.refreshAddonCommands(),this.save()):subscriptionNetwork.onSubscrbing?subscriptionUtils.refreshAddonCommands():subscriptionNetwork.subscribe().then(t=>{subscriptionUtils.refreshAddonCommands()}):(t&&subscriptionUtils.showHUD("Not activated!"),subscriptionConfig.config.autoSubscription=!1,subscriptionUtils.refreshAddonCommands()):subscriptionUtils.refreshAddonCommands()}}