{
  "currentState": "initialized",
  "stateHistory": [
    {
      "from": "initial",
      "command": "init",
      "timestamp": "2025-07-05T15:54:09.194Z",
      "args": [
        {
          "workingDirectory": "/Users/xiakangwei/Nutstore/Github/repository/MN-addon-develop/MN-Addon/mntask"
        }
      ]
    },
    {
      "from": "initialized",
      "command": "remember",
      "timestamp": "2025-07-05T16:31:21.771Z",
      "args": [
        "MN-Addon 开发陷阱：变量重复声明导致的静默加载失败\n\n问题描述：\n- 插件突然无法找到某个类（如 MNTaskManager），报错 \"Can't find variable: ClassName\"\n- 没有任何语法错误提示，文件似乎没有被成功加载\n\n根本原因：\nJavaScript 文件中存在语法错误（如在同一作用域内重复声明 const 变量），但被文件末尾的 try-catch 静默处理了。\n\n真实案例：\n在 xdyy_utils_extensions.js 的 linkParentTask 方法中，第786行和第836行重复声明了 const parentParts 变量，导致语法错误。\n\n为什么难以发现：\n文件末尾的初始化代码静默处理了所有错误：\n```javascript\n} catch (error) {\n  // 静默处理错误 - 这导致问题难以发现！\n}\n```\n\n诊断方法：\n1. 使用 node -c filename.js 检查语法错误\n2. 查看 git diff 重点检查变量声明\n3. 搜索变量名检查是否重复声明\n\n解决方案：\n1. 修复语法错误（删除重复声明或重命名）\n2. 改进错误处理，在 catch 块中添加日志\n3. 开发时启用语法检查，提交前验证\n4. 使用 ESLint 配置 no-redeclare 规则\n\n经验总结：\n- 当类突然\"消失\"时，首先怀疑文件加载失败\n- 文件加载失败通常是因为语法错误\n- 静默的 try-catch 是调试的大敌\n- 始终使用工具验证语法正确性",
        "--tags",
        "MN-Addon JavaScript 语法错误 调试技巧 MarginNote插件"
      ]
    },
    {
      "from": "memory_saved",
      "command": "init",
      "timestamp": "2025-07-05T17:10:58.723Z",
      "args": [
        {
          "workingDirectory": "/Users/xiakangwei/Nutstore/Github/repository/MN-addon-develop/MN-Addon/mntoolbar/mntoolbar"
        }
      ]
    },
    {
      "from": "initialized",
      "command": "init",
      "timestamp": "2025-07-05T17:19:30.147Z",
      "args": [
        {
          "workingDirectory": "/Users/xiakangwei/Nutstore/Github/repository/MN-addon-develop/MN-Addon/mntoolbar/mntoolbar"
        }
      ]
    },
    {
      "from": "initialized",
      "command": "init",
      "timestamp": "2025-07-08T16:02:11.397Z",
      "args": [
        {
          "workingDirectory": "/Users/xiakangwei/Nutstore/Github/repository/MN-addon-develop/MN-Addon/mnutils"
        }
      ]
    },
    {
      "from": "initialized",
      "command": "init",
      "timestamp": "2025-07-09T16:08:57.104Z",
      "args": [
        {
          "workingDirectory": "/Users/xiakangwei/Nutstore/Github/repository/MN-addon-develop/MN-Addon/mntask"
        }
      ]
    },
    {
      "from": "initialized",
      "command": "init",
      "timestamp": "2025-07-10T03:30:21.333Z",
      "args": [
        {
          "workingDirectory": "/Users/xiakangwei/Nutstore/Github/repository/MN-addon-develop/MN-Addon/mntask"
        }
      ]
    },
    {
      "from": "initialized",
      "command": "init",
      "timestamp": "2025-07-10T04:40:35.758Z",
      "args": [
        {
          "workingDirectory": "/Users/xiakangwei/Nutstore/Github/repository/MN-addon-develop/MN-Addon/mntask"
        }
      ]
    },
    {
      "from": "initialized",
      "command": "remember",
      "timestamp": "2025-07-10T17:22:23.364Z",
      "args": [
        "## MNToolbar 按钮开发陷阱总结\n\n### 1. MNNote.appendMarkdownComment 空内容检查\n- 问题：MNNote 包装器会检查 `comment && comment.trim()`，空内容直接返回\n- 解决：使用原生 API `focusNote.note.appendMarkdownComment()` 绕过检查\n\n### 2. 空输入值的不同表现\n- 手动输入空框：`alert.textFieldAtIndex(0).text` 返回 `undefined`\n- 代码传入空字符串：`\"\"` 或 `\" \"` 都会被 trim 掉\n- 关键：理解 undefined、null、空字符串的差异\n\n### 3. MNToolbar 按钮键名必须使用 custom+数字格式\n- 错误：使用 `registerButton(\"proof\", ...)` 导致单击无反应\n- 正确：必须使用 `registerButton(\"custom8\", ...)` 格式\n- 原因：按钮系统只识别 custom 格式的键名\n- 症状：长按菜单正常但单击失效\n\n### 4. 调试策略\n- API 层级：区分包装器和原生 API\n- 框架约定：注意隐含的命名规则\n- 底层方案：高层 API 受限时使用底层 API",
        "--tags",
        "MN-Addon MNToolbar 开发陷阱 按钮开发"
      ]
    },
    {
      "from": "memory_saved",
      "command": "init",
      "timestamp": "2025-07-10T17:39:00.693Z",
      "args": [
        {
          "workingDirectory": "/Users/xiakangwei/Nutstore/Github/repository/MN-addon-develop/MN-Addon"
        }
      ]
    },
    {
      "from": "initialized",
      "command": "init",
      "timestamp": "2025-07-10T17:54:22.684Z",
      "args": [
        {
          "workingDirectory": "/Users/xiakangwei/Nutstore/Github/repository/MN-addon-develop/MN-Addon"
        }
      ]
    },
    {
      "from": "initialized",
      "command": "init",
      "timestamp": "2025-07-10T18:16:49.547Z",
      "args": [
        {
          "workingDirectory": "/Users/xiakangwei/Nutstore/Github/repository/MN-addon-develop/MN-Addon/mnutils"
        }
      ]
    },
    {
      "from": "initialized",
      "command": "init",
      "timestamp": "2025-07-10T18:40:34.002Z",
      "args": [
        {
          "workingDirectory": "/Users/xiakangwei/Nutstore/Github/repository/MN-addon-develop/MN-Addon/mntask"
        }
      ]
    },
    {
      "from": "initialized",
      "command": "init",
      "timestamp": "2025-07-11T03:35:01.342Z",
      "args": [
        {
          "workingDirectory": "/Users/xiakangwei/Nutstore/Github/repository/MN-addon-develop/MN-Addon/mntask"
        }
      ]
    },
    {
      "from": "initialized",
      "command": "init",
      "timestamp": "2025-07-11T03:41:48.763Z",
      "args": [
        {
          "workingDirectory": "/Users/xiakangwei/Nutstore/Github/repository/MN-addon-develop/MN-Addon/mntask"
        }
      ]
    },
    {
      "from": "initialized",
      "command": "init",
      "timestamp": "2025-07-11T04:13:25.801Z",
      "args": [
        {
          "workingDirectory": "/Users/xiakangwei/Nutstore/Github/repository/MN-addon-develop/MN-Addon/mntask"
        }
      ]
    },
    {
      "from": "initialized",
      "command": "init",
      "timestamp": "2025-07-11T06:04:56.269Z",
      "args": [
        {
          "workingDirectory": "/Users/xiakangwei/Nutstore/Github/repository/MN-addon-develop/MN-Addon/mntask"
        }
      ]
    },
    {
      "from": "initialized",
      "command": "remember",
      "timestamp": "2025-07-11T12:36:08.216Z",
      "args": [
        "MN-Addon WebView 显示和数据传递问题解决方案：\n\n1. WebView 显示问题：\n   - 必须在容器视图布局完成后创建 WebView（使用延迟初始化）\n   - 使用 loadFileURLAllowingReadAccessToURL 而不是 loadRequest\n   - 正确设置 frame：使用容器的 bounds\n\n2. iframe 架构数据传递：\n   - 主容器(sidebarContainer.html)需要代理函数接收原生调用\n   - 使用 postMessage 转发数据到 iframe\n   - iframe 页面需要监听 message 事件\n   - 保持原有 API 兼容性：原生代码仍调用 loadTasksFromPlugin",
        "--tags",
        "WebView MarginNote iframe postMessage MNTask"
      ]
    },
    {
      "from": "memory_saved",
      "command": "remember",
      "timestamp": "2025-07-11T12:47:58.637Z",
      "args": [
        "iframe 架构下的视图切换时序问题解决方案：\n\n1. 问题症状：\n   - 切换到日志视图时一直显示\"加载中\"\n   - 需要手动刷新才能加载数据\n\n2. 根本原因：\n   - 切换视图只是改变了 iframe 的 src\n   - 没有等待 iframe 加载完成就尝试传递数据\n   - 或者根本没有触发数据加载\n\n3. 解决方案：\n   - 在 iframe.onload 中通知原生代码\n   - 根据不同视图发送不同的加载请求\n   - 原生代码收到请求后调用相应的数据加载方法\n\n4. 关键要点：\n   - iframe 加载是异步的\n   - 使用 URL 协议从 WebView 通知原生代码\n   - 事件驱动设计：iframe 主动请求数据\n   - 每个视图都需要独立的初始化逻辑",
        "--tags",
        "iframe WebView MarginNote 时序 异步加载"
      ]
    },
    {
      "from": "memory_saved",
      "command": "remember",
      "timestamp": "2025-07-11T13:06:44.959Z",
      "args": [
        "MNTask v0.10.1 开发经验总结：\n\n1. **任务路径显示**：在 todayboard.html 的任务卡片中，通过在 task-title 后添加 task-path div 实现路径显示，使用灰色小字体（font-size: 12px, color: var(--text-secondary)），数据从 settingController.js 的 loadTodayBoardData 中传递（task.path）。\n\n2. **项目视图架构**：\n   - 创建独立的 projectview.html，实现两栏布局（左侧项目列表，右侧任务列表）\n   - 在 sidebarContainer.html 添加导航项和代理函数（loadProjectsFromPlugin、loadProjectTasksFromPlugin）\n   - 在 settingController.js 添加 loadProjectsData 和 loadProjectTasks 函数\n   - 扩展 handleTodayBoardProtocol 处理新的协议（loadProjectsData、loadProjectTasks）\n\n3. **关键实现细节**：\n   - 项目筛选：MNTaskManager.filterTasksSync({ types: ['项目'] })\n   - 子任务获取：MNTaskManager.filterTasksSync({ parentId: projectId })\n   - 项目排序：按状态排序（进行中 > 未开始 > 已完成）\n   - 复用任务卡片样式和功能，保持用户体验一致性\n\n4. **iframe 通信模式**：原生代码 → sidebarContainer 代理函数 → iframe postMessage → 视图内部处理",
        "--tags",
        "MNTask 项目视图 WebView iframe MarginNote"
      ]
    },
    {
      "from": "memory_saved",
      "command": "init",
      "timestamp": "2025-07-11T17:26:53.340Z",
      "args": [
        {
          "workingDirectory": "/Users/xiakangwei/Nutstore/Github/repository/MN-addon-develop/MN-Addon/mntask"
        }
      ]
    }
  ],
  "lastUpdated": "2025-07-11T17:26:53.350Z"
}
