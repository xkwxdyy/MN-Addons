# MarginNote æ’ä»¶å¼€å‘æ–°æ‰‹æ•™ç¨‹ - ä»é›¶å¼€å§‹åˆ°ç‹¬ç«‹å¼€å‘

> æœ¬æ•™ç¨‹ä¸“ä¸ºæ²¡æœ‰ JavaScript åŸºç¡€çš„ MarginNote ç”¨æˆ·è®¾è®¡ï¼Œé€šè¿‡å®é™…æ¡ˆä¾‹è®©ä½ å¿«é€ŸæŒæ¡æ’ä»¶å¼€å‘ã€‚

## ğŸ“š ç›®å½•

1. [å‰è¨€ - ä¸ºä»€ä¹ˆè¦å­¦ä¹ æ’ä»¶å¼€å‘](#å‰è¨€---ä¸ºä»€ä¹ˆè¦å­¦ä¹ æ’ä»¶å¼€å‘)
   - æ’ä»¶èƒ½åšä»€ä¹ˆ | å­¦ä¹ è·¯çº¿å›¾
2. [JavaScript å¿…å¤‡åŸºç¡€](#javascript-å¿…å¤‡åŸºç¡€)ï¼ˆâ­ æ–°æ‰‹å¿…è¯»ï¼‰
   - å˜é‡ | å­—ç¬¦ä¸² | æ•°ç»„ | å¯¹è±¡ | å‡½æ•° | æ¡ä»¶åˆ¤æ–­
3. [MarginNote æ’ä»¶ç»“æ„](#marginnote-æ’ä»¶ç»“æ„)
   - æ’ä»¶å…¥å£ | ç”Ÿå‘½å‘¨æœŸ | JSB æ¡†æ¶
4. [MNUtils API å…¥é—¨](#mnutils-api-å…¥é—¨)ï¼ˆâ­ æ ¸å¿ƒå†…å®¹ï¼‰
   - ä»€ä¹ˆæ˜¯ MNUtils | å¸¸ç”¨ API | å®æˆ˜ç¤ºä¾‹
5. [å¼€å‘ä½ çš„ç¬¬ä¸€ä¸ªæŒ‰é’®](#å¼€å‘ä½ çš„ç¬¬ä¸€ä¸ªæŒ‰é’®)ï¼ˆğŸš€ å¿«é€Ÿä¸Šæ‰‹ï¼‰
   - ä¸‰æ­¥æ·»åŠ æŒ‰é’® | å®æˆ˜ç¤ºä¾‹ | è°ƒè¯•æŠ€å·§
6. [æ’ä»¶æ–‡ä»¶å¤„ç†](#æ’ä»¶æ–‡ä»¶å¤„ç†)
   - æ‰“åŒ…æ–¹æ³• | å®‰è£…è°ƒè¯• | å¸¸è§é”™è¯¯
7. [è¿›é˜¶åŠŸèƒ½å¼€å‘](#è¿›é˜¶åŠŸèƒ½å¼€å‘)
   - è¯„è®ºç®¡ç† | é“¾æ¥ç®¡ç† | æ‰¹é‡å¤„ç† | æ¨¡æ¿ç³»ç»Ÿ
8. [MNTask æ¡ˆä¾‹å­¦ä¹ ](#mntask-æ¡ˆä¾‹å­¦ä¹ )
   - ä»»åŠ¡å¡ç‰‡ | çŠ¶æ€ç®¡ç† | å­¦ä¹ è¦ç‚¹
9. [å¸¸è§é—®é¢˜ä¸è°ƒè¯•](#å¸¸è§é—®é¢˜ä¸è°ƒè¯•)ï¼ˆğŸ”§ é‡åˆ°é—®é¢˜çœ‹è¿™é‡Œï¼‰
   - å¸¸è§é”™è¯¯ | è°ƒè¯•æŠ€å·§ | æ€§èƒ½ä¼˜åŒ–
10. [èµ„æºä¸ä¸‹ä¸€æ­¥](#èµ„æºä¸ä¸‹ä¸€æ­¥)
    - å­¦ä¹ è·¯å¾„ | æ¨èèµ„æº | ç¤¾åŒºæ”¯æŒ

## å‰è¨€ - ä¸ºä»€ä¹ˆè¦å­¦ä¹ æ’ä»¶å¼€å‘

MarginNote çš„æ’ä»¶ç³»ç»Ÿè®©ä½ èƒ½å¤Ÿï¼š
- ğŸš€ è‡ªå®šä¹‰å·¥ä½œæµç¨‹ï¼Œæé«˜å­¦ä¹ æ•ˆç‡
- ğŸ¯ å®ç°ç‰¹å®šéœ€æ±‚ï¼Œå¦‚æ‰¹é‡å¤„ç†ã€è‡ªåŠ¨åŒ–æ“ä½œ
- ğŸ’¡ æ•´åˆå¤–éƒ¨å·¥å…·ï¼Œå¦‚ AIã€ç½‘ç»œæœåŠ¡ç­‰
- ğŸ› ï¸ ä¿®æ”¹ç°æœ‰æ’ä»¶ï¼Œé€‚é…ä¸ªäººéœ€æ±‚

### ğŸ—ºï¸ å­¦ä¹ è·¯çº¿å›¾ï¼ˆæ–°æ‰‹å¿…çœ‹ï¼‰

```
ç¬¬ 1-3 å¤©ï¼šJavaScript åŸºç¡€
  â†“ å­¦ä¹ å˜é‡ã€å­—ç¬¦ä¸²ã€æ•°ç»„ï¼ˆç« èŠ‚2ï¼‰
ç¬¬ 4-5 å¤©ï¼šç†è§£æ’ä»¶ç»“æ„
  â†“ äº†è§£æ’ä»¶å¦‚ä½•è¿è¡Œï¼ˆç« èŠ‚3ï¼‰
ç¬¬ 6-7 å¤©ï¼šç†Ÿæ‚‰ MNUtils API
  â†“ æŒæ¡æ ¸å¿ƒ API ä½¿ç”¨ï¼ˆç« èŠ‚4ï¼‰
ç¬¬ 8-10 å¤©ï¼šåˆ›å»ºç¬¬ä¸€ä¸ªæŒ‰é’® â­
  â†“ åŠ¨æ‰‹å®è·µï¼Œå»ºç«‹ä¿¡å¿ƒï¼ˆç« èŠ‚5ï¼‰
ç¬¬ 11-15 å¤©ï¼šå¼€å‘å®ç”¨åŠŸèƒ½
  â†“ æ‰¹é‡å¤„ç†ã€æ¨¡æ¿ç­‰ï¼ˆç« èŠ‚7ï¼‰
ç¬¬ 16-21 å¤©ï¼šå­¦ä¹ ä¼˜ç§€æ¡ˆä¾‹
  â†“ ç ”ç©¶ MNTask æºç ï¼ˆç« èŠ‚8ï¼‰
```

> ğŸ’¡ **æ–°æ‰‹å»ºè®®**ï¼šä¸è¦è¯•å›¾ä¸€æ¬¡å­¦å®Œæ‰€æœ‰å†…å®¹ã€‚æŒ‰ç…§è·¯çº¿å›¾å¾ªåºæ¸è¿›ï¼Œæ¯å®Œæˆä¸€ä¸ªé˜¶æ®µå°±åŠ¨æ‰‹å®è·µä¸€ä¸‹ã€‚

## JavaScript å¿…å¤‡åŸºç¡€

> ğŸ’¡ **ä¸ºä»€ä¹ˆè¦å­¦ JavaScriptï¼Ÿ**  
> æƒ³è±¡ä¸€ä¸‹ï¼ŒMarginNote å°±åƒä¸€ä¸ªåŠŸèƒ½å¼ºå¤§çš„ç¬”è®°æœ¬ï¼Œè€Œ JavaScript å°±æ˜¯è®©ä½ èƒ½åœ¨è¿™ä¸ªç¬”è®°æœ¬ä¸Š"æ–½å±•é­”æ³•"çš„å’’è¯­ã€‚é€šè¿‡ JavaScriptï¼Œä½ å¯ä»¥è®© MarginNote æŒ‰ç…§ä½ çš„æƒ³æ³•è‡ªåŠ¨å·¥ä½œã€‚

### 1. ä»ä¸€ä¸ªå®é™…éœ€æ±‚å¼€å§‹

å‡è®¾ä½ æƒ³ç»™æ‰€æœ‰é‡è¦çš„ç¬”è®°åŠ ä¸Šçº¢è‰²æ ‡è®°ï¼Œæ‰‹åŠ¨æ“ä½œéœ€è¦ï¼š
1. æ‰¾åˆ°æ¯ä¸ªç¬”è®°
2. ç‚¹å‡»é¢œè‰²æŒ‰é’®
3. é€‰æ‹©çº¢è‰²
4. é‡å¤...é‡å¤...é‡å¤...ğŸ˜“

ç”¨æ’ä»¶åªéœ€è¦ä¸€è¡Œ"é­”æ³•å’’è¯­"ï¼š
```javascript
focusNote.colorIndex = 6;  // ç¬é—´å˜çº¢ï¼
```

ä½†æ˜¯ç­‰ç­‰ï¼Œ`focusNote` æ˜¯ä»€ä¹ˆï¼Ÿ`colorIndex` åˆæ˜¯ä»€ä¹ˆï¼Ÿåˆ«æ€¥ï¼Œè®©æˆ‘ä»¬ä¸€æ­¥æ­¥æ¥ç†è§£ã€‚

### 2. å˜é‡ - ç»™ä¸œè¥¿èµ·åå­—

åœ¨ç”Ÿæ´»ä¸­ï¼Œæˆ‘ä»¬ä¼šè¯´"æŠŠ**é‚£æœ¬ä¹¦**é€’ç»™æˆ‘"ã€‚åœ¨ JavaScript ä¸­ï¼Œæˆ‘ä»¬éœ€è¦å…ˆç»™"é‚£æœ¬ä¹¦"èµ·ä¸ªåå­—ï¼š

```javascript
// ç”¨ let å£°æ˜ä¸€ä¸ªå¯ä»¥æ”¹å˜çš„å˜é‡ï¼ˆå°±åƒç”¨é“…ç¬”å†™å­—ï¼‰
let myBook = "JavaScript å…¥é—¨";
myBook = "JavaScript è¿›é˜¶";  // âœ… å¯ä»¥æ”¹ï¼

// ç”¨ const å£°æ˜ä¸€ä¸ªä¸èƒ½æ”¹å˜çš„å¸¸é‡ï¼ˆå°±åƒç”¨é’¢ç¬”å†™å­—ï¼‰
const myName = "å°æ˜";
myName = "å°çº¢";  // âŒ é”™è¯¯ï¼const å£°æ˜çš„ä¸èƒ½æ”¹
```

**åœ¨æ’ä»¶ä¸­çš„å®é™…åº”ç”¨ï¼š**
```javascript
// è·å–å½“å‰é€‰ä¸­çš„ç¬”è®°ï¼Œå­˜åˆ° focusNote å˜é‡é‡Œ
const focusNote = MNNote.getFocusNote();

// å¦‚æœä½ æƒ³ä¿å­˜åŸå§‹æ ‡é¢˜ä»¥ä¾¿åç»­æ¢å¤
let originalTitle = focusNote.noteTitle;
```

> ğŸ¯ **å°è´´å£«**ï¼šç”¨ `const` è¿˜æ˜¯ `let`ï¼Ÿ  
> - å¦‚æœè¿™ä¸ªå€¼åé¢ä¸ä¼šå˜ï¼Œç”¨ `const`ï¼ˆæ¯”å¦‚è·å–çš„ç¬”è®°å¯¹è±¡ï¼‰
> - å¦‚æœè¿™ä¸ªå€¼å¯èƒ½ä¼šå˜ï¼Œç”¨ `let`ï¼ˆæ¯”å¦‚è®¡æ•°å™¨ã€ä¸´æ—¶æ ‡é¢˜ç­‰ï¼‰

### 3. å­—ç¬¦ä¸² - å¤„ç†æ–‡å­—

å­—ç¬¦ä¸²å°±æ˜¯æ–‡æœ¬ï¼Œç”¨å¼•å·åŒ…èµ·æ¥ï¼š

```javascript
// ä¸‰ç§å¼•å·éƒ½å¯ä»¥
let text1 = "åŒå¼•å·";
let text2 = 'å•å¼•å·';
let text3 = `åå¼•å·ï¼ˆæ¨¡æ¿å­—ç¬¦ä¸²ï¼‰`;
```

**ä¸ºä»€ä¹ˆæœ‰ä¸‰ç§ï¼Ÿçœ‹çœ‹å®é™…åº”ç”¨ï¼š**

```javascript
// åœºæ™¯1ï¼šåœ¨ç¬”è®°æ ‡é¢˜å‰åŠ ä¸Šæ ‡è®°
let noteTitle = "é‡è¦ä¼šè®®";
let markedTitle = "ã€å¾…åŠã€‘" + noteTitle;  // ç»“æœï¼š"ã€å¾…åŠã€‘é‡è¦ä¼šè®®"

// åœºæ™¯2ï¼šæ˜¾ç¤ºå¤„ç†è¿›åº¦ï¼ˆè¿™æ—¶æ¨¡æ¿å­—ç¬¦ä¸²å°±å¾ˆæ–¹ä¾¿ï¼‰
let processed = 5;
let total = 10;
let progress = `å·²å¤„ç† ${processed}/${total} ä¸ªç¬”è®°`;  // "å·²å¤„ç† 5/10 ä¸ªç¬”è®°"
```

**å¸¸ç”¨çš„æ–‡å­—å¤„ç†æŠ€å·§ï¼š**
```javascript
let title = "  TODO: å®Œæˆä½œä¸š  ";

// å»æ‰é¦–å°¾ç©ºæ ¼
title = title.trim();  // "TODO: å®Œæˆä½œä¸š"

// æ£€æŸ¥æ˜¯å¦åŒ…å«æŸä¸ªè¯
if (title.includes("TODO")) {
  // æ›¿æ¢æ–‡å­—
  title = title.replace("TODO", "DONE");  // "DONE: å®Œæˆä½œä¸š"
}

// åœ¨æ’ä»¶ä¸­çš„å®é™…åº”ç”¨
const focusNote = MNNote.getFocusNote();
if (focusNote && focusNote.noteTitle.includes("é‡è¦")) {
  focusNote.colorIndex = 6;  // åŒ…å«"é‡è¦"çš„ç¬”è®°æ ‡è®°ä¸ºçº¢è‰²
}
```

### 4. æ•°ç»„ - ç®¡ç†å¤šä¸ªä¸œè¥¿

æƒ³è±¡æ•°ç»„å°±åƒä¸€ä¸ªæœ‰ç¼–å·çš„å‚¨ç‰©æŸœï¼š

```javascript
// åˆ›å»ºä¸€ä¸ªæ ‡ç­¾åˆ—è¡¨
let tags = ["é‡è¦", "å¤ä¹ ", "è€ƒè¯•"];
//  ä½ç½®ï¼š    0      1      2     ï¼ˆä½ç½®ä» 0 å¼€å§‹æ•°ï¼ï¼‰

// è·å–ç¬¬ä¸€ä¸ªæ ‡ç­¾
let firstTag = tags[0];  // "é‡è¦"

// æ·»åŠ æ–°æ ‡ç­¾
tags.push("ç´§æ€¥");  // åœ¨æœ«å°¾æ·»åŠ  â†’ ["é‡è¦", "å¤ä¹ ", "è€ƒè¯•", "ç´§æ€¥"]
```

**åœ¨æ’ä»¶å¼€å‘ä¸­ï¼Œæ•°ç»„æœ€å¸¸ç”¨äºå¤„ç†å¤šä¸ªç¬”è®°ï¼š**

```javascript
// è·å–æ‰€æœ‰é€‰ä¸­çš„ç¬”è®°
const selectedNotes = MNNote.getFocusNotes();
console.log(`é€‰ä¸­äº† ${selectedNotes.length} ä¸ªç¬”è®°`);

// åœºæ™¯1ï¼šç»™æ‰€æœ‰é€‰ä¸­çš„ç¬”è®°åŠ ä¸Šé»„è‰²
selectedNotes.forEach(note => {
  note.colorIndex = 3;  // 3 æ˜¯é»„è‰²
});

// åœºæ™¯2ï¼šæ‰¾å‡ºæ‰€æœ‰åŒ…å«"TODO"çš„ç¬”è®°
const todoNotes = selectedNotes.filter(note => 
  note.noteTitle.includes("TODO")
);

// åœºæ™¯3ï¼šè·å–æ‰€æœ‰ç¬”è®°çš„æ ‡é¢˜
const titles = selectedNotes.map(note => note.noteTitle);
// å¦‚æœé€‰ä¸­äº†3ä¸ªç¬”è®°ï¼Œtitles å¯èƒ½æ˜¯ï¼š["ç¬”è®°1", "ç¬”è®°2", "ç¬”è®°3"]
```

> ğŸ’¡ **æ•°ç»„æ–¹æ³•é€Ÿè®°**ï¼š
> - `forEach` = å¯¹æ¯ä¸ªå…ƒç´ åšç‚¹ä»€ä¹ˆï¼ˆéå†ï¼‰
> - `filter` = ç­›é€‰å‡ºç¬¦åˆæ¡ä»¶çš„ï¼ˆè¿‡æ»¤ï¼‰
> - `map` = æŠŠæ¯ä¸ªå…ƒç´ è½¬æ¢æˆåˆ«çš„ä¸œè¥¿ï¼ˆæ˜ å°„ï¼‰
> - `find` = æ‰¾åˆ°ç¬¬ä¸€ä¸ªç¬¦åˆæ¡ä»¶çš„ï¼ˆæŸ¥æ‰¾ï¼‰

### 5. å¯¹è±¡ - æè¿°å¤æ‚çš„ä¸œè¥¿

å¦‚æœè¯´æ•°ç»„æ˜¯"æœ‰åºçš„åˆ—è¡¨"ï¼Œé‚£å¯¹è±¡å°±æ˜¯"æœ‰åå­—çš„å±æ€§é›†åˆ"ï¼š

```javascript
// æè¿°ä¸€æœ¬ä¹¦çš„ä¿¡æ¯
let book = {
  title: "JavaScript å…¥é—¨",
  author: "å¼ ä¸‰",
  pages: 200,
  isRead: true
};

// è·å–ä¿¡æ¯
console.log(book.title);        // "JavaScript å…¥é—¨"
console.log(book["author"]);    // "å¼ ä¸‰"ï¼ˆå¦ä¸€ç§å†™æ³•ï¼‰

// ä¿®æ”¹ä¿¡æ¯
book.pages = 250;               // ä¿®æ”¹é¡µæ•°
book.publisher = "æ¸…åå‡ºç‰ˆç¤¾";   // æ·»åŠ æ–°å±æ€§
```

**åœ¨æ’ä»¶ä¸­ï¼Œå¯¹è±¡æ— å¤„ä¸åœ¨ï¼š**
```javascript
// ç¬”è®°å¯¹è±¡åŒ…å«äº†å„ç§å±æ€§
const focusNote = MNNote.getFocusNote();
if (focusNote) {
  console.log(focusNote.noteTitle);    // æ ‡é¢˜
  console.log(focusNote.noteId);       // å”¯ä¸€ID
  console.log(focusNote.colorIndex);   // é¢œè‰²ç¼–å·
  console.log(focusNote.tags);         // æ ‡ç­¾æ•°ç»„
}

// åˆ›å»ºèœå•æ—¶ï¼Œç”¨å¯¹è±¡æè¿°èœå•ç»“æ„
const menuConfig = {
  action: "menu",
  menuItems: [
    {
      action: "copyTitle",
      menuTitle: "ğŸ“‹ å¤åˆ¶æ ‡é¢˜"
    },
    {
      action: "changeColor",
      menuTitle: "ğŸ¨ æ”¹å˜é¢œè‰²"
    }
  ]
};
```

> ğŸ”‘ **ç†è§£å¯¹è±¡çš„å…³é”®**ï¼šæŠŠå¯¹è±¡æƒ³è±¡æˆä¸€ä¸ª"èµ„æ–™å¡"ï¼Œä¸Šé¢è®°å½•äº†å„ç§ç›¸å…³ä¿¡æ¯ã€‚

### 6. å‡½æ•° - å¯é‡å¤ä½¿ç”¨çš„é­”æ³•

å‡½æ•°å°±åƒä¸€ä¸ª"é­”æ³•é…æ–¹"ï¼Œå®šä¹‰ä¸€æ¬¡ï¼Œå¯ä»¥åå¤ä½¿ç”¨ï¼š

```javascript
// å®šä¹‰ä¸€ä¸ª"æŠŠç¬”è®°å˜çº¢"çš„å‡½æ•°
function makeNoteRed(note) {
  note.colorIndex = 6;  // 6 æ˜¯çº¢è‰²
  MNUtil.showHUD("å·²æ ‡è®°ä¸ºçº¢è‰²ï¼");
}

// ä½¿ç”¨è¿™ä¸ªå‡½æ•°
const myNote = MNNote.getFocusNote();
if (myNote) {
  makeNoteRed(myNote);  // è°ƒç”¨å‡½æ•°
}
```

**ç°ä»£ JavaScript æ›´å–œæ¬¢ç”¨ç®­å¤´å‡½æ•°ï¼š**
```javascript
// ä¼ ç»Ÿå‡½æ•°å†™æ³•
function addPrefix(title) {
  return "ã€é‡è¦ã€‘" + title;
}

// ç®­å¤´å‡½æ•°å†™æ³•ï¼ˆåœ¨æ’ä»¶ä¸­æ›´å¸¸è§ï¼‰
const addPrefix = (title) => {
  return "ã€é‡è¦ã€‘" + title;
};

// å¦‚æœå‡½æ•°ä½“åªæœ‰ä¸€è¡Œï¼Œå¯ä»¥æ›´ç®€æ´
const addPrefix = title => "ã€é‡è¦ã€‘" + title;

// å®é™…åº”ç”¨ï¼šæ‰¹é‡å¤„ç†ç¬”è®°
const markAsImportant = (notes) => {
  notes.forEach(note => {
    note.noteTitle = addPrefix(note.noteTitle);
    note.colorIndex = 6;  // çº¢è‰²
  });
};
```

### 7. æ¡ä»¶åˆ¤æ–­ - è®©æ’ä»¶æ›´æ™ºèƒ½

ç¨‹åºéœ€è¦æ ¹æ®ä¸åŒæƒ…å†µåšä¸åŒçš„äº‹ï¼š

```javascript
// åŸºæœ¬çš„ if-else
const focusNote = MNNote.getFocusNote();

if (focusNote) {
  // æœ‰é€‰ä¸­ç¬”è®°æ—¶
  MNUtil.showHUD(`æ­£åœ¨å¤„ç†ï¼š${focusNote.noteTitle}`);
} else {
  // æ²¡æœ‰é€‰ä¸­æ—¶
  MNUtil.showHUD("è¯·å…ˆé€‰æ‹©ä¸€ä¸ªç¬”è®°ï¼");
  return;  // æå‰ç»“æŸ
}

// å¤šé‡æ¡ä»¶
if (focusNote.colorIndex === 0) {
  MNUtil.showHUD("è¿™æ˜¯ä¸ªæ— è‰²ç¬”è®°");
} else if (focusNote.colorIndex === 6) {
  MNUtil.showHUD("è¿™æ˜¯ä¸ªçº¢è‰²ç¬”è®°");
} else {
  MNUtil.showHUD("è¿™æ˜¯å…¶ä»–é¢œè‰²çš„ç¬”è®°");
}
```

**å®ç”¨æŠ€å·§ - çŸ­è·¯é€»è¾‘ï¼š**
```javascript
// && (AND) - æ‰€æœ‰æ¡ä»¶éƒ½è¦æ»¡è¶³
if (focusNote && focusNote.noteTitle && focusNote.noteTitle.includes("TODO")) {
  // å®‰å…¨åœ°æ£€æŸ¥ï¼šç¬”è®°å­˜åœ¨ ä¸” æœ‰æ ‡é¢˜ ä¸” æ ‡é¢˜åŒ…å«TODO
}

// || (OR) - ä»»ä¸€æ¡ä»¶æ»¡è¶³å³å¯
if (!focusNote || focusNote.colorIndex === 0) {
  MNUtil.showHUD("è¯·é€‰æ‹©ä¸€ä¸ªæœ‰é¢œè‰²çš„ç¬”è®°");
}

// ä¸‰å…ƒè¿ç®—ç¬¦ - ç®€æ´çš„æ¡ä»¶åˆ¤æ–­
const message = focusNote ? "å·²é€‰ä¸­ç¬”è®°" : "æœªé€‰ä¸­ç¬”è®°";
```

### 8. å¼‚æ­¥æ“ä½œ - ç­‰å¾…ç”¨æˆ·è¾“å…¥

æœ‰äº›æ“ä½œéœ€è¦æ—¶é—´ï¼Œæ¯”å¦‚ç­‰å¾…ç”¨æˆ·è¾“å…¥ï¼š

```javascript
// async/await è®©å¼‚æ­¥ä»£ç çœ‹èµ·æ¥åƒåŒæ­¥çš„
async function askUserForTitle() {
  // await è¡¨ç¤º"ç­‰å¾…"è¿™ä¸ªæ“ä½œå®Œæˆ
  const newTitle = await MNUtil.input("è¯·è¾“å…¥æ–°æ ‡é¢˜", "æ ‡é¢˜", ["ç¡®å®š"]);
  
  if (newTitle) {
    const focusNote = MNNote.getFocusNote();
    if (focusNote) {
      focusNote.noteTitle = newTitle;
      MNUtil.showHUD("æ ‡é¢˜å·²æ›´æ–°ï¼");
    }
  }
}

// è°ƒç”¨å¼‚æ­¥å‡½æ•°
askUserForTitle();  // æ³¨æ„ï¼šä¸éœ€è¦ awaitï¼Œé™¤éåœ¨å¦ä¸€ä¸ª async å‡½æ•°ä¸­
```

### ğŸ¯ å¿«é€Ÿå®æˆ˜ï¼šä½ çš„ç¬¬ä¸€ä¸ªå®Œæ•´åŠŸèƒ½ï¼ˆæ–°æ‰‹ä¿¡å¿ƒæå‡ï¼‰

å­¦äº†è¿™ä¹ˆå¤šï¼Œè®©æˆ‘ä»¬ç«‹å³å®æˆ˜ï¼ä¸‹é¢æ˜¯ä¸€ä¸ªå®Œæ•´çš„å°åŠŸèƒ½ï¼Œä½ å¯ä»¥ç›´æ¥å¤åˆ¶ä½¿ç”¨ï¼š

```javascript
// åŠŸèƒ½ï¼šç»™é€‰ä¸­çš„ç¬”è®°æ·»åŠ æ—¶é—´æˆ³
async function addTimestamp() {
  // 1. è·å–é€‰ä¸­çš„ç¬”è®°
  const focusNote = MNNote.getFocusNote();
  
  // 2. æ£€æŸ¥æ˜¯å¦æœ‰é€‰ä¸­
  if (!focusNote) {
    MNUtil.showHUD("âŒ è¯·å…ˆé€‰æ‹©ä¸€ä¸ªç¬”è®°");
    return;
  }
  
  // 3. è·å–å½“å‰æ—¶é—´
  const now = new Date();
  const timestamp = now.toLocaleString('zh-CN');
  
  // 4. åœ¨æ ‡é¢˜å‰æ·»åŠ æ—¶é—´æˆ³
  const oldTitle = focusNote.noteTitle;
  const newTitle = `[${timestamp}] ${oldTitle}`;
  
  // 5. ä½¿ç”¨æ’¤é”€åˆ†ç»„ï¼ˆè®©ç”¨æˆ·å¯ä»¥ä¸€é”®æ’¤é”€ï¼‰
  MNUtil.undoGrouping(() => {
    focusNote.noteTitle = newTitle;
    focusNote.colorIndex = 3;  // è®¾ä¸ºé»„è‰²
    focusNote.appendTextComment(`åŸæ ‡é¢˜ï¼š${oldTitle}`);
  });
  
  // 6. æ˜¾ç¤ºæˆåŠŸæ¶ˆæ¯
  MNUtil.showHUD("âœ… å·²æ·»åŠ æ—¶é—´æˆ³");
}

// æ‰§è¡Œå‡½æ•°
addTimestamp();
```

> ğŸ’¡ **æ­å–œï¼** ä½ åˆšåˆšå®Œæˆäº†ä¸€ä¸ªåŒ…å«æ‰€æœ‰åŸºç¡€çŸ¥è¯†çš„å®ç”¨åŠŸèƒ½ï¼š
> - âœ… ä½¿ç”¨äº†å˜é‡å­˜å‚¨æ•°æ®
> - âœ… ä½¿ç”¨äº†å¯¹è±¡å±æ€§ï¼ˆfocusNote.noteTitleï¼‰
> - âœ… ä½¿ç”¨äº†æ¡ä»¶åˆ¤æ–­ï¼ˆif è¯­å¥ï¼‰
> - âœ… ä½¿ç”¨äº†å­—ç¬¦ä¸²å¤„ç†ï¼ˆæ¨¡æ¿å­—ç¬¦ä¸²ï¼‰
> - âœ… ä½¿ç”¨äº†å‡½æ•°å°è£…åŠŸèƒ½
> - âœ… ä½¿ç”¨äº†é”™è¯¯å¤„ç†ï¼ˆæ£€æŸ¥ focusNoteï¼‰

### 9. é”™è¯¯å¤„ç† - è®©æ’ä»¶æ›´ç¨³å®š

å³ä½¿æ˜¯æœ€å¥½çš„ä»£ç ä¹Ÿå¯èƒ½å‡ºé”™ï¼Œæ‰€ä»¥è¦åšå¥½å‡†å¤‡ï¼š

```javascript
// ä½¿ç”¨ try-catch æ•è·é”™è¯¯
async function safeProcessNote() {
  try {
    const focusNote = MNNote.getFocusNote();
    if (!focusNote) {
      throw new Error("æ²¡æœ‰é€‰ä¸­ç¬”è®°");  // ä¸»åŠ¨æŠ›å‡ºé”™è¯¯
    }
    
    focusNote.noteTitle = "æ–°æ ‡é¢˜";
    MNUtil.showHUD("âœ… å¤„ç†æˆåŠŸ");
    
  } catch (error) {
    // é”™è¯¯æ—¶æ˜¾ç¤ºå‹å¥½çš„æç¤º
    MNUtil.showHUD(`âŒ æ“ä½œå¤±è´¥ï¼š${error.message}`);
  }
}
```

**é˜²å¾¡å¼ç¼–ç¨‹ - æå‰æ£€æŸ¥ï¼š**
```javascript
function processNotes(notes) {
  // æå‰æ£€æŸ¥å‚æ•°
  if (!notes || notes.length === 0) {
    MNUtil.showHUD("æ²¡æœ‰è¦å¤„ç†çš„ç¬”è®°");
    return;
  }
  
  // å®‰å…¨åœ°å¤„ç†æ¯ä¸ªç¬”è®°
  notes.forEach(note => {
    if (note && note.noteTitle) {  // åŒé‡æ£€æŸ¥
      note.noteTitle = `[å·²å¤„ç†] ${note.noteTitle}`;
    }
  });
  
  MNUtil.showHUD(`âœ… æˆåŠŸå¤„ç† ${notes.length} ä¸ªç¬”è®°`);
}
```

### 10. æŠŠçŸ¥è¯†ä¸²èµ·æ¥ - ç¬¬ä¸€ä¸ªå®Œæ•´åŠŸèƒ½

ç°åœ¨è®©æˆ‘ä»¬ç”¨å­¦åˆ°çš„çŸ¥è¯†å†™ä¸€ä¸ªå®ç”¨çš„åŠŸèƒ½ï¼š

```javascript
// åŠŸèƒ½ï¼šæ‰¹é‡æ•´ç†TODOç¬”è®°
async function organizeTodoNotes() {
  try {
    // 1. è·å–æ‰€æœ‰é€‰ä¸­çš„ç¬”è®°ï¼ˆæ•°ç»„ï¼‰
    const selectedNotes = MNNote.getFocusNotes();
    
    // 2. æ£€æŸ¥æ˜¯å¦æœ‰é€‰ä¸­ï¼ˆæ¡ä»¶åˆ¤æ–­ï¼‰
    if (!selectedNotes || selectedNotes.length === 0) {
      MNUtil.showHUD("è¯·å…ˆé€‰æ‹©è¦æ•´ç†çš„ç¬”è®°");
      return;
    }
    
    // 3. ç­›é€‰å‡ºTODOç¬”è®°ï¼ˆæ•°ç»„æ–¹æ³•ï¼‰
    const todoNotes = selectedNotes.filter(note => 
      note.noteTitle.includes("TODO")
    );
    
    // 4. è¯¢é—®ç”¨æˆ·æ“ä½œï¼ˆå¼‚æ­¥ï¼‰
    const action = await MNUtil.userSelect(
      "é€‰æ‹©æ“ä½œ", 
      "", 
      ["æ ‡è®°ä¸ºå®Œæˆ", "è®¾ä¸ºç´§æ€¥", "æ·»åŠ ä»Šæ—¥æ ‡ç­¾"]
    );
    
    // 5. æ ¹æ®é€‰æ‹©æ‰§è¡Œæ“ä½œï¼ˆæ¡ä»¶åˆ¤æ–­ï¼‰
    if (action === 0) return;  // ç”¨æˆ·å–æ¶ˆ
    
    // 6. æ‰¹é‡å¤„ç†ï¼ˆå‡½æ•° + å¾ªç¯ï¼‰
    MNUtil.undoGrouping(() => {
      todoNotes.forEach(note => {
        switch (action) {
          case 1:  // æ ‡è®°ä¸ºå®Œæˆ
            note.noteTitle = note.noteTitle.replace("TODO", "DONE");
            note.colorIndex = 8;  // ç»¿è‰²
            break;
          case 2:  // è®¾ä¸ºç´§æ€¥
            note.noteTitle = "ğŸ”¥ " + note.noteTitle;
            note.colorIndex = 6;  // çº¢è‰²
            break;
          case 3:  // æ·»åŠ ä»Šæ—¥æ ‡ç­¾
            note.appendTags([`ğŸ“… ${new Date().toLocaleDateString()}`]);
            break;
        }
      });
    });
    
    // 7. æ˜¾ç¤ºç»“æœï¼ˆå­—ç¬¦ä¸²æ¨¡æ¿ï¼‰
    MNUtil.showHUD(`âœ… æˆåŠŸå¤„ç† ${todoNotes.length} ä¸ªTODOç¬”è®°`);
    
  } catch (error) {
    // 8. é”™è¯¯å¤„ç†
    MNUtil.showHUD(`âŒ å‡ºé”™äº†ï¼š${error.message}`);
  }
}

// è¿è¡Œè¿™ä¸ªå‡½æ•°
organizeTodoNotes();
```

> ğŸ‰ **æ­å–œä½ ï¼**  
> å¦‚æœä½ èƒ½ç†è§£ä¸Šé¢è¿™ä¸ªå‡½æ•°ï¼Œä½ å·²ç»æŒæ¡äº† MarginNote æ’ä»¶å¼€å‘æ‰€éœ€çš„ JavaScript åŸºç¡€ã€‚æ¥ä¸‹æ¥ï¼Œè®©æˆ‘ä»¬çœ‹çœ‹å¦‚ä½•æŠŠè¿™äº›çŸ¥è¯†åº”ç”¨åˆ°å®é™…çš„æ’ä»¶å¼€å‘ä¸­ã€‚

## MarginNote æ’ä»¶ç»“æ„

> ğŸ—ï¸ **æ’ä»¶ = é…ç½®æ–‡ä»¶ + ä»£ç æ–‡ä»¶ + èµ„æºæ–‡ä»¶**  
> å°±åƒç›–æˆ¿å­éœ€è¦å›¾çº¸ã€ææ–™å’Œå·¥å…·ï¼ŒMarginNote æ’ä»¶ä¹Ÿç”±è¿™ä¸‰éƒ¨åˆ†ç»„æˆã€‚

### 1. æ’ä»¶çš„"èº«ä»½è¯" - æ–‡ä»¶ç»“æ„

```
my-plugin/                  # ä½ çš„æ’ä»¶æ–‡ä»¶å¤¹
â”œâ”€â”€ ğŸ“„ main.js             # æ’ä»¶çš„"å¤§è„‘"ï¼ˆå¿…éœ€ï¼‰
â”œâ”€â”€ ğŸ“‹ mnaddon.json        # æ’ä»¶çš„"èº«ä»½è¯"ï¼ˆå¿…éœ€ï¼‰
â”œâ”€â”€ ğŸ¨ logo.png            # æ’ä»¶çš„"å¤´åƒ"44Ã—44åƒç´ ï¼ˆå¿…éœ€ï¼‰
â”œâ”€â”€ ğŸ”§ utils.js            # å·¥å…·ç®±ï¼ˆå¯é€‰ï¼‰
â””â”€â”€ ğŸ“ resources/          # èµ„æºæ–‡ä»¶å¤¹ï¼ˆå¯é€‰ï¼‰
    â”œâ”€â”€ images/            # å›¾ç‰‡èµ„æº
    â””â”€â”€ html/              # ç½‘é¡µæ–‡ä»¶
```

### 2. mnaddon.json - æ’ä»¶é…ç½®æ–‡ä»¶

è¿™ä¸ªæ–‡ä»¶å‘Šè¯‰ MarginNote ä½ çš„æ’ä»¶æ˜¯è°ï¼š

```json
{
  "addonid": "com.example.myplugin",     // å”¯ä¸€IDï¼Œåƒèº«ä»½è¯å·
  "name": "æˆ‘çš„ç¬¬ä¸€ä¸ªæ’ä»¶",                // æ˜¾ç¤ºåç§°
  "author": "ä½ çš„åå­—",                    // ä½œè€…
  "version": "1.0.0",                     // ç‰ˆæœ¬å·
  "marginnote_version_min": "3.7.0",      // æœ€ä½æ”¯æŒçš„ MN ç‰ˆæœ¬
  "cert_key": ""                          // è®¤è¯å¯†é’¥ï¼ˆç•™ç©ºå³å¯ï¼‰
}
```

> ğŸ’¡ **ç‰ˆæœ¬å·è§„åˆ™**ï¼šä¸»ç‰ˆæœ¬.æ¬¡ç‰ˆæœ¬.ä¿®è®¢ç‰ˆæœ¬  
> - 1.0.0 â†’ 1.0.1ï¼ˆä¿®å¤bugï¼‰  
> - 1.0.0 â†’ 1.1.0ï¼ˆæ–°åŠŸèƒ½ï¼‰  
> - 1.0.0 â†’ 2.0.0ï¼ˆå¤§æ”¹ç‰ˆï¼‰

### 3. æ’ä»¶ç”Ÿå‘½å‘¨æœŸ - ä»å‡ºç”Ÿåˆ°æ¶ˆäº¡

æ ¹æ® mntoolbar_learning çš„è¯¦ç»†æ³¨é‡Šï¼Œæ’ä»¶çš„ç”Ÿå‘½å‘¨æœŸå°±åƒäººçš„ä¸€ç”Ÿï¼š

```
ğŸš€ æ’ä»¶å·¥å‚å‡½æ•° JSB.newAddon(mainPath)
         â”‚
         â”œâ”€ ğŸ“¦ åŠ è½½ä¾èµ–æ¨¡å—
         â”‚    â””â”€ JSB.require('utils')
         â”‚
         â”œâ”€ ğŸ” æ£€æŸ¥ MNUtilsï¼ˆå¦‚æœéœ€è¦ï¼‰
         â”‚    â””â”€ ç¡®ä¿å¿…è¦çš„ä¾èµ–å­˜åœ¨
         â”‚
         â””â”€ ğŸ¯ å®šä¹‰æ’ä»¶ç±»
              â”‚
              â”œâ”€ ğŸŒŸ sceneWillConnect (å‡ºç”Ÿ)
              â”‚    â”œâ”€ åˆå§‹åŒ–æ’ä»¶æ ¸å¿ƒ
              â”‚    â”œâ”€ è®¾ç½®åˆå§‹çŠ¶æ€
              â”‚    â””â”€ æ³¨å†Œäº‹ä»¶ç›‘å¬å™¨
              â”‚
              â”œâ”€ ğŸ“š notebookWillOpen (å¼€å§‹å·¥ä½œ)
              â”‚    â”œâ”€ åˆ›å»ºç”¨æˆ·ç•Œé¢
              â”‚    â”œâ”€ åŠ è½½é…ç½®
              â”‚    â””â”€ å‡†å¤‡å·¥å…·æ 
              â”‚
              â”œâ”€ ğŸ® ç”¨æˆ·äº¤äº’é˜¶æ®µ
              â”‚    â”œâ”€ onPopupMenuOnNote
              â”‚    â”œâ”€ onPopupMenuOnSelection
              â”‚    â””â”€ è‡ªå®šä¹‰åŠŸèƒ½æ‰§è¡Œ
              â”‚
              â”œâ”€ ğŸ“• notebookWillClose (å‡†å¤‡ä¼‘æ¯)
              â”‚    â”œâ”€ ä¿å­˜ç”¨æˆ·æ•°æ®
              â”‚    â””â”€ æ¸…ç†ä¸´æ—¶èµ„æº
              â”‚
              â””â”€ ğŸŒ… sceneDidDisconnect (ç»“æŸ)
                   â”œâ”€ ç§»é™¤äº‹ä»¶ç›‘å¬
                   â””â”€ é‡Šæ”¾æ‰€æœ‰èµ„æº
```

### 4. main.js - æ’ä»¶ä¸»æ–‡ä»¶è¯¦è§£

åŸºäº mntoolbar_learning çš„æ·±å…¥ç†è§£ï¼Œè¿™æ˜¯ä¸€ä¸ªå®Œæ•´çš„æ’ä»¶æ¡†æ¶ï¼š

```javascript
/**
 * ğŸš€ æ’ä»¶å·¥å‚å‡½æ•° - MarginNote æ’ä»¶ç³»ç»Ÿçš„å…¥å£
 * 
 * å½“ MarginNote åŠ è½½æ’ä»¶æ—¶ä¼šè°ƒç”¨è¿™ä¸ªå‡½æ•°
 * @param {string} mainPath - æ’ä»¶çš„å®‰è£…è·¯å¾„
 */
JSB.newAddon = function(mainPath) {
  // ğŸ“¦ ç¬¬ä¸€æ­¥ï¼šåŠ è½½ä¾èµ–ï¼ˆå¦‚æœæœ‰ï¼‰
  // JSB.require('utils');  // åŠ è½½å·¥å…·æ¨¡å—
  
  // ğŸ¯ ç¬¬äºŒæ­¥ï¼šè·å–æ’ä»¶å•ä¾‹çš„è¾…åŠ©å‡½æ•°ï¼ˆJSB æ¡†æ¶ç‰¹æ®Šè¦æ±‚ï¼‰
  const getMyPlugin = () => self;
  
  /**
   * ğŸ“± å®šä¹‰æ’ä»¶ä¸»ç±»
   * ç»§æ‰¿è‡ª JSExtensionï¼Œè·å¾—ç”Ÿå‘½å‘¨æœŸæ–¹æ³•
   */
  var MyPlugin = JSB.defineClass('MyPlugin : JSExtension', {
    
    /**
     * ğŸŒŸ åœºæ™¯å³å°†è¿æ¥ - æ’ä»¶ç”Ÿå‘½å‘¨æœŸçš„å¼€å§‹
     * è°ƒç”¨æ—¶æœºï¼šæ‰“å¼€ MarginNoteã€åˆ›å»ºæ–°çª—å£ã€ä»åå°æ¢å¤
     */
    sceneWillConnect: function() {
      // è·å–æ’ä»¶å®ä¾‹ï¼ˆå¿…é¡»ç¬¬ä¸€è¡Œï¼‰
      let self = getMyPlugin();
      
      // åˆå§‹åŒ–æ’ä»¶çŠ¶æ€
      self.isReady = false;
      self.selectedText = "";
      
      // æ˜¾ç¤ºå¯åŠ¨æ¶ˆæ¯
      MNUtil.showHUD("ğŸš€ æ’ä»¶å·²å¯åŠ¨");
      
      // æ³¨å†Œäº‹ä»¶ç›‘å¬å™¨ï¼ˆè§‚å¯Ÿè€…æ¨¡å¼ï¼‰
      // å‚æ•°ï¼š(è§‚å¯Ÿè€…, æ–¹æ³•å, é€šçŸ¥å)
      MNUtil.addObserver(self, 'onPopupMenuOnNote:', 'PopupMenuOnNote');
      MNUtil.addObserver(self, 'onPopupMenuOnSelection:', 'PopupMenuOnSelection');
    },
    
    /**
     * ğŸŒ… åœºæ™¯å·²æ–­å¼€è¿æ¥ - æ¸…ç†èµ„æº
     * è°ƒç”¨æ—¶æœºï¼šå…³é—­æ’ä»¶ã€å…³é—­çª—å£
     */
    sceneDidDisconnect: function() {
      // å®‰å…¨æ£€æŸ¥
      if (typeof MNUtil === 'undefined') return;
      
      let self = getMyPlugin();
      
      // ç§»é™¤æ‰€æœ‰ç›‘å¬å™¨ï¼ˆé˜²æ­¢å†…å­˜æ³„æ¼ï¼‰
      MNUtil.removeObserver(self, 'PopupMenuOnNote');
      MNUtil.removeObserver(self, 'PopupMenuOnSelection');
      
      // æ¸…ç†å…¶ä»–èµ„æº
      self.isReady = false;
    },
    
    /**
     * ğŸ“š ç¬”è®°æœ¬å³å°†æ‰“å¼€
     * è°ƒç”¨æ—¶æœºï¼šç”¨æˆ·æ‰“å¼€ç¬”è®°æœ¬ã€åˆ‡æ¢ç¬”è®°æœ¬
     */
    notebookWillOpen: function(notebookId) {
      let self = getMyPlugin();
      
      // è®°å½•å½“å‰ç¬”è®°æœ¬
      self.currentNotebookId = notebookId;
      
      // å»¶è¿Ÿåˆå§‹åŒ–ï¼ˆç»™ç•Œé¢æ—¶é—´å®Œå…¨åŠ è½½ï¼‰
      MNUtil.delay(0.5).then(() => {
        self.isReady = true;
        MNUtil.showHUD("ğŸ“š ç¬”è®°æœ¬å·²å°±ç»ª");
      });
    },
    
    /**
     * ğŸ“ ç¬”è®°å¼¹å‡ºèœå•äº‹ä»¶
     * å½“ç”¨æˆ·ç‚¹å‡»ç¬”è®°å¡ç‰‡å¼¹å‡ºèœå•æ—¶è§¦å‘
     */
    onPopupMenuOnNote: function(sender) {
      // å‚æ•°éªŒè¯ï¼ˆé˜²å¾¡å¼ç¼–ç¨‹ï¼‰
      if (!sender || !sender.userInfo || !sender.userInfo.note) return;
      
      let self = getMyPlugin();
      let note = sender.userInfo.note;
      
      // æ·»åŠ è‡ªå®šä¹‰èœå•é¡¹
      sender.userInfo.menuController.commandTable.push({
        title: "ğŸ¨ æ”¹å˜é¢œè‰²",
        object: self,
        selector: "changeNoteColor:",
        param: note.noteId
      });
      
      sender.userInfo.menuController.commandTable.push({
        title: "ğŸ“‹ å¤åˆ¶æ ‡é¢˜",
        object: self,
        selector: "copyNoteTitle:",
        param: note.noteId
      });
    },
    
    /**
     * âœï¸ é€‰ä¸­æ–‡æœ¬å¼¹å‡ºèœå•äº‹ä»¶
     */
    onPopupMenuOnSelection: function(sender) {
      if (!sender || !sender.userInfo) return;
      
      let self = getMyPlugin();
      
      // ä¿å­˜é€‰ä¸­çš„æ–‡æœ¬
      self.selectedText = sender.userInfo.documentController.selectionText;
      
      // æ·»åŠ èœå•é¡¹
      sender.userInfo.menuController.commandTable.push({
        title: "ğŸ” æœç´¢é€‰ä¸­æ–‡æœ¬",
        object: self,
        selector: "searchSelectedText:",
        param: self.selectedText
      });
    },
    
    // ========== è‡ªå®šä¹‰åŠŸèƒ½å®ç° ==========
    
    /**
     * æ”¹å˜ç¬”è®°é¢œè‰²
     */
    changeNoteColor: function(noteId) {
      let self = getMyPlugin();
      const note = MNNote.new(noteId);
      
      if (!note) {
        MNUtil.showHUD("âŒ æ‰¾ä¸åˆ°ç¬”è®°");
        return;
      }
      
      // ä½¿ç”¨æ’¤é”€åˆ†ç»„ï¼ˆç”¨æˆ·å¯ä»¥æ’¤é”€ï¼‰
      MNUtil.undoGrouping(() => {
        // å¾ªç¯åˆ‡æ¢é¢œè‰²ï¼ˆ0-15ï¼‰
        note.colorIndex = (note.colorIndex + 1) % 16;
        
        // é¢œè‰²åç§°æ˜ å°„
        const colorNames = ["æ— è‰²", "æ·¡é»„", "æ·¡è“", "é»„è‰²", "æ·±è“", 
                          "æ©™è‰²", "çº¢è‰²", "ç´«è‰²", "æ·¡ç»¿", "æ·±ç»¿",
                          "ç°è‰²", "æ·±æ©™", "æ£•è‰²", "æ·±çº¢", "æ·±ç´«", "æ·±ç°"];
        
        MNUtil.showHUD(`ğŸ¨ å·²æ”¹ä¸º${colorNames[note.colorIndex]}`);
      });
    },
    
    /**
     * å¤åˆ¶ç¬”è®°æ ‡é¢˜
     */
    copyNoteTitle: function(noteId) {
      const note = MNNote.new(noteId);
      if (!note) return;
      
      MNUtil.copy(note.noteTitle);
      MNUtil.showHUD("ğŸ“‹ å·²å¤åˆ¶æ ‡é¢˜");
    },
    
    /**
     * æœç´¢é€‰ä¸­æ–‡æœ¬
     */
    searchSelectedText: function(text) {
      if (!text) return;
      
      // åœ¨å½“å‰ç¬”è®°æœ¬ä¸­æœç´¢
      const notebook = MNNotebook.currentNotebook;
      if (!notebook) return;
      
      // è¿™é‡Œå¯ä»¥å®ç°æœç´¢é€»è¾‘
      MNUtil.showHUD(`ğŸ” æœç´¢"${text}"...`);
    }
  });
  
  // è¿”å›æ’ä»¶ç±»ä¾› MarginNote ç®¡ç†
  return MyPlugin;
};
```

### 5. JSB æ¡†æ¶çš„ç‰¹æ®Šè§„åˆ™

#### âš ï¸ self å¼•ç”¨é™·é˜±ï¼ˆæœ€å®¹æ˜“çŠ¯çš„é”™è¯¯ï¼‰

åœ¨æ ‡å‡† JavaScript ä¸­ï¼Œ`this` æŒ‡å‘å½“å‰å¯¹è±¡ã€‚ä½†åœ¨ JSB æ¡†æ¶ä¸­ï¼Œæƒ…å†µå®Œå…¨ä¸åŒï¼š

```javascript
// âŒ æ°¸è¿œä¸è¦åœ¨ JSB.defineClass çš„æ–¹æ³•ä¸­è¿™æ ·åš
myMethod: function() {
  let self = this;  // è¿™åœ¨ JSB ä¸­è·å–ä¸åˆ°æ­£ç¡®çš„å®ä¾‹ï¼
  self.someProperty = "value";  // ä¼šæŠ¥é”™
}

// âœ… æ­£ç¡®çš„åšæ³•ï¼ˆæ¥è‡ª mntoolbar_learningï¼‰
const getMyPlugin = () => self;  // åœ¨æ–‡ä»¶é¡¶éƒ¨å®šä¹‰

myMethod: function() {
  let self = getMyPlugin();  // é€šè¿‡å‡½æ•°è·å–å®ä¾‹
  self.someProperty = "value";  // æ­£å¸¸å·¥ä½œ
}
```

**ä¸ºä»€ä¹ˆä¼šè¿™æ ·ï¼Ÿ**
- JSB æ˜¯ JavaScript Bridgeï¼Œæ¡¥æ¥äº† JS å’Œ Objective-C
- `this` çš„è¡Œä¸ºè¢«ä¿®æ”¹ä»¥é€‚åº”åŸç”Ÿæ¡†æ¶
- `self` æ˜¯ JSB æä¾›çš„å…¨å±€å˜é‡ï¼ŒæŒ‡å‘æ’ä»¶å®ä¾‹

### 6. äº‹ä»¶é©±åŠ¨æ¶æ„

MarginNote æ’ä»¶é‡‡ç”¨è§‚å¯Ÿè€…æ¨¡å¼ï¼Œé€šè¿‡ NSNotificationCenter å®ç°ï¼š

```javascript
// æ³¨å†Œè§‚å¯Ÿè€…
MNUtil.addObserver(self, 'onEventName:', 'NotificationName');

// äº‹ä»¶è§¦å‘æ—¶ï¼Œä¼šè°ƒç”¨ onEventName: æ–¹æ³•
onEventName: function(sender) {
  // sender.userInfo åŒ…å«äº‹ä»¶æ•°æ®
}

// è®°å¾—åœ¨ sceneDidDisconnect ä¸­ç§»é™¤
MNUtil.removeObserver(self, 'NotificationName');
```

**å¸¸ç”¨äº‹ä»¶åˆ—è¡¨ï¼š**
- `PopupMenuOnNote` - ç¬”è®°èœå•å¼¹å‡º
- `PopupMenuOnSelection` - æ–‡æœ¬é€‰æ‹©èœå•å¼¹å‡º
- `ProcessNewExcerpt` - æ–°å»ºæ‘˜å½•
- `ChangeExcerptRange` - ä¿®æ”¹æ‘˜å½•èŒƒå›´
- `ClosePopupMenuOnNote` - å…³é—­ç¬”è®°èœå•

> ğŸ¯ **æœ€ä½³å®è·µ**ï¼š
> 1. æ€»æ˜¯åœ¨ `sceneWillConnect` ä¸­æ³¨å†Œç›‘å¬å™¨
> 2. æ€»æ˜¯åœ¨ `sceneDidDisconnect` ä¸­ç§»é™¤ç›‘å¬å™¨
> 3. äº‹ä»¶å¤„ç†æ–¹æ³•å¼€å¤´è¿›è¡Œå‚æ•°éªŒè¯
> 4. ä½¿ç”¨ try-catch ä¿æŠ¤äº‹ä»¶å¤„ç†é€»è¾‘

## MNUtils API å…¥é—¨ - è®©æ’ä»¶"æ´»"èµ·æ¥

### ğŸ¯ å­¦ä¹ ç›®æ ‡

å®Œæˆæœ¬ç« åï¼Œä½ å°†èƒ½å¤Ÿï¼š
- âœ… ä¸ç”¨æˆ·è¿›è¡Œå„ç§äº¤äº’ï¼ˆæ˜¾ç¤ºæ¶ˆæ¯ã€è·å–è¾“å…¥ï¼‰
- âœ… æ“ä½œç¬”è®°ï¼ˆè·å–ã€ä¿®æ”¹ã€æ‰¹é‡å¤„ç†ï¼‰
- âœ… ä½¿ç”¨é«˜çº§åŠŸèƒ½ï¼ˆå‰ªè´´æ¿ã€èœå•ã€æ–‡ä»¶æ“ä½œï¼‰

### å¼€å§‹ä¹‹å‰ï¼šå®‰è£… MNUtils

MNUtils å°±åƒæ˜¯æ’ä»¶å¼€å‘çš„"ç‘å£«å†›åˆ€"ï¼Œæä¾›äº† 300+ ä¸ªå®ç”¨å·¥å…·ã€‚é¦–å…ˆéœ€è¦ç¡®ä¿å®ƒå¯ç”¨ï¼š

```javascript
JSB.newAddon = function(mainPath) {
  // åŠ è½½ MNUtils
  JSB.require('mnutils');
  
  var MyPlugin = JSB.defineClass('MyPlugin : JSExtension', {
    sceneWillConnect: function() {
      // æ£€æŸ¥ MNUtils æ˜¯å¦å¯ç”¨
      if (typeof MNUtil === 'undefined') {
        alert("è¯·å…ˆå®‰è£… MNUtils æ’ä»¶");
        return;
      }
      
      // å¯ä»¥å¼€å§‹ä½¿ç”¨äº†ï¼
      MNUtil.showHUD("æ’ä»¶å·²å¯åŠ¨");
    }
  });
  
  return MyPlugin;
};
```

> ğŸ’¡ **æ–°æ‰‹æç¤º**ï¼šMNUtils æ˜¯ä¸€ä¸ªç‹¬ç«‹çš„æ’ä»¶ï¼Œéœ€è¦å…ˆä»æ’ä»¶å•†åº—å®‰è£…ã€‚å®‰è£…åï¼Œå…¶ä»–æ’ä»¶å°±å¯ä»¥ä½¿ç”¨å®ƒæä¾›çš„åŠŸèƒ½äº†ã€‚

### ç¬¬ä¸€ç«™ï¼šä¸ç”¨æˆ·å¯¹è¯ï¼ˆè®©æ’ä»¶æœ‰åé¦ˆï¼‰

æƒ³è±¡ä¸€ä¸‹ï¼Œå¦‚æœæ’ä»¶é»˜é»˜å·¥ä½œï¼Œç”¨æˆ·å®Œå…¨ä¸çŸ¥é“å‘ç”Ÿäº†ä»€ä¹ˆï¼Œä½“éªŒä¼šå¾ˆç³Ÿç³•ã€‚æ‰€ä»¥ç¬¬ä¸€æ­¥ï¼Œæˆ‘ä»¬è¦å­¦ä¼š"è¯´è¯"ã€‚

#### ğŸ—¨ï¸ æœ€ç®€å•çš„å¼€å§‹ - showHUD

`showHUD` å°±åƒæ‰‹æœºä¸Šçš„é€šçŸ¥æç¤ºï¼Œç®€å•ä½†å¾ˆæœ‰ç”¨ï¼š

```javascript
// å‘Šè¯‰ç”¨æˆ·å‘ç”Ÿäº†ä»€ä¹ˆ
MNUtil.showHUD("âœ… æ“ä½œæˆåŠŸï¼");     // é»˜è®¤æ˜¾ç¤º 2 ç§’

// å¤„ç†è€—æ—¶æ“ä½œæ—¶
MNUtil.showHUD("â³ æ­£åœ¨å¤„ç†...", 5);  // æ˜¾ç¤º 5 ç§’

// é‡åˆ°é”™è¯¯æ—¶
MNUtil.showHUD("âŒ æ“ä½œå¤±è´¥ï¼šè¯·å…ˆé€‰æ‹©ç¬”è®°", -1);  // éœ€è¦æ‰‹åŠ¨å…³é—­
```

> ğŸ’¡ **ä»€ä¹ˆæ—¶å€™ç”¨ï¼Ÿ**
> - æ“ä½œå®Œæˆæ—¶ï¼šç»™ç”¨æˆ·ä¸€ä¸ªåé¦ˆ
> - å¼€å§‹å¤„ç†æ—¶ï¼šè®©ç”¨æˆ·çŸ¥é“æ’ä»¶åœ¨å·¥ä½œ
> - å‡ºé”™æ—¶ï¼šå‘Šè¯‰ç”¨æˆ·å“ªé‡Œå‡ºäº†é—®é¢˜

#### ğŸ¤” è®©ç”¨æˆ·åšé€‰æ‹© - confirm

æœ‰æ—¶å€™æˆ‘ä»¬éœ€è¦ç”¨æˆ·ç¡®è®¤ï¼Œç‰¹åˆ«æ˜¯åˆ é™¤ç­‰å±é™©æ“ä½œï¼š

```javascript
async function deleteNotes() {
  // å…ˆé—®é—®ç”¨æˆ·æ˜¯å¦ç¡®å®š
  const confirmed = await MNUtil.confirm(
    "ç¡®è®¤åˆ é™¤ï¼Ÿ", 
    "å°†åˆ é™¤æ‰€æœ‰é€‰ä¸­çš„ç¬”è®°ï¼Œæ­¤æ“ä½œä¸å¯æ¢å¤"
  );
  
  if (confirmed) {
    // ç”¨æˆ·ç‚¹äº†"ç¡®å®š"
    MNUtil.showHUD("æ­£åœ¨åˆ é™¤...");
    // æ‰§è¡Œåˆ é™¤æ“ä½œ
  } else {
    // ç”¨æˆ·ç‚¹äº†"å–æ¶ˆ"
    MNUtil.showHUD("å·²å–æ¶ˆ");
  }
}
```

#### âœï¸ è·å–ç”¨æˆ·è¾“å…¥ - input

éœ€è¦ç”¨æˆ·è¾“å…¥æ–‡å­—æ—¶ï¼š

```javascript
async function renameNote() {
  const focusNote = MNNote.getFocusNote();
  if (!focusNote) {
    MNUtil.showHUD("è¯·å…ˆé€‰æ‹©ç¬”è®°");
    return;
  }
  
  // è·å–æ–°æ ‡é¢˜
  const newTitle = await MNUtil.input(
    "é‡å‘½åç¬”è®°",
    "è¯·è¾“å…¥æ–°çš„æ ‡é¢˜",
    ["ç¡®å®š"]  // æŒ‰é’®æ–‡å­—
  );
  
  if (newTitle) {
    // ç”¨æˆ·è¾“å…¥äº†å†…å®¹
    MNUtil.undoGrouping(() => {
      focusNote.noteTitle = newTitle;
    });
    MNUtil.showHUD("âœ… å·²é‡å‘½å");
  }
}
```

#### ğŸ“‹ å¤šé¡¹é€‰æ‹© - userSelect

å½“æœ‰å¤šä¸ªé€‰é¡¹è®©ç”¨æˆ·é€‰æ‹©æ—¶ï¼š

```javascript
async function changeNoteColor() {
  const colorOptions = [
    "ğŸ”´ çº¢è‰² - é‡è¦",
    "ğŸŸ¡ é»„è‰² - æ³¨æ„", 
    "ğŸ”µ è“è‰² - ä¿¡æ¯",
    "ğŸŸ¢ ç»¿è‰² - å®Œæˆ"
  ];
  
  const selected = await MNUtil.userSelect(
    "é€‰æ‹©é¢œè‰²",
    "ç»™ç¬”è®°è®¾ç½®ä»€ä¹ˆé¢œè‰²ï¼Ÿ",
    colorOptions
  );
  
  if (selected > 0) {  // 0 è¡¨ç¤ºå–æ¶ˆ
    const colorMap = {1: 6, 2: 3, 3: 2, 4: 8};  // é€‰é¡¹å¯¹åº”çš„é¢œè‰²ç´¢å¼•
    const focusNote = MNNote.getFocusNote();
    
    if (focusNote) {
      MNUtil.undoGrouping(() => {
        focusNote.colorIndex = colorMap[selected];
      });
      MNUtil.showHUD(`âœ… å·²è®¾ç½®ä¸º${colorOptions[selected - 1]}`);
    }
  }
}
```

#### ğŸ¯ æ–°æ‰‹ä»»åŠ¡ï¼šåˆ›å»ºä¸€ä¸ªé—®å€™æ’ä»¶

æŠŠä¸Šé¢å­¦åˆ°çš„ç»„åˆèµ·æ¥ï¼Œåˆ›å»ºä½ çš„ç¬¬ä¸€ä¸ªäº¤äº’å¼åŠŸèƒ½ï¼š

```javascript
async function greetUser() {
  // 1. è·å–ç”¨æˆ·åå­—
  const name = await MNUtil.input("ä½ å¥½ï¼", "è¯·é—®æ€ä¹ˆç§°å‘¼ä½ ï¼Ÿ", ["ç¡®å®š"]);
  
  if (!name) {
    MNUtil.showHUD("ğŸ‘‹ ä¸‹æ¬¡è§ï¼");
    return;
  }
  
  // 2. è¯¢é—®éœ€æ±‚
  const needs = [
    "ğŸ“ æ•´ç†ç¬”è®°",
    "ğŸ¨ æ‰¹é‡æ”¹è‰²",
    "ğŸ·ï¸ æ·»åŠ æ ‡ç­¾",
    "ğŸ”— åˆ›å»ºé“¾æ¥"
  ];
  
  const selected = await MNUtil.userSelect(
    `ä½ å¥½ï¼Œ${name}ï¼`,
    "éœ€è¦ä»€ä¹ˆå¸®åŠ©ï¼Ÿ",
    needs
  );
  
  // 3. æ ¹æ®é€‰æ‹©ç»™å‡ºåé¦ˆ
  if (selected > 0) {
    MNUtil.showHUD(`âœ… æ˜ç™½äº†ï¼è®©æˆ‘ä»¬å¼€å§‹${needs[selected - 1]}`);
    // è¿™é‡Œå¯ä»¥è°ƒç”¨ç›¸åº”çš„åŠŸèƒ½
  }
}
```

> ğŸ‰ **æ­å–œï¼** ä½ å·²ç»å­¦ä¼šäº†ä¸ç”¨æˆ·äº¤äº’çš„æ‰€æœ‰åŸºæœ¬æ–¹æ³•ã€‚ç°åœ¨ä½ çš„æ’ä»¶å¯ä»¥"è¯´è¯"ã€"æé—®"ã€"å€¾å¬"äº†ï¼

### ç¬¬äºŒç«™ï¼šæ“ä½œç¬”è®°ï¼ˆä½ çš„ä¸»è¦å·¥ä½œå¯¹è±¡ï¼‰

ç¬”è®°æ˜¯ MarginNote çš„æ ¸å¿ƒï¼Œä¹Ÿæ˜¯æ’ä»¶æœ€å¸¸æ“ä½œçš„å¯¹è±¡ã€‚è®©æˆ‘ä»¬åƒæ­ç§¯æœ¨ä¸€æ ·ï¼Œä¸€æ­¥æ­¥å­¦ä¼šæ“ä½œå®ƒä»¬ã€‚

#### ğŸ¯ ç¬¬ä¸€æ­¥ï¼šæ‰¾åˆ°è¦æ“ä½œçš„ç¬”è®°

åœ¨æ“ä½œç¬”è®°ä¹‹å‰ï¼Œæˆ‘ä»¬éœ€è¦å…ˆ"æ‹¿åˆ°"å®ƒã€‚å°±åƒä½ è¦ä¿®æ”¹ä¸€ä»½æ–‡ä»¶ï¼Œå¾—å…ˆæ‰¾åˆ°è¿™ä¸ªæ–‡ä»¶ã€‚

```javascript
// æœ€å¸¸ç”¨ï¼šè·å–ç”¨æˆ·å½“å‰é€‰ä¸­çš„ç¬”è®°
const focusNote = MNNote.getFocusNote();

// å§‹ç»ˆè¦æ£€æŸ¥æ˜¯å¦çœŸçš„æ‹¿åˆ°äº†
if (!focusNote) {
  MNUtil.showHUD("âŒ è¯·å…ˆé€‰æ‹©ä¸€ä¸ªç¬”è®°");
  return;
}

// ç°åœ¨å¯ä»¥å®‰å…¨åœ°ä½¿ç”¨äº†
MNUtil.showHUD(`âœ… æ‰¾åˆ°äº†ï¼š${focusNote.noteTitle}`);
```

> ğŸ’¡ **ä¸ºä»€ä¹ˆè¦æ£€æŸ¥ï¼Ÿ**  
> ç”¨æˆ·å¯èƒ½æ²¡æœ‰é€‰ä¸­ä»»ä½•ç¬”è®°å°±ç‚¹å‡»äº†ä½ çš„æŒ‰é’®ã€‚å¦‚æœä¸æ£€æŸ¥å°±ç›´æ¥æ“ä½œï¼Œæ’ä»¶ä¼šå´©æºƒã€‚è®°ä½ï¼š**æ°¸è¿œä¸è¦å‡è®¾ç¬”è®°å­˜åœ¨**ã€‚

#### ğŸ“š æ‰¹é‡è·å–ï¼šå¤„ç†å¤šä¸ªç¬”è®°

æœ‰æ—¶å€™éœ€è¦åŒæ—¶å¤„ç†å¤šä¸ªç¬”è®°ï¼š

```javascript
// è·å–æ‰€æœ‰é€‰ä¸­çš„ç¬”è®°
const selectedNotes = MNNote.getFocusNotes();

if (selectedNotes.length === 0) {
  MNUtil.showHUD("âŒ è¯·è‡³å°‘é€‰æ‹©ä¸€ä¸ªç¬”è®°");
  return;
}

MNUtil.showHUD(`âœ… é€‰ä¸­äº† ${selectedNotes.length} ä¸ªç¬”è®°`);

// å¤„ç†æ¯ä¸€ä¸ªç¬”è®°
selectedNotes.forEach((note, index) => {
  console.log(`ç¬¬ ${index + 1} ä¸ªç¬”è®°ï¼š${note.noteTitle}`);
});
```

#### ğŸ” äº†è§£ç¬”è®°çš„"èº«ä»½è¯"

æ¯ä¸ªç¬”è®°éƒ½æœ‰å¾ˆå¤šå±æ€§ï¼Œå°±åƒäººæœ‰åå­—ã€å¹´é¾„ã€èº«é«˜ä¸€æ ·ï¼š

```javascript
function inspectNote() {
  const focusNote = MNNote.getFocusNote();
  if (!focusNote) return;
  
  // åŸºæœ¬ä¿¡æ¯
  console.log("æ ‡é¢˜ï¼š", focusNote.noteTitle);      // ç¬”è®°æ ‡é¢˜
  console.log("æ‘˜å½•ï¼š", focusNote.excerptText);    // æ‘˜å½•çš„æ–‡æœ¬
  console.log("é¢œè‰²ï¼š", focusNote.colorIndex);     // é¢œè‰²ç¼–å· (0-15)
  
  // å…³ç³»ä¿¡æ¯
  console.log("æœ‰çˆ¶ç¬”è®°å—ï¼Ÿ", focusNote.parentNote ? "æœ‰" : "æ²¡æœ‰");
  console.log("å­ç¬”è®°æ•°é‡ï¼š", focusNote.childNotes.length);
  
  // å†…å®¹ä¿¡æ¯
  console.log("è¯„è®ºæ•°é‡ï¼š", focusNote.comments.length);
  console.log("æ ‡ç­¾ï¼š", focusNote.tags.join(", "));
}
```

#### ğŸ¨ ä¿®æ”¹ç¬”è®°ï¼ˆæœ€é‡è¦çš„éƒ¨åˆ†ï¼‰

ç°åœ¨åˆ°äº†æ¿€åŠ¨äººå¿ƒçš„æ—¶åˆ»â€”â€”ä¿®æ”¹ç¬”è®°ï¼ä½†æ˜¯è®°ä½ä¸€ä¸ªé»„é‡‘æ³•åˆ™ï¼š**æ‰€æœ‰ä¿®æ”¹éƒ½è¦åŒ…åœ¨ `undoGrouping` é‡Œ**ã€‚

```javascript
// âŒ é”™è¯¯çš„åšæ³•ï¼ˆç”¨æˆ·æ— æ³•æ’¤é”€ï¼‰
focusNote.noteTitle = "æ–°æ ‡é¢˜";
focusNote.colorIndex = 6;

// âœ… æ­£ç¡®çš„åšæ³•ï¼ˆç”¨æˆ·å¯ä»¥ä¸€é”®æ’¤é”€ï¼‰
MNUtil.undoGrouping(() => {
  focusNote.noteTitle = "æ–°æ ‡é¢˜";
  focusNote.colorIndex = 6;
});
```

> ğŸ”‘ **é»„é‡‘æ³•åˆ™**ï¼š`undoGrouping` å°±åƒä¸€ä¸ª"äº‹åŠ¡"ï¼Œé‡Œé¢çš„æ‰€æœ‰æ“ä½œè¦ä¹ˆå…¨éƒ¨æˆåŠŸï¼Œè¦ä¹ˆå…¨éƒ¨æ’¤é”€ã€‚è¿™ç»™äº†ç”¨æˆ·"åæ‚”è¯"ã€‚

#### ğŸ“ å®æˆ˜ç¤ºä¾‹ï¼šæ™ºèƒ½ç¬”è®°å¤„ç†å™¨

è®©æˆ‘ä»¬æŠŠå­¦åˆ°çš„çŸ¥è¯†ç»„åˆèµ·æ¥ï¼Œåˆ›å»ºä¸€ä¸ªå®ç”¨çš„åŠŸèƒ½ï¼š

```javascript
async function smartNoteProcessor() {
  // 1. è·å–é€‰ä¸­çš„ç¬”è®°
  const notes = MNNote.getFocusNotes();
  if (notes.length === 0) {
    MNUtil.showHUD("âŒ è¯·é€‰æ‹©è¦å¤„ç†çš„ç¬”è®°");
    return;
  }
  
  // 2. è¯¢é—®ç”¨æˆ·æƒ³åšä»€ä¹ˆ
  const actions = [
    "ğŸ¨ ç»Ÿä¸€æ”¹è‰²",
    "ğŸ·ï¸ æ‰¹é‡åŠ æ ‡ç­¾",
    "ğŸ“ æ·»åŠ å‰ç¼€",
    "ğŸ§¹ æ¸…ç†æ ¼å¼"
  ];
  
  const selected = await MNUtil.userSelect("é€‰æ‹©æ“ä½œ", "", actions);
  if (selected === 0) return;
  
  // 3. æ‰§è¡Œæ“ä½œï¼ˆä½¿ç”¨æ’¤é”€åˆ†ç»„ï¼‰
  MNUtil.showHUD("â³ å¤„ç†ä¸­...", -1);
  
  MNUtil.undoGrouping(() => {
    let successCount = 0;
    
    notes.forEach(note => {
      switch (selected) {
        case 1: // ç»Ÿä¸€æ”¹è‰²
          note.colorIndex = 3;  // é»„è‰²
          break;
          
        case 2: // æ‰¹é‡åŠ æ ‡ç­¾
          note.appendTags(["å·²æ•´ç†", new Date().toLocaleDateString()]);
          break;
          
        case 3: // æ·»åŠ å‰ç¼€
          note.noteTitle = "ğŸ“Œ " + note.noteTitle;
          break;
          
        case 4: // æ¸…ç†æ ¼å¼
          note.noteTitle = note.noteTitle.trim().replace(/\s+/g, ' ');
          break;
      }
      
      successCount++;
    });
    
    MNUtil.showHUD(`âœ… æˆåŠŸå¤„ç† ${successCount} ä¸ªç¬”è®°`);
  });
}
```

#### ğŸ¨ é¢œè‰²é€ŸæŸ¥è¡¨

MarginNote ä½¿ç”¨æ•°å­—è¡¨ç¤ºé¢œè‰²ï¼Œè¿™é‡Œæ˜¯å®Œæ•´å¯¹ç…§è¡¨ï¼š

```javascript
const colorMap = {
  0: "âšª æ— è‰²",     1: "ğŸŸ¡ æ·¡é»„",   2: "ğŸ”µ æ·¡è“",   3: "ğŸŸ¡ é»„è‰²",
  4: "ğŸ”· æ·±è“",     5: "ğŸŸ  æ©™è‰²",   6: "ğŸ”´ çº¢è‰²",   7: "ğŸŸ£ ç´«è‰²",
  8: "ğŸŸ¢ æ·¡ç»¿",     9: "ğŸŸ¢ æ·±ç»¿",   10: "âš« ç°è‰²",  11: "ğŸŸ¤ æ·±æ©™",
  12: "ğŸŸ« æ£•è‰²",    13: "ğŸ”´ æ·±çº¢",  14: "ğŸŸ£ æ·±ç´«",  15: "âš« æ·±ç°"
};

// ä½¿ç”¨ç¤ºä¾‹
function setNoteColorByMeaning() {
  const focusNote = MNNote.getFocusNote();
  if (!focusNote) return;
  
  const options = [
    "ğŸ”´ é‡è¦/ç´§æ€¥ (çº¢è‰²)",
    "ğŸŸ¡ éœ€è¦æ³¨æ„ (é»„è‰²)",
    "ğŸŸ¢ å·²å®Œæˆ (ç»¿è‰²)",
    "ğŸ”µ å‚è€ƒä¿¡æ¯ (è“è‰²)"
  ];
  
  MNUtil.userSelect("é€‰æ‹©å«ä¹‰", "", options).then(selected => {
    if (selected > 0) {
      const colorIndices = [6, 3, 8, 2];  // å¯¹åº”çš„é¢œè‰²ç´¢å¼•
      MNUtil.undoGrouping(() => {
        focusNote.colorIndex = colorIndices[selected - 1];
      });
    }
  });
}
```

#### ğŸ’¬ ç»™ç¬”è®°æ·»åŠ å†…å®¹

ç¬”è®°ä¸ä»…æœ‰æ ‡é¢˜ï¼Œè¿˜å¯ä»¥æ·»åŠ å„ç§è¯„è®ºï¼š

```javascript
function enrichNote() {
  const focusNote = MNNote.getFocusNote();
  if (!focusNote) return;
  
  MNUtil.undoGrouping(() => {
    // æ·»åŠ çº¯æ–‡æœ¬è¯„è®º
    focusNote.appendTextComment("ğŸ“… " + new Date().toLocaleString());
    
    // æ·»åŠ  Markdown æ ¼å¼è¯„è®º
    focusNote.appendMarkdownComment("**é‡ç‚¹ï¼š** è¿™æ˜¯ä¸€ä¸ª *é‡è¦* çš„ç¬”è®°");
    
    // æ·»åŠ  HTML æ ¼å¼è¯„è®ºï¼ˆæ›´ä¸°å¯Œçš„æ ·å¼ï¼‰
    focusNote.appendHtmlComment(
      '<span style="color: red; font-weight: bold;">âš ï¸ æ³¨æ„äº‹é¡¹</span>',
      "æ³¨æ„äº‹é¡¹",  // çº¯æ–‡æœ¬ç‰ˆæœ¬
      {width: 150, height: 30},  // æ˜¾ç¤ºå°ºå¯¸
      "myPlugin"  // æ ‡ç­¾ï¼Œç”¨äºè¯†åˆ«æ˜¯å“ªä¸ªæ’ä»¶æ·»åŠ çš„
    );
    
    // æ·»åŠ æ ‡ç­¾
    focusNote.appendTags(["é‡è¦", "å¾…å¤ä¹ "]);
  });
  
  MNUtil.showHUD("âœ… ç¬”è®°å†…å®¹å·²ä¸°å¯Œ");
}
```

#### ğŸ¯ æ–°æ‰‹ä»»åŠ¡ï¼šåˆ›å»ºä¸€ä¸ªç¬”è®°æ¨¡æ¿ç³»ç»Ÿ

ç»¼åˆè¿ç”¨æ‰€å­¦çŸ¥è¯†ï¼Œåˆ›å»ºä¸€ä¸ªå®ç”¨çš„ç¬”è®°æ¨¡æ¿åŠŸèƒ½ï¼š

```javascript
async function applyNoteTemplate() {
  const focusNote = MNNote.getFocusNote();
  if (!focusNote) {
    MNUtil.showHUD("âŒ è¯·å…ˆé€‰æ‹©ä¸€ä¸ªç¬”è®°");
    return;
  }
  
  // å®šä¹‰æ¨¡æ¿
  const templates = {
    "ğŸ“š è¯»ä¹¦ç¬”è®°": {
      prefix: "ğŸ“š ",
      color: 2,  // æ·¡è“è‰²
      tags: ["è¯»ä¹¦", "å­¦ä¹ "],
      comments: [
        "ğŸ“– ä¹¦åï¼š",
        "ğŸ‘¤ ä½œè€…ï¼š",
        "ğŸ“„ ç« èŠ‚ï¼š",
        "ğŸ’¡ è¦ç‚¹ï¼š",
        "ğŸ’­ æ€è€ƒï¼š"
      ]
    },
    "ğŸ¯ ä»»åŠ¡æ¸…å•": {
      prefix: "ğŸ¯ ",
      color: 3,  // é»„è‰²
      tags: ["ä»»åŠ¡", "å¾…åŠ"],
      comments: [
        "ğŸ“… æˆªæ­¢æ—¥æœŸï¼š",
        "ğŸ¯ ç›®æ ‡ï¼š",
        "ğŸ“ æ­¥éª¤ï¼š\n- [ ] \n- [ ] \n- [ ] ",
        "âœ… å®Œæˆæƒ…å†µï¼š"
      ]
    },
    "ğŸ’¡ çµæ„Ÿè®°å½•": {
      prefix: "ğŸ’¡ ",
      color: 5,  // æ©™è‰²
      tags: ["çµæ„Ÿ", "åˆ›æ„"],
      comments: [
        "ğŸ’¡ çµæ„Ÿæ¥æºï¼š",
        "ğŸ¨ å…·ä½“æƒ³æ³•ï¼š",
        "ğŸ”— ç›¸å…³é“¾æ¥ï¼š",
        "ğŸ“… è®°å½•æ—¶é—´ï¼š" + new Date().toLocaleString()
      ]
    }
  };
  
  // è®©ç”¨æˆ·é€‰æ‹©æ¨¡æ¿
  const templateNames = Object.keys(templates);
  const selected = await MNUtil.userSelect("é€‰æ‹©æ¨¡æ¿", "", templateNames);
  
  if (selected > 0) {
    const templateName = templateNames[selected - 1];
    const template = templates[templateName];
    
    // åº”ç”¨æ¨¡æ¿
    MNUtil.undoGrouping(() => {
      // ä¿®æ”¹æ ‡é¢˜
      if (!focusNote.noteTitle.startsWith(template.prefix)) {
        focusNote.noteTitle = template.prefix + focusNote.noteTitle;
      }
      
      // è®¾ç½®é¢œè‰²
      focusNote.colorIndex = template.color;
      
      // æ·»åŠ æ ‡ç­¾
      focusNote.appendTags(template.tags);
      
      // æ·»åŠ è¯„è®º
      template.comments.forEach(comment => {
        focusNote.appendTextComment(comment);
      });
    });
    
    MNUtil.showHUD(`âœ… å·²åº”ç”¨æ¨¡æ¿ï¼š${templateName}`);
  }
}
```

> ğŸ‰ **å¤ªæ£’äº†ï¼** ä½ å·²ç»æŒæ¡äº†ç¬”è®°æ“ä½œçš„æ ¸å¿ƒæŠ€èƒ½ã€‚ç°åœ¨ä½ å¯ä»¥ï¼š
> - âœ… å®‰å…¨åœ°è·å–å’Œæ£€æŸ¥ç¬”è®°
> - âœ… ä¿®æ”¹ç¬”è®°çš„å„ç§å±æ€§
> - âœ… æ‰¹é‡å¤„ç†å¤šä¸ªç¬”è®°
> - âœ… ä½¿ç”¨æ’¤é”€åˆ†ç»„ä¿æŠ¤ç”¨æˆ·æ“ä½œ
> - âœ… åˆ›å»ºå®ç”¨çš„ç¬”è®°å¤„ç†åŠŸèƒ½

### ç¬¬ä¸‰ç«™ï¼šå¢å¼ºåŠŸèƒ½ï¼ˆè®©æ’ä»¶æ›´å¼ºå¤§ï¼‰

å‰ä¸¤ç«™æˆ‘ä»¬å­¦ä¼šäº†å’Œç”¨æˆ·å¯¹è¯ã€æ“ä½œç¬”è®°ã€‚ç°åœ¨è®©æˆ‘ä»¬è§£é”ä¸€äº›é«˜çº§åŠŸèƒ½ï¼Œè®©ä½ çš„æ’ä»¶çœŸæ­£å¼ºå¤§èµ·æ¥ï¼

#### ğŸ“‹ å‰ªè´´æ¿æ“ä½œ - ä¸å¤–ç•Œäº¤æµçš„æ¡¥æ¢

å‰ªè´´æ¿æ˜¯æ’ä»¶ä¸å¤–éƒ¨ä¸–ç•Œäº¤æµçš„é‡è¦é€”å¾„ã€‚æƒ³è±¡ä¸€ä¸‹ï¼Œç”¨æˆ·ä»ç½‘é¡µå¤åˆ¶äº†ä¸€æ®µæ–‡å­—ï¼Œä½ çš„æ’ä»¶å¯ä»¥ç›´æ¥ä½¿ç”¨å®ƒï¼

```javascript
// ğŸ“¥ è¯»å–å‰ªè´´æ¿
function pasteAsNote() {
  // è·å–å‰ªè´´æ¿å†…å®¹
  const clipboardText = MNUtil.clipboardText;
  
  if (!clipboardText) {
    MNUtil.showHUD("âŒ å‰ªè´´æ¿æ˜¯ç©ºçš„");
    return;
  }
  
  // æ£€æŸ¥å†…å®¹ç±»å‹
  if (clipboardText.startsWith("http")) {
    MNUtil.showHUD("ğŸ”— æ£€æµ‹åˆ°é“¾æ¥ï¼Œæ­£åœ¨åˆ›å»ºé“¾æ¥ç¬”è®°...");
    // åˆ›å»ºé“¾æ¥ç¬”è®°
  } else if (clipboardText.length > 200) {
    MNUtil.showHUD("ğŸ“„ æ£€æµ‹åˆ°é•¿æ–‡æœ¬ï¼Œæ­£åœ¨åˆ›å»ºæ‘˜è¦ç¬”è®°...");
    // åˆ›å»ºé•¿æ–‡æœ¬ç¬”è®°
  } else {
    MNUtil.showHUD("ğŸ“ æ­£åœ¨åˆ›å»ºç¬”è®°...");
    // åˆ›å»ºæ™®é€šç¬”è®°
  }
}

// ğŸ“¤ å¤åˆ¶åˆ°å‰ªè´´æ¿
function copyNoteInfo() {
  const focusNote = MNNote.getFocusNote();
  if (!focusNote) {
    MNUtil.showHUD("âŒ è¯·å…ˆé€‰æ‹©ç¬”è®°");
    return;
  }
  
  // æ„å»ºè¦å¤åˆ¶çš„å†…å®¹
  const info = `ğŸ“Œ ${focusNote.noteTitle}
ğŸ“ ${focusNote.excerptText || "æ— æ‘˜å½•"}
ğŸ·ï¸ ${focusNote.tags.join(", ") || "æ— æ ‡ç­¾"}
ğŸ”— ${focusNote.noteURL}`;
  
  // å¤åˆ¶åˆ°å‰ªè´´æ¿
  MNUtil.copy(info);
  MNUtil.showHUD("âœ… ç¬”è®°ä¿¡æ¯å·²å¤åˆ¶");
}
```

> ğŸ’¡ **å®ç”¨åœºæ™¯**ï¼š
> - ä»ç½‘é¡µå¤åˆ¶å†…å®¹ç›´æ¥åˆ›å»ºç¬”è®°
> - å¯¼å‡ºç¬”è®°ä¿¡æ¯åˆ°å…¶ä»–åº”ç”¨
> - æ‰¹é‡æ”¶é›†é“¾æ¥å¹¶åˆ›å»ºå¼•ç”¨

#### ğŸ›ï¸ è‡ªå®šä¹‰èœå• - è®©æ’ä»¶æ›´ä¸“ä¸š

å½“åŠŸèƒ½å˜å¤šæ—¶ï¼Œä¸€ä¸ªæŒ‰é’®å·²ç»ä¸å¤Ÿç”¨äº†ã€‚è¿™æ—¶å€™å°±éœ€è¦èœå•æ¥ç»„ç»‡åŠŸèƒ½ï¼š

```javascript
// åˆ›å»ºä¸€ä¸ªåŠŸèƒ½ä¸°å¯Œçš„å³é”®èœå•
async function showSmartMenu(button) {
  const focusNote = MNNote.getFocusNote();
  if (!focusNote) {
    MNUtil.showHUD("âŒ è¯·å…ˆé€‰æ‹©ç¬”è®°");
    return;
  }
  
  // åˆ›å»ºèœå•ï¼ˆæŒ‰é’®ï¼Œæ§åˆ¶å™¨ï¼Œå®½åº¦ï¼‰
  const menu = new Menu(button, self, 280);
  
  // æ·»åŠ èœå•é¡¹ - åŸºç¡€æ“ä½œ
  menu.addMenuItem("ğŸ“‹ å¤åˆ¶æ ‡é¢˜", "copyTitle:", focusNote);
  menu.addMenuItem("ğŸ”— å¤åˆ¶é“¾æ¥", "copyLink:", focusNote);
  menu.addMenuItem("ğŸ“ å¤åˆ¶æ‘˜å½•", "copyExcerpt:", focusNote);
  
  // æ·»åŠ åˆ†éš”çº¿ï¼ˆç”¨çº¯æ–‡æœ¬ä½œä¸ºåˆ†ç»„æ ‡é¢˜ï¼‰
  menu.addMenuItem("â”€â”€â”€â”€â”€â”€â”€ é«˜çº§æ“ä½œ â”€â”€â”€â”€â”€â”€â”€");
  
  // é«˜çº§æ“ä½œ
  menu.addMenuItem("ğŸ¨ åº”ç”¨æ¨¡æ¿", "applyTemplate:", focusNote);
  menu.addMenuItem("ğŸ”„ è½¬æ¢æ ¼å¼", "convertFormat:", focusNote);
  menu.addMenuItem("ğŸ“Š ç”Ÿæˆç»Ÿè®¡", "generateStats:", focusNote);
  
  // æ¡ä»¶èœå•é¡¹ï¼ˆæ ¹æ®ç¬”è®°çŠ¶æ€æ˜¾ç¤ºä¸åŒé€‰é¡¹ï¼‰
  if (focusNote.childNotes.length > 0) {
    menu.addMenuItem("ğŸ‘¶ å¤„ç†å­ç¬”è®°", "processChildren:", focusNote);
  }
  
  if (focusNote.tags.includes("TODO")) {
    menu.addMenuItem("âœ… æ ‡è®°å®Œæˆ", "markDone:", focusNote);
  }
  
  // æ˜¾ç¤ºèœå•
  menu.show();
}

// å®ç°èœå•åŠŸèƒ½ï¼ˆåœ¨æ’ä»¶ç±»ä¸­ï¼‰
copyTitle: function(note) {
  MNUtil.copy(note.noteTitle);
  MNUtil.showHUD("âœ… æ ‡é¢˜å·²å¤åˆ¶");
},

copyLink: function(note) {
  MNUtil.copy(note.noteURL);
  MNUtil.showHUD("âœ… é“¾æ¥å·²å¤åˆ¶");
},

applyTemplate: async function(note) {
  // è¿™é‡Œå¯ä»¥è°ƒç”¨ä¹‹å‰å†™çš„æ¨¡æ¿åŠŸèƒ½
  await applyNoteTemplate();
}
```

> ğŸ¯ **èœå•è®¾è®¡æŠ€å·§**ï¼š
> - æœ€å¸¸ç”¨çš„åŠŸèƒ½æ”¾åœ¨æœ€ä¸Šé¢
> - ä½¿ç”¨å›¾æ ‡è®©èœå•æ›´ç›´è§‚
> - ç›¸å…³åŠŸèƒ½ç”¨åˆ†éš”çº¿åˆ†ç»„
> - å±é™©æ“ä½œï¼ˆå¦‚åˆ é™¤ï¼‰æ”¾åœ¨æœ€ä¸‹é¢

#### ğŸ’¾ æ–‡ä»¶æ“ä½œ - å¯¼å…¥å¯¼å‡ºæ•°æ®

æœ‰æ—¶å€™æˆ‘ä»¬éœ€è¦ä¿å­˜é…ç½®æˆ–å¯¼å‡ºæ•°æ®ï¼š

```javascript
// ğŸ“¤ å¯¼å‡ºç¬”è®°åˆ°æ–‡ä»¶
function exportNotes() {
  const notes = MNNote.getFocusNotes();
  if (notes.length === 0) {
    MNUtil.showHUD("âŒ è¯·é€‰æ‹©è¦å¯¼å‡ºçš„ç¬”è®°");
    return;
  }
  
  // æ„å»ºå¯¼å‡ºæ•°æ®
  const exportData = {
    exportDate: new Date().toISOString(),
    noteCount: notes.length,
    notes: notes.map(note => ({
      title: note.noteTitle,
      excerpt: note.excerptText,
      color: note.colorIndex,
      tags: note.tags,
      comments: note.comments.map(c => c.text)
    }))
  };
  
  // ä¿å­˜åˆ°æ–‡ä»¶
  const fileName = `ç¬”è®°å¯¼å‡º_${new Date().toLocaleDateString()}.json`;
  const filePath = `${MNUtil.mainPath}/exports/${fileName}`;
  
  // ç¡®ä¿ç›®å½•å­˜åœ¨
  MNUtil.createFolder(`${MNUtil.mainPath}/exports`);
  
  // å†™å…¥æ–‡ä»¶
  MNUtil.writeJSON(filePath, exportData);
  
  // å¤åˆ¶æ–‡ä»¶è·¯å¾„åˆ°å‰ªè´´æ¿
  MNUtil.copy(filePath);
  MNUtil.showHUD(`âœ… å·²å¯¼å‡º ${notes.length} ä¸ªç¬”è®°\nè·¯å¾„å·²å¤åˆ¶åˆ°å‰ªè´´æ¿`);
}

// ğŸ“¥ ä»æ–‡ä»¶å¯¼å…¥é…ç½®
function loadConfig() {
  const configPath = `${MNUtil.mainPath}/config.json`;
  
  // æ£€æŸ¥æ–‡ä»¶æ˜¯å¦å­˜åœ¨
  if (!MNUtil.isfileExists(configPath)) {
    // åˆ›å»ºé»˜è®¤é…ç½®
    const defaultConfig = {
      version: "1.0.0",
      settings: {
        defaultColor: 3,
        autoTag: true,
        templateEnabled: true
      }
    };
    
    MNUtil.writeJSON(configPath, defaultConfig);
    return defaultConfig;
  }
  
  // è¯»å–é…ç½®
  return MNUtil.readJSON(configPath);
}
```

#### ğŸŒ å¹³å°é€‚é… - è®©æ’ä»¶æ›´å‹å¥½

MarginNote æ”¯æŒ Mac å’Œ iPadï¼Œä¸åŒå¹³å°æœ‰ä¸åŒçš„ç‰¹æ€§ï¼š

```javascript
// æ£€æµ‹å¹³å°å¹¶é€‚é…
function adaptToPlatform() {
  const isMac = MNUtil.isMacOS();
  
  if (isMac) {
    // Mac å¹³å°ç‰¹æœ‰åŠŸèƒ½
    setupMacFeatures();
  } else {
    // iOS/iPadOS ç‰¹æœ‰åŠŸèƒ½
    setupIOSFeatures();
  }
}

// Mac å¹³å°åŠŸèƒ½
function setupMacFeatures() {
  // Mac æ”¯æŒæ›´å¤æ‚çš„å¿«æ·é”®
  MNUtil.showHUD("ğŸ’» Mac ç‰ˆæœ¬ï¼šæ”¯æŒé”®ç›˜å¿«æ·é”®");
  
  // Mac æ”¯æŒæ–‡ä»¶æ‹–æ”¾
  // å¯ä»¥å®ç°æ‹–å…¥æ–‡ä»¶åˆ›å»ºç¬”è®°ç­‰åŠŸèƒ½
}

// iOS å¹³å°åŠŸèƒ½
function setupIOSFeatures() {
  // iOS æ›´æ³¨é‡æ‰‹åŠ¿æ“ä½œ
  MNUtil.showHUD("ğŸ“± iOS ç‰ˆæœ¬ï¼šä¼˜åŒ–è§¦æ‘¸ä½“éªŒ");
  
  // iOS çš„èœå•éœ€è¦è€ƒè™‘æ‰‹æŒ‡æ“ä½œ
  // æŒ‰é’®è¦æ›´å¤§ï¼Œé—´è·è¦æ›´å®½
}

// è‡ªé€‚åº”ç•Œé¢ç¤ºä¾‹
function createAdaptiveUI() {
  const isMac = MNUtil.isMacOS();
  
  // æ ¹æ®å¹³å°è°ƒæ•´æŒ‰é’®å¤§å°
  const buttonSize = isMac ? 30 : 44;  // iOS éœ€è¦æ›´å¤§çš„è§¦æ‘¸ç›®æ ‡
  const spacing = isMac ? 5 : 10;      // iOS éœ€è¦æ›´å¤§çš„é—´è·
  
  // åˆ›å»ºæŒ‰é’®æ—¶ä½¿ç”¨è¿™äº›å€¼
  const button = MNButton.new({
    width: buttonSize,
    height: buttonSize,
    margin: spacing
  });
}
```

#### ğŸ¯ ç»¼åˆå®æˆ˜ï¼šæ™ºèƒ½ç¬”è®°åŠ©æ‰‹

è®©æˆ‘ä»¬æŠŠæ‰€æœ‰å­¦åˆ°çš„å¢å¼ºåŠŸèƒ½ç»„åˆèµ·æ¥ï¼Œåˆ›å»ºä¸€ä¸ªçœŸæ­£å®ç”¨çš„åŠŸèƒ½ï¼š

```javascript
// æ™ºèƒ½ç¬”è®°åŠ©æ‰‹ - é›†æˆæ‰€æœ‰é«˜çº§åŠŸèƒ½
async function smartNoteAssistant() {
  // æ£€æµ‹å¹³å°
  const isMac = MNUtil.isMacOS();
  
  // æ„å»ºåŠŸèƒ½èœå•
  const features = [
    "ğŸ“‹ ä»å‰ªè´´æ¿åˆ›å»ºç¬”è®°",
    "ğŸ“¤ å¯¼å‡ºé€‰ä¸­ç¬”è®°",
    "ğŸ¨ æ‰¹é‡åº”ç”¨æ¨¡æ¿",
    "ğŸ”„ æ™ºèƒ½æ ¼å¼è½¬æ¢",
    "ğŸ“Š ç”Ÿæˆå­¦ä¹ æŠ¥å‘Š",
    "âš™ï¸ æ’ä»¶è®¾ç½®"
  ];
  
  // iOS ä¸Šæ·»åŠ é¢å¤–é€‰é¡¹
  if (!isMac) {
    features.push("ğŸ“± è§¦æ‘¸ä¼˜åŒ–æ¨¡å¼");
  }
  
  const selected = await MNUtil.userSelect(
    "æ™ºèƒ½ç¬”è®°åŠ©æ‰‹",
    "é€‰æ‹©è¦æ‰§è¡Œçš„åŠŸèƒ½",
    features
  );
  
  if (selected === 0) return;
  
  switch (selected) {
    case 1: // ä»å‰ªè´´æ¿åˆ›å»ºç¬”è®°
      await createNoteFromClipboard();
      break;
      
    case 2: // å¯¼å‡ºé€‰ä¸­ç¬”è®°
      await exportSelectedNotes();
      break;
      
    case 3: // æ‰¹é‡åº”ç”¨æ¨¡æ¿
      await batchApplyTemplate();
      break;
      
    case 4: // æ™ºèƒ½æ ¼å¼è½¬æ¢
      await smartFormatConversion();
      break;
      
    case 5: // ç”Ÿæˆå­¦ä¹ æŠ¥å‘Š
      await generateStudyReport();
      break;
      
    case 6: // æ’ä»¶è®¾ç½®
      await showSettings();
      break;
      
    case 7: // iOS è§¦æ‘¸ä¼˜åŒ–
      if (!isMac) {
        await enableTouchOptimization();
      }
      break;
  }
}

// ä»å‰ªè´´æ¿æ™ºèƒ½åˆ›å»ºç¬”è®°
async function createNoteFromClipboard() {
  const text = MNUtil.clipboardText;
  if (!text) {
    MNUtil.showHUD("âŒ å‰ªè´´æ¿ä¸ºç©º");
    return;
  }
  
  // æ™ºèƒ½è¯†åˆ«å†…å®¹ç±»å‹
  let noteType = "æ™®é€šç¬”è®°";
  let color = 0;
  let tags = [];
  
  if (text.startsWith("http")) {
    noteType = "é“¾æ¥ç¬”è®°";
    color = 2;  // è“è‰²
    tags = ["é“¾æ¥", "å‚è€ƒ"];
  } else if (text.includes("TODO") || text.includes("å¾…åŠ")) {
    noteType = "ä»»åŠ¡ç¬”è®°";
    color = 3;  // é»„è‰²
    tags = ["TODO", "ä»»åŠ¡"];
  } else if (text.length > 500) {
    noteType = "é•¿æ–‡ç¬”è®°";
    color = 8;  // ç»¿è‰²
    tags = ["é•¿æ–‡", "é˜…è¯»"];
  }
  
  const confirmed = await MNUtil.confirm(
    `åˆ›å»º${noteType}`,
    `æ£€æµ‹åˆ°${noteType}ï¼Œæ˜¯å¦åˆ›å»ºï¼Ÿ\n\n${text.substring(0, 100)}...`
  );
  
  if (confirmed) {
    // è¿™é‡Œå®é™…åˆ›å»ºç¬”è®°çš„ä»£ç 
    MNUtil.showHUD(`âœ… ${noteType}åˆ›å»ºæˆåŠŸ`);
  }
}
```

#### ğŸ¯ æ–°æ‰‹ä»»åŠ¡ï¼šåˆ›å»ºä½ çš„ç‘å£«å†›åˆ€

ç°åœ¨è½®åˆ°ä½ äº†ï¼è¯•ç€åˆ›å»ºä¸€ä¸ªé›†æˆå¤šç§åŠŸèƒ½çš„"ç‘å£«å†›åˆ€"æ’ä»¶ï¼š

```javascript
// ä½ çš„ä»»åŠ¡ï¼šå®Œæˆè¿™ä¸ªå¤šåŠŸèƒ½å·¥å…·
async function mySwissKnife() {
  const focusNote = MNNote.getFocusNote();
  
  // 1. åˆ›å»ºä¸€ä¸ªè‡ªé€‚åº”èœå•
  const menu = new Menu(button, self, MNUtil.isMacOS() ? 250 : 300);
  
  // 2. æ·»åŠ è‡³å°‘5ä¸ªå®ç”¨åŠŸèƒ½
  menu.addMenuItem("ğŸ“‹ å¤åˆ¶ä¸º Markdown", "copyAsMarkdown:", focusNote);
  menu.addMenuItem("ğŸ”— ç”Ÿæˆåˆ†äº«é“¾æ¥", "generateShareLink:", focusNote);
  // ... æ·»åŠ æ›´å¤šåŠŸèƒ½
  
  // 3. æ ¹æ®ä¸åŒæƒ…å†µæ˜¾ç¤ºä¸åŒé€‰é¡¹
  if (MNUtil.clipboardText) {
    menu.addMenuItem("ğŸ“¥ ç²˜è´´å¹¶å…³è”", "pasteAndLink:", focusNote);
  }
  
  menu.show();
}

// å®ç°å…¶ä¸­ä¸€ä¸ªåŠŸèƒ½ä½œä¸ºç¤ºä¾‹
copyAsMarkdown: function(note) {
  if (!note) return;
  
  // æ„å»º Markdown æ ¼å¼
  const markdown = `## ${note.noteTitle}

${note.excerptText || ""}

æ ‡ç­¾ï¼š${note.tags.map(t => `#${t}`).join(" ")}
åˆ›å»ºæ—¶é—´ï¼š${new Date(note.createTime).toLocaleString()}
`;
  
  MNUtil.copy(markdown);
  MNUtil.showHUD("âœ… å·²å¤åˆ¶ Markdown æ ¼å¼");
}
```

> ğŸ‰ **æ­å–œä½ å®Œæˆç¬¬ä¸‰ç«™ï¼**
> 
> ä½ å·²ç»æŒæ¡äº†ï¼š
> - âœ… å‰ªè´´æ¿æ“ä½œ - ä¸å¤–éƒ¨ä¸–ç•Œäº¤æµ
> - âœ… èœå•ç³»ç»Ÿ - ç»„ç»‡å¤æ‚åŠŸèƒ½
> - âœ… æ–‡ä»¶æ“ä½œ - å¯¼å…¥å¯¼å‡ºæ•°æ®
> - âœ… å¹³å°é€‚é… - ä¼˜åŒ–ç”¨æˆ·ä½“éªŒ
> 
> è¿™äº›å¢å¼ºåŠŸèƒ½è®©ä½ çš„æ’ä»¶ä»"èƒ½ç”¨"å˜æˆ"å¥½ç”¨"ã€‚è®°ä½ï¼Œå¥½çš„æ’ä»¶ä¸ä»…åŠŸèƒ½å¼ºå¤§ï¼Œæ›´è¦ä½“éªŒæµç•…ï¼

## å¼€å‘ä½ çš„ç¬¬ä¸€ä¸ªæŒ‰é’®

### 1. æ’ä»¶æ‰“åŒ…ï¼ˆæå…¶é‡è¦ï¼‰

#### âš ï¸ é”™è¯¯çš„æ‰“åŒ…æ–¹å¼ï¼ˆä¼šå¯¼è‡´æ’ä»¶æ— æ³•åŠ è½½ï¼‰

```bash
# âŒ é”™è¯¯ï¼šä»å¤–éƒ¨ç›®å½•å‹ç¼©
zip ../plugin.mnaddon ../plugin-folder/*

# âŒ é”™è¯¯ï¼šå‹ç¼©æ•´ä¸ªæ–‡ä»¶å¤¹
zip -r plugin.mnaddon plugin-folder/

# âŒ é”™è¯¯ï¼šä½¿ç”¨ç›¸å¯¹è·¯å¾„
zip plugin.mnaddon ../plugin/main.js
```

è¿™äº›é”™è¯¯ä¼šå¯¼è‡´ï¼š
- æ’ä»¶æ— æ³•åŠ è½½
- æ’ä»¶åˆ—è¡¨ä¸­æ˜¾ç¤ºä½†æ— æ³•å‹¾é€‰
- ä¸¥é‡æ—¶å¯¼è‡´ MarginNote é—ªé€€

#### âœ… æ­£ç¡®çš„æ‰“åŒ…æ–¹å¼

```bash
# æ–¹æ³•ä¸€ï¼šä½¿ç”¨ mnaddon4 å·¥å…·ï¼ˆæ¨èï¼‰
cd your-plugin-folder
mnaddon4 build plugin-name

# æ–¹æ³•äºŒï¼šåœ¨æ’ä»¶ç›®å½•å†…ç›´æ¥å‹ç¼©
cd your-plugin-folder
zip plugin-name.mnaddon main.js mnaddon.json logo.png utils.js

# æ–¹æ³•ä¸‰ï¼šä½¿ç”¨é€šé…ç¬¦
cd your-plugin-folder
zip plugin-name.mnaddon *.js *.json *.png
```

#### éªŒè¯æ‰“åŒ…ç»“æœ

```bash
# æ£€æŸ¥æ–‡ä»¶ç»“æ„
unzip -l plugin-name.mnaddon

# æ­£ç¡®çš„è¾“å‡ºï¼š
Archive:  plugin-name.mnaddon
  Length      Date    Time    Name
---------  ---------- -----   ----
     1234  06-30-2025 18:00   main.js
      567  06-30-2025 18:00   mnaddon.json
     1803  06-30-2025 18:00   logo.png
---------                     -------
     3604                     3 files

# æ³¨æ„ï¼šæ–‡ä»¶åå‰é¢ä¸åº”è¯¥æœ‰ä»»ä½•è·¯å¾„å‰ç¼€ï¼
```

### 2. mnaddon4 å·¥å…·ä½¿ç”¨

```bash
# å®‰è£… mnaddon4 å·¥å…·
npm install -g mnaddon4

# æ‰“åŒ…æ’ä»¶
mnaddon4 build my-plugin

# è§£åŒ…æ’ä»¶ï¼ˆæŸ¥çœ‹å…¶ä»–æ’ä»¶çš„æºç ï¼‰
mnaddon4 unpack some-plugin.mnaddon

# è°ƒæ•´å›¾æ ‡å¤§å°åˆ° 44Ã—44
mnaddon4 resize logo.png
```

### 3. æ’ä»¶å®‰è£…å’Œè°ƒè¯•

#### å®‰è£…æ–¹å¼

1. **æ‹–æ‹½å®‰è£…**ï¼šå°† .mnaddon æ–‡ä»¶æ‹–å…¥ MarginNote
2. **åŒå‡»å®‰è£…**ï¼šåŒå‡» .mnaddon æ–‡ä»¶
3. **å¼€å‘æ¨¡å¼**ï¼šå°†æ’ä»¶æ–‡ä»¶å¤¹æ”¾åˆ°æ‰©å±•ç›®å½•
   - macOS: `~/Library/Containers/QReader.MarginStudyMac/Data/Library/MarginNote Extensions/`
   - iOS: é€šè¿‡ iTunes æ–‡ä»¶å…±äº«

#### é‡è¦æç¤º

- âš ï¸ æ’ä»¶**æ— æ³•çƒ­æ›´æ–°**ï¼Œä¿®æ”¹åå¿…é¡»é‡å¯ MarginNote
- ğŸ’¡ å¼€å‘æ—¶å»ºè®®ä½¿ç”¨å¿«æ·é”® `Cmd+Q` (macOS) å¿«é€Ÿé€€å‡ºé‡å¯
- ğŸ”§ ä½¿ç”¨ `MNUtil.showHUD()` å’Œ `MNUtil.log()` è¿›è¡Œè°ƒè¯•

## å¼€å‘ä½ çš„ç¬¬ä¸€ä¸ªæŒ‰é’®

### 1. MNToolbar æ¶æ„ç®€ä»‹

MNToolbar ä½¿ç”¨**æ³¨å†Œè¡¨æ¨¡å¼**ï¼Œè®©ä½ æ— éœ€ä¿®æ”¹æ ¸å¿ƒæ–‡ä»¶å°±èƒ½æ·»åŠ åŠŸèƒ½ï¼š

```
æ ¸å¿ƒæ–‡ä»¶ï¼ˆä¸è¦ä¿®æ”¹ï¼‰              æ‰©å±•æ–‡ä»¶ï¼ˆä½ è¦ä¿®æ”¹çš„ï¼‰
â”œâ”€â”€ main.js                    â”œâ”€â”€ xdyy_button_registry.js      # æŒ‰é’®é…ç½®
â”œâ”€â”€ utils.js                   â”œâ”€â”€ xdyy_menu_registry.js        # èœå•æ¨¡æ¿  
â””â”€â”€ webviewController.js       â””â”€â”€ xdyy_custom_actions_registry.js # åŠŸèƒ½å®ç°
```

### ğŸš€ å¿«é€Ÿå¼€å§‹æ¨¡æ¿ï¼ˆæ–°æ‰‹å¤åˆ¶å³ç”¨ï¼‰

æƒ³è¦æœ€å¿«é€Ÿåº¦çœ‹åˆ°æ•ˆæœï¼Ÿç›´æ¥å¤åˆ¶ä¸‹é¢çš„ä»£ç åˆ°å¯¹åº”æ–‡ä»¶ï¼š

**ç¬¬ä¸€æ­¥ï¼šåœ¨ `xdyy_button_registry.js` ä¸­æ·»åŠ ï¼š**
```javascript
global.registerButton("custom19", {
  name: "æ—¶é—´æˆ³",
  image: "timer",  // ä½¿ç”¨å†…ç½®å›¾æ ‡
  templateName: "menu_timestamp"
});
```

**ç¬¬äºŒæ­¥ï¼šåœ¨ `xdyy_menu_registry.js` ä¸­æ·»åŠ ï¼š**
```javascript
global.registerMenuTemplate("menu_timestamp", JSON.stringify({
  action: "addTimestamp"
}));
```

**ç¬¬ä¸‰æ­¥ï¼šåœ¨ `xdyy_custom_actions_registry.js` ä¸­æ·»åŠ ï¼š**
```javascript
global.registerCustomAction("addTimestamp", async function(context) {
  const { button, des, focusNote, focusNotes, self } = context;
  
  if (!focusNote) {
    MNUtil.showHUD("âŒ è¯·å…ˆé€‰æ‹©ç¬”è®°");
    return;
  }
  
  MNUtil.undoGrouping(() => {
    const time = new Date().toLocaleString('zh-CN');
    focusNote.noteTitle = `[${time}] ${focusNote.noteTitle}`;
    MNUtil.showHUD("âœ… å·²æ·»åŠ æ—¶é—´æˆ³");
  });
});
```

**å®Œæˆï¼** é‡å¯ MarginNoteï¼Œä½ çš„ç¬¬ä¸€ä¸ªæŒ‰é’®å°±å‡ºç°åœ¨å·¥å…·æ äº†ï¼

---

### 2. ä¸‰æ­¥æ·»åŠ æ–°æŒ‰é’®ï¼ˆè¯¦ç»†è¯´æ˜ï¼‰

#### æ­¥éª¤ 1ï¼šæ³¨å†ŒæŒ‰é’®ï¼ˆxdyy_button_registry.jsï¼‰

æ‰¾åˆ° `registerAllButtons()` å‡½æ•°ï¼Œæ·»åŠ ä½ çš„æŒ‰é’®ï¼š

```javascript
// åœ¨ registerAllButtons() å‡½æ•°ä¸­æ·»åŠ 
global.registerButton("custom21", {
  name: "æ‰¹é‡æ”¹è‰²",               // æŒ‰é’®æ˜¾ç¤ºçš„åç§°
  image: "color_batch",          // å›¾æ ‡æ–‡ä»¶åï¼ˆä¸å« .pngï¼‰
  templateName: "menu_color_batch" // å…³è”çš„èœå•æ¨¡æ¿åç§°
});
```

#### æ­¥éª¤ 2ï¼šå®šä¹‰èœå•ï¼ˆxdyy_menu_registry.jsï¼‰

##### ç®€å•æŒ‰é’®ï¼ˆç›´æ¥æ‰§è¡Œï¼‰

```javascript
global.registerMenuTemplate("menu_color_batch", JSON.stringify({
  action: "batchChangeColor"  // å¯¹åº”çš„åŠ¨ä½œåç§°
}));
```

##### å¸¦èœå•çš„æŒ‰é’®

```javascript
global.registerMenuTemplate("menu_color_batch", {
  action: "menu",
  menuTitle: "æ‰¹é‡æ”¹è‰²",
  menuItems: [
    {
      action: "changeToRed",
      menuTitle: "ğŸ”´ æ”¹ä¸ºçº¢è‰²"
    },
    {
      action: "changeToBlue", 
      menuTitle: "ğŸ”µ æ”¹ä¸ºè“è‰²"
    },
    {
      action: "changeToYellow",
      menuTitle: "ğŸŸ¡ æ”¹ä¸ºé»„è‰²"
    }
  ]
});
```

#### æ­¥éª¤ 3ï¼šå®ç°åŠŸèƒ½ï¼ˆxdyy_custom_actions_registry.jsï¼‰

```javascript
// ç®€å•æŒ‰é’®çš„å®ç°
global.registerCustomAction("batchChangeColor", async function(context) {
  const { button, des, focusNote, focusNotes, self } = context;
  
  // æ£€æŸ¥æ˜¯å¦æœ‰é€‰ä¸­çš„ç¬”è®°
  if (!focusNotes || focusNotes.length === 0) {
    MNUtil.showHUD("âŒ è¯·å…ˆé€‰æ‹©è¦å¤„ç†çš„ç¬”è®°");
    return;
  }
  
  // ä½¿ç”¨æ’¤é”€åˆ†ç»„ï¼Œè®©ç”¨æˆ·å¯ä»¥ä¸€é”®æ’¤é”€
  MNUtil.undoGrouping(() => {
    try {
      // æ‰¹é‡ä¿®æ”¹é¢œè‰²
      focusNotes.forEach(note => {
        note.colorIndex = 6;  // è®¾ä¸ºçº¢è‰²
      });
      
      MNUtil.showHUD(`âœ… å·²å°† ${focusNotes.length} ä¸ªç¬”è®°æ”¹ä¸ºçº¢è‰²`);
    } catch (error) {
      MNUtil.showHUD(`âŒ æ“ä½œå¤±è´¥: ${error.message}`);
    }
  });
});

// å¸¦èœå•æŒ‰é’®çš„å®ç°
global.registerCustomAction("changeToRed", async function(context) {
  changeNotesColor(context, 6, "çº¢è‰²");
});

global.registerCustomAction("changeToBlue", async function(context) {
  changeNotesColor(context, 2, "è“è‰²");
});

global.registerCustomAction("changeToYellow", async function(context) {
  changeNotesColor(context, 3, "é»„è‰²");
});

// é€šç”¨å‡½æ•°
function changeNotesColor(context, colorIndex, colorName) {
  const { button, des, focusNote, focusNotes, self } = context;
  
  if (!focusNotes || focusNotes.length === 0) {
    MNUtil.showHUD("âŒ è¯·å…ˆé€‰æ‹©ç¬”è®°");
    return;
  }
  
  MNUtil.undoGrouping(() => {
    focusNotes.forEach(note => {
      note.colorIndex = colorIndex;
    });
    MNUtil.showHUD(`âœ… å·²æ”¹ä¸º${colorName}`);
  });
}
```

### 3. å®æˆ˜ç¤ºä¾‹ï¼šæ™ºèƒ½æ ‡é¢˜å¤„ç†

è®©æˆ‘ä»¬åˆ›å»ºä¸€ä¸ªæ›´å®ç”¨çš„åŠŸèƒ½ï¼š

```javascript
// æ­¥éª¤ 1ï¼šæ³¨å†ŒæŒ‰é’®
global.registerButton("custom22", {
  name: "æ™ºèƒ½æ ‡é¢˜",
  image: "smart_title",
  templateName: "menu_smart_title"
});

// æ­¥éª¤ 2ï¼šå®šä¹‰èœå•
global.registerMenuTemplate("menu_smart_title", {
  action: "menu",
  menuTitle: "æ™ºèƒ½æ ‡é¢˜å¤„ç†",
  menuItems: [
    {
      action: "addPrefix",
      menuTitle: "ğŸ“Œ æ·»åŠ å‰ç¼€"
    },
    {
      action: "addSuffix",
      menuTitle: "ğŸ”š æ·»åŠ åç¼€"
    },
    {
      action: "cleanTitle",
      menuTitle: "ğŸ§¹ æ¸…ç†æ ‡é¢˜"
    },
    {
      action: "capitalizeTitle",
      menuTitle: "ğŸ”¤ é¦–å­—æ¯å¤§å†™"
    }
  ]
});

// æ­¥éª¤ 3ï¼šå®ç°åŠŸèƒ½
global.registerCustomAction("addPrefix", async function(context) {
  const { button, des, focusNote, focusNotes, self } = context;
  if (!focusNotes || focusNotes.length === 0) {
    MNUtil.showHUD("âŒ è¯·å…ˆé€‰æ‹©ç¬”è®°");
    return;
  }
  
  // è·å–ç”¨æˆ·è¾“å…¥
  const prefix = await MNUtil.input("è¾“å…¥å‰ç¼€", "å°†æ·»åŠ åˆ°æ‰€æœ‰é€‰ä¸­ç¬”è®°çš„æ ‡é¢˜å‰", ["ç¡®å®š"]);
  if (!prefix) return;
  
  MNUtil.undoGrouping(() => {
    focusNotes.forEach(note => {
      note.noteTitle = prefix + note.noteTitle;
    });
    MNUtil.showHUD(`âœ… å·²æ·»åŠ å‰ç¼€åˆ° ${focusNotes.length} ä¸ªç¬”è®°`);
  });
});

global.registerCustomAction("cleanTitle", async function(context) {
  const { button, des, focusNote, focusNotes, self } = context;
  if (!focusNotes || focusNotes.length === 0) {
    MNUtil.showHUD("âŒ è¯·å…ˆé€‰æ‹©ç¬”è®°");
    return;
  }
  
  MNUtil.undoGrouping(() => {
    let cleaned = 0;
    focusNotes.forEach(note => {
      // æ¸…ç†å¸¸è§çš„æ— ç”¨å­—ç¬¦
      const oldTitle = note.noteTitle;
      const newTitle = oldTitle
        .trim()                           // å»é™¤é¦–å°¾ç©ºæ ¼
        .replace(/\s+/g, ' ')            // å¤šä¸ªç©ºæ ¼æ›¿æ¢ä¸ºä¸€ä¸ª
        .replace(/^[\-\*\Â·\â€¢]+\s*/, '') // å»é™¤å¼€å¤´çš„ç¬¦å·
        .replace(/[\.,;:!?ã€‚ï¼Œï¼›ï¼šï¼ï¼Ÿ]+$/, ''); // å»é™¤ç»“å°¾çš„æ ‡ç‚¹
      
      if (oldTitle !== newTitle) {
        note.noteTitle = newTitle;
        cleaned++;
      }
    });
    MNUtil.showHUD(`âœ… æ¸…ç†äº† ${cleaned} ä¸ªæ ‡é¢˜`);
  });
});
```

### 4. é«˜çº§åŠŸèƒ½ç¤ºä¾‹

#### 4.1 åŒå‡»å’Œé•¿æŒ‰

```javascript
global.registerMenuTemplate("menu_advanced", {
  action: "defaultAction",        // å•å‡»æ‰§è¡Œ
  doubleClick: {                 // åŒå‡»æ‰§è¡Œ
    action: "doubleClickAction"
  },
  onLongPress: {                 // é•¿æŒ‰æ˜¾ç¤ºèœå•
    action: "menu",
    menuItems: [
      {
        action: "option1",
        menuTitle: "é€‰é¡¹ 1"
      }
    ]
  }
});
```

#### 4.2 æ¡ä»¶èœå•

```javascript
global.registerCustomAction("conditionalMenu", async function(context) {
  const { button, des, focusNote, focusNotes, self } = context;
  
  // æ ¹æ®æ¡ä»¶æ˜¾ç¤ºä¸åŒèœå•
  const menuItems = [];
  
  if (focusNote) {
    if (focusNote.colorIndex === 0) {
      menuItems.push({
        title: "è®¾ç½®é¢œè‰²",
        object: self,
        selector: "setColor:",
        param: focusNote
      });
    }
    
    if (!focusNote.parentNote) {
      menuItems.push({
        title: "è®¾ä¸ºå­ç¬”è®°",
        object: self,
        selector: "setAsChild:",
        param: focusNote
      });
    }
  }
  
  // æ˜¾ç¤ºèœå•
  const menu = new Menu(context.button, self, 250);
  menuItems.forEach(item => {
    menu.addMenuItem(item.title, item.selector, item.param);
  });
  menu.show();
});
```

### 5. è°ƒè¯•æŠ€å·§

```javascript
// 1. ä½¿ç”¨ HUD æ˜¾ç¤ºè°ƒè¯•ä¿¡æ¯
MNUtil.showHUD(`è°ƒè¯•: focusNotes = ${focusNotes.length}`);

// 2. ä½¿ç”¨æ—¥å¿—ï¼ˆéœ€è¦ MNUtilsï¼‰
if (typeof MNUtil !== "undefined" && MNUtil.log) {
  MNUtil.log("ğŸ” è°ƒè¯•ä¿¡æ¯:", {
    focusNote: focusNote?.noteTitle,
    count: focusNotes.length
  });
}

// 3. å¤åˆ¶å¯¹è±¡åˆ°å‰ªè´´æ¿æŸ¥çœ‹
MNUtil.copyJSON({
  noteInfo: {
    id: focusNote.noteId,
    title: focusNote.noteTitle,
    color: focusNote.colorIndex
  }
});
MNUtil.showHUD("å·²å¤åˆ¶è°ƒè¯•ä¿¡æ¯åˆ°å‰ªè´´æ¿");

// 4. é”™è¯¯å¤„ç†
try {
  // ä½ çš„ä»£ç 
} catch (error) {
  MNUtil.showHUD(`âŒ é”™è¯¯: ${error.message}`);
  MNUtil.log("é”™è¯¯è¯¦æƒ…:", error);
}
```

## è¿›é˜¶åŠŸèƒ½å¼€å‘

### 1. è¯„è®ºç®¡ç†ç³»ç»Ÿ

```javascript
// æ·»åŠ å„ç§ç±»å‹çš„è¯„è®º
const note = MNNote.getFocusNote();

// æ–‡æœ¬è¯„è®º
note.appendTextComment("è¿™æ˜¯ä¸€æ¡æ™®é€šè¯„è®º");

// Markdown è¯„è®º
note.appendMarkdownComment("**ç²—ä½“** *æ–œä½“* `ä»£ç `");

// HTML è¯„è®ºï¼ˆå¸¦æ ·å¼ï¼‰
note.appendHtmlComment(
  '<span style="color: red;">çº¢è‰²æ–‡å­—</span>',
  "çº¢è‰²æ–‡å­—",  // çº¯æ–‡æœ¬ç‰ˆæœ¬
  {width: 100, height: 30},  // å°ºå¯¸å¯¹è±¡
  "myPlugin"                 // æ ‡ç­¾
);

// ç§»åŠ¨è¯„è®ºä½ç½®
note.moveComment(0, 2);  // å°†ç¬¬ä¸€æ¡è¯„è®ºç§»åˆ°ç¬¬ä¸‰ä¸ªä½ç½®

// åˆ é™¤è¯„è®º
note.removeCommentByIndex(1);  // åˆ é™¤ç¬¬äºŒæ¡è¯„è®º
```

### 2. æ™ºèƒ½é“¾æ¥ç®¡ç†

```javascript
// åˆ›å»ºåŒå‘é“¾æ¥
const note1 = MNNote.getFocusNote();
const note2 = MNNote.getFocusNotes()[1];

if (note1 && note2) {
  // æ·»åŠ åŒå‘é“¾æ¥
  note1.appendNoteLink(note2, "Both");
  
  // æˆ–å•å‘é“¾æ¥
  note1.appendNoteLink(note2, "To");    // note1 â†’ note2
  note1.appendNoteLink(note2, "From");  // note1 â† note2
}

// è·å–é“¾æ¥çš„ç¬”è®°
const linkedNotes = note1.linkedNotes.map(link => {
  return MNNote.new(link.noteId);
});
```

### 3. æ‰¹é‡å¤„ç†æ¨¡å¼

```javascript
global.registerCustomAction("batchProcess", async function(context) {
  const { button, des, focusNote, focusNotes, self } = context;
  
  if (!focusNotes || focusNotes.length === 0) {
    MNUtil.showHUD("âŒ è¯·é€‰æ‹©è¦å¤„ç†çš„ç¬”è®°");
    return;
  }
  
  // æ˜¾ç¤ºå¤„ç†é€‰é¡¹
  const options = [
    "æ·»åŠ æ ‡ç­¾",
    "ä¿®æ”¹é¢œè‰²",
    "æ·»åŠ åˆ°å¤ä¹ ",
    "åˆ›å»ºå­ç¬”è®°"
  ];
  
  const selected = await MNUtil.userSelect("é€‰æ‹©æ‰¹é‡æ“ä½œ", "", options);
  if (selected === 0) return;  // å–æ¶ˆ
  
  const action = options[selected - 1];
  
  // æ˜¾ç¤ºè¿›åº¦
  MNUtil.showHUD(`æ­£åœ¨${action}...`, -1);
  
  MNUtil.undoGrouping(() => {
    let processed = 0;
    let failed = 0;
    
    focusNotes.forEach(note => {
      try {
        switch (action) {
          case "æ·»åŠ æ ‡ç­¾":
            note.appendTags(["æ‰¹å¤„ç†", new Date().toLocaleDateString()]);
            break;
          case "ä¿®æ”¹é¢œè‰²":
            note.colorIndex = 3;  // é»„è‰²
            break;
          case "æ·»åŠ åˆ°å¤ä¹ ":
            note.addToReview();
            break;
          case "åˆ›å»ºå­ç¬”è®°":
            note.createChildNote({
              title: "å­ç¬”è®°",
              colorIndex: note.colorIndex
            });
            break;
        }
        processed++;
      } catch (error) {
        failed++;
      }
    });
    
    MNUtil.showHUD(
      `âœ… å®Œæˆï¼æˆåŠŸ: ${processed}, å¤±è´¥: ${failed}`
    );
  });
});
```

### 4. æ¨¡æ¿ç³»ç»Ÿ

```javascript
// å®šä¹‰ç¬”è®°æ¨¡æ¿
const templates = {
  "ä¼šè®®ç¬”è®°": {
    title: "ä¼šè®®ç¬”è®° - {date}",
    color: 3,
    tags: ["ä¼šè®®", "å¾…åŠ"],
    comments: [
      "ğŸ“… æ—¥æœŸ: {date}",
      "ğŸ‘¥ å‚ä¸äºº: ",
      "ğŸ“‹ è®®é¢˜: ",
      "âœ… è¡ŒåŠ¨é¡¹: "
    ]
  },
  "è¯»ä¹¦ç¬”è®°": {
    title: "ã€Šä¹¦åã€‹- ç¬¬Xç« ",
    color: 2,
    tags: ["è¯»ä¹¦", "å­¦ä¹ "],
    comments: [
      "ğŸ“– ä¹¦å: ",
      "ğŸ“„ ç« èŠ‚: ",
      "ğŸ’¡ è¦ç‚¹: ",
      "ğŸ’­ æ€è€ƒ: "
    ]
  }
};

// åº”ç”¨æ¨¡æ¿
global.registerCustomAction("applyTemplate", async function(context) {
  // é€‰æ‹©æ¨¡æ¿
  const templateNames = Object.keys(templates);
  const selected = await MNUtil.userSelect("é€‰æ‹©æ¨¡æ¿", "", templateNames);
  if (selected === 0) return;
  
  const templateName = templateNames[selected - 1];
  const template = templates[templateName];
  
  // åˆ›å»ºæ–°ç¬”è®°
  const parentNote = MNNote.getFocusNote();
  if (!parentNote) {
    MNUtil.showHUD("âŒ è¯·å…ˆé€‰æ‹©çˆ¶ç¬”è®°");
    return;
  }
  
  MNUtil.undoGrouping(() => {
    // æ›¿æ¢æ¨¡æ¿å˜é‡
    const date = new Date().toLocaleDateString();
    const title = template.title.replace("{date}", date);
    
    // åˆ›å»ºç¬”è®°
    const newNote = parentNote.createChildNote({
      title: title
    });
    
    // åº”ç”¨æ¨¡æ¿å±æ€§
    newNote.colorIndex = template.color;
    newNote.appendTags(template.tags);
    
    // æ·»åŠ è¯„è®º
    template.comments.forEach(comment => {
      const text = comment.replace("{date}", date);
      newNote.appendTextComment(text);
    });
    
    // èšç„¦åˆ°æ–°ç¬”è®°
    newNote.focus();
    MNUtil.showHUD(`âœ… å·²åº”ç”¨æ¨¡æ¿: ${templateName}`);
  });
});
```

### 5. ä¸å¤–éƒ¨å·¥å…·é›†æˆ

```javascript
// URL Scheme è°ƒç”¨
global.registerCustomAction("openInObsidian", async function(context) {
  const { button, des, focusNote, focusNotes, self } = context;
  if (!focusNote) {
    MNUtil.showHUD("âŒ è¯·é€‰æ‹©ç¬”è®°");
    return;
  }
  
  // æ„å»º Obsidian URL
  const vaultName = "MyVault";
  const noteName = focusNote.noteTitle.replace(/[/\\?%*:|"<>]/g, '-');
  const content = encodeURIComponent(focusNote.excerptText || "");
  
  const url = `obsidian://new?vault=${vaultName}&name=${noteName}&content=${content}`;
  
  // æ‰“å¼€ URL
  MNUtil.openURL(url);
  MNUtil.showHUD("âœ… å·²å‘é€åˆ° Obsidian");
});

// å¤åˆ¶ä¸ºç‰¹å®šæ ¼å¼
global.registerCustomAction("copyAsMarkdown", async function(context) {
  const { button, des, focusNote, focusNotes, self } = context;
  if (!focusNote) return;
  
  // æ„å»º Markdown æ ¼å¼
  let markdown = `# ${focusNote.noteTitle}\n\n`;
  
  if (focusNote.excerptText) {
    markdown += `> ${focusNote.excerptText}\n\n`;
  }
  
  // æ·»åŠ æ ‡ç­¾
  if (focusNote.tags.length > 0) {
    markdown += `æ ‡ç­¾: ${focusNote.tags.map(tag => `#${tag}`).join(' ')}\n\n`;
  }
  
  // æ·»åŠ è¯„è®º
  focusNote.comments.forEach(comment => {
    markdown += `- ${comment.text}\n`;
  });
  
  MNUtil.copy(markdown);
  MNUtil.showHUD("âœ… å·²å¤åˆ¶ Markdown æ ¼å¼");
});
```

## MNTask æ¡ˆä¾‹å­¦ä¹ 

MNTask å±•ç¤ºäº†å¤æ‚æ’ä»¶çš„å¼€å‘æ¨¡å¼ï¼Œè®©æˆ‘ä»¬å­¦ä¹ å…¶ä¸­çš„å…³é”®æŠ€æœ¯ï¼š

### 1. ä»»åŠ¡å¡ç‰‡ç³»ç»Ÿè®¾è®¡

```javascript
// MNTask çš„ä»»åŠ¡ç±»å‹ç³»ç»Ÿ
const taskTypes = {
  objective: {
    name: "ç›®æ ‡",
    color: 9,     // æ·±ç»¿è‰²
    prefix: "ğŸ¯"
  },
  keyResult: {
    name: "å…³é”®ç»“æœ",
    color: 5,     // æ©™è‰²
    prefix: "ğŸ“Š"
  },
  project: {
    name: "é¡¹ç›®",
    color: 2,     // è“è‰²
    prefix: "ğŸ“"
  },
  action: {
    name: "åŠ¨ä½œ",
    color: 3,     // é»„è‰²
    prefix: "âš¡"
  }
};

// è§£æä»»åŠ¡æ ‡é¢˜
function parseTaskTitle(title) {
  const match = title.match(/ã€(\w+)ï½œ(\w+)ã€‘(.+)/);
  if (match) {
    return {
      type: match[1],
      status: match[2],
      content: match[3]
    };
  }
  return null;
}

// åˆ›å»ºä»»åŠ¡å¡ç‰‡
function createTaskCard(type, content) {
  const focusNote = MNNote.getFocusNote();
  if (!focusNote) return;
  
  const taskType = taskTypes[type];
  const title = `ã€${taskType.name}ï½œæœªå¼€å§‹ã€‘${content}`;
  
  MNUtil.undoGrouping(() => {
    const task = focusNote.createChildNote({
      title: title
    });
    
    task.colorIndex = taskType.color;
    task.appendHtmlComment(
      "çŠ¶æ€: æœªå¼€å§‹",
      "çŠ¶æ€: æœªå¼€å§‹",
      {width: 100, height: 30},
      "state"
    );
    
    task.focus();
    MNUtil.showHUD(`âœ… åˆ›å»º${taskType.name}: ${content}`);
  });
}
```

### 2. çŠ¶æ€ç®¡ç†ç³»ç»Ÿ

```javascript
// ä»»åŠ¡çŠ¶æ€æµè½¬
const taskStates = ["æœªå¼€å§‹", "è¿›è¡Œä¸­", "å·²å®Œæˆ", "å·²å½’æ¡£"];
const stateEmojis = ["ğŸ˜´", "ğŸ”¥", "âœ…", "ğŸ“¦"];

// åˆ‡æ¢ä»»åŠ¡çŠ¶æ€
function toggleTaskState(note, forward = true) {
  const parsed = parseTaskTitle(note.noteTitle);
  if (!parsed) return;
  
  const currentIndex = taskStates.indexOf(parsed.status);
  if (currentIndex === -1) return;
  
  let newIndex;
  if (forward) {
    newIndex = (currentIndex + 1) % taskStates.length;
  } else {
    newIndex = currentIndex - 1;
    if (newIndex < 0) newIndex = taskStates.length - 1;
  }
  
  const newStatus = taskStates[newIndex];
  const newEmoji = stateEmojis[newIndex];
  
  MNUtil.undoGrouping(() => {
    // æ›´æ–°æ ‡é¢˜
    note.noteTitle = `ã€${parsed.type}ï½œ${newStatus}ã€‘${parsed.content}`;
    
    // æ›´æ–°çŠ¶æ€è¯„è®º
    const stateComment = note.comments.find(c => 
      c.text && c.text.includes("çŠ¶æ€:")
    );
    
    if (stateComment) {
      const index = note.comments.indexOf(stateComment);
      note.removeCommentByIndex(index);
      note.appendHtmlComment(
        `çŠ¶æ€: ${newStatus} ${newEmoji}`,
        `çŠ¶æ€: ${newStatus}`,
        {width: 120, height: 30},
        "state"
      );
    }
    
    MNUtil.showHUD(`${newEmoji} ${newStatus}`);
  });
}
```

### 3. ä»Šæ—¥ä»»åŠ¡ç³»ç»Ÿ

```javascript
// æ ‡è®°ä¸ºä»Šæ—¥ä»»åŠ¡
function markAsToday(notes) {
  const today = new Date().toLocaleDateString();
  
  MNUtil.undoGrouping(() => {
    notes.forEach(note => {
      // æ£€æŸ¥æ˜¯å¦å·²æœ‰ä»Šæ—¥æ ‡è®°
      const hasTodayMark = note.comments.some(c => 
        c.text && c.text.includes("ğŸ“… ä»Šæ—¥")
      );
      
      if (!hasTodayMark) {
        note.appendHtmlComment(
          `ğŸ“… ä»Šæ—¥ (${today})`,
          `ä»Šæ—¥ä»»åŠ¡`,
          {width: 100, height: 25},
          "today"
        );
        
        // è‡ªåŠ¨è®¾ä¸ºè¿›è¡Œä¸­
        const parsed = parseTaskTitle(note.noteTitle);
        if (parsed && parsed.status === "æœªå¼€å§‹") {
          toggleTaskState(note, true);
        }
      }
    });
    
    MNUtil.showHUD(`âœ… å·²æ ‡è®° ${notes.length} ä¸ªä»Šæ—¥ä»»åŠ¡`);
  });
}

// è·å–ä»Šæ—¥ä»»åŠ¡
function getTodayTasks() {
  const notebook = MNNotebook.currentNotebook;
  if (!notebook) return [];
  
  const allNotes = notebook.notes;
  const today = new Date().toLocaleDateString();
  
  return allNotes.filter(note => {
    return note.comments.some(c => 
      c.text && c.text.includes(`ğŸ“… ä»Šæ—¥ (${today})`)
    );
  });
}
```

### 4. å­¦ä¹ è¦ç‚¹

ä» MNTask æˆ‘ä»¬å¯ä»¥å­¦åˆ°ï¼š

1. **ç»“æ„åŒ–æ•°æ®**ï¼šä½¿ç”¨ç‰¹å®šæ ¼å¼å­˜å‚¨ä¿¡æ¯ï¼ˆå¦‚ `ã€ç±»å‹ï½œçŠ¶æ€ã€‘å†…å®¹`ï¼‰
2. **çŠ¶æ€ç®¡ç†**ï¼šé€šè¿‡è¯„è®ºç³»ç»ŸæŒä¹…åŒ–çŠ¶æ€ä¿¡æ¯
3. **æ‰¹é‡æ“ä½œ**ï¼šæä¾›æ‰¹é‡å¤„ç†åŠŸèƒ½æé«˜æ•ˆç‡
4. **ç”¨æˆ·ä½“éªŒ**ï¼š
   - ä½¿ç”¨ emoji å¢å¼ºè§†è§‰æ•ˆæœ
   - æä¾›æ’¤é”€åŠŸèƒ½
   - å®æ—¶åé¦ˆæ“ä½œç»“æœ
5. **æ¨¡å—åŒ–è®¾è®¡**ï¼šå°†åŠŸèƒ½æ‹†åˆ†ä¸ºç‹¬ç«‹çš„å‡½æ•°

## å¸¸è§é—®é¢˜ä¸è°ƒè¯•

### ğŸ†˜ æ–°æ‰‹è‡ªæ£€æ¸…å•ï¼ˆé‡åˆ°é—®é¢˜å…ˆçœ‹è¿™é‡Œï¼‰

é‡åˆ°é—®é¢˜ä¸è¦æ…Œï¼æŒ‰ç…§è¿™ä¸ªæ¸…å•é€é¡¹æ£€æŸ¥ï¼š

1. **æ’ä»¶æ˜¯å¦æ­£ç¡®å®‰è£…ï¼Ÿ**
   - [ ] MNUtils å·²å®‰è£…å¹¶å‹¾é€‰å¯ç”¨
   - [ ] ä½ çš„æ’ä»¶å·²å®‰è£…å¹¶å‹¾é€‰å¯ç”¨
   - [ ] é‡å¯è¿‡ MarginNoteï¼ˆå¿…é¡»ï¼ï¼‰

2. **ä»£ç æ˜¯å¦æœ‰è¯­æ³•é”™è¯¯ï¼Ÿ**
   - [ ] æ£€æŸ¥æ‰€æœ‰çš„æ‹¬å· `{}` `()` `[]` æ˜¯å¦æˆå¯¹
   - [ ] æ£€æŸ¥æ˜¯å¦æœ‰å¤šä½™çš„é€—å·
   - [ ] å­—ç¬¦ä¸²å¼•å·æ˜¯å¦åŒ¹é…

3. **åŠŸèƒ½æ˜¯å¦æ­£ç¡®æ³¨å†Œï¼Ÿ**
   - [ ] æŒ‰é’®åœ¨ `xdyy_button_registry.js` ä¸­æ³¨å†Œäº†å—ï¼Ÿ
   - [ ] èœå•åœ¨ `xdyy_menu_registry.js` ä¸­å®šä¹‰äº†å—ï¼Ÿ
   - [ ] åŠ¨ä½œåœ¨ `xdyy_custom_actions_registry.js` ä¸­å®ç°äº†å—ï¼Ÿ

4. **æµ‹è¯•æ­¥éª¤æ˜¯å¦æ­£ç¡®ï¼Ÿ**
   - [ ] é€‰ä¸­äº†ç¬”è®°å†ç‚¹å‡»æŒ‰é’®ï¼Ÿ
   - [ ] åœ¨æ­£ç¡®çš„è§†å›¾ï¼ˆæ–‡æ¡£/å­¦ä¹ /å¤ä¹ ï¼‰ï¼Ÿ

### 1. æ’ä»¶æ— æ³•åŠ è½½ï¼ˆæœ€å¸¸è§ï¼‰

#### ç—‡çŠ¶
- æ’ä»¶å‡ºç°åœ¨åˆ—è¡¨ä½†æ— æ³•å‹¾é€‰
- æ’ä»¶å®‰è£…åçœ‹ä¸åˆ°
- MarginNote é—ªé€€

#### åŸå› å’Œè§£å†³æ–¹æ¡ˆ

**1. æ‰“åŒ…é”™è¯¯ï¼ˆ80% çš„é—®é¢˜ï¼‰**
```bash
# âŒ é”™è¯¯ï¼šä¼šäº§ç”Ÿè·¯å¾„å‰ç¼€
cd ..
zip -r plugin.mnaddon plugin-folder/*

# âœ… æ­£ç¡®ï¼šåœ¨æ’ä»¶ç›®å½•å†…æ‰“åŒ…
cd plugin-folder
zip plugin.mnaddon *.js *.json *.png
```

**2. mnaddon.json æ ¼å¼é”™è¯¯**
```json
// âŒ é”™è¯¯ï¼šæœ€åæœ‰é€—å·
{
  "addonid": "com.example.plugin",
  "name": "My Plugin",
  "version": "1.0.0",  // è¿™ä¸ªé€—å·ä¼šå¯¼è‡´è§£æå¤±è´¥
}

// âœ… æ­£ç¡®
{
  "addonid": "com.example.plugin",
  "name": "My Plugin",
  "version": "1.0.0"
}
```

**3. JavaScript è¯­æ³•é”™è¯¯**
ä½¿ç”¨ Node.js æ£€æŸ¥è¯­æ³•ï¼š
```bash
node -c main.js
```

### 2. "Can't find variable" é”™è¯¯

#### åŸå› 
- MNUtils æœªå®‰è£…æˆ–æœªåŠ è½½
- å˜é‡åæ‹¼å†™é”™è¯¯
- åŠ è½½é¡ºåºé—®é¢˜

#### è§£å†³æ–¹æ¡ˆ
```javascript
// åœ¨ä½¿ç”¨å‰æ£€æŸ¥
if (typeof MNUtil === 'undefined') {
  alert("è¯·å…ˆå®‰è£… MNUtils æ’ä»¶");
  return;
}

// æ£€æŸ¥æ‹¼å†™
// âŒ MNUtils.showHUD()  // é”™è¯¯ï¼šåº”è¯¥æ˜¯ MNUtil
// âœ… MNUtil.showHUD()   // æ­£ç¡®
```

### 3. self å¼•ç”¨é”™è¯¯ï¼ˆJSB æ¡†æ¶ç‰¹æœ‰ï¼‰

```javascript
// âŒ æ°¸è¿œä¸è¦è¿™æ ·åš
myMethod: function() {
  let self = this;  // åœ¨ JSB ä¸­ä¸èµ·ä½œç”¨ï¼
}

// âœ… æ­£ç¡®åšæ³•
const getMyPlugin = () => self;

myMethod: function() {
  let self = getMyPlugin();
}
```

### 4. æŒ‰é’®ä¸æ˜¾ç¤º

#### æ£€æŸ¥æ¸…å•
1. æŒ‰é’®æ˜¯å¦æ­£ç¡®æ³¨å†Œï¼Ÿ
2. å›¾æ ‡æ–‡ä»¶æ˜¯å¦å­˜åœ¨ï¼Ÿ
3. èœå•æ¨¡æ¿æ˜¯å¦å®šä¹‰ï¼Ÿ
4. ç¼“å­˜æ˜¯å¦éœ€è¦æ¸…ç†ï¼Ÿ

```javascript
// å¼ºåˆ¶åˆ·æ–°æŒ‰é’®
if (global.forceRefreshButtons) {
  global.forceRefreshButtons();
}
```

### 5. è°ƒè¯•æŠ€å·§å¤§å…¨

#### 5.1 åŸºç¡€è°ƒè¯•
```javascript
// 1. HUD è°ƒè¯•ï¼ˆç”¨æˆ·å¯è§ï¼‰
MNUtil.showHUD(`å˜é‡å€¼: ${myVar}`);

// 2. æ—¥å¿—è°ƒè¯•ï¼ˆå¼€å‘ç”¨ï¼‰
if (typeof MNUtil !== "undefined" && MNUtil.log) {
  MNUtil.log("ğŸ” è°ƒè¯•:", {
    variable: myVar,
    type: typeof myVar
  });
}

// 3. å¤åˆ¶åˆ°å‰ªè´´æ¿æŸ¥çœ‹
MNUtil.copyJSON({
  noteInfo: note,
  error: error.message
});
```

#### 5.2 é«˜çº§è°ƒè¯•
```javascript
// 1. æ–­ç‚¹è°ƒè¯•ï¼ˆä½¿ç”¨ debugger è¯­å¥ï¼‰
function myFunction() {
  debugger;  // åœ¨ Safari è°ƒè¯•å™¨ä¸­ä¼šæš‚åœ
  // ä½ çš„ä»£ç 
}

// 2. æ€§èƒ½æµ‹è¯•
const start = Date.now();
// æ‰§è¡Œæ“ä½œ
const elapsed = Date.now() - start;
MNUtil.log(`æ“ä½œè€—æ—¶: ${elapsed}ms`);

// 3. å†…å­˜ä½¿ç”¨ç›‘æ§
const noteCount = MNNote.getFocusNotes().length;
if (noteCount > 1000) {
  MNUtil.showHUD("âš ï¸ é€‰ä¸­ç¬”è®°è¿‡å¤šï¼Œå¯èƒ½å½±å“æ€§èƒ½");
}
```

### 6. å¸¸è§é™·é˜±å’Œæœ€ä½³å®è·µ

#### 6.1 å¼‚æ­¥æ“ä½œé™·é˜±
```javascript
// âŒ é”™è¯¯ï¼šå¿˜è®° await
const result = MNUtil.input("è¾“å…¥", "", ["ç¡®å®š"]);
console.log(result);  // Promise å¯¹è±¡ï¼Œä¸æ˜¯ç»“æœï¼

// âœ… æ­£ç¡®ï¼šä½¿ç”¨ await
const result = await MNUtil.input("è¾“å…¥", "", ["ç¡®å®š"]);
console.log(result);  // å®é™…çš„è¾“å…¥å€¼
```

#### 6.2 å†…å­˜æ³„æ¼
```javascript
// âŒ é”™è¯¯ï¼šæ²¡æœ‰æ¸…ç†
sceneWillConnect: function() {
  this.timer = setInterval(() => {
    // å®šæ—¶ä»»åŠ¡
  }, 1000);
}

// âœ… æ­£ç¡®ï¼šè®°å¾—æ¸…ç†
sceneDidDisconnect: function() {
  if (this.timer) {
    clearInterval(this.timer);
  }
}
```

#### 6.3 é”™è¯¯å¤„ç†
```javascript
// âŒ é”™è¯¯ï¼šæ²¡æœ‰é”™è¯¯å¤„ç†
const note = MNNote.getFocusNote();
note.noteTitle = "æ–°æ ‡é¢˜";  // å¦‚æœ note ä¸º null ä¼šå´©æºƒ

// âœ… æ­£ç¡®ï¼šé˜²å¾¡æ€§ç¼–ç¨‹
const note = MNNote.getFocusNote();
if (note) {
  try {
    note.noteTitle = "æ–°æ ‡é¢˜";
  } catch (error) {
    MNUtil.showHUD("æ“ä½œå¤±è´¥: " + error.message);
  }
}
```

### 7. æ€§èƒ½ä¼˜åŒ–å»ºè®®

1. **æ‰¹é‡æ“ä½œä½¿ç”¨æ’¤é”€åˆ†ç»„**
```javascript
// ä¸€æ¬¡æ’¤é”€æ‰€æœ‰æ“ä½œï¼Œè€Œä¸æ˜¯æ¯ä¸ªæ“ä½œå•ç‹¬æ’¤é”€
MNUtil.undoGrouping(() => {
  notes.forEach(note => {
    // æ‰¹é‡ä¿®æ”¹
  });
});
```

2. **é¿å…é¢‘ç¹ UI æ›´æ–°**
```javascript
// âŒ é”™è¯¯ï¼šæ¯æ¬¡éƒ½æ›´æ–° HUD
notes.forEach((note, index) => {
  note.colorIndex = 2;
  MNUtil.showHUD(`å¤„ç†ä¸­ ${index + 1}/${notes.length}`);
});

// âœ… æ­£ç¡®ï¼šåªåœ¨æœ€åæ›´æ–°
notes.forEach(note => {
  note.colorIndex = 2;
});
MNUtil.showHUD(`âœ… å¤„ç†å®Œæˆ ${notes.length} ä¸ªç¬”è®°`);
```

3. **å¤§æ•°æ®é›†åˆ†æ‰¹å¤„ç†**
```javascript
async function processBatch(notes, batchSize = 50) {
  for (let i = 0; i < notes.length; i += batchSize) {
    const batch = notes.slice(i, i + batchSize);
    
    MNUtil.undoGrouping(() => {
      batch.forEach(note => {
        // å¤„ç†
      });
    });
    
    // è®© UI æœ‰æœºä¼šæ›´æ–°
    await MNUtil.delay(0.1);
  }
}
```

## èµ„æºä¸ä¸‹ä¸€æ­¥

### 1. å­¦ä¹ è·¯å¾„å»ºè®®

#### ç¬¬ä¸€é˜¶æ®µï¼šåŸºç¡€å…¥é—¨ï¼ˆ1-2 å‘¨ï¼‰
1. **æŒæ¡ JavaScript åŸºç¡€**
   - å˜é‡ã€å‡½æ•°ã€å¯¹è±¡ã€æ•°ç»„
   - æ¡ä»¶åˆ¤æ–­ã€å¾ªç¯
   - å¼‚æ­¥ç¼–ç¨‹ï¼ˆasync/awaitï¼‰

2. **ç†Ÿæ‚‰ MNUtils API**
   - MNUtil ç±»çš„å¸¸ç”¨æ–¹æ³•
   - MNNote ç±»çš„åŸºæœ¬æ“ä½œ
   - Menu ç±»çš„ä½¿ç”¨

3. **åˆ›å»ºç¬¬ä¸€ä¸ªæ’ä»¶**
   - ç®€å•çš„ç¬”è®°å¤„ç†åŠŸèƒ½
   - åŸºç¡€çš„ç”¨æˆ·ç•Œé¢

#### ç¬¬äºŒé˜¶æ®µï¼šè¿›é˜¶å¼€å‘ï¼ˆ2-4 å‘¨ï¼‰
1. **å­¦ä¹  MNToolbar æ¶æ„**
   - ç†è§£æ³¨å†Œè¡¨æ¨¡å¼
   - åˆ›å»ºè‡ªå®šä¹‰æŒ‰é’®
   - å®ç°å¤æ‚èœå•

2. **æ·±å…¥ MNTask æºç **
   - å­¦ä¹ çŠ¶æ€ç®¡ç†
   - ç†è§£æ•°æ®æŒä¹…åŒ–
   - æŒæ¡æ‰¹é‡æ“ä½œ

3. **å¼€å‘å®ç”¨åŠŸèƒ½**
   - æ¨¡æ¿ç³»ç»Ÿ
   - æ‰¹å¤„ç†å·¥å…·
   - ä¸å¤–éƒ¨å·¥å…·é›†æˆ

#### ç¬¬ä¸‰é˜¶æ®µï¼šé«˜çº§åº”ç”¨ï¼ˆ1-2 æœˆï¼‰
1. **ç ”ç©¶ MN ChatAI**
   - å¤šæ§åˆ¶å™¨æ¶æ„
   - WebView é›†æˆ
   - ç½‘ç»œè¯·æ±‚å¤„ç†

2. **æ€§èƒ½ä¼˜åŒ–**
   - å¤§æ•°æ®å¤„ç†
   - å†…å­˜ç®¡ç†
   - UI å“åº”ä¼˜åŒ–

3. **åˆ›æ–°åŠŸèƒ½**
   - AI é›†æˆ
   - äº‘åŒæ­¥
   - å›¢é˜Ÿåä½œ

### 2. æ¨èèµ„æº

#### å®˜æ–¹èµ„æº
- [MarginNote å®˜ç½‘](https://www.marginnote.com/)
- [MarginNote è®ºå›](https://bbs.marginnote.cn/)

#### å¼€æºé¡¹ç›®ï¼ˆå­¦ä¹ èŒƒä¾‹ï¼‰
1. **MNUtils** - æ ¸å¿ƒ API æ¡†æ¶
   - è·¯å¾„ï¼š`mnutils/`
   - å­¦ä¹ é‡ç‚¹ï¼šAPI è®¾è®¡ã€æ¡†æ¶æ¶æ„

2. **MNToolbar** - å·¥å…·æ æ’ä»¶
   - è·¯å¾„ï¼š`mntoolbar/`
   - å­¦ä¹ é‡ç‚¹ï¼šUI å¼€å‘ã€æŒ‰é’®ç³»ç»Ÿ

3. **MNTask** - ä»»åŠ¡ç®¡ç†æ’ä»¶
   - è·¯å¾„ï¼š`mntask/`
   - å­¦ä¹ é‡ç‚¹ï¼šæ•°æ®ç®¡ç†ã€çŠ¶æ€ç³»ç»Ÿ

4. **MN ChatAI** - AI å¯¹è¯æ’ä»¶
   - è·¯å¾„ï¼š`mnai/`
   - å­¦ä¹ é‡ç‚¹ï¼šé«˜çº§æ¶æ„ã€ç½‘ç»œé›†æˆ

#### JavaScript å­¦ä¹ èµ„æº
- [MDN Web Docs](https://developer.mozilla.org/zh-CN/docs/Web/JavaScript) - æƒå¨çš„ JavaScript æ–‡æ¡£
- [JavaScript.info](https://zh.javascript.info/) - ç°ä»£ JavaScript æ•™ç¨‹
- [ES6 å…¥é—¨æ•™ç¨‹](https://es6.ruanyifeng.com/) - é˜®ä¸€å³°çš„ ES6 æ•™ç¨‹

#### å¼€å‘å·¥å…·
1. **ä»£ç ç¼–è¾‘å™¨**
   - VS Codeï¼ˆæ¨èï¼‰
   - Sublime Text
   - WebStorm

2. **è°ƒè¯•å·¥å…·**
   - Safari Web Inspector (macOS)
   - Chrome DevTools

3. **è¾…åŠ©å·¥å…·**
   - mnaddon4 - æ’ä»¶æ‰“åŒ…å·¥å…·
   - Prettier - ä»£ç æ ¼å¼åŒ–
   - ESLint - ä»£ç æ£€æŸ¥

### 3. ç¤¾åŒºå’Œæ”¯æŒ

#### è·å–å¸®åŠ©
1. **MarginNote è®ºå›**
   - å‘å¸–æé—®
   - æœç´¢å·²æœ‰ç­”æ¡ˆ
   - åˆ†äº«ä½ çš„æ’ä»¶

2. **GitHub Issues**
   - æŠ¥å‘Š bug
   - è¯·æ±‚æ–°åŠŸèƒ½
   - è´¡çŒ®ä»£ç 

3. **å³æ—¶é€šè®¯ç¾¤**
   - QQ ç¾¤
   - Telegram ç¾¤
   - Discord æœåŠ¡å™¨

#### è´¡çŒ®æŒ‡å—
1. Fork é¡¹ç›®
2. åˆ›å»ºåŠŸèƒ½åˆ†æ”¯
3. æäº¤ä»£ç 
4. å‘èµ· Pull Request

### 4. ä¸‹ä¸€æ­¥è¡ŒåŠ¨

#### ç«‹å³å¼€å§‹
1. **å®‰è£… MNUtils**
   - è¿™æ˜¯æ‰€æœ‰æ’ä»¶å¼€å‘çš„åŸºç¡€

2. **å¤åˆ¶ç¤ºä¾‹ä»£ç **
   - ä»æœ¬æ•™ç¨‹ä¸­å¤åˆ¶ä»£ç 
   - åˆ›å»ºä½ çš„ç¬¬ä¸€ä¸ªæ’ä»¶

3. **ä¿®æ”¹ç°æœ‰æ’ä»¶**
   - ä¸‹è½½ MNToolbar
   - æ·»åŠ ä¸€ä¸ªè‡ªå®šä¹‰æŒ‰é’®
   - å®ç°ä¸€ä¸ªç®€å•åŠŸèƒ½

#### çŸ­æœŸç›®æ ‡ï¼ˆ1 ä¸ªæœˆå†…ï¼‰
1. å¼€å‘ 3-5 ä¸ªå°æ’ä»¶
2. ä¸ºç°æœ‰æ’ä»¶è´¡çŒ®ä»£ç 
3. åœ¨è®ºå›åˆ†äº«ä½ çš„ä½œå“

#### é•¿æœŸè§„åˆ’
1. å¼€å‘ä¸€ä¸ªå®Œæ•´çš„æ’ä»¶
2. æˆä¸ºç¤¾åŒºè´¡çŒ®è€…
3. å¸®åŠ©å…¶ä»–æ–°æ‰‹å…¥é—¨

### 5. å¸¸ç”¨ä»£ç ç‰‡æ®µåº“

ä¿å­˜è¿™äº›ä»£ç ç‰‡æ®µï¼ŒåŠ å¿«ä½ çš„å¼€å‘é€Ÿåº¦ï¼š

```javascript
// 1. æ’ä»¶æ¨¡æ¿
JSB.newAddon = function(mainPath) {
  JSB.require('mnutils');
  
  var MyPlugin = JSB.defineClass('MyPlugin : JSExtension', {
    sceneWillConnect: function() {
      MNUtil.showHUD("æ’ä»¶å·²å¯åŠ¨");
    }
  });
  
  return MyPlugin;
};

// 2. è·å–ç„¦ç‚¹ç¬”è®°ï¼ˆå¸¦æ£€æŸ¥ï¼‰
const focusNote = MNNote.getFocusNote();
if (!focusNote) {
  MNUtil.showHUD("è¯·å…ˆé€‰æ‹©ç¬”è®°");
  return;
}

// 3. æ‰¹é‡æ“ä½œæ¨¡æ¿
const notes = MNNote.getFocusNotes();
MNUtil.undoGrouping(() => {
  notes.forEach(note => {
    // ä½ çš„æ“ä½œ
  });
  MNUtil.showHUD(`âœ… å¤„ç†äº† ${notes.length} ä¸ªç¬”è®°`);
});

// 4. ç”¨æˆ·è¾“å…¥
const input = await MNUtil.input("æ ‡é¢˜", "æç¤º", ["ç¡®å®š"]);
if (input) {
  // å¤„ç†è¾“å…¥
}

// 5. é€‰æ‹©èœå•
const options = ["é€‰é¡¹1", "é€‰é¡¹2", "é€‰é¡¹3"];
const selected = await MNUtil.userSelect("é€‰æ‹©", "", options);
if (selected > 0) {
  const choice = options[selected - 1];
}

// 6. é”™è¯¯å¤„ç†
try {
  // å±é™©æ“ä½œ
} catch (error) {
  MNUtil.showHUD("é”™è¯¯: " + error.message);
  if (MNUtil.log) {
    MNUtil.log("é”™è¯¯è¯¦æƒ…:", error);
  }
}
```

### ğŸ“‹ æ–°æ‰‹æ¯•ä¸šæ¸…å•

å®Œæˆä»¥ä¸‹ä»»åŠ¡ï¼Œä½ å°±æ­£å¼ä»æ–°æ‰‹æ¯•ä¸šäº†ï¼š

- [ ] æˆåŠŸåˆ›å»ºäº†è‡³å°‘ä¸€ä¸ªè‡ªå®šä¹‰æŒ‰é’®
- [ ] ç†è§£äº† `focusNote` å’Œ `focusNotes` çš„åŒºåˆ«
- [ ] èƒ½å¤Ÿä½¿ç”¨ `MNUtil.undoGrouping()` åŒ…è£…æ“ä½œ
- [ ] çŸ¥é“å¦‚ä½•ç”¨ `MNUtil.showHUD()` æ˜¾ç¤ºæ¶ˆæ¯
- [ ] å­¦ä¼šäº†ç”¨ `try-catch` å¤„ç†é”™è¯¯
- [ ] èƒ½å¤Ÿç‹¬ç«‹è°ƒè¯•ç®€å•çš„é—®é¢˜
- [ ] å®Œæˆäº†ä¸€ä¸ªå¯¹è‡ªå·±æœ‰ç”¨çš„å°åŠŸèƒ½

## ç»“è¯­

æ­å–œä½ å®Œæˆäº†è¿™ä¸ªæ•™ç¨‹ï¼ç°åœ¨ä½ å·²ç»æŒæ¡äº† MarginNote æ’ä»¶å¼€å‘çš„åŸºç¡€çŸ¥è¯†ã€‚è®°ä½ï¼š

1. **ä»ç®€å•å¼€å§‹** - ä¸è¦ä¸€å¼€å§‹å°±å°è¯•å¤æ‚åŠŸèƒ½
2. **å¤šçœ‹æºç ** - MNUtilsã€MNToolbarã€MNTask éƒ½æ˜¯å¾ˆå¥½çš„å­¦ä¹ ææ–™
3. **å‹¤äºå®è·µ** - åŠ¨æ‰‹å†™ä»£ç æ˜¯æœ€å¥½çš„å­¦ä¹ æ–¹å¼
4. **æ•¢äºå°è¯•** - ä¸è¦å®³æ€•å‡ºé”™ï¼Œæ¯ä¸ªé”™è¯¯éƒ½æ˜¯å­¦ä¹ æœºä¼š
5. **ä¹äºåˆ†äº«** - æŠŠä½ çš„ä½œå“åˆ†äº«ç»™ç¤¾åŒº

MarginNote æ’ä»¶å¼€å‘æ˜¯ä¸€ä¸ªå……æ»¡åˆ›é€ åŠ›çš„é¢†åŸŸã€‚é€šè¿‡å¼€å‘æ’ä»¶ï¼Œä½ ä¸ä»…èƒ½æå‡è‡ªå·±çš„å­¦ä¹ æ•ˆç‡ï¼Œè¿˜èƒ½å¸®åŠ©å…¨çƒçš„ MarginNote ç”¨æˆ·ã€‚

ç¥ä½ åœ¨æ’ä»¶å¼€å‘çš„é“è·¯ä¸Šè¶Šèµ°è¶Šè¿œï¼ğŸš€

---

*æœ¬æ•™ç¨‹åŸºäº MN-Addon é¡¹ç›®ç¼–å†™ï¼Œç‰¹åˆ«æ„Ÿè°¢ MNUtilsã€MNToolbarã€MNTask å’Œ MN ChatAI çš„å¼€å‘è€…ä»¬ã€‚*