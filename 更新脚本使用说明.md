# MN Toolbar 更新脚本使用说明

## 脚本对比

### 原脚本 (update.py)
- 功能基础，代码有重复
- 硬编码的文件列表
- 没有错误恢复机制
- 更新 mntoolbar_official 的代码重复

### 优化脚本 (update_optimized.py)
- 面向对象设计，代码复用性好
- 支持配置文件
- 自动备份和恢复自定义文件
- 自动检查集成状态
- 更好的日志输出
- 支持命令行参数

## 使用方法

### 基本使用
```bash
# 使用原脚本（兼容旧流程）
python update.py

# 使用优化脚本
python update_optimized.py
```

### 高级选项
```bash
# 只更新 mntoolbar，跳过 official
python update_optimized.py --skip-official

# 指定工作目录
python update_optimized.py --dir /path/to/mntoolbar

# 查看帮助
python update_optimized.py --help
```

## 配置文件说明 (update_config.json)

### custom_files
需要保留的自定义文件列表。更新时这些文件会被备份并在更新后恢复。

```json
"custom_files": [
  "xdyytoolbar.js",
  "XDYY_README.md",
  "XDYY_开发指南.md"
]
```

### file_extensions
需要更新的文件类型。只有这些扩展名的文件会被复制。

### text_replacements
自动文本替换规则。用于修复常见的拼写错误或进行必要的代码调整。

```json
"text_replacements": {
  "foucsNote": "focusNote",
  "oldAPI": "newAPI"
}
```

### integration_checks
集成检查规则。用于验证自定义功能的集成代码是否存在。

### ignore_patterns
忽略的文件模式（正则表达式）。匹配这些模式的文件不会被报告为"新文件"。

## 更新流程

1. **查找最新版本**
   - 扫描当前目录的 .mnaddon 文件
   - 解析版本号并找出最新版本

2. **解压插件**
   - 使用 mnaddon4 或 mnaddon 命令解压
   - 自动处理命令兼容性

3. **更新 mntoolbar 目录**
   - 备份自定义文件
   - 复制新文件
   - 应用文本替换
   - 恢复自定义文件
   - 检查集成状态

4. **更新 mntoolbar_official 目录**（可选）
   - 完整复制官方版本
   - 不保留任何自定义内容

5. **清理**
   - 删除临时解压目录

## 解耦后的注意事项

### 需要保持的集成代码

1. **main.js** 中需要保持：
   ```javascript
   // 加载自定义模块
   JSB.require('xdyytoolbar');
   
   // 初始化时调用
   if (typeof XDYYToolbar !== 'undefined') {
     XDYYToolbar.init(this);
   }
   
   // 执行自定义动作的方法
   executeCustomAction: function (params) {
     // ...
   }
   ```

2. **webviewController.js** 中需要保持：
   ```javascript
   // 在 viewDidLoad 中
   if (typeof XDYYToolbar !== 'undefined') {
     self.registerCustomActions();
   }
   
   // 注册方法
   registerCustomActions: function() {
     // ...
   }
   ```

### 自动检查功能
优化后的脚本会自动检查这些集成点，如果发现缺失会给出警告。

## 添加新的自定义文件

如果你添加了新的自定义文件，需要更新配置：

1. 编辑 `update_config.json`
2. 在 `custom_files` 数组中添加新文件名
3. 下次更新时该文件会被自动保留

## 故障排除

### 解压失败
- 确保安装了 mnaddon4 或 mnaddon 命令行工具
- 检查 .mnaddon 文件是否损坏

### 集成检查失败
- 参考 XDYY_README.md 重新应用集成代码
- 确保没有语法错误

### 文件权限问题
- 确保对目录有写入权限
- 在 macOS/Linux 上可能需要使用 sudo

## 建议的工作流程

1. **日常更新**
   ```bash
   python update_optimized.py
   ```

2. **只更新自己的版本**（当你修改了很多代码时）
   ```bash
   python update_optimized.py --skip-official
   ```

3. **重大版本更新**
   - 先备份整个项目
   - 运行更新脚本
   - 检查集成状态
   - 测试所有自定义功能

## 版本管理建议

1. 使用 Git 管理你的修改
2. 在更新前创建分支或标签
3. 更新后进行充分测试
4. 记录每次更新的变更