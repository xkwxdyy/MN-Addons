var MNOnAlert;void 0===MNOnAlert&&(MNOnAlert=!1),JSB.newAddon=function(t){try{JSB.require("mnutils"),JSB.require("xdyyutils"),MNUtil.init(t)}catch(t){subscriptionUtils.showHUD("Error when loading mnutils: "+t)}JSB.require("mnutils");try{JSB.require("CryptoJS")}catch(t){MNUtil.log("Error when loading CryptoJS: "+t)}try{JSB.require("marked")}catch(t){MNUtil.log("Error when loading marked: "+t)}try{JSB.require("pdf")}catch(t){MNUtil.log("Error when loading pdf: "+t)}try{JSB.require("highlight")}catch(t){MNUtil.log("Error when loading highlight: "+t)}try{JSB.require("mustache")}catch(t){MNUtil.log("Error when loading mustache: "+t)}return JSB.defineClass("MNSubscription : JSExtension",{sceneWillConnect:async function(){try{var t,e;self.appInstance=Application.sharedInstance(),subscriptionConfig.init(),self.isNewWindow=!1,self.watchMode=!1,self.textSelected="",self.textProcessed=!1,self.dateGetText=Date.now(),self.dateNow=Date.now(),self.rect="{{0, 0}, {10, 10}}",self.arrow=1,self.notifications=[],self.isFirst=!0,MNUtil.addObservers(self,{PopupMenuOnNote:"onPopupMenuOnNote:",PopupMenuOnSelection:"onPopupMenuOnSelection:",ClosePopupMenuOnNote:"onClosePopupMenuOnNote:",ClosePopupMenuOnSelection:"onClosePopupMenuOnSelection:",UITextViewTextDidBeginEditingNotification:"onTextDidBeginEditing:",UITextViewTextDidEndEditingNotification:"onTextDidEndEditing:",AddonBroadcast:"onAddonBroadcast:"}),await MNUtil.delay(.1),subscriptionUtils.checkSubscriptionController(),subscriptionUtils.ensureView(subscriptionUtils.subscriptionController.view),self.isFirst&&(t=subscriptionConfig.getMiniFrame(),subscriptionUtils.subscriptionController.view.frame=t,e=subscriptionUtils.calcLastFrame(),subscriptionUtils.subscriptionController.lastFrame=e,subscriptionUtils.subscriptionController.currentFrame=subscriptionUtils.subscriptionController.view.frame,subscriptionUtils.subscriptionController.onAnimate&&await MNUtil.delay(.5),subscriptionUtils.subscriptionController.initialized=!0,self.isFirst=!1)}catch(t){subscriptionUtils.addErrorLog(t,"sceneWillConnect")}},sceneDidDisconnect:function(){MNUtil.removeObservers(self)},onPopupMenuOnNote:function(t){var e;self.window===MNUtil.currentWindow&&(t=t.userInfo.note.noteId,e=Date.now(),MNUtil.popUpNoteInfo={time:e,noteId:t},e=MNNote.new(t),MNUtil.addHistory("note",{type:"note",noteId:t,notebookId:e.notebookId,docMd5:e.docMd5}))},onClosePopupMenuOnNote:function(t){self.window===MNUtil.currentWindow&&MNUtil.popUpNoteInfo&&t.userInfo.noteid===MNUtil.popUpNoteInfo.noteId&&MNUtil.delay(1).then(()=>{MNUtil.popUpNoteInfo=void 0})},onPopupMenuOnSelection:function(t){var e;self.window===MNUtil.currentWindow&&(e=Date.now(),t=t.userInfo.documentController,MNUtil.popUpSelectionInfo={time:e,docController:t},e=t.isSelectionText,MNUtil.addHistory(e?"text":"image",{notebookId:t.notebookId,docMd5:t.docMd5,text:t.selectionText,imageData:t.imageFromSelection()}))},onClosePopupMenuOnSelection:async function(t){self.window===MNUtil.currentWindow&&(await MNUtil.delay(.01),MNUtil.popUpSelectionInfo)&&t.userInfo.documentController===MNUtil.popUpSelectionInfo.docController&&!t.userInfo.documentController.imageFromSelection()&&(MNUtil.popUpSelectionInfo=void 0)},onTextDidBeginEditing:function(t){self.window===MNUtil.currentWindow&&3!==MNUtil.studyMode&&(t=t.object,MNUtil.activeTextView=t)},onTextDidEndEditing:function(t){self.window===MNUtil.currentWindow&&3!==MNUtil.studyMode&&t.object===MNUtil.activeTextView&&(MNUtil.activeTextView=void 0)},onAddonBroadcast:async function(t){var t="marginnote4app://addon/"+t.userInfo.message,e=MNUtil.parseURL(t),t=e.pathComponents[0];if("mnutils"===t)switch(e.params.action){case"changeView":subscriptionUtils.subscriptionController.changeViewTo(e.params.view);break;case"loadRechargePage":var i=subscriptionUtils.subscriptionController;await i.changeViewTo("subscriptionView"),i.loadRechargePage()}},sceneWillResignActive:function(){},sceneDidBecomeActive:function(){subscriptionUtils.checkSubscriptionController()},notebookWillOpen:function(t){try{subscriptionUtils.refreshAddonCommands(),self.notebookid=t,subscriptionConfig.autoSubscribe()}catch(t){subscriptionUtils.addErrorLog(t,"notebookWillOpen")}},onCloudConfigChange:async function(t){MNUtil.postNotification("cloudConfigChange",t.userInfo)},notebookWillClose:function(t){},documentDidOpen:function(t){},documentWillClose:function(t){},controllerWillLayoutSubviews:function(t){if(t===MNUtil.studyController)try{var e=subscriptionUtils.subscriptionController;if(e&&!e.onAnimate&&!e.view.hidden){var i=MNUtil.currentWindow.bounds;let t=e.currentFrame;e.miniMode?(subscriptionUtils.checkSubscriptionController(),t=subscriptionConfig.getMiniFrame(),e.view.frame=t,e.currentFrame=t):(t.x+.5*t.width>=i.width&&(t.x=i.width-.5*t.width),t.y>=i.height&&(t.y=i.height-20),e.view.frame=t,e.currentFrame=t)}}catch(t){subscriptionUtils.addErrorLog(t,"controllerWillLayoutSubviews")}},queryAddonCommandStatus:function(){return null},toggleAddon:async function(t){try{var e;subscriptionUtils.ensureView(subscriptionUtils.subscriptionController.view),self.addonBar||(self.addonBar=t.superview.superview,subscriptionUtils.addonBar=self.addonBar),self.isFirst&&(0===(e=self.addonBar.frame).x?subscriptionUtils.subscriptionController.view.frame={x:40,y:e.y,width:280,height:subscriptionConfig.frameHeight}:subscriptionUtils.subscriptionController.view.frame={x:e.x-280,y:e.y,width:280,height:subscriptionConfig.frameHeight},subscriptionUtils.subscriptionController.currentFrame=subscriptionUtils.subscriptionController.view.frame,self.isFirst=!1),subscriptionUtils.subscriptionController.view.hidden?subscriptionUtils.subscriptionController.show(self.addonBar.frame):subscriptionUtils.subscriptionController.hide(self.addonBar.frame)}catch(t){subscriptionUtils.showHUD(t)}}},{addonDidConnect:function(){subscriptionUtils.init(t),subscriptionUtils.subscriptionController&&(subscriptionUtils.subscriptionController.view.hidden=!1)},addonWillDisconnect:function(){subscriptionUtils.addonConnected=!1,subscriptionUtils.subscriptionController&&(subscriptionUtils.subscriptionController.view.hidden=!0)},applicationWillEnterForeground:async function(){subscriptionUtils.addonConnected&&MNUtil.currentNotebookId&&(await MNUtil.delay(.01),subscriptionConfig.autoSubscribe(!1))},applicationDidEnterBackground:function(){},applicationDidReceiveLocalNotification:function(t){}})};const getSubscriptionController=()=>self;var subscriptionController=JSB.defineClass("subscriptionController : UIViewController <NSURLConnectionDelegate,UIWebViewDelegate>",{viewDidLoad:function(){try{self.initialized=!1,self.custom=!1,self.dynamic=!0,self.miniMode=!0,self.isLoading=!1,self.lastFrame=self.view.frame,self.currentFrame=self.view.frame,self.color=["#ffffb4","#ccfdc4","#b4d1fb","#f3aebe","#ffff54","#75fb4c","#55bbf9","#ea3323","#ef8733","#377e47","#173dac","#be3223","#ffffff","#dadada","#b4b4b4","#bd9fdc"],self.mode=0,self.moveDate=Date.now(),self.lastRefreshView="",self.lastRefreshTime=0,self.init()}catch(t){subscriptionUtils.addErrorLog(t,"viewDidLoad")}},viewWillAppear:t=>{},viewWillDisappear:t=>{},viewWillLayoutSubviews:()=>{self.layoutSubviews()},connectionDidReceiveResponse:async function(t,e){self.statusCode=e.statusCode(),400<=self.statusCode?(MNUtil.stopHUD(),MNUtil.showHUD(MNUtil.getStatusCodeDescription(""+self.statusCode))):(self.onDownloading=!0,self.currentData=NSMutableData.new(),self.expectedContentLength=e.expectedContentLength())},connectionDidReceiveData:async function(t,e){try{400<=self.statusCode?self.onDownloading=!1:(self.currentData.appendData(e),self.waitHUD("Downloading: "+(self.currentData.length()/self.expectedContentLength*100).toFixed(2)+"%"))}catch(t){subscriptionUtils.addErrorLog(t,"connectionDidReceiveData")}},connectionDidFinishLoading:async function(t){try{if(self.onDownloading=!1,!(400<=self.statusCode)){if(self.targetPath)switch(self.currentData.writeToFileAtomically(self.targetPath,!1),self.fileType){case"document":var e=MNUtil.getFileName(self.targetPath),i=MNUtil.importDocument(self.targetPath);MNUtil.copy(i),MNUtil.currentNotebookId&&await MNUtil.confirm("Open document?","是否打开该文档？\n"+e)&&MNUtil.openDoc(i,MNUtil.currentNotebookId);break;case"notebook":(self.targetPath.endsWith(".marginpkg")||self.targetPath.endsWith(".marginnotes"))&&subscriptionUtils.importNotebook(self.targetPath,self.folder,self.notebookId);break;case"mnaddon":ZipArchive.unzipFileAtPathToDestination(self.targetPath,self.addonPath),self.showHUD("Install success!\n\nPlease restart MN manually",2)}MNUtil.delay(1).then(()=>{MNUtil.stopHUD()})}}catch(t){MNUtil.stopHUD(),subscriptionUtils.addErrorLog(t,"connectionDidFinishLoading")}},connectionDidFailWithError:function(t,e){self.onDownloading=!1,self.showHUD("connectionDidFailWithError")},webViewDidFinishLoad:async function(t){var e=getSubscriptionController();if(!t.sidebar){var i,o=MNUtil.parseURL(t.request);if("file"===o.scheme&&o.pathComponents.length&&"recharge.html"===o.pathComponents.at(-1))e.runJavaScript(`state.apiKey = "${subscriptionConfig.APIKey}"`,"docview");else{if("https"===o.scheme)switch(o.host){case"afdian.com":case"ifdian.net":if("message"===o.pathComponents[0])return e.waitHUD("Checking APIKey..."),await MNUtil.delay(1),(i=await e.getApikeyFromWebview(t))&&await MNUtil.confirm("Subscribe using APIKey below?","是否使用以下APIKey订阅?\n"+i)&&(e.apikeyInput.text=i,e.apikeyInput.editable=!0,MNButton.setColor(e.showAPIKeyButton,"#e06c75"),e.showHUD("Save APIKey"),subscriptionConfig.save(),e.activate()),void MNUtil.stopHUD();break;case"www.jianguoyun.com":return e.runJavaScript('document.getElementById("dashboard-container").style.display = "none";document.getElementsByClassName("info-container")[0].style.marginTop = 0;',"docview"),void MNUtil.stopHUD()}MNUtil.stopHUD()}}},webViewShouldStartLoadWithRequestNavigationType:function(t,e,i){try{let s=getSubscriptionController(),n=e.URL().absoluteString(),i=MNUtil.parseURL(n);switch(i.scheme){case"marginnote4app":case"marginnote3app":case"xhsdiscover":return MNUtil.confirm("MN Utils","Open Red Note?\n\n是否打开小红书？").then(async t=>{t&&MNUtil.openURL(n)}),s.changeViewTo(subscriptionConfig.lastView,!0),!1;case"mqqapi":return MNUtil.confirm("MN Utils","Open QQ?\n\n是否打开QQ？").then(async t=>{t&&MNUtil.openURL(n),s.changeViewTo(subscriptionConfig.lastView,!0)}),!1;case"tencent":return"groupwpa"===i.host&&(MNUtil.confirm("MN Utils","Open QQ Group?\n\n是否打开QQ群？").then(async t=>{t&&MNUtil.openURL(n)}),s.changeViewTo(subscriptionConfig.lastView,!0)),!1;case"nativeaction":return"copy"===i.host&&MNUtil.copy(i.params.text),!1;case"mnaddonaction":return s.executeMNAddonAction(i),!1;case"afd":return MNConnection.loadRequest(s.docview,"https://afdian.com",!1),!1;case"subscription":switch(i.host){case"newkey":return s.afdNewkeyOrderPage(i.params.credit,i.params.openInBrowser),!1;case"recharge":return s.afdRechargeOrderPage(i.params.credit,i.params.openInBrowser),!1;case"verify":var r=i.params.apikey;return s.verifyApiKeyInRechargePage(r),!1}return!1;case"https":if(t.sidebar){switch(i.host){case"qm.qq.com":return s.setWebMode(MNUtil.isMacOS(),"docview"),MNConnection.loadRequest(s.docview,n,!1),!1;case"www.xiaohongshu.com":return!0;case"oia.xiaohongshu.com":return MNUtil.confirm("MN Utils","Open Red Note?\n\n是否打开小红书？").then(async t=>{var e=i.params.deeplink;t&&(MNUtil.openURL(e),s.changeViewTo(subscriptionConfig.lastView,!0))}),!1}return s.checkDocview(),650<s.view.frame.width&&(s.waitHUD("Previewing Document...",s.docview),s.previewPDF(subscriptionUtils.mainPath+"/test.pdf")),!1}if("ifdian.net"===i.host||"afdian.com"===i.host){var a=i.params;if(a&&"method"in a&&"alipay.trade.page.pay.return"===a.method)return s.docview.stopLoading(),MNConnection.loadRequest(s.docview,"https://ifdian.net/message/929697869e9311eea6745254001e7c00",!1),!1}if("h5coml.vivo.com.cn"===i.host)return!1;if("mnaddon.craft.me"===i.host)return s.waitHUD("Loading Document...",s.docview),!0}if(n.startsWith("data:application/pdf;base64,"))return!0;let o=subscriptionUtils.getFileNameFromUrl(n);if(o&&(o.endsWith(".marginnotes")||o.endsWith(".marginpkg"))&&MNUtil.confirm("Should download this notebook?","是否下载该学习集？\n"+o).then(async t=>{var e;t&&(s.waitHUD("Downloading..."),t=subscriptionUtils.mainPath+"/"+o,e=MNConnection.requestWithURL(n),NSURLConnection.connectionWithRequestDelegate(e,s),s.targetPath=t,s.folder=subscriptionUtils.mainPath+"/download")}),/^https?\:\/\/.*\.mnaddon$/.test(n)){let o=MNUtil.getFileName(n);return MNUtil.confirm("Install mnaddon: "+o+"?","安装插件: "+o+"？").then(async t=>{var e,i;t&&(s.waitHUD("Download: "+o),t=subscriptionUtils.mainPath+"/"+o,(await MNConnection.fetch(n)).writeToFileAtomically(t,!1),s.waitHUD("Get addonid..."),ZipArchive.unzipFileAtPathToDestination(t,subscriptionUtils.mainPath+"/temp"),e=MNUtil.readJSON(subscriptionUtils.mainPath+"/temp/mnaddon.json"))&&"addonid"in e&&(i=subscriptionUtils.extensionPath+"/"+e.addonid,ZipArchive.unzipFileAtPathToDestination(t,i),s.showHUD(`Install mnaddon [${e.title}] success! Please restart MN manually`))}),!1}}catch(t){return subscriptionUtils.addErrorLog(t,"webViewShouldStartLoadWithRequestNavigationType"),!1}return!0},scrollViewDidScroll:function(){},openRechargePage:async function(t){await self.loadRechargePage()},chooseAPIKeyForQuota:async function(){var t=getSubscriptionController(),e=subscriptionConfig.APIKey;let i="newAPIKey",o,s;if(e)switch(o=await MNUtil.userSelect("Select Action\n选择操作","",["New Key / 新的Key","Recharge / 充值"])){case 0:return;case 1:i="newAPIKey";break;case 2:i="rechargeAPIKey";break;default:return}if("newAPIKey"===i)o=await MNUtil.userSelect("Select APIKey for quota","选择要购买的额度",["5 Points (5¥)","10 Points (9.5¥)","20 Points (19¥)","50 Points (45¥)"]),s=["https://ifdian.net/order/create?product_type=1&plan_id=a6ed8b60fbcf11ee941152540025c377&sku=%5B%7B%22sku_id%22:%22b24e214cfd3f11eebc335254001e7c00%22,%22count%22:1%7D%5D","https://ifdian.net/order/create?product_type=1&plan_id=a6ed8b60fbcf11ee941152540025c377&sku=%5B%7B%22sku_id%22:%22a58e5502146f11efa4fa5254001e7c00%22,%22count%22:1%7D%5D","https://ifdian.net/order/create?product_type=1&plan_id=a6ed8b60fbcf11ee941152540025c377&sku=%5B%7B%22sku_id%22:%2279e3e74a147011efb46e52540025c377%22,%22count%22:1%7D%5D","https://ifdian.net/order/create?product_type=1&plan_id=a6ed8b60fbcf11ee941152540025c377&sku=%5B%7B%22sku_id%22%3A%22e87e8a7432f811efaa1552540025c377%22,%22count%22%3A1%7D%5D"];else if(o=await MNUtil.userSelect("Choose the recharge quota","选择要增加的额度\n(充值到账有数小时延迟)",["5 Points (5¥)","10 Points (9.5¥)","20 Points (19¥)","50 Points (45¥)"]),s=["https://ifdian.net/order/create?product_type=1&plan_id=f52724aa464611ef8acc52540025c377&sku=%5B%7B%22sku_id%22:%22f52fdfc8464611efbe3052540025c377%22,%22count%22:1%7D%5D","https://ifdian.net/order/create?product_type=1&plan_id=f52724aa464611ef8acc52540025c377&sku=%5B%7B%22sku_id%22:%22a077cf88557611efb1785254001e7c00%22,%22count%22:1%7D%5D","https://ifdian.net/order/create?product_type=1&plan_id=f52724aa464611ef8acc52540025c377&sku=%5B%7B%22sku_id%22:%22a0831816557611ef8fb05254001e7c00%22,%22count%22:1%7D%5D","https://ifdian.net/order/create?product_type=1&plan_id=f52724aa464611ef8acc52540025c377&sku=%5B%7B%22sku_id%22:%22ba4c466e557611ef80c852540025c377%22,%22count%22:1%7D%5D"],0===o)return;switch(t.docview.customUserAgent="Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_6) AppleWebKit/605.1.15 (KHTML, like Gecko) Version/16.0 Safari/605.1.15",o){case 0:return;case 1:MNConnection.loadRequest(t.docview,s[0]+"&remark="+e);break;case 2:MNConnection.loadRequest(t.docview,s[1]+"&remark="+e);break;case 3:MNConnection.loadRequest(t.docview,s[2]+"&remark="+e);break;case 4:MNConnection.loadRequest(t.docview,s[3]+"&remark="+e);break;default:return}t.checkDocview()},showHelper:async function(t){await self.checkDocview(),self.waitHUD("Loading...",self.docview),MNConnection.loadRequest(self.docview,"https://mnaddon.craft.me/utils/subscription",MNUtil.isMacOS())},chooseQuota:async function(){var t=getSubscriptionController(),e=subscriptionConfig.APIKey;if(e){var i=await MNUtil.userSelect("Choose the recharge quota","选择要增加的额度\n(充值到账有数小时延迟)",["5 Points (5¥)","10 Points (9.5¥)","20 Points (19¥)","50 Points (45¥)"]),o=["https://ifdian.net/order/create?product_type=1&plan_id=f52724aa464611ef8acc52540025c377&sku=%5B%7B%22sku_id%22:%22f52fdfc8464611efbe3052540025c377%22,%22count%22:1%7D%5D","https://ifdian.net/order/create?product_type=1&plan_id=f52724aa464611ef8acc52540025c377&sku=%5B%7B%22sku_id%22:%22a077cf88557611efb1785254001e7c00%22,%22count%22:1%7D%5D","https://ifdian.net/order/create?product_type=1&plan_id=f52724aa464611ef8acc52540025c377&sku=%5B%7B%22sku_id%22:%22a0831816557611ef8fb05254001e7c00%22,%22count%22:1%7D%5D","https://ifdian.net/order/create?product_type=1&plan_id=f52724aa464611ef8acc52540025c377&sku=%5B%7B%22sku_id%22:%22ba4c466e557611ef80c852540025c377%22,%22count%22:1%7D%5D"];switch(t.docview.customUserAgent="Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_6) AppleWebKit/605.1.15 (KHTML, like Gecko) Version/16.0 Safari/605.1.15",i){case 0:return;case 1:MNConnection.loadRequest(t.docview,o[0]+"&remark="+e);break;case 2:MNConnection.loadRequest(t.docview,o[1]+"&remark="+e);break;case 3:MNConnection.loadRequest(t.docview,o[2]+"&remark="+e);break;case 4:MNConnection.loadRequest(t.docview,o[3]+"&remark="+e);break;default:return}t.checkDocview()}else t.showHUD("No APIKey")},getApiKey:async function(t){var e=getSubscriptionController();await e.checkDocview(),e.docview.customUserAgent="Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_6) AppleWebKit/605.1.15 (KHTML, like Gecko) Version/16.0 Safari/605.1.15",MNConnection.loadRequest(e.docview,"https://ifdian.net/message/929697869e9311eea6745254001e7c00")},openURL:async function(t){await self.checkDocview(),self.docview.customUserAgent="Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_6) AppleWebKit/605.1.15 (KHTML, like Gecko) Version/16.0 Safari/605.1.15",MNConnection.loadRequest(self.docview,t.url)},changeURL:function(t){self.popoverController&&self.popoverController.dismissPopoverAnimated(!0);var e=subscriptionConfig.URL,i="changeURLTo:",i=[MNUtil.tableItem("URL1 (default)",self,i,"https://api.feliks.top","https://api.feliks.top"===e),MNUtil.tableItem("URL2",self,i,"https://api1.feliks.top","https://api1.feliks.top"===e),MNUtil.tableItem("URL3",self,i,"https://alpha.u1162561.nyat.app:20075","https://alpha.u1162561.nyat.app:20075"===e),MNUtil.tableItem("URL4",self,i,"https://api.u1162561.nyat.app:20074","https://api.u1162561.nyat.app:20074"===e)];self.popoverController=MNUtil.getPopoverAndPresent(t,i,200,2)},changeURLTo:function(t){self.popoverController&&self.popoverController.dismissPopoverAnimated(!0),subscriptionConfig.config.url=t,subscriptionConfig.save(),self.URLButton.setTitleForState(subscriptionUtils.getURLTitle(),0)},changeView:async function(t){var e,i=getSubscriptionController();try{i.miniMode?(await i.exitMiniMode(),e=subscriptionConfig.lastView,i.lastRefreshView===e&&i.lastRefreshTime>Date.now()-6e4?i.refresh(!1):i.refresh()):(Menu.dismissCurrentMenu(),i.popoverController&&i.popoverController.dismissPopoverAnimated(!0),i.changeView(t))}catch(t){subscriptionUtils.addErrorLog(t,"changeView")}},setViewTo:async function(t){var e=getSubscriptionController();try{Menu.dismissCurrentMenu(),e.changeViewTo(t)}catch(t){subscriptionUtils.addErrorLog(t,"setViewTo")}},force2Crash:function(t){MNUtil.studyView.frame={x:void 0}},showPanel:function(t){Menu.dismissCurrentMenu(),"sidebar"===t?MNExtensionPanel.toggle():(self.blur(),MNUtil.excuteCommand("OpenExtensions"))},pasteApiKey:async function(t){return void MNUtil.showHUD("pasteApiKey")},toggleApikey:function(t){var e;self.apikeyInput.text&&self.apikeyInput.text.trim()?(self.apikeyInput.text="",self.apikeyInput.editable=!1,MNButton.setColor(self.showAPIKeyButton,"#a2a2a2")):(self.apikeyInput.editable=!0,subscriptionConfig.config.apikey.trim()?(e=subscriptionConfig.APIKey,self.apikeyInput.text=e,self.showAPIKeyButton.color="#e06c75",MNUtil.copy(e),self.showHUD("APIKey 已复制")):(self.showAPIKeyButton.color="#a2a2a2",self.showHUD("No APIKey")))},refreshUsage:async function(t){var e,i=getSubscriptionController(),o=(i.waitHUD("Fetching usage"),await subscriptionNetwork.getUsage());MNUtil.stopHUD(),"error"in o?o.noQuota?(i.usageButton.setTitleForState(o.error,0),await MNUtil.confirm("订阅Key额度不足\n是否充值?",JSON.stringify(o,void 0,2))&&i.loadRechargePage()):o.disabled?(i.usageButton.setTitleForState(o.error,0),MNUtil.confirm("订阅Key被禁用",JSON.stringify(o,void 0,2))):i.usageButton.setTitleForState(o.error,0):(e=99999999<o.total?"":" / "+o.total.toFixed(2),i.usageButton.setTitleForState("Usage: "+(o.usage/100).toFixed(2)+e,0))},showDetail:async function(t){await self.checkDocview();var e=subscriptionConfig.APIKey;e?(self.showHUD("Loading..."),self.docview.loadFileURLAllowingReadAccessToURL(NSURL.fileURLWithPath(subscriptionUtils.mainPath+"/usage.html"),NSURL.fileURLWithPath(subscriptionUtils.mainPath+"/")),await MNUtil.delay(.5),self.runJavaScript(`window.fetchData("${e}","${subscriptionConfig.URL}")`,"docview")):self.showHUD("No APIKey")},chooseActivateDays:function(t){var e;self.popoverController&&self.popoverController.dismissPopoverAnimated(!0),subscriptionConfig.APIKey?!subscriptionConfig.config.activated&&subscriptionConfig.config.subscriptionDaysRemain||!subscriptionConfig.isSubscribed()&&subscriptionConfig.config.subscriptionDaysRemain?(subscriptionConfig.config.activated=!0,subscriptionConfig.config.subscribedDay=subscriptionUtils.getToday(),subscriptionConfig.config.subscriptionDaysRemain=subscriptionConfig.config.subscriptionDaysRemain-1,subscriptionConfig.save(),subscriptionUtils.refreshAddonCommands(),self.activationStatus.setTitleForState(subscriptionConfig.getStatus(),0),subscriptionUtils.showHUD("Subscription days remian: "+subscriptionConfig.config.subscriptionDaysRemain)):(e="activate:",e=[MNUtil.tableItem("1 day",self,e,1),MNUtil.tableItem("5 days",self,e,5),MNUtil.tableItem("10 days",self,e,10),MNUtil.tableItem("15 days",self,e,15),MNUtil.tableItem("20 days",self,e,20),MNUtil.tableItem("25 days",self,e,25),MNUtil.tableItem("30 days",self,e,30)],self.popoverController=MNUtil.getPopoverAndPresent(t,e,100,1)):(MNConnection.loadFile(self.docview,subscriptionUtils.mainPath+"/newkey.html",subscriptionUtils.mainPath),self.checkDocview())},activate:async function(t=1){self.popoverController&&self.popoverController.dismissPopoverAnimated(!0);var e=self.apikeyInput.text.trim();if((e&&(subscriptionConfig.config.apikey=e),10<=t)&&!await MNUtil.confirm(`You'll be charged $${.1*t} for a ${t}-day subscription. Please confirm`,`订阅${t}天会扣除${.1*t}$额度. 请确认`))return;var i,e=await subscriptionNetwork.subscribe(t);e.success?"error"in(t=await subscriptionNetwork.getUsage())?self.usageButton.setTitleForState(t.error,0):(i=99999999<t.total?"":" / "+t.total.toFixed(2),self.usageButton.setTitleForState("Usage: "+(t.usage/100).toFixed(2)+i,0)):(subscriptionConfig.config.autoSubscription=!1,self.autoSubscription.setTitleForState(subscriptionConfig.config.autoSubscription?"Auto subscription: ✅":"Auto subscription: ❌",0),subscriptionConfig.save(),e.noQuota?(self.usageButton.setTitleForState("订阅Key额度不足",0),await MNUtil.confirm("订阅Key额度不足\n是否充值?",e.error.message)&&self.loadRechargePage()):e.disabled?(self.usageButton.setTitleForState("订阅Key已被禁用",0),MNUtil.confirm("订阅Key已被禁用",e.error.message)):e.error?.message?MNUtil.confirm("订阅时发生错误",e.error):MNUtil.confirm("订阅时发生错误"))},toggleAutoSubscription:async function(t){try{var e=subscriptionConfig.getConfig("autoSubscription");subscriptionConfig.config.autoSubscription=!e,subscriptionConfig.save(),self.autoSubscription.setTitleForState(subscriptionConfig.config.autoSubscription?"Auto subscription: ✅":"Auto subscription: ❌",0)}catch(t){subscriptionUtils.addErrorLog(t,"toggleAutoSubscription")}},changeOpacity:function(t){self.popoverController&&self.popoverController.dismissPopoverAnimated(!0);var e=[{title:"100%",object:self,selector:"changeOpacityTo:",param:1},{title:"90%",object:self,selector:"changeOpacityTo:",param:.9},{title:"80%",object:self,selector:"changeOpacityTo:",param:.8},{title:"70%",object:self,selector:"changeOpacityTo:",param:.7},{title:"60%",object:self,selector:"changeOpacityTo:",param:.6},{title:"50%",object:self,selector:"changeOpacityTo:",param:.5}];self.popoverController=subscriptionUtils.getPopoverAndPresent(t,e,100)},changeOpacityTo:function(t){self.view.layer.opacity=t},closeButtonTapped:async function(){self.toMinimode(!0),self.blur()},refreshButtonTapped:async function(t){let e=getSubscriptionController();var i,o=subscriptionConfig.lastView;"subscriptionView"==o?"error"in(i=await subscriptionNetwork.getUsage())?e.usageButton.setTitleForState(i.error,0):e.usageButton.setTitleForState(`Usage: ${(i.usage/100).toFixed(2)} / `+i.total.toFixed(2),0):"log"==o?e.clearLogs():t.clickDate&&Date.now()-t.clickDate<500?(e.webview.loadFileURLAllowingReadAccessToURL(NSURL.fileURLWithPath(subscriptionUtils.mainPath+"/sidebar.html"),NSURL.fileURLWithPath(subscriptionUtils.mainPath+"/")),MNUtil.delay(.5).then(()=>{e.refreshSidebar(!1,subscriptionConfig.lastView)})):(e.refreshSidebar(!0,subscriptionConfig.lastView),t.clickDate=Date.now()),e.view.setNeedsLayout()},onMoveGesture:function(t){try{var e,i,o,s,n,r,a=self.view.frame;if(1===t.state)e=t.translationInView(t.view),i=t.locationInView(MNUtil.currentWindow),self.setMiniColor(!1),self.base=MNUtil.genFrame(a.x-i.x+e.x,a.y-i.y+e.y,a.width,a.height);else if(2===t.state&&(o=MNUtil.currentWindow.bounds,s=t.locationInView(MNUtil.currentWindow),n=MNUtil.constrain(self.base.y+s.y,0,o.height-15),r=MNUtil.constrain(self.base.x+s.x,-.5*self.base.width,o.width-40),self.view.frame=MNUtil.genFrame(r,n,self.base.width,self.base.height),self.currentFrame=self.view.frame,self.custom=!1),3===t.state&&self.miniMode){var c=subscriptionUtils.topOffset,l=subscriptionUtils.bottomOffset;let i={left:a.x,right:MNUtil.currentWindow.frame.width-a.x-a.width,top:a.y-c,bottom:MNUtil.currentWindow.frame.height-a.y-a.height-l};if(i.left<20&&i.top<20)subscriptionConfig.config.customMode="leftTop";else if(i.right<20&&i.top<20)subscriptionConfig.config.customMode="rightTop";else if(i.left<20&&i.bottom<20)subscriptionConfig.config.customMode="leftBottom";else if(i.right<20&&i.bottom<20)subscriptionConfig.config.customMode="rightBottom";else{var u=Object.keys(i).reduce((t,e)=>i[t]<i[e]?t:e);if(!["left","right","top","bottom"].includes(u))return void MNUtil.showHUD("No edge found");subscriptionConfig.config.customMode=u}let e=subscriptionConfig.getMiniFrame(a,subscriptionConfig.config.customMode);self.onAnimate=!0,MNUtil.animate(()=>{self.view.frame=e,self.currentFrame=self.view.frame,self.custom=!1}).then(()=>{self.onAnimate=!1,subscriptionConfig.config.miniFrame=e,subscriptionConfig.save(),self.setMiniColor(!0);var t=self.lastFrame;self.lastFrame=subscriptionUtils.calcLastFrame(t)})}}catch(t){subscriptionUtils.addErrorLog(t,"onMoveGesture")}},onResizeGesture0:function(t){self.custom=!1;var e=t.view.frame,i=t.locationInView(self.view),o=self.view.frame;let s=i.x+.5*e.width;i=self.view.frame.height;s<=280&&(s=280),self.view.frame={x:o.x,y:o.y,width:s,height:i},self.currentFrame=self.view.frame,3===t.state&&MNUtil.currentWindow.bringSubviewToFront(self.view)},onResizeGesture:function(t){self.custom=!1,self.dynamic=!1;var e=t.view.frame,i=t.locationInView(t.view),o=self.view.frame;let s=i.x+e.x+.3*e.width,n=i.y+e.y+.3*e.height;s<=280&&(s=280),n<=subscriptionConfig.frameHeight&&(n=subscriptionConfig.frameHeight),self.view.frame={x:o.x,y:o.y,width:s,height:n},self.currentFrame=self.view.frame,3===t.state&&MNUtil.currentWindow.bringSubviewToFront(self.view)},onLongPress:async function(t){var e;1===t.state&&(e=getSubscriptionController(),(t=t.view).url?MNUtil.openURL(t.url):t.id&&"changeview"===t.id&&e.changeView(t))}});function tryCatch(e){return function(...t){try{return e(...t)}catch(t){return MNUtil.showHUD(t),null}}}subscriptionController.prototype.refresh=async function(t=!0){try{switch(subscriptionConfig.lastView){case"subscriptionView":this.subscriptionView.hidden=!1,this.webview.hidden=!0,this.moveButton.setTitle("Subscription Manager"),subscriptionConfig.config.lastView="subscriptionView";break;case"webview":this.subscriptionView.hidden=!0,this.webview.hidden=!1,this.moveButton.setTitle("Update Manager"),t&&MNUtil.delay(.5).then(()=>{this.refreshSidebar(!0,"webview")}),subscriptionConfig.config.lastView="webview";break;case"webviewAlpha":this.subscriptionView.hidden=!0,this.webview.hidden=!1,this.moveButton.setTitle("Update Manager (α)"),t&&MNUtil.delay(.5).then(()=>{this.refreshSidebar(!0,"webviewAlpha")}),subscriptionConfig.config.lastView="webviewAlpha";break;case"shareNotebooks":this.subscriptionView.hidden=!0,this.webview.hidden=!1,this.moveButton.setTitle("Shared Notebooks"),t&&MNUtil.delay(.5).then(()=>{this.refreshSidebar(!0,"shareNotebooks")}),subscriptionConfig.config.lastView="shareNotebooks";break;case"shareDocuments":this.subscriptionView.hidden=!0,this.webview.hidden=!1,this.moveButton.setTitle("Shared Documents"),t&&MNUtil.delay(.5).then(()=>{this.refreshSidebar(!0,"shareDocuments")}),subscriptionConfig.config.lastView="shareDocuments";break;case"log":this.subscriptionView.hidden=!0,this.webview.hidden=!1,MNButton.setTitle(this.moveButton,"Log Viewer",void 0,!0),this.webview.loadFileURLAllowingReadAccessToURL(NSURL.fileURLWithPath(subscriptionUtils.mainPath+"/log.html"),NSURL.fileURLWithPath(subscriptionUtils.mainPath+"/")),subscriptionConfig.config.lastView="log";var e=this.view.frame;e.width<500&&(e.width=500),e.height<500&&(e.height=500),this.view.frame=e,this.currentFrame=e,this.view.setNeedsLayout(),await MNUtil.delay(.5),this.showLog(MNUtil.logs)}}catch(t){subscriptionUtils.addErrorLog(t,"refresh")}},subscriptionController.prototype.init=async function(){try{this.logoImage=MNUtil.getImage(subscriptionUtils.mainPath+"/dollar.png",2),this.logImage=MNUtil.getImage(subscriptionUtils.mainPath+"/log.png",2),this.appImage=MNUtil.getImage(subscriptionUtils.mainPath+"/app.png",2),this.bothModeImage=MNUtil.getImage(subscriptionUtils.mainPath+"/bothMode.png",2),this.goforwardImage=MNUtil.getImage(subscriptionUtils.mainPath+"/goforward.png",2),this.screenImage=MNUtil.getImage(subscriptionUtils.mainPath+"/screen.png",2),this.snipasteImage=MNUtil.getImage(subscriptionUtils.mainPath+"/snipaste.png",2),this.closeImage=MNUtil.getImage(subscriptionUtils.mainPath+"/stop.png",2),this.view.layer.shadowOffset={width:0,height:0},this.view.layer.shadowRadius=15,this.view.layer.shadowOpacity=.5,this.view.layer.shadowColor=UIColor.colorWithWhiteAlpha(.5,1),this.view.layer.opacity=1,this.view.layer.cornerRadius=15,this.view.backgroundColor=UIColor.blackColor().colorWithAlphaComponent(1),this.highlightColor=UIColor.blendedColor(UIColor.colorWithHexString("#2c4d81").colorWithAlphaComponent(.8),Application.sharedInstance().defaultTextColor,.8);var t=subscriptionConfig.isSubscribed()?"#457bd3":"#677180",e=(this.moveButton=MNButton.new({title:"Subscription Manager",bold:!0,font:16,radius:8,color:t,highlight:this.highlightColor,opacity:.8,alpha:.4,id:"changeview"},this.view),this.moveButton.addClickAction(this,"changeView:"),this.moveButton.addLongPressGesture(this,"onLongPress:"),this.closeButton=MNButton.new({image:subscriptionUtils.mainPath+"/stop.png",radius:8,color:"#e06c75",opacity:.8},this.view),this.closeButton.addClickAction(this,"closeButtonTapped:"),this.refreshButton=MNButton.new({image:subscriptionUtils.mainPath+"/reload.png",radius:8,color:"#457bd3",opacity:.8},this.view),this.refreshButton.addClickAction(this,"refreshButtonTapped:"),this.subscriptionView=UIView.new(),this.subscriptionView.backgroundColor=UIColor.whiteColor().colorWithAlphaComponent(.8),this.subscriptionView.layer.cornerRadius=13,this.subscriptionView.hidden=!1,this.view.addSubview(this.subscriptionView),this.webview=new UIWebView(this.view.bounds),this.webview.backgroundColor=UIColor.whiteColor(),this.webview.scalesPageToFit=!0,this.webview.autoresizingMask=18,((this.webview.delegate=this).webview.scrollView.delegate=this).webview.scrollView.bounces=!1,this.webview.layer.cornerRadius=15,this.webview.layer.masksToBounds=!0,this.webview.layer.borderColor=MNUtil.hexColorAlpha("#9bb2d6",.8),this.webview.layer.borderWidth=0,this.webview.sidebar=!0,this.docview=new UIWebView(this.view.bounds),this.docview.backgroundColor=UIColor.whiteColor(),this.docview.scalesPageToFit=!0,this.docview.autoresizingMask=18,((this.docview.delegate=this).docview.scrollView.delegate=this).docview.scrollView.bounces=!1,this.docview.layer.cornerRadius=15,this.docview.layer.masksToBounds=!0,this.docview.layer.borderColor=MNUtil.hexColorAlpha("#9bb2d6",.8),this.docview.layer.borderWidth=0,this.docview.sidebar=!1,this.docview.customUserAgent="Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_6) AppleWebKit/605.1.15 (KHTML, like Gecko) Version/16.0 Safari/605.1.15",this.highlightColor=UIColor.blendedColor(MNUtil.hexColorAlpha("#2c4d81",.8),MNUtil.app.defaultTextColor,.8),this.webview.hidden=!0,this.docview.hidden=!0,this.webview.lastOffset=0,this.view.addSubview(this.webview),this.view.addSubview(this.docview),this.webview.loadFileURLAllowingReadAccessToURL(NSURL.fileURLWithPath(subscriptionUtils.mainPath+"/sidebar.html"),NSURL.fileURLWithPath(subscriptionUtils.mainPath+"/")),this.activationStatus=MNButton.new({title:subscriptionConfig.getStatus(),bold:!0,font:14,radius:10,color:"#457bd3",highlight:this.highlightColor,opacity:.8},this.subscriptionView),this.activationStatus.addClickAction(this,"chooseActivateDays:"),subscriptionConfig.getConfig("autoSubscription"));this.autoSubscription=MNButton.new({title:e?"Auto subscription: ✅":"Auto subscription: ❌",bold:!0,font:14,radius:10,color:"#457bd3",highlight:this.highlightColor,opacity:.8},this.subscriptionView),this.autoSubscription.addClickAction(this,"toggleAutoSubscription:"),this.freeUsage=MNButton.new({title:subscriptionConfig.getFreeUsage(),bold:!0,font:14,radius:10,color:"#457bd3",highlight:this.highlightColor,opacity:.8},this.subscriptionView),this.usageButton=MNButton.new({title:"Refresh Usage",bold:!0,font:14,radius:10,color:"#457bd3",highlight:this.highlightColor,opacity:.8},this.subscriptionView),this.usageButton.addClickAction(this,"refreshUsage:"),this.usageDetailButton=MNButton.new({title:"Usage Detail",bold:!0,font:14,radius:10,color:"#457bd3",highlight:this.highlightColor,opacity:.8},this.subscriptionView),this.usageDetailButton.addClickAction(this,"showDetail:"),this.URLButton=MNButton.new({title:subscriptionUtils.getURLTitle(),bold:!0,font:14,radius:10,color:"#457bd3",highlight:this.highlightColor,opacity:.8},this.subscriptionView),this.URLButton.addClickAction(this,"changeURL:"),this.apikeyInput=this.creatTextView("subscriptionView",void 0,.75),this.apikeyInput.editable=!1,this.apikeyInput.text="",this.apikeyInput.becomeFirstResponder(),this.pasteKeyButton=MNButton.new({title:"Paste",bold:!0,font:14,radius:8,color:"#e06c75",highlight:this.highlightColor,opacity:.8},this.subscriptionView),this.pasteKeyButton.addClickAction(this,"pasteApiKey:"),this.showAPIKeyButton=MNButton.new({image:subscriptionUtils.mainPath+"/vision.png",radius:8,color:"#a2a2a2",opacity:.8},this.subscriptionView),this.showAPIKeyButton.addClickAction(this,"toggleApikey:"),this.DMButton=MNButton.new({title:"Show APIKey",bold:!0,font:14,highlight:this.highlightColor,radius:10,color:"#e06c75",opacity:.8,url:"https://ifdian.net/message/929697869e9311eea6745254001e7c00"},this.subscriptionView),this.DMButton.addClickAction(this,"getApiKey:"),this.DMButton.addLongPressGesture(this,"onLongPress:"),this.buyAPIKeyButton=MNButton.new({title:"Buy APIKey",bold:!0,font:14,highlight:this.highlightColor,radius:10,color:"#9bb2d6",id:"chooseAPIKeyForQuota"},this.subscriptionView),this.buyAPIKeyButton.addClickAction(this,"openRechargePage:"),this.helperButton=MNButton.new({title:"Have questions?",bold:!0,font:14,highlight:this.highlightColor,radius:10,color:"#9bb2d6",id:"showHelper"},this.subscriptionView),this.helperButton.addClickAction(this,"showHelper:"),this.resizeButton=MNButton.new({image:subscriptionUtils.mainPath+"/curve.png",radius:10,color:"#e06c75",opacity:.8,alpha:0},this.view),this.moveButton.addPanGesture(this,"onMoveGesture:"),this.closeButton.addPanGesture(this,"onResizeGesture0:"),this.resizeButton.addPanGesture(this,"onResizeGesture:"),this.toMinimode(!1)}catch(t){subscriptionUtils.addErrorLog(t,"init")}},subscriptionController.prototype.show=function(t){let e=this.view.frame,i=this.view.layer.opacity;if("marginnote3"===subscriptionUtils.version.version)this.view.hidden=!1;else{let t=subscriptionConfig.lastView;this.view.layer.opacity=.2,"log"===t&&(e.width<500&&(e.width=500),e.x+500>MNUtil.studyWidth&&(e.x=MNUtil.studyWidth-500),e.height<500&&(e.height=500),e.y+500>MNUtil.studyHeight)&&(e.y=MNUtil.studyHeight-500),this.view.hidden=!1,this.moveButton.hidden=!0,this.closeButton.hidden=!0,this.activationStatus.hidden=!0,this.freeUsage.hidden=!0,this.autoSubscription.hidden=!0,this.usageButton.hidden=!0,this.apikeyInput.hidden=!0,this.pasteKeyButton.hidden=!0,this.refreshButton.hidden=!0,MNUtil.currentWindow.bringSubviewToFront(this.view),this.activationStatus.setTitle(subscriptionConfig.getStatus()),this.freeUsage.setTitle(subscriptionConfig.getFreeUsage()),MNUtil.animate(()=>{this.view.layer.opacity=i,this.view.frame=e,this.currentFrame=e}).then(()=>{this.view.layer.borderWidth=0,this.moveButton.hidden=!1,this.closeButton.hidden=!1,this.activationStatus.hidden=!1,this.freeUsage.hidden=!1,this.autoSubscription.hidden=!1,this.pasteKeyButton.hidden=!1,this.apikeyInput.hidden=!1,this.usageButton.hidden=!1,this.refreshButton.hidden=!1,this.refreshLayout(),"webview"===t?this.refreshSidebar(!0,!1):"webviewAlpha"===t?this.refreshSidebar(!0,!0):"log"===t&&this.showLog(MNUtil.logs)})}},subscriptionController.prototype.hide=function(t){let e=this.view.layer.opacity;"marginnote3"===subscriptionUtils.version.version?this.view.hidden=!0:(this.moveButton.hidden=!0,this.closeButton.hidden=!0,this.activationStatus.hidden=!0,this.freeUsage.hidden=!0,this.autoSubscription.hidden=!0,this.pasteKeyButton.hidden=!0,this.usageButton.hidden=!0,this.apikeyInput.hidden=!0,this.refreshButton.hidden=!0,MNUtil.animate(()=>{this.view.layer.opacity=.2}).then(()=>{this.view.hidden=!0,this.view.layer.opacity=e}))},subscriptionController.prototype.creatTextView=function(t="view",e="#c0bfbf",i=.9){var o=UITextView.new();return o.font=UIFont.systemFontOfSize(15),o.layer.cornerRadius=8,o.backgroundColor=subscriptionUtils.hexColorAlpha(e,i),o.textColor=UIColor.blackColor(),o.bounces=!0,this[t].addSubview(o),o},subscriptionController.prototype.refreshLayout=function(){this.freeUsage.setTitleForState(subscriptionConfig.getFreeUsage(),0)},subscriptionController.prototype.runJavaScript=async function(i,o="webview"){return new Promise((e,t)=>{try{this[o].evaluateJavaScript(i,t=>{e(t)})}catch(t){subscriptionUtils.addErrorLog(t,"runJavaScript"),e(0)}})},subscriptionController.prototype.getApikeyFromWebview=async function(i){return new Promise((e,t)=>{i.evaluateJavaScript('JSON.stringify(Array.from(document.getElementsByClassName("msg")).map(msg => msg.innerText).filter(msg=>msg.startsWith("sk")))',async t=>{var t=JSON.parse(t);t.length&&((t=t.at(-1))===subscriptionConfig.APIKey&&e(void 0),e(t)),e(void 0)})})},subscriptionController.prototype.refreshSidebar=async function(e=!0,r="webview"){try{let t;if(e){if(!this.view.hidden)switch(r){case"webview":this.waitHUD("Retrieving updates...",this.webview);break;case"shareNotebooks":this.waitHUD("Retrieving notebooks...",this.webview);break;case"shareDocuments":this.waitHUD("Retrieving documents...",this.webview);break;case"webviewAlpha":this.waitHUD("Retrieving updates (α)...",this.webview)}switch(r){case"webview":t=await subscriptionNetwork.readFileFromWebdav("mnaddon.json"),subscriptionConfig.config.alpha=!1,this.lastRefreshView="webview",this.lastRefreshTime=Date.now();break;case"shareNotebooks":t=await subscriptionNetwork.readFileFromWebdav("shareNotebooks.json"),this.lastRefreshView="shareNotebooks",this.lastRefreshTime=Date.now();break;case"shareDocuments":t=await subscriptionNetwork.readFileFromWebdav("shareDocuments.json"),this.lastRefreshView="shareDocuments",this.lastRefreshTime=Date.now();break;case"webviewAlpha":t=await subscriptionNetwork.readFileFromWebdav("mnaddonAlpha.json"),subscriptionConfig.config.alpha=!0,this.lastRefreshView="webviewAlpha",this.lastRefreshTime=Date.now()}MNUtil.stopHUD(),subscriptionConfig.mnaddon=t}else t=subscriptionConfig.mnaddon;let i=subscriptionUtils.getLocalMNAddonVersions(),o=[],s=[],n=[];var a,c;Array.isArray(t)?(c=(t=t.map(t=>{var e=t.id;if(e in i)switch(subscriptionUtils.compareVersions(t.version,i[e])){case 0:t.action="reinstall",s.push(t);break;case 1:t.action="update",o.push(t);break;case-1:t.action="reinstall",s.push(t)}else n.push(t);return t}),0<o.length&&(a=o.map(t=>t.name),MNUtil.showHUD("Updates available: "+a.join(", "))),o.concat(s).concat(n)),this.runJavaScript(`updateFromNative(\`${encodeURIComponent(JSON.stringify(c))}\`)`),subscriptionConfig.save()):t.timeout&&t.message?MNUtil.showHUD(t.message):subscriptionUtils.addErrorLog("获取插件商店内容失败","refreshSidebar",t)}catch(t){subscriptionUtils.addErrorLog(t,"refreshSidebar")}},subscriptionController.prototype.activate=async function(t=1){MNUtil.showHUD("activate");var e=this.apikeyInput.text.trim();e?subscriptionConfig.APIKey=e:subscriptionConfig.APIKey,subscriptionConfig.config.activated?!subscriptionConfig.isSubscribed()&&subscriptionConfig.config.subscriptionDaysRemain?(subscriptionConfig.config.activated=!0,subscriptionConfig.config.subscribedDay=subscriptionUtils.getToday(),subscriptionConfig.config.subscriptionDaysRemain=subscriptionConfig.config.subscriptionDaysRemain-1,subscriptionConfig.save(),subscriptionUtils.refreshAddonCommands(),this.activationStatus.setTitle(subscriptionConfig.getStatus()),subscriptionUtils.showHUD("Subscription days remian: "+subscriptionConfig.config.subscriptionDaysRemain)):(await subscriptionNetwork.subscribe(t)).success||(this.autoSubscription.setTitle(subscriptionConfig.config.autoSubscription?"Auto subscription: ✅":"Auto subscription: ❌"),subscriptionConfig.save()):subscriptionConfig.config.subscriptionDaysRemain?(subscriptionConfig.config.activated=!0,subscriptionConfig.config.subscribedDay=subscriptionUtils.getToday(),subscriptionConfig.config.subscriptionDaysRemain=subscriptionConfig.config.subscriptionDaysRemain-1,subscriptionConfig.save(),subscriptionUtils.refreshAddonCommands(),this.activationStatus.setTitle(subscriptionConfig.getStatus()),subscriptionUtils.showHUD("Subscription days remian: "+subscriptionConfig.config.subscriptionDaysRemain)):subscriptionNetwork.subscribe(t)},subscriptionController.prototype.blur=async function(){await this.runJavaScript(`        function removeFocus() {
            // 获取当前具有焦点的元素
            const focusedElement = document.activeElement;

            // 如果当前焦点元素存在，移除焦点
            if (focusedElement) {
                focusedElement.blur();
            }
        }
        removeFocus()`,"docview"),this.docview.endEditing(!0)},subscriptionController.prototype.layoutSubviews=function(){var t,e,i,o;this.miniMode||(t=(e=this.view.bounds).width,e=e.y+e.height,i=270,o=subscriptionConfig.lastView,500<t&&"log"!==o?(this.subscriptionView.frame=MNUtil.genFrame(0,30,280,e-30),this.webview.frame=MNUtil.genFrame(0,30,280,e-30),this.docview.frame=MNUtil.genFrame(285,30,t-285,e-30),this.docview.hidden=!1):(i=t-10,this.subscriptionView.frame=MNUtil.genFrame(0,30,t,e-30),this.webview.frame=MNUtil.genFrame(0,30,t,e-30),this.docview.hidden=!0),this.closeButton.setFrame(t-30,0,25,25),this.moveButton.setFrame(35,0,t-70,25),this.refreshButton.setFrame(5,0,25,25),this.activationStatus.setFrame(5,80,i,30),this.showAPIKeyButton.setFrame(i-85,45,30,25),this.pasteKeyButton.setFrame(i-50,45,50,25),this.autoSubscription.setFrame(5,115,i,30),this.freeUsage.setFrame(i-25,150,30,30),this.usageButton.setFrame(5,150,i-35,30),this.usageDetailButton.setFrame(i-110,185,115,30),this.URLButton.setFrame(5,185,i-120,30),this.apikeyInput.frame={x:5,y:5,width:i,height:70},this.resizeButton.setFrame(t-30,e-30,30,30),this.DMButton.hidden=e<295,this.DMButton.setFrame(5,220,i,30),this.buyAPIKeyButton.hidden=e<320,this.buyAPIKeyButton.setFrame(5,255,i,30),this.helperButton.hidden=e<340,this.helperButton.setFrame(5,290,i,30))},subscriptionController.prototype.showHUD=function(t,e=1.5,i=this.view){MNUtil.showHUD(t,e,i)},subscriptionController.prototype.waitHUD=function(t,e=this.view){MNUtil.waitHUD(t,e)},subscriptionController.prototype.showLog=function(t){"log"==subscriptionConfig.lastView&&this.runJavaScript(`showLogsFromAddon(\`${encodeURIComponent(JSON.stringify(t))}\`)`)},subscriptionController.prototype.appendLog=function(t){"log"==subscriptionConfig.lastView&&this.runJavaScript(`appendLogFromAddon(\`${encodeURIComponent(JSON.stringify(t))}\`)`)},subscriptionController.prototype.clearLogs=function(){"log"==subscriptionConfig.lastView?(MNUtil.logs=[],this.runJavaScript("clearLogsFromAddon()")):MNUtil.logs=[]},subscriptionController.prototype.hideAllButton=function(){this.closeButton.hidden=!0,this.refreshButton.hidden=!0,this.subscriptionView.hidden=!0,this.resizeButton.hidden=!0,this.webview.hidden=!0,this.docview.hidden=!0},subscriptionController.prototype.showAllButton=function(){this.closeButton.hidden=!1,this.refreshButton.hidden=!1,this.subscriptionView.hidden=!1,this.webview.hidden=!1,this.resizeButton.hidden=!1},subscriptionController.prototype.setFrame=function(t,e,i,o){this.view.frame="object"==typeof t?t:MNUtil.genFrame(t,e,i,o),this.currentFrame=this.view.frame},subscriptionController.prototype.toMinimode=function(i=!0){try{this.miniMode=!0,this.lastFrame=this.view.frame,this.currentFrame=this.view.frame,this.hideAllButton(),this.view.layer.borderWidth=0,this.moveButton.setTitleForState("",0);let t="#457bd3",e=subscriptionConfig.getMiniFrame();i?(this.onAnimate=!0,MNUtil.animate(()=>{this.view.layer.backgroundColor=MNUtil.hexColorAlpha(t,.8),this.setFrame(e),this.moveButton.frame=MNUtil.genFrame(0,0,40,40),this.setMiniColor(!1)}).then(()=>{this.moveButton.hidden=!1,this.view.layer.backgroundColor=MNUtil.hexColorAlpha(t,0),this.setMiniColor(!0),this.setMiniImage(),this.onAnimate=!1})):(this.setFrame(e),this.moveButton.frame=MNUtil.genFrame(0,0,40,40),this.moveButton.hidden=!1,this.view.layer.backgroundColor=MNUtil.hexColorAlpha(t,0),this.setMiniImage(),this.setMiniColor(!0))}catch(t){subscriptionUtils.addErrorLog(t,"toMinimode")}},subscriptionController.prototype.previewPDF=function(t){t=NSData.dataWithContentsOfURL(NSURL.fileURLWithPath(t));MNConnection.loadHTML(this.docview,`
<!DOCTYPE html>
<html>
<head>
    <title>优化版PDF预览</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
    <style>
        body {
            user-select: none; /* 核心属性：防止文本被选择 */
            -webkit-user-select: none; /* Chrome、Safari 浏览器 */
            -moz-user-select: none; /* Firefox 浏览器 */
            -ms-user-select: none; /* Internet Explorer/Edge 浏览器 */
        }
        .page-container { margin: 10px auto; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
    </style>
</head>
<body>
    <script>
        // 数据加载部分保持不变...
const base64PDF = "${t.base64Encoding()}"; // 完整的Base64字符串
const rawData = atob(base64PDF); // 解码Base64
const buffer = new Uint8Array(rawData.length);
for (let i = 0; i < rawData.length; i++) {
  buffer[i] = rawData.charCodeAt(i);
}

        pdfjsLib.getDocument(buffer).promise
            .then(async(pdf)=>{
                const numPages = pdf.numPages;
                const pixelRatio = window.devicePixelRatio || 1;
                const maxPages = 10

                const renderPage = async (pageNum) => {
                    if (pageNum > numPages || pageNum > maxPages) {
                        return;
                    }
                    const page = await pdf.getPage(pageNum);
                    const baseScale = 2; // 基础缩放级别
                    const viewport = page.getViewport({ 
                        scale: baseScale * pixelRatio 
                    });

                    const canvas = document.createElement('canvas');
                    const div = document.createElement('div');
                    div.className = 'page-container';
                    div.appendChild(canvas);
                    document.body.appendChild(div);

                    // 设置canvas物理像素
                    canvas.width = viewport.width;
                    canvas.height = viewport.height;
                    
                    // 设置CSS显示尺寸
                    canvas.style.width = (viewport.width / pixelRatio)+"px";
                    canvas.style.height = (viewport.height / pixelRatio)+"px";

                    // 配置渲染上下文
                    const ctx = canvas.getContext('2d');
                    ctx.imageSmoothingEnabled = false;
                    ctx.mozImageSmoothingEnabled = false;

                    // 高质量渲染参数
                    const renderContext = {
                        canvasContext: ctx,
                        viewport: viewport
                    };
                    await page.render(renderContext).promise;
                    await renderPage(pageNum + 1);
                };

                await renderPage(1);
            });
    </script>
</body>
</html>
`)},subscriptionController.prototype.setMiniColor=function(e=!1){if(this.miniMode){let t=subscriptionConfig.isSubscribed()?"#457bd3":"#677180";e?MNUtil.animate(()=>{MNButton.setColor(this.moveButton,t,.4)},.6):MNButton.setColor(this.moveButton,t)}},subscriptionController.prototype.setMiniImage=function(){if(this.miniMode)switch(this.moveButton.setTitleForState("",0),subscriptionConfig.lastView){case"subscriptionView":this.moveButton.setImageForState(this.logoImage,0);break;case"webview":case"webviewAlpha":this.moveButton.setImageForState(this.appImage,0);break;case"log":this.moveButton.setImageForState(this.logImage,0);break;default:this.moveButton.setImageForState(this.appImage,0)}},subscriptionController.prototype.checkDocview=async function(){try{return new Promise((e,t)=>{if(this.docview.hidden){let t=this.view.frame;t.width=800,t.height<500&&(t.height=500),MNUtil.windowWidth-t.x<800&&(t.width=600),t.x=MNUtil.constrain(this.view.frame.x,40,MNUtil.currentWindow.frame.width-t.width),this.onAnimate=!0,MNUtil.animate(()=>{this.view.frame=t,this.layoutSubviews()}).then(()=>{this.currentFrame=t,this.onAnimate=!1,this.view.setNeedsLayout(),e()})}else{let t=this.view.frame;t.height<500&&(t.height=500,this.onAnimate=!0,MNUtil.animate(()=>{this.view.frame=t,this.layoutSubviews()}).then(()=>{this.currentFrame=t,this.onAnimate=!1,this.view.setNeedsLayout(),e()}))}e()})}catch(t){subscriptionUtils.addErrorLog(t,"checkDocview")}},subscriptionController.prototype.loadRechargePage=async function(){if(MNUtil.isIOS())MNUtil.confirm("MN Utils","Not supported on iOS\n\n暂不支持iOS");else{await this.checkDocview(),this.setWebMode(!0,"docview");let t=subscriptionConfig.APIKey;t?(MNConnection.loadFile(this.docview,subscriptionUtils.mainPath+"/recharge.html",subscriptionUtils.mainPath),MNUtil.delay(.5).then(()=>{this.runJavaScript(`state.apiKey = "${t}"`,"docview")})):MNConnection.loadFile(this.docview,subscriptionUtils.mainPath+"/newkey.html",subscriptionUtils.mainPath)}},subscriptionController.prototype.verifyApiKeyInRechargePage=async function(t){(await subscriptionNetwork.validateAPIKey(t)).success?this.runJavaScript("handleApiKeyVerificationResult(true)","docview"):this.runJavaScript("handleApiKeyVerificationResult(false)","docview")},subscriptionController.prototype.afdNewkeyOrderPage=async function(t,e=!1){var t=["5","10","20","50"].indexOf(t),i=NSUUID.UUID().UUIDString(),t=(subscriptionUtils.orderId=i,["https://ifdian.net/order/create?product_type=1&plan_id=a6ed8b60fbcf11ee941152540025c377&sku=%5B%7B%22sku_id%22:%22b24e214cfd3f11eebc335254001e7c00%22,%22count%22:1%7D%5D","https://ifdian.net/order/create?product_type=1&plan_id=a6ed8b60fbcf11ee941152540025c377&sku=%5B%7B%22sku_id%22:%22a58e5502146f11efa4fa5254001e7c00%22,%22count%22:1%7D%5D","https://ifdian.net/order/create?product_type=1&plan_id=a6ed8b60fbcf11ee941152540025c377&sku=%5B%7B%22sku_id%22:%2279e3e74a147011efb46e52540025c377%22,%22count%22:1%7D%5D","https://ifdian.net/order/create?product_type=1&plan_id=a6ed8b60fbcf11ee941152540025c377&sku=%5B%7B%22sku_id%22%3A%22e87e8a7432f811efaa1552540025c377%22,%22count%22%3A1%7D%5D"][t]+"&custom_order_id="+encodeURIComponent(i));MNUtil.copy(i),e?MNUtil.openURL(t):MNConnection.loadRequest(this.docview,t,!0)},subscriptionController.prototype.afdRechargeOrderPage=async function(t,e=!1){var t=["5","10","20","50"].indexOf(t),i=["https://ifdian.net/order/create?product_type=1&plan_id=f52724aa464611ef8acc52540025c377&sku=%5B%7B%22sku_id%22:%22f52fdfc8464611efbe3052540025c377%22,%22count%22:1%7D%5D","https://ifdian.net/order/create?product_type=1&plan_id=f52724aa464611ef8acc52540025c377&sku=%5B%7B%22sku_id%22:%22a077cf88557611efb1785254001e7c00%22,%22count%22:1%7D%5D","https://ifdian.net/order/create?product_type=1&plan_id=f52724aa464611ef8acc52540025c377&sku=%5B%7B%22sku_id%22:%22a0831816557611ef8fb05254001e7c00%22,%22count%22:1%7D%5D","https://ifdian.net/order/create?product_type=1&plan_id=f52724aa464611ef8acc52540025c377&sku=%5B%7B%22sku_id%22:%22ba4c466e557611ef80c852540025c377%22,%22count%22:1%7D%5D"];e?MNUtil.openURL(i[t]):MNConnection.loadRequest(this.docview,i[t],!0)},subscriptionController.prototype.executeMNAddonAction=async function(t){if(this.onDownloading)return this.showHUD("Wait..."),!1;var e=t.host;let i=t.params.id;var o,s,n=subscriptionConfig.mnaddon.filter(t=>t.id===i)[0];switch(e){case"showDescription":MNConnection.loadRequest(this.docview,n.description),await this.checkDocview(),this.waitHUD("Previewing Document...",this.docview);break;case"importDocument":this.waitHUD("Importing document..."),subscriptionNetwork.downloadFromConfig(n,this),MNUtil.log({level:"info",message:"Import document: "+n.name});break;case"importNotebook":this.waitHUD("Importing notebook..."),subscriptionNetwork.downloadFromConfig(n,this),MNUtil.log({level:"info",message:"Import notebook: "+n.name});break;case"install":case"update":subscriptionNetwork.downloadFromConfig(n,this),this.docview.hidden||MNConnection.loadRequest(this.docview,n.description),MNUtil.log({level:"info",message:"Install addon: "+n.name+" "+n.version});break;case"reinstall":"history"in n?(s=n.history.map(t=>t.version).slice(0,6),(o=await MNUtil.userSelect("Choose a history version","选择历史版本",s))&&(s=s[o-1],n.version=s,subscriptionNetwork.downloadFromConfig(n,this),MNUtil.log({level:"info",message:"Install addon: "+n.name+" "+n.version}),this.docview.hidden||MNConnection.loadRequest(this.docview,n.description))):await MNUtil.confirm("Re-install this addon?","重新安装该插件？")&&(subscriptionNetwork.downloadFromConfig(n,this),MNUtil.log({level:"info",message:"Install addon: "+n.name+" "+n.version}),this.docview.hidden||MNConnection.loadRequest(this.docview,n.description))}},subscriptionController.prototype.changeView=async function(t){var e=subscriptionConfig.lastView,i=subscriptionConfig.getConfig("customMode"),o=new Menu(t,this);if(o.width=250,o.rowHeight=35,o.preferredPosition=1,this.miniMode)switch(i){case"leftTop":case"rightTop":o.preferredPosition=1;break;case"leftBottom":case"rightBottom":o.preferredPosition=2;break;case"top":o.preferredPosition=1;break;case"bottom":o.preferredPosition=2;break;case"left":o.preferredPosition=4;break;case"right":o.preferredPosition=0;break;default:o.preferredPosition=1}o.addMenuItem("💲  Subscription Manager","setViewTo:","subscriptionView","subscriptionView"===e),o.addMenuItem("🎛️  Update Manager","setViewTo:","webview","webview"===e),o.addMenuItem("🎛️  Update Manager (α)","setViewTo:","webviewAlpha","webviewAlpha"===e),o.addMenuItem("📔  Shared Notebooks","setViewTo:","shareNotebooks","shareNotebooks"===e),o.addMenuItem("📄  Shared Documents","setViewTo:","shareDocuments","shareDocuments"===e),o.addMenuItem("🎛️  MNAddon Panel","showPanel:","setting","setting"===e),o.addMenuItem("🔨  Log Viewer","setViewTo:","log","log"===e),o.addMenuItem("🗺️  Update Roadmap","setViewTo:","roadmap","roadmap"===e),o.addMenuItem("🗺️  Feedback","setViewTo:","feedback","feedback"===e),o.addMenuItem("💬  QQ Gruop","setViewTo:","QQGruop","QQGruop"===e),o.addMenuItem("📕  Red Note","setViewTo:","redNote","redNote"===e),o.addMenuItem("❓  Questions","setViewTo:","commonQuestion","commonQuestion"===e),o.addMenuItem("❌  Force to Crash","force2Crash:","sidebar","sidebar"===e),o.show()},subscriptionController.prototype.changeViewTo=async function(t,e=!1){try{for(;!this.initialized;)MNUtil.showHUD("not initialized"),await MNUtil.delay(.5);if(this.miniMode){switch(t){case"roadmap":return void MNUtil.postNotification("openInBrowser",{url:"https://mnaddon.craft.me/roadmap"});case"feedback":return void MNUtil.postNotification("openInBrowser",{url:"https://s.craft.me/D9f5zVkfItscTP"})}await this.exitMiniMode(),await MNUtil.delay(.5)}if(e||subscriptionConfig.lastView!==t){switch(t){case"subscriptionView":this.subscriptionView.hidden=!1,this.webview.hidden=!0,MNButton.setTitle(this.moveButton,"Subscription Manager",void 0,!0),subscriptionConfig.config.lastView="subscriptionView";break;case"shareNotebooks":this.subscriptionView.hidden=!0,this.webview.hidden=!1,MNButton.setTitle(this.moveButton,"Shared Notebooks",void 0,!0),this.webview.loadFileURLAllowingReadAccessToURL(NSURL.fileURLWithPath(subscriptionUtils.mainPath+"/sidebar.html"),NSURL.fileURLWithPath(subscriptionUtils.mainPath+"/")),this.refreshSidebar(!0,"shareNotebooks"),subscriptionConfig.config.lastView="shareNotebooks";break;case"shareDocuments":this.subscriptionView.hidden=!0,this.webview.hidden=!1,MNButton.setTitle(this.moveButton,"Shared Documents",void 0,!0),this.webview.loadFileURLAllowingReadAccessToURL(NSURL.fileURLWithPath(subscriptionUtils.mainPath+"/sidebar.html"),NSURL.fileURLWithPath(subscriptionUtils.mainPath+"/")),this.refreshSidebar(!0,"shareDocuments"),subscriptionConfig.config.lastView="shareDocuments";break;case"webview":this.subscriptionView.hidden=!0,this.webview.hidden=!1,MNButton.setTitle(this.moveButton,"Update Manager",void 0,!0),this.webview.loadFileURLAllowingReadAccessToURL(NSURL.fileURLWithPath(subscriptionUtils.mainPath+"/sidebar.html"),NSURL.fileURLWithPath(subscriptionUtils.mainPath+"/")),this.refreshSidebar(!0,"webview"),subscriptionConfig.config.lastView="webview";break;case"webviewAlpha":this.subscriptionView.hidden=!0,this.webview.hidden=!1,MNButton.setTitle(this.moveButton,"Update Manager (α)",void 0,!0),this.webview.loadFileURLAllowingReadAccessToURL(NSURL.fileURLWithPath(subscriptionUtils.mainPath+"/sidebar.html"),NSURL.fileURLWithPath(subscriptionUtils.mainPath+"/")),this.refreshSidebar(!0,"webviewAlpha"),subscriptionConfig.config.lastView="webviewAlpha";break;case"commonQuestion":this.checkDocview(),MNConnection.loadRequest(this.docview,"https://mnaddon.craft.me/question",MNUtil.isMacOS());break;case"redNote":this.subscriptionView.hidden=!0,this.webview.hidden=!1,MNConnection.loadRequest(this.webview,"http://xhslink.com/m/80rv3rT5lFq",!1),this.wideSidebar();break;case"QQGruop":return void MNConnection.loadRequest(this.webview,"https://qm.qq.com/cgi-bin/qm/qr?k=KbIlzoREcs0i6BptRm7mPz-FbSQ0rDdY&jump_from=webapi&authKey=IFb0w7qbBf7tqVvYh1EbMh0KeQ7+Ucl5ZGmjYr5ddX9wCGHyYUWuFnhI65S3Ne+6",MNUtil.isMacOS());case"roadmap":MNUtil.postNotification("openInBrowser",{url:"https://mnaddon.craft.me/roadmap"});break;case"feedback":MNUtil.postNotification("openInBrowser",{url:"https://s.craft.me/D9f5zVkfItscTP"});break;case"log":this.subscriptionView.hidden=!0,this.webview.hidden=!1,MNButton.setTitle(this.moveButton,"Log Viewer",void 0,!0),this.webview.loadFileURLAllowingReadAccessToURL(NSURL.fileURLWithPath(subscriptionUtils.mainPath+"/log.html"),NSURL.fileURLWithPath(subscriptionUtils.mainPath+"/")),subscriptionConfig.config.lastView="log",this.wideSidebar(),await MNUtil.delay(.5),this.showLog(MNUtil.logs)}subscriptionConfig.save(),this.view.setNeedsLayout()}}catch(t){subscriptionUtils.addErrorLog(t,"changeViewTo")}},subscriptionController.prototype.exitMiniMode=async function(){let i="#457bd3";return this.view.layer.backgroundColor=MNUtil.hexColorAlpha(i,.8),this.moveButton.setImageForState(void 0,0),this.lastFrame.x=MNUtil.constrain(0,this.lastFrame.x,MNUtil.studyWidth-this.lastFrame.width),this.lastFrame.y=MNUtil.constrain(0,this.lastFrame.y,MNUtil.studyHeight-this.lastFrame.height),new Promise((t,e)=>{this.onAnimate=!0,MNUtil.animate(()=>{this.setFrame(this.lastFrame);var t=this.view.bounds.width;this.moveButton.setFrame(35,0,t-70,25),MNButton.setColor(this.moveButton,i)},.25).then(()=>{this.miniMode=!1,this.showAllButton(),this.view.layer.backgroundColor=MNUtil.hexColorAlpha(i,0),MNButton.setColor(this.moveButton,i),this.onAnimate=!1,this.view.setNeedsLayout(),t()})})},subscriptionController.prototype.wideSidebar=function(){var t=this.view.frame;t.width<500&&(t.width=500),t.height<500&&(t.height=500),this.view.frame=t,this.currentFrame=t},subscriptionController.prototype.setWebMode=function(t=!1,e="webview"){this[e].customUserAgent=t?"Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_6) AppleWebKit/605.1.15 (KHTML, like Gecko) Version/16.0 Safari/605.1.15":"Mozilla/5.0 (iPhone; CPU iPhone OS 15_0 like Mac OS X) AppleWebKit/605.1.15 (KHTML, like Gecko) Mobile/15E148"};class subscriptionUtils{constructor(t){this.name=t}static subscriptionController;static mainPath;static orderId="";static init(t){try{this.addonConnected=!0,this.app=Application.sharedInstance(),this.data=Database.sharedInstance(),this.focusWindow=this.app.focusWindow,this.version=this.appVersion(),this.mainPath=t,this.errorLog=[],this.extensionPath=t.replace(/\/marginnote\.extension\.\w+/,""),this.topOffset=MNUtil.isMacOS()?30:22,this.bottomOffset=MNUtil.isMacOS()?0:10,MNUtil.createFolder(t+"/download"),this.downloadPath=t+"/download"}catch(t){MNUtil.log({message:"subscriptionUtils.init",level:"ERROR",source:"MN Utils",timestamp:Date.now(),detail:t.toString()})}}static showHUD(t,e=0){this.app.showHUD(t,this.focusWindow,2)}static addErrorLog(t,e,i){MNUtil.showHUD("MN Utils Error ("+e+"): "+t);t={error:t.toString(),source:e,time:new Date(Date.now()).toString(),mnaddon:"MN Utils"};i&&(t.info=i),this.errorLog.push(t),MNUtil.copyJSON(this.errorLog)}static appVersion(){var t={},e=parseFloat(this.app.appVersion);switch(t.version=4<=e?"marginnote4":"marginnote3",this.app.osType){case 0:t.type="iPadOS";break;case 1:t.type="iPhoneOS";break;case 2:t.type="macOS"}return t}static getByDefault(t,e){var i=NSUserDefaults.standardUserDefaults().objectForKey(t);return void 0===i?(NSUserDefaults.standardUserDefaults().setObjectForKey(e,t),e):i}static getNoteColors(){return["#ffffb4","#ccfdc4","#b4d1fb","#f3aebe","#ffff54","#75fb4c","#55bbf9","#ea3323","#ef8733","#377e47","#173dac","#be3223","#ffffff","#dadada","#b4b4b4","#bd9fdc"]}static getNoteById(t){return this.data.getNoteById(t)}static getNoteBookById(t){return this.data.getNotebookById(t)}static getUrlByNoteId(t){return this.appVersion().version+"app://note/"+t}static getNoteIdByURL(t){let e=t.trim();return e=/^marginnote\dapp:\/\/note\//.test(e)?e.slice(22):e}static clipboardText(){return UIPasteboard.generalPasteboard().string}static copy(t){UIPasteboard.generalPasteboard().string=t}static copyJSON(t){UIPasteboard.generalPasteboard().string=JSON.stringify(t,null,2)}static copyImage(t){UIPasteboard.generalPasteboard().setDataForPasteboardType(t,"public.png")}static studyController(){return this.app.studyController(this.focusWindow)}static studyView(){return this.app.studyController(this.focusWindow).view}static currentDocController(){return this.studyController().readerController.currentDocumentController}static currentNotebook(){var t=this.studyController().notebookController.notebookId;return this.getNoteBookById(t)}static undoGrouping(t,e){UndoManager.sharedInstance().undoGrouping(String(Date.now()),t,e),this.app.refreshAfterDBChanged(t)}static checkSubscriptionController(){this.subscriptionController||(this.subscriptionController=subscriptionController.new()),MNUtil.isDescendantOfCurrentWindow(this.subscriptionController.view)||MNUtil.currentWindow.addSubview(this.subscriptionController.view)}static getNewLocDev(t,e=MNUtil.currentWindow){1===t.state&&(t.initLocation=t.locationInView(e),self.initFrame=self.view.frame)}static getNewLoc(t,e=MNUtil.currentWindow){var i,o=t.locationInView(e),s=(t.moveDate||(t.moveDate=0),100<Date.now()-t.moveDate&&(i=t.translationInView(e),s=t.locationInView(t.view.superview),1===t.state)&&(t.locationToBrowser={x:s.x-i.x,y:s.y-i.y}),o.x<=0&&(o.x=0),o.x>e.frame.width&&(o.x=e.frame.width),t.moveDate=Date.now(),{x:o.x-t.locationToBrowser.x,y:o.y-t.locationToBrowser.y});return s.y<=0&&(s.y=0),s.y>=e.frame.height-15&&(s.y=e.frame.height-15),s}static getImage(t,e=2){return UIImage.imageWithDataScale(NSData.dataWithContentsOfFile(t),e)}static refreshAddonCommands(){var t=subscriptionUtils.subscriptionController;t&&t.miniMode&&(subscriptionConfig.isSubscribed()?MNButton.setColor(t.moveButton,"#457bd3",.4):MNButton.setColor(t.moveButton,"#677180",.4))}static addObserver(t,e,i){NSNotificationCenter.defaultCenter().addObserverSelectorName(t,e,i)}static removeObserver(t,e){NSNotificationCenter.defaultCenter().removeObserverName(t,e)}static checkSender(t,e){return this.app.checkNotifySenderInWindow(t,e)}static getPopoverAndPresent(t,e,i=100,o=2){var s=MenuController.new(),e=(s.commandTable=e,s.rowHeight=35,s.preferredContentSize={width:i,height:s.rowHeight*s.commandTable.length},new UIPopoverController(s)),i=t.convertRectToView(t.bounds,this.studyView());return e.presentPopoverFromRect(i,this.studyView(),o,!0),e}static hexColorAlpha(t,e){t=UIColor.colorWithHexString(t);return void 0!==e?t.colorWithAlphaComponent(e):t}static getToday(){return(new Date).getDate()}static ensureView(t){MNUtil.isDescendantOfCurrentWindow(t)||(t.hidden=!1,MNUtil.currentWindow.addSubview(t))}static async delay(i){return new Promise((t,e)=>{NSTimer.scheduledTimerWithTimeInterval(i,!1,function(){t()})})}static getLocalMNAddonVersions(){try{var e=this.extensionPath+"/";let t=NSFileManager.defaultManager().contentsOfDirectoryAtPath(e),i=(t=t.filter(t=>!/\.DS_Store$/.test(t)),{});return t.map(t=>{var e;MNUtil.isfileExists(this.extensionPath+"/"+t+"/mnaddon.json")&&(e=MNUtil.readJSON(this.extensionPath+"/"+t+"/mnaddon.json").version,t=t.split("marginnote.extension.")[1],i[t]=e)}),i}catch(t){MNUtil.showHUD(t)}}static compareVersions(t,e){var i=t=>{return t.match(/(\d+)([a-zA-Z]*)(\d*)/g).map(t=>{var e=t.match(/\d+/),t=t.match(/[a-zA-Z]+/);return{num:e?parseInt(e[0],10):0,alpha:t?t[0]:"",alphaNum:t?t[0].charCodeAt(0):0}})},o=i(t),s=i(e);for(let t=0;t<Math.max(o.length,s.length);t++){var n=o[t]||{num:0,alpha:"",alphaNum:0},r=s[t]||{num:0,alpha:"",alphaNum:0};if(n.num!==r.num)return n.num>r.num?1:-1;if(n.alphaNum!==r.alphaNum)return n.alphaNum>r.alphaNum?1:-1;if(n.alpha===r.alpha&&n.num===r.num){n=n.num,r=r.num;if(n!==r)return r<n?1:-1}}return 0}static getRandomAuthorization(t){t="https://dav.jianguoyun.com/dav/mnaddonStore/"+t,t=[{user:"2063617827@qq.com",password:"a3dkxi2c72hgm8hh",url:t},{user:"1514501767@qq.com",password:"a76xnbehrsr36via",url:t}];return 1===t.length?t[0]:t.length?t[Math.floor(Math.random()*t.length)]:""}static getURLTitle(){var t=subscriptionConfig.URL;return"https://api.feliks.top"===t?"URL1":"https://api1.feliks.top"===t?"URL2":"https://alpha.u1162561.nyat.app:20075"===t?"URL3":"https://api.u1162561.nyat.app:20074"===t?"URL4":"https://d2p9226849.vicp.fun"===t?"URL5":"Unknown URL"}static async importNotebook(o,s,t){try{var n=subscriptionUtils.subscriptionController,i=(n.waitHUD("Importing notebook..."),MNUtil.allNotebookIds());let e=2;if(i.includes(t)&&(e=await MNUtil.userSelect("请选择操作","",["合并已有学习集","覆盖已有学习集"])),o.endsWith(".marginnotes"))switch(e){case 0:return void MNUtil.stopHUD();case 1:n.waitHUD("Importing notebook..."),await MNUtil.delay(.1);var r,a=MNUtil.importNotebook(o,!0);n.waitHUD("✅ Import success!"),a&&(r=await MNUtil.confirm("是否打开学习集？",a.title),MNUtil.refreshAfterDBChanged(),r)&&MNUtil.openURL("marginnote4app://notebook/"+a.topicId),MNUtil.stopHUD(.5);break;case 2:case 3:n.waitHUD("Importing notebook..."),await MNUtil.delay(.1);var c,l=MNUtil.importNotebook(o,!1);n.waitHUD("✅ Import success!"),l&&(c=await MNUtil.confirm("是否打开学习集？",l.title),MNUtil.refreshAfterDBChanged(),c)&&MNUtil.openURL("marginnote4app://notebook/"+l.topicId),MNUtil.stopHUD(.5);break;default:return}else{MNUtil.createFolderDev(s),ZipArchive.unzipFileAtPathToDestination(o,s);var u=MNUtil.subpathsOfDirectory(s+"/").filter(t=>t.endsWith(".pdf"));let i=u.map(t=>s+"/"+t);var d=u.map(t=>MNUtil.documentFolder+"/"+t);let t=MNUtil.contentsOfDirectory(s+"/");switch(t=t.filter(t=>t.endsWith(".marginnotes")),e){case 0:return void MNUtil.stopHUD();case 1:n.waitHUD("Importing notebook..."),await MNUtil.delay(.1);var h=MNUtil.importNotebook(s+"/"+t[0],!0);await MNUtil.delay(.1),d.length&&(n.waitHUD("Importing documents..."),d.forEach((t,e)=>{MNUtil.copyFile(i[e],t),MNUtil.importDocument(t)})),await MNUtil.delay(.1),n.waitHUD("✅ Import success!"),await MNUtil.openNotebook(h,!0),MNUtil.stopHUD(.5);break;case 2:case 3:n.waitHUD("Importing notebook..."),await MNUtil.delay(.1);var p=MNUtil.importNotebook(s+"/"+t[0],!1);await MNUtil.delay(.1),d.length&&(n.waitHUD("Importing documents..."),d.forEach((t,e)=>{MNUtil.copyFile(i[e],t),MNUtil.importDocument(t)})),await MNUtil.delay(.1),n.waitHUD("✅ Import success!"),await MNUtil.openNotebook(p,!0),MNUtil.stopHUD(.5);break;default:return}}}catch(t){subscriptionUtils.addErrorLog(t,"importNotebook")}}static getFileNameFromUrl(t){var e=t.indexOf("?");if(-1===e)return MNUtil.getFileName(t);for(const s of t.slice(e+1).split("&")){var[i,o]=s.split("=");if("filename"===i)return decodeURIComponent(o)}return null}static calcLastFrame(e=void 0){try{let t={};e?t=e:"log"===subscriptionConfig.lastView?(t.width=500,t.height=500):(t.width=280,t.height=subscriptionConfig.frameHeight);var i=subscriptionConfig.getConfig("customMode"),o=subscriptionConfig.getMiniFrame();switch(t.x=o.x-.5*t.width,i){case"leftTop":t.x=40,t.y=40;break;case"rightTop":t.x=MNUtil.currentWindow.frame.width-t.width-40,t.y=40;break;case"leftBottom":t.x=40,t.y=MNUtil.currentWindow.frame.height-t.height-40;break;case"rightBottom":t.x=MNUtil.currentWindow.frame.width-t.width-40,t.y=MNUtil.currentWindow.frame.height-t.height-40;break;case"left":t.x=40,t.y=MNUtil.constrain(o.y,40,MNUtil.currentWindow.frame.height-t.height-40);break;case"top":t.y=40;break;case"right":t.x=MNUtil.currentWindow.frame.width-t.width-40,t.y=MNUtil.constrain(o.y,40,MNUtil.currentWindow.frame.height-t.height-40);break;case"bottom":t.x=MNUtil.constrain(o.x,40,MNUtil.currentWindow.frame.width-t.width-40),t.y=MNUtil.currentWindow.frame.height-t.height-40}return t}catch(t){subscriptionUtils.addErrorLog(t,"calcLastFrame")}}}class subscriptionNetwork{constructor(t){this.name=t}static onSubscrbing=!1;static genNSURL(t){return NSURL.URLWithString(t)}static initRequest(t,e){var i=NSMutableURLRequest.requestWithURL(this.genNSURL(t));i.setHTTPMethod(e.method??"GET"),i.setTimeoutInterval(e.timeout??10);return i.setAllHTTPHeaderFields({"User-Agent":"Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_4) AppleWebKit/605.1.15 (KHTML, like Gecko) Version/13.1.1 Safari/605.1.15","Content-Type":"application/json",Accept:"application/json",...e.headers??{}}),e.search?i.setURL(this.genNSURL(t.trim()+"?"+Object.entries(e.search).reduce((t,e)=>{var[e,i]=e;return(t?t+"&":"")+e+"="+encodeURIComponent(i)},""))):e.body?i.setHTTPBody(NSData.dataWithStringEncoding(e.body,4)):e.form?i.setHTTPBody(NSData.dataWithStringEncoding(Object.entries(e.form).reduce((t,e)=>{var[e,i]=e;return(t?t+"&":"")+e+"="+encodeURIComponent(i)},""),4)):e.json&&i.setHTTPBody(NSJSONSerialization.dataWithJSONObjectOptions(e.json,1)),i}static async sendRequest(e){const i=NSOperationQueue.mainQueue();return new Promise((o,t)=>{NSURLConnection.sendAsynchronousRequestQueueCompletionHandler(e,i,(t,e,i)=>{e=NSJSONSerialization.JSONObjectWithDataOptions(e,1);NSJSONSerialization.isValidJSONObject(e)&&(i.localizedDescription&&(e.success=!1,subscriptionUtils.showHUD(i.localizedDescription)),o(e)),o(e)})})}static async fetch(t,e={}){t=this.initRequest(t,e);return await this.sendRequest(t)}static async subscribe(t=1,i=!0){if(this.onSubscrbing)return!0;this.onSubscrbing=!0;var e={"Content-Type":"application/json",Authorization:"Bearer "+subscriptionConfig.config.apikey};let o="mnaddon";var s={model:o=1<t?"mnaddon"+t:o,messages:[{role:"user",content:"mnaddon"}]},n=subscriptionConfig.URL+"/v1/chat/completions",e={method:"POST",headers:e,timeout:60,json:s},s=(1<t?MNUtil.waitHUD("Subscribing for "+t+" days..."):MNUtil.waitHUD("Subscribing..."),await MNUtil.delay(.5),await this.fetch(n,e));if(s.success)subscriptionConfig.isSubscribed()?(subscriptionConfig.addSubscriptionDay(t),MNUtil.stopHUD(),MNUtil.showHUD("✅ Subscribe success! "+subscriptionConfig.config.subscriptionDaysRemain+" days remain")):(subscriptionConfig.config.activated=!0,subscriptionConfig.config.subscribedDay=subscriptionUtils.getToday(),subscriptionConfig.addSubscriptionDay(t-1),MNUtil.stopHUD(),MNUtil.showHUD("✅ subscribe success! "+subscriptionConfig.config.subscriptionDaysRemain+" days remain")),MNUtil.log({source:"subscription",message:"✅ Subscribe success!",detail:subscriptionConfig.config.subscriptionDaysRemain+" days remain"});else{let t=!1,e=!1;if(subscriptionConfig.config.autoSubscription=!1,s.error&&(MNUtil.log({level:"error",source:"subscription",message:"Error: "+s.error.message,detail:JSON.stringify(s.error,void 0,2)}),s.error.message?(MNUtil.stopHUD(),(s.error.message.includes("该令牌额度已用尽")||s.error.message.includes("token quota is not enough"))&&(t=!0,MNUtil.showHUD("订阅Key额度不足")),s.error.message.includes("该令牌状态不可用")&&(e=!0,MNUtil.showHUD("订阅Key被禁用"))):(MNUtil.stopHUD(),MNUtil.showHUD("Error: "+JSON.stringify(s.error)),MNUtil.addErrorLog(JSON.stringify(s.error),"subscribe"))),subscriptionConfig.config.activated&&(t||e))return this.onSubscrbing=!1,s.success=!1,s.noQuota=t,s.disabled=e,s;i&&(subscriptionConfig.config.activated=!1)}return this.onSubscrbing=!1,MNUtil.delay(.1).then(()=>{subscriptionConfig.save(),subscriptionUtils.subscriptionController.activationStatus.setTitleForState(subscriptionConfig.getStatus(),0),subscriptionUtils.refreshAddonCommands()}),s}static async getKey(t="mnaddon"){var e,i=subscriptionConfig.APIKey;if(""!==i.trim())return i={"Content-Type":"application/json",Authorization:"Bearer "+i},t={model:t,messages:[{role:"user",content:"mnaddon"}]},e=subscriptionConfig.URL+"/v1/chat/completions",await this.fetch(e,{method:"POST",headers:i,timeout:60,json:t});subscriptionUtils.showHUD("no api key")}static async countDownload(t="mnaddon"){var e={"Content-Type":"application/json",Authorization:"Bearer sk-yJBsnoQlOkI7gQcqV501oAjuuiIhIg01gJ3qqmEyQdX81sQK"},t={model:t,messages:[{role:"user",content:"mnaddon"}]},i=subscriptionConfig.URL+"/v1/chat/completions";return await this.fetch(i,{method:"POST",headers:e,timeout:60,json:t})}static async getUsage(){try{var t=subscriptionConfig.URL,e=t+"/v1/dashboard/billing/subscription",i=t+"/v1/dashboard/billing/usage",o=subscriptionConfig.APIKey;if(""!==o.trim()){var s={Authorization:"Bearer "+o,"Content-Type":"application/json"},n={},r=await this.fetch(i,{method:"GET",timeout:60,headers:s});if("error"in r){if(r.error.message.includes("该令牌额度已用尽")||r.error.message.includes("token quota is not enough"))return n.error="订阅Key额度不足",n.noQuota=!0,n.disabled=!1,n.message=r.error.message,n;if(r.error.message.includes("该令牌状态不可用"))return n.error="订阅Key被禁用",n.noQuota=!1,n.disabled=!0,n.message=r.error.message,n;n.message=r.error.message}n.usage=r.total_usage;var a=await this.fetch(e,{method:"GET",timeout:60,headers:s}),c=(n.total=a.hard_limit_usd,n.total-n.usage/100);return c<.1&&(n.error="订阅Key额度不足",n.noQuota=!0,n.disabled=!1),n}subscriptionUtils.showHUD("no api key")}catch(t){return subscriptionUtils.addErrorLog(t,"getUsage"),{}}}static async validateAPIKey(e){try{var i=subscriptionConfig.URL+"/api/token/search?keyword=&token="+e;let t="gcZMFWrJysiae1/cs087tsmii3OBvvHY";var o={"New-Api-User":"29",Authorization:"Bearer "+t,"Content-Type":"application/json"},s=await this.fetch(i,{method:"GET",timeout:60,headers:o});return 1===s.data.length?{success:!0,apikey:"sk-"+s.data[0].key}:(o={"New-Api-User":"1",Authorization:"Bearer "+(t="RGEcAM0eZ7e/Otha+xiBPfaUEAMi+Q=="),"Content-Type":"application/json"},1===(s=await this.fetch(i,{method:"GET",timeout:60,headers:o})).data.length?{success:!0,apikey:"sk-"+s.data[0].key}:{success:!1})}catch(t){return subscriptionUtils.addErrorLog(t,"validateAPIKey"),!1}}static btoa(t){t=CryptoJS.enc.Utf8.parse(t);return CryptoJS.enc.Base64.stringify(t)}static atob(t){let e=t.replace(/-/g,"+").replace(/_/g,"/");switch(e.length%4){case 2:e+="==";break;case 3:e+="="}try{return CryptoJS.enc.Base64.parse(e).toString(CryptoJS.enc.Utf8)}catch(t){return CryptoJS.enc.Base64.parse(e).toString(CryptoJS.enc.Latin1)}}static async readWebDAVFile(t,e,i){e={Authorization:"Basic "+this.btoa(e+":"+i),"Cache-Control":"no-cache"},i=await MNConnection.fetch(t,{method:"GET",headers:e});try{return i.base64Encoding?MNUtil.data2string(i):i}catch(t){return i}}static readWebDAVFileWithDelegate(t,e,i){try{var o={Authorization:"Basic "+this.btoa(e+":"+i),"Cache-Control":"no-cache"};return this.initRequest(t,{method:"GET",headers:o})}catch(t){}}static async readFileFromWebdav(t){t=subscriptionUtils.getRandomAuthorization(t);return await this.readWebDAVFile(t.url,t.user,t.password)}static readFileFromWebdavWithDelegate(t,e){t=subscriptionUtils.getRandomAuthorization(t);return this.readWebDAVFileWithDelegate(t.url,t.user,t.password,e)}static async downloadFromConfig(t,e=void 0){var i=subscriptionUtils.subscriptionController;if("importDocument"===t.action)MNUtil.allDocumentIds().includes(t.id)?(MNUtil.currentNotebookId?await MNUtil.confirm("Document already exists","文档已存在，是否打开该文档？\n"+t.fileName)&&(MNUtil.openDoc(t.id,MNUtil.currentNotebookId),0===MNUtil.docMapSplitMode)&&(MNUtil.studyController.docMapSplitMode=1):MNUtil.confirm("Document already exists","文档已存在\n"+t.fileName),MNUtil.stopHUD()):(i.waitHUD("Download: "+t.name),MNUtil.createFolderDev(MNUtil.documentFolder+"/Download"),r=(s=MNUtil.documentFolder+"/Download")+"/"+t.fileName,n=MNConnection.requestWithURL(t.url),e&&(NSURLConnection.connectionWithRequestDelegate(n,e),e.targetPath=r,e.folder=s,e.documentId=t.id,e.fileType="document"));else{if("importNotebook"===t.action)return n=t.url.endsWith(".marginpkg")?t.id+".marginpkg":t.id+".marginnotes",r=subscriptionUtils.downloadPath+"/"+n,MNUtil.isfileExists(r)?(s=subscriptionUtils.downloadPath+"/"+t.id,void subscriptionUtils.importNotebook(r,s,t.id)):(i.waitHUD("Download: "+t.name),n=MNConnection.requestWithURL(t.url),e&&(NSURLConnection.connectionWithRequestDelegate(n,e),e.targetPath=r,e.folder=subscriptionUtils.downloadPath+"/"+t.id,e.notebookId=t.id,e.fileType="notebook"),void MNUtil.stopHUD());var o,s=subscriptionUtils.extensionPath+"/marginnote.extension."+t.id,n=t.id+"_v"+t.version.replace(/\./g,"_")+".mnaddon",r=subscriptionUtils.downloadPath+"/"+n;t.customUrl?(i.waitHUD("Download: "+t.name),o=MNConnection.requestWithURL(t.url),e&&(NSURLConnection.connectionWithRequestDelegate(o,e),e.targetPath=r,e.addonPath=s,e.fileType="mnaddon")):(i.waitHUD("Download: "+n),e&&(o=subscriptionNetwork.readFileFromWebdavWithDelegate(n,e),NSURLConnection.connectionWithRequestDelegate(o,e),e.targetPath=r,e.addonPath=s,e.fileType="mnaddon")),subscriptionNetwork.countDownload(t.id)}}}class subscriptionConfig{constructor(t){this.name=t}static defaultConfig={activated:!1,autoSubscription:!1,subscribedDay:0,apikey:"",freeUsage:0,freeDay:0,subscriptionDaysRemain:0,url:"https://api.feliks.top",lastView:"webview",customMode:"left",alpha:!1,miniFrame:{x:0,y:80,width:40,height:40}};static frameHeight=355;static mnaddon=[];static init(){this.config=this.getByDefault("FeliksPro",this.defaultConfig)}static getByDefault(t,e){var i=NSUserDefaults.standardUserDefaults().objectForKey(t);return void 0===i?(NSUserDefaults.standardUserDefaults().setObjectForKey(e,t),e):i}static getConfig(t){return(void 0!==this.config[t]?this.config:this.defaultConfig)[t]}static get APIKey(){return this.getConfig("apikey").trim()}static get URL(){return this.getConfig("url").trim()}static get lastView(){return this.getConfig("lastView")}static set APIKey(t){this.config.apikey=t.trim()}static get miniFrame(){return{...this.getConfig("miniFrame")}}static getMiniFrame(t,e){var i=t??this.miniFrame,o=subscriptionUtils.topOffset,s=subscriptionUtils.bottomOffset,n=(i.width=40,i.height=40,MNUtil.windowWidth),r=MNUtil.windowHeight;switch(e??this.getConfig("customMode")){case"leftTop":i.x=-7,i.y=o;break;case"rightTop":i.x=n-33,i.y=o;break;case"leftBottom":i.x=-7,i.y=r-40-s;break;case"rightBottom":i.x=n-33,i.y=r-40-s;break;case"left":i.x=-7,i.y=MNUtil.constrain(i.y,o,r-40-s);break;case"right":i.x=n-33,i.y=MNUtil.constrain(i.y,o,r-40-s);break;case"top":i.y=o,i.x=MNUtil.constrain(i.x,-7,n-33);break;case"bottom":i.x=MNUtil.constrain(i.x,-7,n-33),i.y=r-40-s}return i}static addSubscriptionDay(t){var e=subscriptionConfig.getConfig("subscriptionDaysRemain");this.config.subscriptionDaysRemain=e+t}static isSubscribed(){var t;return!!this.getConfig("activated")&&(t=subscriptionUtils.getToday(),this.getConfig("subscribedDay")===t)}static updateFreeUsage(){subscriptionUtils.subscriptionController&&subscriptionUtils.subscriptionController.freeUsage.setTitleForState(this.getFreeUsage(),0)}static getFreeUsage(){var t=subscriptionUtils.getToday();return this.getConfig("freeDay")===t?["🔟","9️⃣","8️⃣","7️⃣","6️⃣","5️⃣","4️⃣","3️⃣","2️⃣","1️⃣","0️⃣"][this.getConfig("freeUsage")]||"0️⃣":(this.config.freeDay=t,this.config.freeUsage=0,"🔟")}static isFree(t=!0){var e,i=subscriptionUtils.getToday();return this.getConfig("freeDay")===i?(e=this.getConfig("freeUsage"),t?(this.config.freeUsage=e+1,10<=this.config.freeUsage?subscriptionUtils.showHUD("Free Usage remian: 0"):subscriptionUtils.showHUD("Free Usage remian: "+(9-e)),e<=10):e<=9):(this.config.freeDay=i,t?(this.config.freeUsage=1,subscriptionUtils.showHUD("Free Usage remian: "+(10-this.config.freeUsage))):this.config.freeUsage=0,!0)}static checkSubscribed(t=!0,e=!1,i=!0){if(this.getConfig("activated")){if(this.isSubscribed())return!0;if(this.getConfig("autoSubscription"))return this.subscribeUsingLocalDays()||subscriptionNetwork.subscribe(),!0;if(!e&&this.isFree(t))return MNUtil.delay(.1).then(()=>{this.updateFreeUsage(),this.save()}),!0;i&&MNUtil.confirm("MN Utils","Free usage is not enough today. Please subscribe and retry.\n\n今日免费额度已用尽, 请订阅后重试").then(t=>{switch(t){case 0:return;case 1:this.subscribeUsingLocalDays()||subscriptionNetwork.subscribe()}})}else if(e)i&&MNUtil.confirm("MN Utils","Subscription is required. Do you want to open MN Utils?\n\n该功能需要插件订阅, 是否打开充值页面?").then(async t=>{t&&(await(t=subscriptionUtils.subscriptionController).changeViewTo("subscriptionView"),t.loadRechargePage())});else{if(this.isFree(t))return MNUtil.delay(.1).then(()=>{this.updateFreeUsage(),this.save()}),!0;i&&MNUtil.confirm("MN Utils","Free usage is not enough today. Do you want to open MN Utils?\n\n今日免费额度已用尽, 请订阅或者等待明日使用免费额度, 是否打开充值页面?").then(async t=>{t&&(await(t=subscriptionUtils.subscriptionController).changeViewTo("subscriptionView"),t.loadRechargePage())})}return!1}static subscribeUsingLocalDays(){return!!this.config.subscriptionDaysRemain&&(this.config.activated=!0,this.config.subscribedDay=subscriptionUtils.getToday(),this.config.subscriptionDaysRemain=this.config.subscriptionDaysRemain-1,MNUtil.delay(.1).then(()=>{subscriptionUtils.subscriptionController&&subscriptionUtils.subscriptionController.activationStatus&&subscriptionUtils.subscriptionController.activationStatus.setTitleForState(this.getStatus(),0),subscriptionUtils.showHUD("Subscription days remian: "+this.config.subscriptionDaysRemain),subscriptionUtils.refreshAddonCommands(),this.save()}),!0)}static getStatus(){return"Activated: "+(this.getConfig("activated")?"✅":"❌")+" | "+("Subscribed: "+(this.isSubscribed()?"✅":"❌"))+" | "+this.getConfig("subscriptionDaysRemain")}static save(){NSUserDefaults.standardUserDefaults().setObjectForKey(this.config,"FeliksPro")}static remove(){NSUserDefaults.standardUserDefaults().removeObjectForKey("FeliksPro")}static autoSubscribe(t=!0){this.getConfig("autoSubscription")?this.getConfig("activated")?this.isSubscribed()?subscriptionUtils.refreshAddonCommands():this.config.subscriptionDaysRemain?(this.config.activated=!0,this.config.subscribedDay=subscriptionUtils.getToday(),this.config.subscriptionDaysRemain=this.config.subscriptionDaysRemain-1,subscriptionUtils.subscriptionController.activationStatus&&subscriptionUtils.subscriptionController.activationStatus.setTitleForState(this.getStatus(),0),subscriptionUtils.showHUD("Subscription days remian: "+this.config.subscriptionDaysRemain),subscriptionUtils.refreshAddonCommands(),this.save()):subscriptionNetwork.onSubscrbing?subscriptionUtils.refreshAddonCommands():subscriptionNetwork.subscribe().then(t=>{subscriptionUtils.refreshAddonCommands()}):(t&&subscriptionUtils.showHUD("Not activated!"),subscriptionConfig.config.autoSubscription=!1,subscriptionUtils.refreshAddonCommands()):subscriptionUtils.refreshAddonCommands()}"µ"}